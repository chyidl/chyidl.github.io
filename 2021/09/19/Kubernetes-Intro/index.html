<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB+Garamond:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chyidl.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="Kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes Intro">
<meta property="og:url" content="http://chyidl.github.io/2021/09/19/Kubernetes-Intro/">
<meta property="og:site_name" content="Stay Hungry Stay Foolish">
<meta property="og:description" content="Kubernetes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kubernetes-global-articture.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kubernetes-pod-road-map.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/container_evolution.svg">
<meta property="og:image" content="http://chyidl.github.io/misc/images/components-of-kubernetes.svg">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kubernetes-storageclass.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kubernetes-cni-architecture.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kube-proxy-userspace-mode.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kube-proxy-iptables-mode.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/vxlan-architecture.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kubernetes-pod-infra.png">
<meta property="og:image" content="http://chyidl.github.io/misc/images/kubernetes-rollmap.jpg">
<meta property="article:published_time" content="2021-09-19T14:11:16.000Z">
<meta property="article:modified_time" content="2021-09-19T14:11:16.000Z">
<meta property="article:author" content="chyi">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://chyidl.github.io/misc/images/kubernetes-global-articture.png">


<link rel="canonical" href="http://chyidl.github.io/2021/09/19/Kubernetes-Intro/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://chyidl.github.io/2021/09/19/Kubernetes-Intro/","path":"2021/09/19/Kubernetes-Intro/","title":"Kubernetes Intro"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes Intro | Stay Hungry Stay Foolish</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?516e4e6590bcf7090ded728a1abdd5aa"></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Stay Hungry Stay Foolish" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>
  <a target="_blank" rel="noopener" href="https://github.com/chyidl" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Stay Hungry Stay Foolish</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Alaways be curious to learn more and achieve more.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80"><span class="nav-number">1.1.</span> <span class="nav-text">容器基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.</span> <span class="nav-text">Kubernetes 概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Kubernetes"><span class="nav-number">1.3.</span> <span class="nav-text">部署Kubernetes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-IN-Docker-Kind"><span class="nav-number">1.4.</span> <span class="nav-text">Kubernetes IN Docker (Kind)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8"><span class="nav-number">1.5.</span> <span class="nav-text">容器化应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E6%8A%80%E8%83%BD%E5%9B%BE%E8%B0%B1"><span class="nav-number">1.6.</span> <span class="nav-text">Kubernetes 技能图谱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Awesome-Tools"><span class="nav-number">1.7.</span> <span class="nav-text">Awesome Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WarmUp"><span class="nav-number">1.7.1.</span> <span class="nav-text">WarmUp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%93%E4%B8%9A%E6%9C%AF%E8%AF%AD"><span class="nav-number">1.7.2.</span> <span class="nav-text">专业术语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">1.7.3.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="chyi"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">chyi</p>
  <div class="site-description" itemprop="description">ああ月sブログ</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/chyidl" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chyidl" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/chyiyaqing@gmail.com" title="E-Mail → chyiyaqing@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ChyiYaqing" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ChyiYaqing" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chyidl.github.io/2021/09/19/Kubernetes-Intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="chyi">
      <meta itemprop="description" content="ああ月sブログ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stay Hungry Stay Foolish">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes Intro
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-19 22:11:16" itemprop="dateCreated datePublished" datetime="2021-09-19T22:11:16+08:00">2021-09-19</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>30k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>27 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><span id="more"></span>

<h2 id="容器基础"><a href="#容器基础" class="headerlink" title="容器基础"></a>容器基础</h2><blockquote>
<p>容器技术的核心功能，就是通过约束和修改进程的动态表现，从而为其创建出一个“边界”<br>容器，其实是一种特殊的单进程模型而已<br>同一台机器上的所有容器，都共享宿主机操作系统的内核</p>
</blockquote>
  <figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cgroups技术用来限制</span></span><br><span class="line"><span class="comment"># Namespace技术则是用隔离</span></span><br><span class="line">  - Mount Namespace 跟其他Namespace使用略有不同，它对容器进程视图的改变一定是伴随着挂载操作mount才能生效</span><br><span class="line">  - <span class="keyword">chroot</span> (change root file <span class="keyword">system</span>): 改变进程的根目录到指定位置</span><br><span class="line"><span class="comment"># rootfs 根文件系统 (不包括系统内核)</span></span><br><span class="line">  &gt; 由于rootfs里打包的不只是应用，而是整个操作系统的文件和目录 (对于一个应用来说，操作系统本身才是它圆形所需要的最完整的<span class="string">&quot;依赖库&quot;</span>)</span><br><span class="line">  - pivot_root</span><br><span class="line">  - <span class="keyword">chroot</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>Cgroups</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Linux Cgroups是Linux内核中用来为进程设置资源限制的一个重要功能</span></span><br><span class="line"><span class="comment"># Linux Cgroups全称 Linux Control Group,主要作用就是限制进程组能够使用的资源上限，CPU、内存、磁盘、网络带宽</span></span><br><span class="line"></span><br><span class="line">➜ mount -t cgroup</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)                        -- 为块设备设置I/O限制，一般用于磁盘等设备</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/m</span>emory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)                      -- 为进程设置内存使用限制</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)                      -- 为进程分配单独的CPU核和对应的内存节点</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</span><br><span class="line">cgroup on <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line"></span><br><span class="line">➜ ls  <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>cpu</span><br><span class="line">cgroup.clone_children  cpuacct.usage             cpuacct.usage_percpu_user  cpu.cfs_quota_us  init.scope         system.slice</span><br><span class="line">cgroup.procs           cpuacct.usage_all         cpuacct.usage_sys          cpu.shares        kubepods.slice     tasks</span><br><span class="line">cgroup.sane_behavior   cpuacct.usage_percpu      cpuacct.usage_user         cpu.stat          notify_on_release  user.slice</span><br><span class="line">cpuacct.stat           cpuacct.usage_percpu_sys  cpu.cfs_period_us          docker            release_agent</span><br></pre></td></tr></table></figure></li>
<li><p>Docker vs Hypervisor</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 用户运行在容器里的应用进程根宿主主机上的其他进程一样，都由宿主主机操作系统同一管理，只不过这些被隔离的进程拥有额外设置过的Namesapce参数, 而Docker项目在这里扮演的角色更多的是旁路式的辅助和管理工作</span><br><span class="line"><span class="bullet">2.</span> Hypervisor虚拟化作为应用沙盒，必须由Hypervisor负责创建虚拟机，这个虚拟机真实存在，并且运行完整的GuestOS才能执行用户的应用进程.</span><br></pre></td></tr></table></figure></li>
<li><p>容器化</p>
<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> &gt; Dockerd实际上是在创建容器进程时，指定进程所需要启动的一组Namespace参数，这样，容器只能“看”到当前Namespace所限定的资源、文件、设备、状态、或配置，而对于宿主机以及其他不相关的程序，就完全看不到</span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript"><span class="string">&quot;敏捷&quot;</span>和<span class="string">&quot;高性能&quot;</span>是容器相较于虚拟机最大的优势，也是它能够在PaaS这种更细粒度的资源管理平台上大行其道的重要原因.</span></span><br><span class="line"></span><br><span class="line">- 容器和应用的同生命周期</span><br></pre></td></tr></table></figure></li>
<li><p>Docker镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> Docker镜像的设计中引入层layer,用户制作镜像的每一步操作都会生成一个层，也就是一个增量rootfs</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Union File System 联合文件系统</span></span><br><span class="line"><span class="meta">  &gt;</span><span class="bash"> 将多个不同位置的目录联合挂在(Union mount)到同一个目录下</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> overlay2</span></span><br><span class="line"><span class="meta">  &gt;</span><span class="bash"> overlay2, <span class="built_in">which</span> has potential performance advantages over the aufs storage driver.</span></span><br></pre></td></tr></table></figure></li>
<li><p>容器</p>
<blockquote>
<p>是由Linux Namespace、Linux Cgroups和rootfs第三种技术构建出来的进程隔离环境</p>
</blockquote>
</li>
<li><p>Linux容器</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 容器镜像 - 静态视图</span></span><br><span class="line">  &gt; 一组联合rootfs</span><br><span class="line"></span><br><span class="line"><span class="meta"># 容器运行时 - 动态视图</span></span><br><span class="line">  &gt; 一组Namespace + Cgroups 构成的隔离环境</span><br><span class="line"></span><br><span class="line"><span class="meta"># 容器编排工具:</span></span><br><span class="line">  - Docker: Compose+Swarm</span><br><span class="line">  - Google+ReadHat: Kubernetes</span><br></pre></td></tr></table></figure></li>
<li><p>Kubernetes全局架构<br><img src="/misc/images/kubernetes-global-articture.png" alt="Kubernetes 全局架构"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> Master(控制节点):</span><br><span class="line">  &gt; 如何编排、管理、调度用户提交的作业</span><br><span class="line"><span class="bullet">  -</span> kube-controller-manager: Controller Manager</span><br><span class="line"><span class="bullet">  -</span> kube-apiserver: API Server (整个集群的持久化数据由kube-apiserver处理后保存在Etcd中)</span><br><span class="line"><span class="bullet">  -</span> kube-scheduler: Scheduler</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Node(计算节点):</span><br><span class="line"><span class="bullet">  -</span> kubelet: kubelet主要责任同容器运行时(docker)交互</span><br><span class="line"><span class="bullet">  -</span> CNI : kubelet + Networking - 网络插件为容器配置网络</span><br><span class="line"><span class="bullet">  -</span> CRI : kubectl + Container Runtime Interface (接口定义容器运行时的各项核心操作)</span><br><span class="line"><span class="bullet">  -</span> CSI : kubectl + Volume Plugin - 存储插件为容器持久化存储</span><br><span class="line"><span class="bullet">  -</span> OCI : Container Runtime Interface (容器运行时规范同底层Linux操作系统进行交互, 即将CRI请求翻译成Linux系统操作调用 Namespace + Cgroups)</span><br><span class="line"><span class="bullet">  -</span> grpc: kubelet + Device Plugin (Kubernetes项目管理宿主主机物理设备的主要组件)</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; Kubernetes项目关心解决的问题是&quot;运行在大规模集群中的各种任务之间，实际上存在着各种各样的关系，这些关系的处理，才是作业编排和管理系统最困难的地方&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>Kubernetes 核心功能<br><img src="/misc/images/kubernetes-pod-road-map.png" alt="Kubernetes 核心功能"></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&gt; Kubernetes项目的本质是为用户提供一个具有普遍意义的容器编排工具</span><br><span class="line"></span><br><span class="line"><span class="meta"># Pod:</span></span><br><span class="line">  &gt; Pod里的容器共享同一个Network Namespace,同一组数据卷，从而达到高效交换信息的目的</span><br><span class="line">  &gt; Pod就是Kubenetes世界里的<span class="string">&quot;应用&quot;</span>,而一个应用，可以由多个容器组成</span><br><span class="line"></span><br><span class="line"><span class="meta"># Service:</span></span><br><span class="line">  &gt; Service服务作为Pod代理入口(Portal)从而代替Pod对外暴露一个固定的网络地址</span><br><span class="line"></span><br><span class="line"><span class="meta"># Deployment:</span></span><br><span class="line">  &gt; Pod多实例管理器</span><br><span class="line"></span><br><span class="line"><span class="meta"># Secret:</span></span><br><span class="line">  &gt; Secret对象是保存在Etcd里的键值对数据</span><br><span class="line"></span><br><span class="line"><span class="meta"># Job:</span></span><br><span class="line">  &gt; 描述一次性运行Pod</span><br><span class="line"></span><br><span class="line"><span class="meta"># CronJob:</span></span><br><span class="line">  &gt; 描述定时任务</span><br><span class="line"></span><br><span class="line"><span class="meta"># DaemonSet:</span></span><br><span class="line">  &gt; 描述每个宿主机上必须且只能运行一个副本的守护进程服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># 编排对象 - 描述管理的应用</span></span><br><span class="line">  - Pod</span><br><span class="line">  - Job</span><br><span class="line">  - CronJob</span><br><span class="line"></span><br><span class="line"><span class="meta"># 服务对象 - 负责平台级功能</span></span><br><span class="line">  - Service</span><br><span class="line">  - Secret</span><br><span class="line">  - Horizontal Pod Autoscaler(自动水平扩展器)</span><br><span class="line"></span><br><span class="line"><span class="meta"># 声明式API</span></span><br><span class="line">  &gt; 这种API对应的<span class="string">&quot;编排对象&quot;</span>和<span class="string">&quot;服务对象&quot;</span>都是Kubernetes项目中的API对象(API <span class="built_in">Object</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Kubernetes-概念"><a href="#Kubernetes-概念" class="headerlink" title="Kubernetes 概念"></a>Kubernetes 概念</h2><ul>
<li>概述<ul>
<li>Kubernetes是什么<br><img src="/misc/images/container_evolution.svg" alt="容器演进过程"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt; Kubernetes 是一个可移植的，可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化.</span></span><br><span class="line"><span class="quote">&gt; Kubernetes源于希腊语,意为&quot;舵手&quot;或&quot;飞行员&quot;</span></span><br><span class="line"><span class="quote">&gt; Kubernetes建立在Google在大规模运行生产工作负载方面拥有十几年的经验的基础上，结合社区中最好的想法和实践.</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 传统部署时代:</span></span><br><span class="line"><span class="bullet">  -</span> 资源分配问题</span><br><span class="line"></span><br><span class="line"><span class="section"># 虚拟化部署时代:</span></span><br><span class="line"><span class="bullet">  -</span> 虚拟化技术允许在单个物理服务器的CPU上运行多个虚拟机VM,虚拟化允许应用程序在VM之间隔离,并提供一定成都的安全，因为一个应用程序的信息不能被另一个应用程序随意访问</span><br><span class="line"><span class="bullet">  -</span> 虚拟化技术能够更好的利用物理服务器上的资源，因为可轻松地添加或更新应用程序而可以实现更好的可伸缩性，降低硬件成本</span><br><span class="line"><span class="bullet">  -</span> 每一个VM是一台完整的计算机，在虚拟化硬件之上运行所有组件，包括其自己的操作系统</span><br><span class="line"></span><br><span class="line"><span class="section"># 容器部署时代:</span></span><br><span class="line"><span class="bullet">  -</span> 容器类似于VM，但是具有被放宽的隔离属性，可以在应用程序之间共享操作系统OS</span><br><span class="line"><span class="bullet">  -</span> 容器与VM具有自己的文件系统、CPU、内存、进程空间</span><br><span class="line"><span class="bullet">  -</span> 容器的好处:</span><br><span class="line"><span class="bullet">    -</span> 敏捷应用程序的创建和部署: 与使用VM镜像相比，提高容器镜像创建的便捷性和效率</span><br><span class="line"><span class="bullet">    -</span> 持续开发、集成和部署: 通过快速简单的回滚(由于镜像不可变性)，支持可靠且频繁的容器镜像构建和部署</span><br><span class="line"><span class="bullet">    -</span> 开发与运维的分离: 在构建/发布时而不是在部署时创建应用程序容器镜像,从而将应用程序于基础架构分离</span><br><span class="line"><span class="bullet">    -</span> 可观察性: 显示操作系统级别的信息和指标，显示应用程序的运行状态和其他指标信号</span><br><span class="line"><span class="bullet">    -</span> 跨开发、测试和生产的环境一致性: 在便携计算机上与云中相同地运行</span><br><span class="line"><span class="bullet">    -</span> 跨云和操作系统发型版本的可移植性: 可在Ubuntu,RHEL,CoreOS,本地</span><br><span class="line"><span class="bullet">    -</span> 以应用程序为中心的管理: 提高抽象级别，从在虚拟硬件上运行OS到使用逻辑资源在OS上运行应用程序</span><br><span class="line"><span class="bullet">    -</span> 松散耦合、分布式、弹性、解放的微服务: 应用程序被分解成较小的独立部分，并且可以动态部署和管理-而不是在一台大型单机上整体运行</span><br><span class="line"><span class="bullet">    -</span> 资源隔离: 可预测的应用程序性能</span><br><span class="line"><span class="bullet">    -</span> 资源利用: 高效率和高密度</span><br><span class="line"></span><br><span class="line"><span class="section"># Kubernetes 提供功能:</span></span><br><span class="line"><span class="bullet">  -</span> 服务发现和负载均衡</span><br><span class="line"><span class="bullet">  -</span> 存储编排</span><br><span class="line"><span class="bullet">  -</span> 自动部署和回滚:</span><br><span class="line"><span class="bullet">  -</span> 自动完成装箱计算:</span><br><span class="line"><span class="code">    &gt; Kubernetes 允许指定每个容器所需CPU和内存RAM 当容器指定资源请求时，Kubernetes可以做出更好的决策来管理容器资源</span></span><br><span class="line"><span class="code">  - 自我修复</span></span><br><span class="line"><span class="code">  - 密钥与配置管理:</span></span><br><span class="line"><span class="code">    &gt; Kubernetes存储和管理敏感信息</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># Kubernetes 不提供:</span></span><br><span class="line"><span class="bullet">  -</span> 不限制支持的应用程序类型: Kubernetes支持及其多种多样的工作负载，包括无状态、有状态和数据处理工作负载。如果应用程序可以在容器中运行，那么他应该可以在Kubernetes上很好的运行.</span><br><span class="line"><span class="bullet">  -</span> 不部署源代码，也不构建应用: 持续集成CI、交付和部署CI/CD工作流</span><br><span class="line"><span class="bullet">  -</span> 不提供应用程序级别的服务作为内置服务</span><br><span class="line"><span class="bullet">  -</span> 不提供日志记录、监控或报警解决方案: 提供一些集成作为概念证明并提供收集和到处指标的机制</span><br><span class="line"><span class="bullet">  -</span> 不提供不采用任何全面的机器配置、维护、管理或自我修复系统</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; Kubernetes 不仅仅是一个编排系统，实际上消除了编排的需要，编排的技术定义是执行已定义的工作流程，首先执行A，然后执行B，在执行C，Kubernetes包含一组独立的，可组合的控制过程，这些过程联系地将当前状态驱动到所提供状态，如何从A到C的方式无关紧要，也不需要几种控制，使得系统更易于使用且功能更强大、系统更健壮、更为弹性和扩展性.</span></span><br></pre></td></tr></table></figure></li>
<li>Kubernetes 组件<br><img src="/misc/images/components-of-kubernetes.svg" alt="Kubernetes关联组件"><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Control Plane Compoenents 控制平面组件</span></span><br><span class="line">  &gt; 控制平面组件对集群做出全局决策(调度),以及检测和响应集群事件</span><br><span class="line">  &gt; 控制平面组件可以在集群中的任何节点上运行</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> kube-apiserver:</span><br><span class="line"><span class="code">    &gt; 该组件公开Kubernetes API, API服务器是Kubernetes控制面的前端</span></span><br><span class="line"><span class="code">    &gt; 运行kube-apiserver多个实例并在这些实例之间平衡流量</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">  -</span> etcd:</span><br><span class="line"><span class="code">    &gt; etcd 是兼顾一致性和高可用性的键值数据库,作为保存Kubernetes所有集群数据的后台数据库</span></span><br></pre></td></tr></table></figure></li>
<li>PV、PVC、StorageClass<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Kubernetes 容器持久化存储</span></span><br><span class="line"><span class="bullet">  -</span> PV: 持久化存储的实现</span><br><span class="line"><span class="code">    &gt; 持久化存储数据卷,定义的是一个持久化存储在宿主主机上的目录</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">  -</span> PVC: 持久化存储的接口</span><br><span class="line"><span class="code">    &gt; 描述的持久化存储的属性 (Volume存储大小,可读写权限)</span></span><br><span class="line"><span class="code">    &gt; PVC必须和某个符合条件的PV进行绑定</span></span><br><span class="line"><span class="code">      - 1. PV 和 PVC 的spec字段, PV的存储(storage)大小,必须满足PVC的要求</span></span><br><span class="line"><span class="code">      - 2. PV 和 PVC 的storageClassName字段必须一样</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">  -</span> Volume Controller: 持久化存储控制器</span><br><span class="line"><span class="bullet">    -</span> PersistentVolumeController:</span><br><span class="line"><span class="code">      &gt; 不断查看当前每一个PVC是否已经处于Bound状态,如果不是，就会遍历所有的、可用的PV,尝试将其PVC进行绑定</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># 持久化Volume</span></span><br><span class="line"><span class="bullet">  -</span> 远程文件存储</span><br><span class="line"><span class="bullet">    -</span> NFS</span><br><span class="line"><span class="bullet">    -</span> GlusterFS</span><br><span class="line"><span class="bullet">  -</span> 远程快存储</span><br><span class="line"><span class="bullet">    -</span> 公有云提供的远程磁盘</span><br><span class="line"></span><br><span class="line"><span class="section"># 准备&quot;持久化&quot;宿主机目录</span></span><br><span class="line"><span class="bullet">  -</span> 第一阶段 (Attch) -- nodeName</span><br><span class="line"><span class="code">    &gt; 默认情况下，kubelet 为 Volume创建的目录是 /var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/kubernetes.io-&lt;Volume类型&gt;/&lt;Volume名字&gt;</span></span><br><span class="line"><span class="code">    &gt; AttachDetachController (运行在Master节点上)</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">  -</span> 第二阶段 (Mount) -- dir</span><br><span class="line"><span class="code">    &gt; 格式化磁盘设备,然后将其挂在到宿主机指定的挂载点上</span></span><br><span class="line"><span class="code">    &gt; VolumeManagerReconciler (运行在Node节点上,是一个独立于kubelet主循环的goroutine)</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># StorageClass:</span></span><br><span class="line">  &gt; Kubernetes 提供一套可以自动创建PV的机制，Dynamic Provisioning</span><br><span class="line">  &gt; 手动创建PV的方式叫做 Staic Provisioning</span><br><span class="line">  &gt; StorageClass的作用就是创建PV的模板</span><br><span class="line"><span class="bullet">  -</span> 1. PV的属性 (存储类型、Volume大小)</span><br><span class="line"><span class="bullet">  -</span> 2. 创建PV需要用到的存储插件(Ceph, NFS)</span><br><span class="line">  &gt; Kubernetes根据用户提交的PVC，找到对应的StorageClass,然后调用该StorageClass声明的存储插件，创建出需要的PV</span><br></pre></td></tr></table></figure>
<img src="/misc/images/kubernetes-storageclass.png" alt="StorageClass 流程"><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">搭建StorageClass + NFS</a><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 创建一个可用的NFS<span class="built_in"> Server</span></span><br><span class="line"><span class="built_in"></span>  IP: 172.30.1.14</span><br><span class="line">  <span class="builtin-name">Export</span> PATH: /export/K8sData/</span><br><span class="line"></span><br><span class="line">  $ sudo apt-<span class="builtin-name">get</span> install nfs-common cifs-utils</span><br><span class="line"></span><br><span class="line">2. 创建Service Account. 管控NFS Provisioner在K8s集群中运行的权限</span><br><span class="line"></span><br><span class="line">3. 创建StorageClass.负责建立PVC并调用NFS provisioner进行预定的工作，并让PV与PVC建立管理</span><br><span class="line">4. 创建NFS Provisioner,在NFS共享目录下创建挂载点(volume),建立PV并将PV与NFS的挂在点建立关联</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="部署Kubernetes"><a href="#部署Kubernetes" class="headerlink" title="部署Kubernetes"></a>部署Kubernetes</h2><ul>
<li><p>kubeadm</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 创建一个Master节点</span></span><br><span class="line">$ kubeadm init</span><br><span class="line"></span><br><span class="line"><span class="section"># 将一个Node节点加入当前集群</span></span><br><span class="line">$ kubeadm join <span class="xml">&lt;Master节点的IP和端口&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section"># kubeadm 工作原理</span></span><br><span class="line"><span class="bullet">  -</span> kubelet 是Kubernetes项目用来操作Docker等容器运行时的核心组件,除了跟容器运行时交互外，kubelet在配置容器网络、管理容器数据卷时，都需要直接操作宿主机.</span><br><span class="line">  &gt; Kubeadm选择一种妥协方案，把kubelet直接运行在宿主机上，然后使用容器部署其他的Kubernetes组件.</span><br><span class="line"></span><br><span class="line"><span class="section"># kubeadm init工作流程</span></span><br><span class="line"><span class="bullet">  -</span> 1. Preflight Checks 检查工作, 确定机器可以用来部署Kubernetes</span><br><span class="line"><span class="bullet">    -</span> Linux Kernal必须&gt;= 3.10</span><br><span class="line"><span class="bullet">    -</span> Linux Cgroups 模块是否可用</span><br><span class="line"><span class="bullet">    -</span> 机器的hostname是否标准</span><br><span class="line"><span class="bullet">    -</span> 安装的kubeadm和kubelet版本是否匹配</span><br><span class="line"><span class="bullet">    -</span> 机器上是不是已经安装Kubernetes二进制文件</span><br><span class="line"><span class="bullet">    -</span> Kubernetes工作端口10250/10251/10252端口是否占用</span><br><span class="line"><span class="bullet">    -</span> ip, mount Linux指令是否存在</span><br><span class="line"><span class="bullet">    -</span> docker是否安装</span><br><span class="line"><span class="bullet">  -</span> 2. 生成 kubernetes对外提供服务所需要的各种证书和目录</span><br><span class="line"><span class="bullet">    -</span> Kubernetes对外提供服务时，除非专门开启&quot;不安全模式&quot;,否则都要通过HTTPS才能访问kube-apiserver,需要kubernetes集群配置证书文件</span><br><span class="line"><span class="bullet">    -</span> /etc/kubernetes/pki (kubeadm为kubernetes项目生成的证书文件)</span><br><span class="line"><span class="bullet">  -</span> 3. kubeadm为其他组件生成访问kube-apiserver所需的配置文件</span><br><span class="line"><span class="bullet">    -</span> /etc/kubernetes/xxx.cnf</span><br><span class="line"><span class="bullet">  -</span> 4. kubeadm为Master组件生成Pod配置文件</span><br><span class="line"><span class="bullet">    -</span> kube-apiserver</span><br><span class="line"><span class="bullet">    -</span> kube-controller-manager</span><br><span class="line"><span class="bullet">    -</span> kube-scheduler</span><br><span class="line"><span class="bullet">    -</span> ETCD</span><br><span class="line"><span class="code">    &gt; 在Kubernetes中，特殊的容器启动方法&quot;Static Pod&quot;,允许把要部署的Pod的YAML文件放在一个指定的目录里，当kubelet启动时会自动检查次目录，加载所有的PodYAML文件</span></span><br><span class="line"><span class="code">  - 5. kubeadm检查localhost:6443/healthz 等待Master组件完全运行起来</span></span><br><span class="line"><span class="code">  - 6. kubeadm为集群生成一个bootstrap token.</span></span><br><span class="line"><span class="code">    - 剩余的Node节点可以通过此token加入到集群中</span></span><br><span class="line"><span class="code">  - 7. 安装插件kube-proxy和DNS</span></span><br><span class="line"><span class="code">    - kube-proxy: 集群的服务发现</span></span><br><span class="line"><span class="code">    - DNS:</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># kubeadm join工作流程</span></span><br><span class="line"><span class="bullet">  -</span> bootstrap token</span><br><span class="line"><span class="code">    &gt; kubeadm至少需要发起一次&quot;不安全模式&quot;的访问kube-apiserver,从而拿到保存在ConfigMap中的cluster-info(保存了APIServer的授权信息),而bootstrap token扮演的就是这个过程中的安全验证角色</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># kubeadm部署参数配置文件(kubeadm.yaml)</span></span><br><span class="line">  $ kubeadm init --config kubeadm.yaml</span><br></pre></td></tr></table></figure></li>
<li><p>installing kubeadm, kubelet and kubectl</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- kubeadm: the command <span class="keyword">to</span> bootstrap the <span class="keyword">cluster</span></span><br><span class="line">- kubelet: the component that runs <span class="keyword">on</span> <span class="keyword">all</span> <span class="keyword">of</span> the machines <span class="keyword">in</span> your <span class="keyword">cluster</span> <span class="keyword">and</span> does things <span class="keyword">like</span> starting pods <span class="keyword">and</span> containers.</span><br><span class="line">- kubectl: the command <span class="type">line</span> util <span class="keyword">to</span> talk <span class="keyword">to</span> your <span class="keyword">cluster</span></span><br></pre></td></tr></table></figure></li>
<li><p>container runtimes</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># common container <span class="keyword">runtime</span><span class="variable">s:</span></span><br><span class="line">  - containerd</span><br><span class="line">  - CRI-O</span><br><span class="line">  - Docker</span><br><span class="line"></span><br><span class="line"># Cgroup(Control groups) driver<span class="variable">s:</span></span><br><span class="line">  &gt; used <span class="keyword">to</span> constrain(限制) resources that are allocated <span class="keyword">to</span> processes.</span><br><span class="line">  &gt; Changing the settings such that your container <span class="keyword">runtime</span> <span class="built_in">and</span> kubelet use systemd <span class="keyword">as</span> the cgroup stabilized the <span class="built_in">system</span>.</span><br><span class="line"></span><br><span class="line"># Cgroup V2</span><br><span class="line">  &gt; <span class="keyword">is</span> the <span class="keyword">next</span> <span class="keyword">version</span> of cgroup Linux API.</span><br><span class="line">  - cleaner <span class="built_in">and</span> easier <span class="keyword">to</span> use API</span><br><span class="line">  - safe sub-tree delegation <span class="keyword">to</span> containers</span><br><span class="line">  - newer features like Pressure Stall Information</span><br><span class="line"></span><br><span class="line"># Migrating <span class="keyword">to</span> the systemd driver in kubeadm managed clusters</span><br><span class="line">  - Docker:</span><br><span class="line">    sudo <span class="built_in">mkdir</span> /etc/docker</span><br><span class="line">    <span class="keyword">cat</span> &lt;&lt;EOF | sudo tee /etc/docker/daemon.json</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">      <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">      <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    EOF</span><br><span class="line"></span><br><span class="line">  - Restart Docker <span class="built_in">and</span> enable <span class="keyword">on</span> boo<span class="variable">t:</span></span><br><span class="line">    sudo systemctl enable docker</span><br><span class="line">    sudo systemctl daemon-reload</span><br><span class="line">    sudo systemctl restart docker</span><br></pre></td></tr></table></figure></li>
<li><p>kubeadm部署</p>
<blockquote>
<p>kubeadm目前欠缺部署高可用Kubernetes集群,ETCD、Master组件都应该是多节点集群</p>
</blockquote>
</li>
</ul>
  <figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"> # 创建一个Master节点 (--image-repository指定容器镜像地址使用阿里云)</span><br><span class="line"> ➜ sudo kubeadm init [--image-repository=&#x27;registry.cn-hangzhou.aliyuncs.com/google_containers&#x27;]</span><br><span class="line"> [init] Using Kubernetes <span class="keyword">version</span>: v1.22.2</span><br><span class="line"> [preflight] Running pre-flight checks</span><br><span class="line"> [preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes <span class="keyword">cluster</span></span><br><span class="line"> [preflight] This might take a minute or <span class="keyword">two</span>, depending <span class="keyword">on</span> the speed of your internet connection</span><br><span class="line"> [preflight] You can also perform this action <span class="keyword">in</span> beforehand using &#x27;kubeadm config images pull&#x27;</span><br><span class="line"> [certs] Using certificateDir folder <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line"> [certs] Generating <span class="string">&quot;ca&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;apiserver&quot;</span> certificate and key</span><br><span class="line"> [certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [chyiyaqing-poweredge-r720 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.<span class="keyword">cluster</span>.<span class="keyword">local</span>] and IPs [10.96.0.1 192.168.50.57]</span><br><span class="line"> [certs] Generating <span class="string">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;etcd/server&quot;</span> certificate and key</span><br><span class="line"> [certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [chyiyaqing-poweredge-r720 localhost] and IPs [192.168.50.57 127.0.0.1 ::1]</span><br><span class="line"> [certs] Generating <span class="string">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class="line"> [certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [chyiyaqing-poweredge-r720 localhost] and IPs [192.168.50.57 127.0.0.1 ::1]</span><br><span class="line"> [certs] Generating <span class="string">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class="line"> [certs] Generating <span class="string">&quot;sa&quot;</span> key and public key</span><br><span class="line"> [kubeconfig] Using kubeconfig folder <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line"> [kubeconfig] Writing <span class="string">&quot;admin.conf&quot;</span> kubeconfig <span class="keyword">file</span></span><br><span class="line"> [kubeconfig] Writing <span class="string">&quot;kubelet.conf&quot;</span> kubeconfig <span class="keyword">file</span></span><br><span class="line"> [kubeconfig] Writing <span class="string">&quot;controller-manager.conf&quot;</span> kubeconfig <span class="keyword">file</span></span><br><span class="line"> [kubeconfig] Writing <span class="string">&quot;scheduler.conf&quot;</span> kubeconfig <span class="keyword">file</span></span><br><span class="line"> [kubelet-start] Writing kubelet environment <span class="keyword">file</span> with flags to <span class="keyword">file</span> <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line"> [kubelet-start] Writing kubelet configuration to <span class="keyword">file</span> <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"> [kubelet-start] Starting the kubelet</span><br><span class="line"> [control-plane] Using manifest folder <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line"> [control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span><br><span class="line"> [control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span><br><span class="line"> [control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span><br><span class="line"> [etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="keyword">local</span> etcd <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line"> [wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to <span class="keyword">boot</span> up the control plane <span class="keyword">as</span> static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s</span><br><span class="line"> [apiclient] All control plane components are healthy after 9.004478 seconds</span><br><span class="line"> [upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line"> [kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config-1.22&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the <span class="keyword">cluster</span></span><br><span class="line"> [upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line"> [<span class="keyword">mark</span>-control-plane] Marking the node chyiyaqing-poweredge-r720 <span class="keyword">as</span> control-plane <span class="keyword">by</span> adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line"> [<span class="keyword">mark</span>-control-plane] Marking the node chyiyaqing-poweredge-r720 <span class="keyword">as</span> control-plane <span class="keyword">by</span> adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] Using <span class="keyword">token</span>: z7bgdd.d4lm4cueg5vo9krh</span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] Configuring <span class="keyword">bootstrap</span> tokens, <span class="keyword">cluster</span>-info ConfigMap, RBAC Roles</span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow Node <span class="keyword">Bootstrap</span> tokens to get nodes</span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow Node <span class="keyword">Bootstrap</span> tokens to <span class="keyword">post</span> CSRs <span class="keyword">in</span> <span class="keyword">order</span> <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node <span class="keyword">Bootstrap</span> <span class="keyword">Token</span></span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the <span class="keyword">cluster</span></span><br><span class="line"> [<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] Creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line"> [kubelet-finalize] Updating <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line"> [addons] Applied essential addon: CoreDNS</span><br><span class="line"> [addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line"> Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line"> To start using your <span class="keyword">cluster</span>, you need to <span class="keyword">run</span> the following <span class="keyword">as</span> a regular user:</span><br><span class="line"></span><br><span class="line">   <span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">   sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">   sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"> Alternatively, <span class="keyword">if</span> you are the root user, you can <span class="keyword">run</span>:</span><br><span class="line"></span><br><span class="line">   export KUBECONFIG=/etc/kubernetes/admin.<span class="keyword">conf</span></span><br><span class="line"></span><br><span class="line"> You should now deploy a pod network to the <span class="keyword">cluster</span>.</span><br><span class="line"> <span class="keyword">Run</span> <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with <span class="keyword">one</span> of the options listed at:</span><br><span class="line">   https:<span class="comment">//kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"></span><br><span class="line"> Then you can join any number of worker nodes <span class="keyword">by</span> running the following <span class="keyword">on</span> each <span class="keyword">as</span> root:</span><br><span class="line"></span><br><span class="line"> kubeadm join 192.168.50.57:6443 --<span class="keyword">token</span> z7bgdd.d4lm4cueg5vo9krh \</span><br><span class="line">--discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:f56091fb52dddc01e552ad110b3479015f4bcdaba5fadec6d76eadab1b3ee48b</span><br><span class="line"></span><br><span class="line"> # 将一个Node节点加入当前集群</span><br><span class="line"> $ kubeadm join &lt;Master节点的IP和端口&gt;</span><br><span class="line"></span><br><span class="line"> # 获取kubeadm临时生成的<span class="keyword">token</span></span><br><span class="line"> ➜ kubeadm <span class="keyword">token</span> <span class="keyword">list</span></span><br><span class="line"> <span class="keyword">TOKEN</span>                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS</span><br><span class="line"> z1ktsy.k2dzz0m17d42nsem   23h         2021-10-15T05:26:51Z   authentication,signing   The default <span class="keyword">bootstrap</span> <span class="keyword">token</span> generated <span class="keyword">by</span> &#x27;kubeadm init&#x27;.   system:bootstrappers:kubeadm:default-node-<span class="keyword">token</span></span><br><span class="line"></span><br><span class="line"> # 查看nodes</span><br><span class="line"> ➜ kubectl get nodes</span><br><span class="line"> NAME                        STATUS   ROLES                  AGE     <span class="keyword">VERSION</span></span><br><span class="line"> chyiyaqing-poweredge-r720   Ready    control-plane,master   4m49s   v1.22.2</span><br><span class="line"></span><br><span class="line"> # 查看Pod运行情况</span><br><span class="line"> ➜ kubectl get pod -A</span><br><span class="line"> NAMESPACE     NAME                                                READY   STATUS              RESTARTS   AGE</span><br><span class="line"> kube-system   coredns-7d89d9b6b8-cch8p                            0/1     ContainerCreating   0          5m10s</span><br><span class="line"> kube-system   coredns-7d89d9b6b8-vkzw7                            0/1     ContainerCreating   0          5m10s</span><br><span class="line"> kube-system   etcd-chyiyaqing-poweredge-r720                      1/1     Running             0          5m15s</span><br><span class="line"> kube-system   kube-apiserver-chyiyaqing-poweredge-r720            1/1     Running             0          5m15s</span><br><span class="line"> kube-system   kube-controller-manager-chyiyaqing-poweredge-r720   1/1     Running             0          5m17s</span><br><span class="line"> kube-system   kube-proxy-smnf2                                    1/1     Running             0          5m10s</span><br><span class="line"> kube-system   kube-scheduler-chyiyaqing-poweredge-r720            1/1     Running             0          5m14s</span><br><span class="line"></span><br><span class="line"> # kubectl <span class="keyword">describe</span> 查看节点详细信息、状态和事件Event</span><br><span class="line"> ➜ kubectl <span class="keyword">describe</span> pod coredns-7d89d9b6b8-cch8p -<span class="keyword">n</span> kube-system</span><br><span class="line"> Name:                 coredns-7d89d9b6b8-cch8p</span><br><span class="line"> Namespace:            kube-system</span><br><span class="line"> Priority:             2000000000</span><br><span class="line"> Priority <span class="keyword">Class</span> Name:  system-<span class="keyword">cluster</span>-critical</span><br><span class="line"> Node:                 chyiyaqing-poweredge-r720/192.168.50.57</span><br><span class="line"> Start Time:           Thu, 14 Oct 2021 13:27:02 +0800</span><br><span class="line"> Labels:               k8s-<span class="keyword">app</span>=kube-dns</span><br><span class="line">                       pod-template-hash=7d89d9b6b8</span><br><span class="line"> Annotations:          &lt;none&gt;</span><br><span class="line"> Status:               Pending</span><br><span class="line"> IP:</span><br><span class="line"> IPs:                  &lt;none&gt;</span><br><span class="line"> Controlled <span class="keyword">By</span>:        ReplicaSet/coredns-7d89d9b6b8</span><br><span class="line"> Containers:</span><br><span class="line">   coredns:</span><br><span class="line">     Container ID:</span><br><span class="line">     Image:         registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4</span><br><span class="line">     Image ID:</span><br><span class="line">     Ports:         53/UDP, 53/TCP, 9153/TCP</span><br><span class="line">     Host Ports:    0/UDP, 0/TCP, 0/TCP</span><br><span class="line">     <span class="keyword">Args</span>:</span><br><span class="line">       -<span class="keyword">conf</span></span><br><span class="line">       /etc/coredns/Corefile</span><br><span class="line">     State:          Waiting</span><br><span class="line">       Reason:       ContainerCreating</span><br><span class="line">     Ready:          False</span><br><span class="line">     Restart <span class="keyword">Count</span>:  0</span><br><span class="line">     Limits:</span><br><span class="line">       <span class="keyword">memory</span>:  170Mi</span><br><span class="line">     Requests:</span><br><span class="line">       cpu:        100m</span><br><span class="line">       <span class="keyword">memory</span>:     70Mi</span><br><span class="line">     Liveness:     http-get http:<span class="comment">//:8080/health delay=60s timeout=5s period=10s #success=1 #failure=5</span></span><br><span class="line">     Readiness:    http-get http:<span class="comment">//:8181/ready delay=0s timeout=1s period=10s #success=1 #failure=3</span></span><br><span class="line">     Environment:  &lt;none&gt;</span><br><span class="line">     Mounts:</span><br><span class="line">       /etc/coredns from config-volume (ro)</span><br><span class="line">       /<span class="keyword">var</span>/<span class="keyword">run</span>/secrets/kubernetes.io/serviceaccount from kube-api-access-qdx6w (ro)</span><br><span class="line"> Conditions:</span><br><span class="line">   <span class="keyword">Type</span>              Status</span><br><span class="line">   Initialized       True</span><br><span class="line">   Ready             False</span><br><span class="line">   ContainersReady   False</span><br><span class="line">   PodScheduled      True</span><br><span class="line"> Volumes:</span><br><span class="line">   config-volume:</span><br><span class="line">     <span class="keyword">Type</span>:      ConfigMap (a volume populated <span class="keyword">by</span> a ConfigMap)</span><br><span class="line">     Name:      coredns</span><br><span class="line">     Optional:  false</span><br><span class="line">   kube-api-access-qdx6w:</span><br><span class="line">     <span class="keyword">Type</span>:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">     TokenExpirationSeconds:  3607</span><br><span class="line">     ConfigMapName:           kube-root-<span class="keyword">ca</span>.crt</span><br><span class="line">     ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">     DownwardAPI:             true</span><br><span class="line"> QoS <span class="keyword">Class</span>:                   Burstable</span><br><span class="line"> Node-Selectors:              kubernetes.io/os=linux</span><br><span class="line"> Tolerations:                 CriticalAddonsOnly op=Exists</span><br><span class="line">                              node-role.kubernetes.io/control-plane:NoSchedule</span><br><span class="line">                              node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">                              node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                              node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line"> Events:</span><br><span class="line">   <span class="keyword">Type</span>     Reason                  Age                  From               Message</span><br><span class="line">   ----     ------                  ----                 ----               -------</span><br><span class="line">   Warning  FailedScheduling        6m12s                default-scheduler  0/1 nodes are available: 1 node(s) had taint &#123;node.kubernetes.io/not-ready: &#125;, that the pod didn&#x27;t tolerate.</span><br><span class="line">   Normal   Scheduled               6m7s                 default-scheduler  Successfully assigned kube-system/coredns-7d89d9b6b8-cch8p to chyiyaqing-poweredge-r720</span><br><span class="line">   Warning  FailedCreatePodSandBox  6m6s                 kubelet            Failed to create pod sandbox: rpc <span class="keyword">error</span>: code = Unknown <span class="keyword">desc</span> = [failed to <span class="keyword">set</span> up sandbox container <span class="string">&quot;d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span> network <span class="keyword">for</span> pod <span class="string">&quot;coredns-7d89d9b6b8-cch8p&quot;</span>: networkPlugin cni failed to <span class="keyword">set</span> up pod <span class="string">&quot;coredns-7d89d9b6b8-cch8p_kube-system&quot;</span> network: unable to allocate IP address: <span class="keyword">Post</span> <span class="string">&quot;http://127.0.0.1:6784/ip/d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span>: dial tcp 127.0.0.1:6784: connect: connection refused, failed to clean up sandbox container <span class="string">&quot;d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span> network <span class="keyword">for</span> pod <span class="string">&quot;coredns-7d89d9b6b8-cch8p&quot;</span>: networkPlugin cni failed to teardown pod <span class="string">&quot;coredns-7d89d9b6b8-cch8p_kube-system&quot;</span> network: Delete <span class="string">&quot;http://127.0.0.1:6784/ip/d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span>: dial tcp 127.0.0.1:6784: connect: connection refused]</span><br><span class="line">   Normal   SandboxChanged          63s (x25 over 6m5s)  kubelet            Pod sandbox changed, it will be killed and re-created.</span><br><span class="line"></span><br><span class="line"> # 通过Taint/Toleration 调整Master执行Pod的策略 (由于本地搭建环境kubeamd只有一个Master节点)</span><br><span class="line"> &gt; 默认情况下Master节点是不允许运行用户Pod的, Kubernetes依赖Taint/Toleration机制</span><br><span class="line">   - 为节点打上污点(Taint)</span><br><span class="line">     &gt; $ kubectl taint nodes &lt;node-1&gt; foo=bar:NoSchedule</span><br><span class="line">   - 删除Taint</span><br><span class="line">     ➜ kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class="line">     node/chyiyaqing-poweredge-r720 untainted</span><br><span class="line"> # 安装网络插件</span><br><span class="line">     ➜ kubectl apply -f <span class="string">&quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">     serviceaccount/weave-<span class="keyword">net</span> created</span><br><span class="line">     clusterrole.rbac.authorization.k8s.io/weave-<span class="keyword">net</span> created</span><br><span class="line">     clusterrolebinding.rbac.authorization.k8s.io/weave-<span class="keyword">net</span> created</span><br><span class="line">     role.rbac.authorization.k8s.io/weave-<span class="keyword">net</span> created</span><br><span class="line">     rolebinding.rbac.authorization.k8s.io/weave-<span class="keyword">net</span> created</span><br><span class="line">     daemonset.apps/weave-<span class="keyword">net</span> created</span><br></pre></td></tr></table></figure>
<ul>
<li><p>kubernetes CNI (Container Network Interface)<br><img src="/misc/images/kubernetes-cni-architecture.png" alt="CNI plugin architecture"></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt; Kubernetes supports CNI plugins <span class="keyword">for</span> <span class="keyword">the</span> communication <span class="keyword">between</span> pods.</span><br><span class="line">&gt; kubeadm <span class="keyword">does</span> <span class="keyword">not</span> support kubenet. you should use a CNI plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes impose(施加) following rules for network communication:</span></span><br><span class="line">  - All containers can communicate <span class="keyword">with</span> all other containers <span class="keyword">without</span> NAT</span><br><span class="line">  - All nodes can communicate <span class="keyword">with</span> all container (<span class="keyword">and</span> vice-versa) <span class="keyword">without</span> NAT</span><br><span class="line">  - The IP <span class="keyword">that</span> a container sees itself <span class="keyword">as</span> <span class="keyword">is</span> <span class="keyword">the</span> same IP <span class="keyword">that</span> others see <span class="keyword">it</span> <span class="keyword">as</span>.</span><br><span class="line"></span><br><span class="line">CNI plugins generally use kube-proxy <span class="keyword">or</span> directory iptables <span class="keyword">for</span> routing. However, Cilium <span class="keyword">is</span> based <span class="keyword">on</span> BPF <span class="keyword">and</span> XDP <span class="keyword">to</span> provide a faster <span class="keyword">and</span> more scalable option.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plugins:</span></span><br><span class="line">  - Flannel:</span><br><span class="line">    - provides VXLAN tunneling solution 隧道解决方案</span><br><span class="line">    - configuration <span class="keyword">and</span> management are very simple</span><br><span class="line">    - <span class="keyword">does</span> <span class="keyword">not</span> support Network Policies</span><br><span class="line">  - Calico:</span><br><span class="line">    - default choice <span class="keyword">of</span> <span class="keyword">the</span> most <span class="keyword">of</span> kubernetes platform (kubespary, docker enterprise)</span><br><span class="line">    - uses BGP <span class="keyword">and</span> Bird, a daemon called Felix configures routes <span class="keyword">on</span> Bird</span><br><span class="line">    - supports IP-IP encapsulation <span class="keyword">if</span> BGP cannot be used.</span><br><span class="line">    - supports Network Policies</span><br><span class="line">    - uses iptables <span class="keyword">for</span> routing <span class="keyword">but</span> <span class="keyword">it</span> can be configured <span class="keyword">to</span> use kube-proxy&#x27;s IPVS mode.</span><br><span class="line">  - Weave:</span><br><span class="line">    - Provides VXLAN tunneling solution</span><br><span class="line">    - all <span class="keyword">of</span> <span class="keyword">the</span> nodes are connected <span class="keyword">as</span> mesh which allows <span class="keyword">it</span> <span class="keyword">to</span> <span class="built_in">run</span> <span class="keyword">on</span> paritially connected networks.</span><br><span class="line">    - stores configuration files <span class="keyword">on</span> pods <span class="keyword">instead of</span> kubernetes CRDs <span class="keyword">or</span> etcd</span><br><span class="line">    - has an encryption library</span><br><span class="line">    - supports Network Policies</span><br><span class="line">  - Cilium</span><br><span class="line">    - Linux kernel must be <span class="keyword">at</span> least <span class="number">4.9</span></span><br><span class="line">  - kube-router:</span><br><span class="line">    -</span><br></pre></td></tr></table></figure>
<ul>
<li>Terminology<ul>
<li>kube-proxy<ul>
<li>Kube-proxy tree mods: 三个模组<ul>
<li>userspace:<br><img src="/misc/images/kube-proxy-userspace-mode.png" alt="kube-proxy Userspace mode"><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; It adds rules <span class="keyword">to</span> iptables so <span class="keyword">that</span> all communication redirects <span class="keyword">through</span> proxy server. It <span class="keyword">is</span> no longer used <span class="keyword">since</span> <span class="keyword">it</span> <span class="keyword">is</span> much slower compared <span class="keyword">to</span> <span class="keyword">the</span> other modes.</span><br></pre></td></tr></table></figure></li>
<li>Iptables:<br><img src="/misc/images/kube-proxy-iptables-mode.png" alt="kube-proxy iptables mode"><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; This mode adds rules <span class="keyword">to</span> iptables so that iptables redirects straight <span class="keyword">to</span> pods <span class="keyword">without</span> <span class="keyword">using</span> a proxy <span class="keyword">server</span>. It <span class="keyword">is</span> the <span class="keyword">default</span> mode <span class="keyword">of</span> kube-proxy.</span><br></pre></td></tr></table></figure></li>
<li>IPVS:<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPVS (IP Virtual <span class="keyword">Server</span>) <span class="keyword">is</span> layer<span class="number">-4</span> <span class="keyword">load</span> balancer inside the Linux kernel. It <span class="keyword">is</span> built <span class="keyword">on</span> top <span class="keyword">of</span> netfilter <span class="keyword">like</span> iptables. It utilizes hash <span class="keyword">table</span> <span class="keyword">instead</span> <span class="keyword">of</span> chain <span class="keyword">as</span> <span class="keyword">in</span> iptables.</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>Network policy<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kubernetes specification <span class="keyword">that</span> can be used <span class="keyword">to</span> control traffic <span class="keyword">between</span> pods.</span><br></pre></td></tr></table></figure></li>
<li>Overlay Networks<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An overlay network abstracts <span class="keyword">a</span> physical (underlay) network <span class="built_in">to</span> <span class="built_in">create</span> virtual network. It provides simpler interface <span class="keyword">by</span> hiding complexities <span class="keyword">of</span> <span class="keyword">the</span> underlay.</span><br></pre></td></tr></table></figure></li>
<li>VXLAN<br><img src="/misc/images/vxlan-architecture.png" alt="VXLAN architecture"><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VXLAN <span class="keyword">is</span> a network tunneling(隧道) protocol <span class="keyword">in</span> <span class="keyword">the</span> Linux Kernel. Network tunneling means hiding protocol (VXLAN) within another protocol (TCP/IP).VXLAN tuneels layer <span class="number">2</span> frames inside <span class="keyword">of</span> Layer <span class="number">4</span> UDP datagrams.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux network structure in VXLAN:</span></span><br><span class="line">  - veth: Virtual ethernet pair, <span class="keyword">it</span> connects network namespaces</span><br><span class="line">  - bridge: It <span class="keyword">is</span> used <span class="keyword">to</span> connect ethernet pairs <span class="keyword">in</span> Linux</span><br><span class="line">  - vtep: VXLAN tunnel endpoint, <span class="keyword">it</span>&#x27;s entry/<span class="keyword">exit</span> point <span class="keyword">for</span> VXLAN tunnels</span><br></pre></td></tr></table></figure></li>
<li>BGP(Border gateway protocol) - 边界网关协议</li>
<li>BPF(Berkeley Packet Filter) - 伯克利数据包过滤器</li>
<li>XDP (eXpress Data Path)<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XDP <span class="keyword">is</span> a data <span class="type">path</span> recently added <span class="keyword">to</span> Linux kernel. It relies <span class="keyword">on</span> eBPF <span class="keyword">to</span> <span class="keyword">perform</span> fast packet processing.</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>kubernetes安装Metrics Server</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; Metrics Server是集群中资源使用情况的聚合器, Metrics Server从kubelets收集资源指标，并通过Metrics API将他们暴露在Kubernetes apiserver中,以供Horizontal Pod Autoscaler和Vertical Pod Autoscaler使用.</span><br><span class="line">&gt; Metrics Server不适用与非自动缩放目的，不要使用他将指标转发到监控解决方案，或作为监控解决方案指标的来源,这种情况可以使用kuberlet<span class="regexp">/metrics/</span>resource 端点收集指标</span><br><span class="line"></span><br><span class="line"><span class="comment"># Installation</span></span><br><span class="line">- kubectl apply -f https:<span class="regexp">//gi</span>thub.com<span class="regexp">/kubernetes-sigs/m</span>etrics-server<span class="regexp">/releases/</span>latest<span class="regexp">/download/</span>components.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fix: (cannot validate certificate, doesn&#x27;t contain any IP SANs)</span></span><br><span class="line">  - $ kubectl edit deployment metrics-server -n kube-system</span><br><span class="line">    &gt; modifying the metrics-server deployment template, and adding the argument - --kubelet-insecure-tls to the container args</span><br></pre></td></tr></table></figure></li>
<li><p>Kubernetes集群安装Dashboard</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dashboard(Web界面) 可视化插件</span></span><br><span class="line">  ➜ wget kubectl apply -f https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/kubernetes/</span>dashboard<span class="regexp">/v2.2.0/</span>aio<span class="regexp">/deploy/</span>recommended.yaml</span><br><span class="line">  namespace/kubernetes-dashboard created</span><br><span class="line">  serviceaccount/kubernetes-dashboard created</span><br><span class="line">  service/kubernetes-dashboard created</span><br><span class="line">  secret/kubernetes-dashboard-certs created</span><br><span class="line">  secret/kubernetes-dashboard-csrf created</span><br><span class="line">  secret/kubernetes-dashboard-key-holder created</span><br><span class="line">  configmap/kubernetes-dashboard-settings created</span><br><span class="line">  role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">  clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">  rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">  clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">  deployment.apps/kubernetes-dashboard created</span><br><span class="line">  service/dashboard-metrics-scraper created</span><br><span class="line">  Warning: spec.template.metadata.annotations[seccomp.security.alpha.kubernetes.io/pod]: deprecated since v1.<span class="number">19</span>; use the <span class="string">&quot;seccompProfile&quot;</span> field instead</span><br><span class="line">  deployment.apps/dashboard-metrics-scraper created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Dashboard对应的Pod状态</span></span><br><span class="line">➜ kubectl get pods -n kubernetes-dashboard</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-<span class="number">856586</span>f554-w4vvw   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m19s</span><br><span class="line">kubernetes-dashboard-<span class="number">78</span>c79f97b4-l8nmb        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m19s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令行代理 kubectl 访问DashBoard</span></span><br><span class="line">$ kubectl proxy --address=<span class="string">&#x27;0.0.0.0&#x27;</span> --port=<span class="number">8001</span> --accept-hosts=<span class="string">&#x27;.*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从集群外部访问Dashboard 需要使用Ingress</span></span><br></pre></td></tr></table></figure></li>
<li><p>Kubernetes部署存储插件</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; 容器持久化存储,用来保存容器存储状态,存储插件会在容器中挂在一个基于网络或者其他机制的远程数据卷. 使得在容器里创建的文件，实际上保存在远程存储服务器上,</span><br><span class="line"></span><br><span class="line"># Kubernetes 存储插件 - Rook</span><br><span class="line">  &gt; Rook项目是一个基于Ceph的Kubernetes存储插件，不同于Ceph的简单封装，Rook加入了对平扩展、迁移、灾难备份、监控等大量的企业级功能.</span><br><span class="line">  - 部署基于Rook持久化存储集群以容器方式运行</span><br><span class="line">    $ git clone <span class="comment">--single-branch --branch release-1.7 https://github.com/rook/rook.git</span></span><br><span class="line">    cd rook/<span class="keyword">cluster</span>/examples/kubernetes/ceph</span><br><span class="line">    kubectl <span class="keyword">create</span> -f crds.yaml -f common.yaml -f <span class="keyword">operator</span>.yaml</span><br><span class="line">    kubectl <span class="keyword">create</span> -f <span class="keyword">cluster</span>.yaml</span><br><span class="line"></span><br><span class="line">  - 查看Rook部署的Namespace</span><br><span class="line">    ➜ k <span class="keyword">get</span> pods -n rook-ceph</span><br><span class="line">    <span class="type">NAME</span>                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">    csi-cephfsplugin<span class="number">-7</span>l9xb                         <span class="number">3</span>/<span class="number">3</span>     Running   <span class="number">0</span>          <span class="number">15</span>m</span><br><span class="line">    csi-cephfsplugin-provisioner<span class="number">-689686</span>b44-qpt5q   <span class="number">6</span>/<span class="number">6</span>     Running   <span class="number">0</span>          <span class="number">15</span>m</span><br><span class="line">    csi-rbdplugin-provisioner<span class="number">-5775</span>fb866b<span class="number">-25224</span>     <span class="number">6</span>/<span class="number">6</span>     Running   <span class="number">0</span>          <span class="number">15</span>m</span><br><span class="line">    csi-rbdplugin-vvq94                            <span class="number">3</span>/<span class="number">3</span>     Running   <span class="number">0</span>          <span class="number">15</span>m</span><br><span class="line">    rook-ceph-<span class="keyword">operator</span><span class="number">-7</span>bdb744878-zz2fm            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">24</span>m</span><br><span class="line"></span><br><span class="line">  &gt; Kubernetes项目创建的所有Pod就能够通过Persistent Volume (PV) 和 Persistent Volume Claim (PVC) 的方式，在容器里挂载由Ceph提供的数据卷</span><br><span class="line"></span><br><span class="line">  - <span class="keyword">Storage</span></span><br><span class="line">    - Block: <span class="keyword">Create</span> block <span class="keyword">storage</span> <span class="keyword">to</span> be consumed <span class="keyword">by</span> a pod (RWO)</span><br><span class="line">      &gt; <span class="keyword">Before</span> Rook can provision <span class="keyword">storage</span>, a **StorageClass** <span class="keyword">and</span> **CephBlockPool** need <span class="keyword">to</span> be created.</span><br><span class="line">    - Shared FileSystem: <span class="keyword">Create</span> a filesystem <span class="keyword">to</span> be shared across multiple pods (RWX)</span><br><span class="line">    - <span class="keyword">Object</span>: <span class="keyword">Create</span> an <span class="keyword">object</span> store that <span class="keyword">is</span> accessible inside <span class="keyword">or</span> outside the Kubernetes <span class="keyword">cluster</span></span><br></pre></td></tr></table></figure></li>
<li><p>HELM</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt; Helm is the package manager for Kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="section"># Helm 三大概念</span></span><br><span class="line"><span class="bullet">  -</span> Chart: helm包</span><br><span class="line"><span class="code">    &gt; 包含Kubernetes集群内部运行应用程序,工具或服务所需的所有资源定义</span></span><br><span class="line"><span class="code">  - Repository: 仓库</span></span><br><span class="line"><span class="code">    &gt; 存放和共享charts</span></span><br><span class="line"><span class="code">  - Release:</span></span><br><span class="line"><span class="code">    &gt; 运行在Kubernetes集群中的chart实例</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># helm search - 查找Charts</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Kubernetes-IN-Docker-Kind"><a href="#Kubernetes-IN-Docker-Kind" class="headerlink" title="Kubernetes IN Docker (Kind)"></a>Kubernetes IN Docker (Kind)</h2><blockquote>
<p>local clusters for testing Kubernetes</p>
</blockquote>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># Installation</span><br><span class="line">  $ go install sigs.k8s.io/kind@v0.11.1</span><br><span class="line"></span><br><span class="line"># Creating a Cluster</span><br><span class="line">  $ kind <span class="keyword">create</span> <span class="keyword">cluster</span> # Default <span class="keyword">cluster</span> context name <span class="keyword">is</span> <span class="symbol">`kind`</span></span><br><span class="line">  Creating <span class="keyword">cluster</span> <span class="string">&quot;kind&quot;</span> ...</span><br><span class="line">   ✓ Ensuring node image (kindest/node:v1<span class="number">.21</span><span class="number">.1</span>) 🖼</span><br><span class="line">   ✓ Preparing nodes 📦</span><br><span class="line">   ✓ Writing configuration 📜</span><br><span class="line">   ✓ Starting control-plane 🕹️</span><br><span class="line">   ✓ Installing CNI 🔌</span><br><span class="line">   ✓ Installing StorageClass 💾</span><br><span class="line">  <span class="keyword">Set</span> kubectl context <span class="keyword">to</span> <span class="string">&quot;kind-kind&quot;</span></span><br><span class="line">  You can now <span class="keyword">use</span> your <span class="keyword">cluster</span> <span class="keyword">with</span>:</span><br><span class="line"></span><br><span class="line">  kubectl <span class="keyword">cluster</span>-info --context kind-kind</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Not</span> sure what <span class="keyword">to</span> <span class="keyword">do</span> next? 😅  Check out https://kind.sigs.k8s.io/docs/<span class="keyword">user</span>/quick-<span class="keyword">start</span>/</span><br><span class="line"></span><br><span class="line">  ❯ kubectl <span class="keyword">cluster</span>-info --context kind-kind  # interact <span class="keyword">with</span> a specific <span class="keyword">cluster</span></span><br><span class="line">  Kubernetes control plane <span class="keyword">is</span> running at https://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">45967</span></span><br><span class="line">  CoreDNS <span class="keyword">is</span> running at https://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">45967</span>/api/v1/namespaces/kube-<span class="keyword">system</span>/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line">  <span class="keyword">To</span> further debug <span class="keyword">and</span> diagnose <span class="keyword">cluster</span> problems, <span class="keyword">use</span> <span class="string">&#x27;kubectl cluster-info dump&#x27;</span>.</span><br><span class="line"></span><br><span class="line">  ❯ kind get clusters  # list kind clusters</span><br><span class="line">  kind</span><br></pre></td></tr></table></figure>

<h2 id="容器化应用"><a href="#容器化应用" class="headerlink" title="容器化应用"></a>容器化应用</h2><ul>
<li>Kubernetes API 对象定义<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&gt; Kubernetes 不推荐使用命令行方式直接运行容器(kubectl <span class="keyword">run</span>), 而是希望使用YAML方式(kubectl <span class="keyword">create</span> -f yaml)</span><br><span class="line">&gt; 使用一个API对象(Deployment)管理另一种API对象(Pod)的方式叫做“控制器”模式 (Controller pattern)</span><br><span class="line">&gt; Pod 是Kubernetes世界里的“应用”,而一个应用可以由多个容器组成.</span><br><span class="line"></span><br><span class="line">- metadata: API对象的元数据</span><br><span class="line">- spec: 描述它要表达的功能</span><br><span class="line">- labels: 一组<span class="built_in">key</span>-value格式的标签</span><br><span class="line">- spec.selector.matchLabels: Label Selector 标签选择器</span><br><span class="line">- annotations: 一组<span class="built_in">key</span>-value格式的内部信息(kubernetes组件本身感兴趣, 在Kubernetes运行过程中被自动加载到API对象上)</span><br><span class="line"></span><br><span class="line">➜ k get pods -l app=nginx</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment<span class="number">-5</span>d59d67564<span class="number">-8</span>qtq5   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">11</span>m</span><br><span class="line">nginx-deployment<span class="number">-5</span>d59d67564-xx29g   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">11</span>m</span><br><span class="line"></span><br><span class="line"><span class="meta"># 使用kubectl apply 统一进行kubernetes对象的创建和更新操作</span></span><br><span class="line">$ k apply -f nginx-deployment.yaml</span><br><span class="line">$ k <span class="built_in">exec</span> -it nginx-deployment<span class="number">-748</span>c6fff66-plhwq -- /bin/bash</span><br><span class="line">$ k <span class="keyword">delete</span> -f nginx-deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta"># emptyDir</span></span><br><span class="line">  &gt; 不显式声明宿主主机目录的<span class="built_in">Volume</span>,Kubernetes会在宿主主机上创建一个临时目录,这个目录会被绑定到容器所声明的<span class="built_in">Volume</span>目录上(Kubernetes的emptyDir类型，只是把kubernetes创建的临时目录作为<span class="built_in">Volume</span>宿主机目录，交给Docker)</span><br><span class="line"></span><br><span class="line"><span class="meta"># hostPath</span></span><br><span class="line">  &gt; 显式的<span class="built_in">Volume</span>定义</span><br><span class="line">  ...</span><br><span class="line">    volumes:</span><br><span class="line">      - name: nginx-vol</span><br><span class="line">        hostPath:</span><br><span class="line">          path: <span class="string">&quot; /var/data&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>Pod实现原理<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> <span class="javascript">Pod是Kuberntes项目的原子调度单位,kubernetes项目的调度器是统一按照Pod而非容器的资源需求进行计算</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Docker容器的本质<span class="string">&quot;Namespace隔离，Cgroups限制，rootfs文件系统&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Pod是Kubernetes里院子调度单位，Kubernetes项目的调度器是统一按照Pod而非容器的资源需求进行计算.</span></span><br><span class="line"></span><br><span class="line"># 展示系统中正在运行的进程树状结构</span><br><span class="line">$ pstree - display a tree of process</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">容器的<span class="string">&quot;单进程模型&quot;</span>并不是指容器里只能运行<span class="string">&quot;一个&quot;</span>进程,而是指容器没有管理多个进程的能力,</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Pod在Kubernetes项目里“容器设计模型”</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Pod其实是一组共享了某些资源的容器;Pod里的所有容器共享的是一个Network Namespace,并且可以声明共享一个Volume.</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Pod实际上扮演传统基础设施里<span class="string">&quot;虚拟机&quot;</span>的角色，而容器则是这个虚拟机里运行的用户程序</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Pod Infra容器<br><img src="/misc/images/kubernetes-pod-infra.png" alt="Pod Infra"><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> <span class="javascript">Kubernetes项目中Pod实现使用一个中间容器，这个容器叫做Infra容器,在Pod中,Infra容器都是第一个被创建的容器</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Infra 容器使用k8s.gcr.io/pause镜像使用汇编语言编写，永远处于<span class="string">&quot;暂停&quot;</span>状态的容器,解压后大小只有<span class="number">100</span>～200KB</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">Pod声明周期只跟Infra容器一致，而与容器A和B无关</span></span><br></pre></td></tr></table></figure></li>
<li>容器设计模式<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sidecar</span></span><br><span class="line"><span class="meta">  &gt;</span><span class="bash"> 我们可以在一个Pod中启动一个辅助容器，来完成一些独立主容器之外的工作</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Istio - 微服务治理项目</span></span><br><span class="line"><span class="meta">  &gt;</span><span class="bash"> 使用sidecar容器完成微服务治理的原理</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>深入解析Pod对象(-): 基本概念<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt; Kubernetes 项目的最小编排单元 &quot;Pod&quot;</span></span><br><span class="line"><span class="quote">&gt; Pod扮演的是传统部署环境里&quot;虚拟机&quot;的角色</span></span><br><span class="line"></span><br><span class="line"><span class="section"># Pod属性</span></span><br><span class="line"><span class="bullet">  -</span> 调度、网络、存储、安全</span><br><span class="line"><span class="bullet">  -</span> NodeSelector (将Pod与Node进行绑定的字段)</span><br><span class="line"><span class="bullet">  -</span> NodeName: (调度的结果)</span><br><span class="line"><span class="bullet">  -</span> 凡是Pod中的容器要共享宿主机的Namespace,一定是Pod级别的定义</span><br><span class="line"></span><br><span class="line"><span class="section"># Container属性</span></span><br><span class="line"><span class="bullet">  -</span> ImagePullPolicy: 镜像拉取策略</span><br><span class="line"></span><br><span class="line"><span class="section"># Pod对象在Kubernetes中的声明周期</span></span><br><span class="line"><span class="bullet">  -</span> phase:</span><br><span class="line"><span class="bullet">    -</span> Pending: Pod的YAML文件已经提交Kubernetes, API对象已经被创建保存在Etcd当中</span><br><span class="line"><span class="bullet">    -</span> Running: Pod已经调度成功,与具体节点绑定</span><br><span class="line"><span class="bullet">    -</span> Succeeded: Pod中所有容器都正常运行完毕，并且已经退出</span><br><span class="line"><span class="bullet">    -</span> Failed: Pod中至少有一个容器以不正常的状态退出</span><br><span class="line"><span class="bullet">    -</span> Unknown: Pod状态不能持续被kubelet上报给kube-apiserver</span><br><span class="line"><span class="bullet">  -</span> status.condation</span><br><span class="line"><span class="bullet">    -</span> PodScheduled:</span><br><span class="line"><span class="bullet">    -</span> Initialized</span><br><span class="line"><span class="bullet">    -</span> Ready</span><br><span class="line"><span class="bullet">    -</span> ContainersReady</span><br><span class="line"><span class="section"># Volume</span></span><br><span class="line"><span class="bullet">  -</span> Projected Volume</span><br><span class="line"><span class="bullet">    -</span> Secret: 加密数据存放在Etcd,通过Pod容器挂载Volume方式访问Secret,Secret对象存储数据经过base64转码</span><br><span class="line"><span class="bullet">    -</span> ConfigMap: 保存不需要加密、应用所需的配置信息</span><br><span class="line"><span class="bullet">    -</span> Downward API: 直接获取Pod API 对象本身的信息</span><br><span class="line"><span class="bullet">      -</span> spec.nodeName: 宿主机名字</span><br><span class="line"><span class="bullet">      -</span> status.hostIP: 宿主机IP</span><br><span class="line"><span class="bullet">      -</span> metadata.name: Pod名字</span><br><span class="line"><span class="bullet">      -</span> metadata.namespace: Pod的Namespace</span><br><span class="line"><span class="bullet">      -</span> status.podIP: Pod的IP</span><br><span class="line"><span class="bullet">      -</span> spec.serviceAccountName:</span><br><span class="line"><span class="bullet">      -</span> metadata.uid</span><br><span class="line"><span class="bullet">      -</span> metadata.labels</span><br><span class="line"><span class="bullet">      -</span> metadata.annotations</span><br><span class="line"><span class="bullet">      -</span> metadata.labels</span><br><span class="line"><span class="bullet">      -</span> metadata.annotations</span><br><span class="line"><span class="bullet">    -</span> ServiceAccountToken</span><br><span class="line"><span class="code">      &gt; Service Account对象是Kubernetes系统内置的一种&quot;服务账户&quot;,是Kubernetes进行权限分配的对象</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">环境变量获取信息的方式不具备自动更新的能力,建议使用Volume文件的方式获取这些信息</span><br><span class="line">这种把Kubernetes客户端以容器的方式运行在集群里，然后使用default Service Account自动授权的方式，称作&quot;InClusterConfig&quot;，Kubernetes API编程的授权方式</span><br><span class="line"></span><br><span class="line"><span class="section"># 容器健康检查和恢复机制</span></span><br><span class="line"><span class="bullet">  -</span> Probe(探针)</span><br><span class="line"></span><br><span class="line">  &gt; Kubernetes中并没有Docker的Stop,虽然是Restart,</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Kubernetes-技能图谱"><a href="#Kubernetes-技能图谱" class="headerlink" title="Kubernetes 技能图谱"></a>Kubernetes 技能图谱</h2><p><img src="/misc/images/kubernetes-rollmap.jpg" alt="Kubernetes 技能图谱"></p>
<h2 id="Awesome-Tools"><a href="#Awesome-Tools" class="headerlink" title="Awesome Tools"></a>Awesome Tools</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ahmetb/kubectx">kubectx + kubens: Power tools for kubectl</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ktr0731/evans">evans Universal gRPC client</a></li>
</ul>
<h3 id="WarmUp"><a href="#WarmUp" class="headerlink" title="WarmUp"></a>WarmUp</h3><ul>
<li>一旦要追求项目的普适性，那就一定要从顶层开始做好设计</li>
</ul>
<h3 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语"></a>专业术语</h3><ul>
<li>PaaS (Platform as a Service): 平台即服务</li>
<li>BaaS (Backend as a Service): 后端即服务</li>
<li>GA (General Availability): 一般可用性</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/">Kubernetes文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/hotcloud16/hotcloud16_burns.pdf">容器设计模式</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/19/Prometheus-Grafana-Intro/" rel="prev" title="Prometheus+Grafana Intro">
                  <i class="fa fa-chevron-left"></i> Prometheus+Grafana Intro
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/09/21/Cyclic-redundancy-check-Intro/" rel="next" title="Cyclic redundancy check Intro">
                  Cyclic redundancy check Intro <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chyidl</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">237k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:35</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
  <script src="https://embed.widgetpack.com/widget.js" async></script>
  <script class="next-config" data-name="rating" type="application/json">{"enable":true,"id":32031,"color":"#fc6423"}</script>
  <script src="/js/third-party/rating.js"></script>
<script src="/js/third-party/search/local-search.js"></script>




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"id":"location.pathname","github_id":"chyidl","repo":"blog-comments","client_id":"021081d3006495a297db","client_secret":"02b0b1f4e306283b5749fca963872c50632c47e2","admin_user":"chyidl","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"ca5b972a44af35dec56f7f9c944d04ce"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
