<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Docker Tips &amp; Tricks</title>
    <url>/2021/09/01/Docker-Intro/</url>
    <content><![CDATA[<h2 id="Docker-Info"><a href="#Docker-Info" class="headerlink" title="Docker  Info"></a>Docker  Info</h2><figure class="highlight oxygene"><table><tr><td class="code"><pre><code class="hljs oxygene">容器技术的核心功能，就是通过约束和修改进程的动态表现，从而为其创造出一个“边界”<br><br>Cgroups技术是用来制造约束的主要手段<br><span class="hljs-keyword">Namespace</span>技术则是用来修改进程试图的主要方法<br></code></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="Docker-architecture"><a href="#Docker-architecture" class="headerlink" title="Docker architecture"></a>Docker architecture</h2><blockquote>
<p>Docker uses a client-server architecture.</p>
</blockquote>
<p><img src="/misc/images/architecture.svg" alt="docker architecture"></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Docker 仓库操作</span><br>  docker pull/push<br><br><span class="hljs-comment"># Docker 镜像管理</span><br>  docker images/rmi/build<br><br><span class="hljs-comment"># Docker 生命周期管理</span><br>  docker run/<span class="hljs-built_in">start</span>/stop/<span class="hljs-built_in">rm</span><br><br><span class="hljs-comment"># to delete all containers including its volumes use,</span><br><span class="hljs-variable">$</span> docker <span class="hljs-built_in">rm</span> <span class="hljs-literal">-vf</span> <span class="hljs-variable">$</span>(docker <span class="hljs-built_in">ps</span> <span class="hljs-literal">-a</span> <span class="hljs-literal">-q</span>)<br><br><span class="hljs-comment"># to delete all Docker images</span><br><span class="hljs-variable">$</span> docker rmi <span class="hljs-variable">$</span>(docker images <span class="hljs-literal">-q</span>)<br><br><span class="hljs-comment"># stop all Docker containers</span><br>&gt; docker <span class="hljs-built_in">ps</span> -- list all running containers<br>&gt;   <span class="hljs-literal">-q</span> flag will only list the IDs <span class="hljs-keyword">for</span> those containers<br><span class="hljs-variable">$</span> docker <span class="hljs-built_in">kill</span> <span class="hljs-variable">$</span>(docker <span class="hljs-built_in">ps</span> <span class="hljs-literal">-q</span>)<br><br><span class="hljs-comment"># Remove all Docker containers</span><br><span class="hljs-variable">$</span> docker <span class="hljs-built_in">rm</span> <span class="hljs-variable">$</span>(docker <span class="hljs-built_in">ps</span> <span class="hljs-literal">-a</span> <span class="hljs-literal">-q</span>)<br></code></pre></td></tr></table></figure>

<h2 id="Docker-Tips"><a href="#Docker-Tips" class="headerlink" title="Docker Tips"></a>Docker Tips</h2><ul>
<li><p><strong>Docker Tip #1</strong>: Docker 容器进程</p>
<blockquote>
<p>A Docker container is just a process/service that runs directly on your machine. It is slightly different than a regular process because the Docker daemon along with the linux kernel do a few things(<strong>Cgroups</strong>、<strong>Namespace</strong>) to ensure it runs in total isolation<br>Docker容器是一种特殊的进程,和虚拟机差别很大</p>
</blockquote>
</li>
<li><p><strong>Docker Tip #2</strong>: COPY vs. ADD in a Dockerfile</p>
<blockquote>
<p>COPY 和 ADD 功能很相似，都可以从指定目录拷贝数据到Docker镜像中.</p>
</blockquote>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><code class="hljs oxygene"># <span class="hljs-keyword">COPY</span> 和 <span class="hljs-keyword">ADD</span> 区别<br><span class="hljs-number">1</span>. <span class="hljs-keyword">COPY</span>: 只能从本机文件或目录中拷贝到镜像中<br><span class="hljs-number">2</span>. <span class="hljs-keyword">ADD</span>: 不仅可以从本机文件或目录中拷贝，还可以使用URL引入外部的文件地址拷贝到镜像中<br>  $ <span class="hljs-keyword">ADD</span> rootfs.tar.gz /<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #3</strong>: 追加 Docker Run 指令减少镜像大小</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Before Dockerfile -- 新增三个层lager</span><br>RUN wget -O myfile.tar.gz http:<span class="hljs-regexp">//</span>example.com/myfile.tar.gz<br>RUN tar -xvf myfile.tar.gz -C <span class="hljs-regexp">/usr/</span>src/myapp<br>RUN rm myfile.tar.gz<br><br><span class="hljs-comment"># After Dockerfile -- 新增一个层layer</span><br>RUN wget -O myfile.tar.gz http:<span class="hljs-regexp">//</span>example.com/myfile.tar.gz \<br>  &amp;&amp; tar -xvf myfile.tar.gz -C <span class="hljs-regexp">/usr/</span>src/myapp \<br>  &amp;&amp; rm myfile.tar.gz<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #4</strong>: Docker Base镜像OS和Host OS没有关系</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><code class="hljs sqf">Docker <span class="hljs-built_in">Image</span> OS: 定义在Dockerfile文件的Base镜像的系统<br>Host OS: 运行Docker <span class="hljs-built_in">image</span>的环境<br>You can use whatever base <span class="hljs-built_in">image</span> you want <span class="hljs-keyword">for</span> your Docker images.<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #5</strong>: 使用相同Base镜像的好处</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">You could use a different base OS <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> Docker image, but <span class="hljs-keyword">then</span> you lose <span class="hljs-keyword">out</span> <span class="hljs-keyword">on</span> the ability <span class="hljs-keyword">to</span> <span class="hljs-keyword">cache</span> it across all of your images<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #6</strong>: RUN vs. CMD in a Dockerfile</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">RUN:</span> 在镜像内执行命令，这些指令仅仅在构建build镜像中执行一次，并且将构建结果写入新larger层中.<br><span class="hljs-symbol">CMD:</span> 在启动容器时定义默认的运行的指令, 这种动作发生运行时run-time, 覆盖方式<br><span class="hljs-symbol">ENTRYPOINT:</span> 执行命令参数追加方式<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #7</strong>: Base Docker Image Alpine</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm">Why Alpine?<br>&gt; Small. Simple. Secure. Alpine Linux is a security-<span class="hljs-keyword">oriented, </span>lightweight Linux <span class="hljs-keyword">distribution </span><span class="hljs-keyword">based </span>on musl libc <span class="hljs-keyword">and </span><span class="hljs-keyword">busybox.</span><br><span class="hljs-keyword"></span>&gt; Alpine is about <span class="hljs-number">30</span>x smaller than Debian.<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #8</strong>: Project Structure with Multiple Dockerfiles and Docker Compose</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">ubuntu in ~/chyi/micro-services at <span class="hljs-number">3</span>BPlus <span class="hljs-keyword">on</span> 🐳 v20.<span class="hljs-number">10.8</span><br>➜ tree -L <span class="hljs-number">2</span><br>.<br>├── auth<br>│   └── Dockerfile<br>├── billing<br>│   └── Dockerfile<br>├── contact<br>│   └── Dockerfile<br>├── docker-compose.yml<br>└── user<br>    └── Dockerfile<br><br><span class="hljs-number">4</span> directories, <span class="hljs-number">5</span> <span class="hljs-keyword">files</span><br><br>The docker-compose.yaml<br>ubuntu in ~/chyi/micro-services at <span class="hljs-number">3</span>BPlus <span class="hljs-keyword">on</span> 🐳 v20.<span class="hljs-number">10.8</span><br>➜ <span class="hljs-keyword">cat</span> docker-compose.yml<br><span class="hljs-keyword">version</span>: <span class="hljs-string">&#x27;3&#x27;</span><br><br>service<span class="hljs-variable">s:</span><br>    auth:<br>        build: <span class="hljs-string">&#x27;./auth&#x27;</span><br>    billin<span class="hljs-variable">g:</span><br>        build: <span class="hljs-string">&#x27;./billing&#x27;</span><br>    contac<span class="hljs-variable">t:</span><br>        build: <span class="hljs-string">&#x27;./contact&#x27;</span><br>    user:<br>        build: <span class="hljs-string">&#x27;./user&#x27;</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #9</strong>: 使用Volumes</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># docker-compose.yaml</span><br><span class="hljs-attr">services</span>:<span class="hljs-string"></span><br>  <span class="hljs-attr">app</span>:<span class="hljs-string"></span><br><span class="hljs-comment">    # Mount the crrent directoy into `/app` inside the running container.</span><br>    <span class="hljs-attr">volumes</span>:<span class="hljs-string"></span><br>      <span class="hljs-meta">-</span> <span class="hljs-string">&#x27;.:/app&#x27;</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #10</strong>: Published Ports</p>
<blockquote>
<p>Creates a firwaall rule which maps a container port to a port on the Docker host to the outside world.</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Flag value</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-p 8080:80</td>
<td align="left">Map TCP port 80 in the container to port 8080 on the Docker host.</td>
</tr>
<tr>
<td align="left">-p 192.168.1.100:8080:80</td>
<td align="left">Map TCP port 80 in the container to port 8080 on the Docker host for connections to host IP 192.168.1.100.</td>
</tr>
<tr>
<td align="left">-p 8080:80/udp</td>
<td align="left">Map UDP port 80 in the container to port 8080 on the Docker host.</td>
</tr>
<tr>
<td align="left">-p 8080:80/tcp -p 8080:80/udp</td>
<td align="left">Map TCP port 80 in the container to TCP port 8080 on the Docker host, and map UDP port 80 in the container to UDP port 8080 on the Docker host.</td>
</tr>
</tbody></table>
<ul>
<li><p><strong>Docker Tip #11</strong>: dockerignore file</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">.dockerignore</span>: ignore certain files and folders from your Docker images<br>  <span class="hljs-string">.git</span><br>  <span class="hljs-string">.dockerignore</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #12</strong>: Manage Docker without sudo on Linux</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># Add a docker group and then add your user to it:</span><br><span class="hljs-variable">$ </span>sudo groupadd docker<br><span class="hljs-variable">$ </span>docker usermod -aG docker <span class="hljs-variable">$USER</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #13</strong>: Measure Docker Container’s Resources</p>
<blockquote>
<p>How much resources containers are using</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><code class="hljs x86asm">$ docker stats<br>CONTAINER ID   NAME                                                                                         <span class="hljs-meta">CPU</span> %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O         PIDS<br>298d90f942e1   k8s_POD_kafka-zookeeper-0_default_a243d677-<span class="hljs-number">101b</span>-493b-a076-d94f46785f22_0                     <span class="hljs-number">0.00</span>%     724KiB / <span class="hljs-number">3.</span>704GiB     <span class="hljs-number">0.02</span>%     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>           <span class="hljs-number">1</span><br>1d92a13e4a6f   k8s_POD_kafka-0_default_f7374645-<span class="hljs-number">9904</span>-436c-bc8d-43ed415833c1_0                               <span class="hljs-number">0.00</span>%     872KiB / <span class="hljs-number">3.</span>704GiB     <span class="hljs-number">0.02</span>%     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>           <span class="hljs-number">1</span><br>b638c1bbd855   k8s_POD_postgres-postgresql-0_infrastructure_d9067ee1-<span class="hljs-number">6874</span>-<span class="hljs-number">4018</span>-a008-09362ad9330d_16         <span class="hljs-number">0.00</span>%     868KiB / <span class="hljs-number">3.</span>704GiB     <span class="hljs-number">0.02</span>%     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>           <span class="hljs-number">1</span><br>0fdc76799b4e   k8s_kube-flannel_kube-flannel-<span class="hljs-built_in">ds</span>-nk6tj_kube-system_0a186e7a-c0d7-<span class="hljs-number">4282</span>-9f5d-65ee20d0e13a_12   <span class="hljs-number">0.07</span>%     <span class="hljs-number">15.</span>4MiB / 50MiB       <span class="hljs-number">30.80</span>%    <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     <span class="hljs-number">33.</span>1MB / <span class="hljs-number">0B</span>       <span class="hljs-number">11</span><br>4c3705247efa   k8s_kube-proxy_kube-proxy-xwfvl_kube-system_f46216cb-d018-4d82-b510-9be5e01cefca_12          <span class="hljs-number">0.00</span>%     <span class="hljs-number">23.</span>36MiB / <span class="hljs-number">3.</span>704GiB   <span class="hljs-number">0.62</span>%     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     <span class="hljs-number">43.</span>7MB / <span class="hljs-number">12.</span>3kB   <span class="hljs-number">8</span><br>16d5db1e7447   k8s_POD_kube-proxy-xwfvl_kube-system_f46216cb-d018-4d82-b510-9be5e01cefca_13                 <span class="hljs-number">0.00</span>%     <span class="hljs-number">1.</span>996MiB / <span class="hljs-number">3.</span>704GiB   <span class="hljs-number">0.05</span>%     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     487kB / <span class="hljs-number">0B</span>        <span class="hljs-number">1</span><br>496aacf5fddf   k8s_POD_kube-flannel-<span class="hljs-built_in">ds</span>-nk6tj_kube-system_0a186e7a-c0d7-<span class="hljs-number">4282</span>-9f5d-65ee20d0e13a_13            <span class="hljs-number">0.00</span>%     768KiB / <span class="hljs-number">3.</span>704GiB     <span class="hljs-number">0.02</span>%     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>     <span class="hljs-number">0B</span> / <span class="hljs-number">0B</span>           <span class="hljs-number">1</span><br>1e328afeb116   dapr_zipkin                                                                                  <span class="hljs-number">0.17</span>%     <span class="hljs-number">250.</span>2MiB / <span class="hljs-number">3.</span>704GiB   <span class="hljs-number">6.60</span>%     18MB / <span class="hljs-number">0B</span>   60MB / <span class="hljs-number">0B</span>         <span class="hljs-number">55</span><br>27872f88cae3   dapr_placement                                                                               <span class="hljs-number">0.11</span>%     <span class="hljs-number">5.</span>992MiB / <span class="hljs-number">3.</span>704GiB   <span class="hljs-number">0.16</span>%     18MB / <span class="hljs-number">0B</span>   <span class="hljs-number">13.</span>6MB / <span class="hljs-number">0B</span>       <span class="hljs-number">10</span><br>27c1f6daa81c   dapr_redis                                                                                   <span class="hljs-number">0.35</span>%     <span class="hljs-number">5.</span>633MiB / <span class="hljs-number">3.</span>704GiB   <span class="hljs-number">0.15</span>%     18MB / <span class="hljs-number">0B</span>   <span class="hljs-number">10.</span>7MB / <span class="hljs-number">0B</span>       <span class="hljs-number">5</span><br><br>$ docker stats --format <span class="hljs-string">&quot;table &#123;&#123;.Container&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;&quot;</span><br>CONTAINER      <span class="hljs-meta">CPU</span> %     MEM USAGE / LIMIT<br>298d90f942e1   <span class="hljs-number">0.00</span>%     724KiB / <span class="hljs-number">3.</span>704GiB<br>1d92a13e4a6f   <span class="hljs-number">0.00</span>%     872KiB / <span class="hljs-number">3.</span>704GiB<br>b638c1bbd855   <span class="hljs-number">0.00</span>%     868KiB / <span class="hljs-number">3.</span>704GiB<br>0fdc76799b4e   <span class="hljs-number">2.37</span>%     <span class="hljs-number">15.</span>42MiB / 50MiB<br>4c3705247efa   <span class="hljs-number">0.00</span>%     <span class="hljs-number">23.</span>36MiB / <span class="hljs-number">3.</span>704GiB<br>16d5db1e7447   <span class="hljs-number">0.00</span>%     <span class="hljs-number">1.</span>996MiB / <span class="hljs-number">3.</span>704GiB<br>496aacf5fddf   <span class="hljs-number">0.00</span>%     768KiB / <span class="hljs-number">3.</span>704GiB<br>1e328afeb116   <span class="hljs-number">0.21</span>%     <span class="hljs-number">250.</span>2MiB / <span class="hljs-number">3.</span>704GiB<br>27872f88cae3   <span class="hljs-number">0.12</span>%     <span class="hljs-number">5.</span>992MiB / <span class="hljs-number">3.</span>704GiB<br>27c1f6daa81c   <span class="hljs-number">0.34</span>%     <span class="hljs-number">5.</span>633MiB / <span class="hljs-number">3.</span>704GiB<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #14</strong>: Docker Compose vs Docker Stack</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># Docker Compose: is an official tool that helps you manage your Docker containers by letting you define everything through a docker-compose.yml file.</span><br><br><span class="hljs-comment"># docker stack: is a command that&#x27;s embedded into the Docker CLI. Lets you manage a cluster of Docker containers through Docker Swarm.</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #15</strong>: Metadata Docker Images with Labels</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># Dockerfile example of adding 2 labels with 1 LABEL instruction:</span><br><span class="hljs-keyword">LABEL</span><span class="bash"> &lt;key&gt;=&lt;value&gt;</span><br><span class="hljs-keyword">LABEL</span><span class="bash"> version=<span class="hljs-string">&quot;1.0&quot;</span> maintainer=<span class="hljs-string">&quot;chyi &lt;nick.chyi@gmail.com&gt;&quot;</span></span><br><br><span class="hljs-comment"># Docker build example to add dynamic labels to your Docker images:</span><br>$ docker build . --<span class="hljs-keyword">label</span><span class="bash"> <span class="hljs-string">&quot;version=1.0&quot;</span> --label <span class="hljs-string">&quot;maintaner=chyi &lt;nick.chyi@gmail.com&gt;&quot;</span></span><br><br><span class="hljs-comment"># docker inspect images</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #16</strong>: Named Volumes vs Path Based Volumes</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Named volumes</span><br>  postgres:<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/postgresql/</span>data<br><br>  docker-compose automatically create the postgres volume, <span class="hljs-keyword">if</span> not you could running __$ docker volume create postgres__.<br>  On Linux, the volume will get saved to <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>volumes<span class="hljs-regexp">/postgres/</span>_data<br><br><span class="hljs-comment"># Path based volumes</span><br>  .<span class="hljs-regexp">/postgres:/</span>var<span class="hljs-regexp">/lib/</span>postgresql/data<br><br>  postgres/ directory would get created <span class="hljs-keyword">in</span> the current directory on the Docker host.<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #17</strong>: The Volume or Mount Flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Setting up a volume the old way with docker run:</span><br>$ docker container run … -v <span class="hljs-string">&quot;<span class="hljs-subst">$(pwd)</span>&quot;</span>:/myapp<br><br><span class="hljs-comment"># Setting up the same volumes using the mount flag with docker run:</span><br>$ docker container run … --mount <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=<span class="hljs-string">&quot;<span class="hljs-subst">$(pwd)</span>&quot;</span>,target=/myapp<br><br><span class="hljs-comment"># Docker compose</span><br>volumes:<br>  - <span class="hljs-built_in">type</span>: <span class="hljs-string">&quot;bind&quot;</span><br>    <span class="hljs-built_in">source</span>: <span class="hljs-string">&quot;.&quot;</span><br>    target: <span class="hljs-string">&quot;/myapp&quot;</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #18</strong>: Connect to a Service Running on Docker Host</p>
<blockquote>
<p>Implementation of connecting to Docker host over a custom network with a static IP address.</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Create a custom bridge Docker network</span><br>ubuntu <span class="hljs-keyword">in</span> ~ at <span class="hljs-number">3</span>BPlus<br>➜ docker network create -d bridge --subnet <span class="hljs-number">192.168</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">24</span> --gateway <span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span> mynet<br><span class="hljs-number">0330</span>b879fcc8fb23eeb092cb66fd86f1796e7f0abe37df4978903cf8fd07217b<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at <span class="hljs-number">3</span>BPlus<br>➜ ifconfig<br>br-<span class="hljs-number">0330</span>b879fcc8: flags=<span class="hljs-number">4099</span>&lt;UP,BROADCAST,MULTICAST&gt;  mtu <span class="hljs-number">1500</span><br>        inet <span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span>  netmask <span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span>  broadcast <span class="hljs-number">192.168</span>.<span class="hljs-number">0.255</span><br>        ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:<span class="hljs-number">16</span>:<span class="hljs-number">0</span>c:c0:<span class="hljs-number">51</span>  txqueuelen <span class="hljs-number">0</span>  (Ethernet)<br>        RX packets <span class="hljs-number">0</span>  bytes <span class="hljs-number">0</span> (<span class="hljs-number">0.0</span> B)<br>        RX errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span>  overruns <span class="hljs-number">0</span>  frame <span class="hljs-number">0</span><br>        TX packets <span class="hljs-number">0</span>  bytes <span class="hljs-number">0</span> (<span class="hljs-number">0.0</span> B)<br>        TX errors <span class="hljs-number">0</span>  dropped <span class="hljs-number">0</span> overruns <span class="hljs-number">0</span>  carrier <span class="hljs-number">0</span>  collisions <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Start the Alpine container and drop into a Shell prompt.</span><br>ubuntu <span class="hljs-keyword">in</span> ~ at <span class="hljs-number">3</span>BPlus<br>➜ docker container run --rm -it alpine sh<br><br><span class="hljs-comment"># Install the ping utility.</span><br>/ <span class="hljs-comment"># apk update &amp;&amp; apk add iputils</span><br>fetch https:<span class="hljs-regexp">//</span>dl-cdn.alpinelinux.org<span class="hljs-regexp">/alpine/</span>v3.<span class="hljs-number">14</span><span class="hljs-regexp">/main/</span>aarch64/APKINDEX.tar.gz<br>fetch https:<span class="hljs-regexp">//</span>dl-cdn.alpinelinux.org<span class="hljs-regexp">/alpine/</span>v3.<span class="hljs-number">14</span><span class="hljs-regexp">/community/</span>aarch64/APKINDEX.tar.gz<br>v3.<span class="hljs-number">14.2</span>-<span class="hljs-number">5</span>-gd4163d4c6c [https:<span class="hljs-regexp">//</span>dl-cdn.alpinelinux.org<span class="hljs-regexp">/alpine/</span>v3.<span class="hljs-number">14</span>/main]<br>v3.<span class="hljs-number">14.2</span>-<span class="hljs-number">4</span>-ga15b4dc067 [https:<span class="hljs-regexp">//</span>dl-cdn.alpinelinux.org<span class="hljs-regexp">/alpine/</span>v3.<span class="hljs-number">14</span>/community]<br>OK: <span class="hljs-number">14810</span> distinct packages available<br>(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>) Installing libcap (<span class="hljs-number">2.50</span>-r0)<br>(<span class="hljs-number">2</span>/<span class="hljs-number">2</span>) Installing iputils (<span class="hljs-number">20210202</span>-r0)<br>Executing busybox-<span class="hljs-number">1.33</span>.<span class="hljs-number">1</span>-r3.trigger<br>OK: <span class="hljs-number">6</span> MiB <span class="hljs-keyword">in</span> <span class="hljs-number">16</span> packages<br><br><span class="hljs-comment"># Ping the custom IP address we set up.</span><br>/ <span class="hljs-comment"># ping 192.168.0.1</span><br><br><span class="hljs-comment"># You should see this output (hit CTRL+C to stop it)</span><br>PING <span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span> (<span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) bytes of data.<br><span class="hljs-number">64</span> bytes from <span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span>: icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">0.336</span> ms<br><span class="hljs-number">64</span> bytes from <span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span>: icmp_seq=<span class="hljs-number">2</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">0.293</span> ms<br>^C<br>--- <span class="hljs-number">192.168</span>.<span class="hljs-number">0.1</span> ping statistics ---<br><span class="hljs-number">2</span> packets transmitted, <span class="hljs-number">2</span> received, <span class="hljs-number">0</span>% packet loss, time <span class="hljs-number">1013</span>ms<br>rtt min<span class="hljs-regexp">/avg/m</span>ax<span class="hljs-regexp">/mdev = 0.293/</span><span class="hljs-number">0.314</span><span class="hljs-regexp">/0.336/</span><span class="hljs-number">0.021</span> ms<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #19</strong>: Show Total Disk Space Used by Docker</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><code class="hljs tap">ubuntu in ~ at 3BPlus<br>➜ docker system df<br>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE<br>Images         <span class="hljs-number"> 3 </span>       <span class="hljs-number"> 2 </span>        203.9MB   198.5MB (97%)<br>Containers     <span class="hljs-number"> 3 </span>       <span class="hljs-number"> 1 </span>        2.524MB   0B (0%)<br>Local Volumes  <span class="hljs-number"> 1 </span>       <span class="hljs-number"> 0 </span>        0B        0B<br>Build Cache    <span class="hljs-number"> 0 </span>       <span class="hljs-number"> 0 </span>        0B        0B<br><br><span class="hljs-comment"># -v flag (verbose) - will show the unique image size for each image</span><br>ubuntu in ~ at 3BPlus<br>➜ docker system df -v<br>Images space usage:<br><br>REPOSITORY            TAG       IMAGE ID       CREATED       SIZE      SHARED SIZE   UNIQUE SIZE   CONTAINERS<br>alpine                latest    bb3de5531c18  <span class="hljs-number"> 4 </span>days ago    5.337MB   0B            5.337MB       2<br>hello-world           latest    bc11b176a293  <span class="hljs-number"> 7 </span>weeks ago   9.136kB   0B            9.136kB       1<br>bahamat/unix-1st-ed   latest    37aa142d2113  <span class="hljs-number"> 5 </span>years ago   198.5MB   0B            198.5MB       0<br><br>Containers space usage:<br><br>CONTAINER ID   IMAGE         COMMAND            LOCAL VOLUMES   SIZE      CREATED       STATUS                   NAMES<br>9023720cdee7   alpine        &quot;sh&quot;              <span class="hljs-number"> 0 </span>              2.52MB   <span class="hljs-number"> 5 </span>hours ago   Up<span class="hljs-number"> 5 </span>hours               upbeat_kepler<br>9e272ab58362   alpine        &quot;sh -c &#x27;exit 1&#x27;&quot;  <span class="hljs-number"> 0 </span>              0B       <span class="hljs-number"> 6 </span>hours ago   Exited (1)<span class="hljs-number"> 6 </span>hours ago   naughty_blackburn<br>d95cc7e19d43   hello-world   &quot;/hello&quot;          <span class="hljs-number"> 0 </span>              0B       <span class="hljs-number"> 7 </span>weeks ago   Exited (0)<span class="hljs-number"> 7 </span>weeks ago   nifty_hellman<br><br>Local Volumes space usage:<br><br>VOLUME NAME   LINKS     SIZE<br>user_my-db   <span class="hljs-number"> 0 </span>        0B<br><br>Build cache usage: 0B<br><br>CACHE ID   CACHE TYPE   SIZE      CREATED   LAST USED   USAGE     SHARED<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #20</strong>: Docker Compose Stop vs Down</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># docker-compose stop</span><br>&gt; stop container, <span class="hljs-keyword">but</span> <span class="hljs-keyword">it</span> won&#x27;t remove them<br><br><span class="hljs-comment"># docker-compose down</span><br>&gt; stop container, removes <span class="hljs-keyword">the</span> stopped containers <span class="hljs-keyword">as</span> well <span class="hljs-keyword">as</span> any networks <span class="hljs-keyword">that</span> were created.<br><br><span class="hljs-comment"># docker-compose down -v</span><br>&gt; add remove all volumes too.<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #21</strong>: Difference between Docker Create, Start and Run</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># Create:</span><br>  adds a writeable container <span class="hljs-keyword">on</span> top <span class="hljs-keyword">of</span> your image <span class="hljs-keyword">and</span> sets <span class="hljs-keyword">it</span> up <span class="hljs-keyword">for</span> <span class="hljs-built_in">running</span> whatever command you specified <span class="hljs-keyword">in</span> you CMD. The container ID <span class="hljs-keyword">is</span> reported <span class="hljs-keyword">back</span> <span class="hljs-keyword">but</span> <span class="hljs-keyword">it</span>&#x27;s <span class="hljs-keyword">not</span> started.<br><br><span class="hljs-comment"># Start:</span><br>  will start any stopped container.<br><br><span class="hljs-comment"># Run:</span><br>  combination <span class="hljs-keyword">of</span> create <span class="hljs-keyword">and</span> start, It creates <span class="hljs-keyword">the</span> container <span class="hljs-keyword">and</span> starts <span class="hljs-keyword">it</span>.<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #22</strong>: Docker Mem Limit</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">默认情况下容器使用的资源不受限制，可以使用主机内核调度器所允许的最大资源</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">限制容器不能过多的使用主机的内存，一旦内存检测到没有足够的内存可以分配，就会出现OOM(Out Of Memory Exception). 并开始随机Kill一些进程用于释放内存空间，docker尝试调整docker daemon 的OOM优先级进行缓解，内核在选择杀死的进程时会对所有的进程打分，直接杀死得分最高的进程，docker daemon的OOM优先级被降低</span><br></code></pre></td></tr></table></figure>
<ul>
<li><a href="/misc/code/script/show_process_score.sh">show_process_score.sh</a><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 脚本输出得分最高的10个进程,并排序</span><br>  ➜ ./show_process_score.sh<br>  <span class="hljs-number">672</span>  <span class="hljs-number">1510</span> <span class="hljs-regexp">/usr/</span>bin/gnome-shell<br>  <span class="hljs-number">669</span>  <span class="hljs-number">1811</span> <span class="hljs-regexp">/usr/</span>libexec/gnome-initial-setup --existing-user<br>  <span class="hljs-number">668</span>  <span class="hljs-number">1010</span> <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/xorg/</span>Xorg vt2 -displayfd <span class="hljs-number">3</span> -auth <span class="hljs-regexp">/run/u</span>se<br>  <span class="hljs-number">667</span>  <span class="hljs-number">2062</span> update-notifier<br>  <span class="hljs-number">667</span>  <span class="hljs-number">1760</span> <span class="hljs-regexp">/usr/</span>libexec<span class="hljs-regexp">/evolution-data-server/</span>evolution-alarm<br>  <span class="hljs-number">667</span>  <span class="hljs-number">1128</span> <span class="hljs-regexp">/usr/</span>libexec/goa-daemon<br>  <span class="hljs-number">666</span>   <span class="hljs-number">996</span> <span class="hljs-regexp">/usr/</span>libexec/tracker-miner-fs<br>  <span class="hljs-number">666</span>   <span class="hljs-number">994</span> <span class="hljs-regexp">/usr/</span>bin/pulseaudio --daemonize=no --log-target=jo<br>  <span class="hljs-number">666</span>   <span class="hljs-number">988</span> (sd-pam)<br>  <span class="hljs-number">666</span>   <span class="hljs-number">987</span> <span class="hljs-regexp">/lib/</span>systemd/systemd --user<br><br><span class="hljs-comment"># 降低OOM风险:</span><br>  - 通过测试掌握应用对内存的需求<br>  - 保证运行容器的主机有充足的内存<br>  - 限制容器可以使用的内存<br>  - 为主机配置Swap<br><br></code></pre></td></tr></table></figure></li>
<li>压力测试工具 stress<figure class="highlight armasm"><table><tr><td class="code"><pre><code class="hljs armasm"><span class="hljs-comment"># stress</span><br>&gt; a tool for generating workload. <span class="hljs-keyword">It</span> can produce CPU, memory, I/O, <span class="hljs-keyword">and</span> disk stress.<br></code></pre></td></tr></table></figure></li>
<li><a href="/misc/code/devops/benchmark/stress.Dockerfile">stress.Dockerfile</a><figure class="highlight tap"><table><tr><td class="code"><pre><code class="hljs tap"><span class="hljs-comment"># 创建镜像</span><br>➜ docker build -f stress.Dockerfile -t chyiyaqing/u-stress:latest .<br><br><span class="hljs-comment"># 限制内存使用上限(memory-swap值包含容器可用内存和可用swap;)</span><br>➜ docker run -it -m 300M --memory-swap -1 --name con1 chyiyaqing/u-stress /bin/bash<br>root@1a3df043e956:/<span class="hljs-comment"># stress --vm 1 --vm-bytes 500M</span><br>stress: info: [9] dispatching hogs:<span class="hljs-number"> 0 </span>cpu,<span class="hljs-number"> 0 </span>io,<span class="hljs-number"> 1 </span>vm,<span class="hljs-number"> 0 </span>hdd<br><br><span class="hljs-comment"># docker stats 查看</span><br>$ docker stats<br>CONTAINER ID   NAME      CPU %     MEM USAGE / LIMIT   MEM %     NET I/O       BLOCK I/O     PIDS<br>1a3df043e956   con1      71.85%    300MiB / 300MiB     100.00%   6.71kB / 0B   3.45GB / 0B   3<br><br><span class="hljs-comment"># Top命令查看stress进程内存实际情况</span><br>chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took 5s<br><span class="hljs-comment"># pgrep 命令查询stress命令相关进程</span><br>➜ pgrep stress<br>48622<br>48623<br><br>chyiyaqing in ~ at chyiyaqing-PowerEdge-R720<br>➜ top -p 48623<br>top - 22:40:23 up<span class="hljs-number"> 2 </span>days,  5:40, <span class="hljs-number"> 4 </span>users,  load average: 0.95, 0.47, 0.18<br>Tasks:  <span class="hljs-number"> 1 </span>total,  <span class="hljs-number"> 1 </span>running,  <span class="hljs-number"> 0 </span>sleeping,  <span class="hljs-number"> 0 </span>stopped,  <span class="hljs-number"> 0 </span>zombie<br>%Cpu(s):  0.1 us,  2.0 sy,  0.0 ni, 97.1 id,  0.8 wa,  0.0 hi,  0.0 si,  0.0 st<br>MiB Mem :  32106.2 total,  27283.4 free,   1420.6 used,   3402.2 buff/cache<br>MiB Swap:   2048.0 total,   1545.3 free,    502.7 used.  30224.1 avail Mem<br><br>    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND<br> <span class="hljs-number"> 48623 </span>root     <span class="hljs-number"> 20 </span> <span class="hljs-number"> 0 </span><span class="hljs-number"> 515868 </span>305460   <span class="hljs-number"> 272 </span>R  71.7   0.9   2:02.53 stress<br><br><span class="hljs-comment"># VIRT 进程虚拟内存大小; RES 实际分配物理内存大小</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>Docker Tip #23</strong>: Docker CPU Limit</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">&gt; 默认情况下容器可以不受限制的使用CPU/内存资源, 如果不对容器使用进行限制，一旦发生容器程序异常使用CPU/Mem情况，可能会把整个主机CPU/Mem资源耗尽.<br><br># 限制可用CPU个数<br>➜ docker run --rm -it --cpus=<span class="hljs-number">2</span> chyiyaqing/<span class="hljs-keyword">u</span>-stress /bin/bash<br><br>root@f11127fe7c50:/# stress -<span class="hljs-keyword">c</span> <span class="hljs-number">4</span><br>stres<span class="hljs-variable">s:</span> info: [<span class="hljs-number">9</span>] dispatching hog<span class="hljs-variable">s:</span> <span class="hljs-number">4</span> cpu, <span class="hljs-number">0</span> io, <span class="hljs-number">0</span> <span class="hljs-keyword">vm</span>, <span class="hljs-number">0</span> hdd<br><br># docker stats<br>CONTAINER ID   NAME                CPU %     MEM USAGE / LIMIT     MEM %     NET I/O       BLOCK I/O   PIDS<br>f11127fe7c50   competent_noether   <span class="hljs-number">198.98</span>%   <span class="hljs-number">1.695</span>MiB / <span class="hljs-number">31.35</span>GiB   <span class="hljs-number">0.01</span>%     <span class="hljs-number">39.7</span>kB / <span class="hljs-number">0</span>B   <span class="hljs-number">0</span>B / <span class="hljs-number">0</span>B     <span class="hljs-number">6</span><br><br># Top<br>Task<span class="hljs-variable">s:</span> <span class="hljs-number">468</span> total,   <span class="hljs-number">5</span> running, <span class="hljs-number">463</span> sleeping,   <span class="hljs-number">0</span> stopped,   <span class="hljs-number">0</span> zombie<br>%Cpu0  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu1  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu2  : <span class="hljs-number">50.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni, <span class="hljs-number">50.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span>     --<br>%Cpu3  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu4  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu5  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu6  :  <span class="hljs-number">5.0</span> us,  <span class="hljs-number">5.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni, <span class="hljs-number">90.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu7  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu8  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu9  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu10 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu11 : <span class="hljs-number">50.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni, <span class="hljs-number">50.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span>     --<br>%Cpu12 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu13 : <span class="hljs-number">47.4</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni, <span class="hljs-number">52.6</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span>     --<br>%Cpu14 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu15 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu16 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu17 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu18 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu19 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu20 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu21 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu22 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu23 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu24 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu25 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu26 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu27 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu28 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu29 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu30 :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu31 : <span class="hljs-number">50.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni, <span class="hljs-number">50.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span>     --<br>MiB Mem :  <span class="hljs-number">32106.2</span> total,  <span class="hljs-number">27901.2</span> free,   <span class="hljs-number">1119.0</span> used,   <span class="hljs-number">3086.0</span> buff/cache<br>MiB Swap:   <span class="hljs-number">2048.0</span> total,   <span class="hljs-number">2044.6</span> free,      <span class="hljs-number">3.4</span> used.  <span class="hljs-number">30537.0</span> avail Mem<br><br>查看Top真实情况不是两个CPU负载<span class="hljs-number">100</span>%, 而是容器消耗CPU总共<span class="hljs-number">200</span>%的负载，进程没有CPU数的限制，只能通过进程消耗CPU时间片统计出进程占用CPU的百分比<br><br># 指定固定CPU<br>  &gt; 通过--cpuset-cpus设置容器运行在几个固定的CPU上, 因为多核系统每个核心都有自己的缓存,频繁的调度进程在不同的核心上执行会带来缓存失效的开销<br>  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720<br>  ➜ docker run --rm -it --cpuset-cpus=<span class="hljs-string">&quot;0,1,2,3&quot;</span> chyiyaqing/<span class="hljs-keyword">u</span>-stress /bin/bash<br><br># 启动塔里测试命令<br>root@<span class="hljs-number">95110</span>b6915af:/# stress -<span class="hljs-keyword">c</span> <span class="hljs-number">10</span><br>stres<span class="hljs-variable">s:</span> info: [<span class="hljs-number">12</span>] dispatching hog<span class="hljs-variable">s:</span> <span class="hljs-number">4</span> cpu, <span class="hljs-number">0</span> io, <span class="hljs-number">0</span> <span class="hljs-keyword">vm</span>, <span class="hljs-number">0</span> hdd<br><br># docker stats<br>CONTAINER ID   NAME                 CPU %     MEM USAGE / LIMIT    MEM %     NET I/O      BLOCK I/O   PIDS<br><span class="hljs-number">39</span>b4ce536148   frosty_stonebraker   <span class="hljs-number">399.38</span>%   <span class="hljs-number">2.43</span>MiB / <span class="hljs-number">31.35</span>GiB   <span class="hljs-number">0.01</span>%     <span class="hljs-number">3.9</span>kB / <span class="hljs-number">0</span>B   <span class="hljs-number">0</span>B / <span class="hljs-number">0</span>B     <span class="hljs-number">12</span><br><br># Top<br>➜ top<br>top - <span class="hljs-number">23</span>:<span class="hljs-number">08</span>:<span class="hljs-number">19</span> <span class="hljs-keyword">up</span> <span class="hljs-number">2</span> days,  <span class="hljs-number">6</span>:<span class="hljs-number">08</span>,  <span class="hljs-number">4</span> users,  load average: <span class="hljs-number">6.97</span>, <span class="hljs-number">3.73</span>, <span class="hljs-number">2.01</span><br>Task<span class="hljs-variable">s:</span> <span class="hljs-number">496</span> total,  <span class="hljs-number">11</span> running, <span class="hljs-number">485</span> sleeping,   <span class="hljs-number">0</span> stopped,   <span class="hljs-number">0</span> zombie<br>%Cpu0  :<span class="hljs-number">100.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,  <span class="hljs-number">0.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu1  :<span class="hljs-number">100.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,  <span class="hljs-number">0.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu2  :<span class="hljs-number">100.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,  <span class="hljs-number">0.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu3  :<span class="hljs-number">100.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,  <span class="hljs-number">0.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu4  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni, <span class="hljs-number">97.7</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">2.3</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br><br># 设置CPU的权重<br>&gt; 设置CPU权重只有在容器争用CPU资源的情况下，CPU的权重才能让不同的容器分到不同的CPU用量 --cpu-shares 设置CPU权重，默认值为<span class="hljs-number">1024</span>,<br><br># 运行两个容器，指定使用CPU0，分别设置--cpu-shares <span class="hljs-number">512</span>,<span class="hljs-number">1024</span><br>  ➜ docker run --rm -it --cpuset-cpus=<span class="hljs-string">&quot;0&quot;</span> --cpu-shares=<span class="hljs-number">512</span> chyiyaqing/<span class="hljs-keyword">u</span>-stress /bin/bash<br>  ➜ docker run --rm -it --cpuset-cpus=<span class="hljs-string">&quot;0&quot;</span> --cpu-shares=<span class="hljs-number">1024</span> chyiyaqing/<span class="hljs-keyword">u</span>-stress /bin/bash<br><br># 两个容器都运行stress -<span class="hljs-keyword">c</span> <span class="hljs-number">4</span><br><br># top<br>➜ top<br>top - <span class="hljs-number">23</span>:<span class="hljs-number">14</span>:<span class="hljs-number">14</span> <span class="hljs-keyword">up</span> <span class="hljs-number">2</span> days,  <span class="hljs-number">6</span>:<span class="hljs-number">14</span>,  <span class="hljs-number">5</span> users,  load average: <span class="hljs-number">5.30</span>, <span class="hljs-number">5.25</span>, <span class="hljs-number">3.42</span><br>Task<span class="hljs-variable">s:</span> <span class="hljs-number">495</span> total,   <span class="hljs-number">9</span> running, <span class="hljs-number">486</span> sleeping,   <span class="hljs-number">0</span> stopped,   <span class="hljs-number">0</span> zombie<br>%Cpu0  :<span class="hljs-number">100.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,  <span class="hljs-number">0.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br>%Cpu1  :  <span class="hljs-number">0.0</span> us,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">sy</span>,  <span class="hljs-number">0.0</span> ni,<span class="hljs-number">100.0</span> id,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">wa</span>,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">hi</span>,  <span class="hljs-number">0.0</span> si,  <span class="hljs-number">0.0</span> <span class="hljs-keyword">st</span><br><br># docker stats<br>CONTAINER ID   NAME                CPU %     MEM USAGE / LIMIT     MEM %     NET I/O       BLOCK I/O   PIDS<br>f9c8864fab87   beautiful_neumann   <span class="hljs-number">66.39</span>%    <span class="hljs-number">1.695</span>MiB / <span class="hljs-number">31.35</span>GiB   <span class="hljs-number">0.01</span>%     <span class="hljs-number">5.23</span>kB / <span class="hljs-number">0</span>B   <span class="hljs-number">0</span>B / <span class="hljs-number">0</span>B     <span class="hljs-number">6</span><br><span class="hljs-number">6</span>b69afc7fea5   pensive_vaughan     <span class="hljs-number">33.41</span>%    <span class="hljs-number">1.676</span>MiB / <span class="hljs-number">31.35</span>GiB   <span class="hljs-number">0.01</span>%     <span class="hljs-number">7.17</span>kB / <span class="hljs-number">0</span>B   <span class="hljs-number">0</span>B / <span class="hljs-number">0</span>B     <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #24</strong>: Docker import/export vs. load/save</p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><code class="hljs vbnet">➜ docker --help | grep -E <span class="hljs-string">&quot;(export|import|load|save)&quot;</span><br>export      Export a container<span class="hljs-comment">&#x27;s filesystem as a tar archive</span><br>import      Import the contents <span class="hljs-keyword">from</span> a tarball <span class="hljs-keyword">to</span> create a filesystem image<br>load        Load an image <span class="hljs-keyword">from</span> a tar archive <span class="hljs-built_in">or</span> STDIN<br>save        Save one <span class="hljs-built_in">or</span> more images <span class="hljs-keyword">to</span> a tar archive (streamed <span class="hljs-keyword">to</span> STDOUT <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span>)<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #25</strong>: Docker网络模式</p>
<table>
<thead>
<tr>
<th align="left">Docker 网络模式</th>
<th align="left">配置</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">host模式</td>
<td align="left">-net=host</td>
<td align="left">容器和宿主机共享Network namespace</td>
</tr>
<tr>
<td align="left">container 模式</td>
<td align="left">-net=container:NAME_or_ID</td>
<td align="left">容器与另外一个容器共享Network namespace, kubernetes中的pod就是多个容器共享一个Network namespace</td>
</tr>
<tr>
<td align="left">none模式</td>
<td align="left">-net=none</td>
<td align="left">容器有独立的Network namespace,但并没有对其进行任何网络设置</td>
</tr>
<tr>
<td align="left">bridge模式</td>
<td align="left">-net=bridge</td>
<td align="left">默认为该模式</td>
</tr>
</tbody></table>
<figure class="highlight less"><table><tr><td class="code"><pre><code class="hljs less"># 实现原理<br>  &gt; 宿主机虚拟一个<span class="hljs-selector-tag">Docker</span>容器网桥(docker0), <span class="hljs-selector-tag">Docker</span>启动一个容器时会根据<span class="hljs-selector-tag">Docker</span>网桥(docker0)的网段分配给容器一个<span class="hljs-selector-tag">IP</span>地址，称为<span class="hljs-selector-tag">Container-IP</span>,同时<span class="hljs-selector-tag">Docker</span>网桥是每个容器的默认网关.因为同一宿主机内的容器都接入同一网桥，这样容器之间就能够通过容器的<span class="hljs-selector-tag">Container-IP</span>直接通信.<br>  &gt; <span class="hljs-selector-tag">Docker</span>网桥是宿主主机虚拟出来的，并不是真是存在的网络设备，外部网络是无法寻址到，如果容器希望外部能够访问到，可以通过映射容器端口到宿主主机(端口映射),访问容器的时候就通过<span class="hljs-selector-attr">[宿主主机IP]</span>:<span class="hljs-selector-attr">[容器端口]</span>访问容器<br><br></code></pre></td></tr></table></figure>
<ul>
<li>host模式<br><img src="/misc/images/docker-network-host.png" alt="Host模式"><figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">容器使用host模式将使用宿主主机的IP和端口,容器的其他方面，文件系统、进程列表还是和宿主主机隔离</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">使用host模式的容器可以直接使用宿主主机的IP地址与外界通信，容器内部的服务端口也可以使用宿主主机的端口，不需要进行NAT，host最大优势是网络性能比较好，但是docker host上已经使用的端口就不能再使用,网络隔离型不好</span><br></code></pre></td></tr></table></figure></li>
<li>container模式<br><img src="/misc/images/docker-network-container.png" alt="Container模式"><figure class="highlight armasm"><table><tr><td class="code"><pre><code class="hljs armasm">&gt; 新创建的容器和已经存在的一个容器共享一个Network Namespace.新创建的容器不会创建自己的网卡，配置自己的<span class="hljs-built_in">IP</span>，而是和指定的容器共享<span class="hljs-built_in">IP</span>和端口范围, 两个容器的进程可以通过lo网卡设备通信<br></code></pre></td></tr></table></figure></li>
<li>none模式<br><img src="/misc/images/docker-network-none.png" alt="None模式"><figure class="highlight fortran"><table><tr><td class="code"><pre><code class="hljs fortran">&gt; <span class="hljs-keyword">None</span>模式,Docker容器拥有自己的Network Namespace,但是，并不为Docker容器进行任何网络配置，Docker容器没有网卡、IP、路由,需要自己对Docker容器添加网卡、配置IP<br>&gt; <span class="hljs-keyword">None</span>模式下只有lo回环网络，没有其他网卡，<span class="hljs-keyword">None</span>模式可以在容器创建时通过network=<span class="hljs-keyword">None</span>指定，这类网络没办法联网，封闭的网络能很好的保证容器的安全<br></code></pre></td></tr></table></figure></li>
<li>bridge模式<br><img src="/misc/images/docker-network-bridge.png" alt="Bridge模式"><figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">bridge模式是docker默认网络模式,不写--net参数就是bridge模式</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>Docker Tip #26</strong>: Alphine Linux Dockerfile</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><code class="hljs subunit">chyiyaqing in core at chyiyaqing-PowerEdge-R720 on  feat/adaptation-kingbases [!?] via 🐹 v1.17.1 on 🐳 v20.10.10<br>➜ docker run core:BF<span class="hljs-string">-9748</span><br><span class="hljs-keyword">Error </span>relocating /root/core/blocface-core: __vfprintf_chk: symbol not found<br><span class="hljs-keyword">Error </span>relocating /root/core/blocface-core: __fprintf_chk: symbol not found<br><br>在Alpine Linux上, not found错误是动态链接失败的典型特征，musl的ldd链接器存在一个相当混乱的错误，大多数Linux软件都是与glibc(GNUlibc库)相链接(libc提供了标准的C库和posixapi),大多数Linux发行版本都是基于glibc, alpineLinux是基于muslibc库(这是最小的实现，严格遵守POSIX).<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #27</strong>: 防止容器自动退出</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><code class="hljs gherkin">&gt; docker容器的生命周期是同容器中的前置进程相关在一起,前置进程运行结束后，容器便自动退出<br><br>下文使用alpine镜像做为基础镜像，创建一个alpine系统小容器,让其可以常驻运行，以便我们登陆交互执行<br><br>  <span class="hljs-comment"># 使用alpine系统镜像创建容器</span><br>  <span class="hljs-comment"># -i interactive=true 开启stdin</span><br>  <span class="hljs-comment"># -t tty=true 分配会话终端</span><br>  <span class="hljs-comment"># -d 守护模式 不加就直接进入容器中需要ctrl+p+q切出，</span><br><br>  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took 9s<br>  ➜ docker run -it -d --name my_alpine alpine sh<br>  Unable to find image &#x27;alpine:latest&#x27; locally<br>  latest: Pulling from library/alpine<br>  a0d0a0d46f8b: Pull complete<br>  Digest: sha256:e1c082e3d3c45cccac829840a25941e679c25d438cc8412c2fa221cf1a824e6a<br>  Status: Downloaded newer image for alpine:latest<br>  78c0429dd98fe42addaa2071ffe1ca6c22295ea6d6d465ff1f970644f6234a37<br><br>  <span class="hljs-comment"># my_alpine 容器处于运行状态</span><br>  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took 8s<br>  ➜ docker ps |<span class="hljs-string"> grep alpine</span><br><span class="hljs-string">  78c0429dd98f   alpine                                                          &quot;sh&quot;                     34 seconds ago   Up 34 seconds                                                         my_alpine</span><br><span class="hljs-string"></span><br><span class="hljs-string">  # 登入容器</span><br><span class="hljs-string">  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720</span><br><span class="hljs-string">  ➜ docker exec -it my_alpine sh</span><br><span class="hljs-string"></span><br><span class="hljs-string">  # 查看 sh 会话数量</span><br><span class="hljs-string">  / # ps</span><br><span class="hljs-string">  PID   USER     TIME  COMMAND</span><br><span class="hljs-string">      1 root      0:00 sh</span><br><span class="hljs-string">      7 root      0:00 sh</span><br><span class="hljs-string">     13 root      0:00 ps</span><br><span class="hljs-string"></span><br><span class="hljs-string">  # alpine使用apk做为包管理</span><br><span class="hljs-string">  / # apk add sl</span><br><span class="hljs-string">  fetch https://dl-cdn.alpinelinux.org/alpine/v3.14/main/x86_64/APKINDEX.tar.gz</span><br><span class="hljs-string">  fetch https://dl-cdn.alpinelinux.org/alpine/v3.14/community/x86_64/APKINDEX.tar.gz</span><br><span class="hljs-string">  (1/3) Installing ncurses-terminfo-base (6.2_p20210612-r0)</span><br><span class="hljs-string">  (2/3) Installing ncurses-libs (6.2_p20210612-r0)</span><br><span class="hljs-string">  (3/3) Installing sl (5.02-r0)</span><br><span class="hljs-string">  Executing busybox-1.33.1-r3.trigger</span><br><span class="hljs-string">  OK: 6 MiB in 17 packages</span><br><span class="hljs-string">  / # sl</span><br><span class="hljs-string">            (@@@@)</span><br><span class="hljs-string"></span><br><span class="hljs-string">          (   )</span><br><span class="hljs-string">        ====        ________                ___________</span><br><span class="hljs-string">    _D _</span>|<span class="hljs-string">  </span>|<span class="hljs-string">_______/        \__I_I_____===__</span>|<span class="hljs-string">_________</span>|<br>     |<span class="hljs-string">(_)---  </span>|<span class="hljs-string">   H\________/ </span>|<span class="hljs-string">   </span>|<span class="hljs-string">        =</span>|<span class="hljs-string">___ ___</span>|<span class="hljs-string">      _________________</span><br><span class="hljs-string">     /     </span>|<span class="hljs-string">  </span>|<span class="hljs-string">   H  </span>|<span class="hljs-string">  </span>|<span class="hljs-string">     </span>|<span class="hljs-string">   </span>|<span class="hljs-string">         </span>||<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>||<span class="hljs-string">     _</span>|<span class="hljs-string">                \_____A</span><br><span class="hljs-string">    </span>|<span class="hljs-string">      </span>|<span class="hljs-string">  </span>|<span class="hljs-string">   H  </span>|<span class="hljs-string">__--------------------</span>|<span class="hljs-string"> [___] </span>|<span class="hljs-string">   =</span>|<span class="hljs-string">                        </span>|<br>    |<span class="hljs-string"> ________</span>|<span class="hljs-string">___H__/__</span>|<span class="hljs-string">_____/[][]~\_______</span>|<span class="hljs-string">       </span>|<span class="hljs-string">   -</span>|<span class="hljs-string">                        </span>|<br>    |<span class="hljs-string">/ </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-----------I_____I [][] []  D   </span>|<span class="hljs-string">=======</span>|<span class="hljs-string">____</span>|<span class="hljs-string">________________________</span>|_<br>  __/ =|<span class="hljs-string"> o </span>|<span class="hljs-string">=-~O=====O=====O=====O\ ____Y___________</span>|<span class="hljs-string">__</span>|<span class="hljs-string">__________________________</span>|_<br>   |<span class="hljs-string">/-=</span>|<span class="hljs-string">___</span>|<span class="hljs-string">=    </span>||<span class="hljs-string">    </span>||<span class="hljs-string">    </span>||<span class="hljs-string">    </span>|<span class="hljs-string">_____/~\___/          </span>|<span class="hljs-string">_D__D__D_</span>|<span class="hljs-string">  </span>|<span class="hljs-string">_D__D__D_</span>|<br>    \_/      \__/  \__/  \__/  \__/      \_/               \_/   \_/    \_/   \_/<br><br><span class="hljs-comment"># 提交容器变更生成新的镜像</span><br>chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took 2m 57s<br>➜ docker commit -m <span class="hljs-string">&quot;alpine with sl cmd&quot;</span> -a <span class="hljs-string">&quot;big_cat&quot;</span> my_alpine chyiyaqing/alpine_sl<br>sha256:79981bb43b0e638cc193570456ad93793a8cb481c8940e4fd899a0cc60a8bd46<br><br><span class="hljs-comment"># 发布到Docker Hub</span><br>chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took 10s<br>➜ docker push chyiyaqing/alpine_sl<br>Using default tag: latest<br>The push refers to repository [docker.io/chyiyaqing/alpine_sl]<br>102b73ff0977: Pushed<br>e2eb06d8af82: Mounted from library/alpine<br>latest: digest: sha256:500e9b9536a4fec460c487867d3cd7084da934ba37151aa122f4be438cc06d57 size: 739<br><br><span class="hljs-comment"># 停止/启动容器</span><br>$ docker stop/start  my_alpine<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #28</strong>: Docker目录空间</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 查看docker工作根目录</span><br>[hyperchain@mini <span class="hljs-keyword">package</span>]$ docker info | <span class="hljs-keyword">grep</span>  <span class="hljs-string">&#x27;Docker Root Dir&#x27;</span><br>Docker Root Dir: <span class="hljs-regexp">/var/li</span>b/docker<br><br><span class="hljs-comment"># 查看工作目录占用空间大小</span><br>[hyperchain@mini <span class="hljs-keyword">package</span>]$ sudo du -sh /var/lib/docker/<br><span class="hljs-number">65</span>G     /var/lib/docker/<br><br><span class="hljs-comment"># 查看docker占用磁盘空间</span><br>[hyperchain@mini <span class="hljs-keyword">package</span>]$ docker <span class="hljs-keyword">system</span> df<br>TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE<br>Images              <span class="hljs-number">22</span>                  <span class="hljs-number">0</span>                   <span class="hljs-number">11.07</span>GB             <span class="hljs-number">11.07</span>GB (<span class="hljs-number">100</span>%)<br>Containers          <span class="hljs-number">0</span>                   <span class="hljs-number">0</span>                   0B                  0B<br>Local Volumes       <span class="hljs-number">120</span>                 <span class="hljs-number">0</span>                   <span class="hljs-number">56.7</span>GB              <span class="hljs-number">56.7</span>GB (<span class="hljs-number">100</span>%)<br>Build Cache         <span class="hljs-number">0</span>                   <span class="hljs-number">0</span>                   0B                  0B<br><br><span class="hljs-comment"># 清理docker没有被使用的docker镜像</span><br>[hyperchain@mini <span class="hljs-keyword">package</span>]$ docker <span class="hljs-keyword">system</span> prune -a<br>WARNING! This will remove:<br>        - all stopped containers<br>        - all networks <span class="hljs-keyword">not</span> used by at least one container<br>        - all dangling images<br>        - all dangling build cache<br>Are you sure you want to <span class="hljs-keyword">continue</span>? [<span class="hljs-keyword">y</span>/N] <span class="hljs-keyword">y</span><br>Total reclaimed space: 0B<br><br><span class="hljs-comment"># 停止docker服务</span><br>[hyperchain@mini <span class="hljs-keyword">package</span>]$ systemctl stop docker<br>==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====<br>Authentication is required to stop <span class="hljs-string">&#x27;docker.service&#x27;</span>.<br>Authenticating as: hyperchain<br>Password:<br>==== AUTHENTICATION COMPLETE ====<br>[hyperchain@mini <span class="hljs-keyword">package</span>]$<br><br><span class="hljs-comment"># 删除 volumnes</span><br>[hyperchain@mini <span class="hljs-keyword">package</span>]$ docker volume prune<br>WARNING! This will remove all <span class="hljs-keyword">local</span> volumes <span class="hljs-keyword">not</span> used by at least one container.<br>Are you sure you want to <span class="hljs-keyword">continue</span>? [<span class="hljs-keyword">y</span>/N] <span class="hljs-keyword">y</span><br>Deleted Volumes:<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Have-a-Fun"><a href="#Have-a-Fun" class="headerlink" title="Have a Fun"></a>Have a Fun</h2><ul>
<li>Run the First Edition of Unix (1972) with Docker<blockquote>
<p>Run a PDP-11 simulator through Docker to interact with Unix as it was back in 1972</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="code"><pre><code class="hljs stata">$ docker <span class="hljs-keyword">run</span> --<span class="hljs-keyword">rm</span> -it bahamat/unix-1st-<span class="hljs-keyword">ed</span><br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Cloud Native</category>
      </categories>
  </entry>
  <entry>
    <title>hexo-next-gitalk</title>
    <url>/2021/09/01/hexo-next-gitalk/</url>
    <content><![CDATA[<h3 id="站点搭建过程"><a href="#站点搭建过程" class="headerlink" title="站点搭建过程"></a>站点搭建过程</h3><ul>
<li><a href="https://hexo.io/zh-cn/">hexo</a> : 快速、简洁且高校的博客框架</li>
<li><a href="https://github.com/next-theme/hexo-theme-next/blob/master/docs/zh-CN/README.md">next</a> : Hexo主题</li>
<li><a href="https://github.com/gitalk/gitalk">gitalk</a> : 依靠GitHub issue的评论系统</li>
</ul>
<span id="more"></span>

<h3 id="Settings-amp-Tips"><a href="#Settings-amp-Tips" class="headerlink" title="Settings &amp; Tips"></a>Settings &amp; Tips</h3><ul>
<li><p><strong>Show descripion</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"># 修改themes/next/_config.yml<br>excerpt_description: true<br><br># 文章截断<br><span class="hljs-comment">&lt;!--more--&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>字数统计</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 安装插件 hexo-symbols-count-time</span><br><span class="hljs-string">$</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">hexo-symbols-count-time</span><br><br><span class="hljs-comment"># 修改hexo配置文件_config.yml</span><br>  <span class="hljs-comment"># Symbols count and time to read of articles for Hexo.</span><br>  <span class="hljs-attr">symbols_count_time:</span><br>      <span class="hljs-attr">symbols:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">time:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">total_symbols:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">total_time:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-comment"># 修改Next配置文件</span><br>  <span class="hljs-comment"># Post wordcount display settings</span><br>  <span class="hljs-comment"># Dependencies: https://github.com/next-theme/hexo-word-counter</span><br>  <span class="hljs-attr">symbols_count_time:</span><br>    <span class="hljs-attr">separated_meta:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">item_text_post:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">item_text_total:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">awl:</span> <span class="hljs-number">4</span><br>    <span class="hljs-attr">wpm:</span> <span class="hljs-number">275</span><br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Computer Science</category>
      </categories>
  </entry>
  <entry>
    <title>micro-services</title>
    <url>/2021/09/01/micro-services/</url>
    <content><![CDATA[<blockquote>
<p>项目工程化、微服务相关介绍</p>
</blockquote>
<span id="more"></span>

<h2 id="项目工程化"><a href="#项目工程化" class="headerlink" title="项目工程化"></a>项目工程化</h2><ul>
<li><p>开源规范</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 开源协议</span><br><span class="hljs-bullet">  1.</span> GPL - General Public License<br><span class="hljs-code">    &gt; 衍生代码的分发需要开源并且也要遵守此协议</span><br><span class="hljs-code">  2. MPL</span><br><span class="hljs-code">    &gt; 允许免费重发布、免费修改，但要求修改的代码版权归软件发起者，这种授权维护了商业软件的利益，要求基于这种软件的修改无偿贡献版权给该软件</span><br><span class="hljs-code">  3. LGPL</span><br><span class="hljs-code">  4. Apache</span><br><span class="hljs-code">    &gt; Apache 2.0协议除了为用户提供版权许可之外，还有专利许可，适合设计专利内容的项目</span><br><span class="hljs-code">  5. BSD</span><br><span class="hljs-code">    &gt;</span><br><span class="hljs-code">  6. MIT</span><br><span class="hljs-code">    &gt; MIT 协议是所有开源许可中最宽松的一个，除了细笔包含许可声明之外，再无任何限制</span><br></code></pre></td></tr></table></figure></li>
<li><p>开源规范</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 项目结构:<br><span class="hljs-bullet">2.</span> 严格遵循代码规范:<br><span class="hljs-bullet">3.</span> 代码质量:<br><span class="hljs-bullet">4.</span> 单元测试覆盖率:<br><span class="hljs-bullet">5.</span> 版本发布规范:<br><span class="hljs-bullet">6.</span> 向下兼容:<br><span class="hljs-bullet">7.</span> 详细的文档说明:<br><span class="hljs-bullet">8.</span> 安全:<br></code></pre></td></tr></table></figure></li>
<li><p>文档规范</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> README文档<br>  介绍项目功能、安装、部署、使用<br><span class="hljs-bullet">2.</span> 项目文档<br>  开发文档: 说明项目的开发流程<br>  用户文档:<br><span class="hljs-bullet">3.</span> API接口文档<br></code></pre></td></tr></table></figure></li>
<li><p>版本规范</p>
<figure class="highlight tp"><table><tr><td class="code"><pre><code class="hljs tp">语义化版本规范: SemVer: 主版本号.次版本号.修订号 (<span class="hljs-keyword">X</span>.<span class="hljs-keyword">Y</span>.<span class="hljs-keyword">Z</span>), XYZ为非负的整数，禁止在数字前方补零<br>  主版本号: MAJOR: 当做了不兼容API修改<br>  次版本号: MINOR: 当做了向下兼容的功能新增及修改 -- 偶数为稳定版本，奇数为开发版本<br>  修订号:PATCH: 向下兼容问题修正<br><br><span class="hljs-keyword">X</span>.<span class="hljs-keyword">Y</span>.<span class="hljs-keyword">Z</span>[-先行版本号][+版本编译元数据]<br><br><span class="hljs-number">1</span>. 实际开发的时候，使用<span class="hljs-number">0</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>作为第一开发版本号<br>fix类型的commit 可以将修订号+<span class="hljs-number">1</span><br>feat类型的commit可以将次版本号+<span class="hljs-number">1</span><br>breaking change的commit将主版本号+<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li>
<li><p>Commit 规范</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><code class="hljs dts">Commit Message包含三部分:<br><span class="hljs-symbol">  Header:</span> <span class="hljs-params">&lt;type&gt;</span>[optional scope]: <span class="hljs-params">&lt;description&gt;</span><br><span class="hljs-symbol">    type:</span><br><span class="hljs-symbol">      feat:</span> 新增功能<br><span class="hljs-symbol">      fix:</span> Bug修复<br><span class="hljs-symbol">      perf:</span> 提高代码性能的变更<br><span class="hljs-symbol">      style:</span> 代码格式类的变更<br><span class="hljs-symbol">      refactor:</span> 其他代码类的变更，这些变更不属于feat,fix,perf和style. 简化代码，重命名变量、删除冗余代码<br><span class="hljs-symbol">      test:</span> 新增测试用例或是更新现有测试用例<br><span class="hljs-symbol">      ci:</span> 持续集成和部署想干改动，<br><span class="hljs-symbol">      docs:</span> 文档类更新<br><span class="hljs-symbol">      chore:</span> 其他类型，构建流程、依赖管理或者辅助工具的变动<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">    scope:</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">    description:</span> 动词开头，使用现在时<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">  Body:</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">  Footer:</span><br><br>git rebase: 重写历史<br>  git rebase -i <span class="hljs-params">&lt;commit ID&gt;</span> 这里是需要合并commit中最旧commit的父commit ID<br><br>git reset HEAD~<span class="hljs-number">3</span>A 撤销过去的commit,重新提交<br><br>git commit --amend: 修改最近一次commit 的 message<br><br>Commit Message是commit数据结构中的一个属性，如果Commit Message有变更，则commit ID一定会变，git commit --amend只会变更最后一次的commit ID, git rebase -i 会变更父commit ID之后的所有提交commit ID.<br><br>如果当前分之有未commit的代码，需要先执行git stash将工作状态进行暂存，当修改完成后在执行git stash pop恢复之前的工作状态<br></code></pre></td></tr></table></figure></li>
<li><p>目录结构设计</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># 结构化目录结构</span><br>  /cmd            <span class="hljs-comment">-- 组件</span><br>  /internal       <span class="hljs-comment">-- 私有应用和库代码,不希望在其他应用和库中被导入</span><br>  /pkg            <span class="hljs-comment">-- 存放可以被外部应用使用的代码库</span><br><span class="hljs-comment"># 平铺式目录结构</span><br>  &gt; 这种方式在很多框架/库中存在,好处式引用路径长度短<br></code></pre></td></tr></table></figure></li>
<li><p>工作流设计</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># 集中式工作流</span><br>  &gt; 适用于团队人数少、开发不频繁、不需要同时维护多个版本的小项目<br><br><span class="hljs-comment"># 功能分支工作流</span><br>  &gt; 不同功能在不同的分支进行开发，最后合并到<span class="hljs-literal">master</span>分支<br>  Merge pull request:<br>    <span class="hljs-number">1</span>. Create a merge commit: git merge --no-ff. feature分支上所有的commit都会加到<span class="hljs-literal">master</span>分支上，并且会生成一个merge commit。<br>    <span class="hljs-number">2</span>. Squash <span class="hljs-keyword">and</span> merge: git merge --squash. feature分支上所有的commit都合并成一个commit.然后加到<span class="hljs-literal">master</span>分支,原来的commit历史会丢失<br>    <span class="hljs-number">3</span>. Rebase <span class="hljs-keyword">and</span> merge: git rebase. 将pull request上所有提交历史按照原有顺序依次添加到<span class="hljs-literal">master</span>分支的头部HEAD.<br><br><span class="hljs-comment"># Git Flow工作流</span><br>  &gt; 比较适合大型的项目或者迭代速度快的项目<br>  <span class="hljs-literal">master</span>: 该分支最新代码是发布状态，不能直接在该分支上开发，<span class="hljs-literal">master</span>分支每合并一个hotfix/release分支，都会打一个版本标签<br>  develop: 该分支是开发中的最新代码，该分支只做合并操作，不能直接在该分支上开发<br>  feature: 功能开发,基于develop分支新建一个feature分支，feature分支合并之前先pull一下develop分支，<br>  release: 在发布阶段作为版本发布的预发布分支，基于develop分支创建, 测试通过后，将release分支合并到<span class="hljs-literal">master</span>和develop，并在<span class="hljs-literal">master</span>分支上版本标签，最后删除release版本分支<br>  hotfix: 在维护阶段做紧急Bug修复分支，hotfix分支合并到<span class="hljs-literal">master</span>和develop分支，并在<span class="hljs-literal">master</span>分支打上修复后的版本标签,最后删除hotfix分支<br><br><span class="hljs-comment"># Forking 工作流</span><br>  项目远程仓库和开发者远程仓库完全独立，开发者通过Pull Request的方式给远程仓库贡献代码，项目维护者选择性地接收任何开发者的提交，通过这种方式，可以避免开发者项目远程仓库的权限,从而提高项目远程仓库的安全性<br></code></pre></td></tr></table></figure></li>
<li><p>研发流程</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 需求阶段</span><br><span class="hljs-bullet">  1.</span> 市场调研 - PDM(Product Manager) 产品经理<br><span class="hljs-bullet">  2.</span> 需求分析 - PM(Project Manager) 项目经理<br><span class="hljs-bullet">  3.</span> 需求文档 - 最终产物<br><span class="hljs-bullet">  4.</span> 需求评审<br><br><span class="hljs-section"># 设计阶段</span><br><span class="hljs-bullet">  1.</span> 交互设计 - UX(User Experience) 交互设计师<br><span class="hljs-bullet">  2.</span> 视觉设计 - UI(User Interface) 视觉设计师<br><span class="hljs-bullet">  3.</span> 技术设计<br><span class="hljs-bullet">  4.</span> 技术评审 - 最终产物<br><span class="hljs-bullet">  5.</span> 需求排期<br><br><span class="hljs-section"># 开发阶段</span><br><span class="hljs-bullet">  -</span> 开发 - Makefile - RD(Research and Development engineer) 研发工程师<br><span class="hljs-bullet">    1.</span> Git Flow工作流<br><span class="hljs-bullet">    2.</span> 生成代码 -- 尽可能自动生成代码<br><span class="hljs-bullet">    3.</span> 版权检查<br><span class="hljs-bullet">    4.</span> 静态代码检查<br><span class="hljs-bullet">    5.</span> 单元测试<br><span class="hljs-bullet">    6.</span> 编译<br><span class="hljs-bullet">    7.</span> 自测<br><span class="hljs-bullet">    8.</span> Code Review<br><span class="hljs-bullet">    9.</span> Merge<br><span class="hljs-bullet">  -</span> 构建 - CI/CD<br><span class="hljs-bullet">    1.</span> 代码扫描<br><span class="hljs-bullet">    2.</span> 单元测试<br><span class="hljs-bullet">    3.</span> 编译打包<br><span class="hljs-bullet">    4.</span> 归档[镜像仓库]<br><br><span class="hljs-section"># 测试阶段</span><br>  &gt; 测试阶段为了不阻塞测试，确保项目按时发布，研发人员应该优先解决测试同学的Bug,至少是阻塞类的Bug<br><span class="hljs-bullet">  1.</span> 功能测试 - QA(Quality Assurance) 质量管理工程师<br><span class="hljs-bullet">  2.</span> 性能测试 - QE(Quality Engineering) 质量工程师<br><span class="hljs-bullet">  3.</span> 集成测试<br><span class="hljs-bullet">  4.</span> 系统测试<br><br><span class="hljs-section"># 发布阶段</span><br><span class="hljs-bullet">  -</span> 代码发布<br><span class="hljs-bullet">    1.</span> 合并到主干 - Master分支<br><span class="hljs-bullet">    2.</span> 生成版本号<br><span class="hljs-bullet">    3.</span> 打标签<br><span class="hljs-bullet">    4.</span> 代码扫描<br><span class="hljs-bullet">    5.</span> 单元测试<br><span class="hljs-bullet">    6.</span> 编译<br><span class="hljs-bullet">    7.</span> 发布构建产物<br><span class="hljs-bullet">  -</span> 发布审批<br><span class="hljs-bullet">    1.</span> 资源申请<br><span class="hljs-bullet">    2.</span> 创建发布计划<br><span class="hljs-bullet">    3.</span> 创建发布单<br><span class="hljs-bullet">    4.</span> 发布单审批<br><span class="hljs-bullet">  -</span> 服务发布<br><span class="hljs-bullet">    1.</span> 预发部署<br><span class="hljs-bullet">    2.</span> 预发验证<br><span class="hljs-bullet">    3.</span> 现网部署<br><span class="hljs-bullet">    4.</span> 现网验证<br><br><span class="hljs-section"># 运营阶段</span><br><span class="hljs-bullet">  -</span> 产品运营<br><span class="hljs-bullet">    1.</span> 技术沙龙<br><span class="hljs-bullet">    2.</span> 技术推文<br><span class="hljs-bullet">  -</span> 运维运营 - OP(Operation) 运维工程师<br><span class="hljs-bullet">    1.</span> 运维工具<br><span class="hljs-bullet">    2.</span> 日志系统<br><span class="hljs-bullet">    3.</span> 监控告警<br></code></pre></td></tr></table></figure></li>
<li><p>应用生命周期管理</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 研发模式</span><br><span class="hljs-bullet">  -</span> 瀑布模式<br><span class="hljs-bullet">    -</span> 优点:<br><span class="hljs-bullet">      1.</span> 严格按照研发阶段推进研发进度，流程清晰，适合按项目交付的应用<br><span class="hljs-bullet">    -</span> 缺点:<br><span class="hljs-bullet">      1.</span> 变更困难<br><span class="hljs-bullet">      2.</span> 研发周期长<br><span class="hljs-bullet">  -</span> 迭代模式<br><span class="hljs-code">    &gt; 不要求每个阶段的任务做到最完美，而是先把主要功能搭建起来，然后通过客户的反馈信息不断完善</span><br><span class="hljs-code">  - 敏捷模式</span><br><span class="hljs-code">    &gt; 敏捷模式把一个大的需求分成多个、可分阶段完成的小迭代，每个迭代交付的都是一个可使用的软件，开发过程中，软件要一致处于可使用状态</span><br><span class="hljs-code">    - Scrum开发模式</span><br><span class="hljs-code"></span><br><span class="hljs-section"># CI/CD</span><br>  CI: Continuous Integration, 持续集成<br>  CD: Continous Delivery, 持续交付<br>  CD: Continous Deployment, 持续部署<br><br><span class="hljs-section"># DevOps: 研发运维一体化</span><br><span class="hljs-bullet">  -</span> AIOps: 职能运维<br><span class="hljs-bullet">  -</span> ChatOps: 通过聊天窗口的机器人Bot出发任务<br><span class="hljs-bullet">  -</span> GitOps:<br><span class="hljs-code">    &gt; 开发人员开发完代码后推送Git仓库，触发CI流程，CI流程通过编译构建出Docker镜像，并将镜像push到Docker镜像仓库，Push动作触发Push事件，通过webhook形式通知Config Updater服务，Config Updater服务从镜像仓库中下载镜像，并更新Git仓库中的kubernetes YAML文件</span><br><span class="hljs-code">  - NoOps:</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="介绍Web框架"><a href="#介绍Web框架" class="headerlink" title="介绍Web框架"></a>介绍Web框架</h2><ul>
<li>Gin<blockquote>
<p>Go编写的web框架，是一个类似martini性能更好的API框架</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> Engine: 初始化gin对象实例，<br>  日志<br>  中间件<br>  路由控制<br>  handlercontext<br><span class="hljs-bullet">2.</span> Router: 定义各种路由规则和条件<br><span class="hljs-bullet">3.</span> Context: 允许在中间件中共享变量，管理整个流程，验证请求的json以及提供<br><span class="hljs-bullet">4.</span> Bind:<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="介绍微服务架构设计"><a href="#介绍微服务架构设计" class="headerlink" title="介绍微服务架构设计"></a>介绍微服务架构设计</h2><ul>
<li><p>服务化基础设施技术选型</p>
<ul>
<li>服务间通信中间件<ul>
<li>同步方式: RPC</li>
<li>异步方式: MQ</li>
</ul>
</li>
</ul>
</li>
<li><p>客户端一致性</p>
<blockquote>
<p>共享相同connection可以在同一个事务里</p>
</blockquote>
<figure class="highlight sas"><table><tr><td class="code"><pre><code class="hljs sas">1. begin tx 开启本地事务<br>2. <span class="hljs-meta">do</span> work 执行业务操作<br>3. <span class="hljs-meta">insert</span> <span class="hljs-meta">message</span> 向同实例消息库插入消息<br>4. <span class="hljs-meta">end</span> tx 事务提交<br>5. send <span class="hljs-meta">message</span> 网络向server发送消息<br>6. response server 回应消息<br>7. <span class="hljs-meta">delete</span> <span class="hljs-meta">message</span> 如果server回复成功则删除消息<br>8. scan <span class="hljs-meta">message</span> 补偿任务扫描未发送消息<br>9. send <span class="hljs-meta">message</span> 补偿任务补偿消息<br>10. <span class="hljs-meta">delete</span> <span class="hljs-meta">message</span> 补偿任务删除补偿成功的消息<br></code></pre></td></tr></table></figure></li>
<li><p>服务端存储模型</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"># Kafka RocketMQ基于partition存储模型<br><span class="hljs-meta">&gt;</span> <span class="javascript">每个subject分为一个或多个partition，而Server收到消息后将其分发到某个partition上，而concumer消费的时候与partition对应。合理的分配策略是partition个数与consumer个数成倍数关系.</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">静态绑定关系导致consumer扩容缩容比较麻烦</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">顺序append文件，提供很好的性能</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">顺序消费文件，使用offset表示消费进度，不给给个消息记录消费状态,成本极低</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">将所有subject的消息合并在一起</span><br><br># 业务使用消息 vs. 数据流处理区别<br>  &gt; 数据流中消息主题少，每个消息主题的吞吐量极大<br>  &gt; 业务中消息主题极多，很多主题量级很小<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="BFF-Backend-For-Frontend-服务于前端的后端"><a href="#BFF-Backend-For-Frontend-服务于前端的后端" class="headerlink" title="BFF - Backend For Frontend 服务于前端的后端"></a>BFF - Backend For Frontend 服务于前端的后端</h2><blockquote>
<p>用户体验适配器</p>
</blockquote>
<h2 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h2><ul>
<li>计算中所有文件都可以通过添加一个中间层来解决，一个中间层解决不了就添加两个</li>
</ul>
]]></content>
      <categories>
        <category>Microservice</category>
      </categories>
  </entry>
  <entry>
    <title>Distributed ID Generator</title>
    <url>/2021/09/02/Distributed-ID-Generator/</url>
    <content><![CDATA[<blockquote>
<p>分布式ID生成器</p>
</blockquote>
<span id="more"></span>

<h1 id="Distributed-ID-Generator"><a href="#Distributed-ID-Generator" class="headerlink" title="Distributed ID Generator"></a>Distributed ID Generator</h1><ul>
<li>UUID<figure class="highlight makefile"><table><tr><td class="code"><pre><code class="hljs makefile">package main<br><br>import (<br>  <span class="hljs-string">&quot;testing&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/google/uuid&quot;</span><br>)<br><br>func BenchmarkUUID(t *testing.B) &#123;<br>  for i := 0; i &lt; t.N; i++ &#123;<br>    _ = uuid.New()<br>  &#125;<br>&#125;<br><br>~/Downloads/uuid_demo via 🐹 v1.17 took 13s<br>➜ go test -bench=.<br><span class="hljs-section">goos: darwin</span><br><span class="hljs-section">goarch: amd64</span><br><span class="hljs-section">pkg: uuid_demo</span><br><span class="hljs-section">cpu: Intel(R) Core(TM) i5-5257U CPU @ 2.70GHz</span><br>BenchmarkUUID-4   	 1390710	       844.7 ns/op<br>PASS<br>ok  	uuid_demo	2.351s<br><br><span class="hljs-comment"># UUIDs are 128-bit hexadecimal numbers that are globally unique</span><br><br><span class="hljs-comment"># 优点:</span><br>  1. 生成足够简单，本地生成无网络消耗，具有唯一性<br><span class="hljs-comment"># 缺点:</span><br>  1. 无序的字符串，不具备趋势自增特性<br>  2. 没有具体的业务含义<br>  3. 长度过长16字节128位,36位长度的字符串,存储以及查询数据库性能消耗较大,数据库建议主键尽量越短越好，作为数据库主键UUID的无序性会导致数据位置频繁变动，严重影响性能<br></code></pre></td></tr></table></figure></li>
<li>基于数据库自增ID<blockquote>
<p>基于数据库的auto_increment自增ID完成可以充当分布式ID</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"># 创建数据表<br>mysql&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> SEQUENCE_ID (id <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> auto_increment, <span class="hljs-keyword">value</span> <span class="hljs-type">char</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-keyword">PRIMARY KEY</span> (id)) ENGINE=MyISAM;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected, <span class="hljs-number">1</span> <span class="hljs-built_in">warning</span> (<span class="hljs-number">0.08</span> sec)<br><br># MySQL使用存储过程插入数据<br><span class="hljs-keyword">delimiter</span> $$<span class="pgsql"></span><br><span class="pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> bench_insert(count <span class="hljs-type">int</span> unsigned)</span><br><span class="pgsql"><span class="hljs-keyword">BEGIN</span></span><br><span class="pgsql">  <span class="hljs-keyword">declare</span> num <span class="hljs-type">int</span> unsigned <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;</span><br><span class="pgsql">  <span class="hljs-keyword">declare</span> c <span class="hljs-type">char</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">default</span> repeat(<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-number">10</span>);</span><br><span class="pgsql">  <span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;</span><br><span class="pgsql">  <span class="hljs-keyword">while</span> num &lt;= count <span class="hljs-keyword">DO</span></span><br><span class="pgsql">    <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> SEQUENCE_ID(`<span class="hljs-keyword">value</span>`) <span class="hljs-keyword">values</span>(c);</span><br><span class="pgsql">    <span class="hljs-keyword">set</span> num=num+<span class="hljs-number">1</span>;</span><br><span class="pgsql">  <span class="hljs-keyword">end</span> <span class="hljs-keyword">while</span>;</span><br><span class="pgsql"><span class="hljs-keyword">COMMIT</span>;</span><br><span class="pgsql"><span class="hljs-keyword">END</span>$$</span> <span class="hljs-keyword">delimiter</span> ;<br><br><br><span class="hljs-keyword">CALL</span> bench_insert(<span class="hljs-number">10000</span>);<br><br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">PROCEDURE</span> bench_insert;<br><br># 当需要ID的时候，向表中插入记录返回主键ID.<br><br># 优点:<br>  <span class="hljs-number">1.</span> 实现简单、ID单调自增、数值类型查询速度快<br><br>缺点:<br>  <span class="hljs-number">1.</span> DB单点存在宕机风险，无法扛住高并发场景<br></code></pre></td></tr></table></figure></li>
<li>基于数据库集群模式<blockquote>
<p>多数据库实例单独生产自增ID</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"># 设置启始值和自增布长<br>  DB1:<br>    <span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_offset <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">-- 起始值</span><br>    <span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_increment <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; <span class="hljs-comment">-- 步长</span><br>  DB2:<br>    <span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_offset <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; <span class="hljs-comment">-- 起始值</span><br>    <span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_increment <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; <span class="hljs-comment">-- 步长</span><br><br># 优点:<br>  解决DB单点问题<br><br># 缺点:<br>  不利于后续扩容，而且实际上单个数据库自身压力还是很大，依旧无法满足高并发场景<br></code></pre></td></tr></table></figure></li>
<li>基于数据库的号段模式<blockquote>
<p>号段模式是分布式ID生成器主流实现方式之一，批量获取自增ID，每次从数据库取出一个号段范围，具体业务服务将本号段生成的自增ID加载内存</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">  mysql&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> id_generator (id <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, max_id <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">&#x27;当前最大id&#x27;</span>, step <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">&#x27;号段的布长&#x27;</span>, biz_type <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">&#x27;业务类型&#x27;</span>, <span class="hljs-keyword">version</span> <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">&#x27;版本号&#x27;</span>, <span class="hljs-keyword">PRIMARY KEY</span>(`id`));<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected, <span class="hljs-number">5</span> warnings (<span class="hljs-number">0.11</span> sec)<br><br>  mysql&gt; describe id_generator;<br>  +<span class="hljs-comment">----------+--------+------+-----+---------+-------+</span><br>  | Field    | <span class="hljs-keyword">Type</span>   | <span class="hljs-keyword">Null</span> | Key | <span class="hljs-keyword">Default</span> | Extra |<br>  +<span class="hljs-comment">----------+--------+------+-----+---------+-------+</span><br>  | id       | <span class="hljs-type">int</span>    | <span class="hljs-keyword">NO</span>   | PRI | <span class="hljs-keyword">NULL</span>    |       |<br>  | max_id   | <span class="hljs-type">bigint</span> | <span class="hljs-keyword">NO</span>   |     | <span class="hljs-keyword">NULL</span>    |       |  <span class="hljs-comment">-- 当前最大的可用id</span><br>  | step     | <span class="hljs-type">int</span>    | <span class="hljs-keyword">NO</span>   |     | <span class="hljs-keyword">NULL</span>    |       |  <span class="hljs-comment">-- 代表号段的长度</span><br>  | biz_type | <span class="hljs-type">int</span>    | <span class="hljs-keyword">NO</span>   |     | <span class="hljs-keyword">NULL</span>    |       |  <span class="hljs-comment">-- 不同业务类型</span><br>  | <span class="hljs-keyword">version</span>  | <span class="hljs-type">int</span>    | <span class="hljs-keyword">NO</span>   |     | <span class="hljs-keyword">NULL</span>    |       |  <span class="hljs-comment">-- 乐观锁，每次都更新version，保证并发时数据的正确性</span><br>  +<span class="hljs-comment">----------+--------+------+-----+---------+-------+</span><br>  <span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)<br><br>  <span class="hljs-keyword">update</span> id_generator <span class="hljs-keyword">set</span> max_id = #&#123;max_id+step&#125;, version = <span class="hljs-keyword">version</span> + <span class="hljs-number">1</span> <span class="hljs-keyword">where</span> version = # &#123;<span class="hljs-keyword">version</span>&#125; <span class="hljs-keyword">and</span> biz_type = XXX<br></code></pre></td></tr></table></figure></li>
<li>基于Redis模式<blockquote>
<p>利用redis Incr 原子性自增</p>
</blockquote>
<figure class="highlight dns"><table><tr><td class="code"><pre><code class="hljs dns"><br>  <span class="hljs-number">172.30.1.23</span>:<span class="hljs-number">6002</span>&gt; set seq_id <span class="hljs-number">1</span><br>  OK<br>  <span class="hljs-number">172.30.1.23</span>:<span class="hljs-number">6002</span>&gt; incr seq_id<br>  (integer) <span class="hljs-number">2</span><br>  <span class="hljs-number">172.30.1.23</span>:<span class="hljs-number">6002</span>&gt; get seq_id<br>  &quot;<span class="hljs-number">2</span>&quot;<br>  <span class="hljs-number">172.30.1.23</span>:<span class="hljs-number">6002</span>&gt;<br><br># Benchmark<br>ubuntu in ~ at <span class="hljs-number">3</span>BPlus took <span class="hljs-number">4</span>s<br>➜ redis-benchmark -n <span class="hljs-number">1000000</span> -t set,get,incr -P <span class="hljs-number">16</span> -q -h <span class="hljs-number">127.0.0.1</span> -p <span class="hljs-number">6001</span> --cluster<br>Cluster has <span class="hljs-number">3</span> master nodes:<br><br>Master <span class="hljs-number">0</span>: a733c21d3b735b9d026eb4d462ef6b367d8ebb<span class="hljs-number">98 172.30.1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6002</span><br>Master <span class="hljs-number">1</span>: <span class="hljs-number">9</span>c35a4e211f6534861ed768dba592e<span class="hljs-number">85539b1377</span> <span class="hljs-number">172.30.1.23</span>:<span class="hljs-number">6003</span><br>Master <span class="hljs-number">2</span>: a901e497cb72819cf0765e9e4eb16c36399c437b <span class="hljs-number">172.30.1.23</span>:<span class="hljs-number">6001</span><br><br>SET: <span class="hljs-number">47001.32</span> requests per second, p<span class="hljs-number">50=15.199</span> msec<br>GET: <span class="hljs-number">101936.80</span> requests per second, p<span class="hljs-number">50=5.679</span> msec<br>INCR: <span class="hljs-number">46496.49</span> requests per second, p<span class="hljs-number">50=13.879</span> msec   -- 并发<span class="hljs-number">5</span>万/s<br></code></pre></td></tr></table></figure></li>
<li>twitter snowflake<blockquote>
<p>雪花算法 (Snowflake) Twitter内部分布式采用的ID生成算法</p>
</blockquote>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section"># The default Twitter format shown below.</span><br><span class="hljs-section">+--------------------------------------------------------------------------+</span><br><span class="hljs-section">| 1 Bit Unused | 41 Bit Timestamp |  10 Bit NodeID  |   12 Bit Sequence ID |</span><br><span class="hljs-section">+--------------------------------------------------------------------------+</span><br><br>41 bits: store a timestamp with millisecond precision<br>10 bits: store a node id - a range from 0 through 1023<br>12 bits: store a sequence number - a range from 0 through 4095<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Distributed Systems</category>
      </categories>
  </entry>
  <entry>
    <title>Kafka Tips &amp; Tracks</title>
    <url>/2021/09/02/Kafka-Tips-Tracks/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL Tips &amp; Tracks</title>
    <url>/2021/09/02/MySQL-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="数据库-三大范式"><a href="#数据库-三大范式" class="headerlink" title="数据库-三大范式"></a>数据库-三大范式</h1><ul>
<li>原子性: 字段不可分</li>
<li>唯一性: 有主键(没有主键就没有唯一性)，非主键字段依赖主键</li>
<li>消除冗余: 每列都与主键有直接关系, 非主键字段不能相互依赖</li>
</ul>
<span id="more"></span>

<h2 id="MySQL事务模型-ACID"><a href="#MySQL事务模型-ACID" class="headerlink" title="MySQL事务模型 ACID"></a>MySQL事务模型 ACID</h2><blockquote>
<p>MySQL事务的四个特性中ACD三个特性是通过Redo Log(重做日志)和Undo Log(撤销日志)实现,而I隔离型通过Lock实现</p>
</blockquote>
<ul>
<li><p>事务是可以提交或回滚的原子工作单元</p>
</li>
<li><p>ACID模型是一组数据库设计原则</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">A:</span> atomicity原子性: 事务中一系列的操作，要么全部都执行，要么全部都不执行<br><span class="hljs-symbol">C:</span> consistency一致性(通过AID保证): 数据库事务不能破坏关系数据的完整性以及业务逻辑上的一致性<br><span class="hljs-symbol">I:</span> isolation 隔离性(事务的隔离级别): 并发环境下，不同事务同时操作相同的数据，每个事务都有各自的完成数据空间<br><span class="hljs-symbol">D:</span> durability持久性: 只要事务成功结束，对数据库所做的更新就永久保存下来，即使发生系统崩溃，重新启动数据库，数据库还能恢复到事务成功结束时的状态<br></code></pre></td></tr></table></figure></li>
<li><p>InnoDB 存储引擎架构<br><img src="/misc/images/InnoDB-architecture.jpeg" alt="InnoDB Architecture"></p>
</li>
<li><p>并发问题</p>
<ul>
<li>脏读: Drity Read: 读取到未提交的数据</li>
<li>不可重复读: Non-repeatable read: 两次读取结果不同</li>
<li>幻读 Phantom Read: select操作得到的结果所表证的数据状态无法支撑后续的业务操作</li>
</ul>
</li>
<li><p>InnoDB 四种隔离级别</p>
<ul>
<li>READ UNCOMMITED 读未提交 –&gt; 脏读</li>
<li>READ COMMITTED 读已提交 –&gt;  不可重复读</li>
<li>REPEATABLE READ 可重复读 –&gt; 幻读</li>
<li>SERIALIZABLE 串行化</li>
</ul>
</li>
</ul>
<h2 id="数据库日志"><a href="#数据库日志" class="headerlink" title="数据库日志"></a>数据库日志</h2><ul>
<li><p>WAL - Write Ahead Log</p>
<blockquote>
<p>实际写数据前，先把修改的数据记到日志文件中，以便故障时进行修复</p>
</blockquote>
</li>
<li><p>重做日志 - redo log</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash"> 记录修改后的数据</span><br><span class="hljs-meta">&gt;</span><span class="bash"> 用于异常恢复</span><br><span class="hljs-meta">&gt;</span><span class="bash"> 循环写文件</span><br><span class="hljs-meta">&gt;</span><span class="bash">&gt; write Pos: 写入位置</span><br><span class="hljs-meta">&gt;</span><span class="bash">&gt; Check Point: 刷盘位置</span><br><span class="hljs-meta">&gt;</span><span class="bash">&gt; Check Point -&gt; Write Pos: 待落盘</span><br><span class="hljs-meta">&gt;</span><span class="bash">&gt; innodb_flush_log_at_trx_commit: 刷盘时机</span><br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; 0 commit 每秒写文件,并刷盘</span><br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; 1 commit 每次提交时写文件，</span><br><span class="hljs-meta">#</span><span class="bash"> MySQL redo-log:</span><br>  1. 体积小，记录页的修改，比写入页代价低<br>  2. 末尾追加，随机写变顺序写，发生改变的页不固定<br></code></pre></td></tr></table></figure></li>
<li><p>回滚日志 - Undo Log</p>
<blockquote>
<p>回滚日志记录的集合，包含如何撤销事务对聚集索引记录的最新更新的信息</p>
</blockquote>
<ul>
<li><p>保证事务原子性</p>
</li>
<li><p>实现数据多版本</p>
</li>
<li><p>delete undo log: 用于回滚，提交即清理</p>
</li>
<li><p>update undo log:</p>
</li>
<li><p>undo log如何清理:</p>
<ul>
<li>依据系统活跃的最小活跃事务ID Read view</li>
</ul>
</li>
<li><h2 id="为什么InnoDB-count-这么慢"><a href="#为什么InnoDB-count-这么慢" class="headerlink" title="为什么InnoDB count(*) 这么慢?"></a>为什么InnoDB count(*) 这么慢?</h2></li>
</ul>
</li>
</ul>
<h2 id="MySQl多版本并发控制-MVCC"><a href="#MySQl多版本并发控制-MVCC" class="headerlink" title="MySQl多版本并发控制 - MVCC"></a>MySQl多版本并发控制 - MVCC</h2><blockquote>
<p>使得InnoDB的事务隔离级别下执行一致性读操作有保证, 查询一个被另一个事务更新的行，可以看到被更新之前的值<br>多版本并发控制，解决读写冲突问题</p>
</blockquote>
<ul>
<li>InnoDB MVCC实现<ul>
<li>当前读 – Select for update</li>
<li>快照读 – Select Current_TRX_ID</li>
<li>可见性判断<ul>
<li>创建快照这一刻，还未提交的事务，在此生命周期中无法读取</li>
<li>创建快照之后创建的事务无法读取</li>
</ul>
</li>
<li>Read View<ul>
<li>快照读 活跃事务列表</li>
<li>活跃事务列表中最小事务ID</li>
<li>活跃事务列表中最大事务ID<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">InnoDB</span>向数据库中存储的每一行数据添加三个字段隐藏字段<br><span class="hljs-attribute">1</span>. DB_TRX_ID: <span class="hljs-number">6</span>字节 表示插入或更新最后一个事务的事务标识符 全局递增<br><span class="hljs-attribute">2</span>. DB_ROLL_PTR: <span class="hljs-number">7</span>字节 回滚指针 roll pointer, 指向写入回滚段撤销日志Undo Log<br><span class="hljs-attribute">3</span>. DB_ROW_ID: <span class="hljs-number">6</span>字节 随着新行插入而单调增加的行ID<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>  <img src="/misc/images/mvcc.jpeg" alt="mvcc"></p>
<ul>
<li>InnoDB Locking<ul>
<li>Shared and Exclusive Locks - 共享锁和排他锁<ul>
<li>A Shared Lock 允许持有锁的事务读取该行</li>
<li>An Exclusive Lock 允许持有锁的事务更新和删除该行<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">假设事务T1对数据行r持有共享锁(Shared <span class="hljs-keyword">Lock</span>),另一个事务T2对同一数据行r的操作分下面两种情况:<br>  <span class="hljs-number">1.</span> T2对数据行r仅仅是读取请求持有(Shared <span class="hljs-keyword">Lock</span>)成功，结果是T1和T2对数据行r都持有共享锁<br>  <span class="hljs-number">2.</span> T2对数据行人需要<span class="hljs-keyword">Update</span>请求持有(<span class="hljs-keyword">Exclusive</span> <span class="hljs-keyword">Lock</span>)会失败<br><br>假设事务T1对数据行r持有排他锁(<span class="hljs-keyword">exclusive</span> <span class="hljs-keyword">lock</span>),另一个事务T2对同一数据行r的锁请求(共享锁/排他锁)都会失败,事务T2不得不等待事务T1释放锁<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="MySQL-存储引擎"><a href="#MySQL-存储引擎" class="headerlink" title="MySQL 存储引擎"></a>MySQL 存储引擎</h2><ul>
<li><p>Page</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><code class="hljs makefile">&gt; 页Page : 16KB, 存储IO的基本单元<br>Page Header: 页头, 记录页面的控制信息，占用56字节，包括页的左右兄弟页面指针，页面空间使用情况<br><span class="hljs-section">虚记录:</span><br>  最大虚记录,比页内最大主键大<br>  最小虚记录,比页内最小主键小<br><span class="hljs-section">记录堆: 行记录存储区</span><br>  有效记录<br>  已删除记录<br><span class="hljs-section">自由空间链表: 已删除记录组成的链表</span><br><span class="hljs-section">未分配空间: 页内未使用的存储空间</span><br>Slot 区: 连续空间平均分配<br>Page Tailer: 页尾, 占8字节，存储页面的校验信息<br></code></pre></td></tr></table></figure></li>
<li><p>索引B+树</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 顺序保证</span><br><span class="hljs-bullet">  -</span> 物理有序: 数组，二分查找, 支持随机读,<br><span class="hljs-bullet">  -</span> 逻辑有序: 链表, 支持随机写,<br><span class="hljs-section"># 插入策略</span><br><span class="hljs-bullet">  -</span> 自由空间链表<br><span class="hljs-bullet">  -</span> 未使用空间<br><span class="hljs-bullet">  -</span> 收缩数据库,解决数据库page碎片<br><span class="hljs-section"># 页内查询</span><br><span class="hljs-bullet">  -</span> 遍历<br><span class="hljs-bullet">  -</span> 二分查找<br><span class="hljs-bullet">  -</span> skip list<br></code></pre></td></tr></table></figure></li>
<li><p>InnoDB内存管理</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml">-<span class="ruby"> 预分配内存空间:</span><br><span class="ruby"></span>  -<span class="ruby"> Buffer Pool(预分配内存池)<span class="hljs-symbol">:</span>页面加载单位Page</span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">Page:</span> Buffer Pool 的最小单位</span><br><span class="ruby"></span>  -<span class="ruby"> Free <span class="hljs-symbol">List:</span> 空闲Page组成的链表</span><br><span class="ruby"></span>  -<span class="ruby"> Flush <span class="hljs-symbol">List:</span> 脏页列表</span><br><span class="ruby"></span>  -<span class="ruby"> Page Hash表: 维护内存Page和文件Page的映射关系</span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">LRU:</span> 内存淘汰算法- 释放刷盘</span><br><span class="ruby"></span>      LRU_new: 存储热数据<br>      LRU_old: 存储冷数据<br>      Midpoint:<br>-<span class="ruby"> 数据页面加载单元:</span><br><span class="ruby"></span>  -<span class="ruby"> 磁盘数据到内存</span><br><span class="ruby"></span>-<span class="ruby"> 数据内外存交换:</span><br><span class="ruby"></span>-<span class="ruby"> 内存管理的技术点:</span><br><span class="ruby"></span>  -<span class="ruby"> 内存池</span><br><span class="ruby"></span>  -<span class="ruby"> 内存页面管理</span><br><span class="ruby"></span>    -<span class="ruby"> 空闲页</span><br><span class="ruby"></span>    -<span class="ruby"> 数据页</span><br><span class="ruby"></span>    -<span class="ruby"> 脏页: 数据被Update 需要刷盘</span><br><span class="ruby"></span>    -<span class="ruby"> 页面映射</span><br><span class="ruby"></span>    -<span class="ruby"> 页面数据管理</span><br><span class="ruby"></span>  -<span class="ruby"> 数据淘汰:</span><br><span class="ruby"></span>    -<span class="ruby"> <span class="hljs-symbol">LRU:</span> 最经常被访问的数据放在表头，默认删除表尾</span><br><span class="ruby"></span>    -<span class="ruby"> <span class="hljs-symbol">LFU:</span> 使用频率淘汰算法, Redis 使用使用LFU淘汰算法</span><br><span class="ruby"></span>    -<span class="ruby"> 双<span class="hljs-symbol">LRU:</span> 热表LRU，冷表LRU</span><br><span class="ruby"></span>    -<span class="ruby"> 全表扫描对内存的影响?</span><br><span class="ruby"></span>      &gt; 导致热数据被替换, 缓冲区被污染，导致数据库性能下降<br>    -<span class="ruby"> 避免全表扫描对热数据的影响</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="MySQL-锁实现原理"><a href="#MySQL-锁实现原理" class="headerlink" title="MySQL 锁实现原理"></a>MySQL 锁实现原理</h2><ul>
<li><p>锁颗粒度</p>
<ul>
<li>行级锁<ul>
<li>作用在索引(聚簇索引、二级索引)行</li>
<li>是否是唯一索引</li>
</ul>
</li>
<li>间隙锁<ul>
<li>解决可重复读模式下的幻读问题</li>
<li>GAP锁不是加载记录上</li>
<li>GAP锁锁住的位置是两条记录之间的GAP</li>
<li>保证两次当前读返回一致的记录</li>
</ul>
</li>
<li>表级锁<ul>
<li>lock tables</li>
<li>元数据锁(meta data lock, MDL)</li>
<li>全表扫描”表锁”</li>
</ul>
</li>
</ul>
</li>
<li><p>类型</p>
<ul>
<li>共享锁S<ul>
<li>读锁，可以同时被多个事务获取，阻止其他事务对记录的修改</li>
</ul>
</li>
<li>排他锁X<ul>
<li>写锁</li>
</ul>
</li>
</ul>
</li>
<li><h2 id="所有当前读加排他锁"><a href="#所有当前读加排他锁" class="headerlink" title="所有当前读加排他锁:"></a>所有当前读加排他锁:</h2></li>
</ul>
<h2 id="数据库索引"><a href="#数据库索引" class="headerlink" title="数据库索引"></a>数据库索引</h2><ul>
<li><p>in, not in, exists, not exists</p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><code class="hljs asciidoc">➜ mysql -h 127.0.0.1 -u chyi -P 13306 -p<br>Enter password:<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection id is 223<br>Server version: 8.0.26-0ubuntu0.20.04.2 (Ubuntu)<br><br>Copyright (c) 2000, 2021, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-emphasis">&#x27;help;&#x27;</span> or <span class="hljs-emphasis">&#x27;\h&#x27;</span> for help. Type <span class="hljs-emphasis">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; use develop;<br>Reading table information for completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br>mysql&gt; DROP TABLE IF EXISTS <span class="hljs-code">`t1`</span>;<br>Query OK, 0 rows affected, 1 warning (0.03 sec)<br><br>mysql&gt; CREATE TABLE <span class="hljs-code">`t1`</span> (<span class="hljs-code">`id`</span> int(11) NOT NULL AUTO_INCREMENT, <span class="hljs-code">`name`</span> varchar(255) DEFAULT NULL, <span class="hljs-code">`addreee`</span> varchar(255) DEFAULT NULL, PRIMARY KEY(<span class="hljs-code">`id`</span>)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br>Query OK, 0 rows affected, 1 warning (0.06 sec)<br><br>mysql&gt; INSERT INTO <span class="hljs-string">`t1` VALUES (&#x27;</span>1001&#x27;, <span class="hljs-emphasis">&#x27;张三&#x27;</span>, <span class="hljs-emphasis">&#x27;北京&#x27;</span>), (<span class="hljs-emphasis">&#x27;1002&#x27;</span>, <span class="hljs-emphasis">&#x27;李四&#x27;</span>, <span class="hljs-emphasis">&#x27;天津&#x27;</span>), (<span class="hljs-emphasis">&#x27;1003&#x27;</span>, <span class="hljs-emphasis">&#x27;王五&#x27;</span>, <span class="hljs-emphasis">&#x27;北京&#x27;</span>), (<span class="hljs-emphasis">&#x27;1004&#x27;</span>, <span class="hljs-emphasis">&#x27;赵六&#x27;</span>, <span class="hljs-emphasis">&#x27;河北&#x27;</span>), (<span class="hljs-emphasis">&#x27;1005&#x27;</span>, <span class="hljs-emphasis">&#x27;杰克&#x27;</span>, <span class="hljs-emphasis">&#x27;河南&#x27;</span>), (<span class="hljs-emphasis">&#x27;1006&#x27;</span>, <span class="hljs-emphasis">&#x27;汤姆&#x27;</span>, <span class="hljs-emphasis">&#x27;河南&#x27;</span>), (<span class="hljs-emphasis">&#x27;1007&#x27;</span>, <span class="hljs-emphasis">&#x27;贝尔&#x27;</span>, <span class="hljs-emphasis">&#x27;上海&#x27;</span>), (<span class="hljs-emphasis">&#x27;1008&#x27;</span>, <span class="hljs-emphasis">&#x27;孙琪&#x27;</span>, <span class="hljs-emphasis">&#x27;北京&#x27;</span>);<br>Query OK, 8 rows affected (0.04 sec)<br>Records: 8  Duplicates: 0  Warnings: 0<br><br><span class="hljs-section">mysql&gt; select * from t1;</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1001 | 张三   | 北京    |<br>| 1002 | 李四   | 天津    |<br>| 1003 | 王五   | 北京    |<br>| 1004 | 赵六   | 河北    |<br>| 1005 | 杰克   | 河南    |<br>| 1006 | 汤姆   | 河南    |<br>| 1007 | 贝尔   | 上海    |<br><span class="hljs-section">| 1008 | 孙琪   | 北京    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>8 rows in set (0.04 sec)<br><br>mysql&gt; DROP TABLE IF EXISTS <span class="hljs-code">`t2`</span>;<br>Query OK, 0 rows affected (0.05 sec)<br><br>mysql&gt; CREATE TABLE <span class="hljs-code">`t2`</span> (<span class="hljs-code">`id`</span> int(11) NOT NULL AUTO_INCREMENT, <span class="hljs-code">`name`</span> varchar(255), <span class="hljs-code">`address`</span> varchar(255), PRIMARY KEY(<span class="hljs-code">`id`</span>)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br>Query OK, 0 rows affected, 1 warning (0.06 sec)<br><br>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1001, &#x27;</span>张三<span class="hljs-emphasis">&#x27;, &#x27;</span>北京<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1004, &#x27;</span>赵六<span class="hljs-emphasis">&#x27;, &#x27;</span>河北<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.05 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1005, &#x27;</span>杰克<span class="hljs-emphasis">&#x27;, &#x27;</span>河南<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1007, &#x27;</span>贝尔<span class="hljs-emphasis">&#x27;, &#x27;</span>上海<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.03 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1008, &#x27;</span>孙琪<span class="hljs-emphasis">&#x27;, &#x27;</span>北京<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1009, &#x27;</span>曹操<span class="hljs-emphasis">&#x27;, &#x27;</span>魏国<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1010, &#x27;</span>刘备<span class="hljs-emphasis">&#x27;, &#x27;</span>蜀国<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1011, &#x27;</span>孙权<span class="hljs-emphasis">&#x27;, &#x27;</span>吴国<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1012, &#x27;</span>诸葛亮<span class="hljs-emphasis">&#x27;, &#x27;</span>蜀国<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1013, &#x27;</span>典韦<span class="hljs-emphasis">&#x27;, &#x27;</span>魏国<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.04 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span><span class="hljs-section">mysql&gt; select * FROM t1 where name not in (select name from t2);</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1002 | 李四   | 天津    |<br>| 1003 | 王五   | 北京    |<br><span class="hljs-section">| 1006 | 汤姆   | 河南    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>3 rows in set (0.04 sec)<br><br><span class="hljs-section">mysql&gt; select * from t1 where not exists (select name from t2 where t1.name = t2.name);</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1002 | 李四   | 天津    |<br>| 1003 | 王五   | 北京    |<br><span class="hljs-section">| 1006 | 汤姆   | 河南    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>3 rows in set (0.04 sec)<br><br>mysql&gt; INSERT INTO <span class="hljs-string">`t2` VALUES (1014, NULL, &#x27;</span>魏国<span class="hljs-emphasis">&#x27;);</span><br><span class="hljs-emphasis">Query OK, 1 row affected (0.05 sec)</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis"></span># not in 需要保证自查询的匹配字段是非空的<br>mysql&gt; select * FROM t1 where name not in (select name from t2);<br>Empty set (0.04 sec)<br><br># exists 返回的结果是一个boolean值 true或者false,而不关心某个结果集<br><span class="hljs-section">mysql&gt; select * from t1 where not exists (select name from t2 where t1.name = t2.name);</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1002 | 李四   | 天津    |<br>| 1003 | 王五   | 北京    |<br><span class="hljs-section">| 1006 | 汤姆   | 河南    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>3 rows in set (0.04 sec)<br><br># 自查询中name可以修改为其他任意的字段,执行效率上1&gt;column&gt;*<br><span class="hljs-section">mysql&gt; select * from t1 where not exists (select 1 from t2 where t1.name = t2.name);</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1002 | 李四   | 天津    |<br>| 1003 | 王五   | 北京    |<br><span class="hljs-section">| 1006 | 汤姆   | 河南    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>3 rows in set (0.04 sec)<br><br># in, exists 执行流程<br># 对于in查询来说，会先执行子查询，然后把查询得到的结果和外表t1做笛卡尔，通过条件进行筛选(name是否相等)<br><span class="hljs-section">mysql&gt; select * from t1 where name in (select name from t2);</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1001 | 张三   | 北京    |<br>| 1004 | 赵六   | 河北    |<br>| 1005 | 杰克   | 河南    |<br>| 1007 | 贝尔   | 上海    |<br><span class="hljs-section">| 1008 | 孙琪   | 北京    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>5 rows in set (0.04 sec)<br><br># exists,先查询便利外表t1,然后每次遍历时，在检查内标是否符合匹配条件<br><span class="hljs-section">mysql&gt; select * from t1 where exists (select 1 from t2 where t1.name = t2.name);</span><br><span class="hljs-section">+------+--------+---------+</span><br><span class="hljs-section">| id   | name   | addreee |</span><br><span class="hljs-section">+------+--------+---------+</span><br>| 1001 | 张三   | 北京    |<br>| 1004 | 赵六   | 河北    |<br>| 1005 | 杰克   | 河南    |<br>| 1007 | 贝尔   | 上海    |<br><span class="hljs-section">| 1008 | 孙琪   | 北京    |</span><br><span class="hljs-section">+------+--------+---------+</span><br>5 rows in set (0.03 sec)<br><br># 当 in 值多了之后，就不走索引了; 推测MySQL对in查询的成本优化器CBO<br><span class="hljs-section">mysql&gt; explain select * from t1 where id in (1001, 1002, 1003, 1004, 1005, 1006, 1007);</span><br><span class="hljs-section">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span><br><span class="hljs-section">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |</span><br><span class="hljs-section">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span><br><span class="hljs-section">|  1 | SIMPLE      | t1    | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL |    7 |   100.00 | Using where |</span><br><span class="hljs-section">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span><br>1 row in set, 1 warning (0.03 sec)<br><br><br><span class="hljs-section">mysql&gt; explain select * from t1 where id in (1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010);</span><br><span class="hljs-section">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="hljs-section">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="hljs-section">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="hljs-section">|  1 | SIMPLE      | t1    | NULL       | ALL  | PRIMARY       | NULL | NULL    | NULL |    8 |   100.00 | Using where |</span><br><span class="hljs-section">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br>1 row in set, 1 warning (0.03 sec)<br><br># 如果查询的两个表大小相当，用in和exist差别不大，如果两个表中一个较小一个较大，则子查询表大的用exists,子查询表小的用in.<br><br><span class="hljs-section">mysql&gt; explain select * from t1 where id in (select id from t2);</span><br><span class="hljs-section">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------------+</span><br><span class="hljs-section">| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref           | rows | filtered | Extra       |</span><br><span class="hljs-section">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------------+</span><br>|  1 | SIMPLE      | t1    | NULL       | ALL    | PRIMARY       | NULL    | NULL    | NULL          |    8 |   100.00 | NULL        |<br><span class="hljs-section">|  1 | SIMPLE      | t2    | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | develop.t1.id |    1 |   100.00 | Using index |</span><br><span class="hljs-section">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------------+</span><br>2 rows in set, 1 warning (0.05 sec)<br><br># 本意显示警告信息，但是和explain使用，会显示优化后的sql<br><span class="hljs-section">mysql&gt; show warnings;</span><br><span class="hljs-section">+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="hljs-section">| Level | Code | Message                                                                                                                                                                                                           |</span><br><span class="hljs-section">+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="hljs-section">| Note  | 1003 | /* select#1 */ select `develop`.`t1`.`id` AS `id`,`develop`.`t1`.`name` AS `name`,`develop`.`t1`.`addreee` AS `addreee` from `develop`.`t2` join `develop`.`t1` where (`develop`.`t2`.`id` = `develop`.`t1`.`id`) |</span><br><span class="hljs-section">+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br>1 row in set (0.04 sec)<br><br># 外层大表内存小表，用in, 外层小表内层大表，in和exists效率差不多.<br></code></pre></td></tr></table></figure></li>
<li><p>join 嵌套循环 Nested-Loop Join</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><code class="hljs oxygene"><span class="hljs-number">1</span>. 简单嵌套循环连接 Simple <span class="hljs-keyword">Nested</span>-<span class="hljs-keyword">Loop</span> <span class="hljs-keyword">Join</span><br>  inner <span class="hljs-keyword">join</span> - 内连接 双层循环遍历两张表<br>  一般sql中会以小表作为驱动表，外层循环，内层循环作为被驱动表<br><span class="hljs-number">2</span>. 索引嵌套循环连接<br>  内存表列要有索引<br><span class="hljs-number">3</span>. 快索引嵌套连接 <span class="hljs-keyword">Block</span> <span class="hljs-keyword">Nested</span> <span class="hljs-keyword">Loop</span> <span class="hljs-keyword">Join</span><br>  &gt; 缓存外层表的数据到<span class="hljs-keyword">join</span> buffer中，然后buffer中数据批量和内层表数据进行匹配，从而减少内存循环的次数<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>Redis Tips &amp; Tracks</title>
    <url>/2021/09/02/Redis-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><blockquote>
<p>Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache, and message broker.</p>
</blockquote>
<span id="more"></span>

<h2 id="Redis知识的全景图"><a href="#Redis知识的全景图" class="headerlink" title="Redis知识的全景图"></a>Redis知识的全景图</h2><p><img src="/misc/images/redis-knowledge.jpg" alt="Redis 知识全景图"></p>
<ul>
<li>应用纬度:<ul>
<li>缓存应用<ul>
<li>内嵌Key过期机制和淘汰策略</li>
</ul>
</li>
<li>集群应用<ul>
<li>主从集群、切片集群</li>
</ul>
</li>
<li>数据结构应用<ul>
<li>String</li>
<li>Hash</li>
<li>List</li>
<li>Set</li>
<li>Sorted Set</li>
</ul>
</li>
</ul>
</li>
<li>系统纬度:<ul>
<li>处理层:<ul>
<li>线程模型</li>
</ul>
</li>
<li>内存层:<ul>
<li>数据结构</li>
</ul>
</li>
<li>存储层:<ul>
<li>AOF</li>
<li>RDB</li>
</ul>
</li>
<li>网络层:<ul>
<li>epool网络框架</li>
</ul>
</li>
</ul>
</li>
<li>高性能主线:<ul>
<li>线程模型</li>
<li>数据结构<ul>
<li>集合类型采用有序索引，可以支持范围操作</li>
<li>考虑不同数据结构的内存效率、设计了压缩列表、整数数组这些精简的底层数据结构、节省内存开销</li>
</ul>
</li>
<li>内存分配器<ul>
<li>jemalloc和tcmalloc比glibc效率高</li>
</ul>
</li>
<li>持久化<ul>
<li>支持RDB、AOF持久化数据，支持主从库集群</li>
</ul>
</li>
<li>网络框架</li>
</ul>
</li>
<li>高可用主线:<ul>
<li>主从复制</li>
<li>哨兵机制</li>
<li>切片集群</li>
</ul>
</li>
<li>高扩展主线:<ul>
<li>数据分片</li>
<li>负载均衡</li>
</ul>
</li>
</ul>
<h2 id="Redis问题画像图"><a href="#Redis问题画像图" class="headerlink" title="Redis问题画像图"></a>Redis问题画像图</h2><p><img src="/misc/images/redis-problems.jpeg" alt="Redis问题画像"></p>
<h2 id="Redis-基础"><a href="#Redis-基础" class="headerlink" title="Redis 基础"></a>Redis 基础</h2><ul>
<li><p>基础架构</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml"># 数据模型: key-value<br>  &gt; Redis能够在实际业务场景中广泛的应用，就是得益于支持多样化类型的value<br><br># 操作接口:<br>  -<span class="ruby"> <span class="hljs-symbol">PUT:</span></span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">GET:</span></span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">DELETE:</span></span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">SCAN:</span></span><br><span class="ruby"></span><br># 访问框架:<br>  -<span class="ruby"> 动态库访问</span><br><span class="ruby"></span>  -<span class="ruby"> 网络框架访问<span class="hljs-symbol">:</span>包括Socket Server和协议解析</span><br><span class="ruby"></span># 操作模块:<br>  -<span class="ruby"> Redis 键-值映射数据类型</span><br><span class="ruby"></span>    -<span class="ruby"> 哈希表: 就是一个数组，数组的每个元素netry称为一个哈希桶(桶中元素存储的是指向key和value的指针).</span><br><span class="ruby"></span>      -<span class="ruby"> O(<span class="hljs-number">1</span>)时间复杂度快速查找键值对</span><br><span class="ruby"></span>      -<span class="ruby"> 哈希表冲突问题</span><br><span class="ruby"></span>        -<span class="ruby"> Redis解决哈希冲突使用链式哈希,指向同一个哈希桶中的多个元素用链表保存，之间依次用指针连接</span><br><span class="ruby"></span>      -<span class="ruby"> Rehash操作:</span><br><span class="ruby"></span>        -<span class="ruby"> 装载因子 load factor = 所有entry个数/哈希表的哈希桶个数</span><br><span class="ruby"></span>        -<span class="ruby"> rehash操作就是增加现有哈希桶数量，让增多的entry元素能在更多的桶之间分散保存，减少单个桶中元素数量,从而减少单个桶中冲突</span><br><span class="ruby"></span>        -<span class="ruby"> Redis默认采用两个全局哈希表,哈希表<span class="hljs-number">1</span>，哈希表<span class="hljs-number">2</span>, Rehash过程:</span><br><span class="ruby"></span>          -<span class="ruby"> hash2分配更大空间 <span class="hljs-number">2</span> * hash1</span><br><span class="ruby"></span>          -<span class="ruby"> 将hash1中数据重新映射并拷贝到hash2</span><br><span class="ruby"></span>          -<span class="ruby"> 释放hash1空间</span><br><span class="ruby"></span>        -<span class="ruby"> 渐进式<span class="hljs-symbol">rehash:</span></span><br><span class="ruby"></span>          -<span class="ruby"> 巧妙的把一次性大量拷贝的开销分摊到多次处理请求的过程中，避免耗时操作，保证数据的快速访问</span><br><span class="ruby"></span><br>  -<span class="ruby"> Redis值的数据类型:</span><br><span class="ruby"></span>    -<span class="ruby"> 字符串<span class="hljs-symbol">String:</span></span><br><span class="ruby"></span>      -<span class="ruby"> 底层数据类型:</span><br><span class="ruby"></span>        -<span class="ruby"> 简单动态字符串</span><br><span class="ruby"></span>    -<span class="ruby"> 列表List</span><br><span class="ruby"></span>      -<span class="ruby"> 底层数据类型:</span><br><span class="ruby"></span>        -<span class="ruby"> 双向链表</span><br><span class="ruby"></span>        -<span class="ruby"> 压缩列表</span><br><span class="ruby"></span>    -<span class="ruby"> 集合Set</span><br><span class="ruby"></span>      -<span class="ruby"> 底层数据类型</span><br><span class="ruby"></span>        -<span class="ruby"> 压缩列表</span><br><span class="ruby"></span>        -<span class="ruby"> 整数数组</span><br><span class="ruby"></span>    -<span class="ruby"> 有序集合Sorted Set</span><br><span class="ruby"></span>      -<span class="ruby"> 底层数据类型</span><br><span class="ruby"></span>        -<span class="ruby"> 压缩列表</span><br><span class="ruby"></span>        -<span class="ruby"> 跳表</span><br><span class="ruby"></span>    -<span class="ruby"> 哈希Hash</span><br><span class="ruby"></span>      -<span class="ruby"> 底层数据类型</span><br><span class="ruby"></span>        -<span class="ruby"> 压缩列表</span><br><span class="ruby"></span>        -<span class="ruby"> 哈希表</span><br><span class="ruby"></span>  -<span class="ruby"> Redis底层数据结构</span><br><span class="ruby"></span>    &gt; Redis之所以采用不同的数据结构，是在性能和内存使用效率之间进行平衡<br>    -<span class="ruby"> 简单动态字符串</span><br><span class="ruby"></span>    -<span class="ruby"> 双向链表</span><br><span class="ruby"></span>    -<span class="ruby"> 压缩列表<span class="hljs-symbol">:</span>类似数组</span><br><span class="ruby"></span>      -<span class="ruby"> 表头:</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-symbol">zlbytes:</span> 列表长度</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-symbol">zltail:</span> 列表尾的偏移量</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-symbol">zllen:</span> 列表中entry个数</span><br><span class="ruby"></span>      -<span class="ruby"> 表尾:</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-symbol">zlend:</span> 表示结束</span><br><span class="ruby"></span>    -<span class="ruby"> 哈希表</span><br><span class="ruby"></span>    -<span class="ruby"> 跳表: 跳表在链表的基础上增加多级索引，通过索引位置的几个跳转，实现数据的快速定位</span><br><span class="ruby"></span>      -<span class="ruby"> 查找复杂度O(logN)</span><br><span class="ruby"></span>    -<span class="ruby"> 整数数组</span><br><span class="ruby"></span><br># 索引模块:<br>  -<span class="ruby"> 索引的作用是让键值数据库根据Key找到响应value的存储位置，进而执行操作</span><br><span class="ruby"></span>  -<span class="ruby"> 哈希表: redis, mamcached采用</span><br><span class="ruby"></span>    -<span class="ruby"> 内存的高性能随机访问可以很好与哈希表O(<span class="hljs-number">1</span>)操作复杂度相匹配</span><br><span class="ruby"></span>  -<span class="ruby"> B+树</span><br><span class="ruby"></span>  -<span class="ruby"> 字典树</span><br><span class="ruby"></span>  -<span class="ruby"> skip <span class="hljs-symbol">list:</span> RocksDB采用</span><br><span class="ruby"></span># 存储模块:<br>  -<span class="ruby"> 内存分配器</span><br><span class="ruby"></span>    -<span class="ruby"> <span class="hljs-symbol">glibc:</span> malloc/free</span><br><span class="ruby"></span>  -<span class="ruby"> 持久化</span><br><span class="ruby"></span>    -<span class="ruby"> 日志AOF</span><br><span class="ruby"></span>    -<span class="ruby"> 快照RDB</span><br><span class="ruby"></span># IO模型设计<br>  &gt; Redis单线程是指网络IO和键值对读写是由一个线程完成. 其他功能持久化、异步删除、集群数据同步是由额外的线程执行.<br>  -<span class="ruby"> 多线程编程模式:</span><br><span class="ruby"></span>    -<span class="ruby"> 面临共享资源的并发访问控制问题</span><br><span class="ruby"></span>    -<span class="ruby"> 采用多线程开发会引入同步原语来保护共享资源的并发访问</span><br><span class="ruby"></span>  -<span class="ruby"> 单线程编程模式:</span><br><span class="ruby"></span>    -<span class="ruby"> Redis基本IO模型中，主要是主线程在执行操作，任何耗时的操作，bigkey、全量返回等操作，都是潜在的性能瓶颈</span><br></code></pre></td></tr></table></figure></li>
<li><p>Socker网络模型</p>
<table>
<thead>
<tr>
<th align="left">调用方法</th>
<th align="left">返回套接字类型</th>
<th align="left">非阻塞模式</th>
<th align="left">效果</th>
</tr>
</thead>
<tbody><tr>
<td align="left">socket()</td>
<td align="left">主动套接字</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">listen()</td>
<td align="left">监听套接字</td>
<td align="left">可设置</td>
<td align="left">accept()非阻塞</td>
</tr>
<tr>
<td align="left">accept()</td>
<td align="left">已连接套接字</td>
<td align="left">可设置</td>
<td align="left">send()/recv()非阻塞</td>
</tr>
</tbody></table>
</li>
<li><p>Redis多路复用IO模型<br><img src="/misc/images/redis-epoll.jpg" alt="基于多路复用的Redis高性能IO模型"></p>
<blockquote>
<p>一个线程处理多个IO流.该机制允许内核中同时存在多个监听套接字和已连接套接字.<br>select/epoll提供基于事件的回调机制，针对不同事件的发生，调用响应的处理函数</p>
</blockquote>
</li>
<li><p>底层数据结构时间复杂度分类</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td align="left">哈希表</td>
<td align="left">O(1)</td>
</tr>
<tr>
<td align="left">跳表</td>
<td align="left">O(logN)</td>
</tr>
<tr>
<td align="left">双向链表</td>
<td align="left">O(N)</td>
</tr>
<tr>
<td align="left">压缩列表</td>
<td align="left">O(N)</td>
</tr>
<tr>
<td align="left">整数数组</td>
<td align="left">O(N)</td>
</tr>
</tbody></table>
<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 单元素操作是基础</span><br><span class="hljs-meta"># 范围操作非常耗时</span><br>  - 范围操作是指集合类型中的遍历操作: O(N)<br>  - SCAN操作实现渐进式遍历，只返回有限数量的数据.<br><span class="hljs-meta"># 统计操作通常高校</span><br>  压缩列表和双向链表都会记录表头和表尾的偏移量<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><ul>
<li>通信协议<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">redis客户端和服务器发送的命令和数据一律以\r\n (CR LF)结尾<br><br><span class="hljs-comment"># 请求协议:</span><br>  *&lt;参数数量&gt; CR LF<br>  $&lt;参数的字节数量&gt; CR LF<br>  &lt;参数的数据&gt; CR LF<br><br>  ubuntu <span class="hljs-keyword">in</span> /  at 3BPlus took 11s<br>  ➜ tail appendonly.aof<br>  <span class="hljs-number">*3</span>        - 表示当前命令有单个部分<br>  <span class="hljs-variable">$3</span>        - 字节数<br>  <span class="hljs-builtin-name">set</span><br>  <span class="hljs-variable">$4</span><br>  name<br>  <span class="hljs-variable">$10</span><br>  chyiyaqing<br><br><span class="hljs-comment"># 回复协议:</span><br>  &gt; 在回复协议中，可以通过检查第一个字节，确定这个回复是什么类型<br>  - 状态回复 (status reply) 第一个字节是 <span class="hljs-string">&quot;+&quot;</span><br>  - 错误回复 (<span class="hljs-builtin-name">error</span> reply) 第一个字节是 <span class="hljs-string">&quot;-&quot;</span><br>  - 整数回复 (integer reply) 第一个字节是 <span class="hljs-string">&quot;.&quot;</span><br>  - 批量回复 (bulk reply) 第一个字节是 <span class="hljs-string">&quot;$&quot;</span><br>  - 多条批量回复 (multi bulk reply) 第一个字节是 <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><blockquote>
<p>Redis 持久化主要两大机制: AOF (Append Only File) 日志和RDB 快照</p>
</blockquote>
<ul>
<li><p>AOF - Append Only File</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">AOF日志是Redis执行完命令，把数据写入内存，然后才记录日志,避免出现记录错误命令的情况,记录的是Redis收到的每一条命令, 这些命令以文本形式保存</span><br></code></pre></td></tr></table></figure>
<ul>
<li>AOF 潜在的风险<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> 执行完命令还没有来得及记日志就宕机，这个命令和相关的数据有丢失的风险?<br><span class="hljs-bullet">-</span> AOF写日志在主线程中执行，如果磁盘写压力过大，就会导致写盘很慢，进而导致后续的操作无法执行<br><span class="hljs-section"># 写回磁盘策略 appendfsync</span><br><span class="hljs-bullet">  1.</span> Always: 同步写回, 每个写命令执行完，立马同步将日志写回磁盘<br><span class="hljs-code">    &gt; 落盘操作属于慢速，回影响主线程性能</span><br><span class="hljs-code">  2. Everysec: 每秒写回,每个写命令执行完，先把日志写到AOF文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘</span><br><span class="hljs-code">    &gt; 在避免影响主线程和避免数据丢失两者之间trade-off方式</span><br><span class="hljs-code">  3. No: 操作系统控制写回，每个写命令执行完，只是先把日志写到AOF文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span><br><span class="hljs-code">    &gt; 落盘时机交给操作系统，只要AOF记录没有写回磁盘，宕机对应的数据就丢失</span><br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">写回时机</th>
<th align="left">优点</th>
<th align="left">缺点</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Always</td>
<td align="left">同步写回</td>
<td align="left">可靠性高，数据基本不丢失</td>
<td align="left">每个写命令都要落盘，性能影响较大</td>
</tr>
<tr>
<td align="left">EverySec</td>
<td align="left">每秒写回</td>
<td align="left">性能适中</td>
<td align="left">宕机时丢失1秒内的数据</td>
</tr>
<tr>
<td align="left">No</td>
<td align="left">操作系统控制写回</td>
<td align="left">性能好</td>
<td align="left">宕机丢失数据较多</td>
</tr>
</tbody></table>
</li>
<li>AOF文件过大的性能问题<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 文件系统本身对文件大小有限制，无法保存过大的文件<br><span class="hljs-bullet">2.</span> 文件过大，追加命令记录效率变低<br><span class="hljs-bullet">3.</span> 发生宕机，AOF记录命令要被重新执行，故障恢复比较缓慢，会影响Redis正常使用<br></code></pre></td></tr></table></figure></li>
<li>AOF重写机制:<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown">直接根据数据库中数据的最新状态，生成这些数据的插入命令<br><span class="hljs-quote">&gt; 重写机制可以将旧日志文件中的多条命令，在重写后的新日志中变成一条命令</span><br><span class="hljs-quote">&gt; AOF重写过程是由后台子进程bgrewriteaof完成，避免阻塞主线程，导致性能下降</span><br><span class="hljs-bullet">-</span> &quot;一个拷贝，两处日志&quot;<br><span class="hljs-bullet">  -</span> 一个拷贝: 每次执行重写时，主线程fork出后台的bgrewriteaof子进程，此时，fork会把主线程的内存拷贝一份给bgrewriteaof子进程，然后bgrewriteaof子进程在不影响主线程的情况下，逐一把拷贝的数据写成操作，记入重写日志.<br><span class="hljs-bullet">  -</span> 两处日志: 一个是正在使用的AOF日志，Redis会把操作写到它的缓冲区，第二处日志是新的AOF重写日志，等到拷贝数据的所有操作记录重写完成后，重写日志记录的操作也会写入新的AOF文件，保证数据库最新状态的记录<br></code></pre></td></tr></table></figure>
<img src="/misc/images/bgrewriteaof.jpg" alt="AOF非阻塞重写过程"></li>
</ul>
</li>
<li><p>RDB(Redis DataBase) - 内存快照</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">内存快照：指内存中的数据在某一个时刻的状态记录</span><br></code></pre></td></tr></table></figure>
<ul>
<li>Redis两种命令生成RDB文件<ul>
<li>save: 在主线程执行，会导致阻塞</li>
<li>bgsave: 创建子进程，专门用于写入RDB文件，避免主线程阻塞, 默认配置<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; bgsave子进程由主线程fork生成，共享主线程的所有内存数据，bgsave子进程运行后，开始读取主线程的内存数据，并把数据写入RDB文件</span><br><span class="hljs-bullet">  1.</span> 频繁将全量数据写入磁盘，会给磁盘带来很大压力.<br><span class="hljs-bullet">  2.</span> bgsave子进程需要fork操作从主线程创建出来, fork操作会阻塞主线程<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>COW - Copy-On-Write<br><img src="/misc/images/redis-cow.jpg" alt="写时复制机制"><figure class="highlight erlang"><table><tr><td class="code"><pre><code class="hljs erlang">写时复制技术具体来说，主线程在有写操作时，才会把这个新写或者修改的数据写入到新的物理地址,并修改自己的页表映射.<br>保证快照的完整性，也允许主线程同时对数据进行修改，避免对正常业务的影响<br></code></pre></td></tr></table></figure></li>
<li>Redis 4.0 混合AOF+RDB<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 增量快照:</span><br><span class="hljs-quote">&gt; 做一次全量快照后，后续的快照支队修改的数据进行快照记录，可以避免每次全量快照的开销</span><br><br><span class="hljs-section"># 混合使用AOF日志和内存快照</span><br><span class="hljs-quote">&gt; 内存快照以一定的频率执行，两次快照之间，使用AOF日志记录这期间的所有命令操作</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h2><ul>
<li>Redis 主从库模式<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; 主从库采用读写分离方式</span><br><span class="hljs-bullet">  -</span> 读操作: 主库、从库都可以接收<br><span class="hljs-bullet">  -</span> 写操作: 首先到主库执行，然后，主库将写操作同步给从库<br></code></pre></td></tr></table></figure>
<ul>
<li>主从库如何进行第一次同步?<br><img src="/misc/images/master-slave-sync.jpg" alt="主从库第一次同步流程"><figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 三个阶段</span><br><span class="hljs-bullet">  1.</span> 第一阶段: 建立连接、协商同步<br><span class="hljs-bullet">    -</span> psync ? -1<br><span class="hljs-bullet">    -</span> runID: Redis实例自动生成的随机ID<br><span class="hljs-bullet">    -</span> offset: 复制的偏移量<br><span class="hljs-bullet">    -</span> FULLRESYNC: 表示第一次复制采用全量复制，主库会把当前所有的数据都复制给从库<br><span class="hljs-bullet">  2.</span> 第二阶段: 主库同步数据给从库<br><span class="hljs-bullet">    -</span> 主库将所有数据同步给从库,从库收到数据后，在本地完成数据加载<br><span class="hljs-bullet">    -</span> replication buffer: 主从库在进行全量复制时，主库上用于和从库连接的客户端buffer<br><span class="hljs-bullet">  3.</span> 第三阶段: 主库发送新写命令给从库<br><span class="hljs-bullet">    -</span> 主库把replication buffer 操作发给从库<br><span class="hljs-bullet">    -</span> 主库会给每个从库建立一个客户端，所以replication buffer不是共享的，而是每个从库都有一个对应的客户端<br><br><span class="hljs-section"># 主从库复制采用RDB,不采用AOF?</span><br><span class="hljs-bullet">  1.</span> RDB 文件是二进制文件，无论要把RDB写入磁盘还是通过网络传输RDB，IO效率比记录的纯文本AOF高<br><span class="hljs-bullet">  2.</span> 在从库进行恢复时，用RDB的恢复效率比AOF高<br></code></pre></td></tr></table></figure></li>
<li>主 - 从 - 从<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">通过“主-从-从”模式将主库生成RDB和传输RDB的压力，以级联的方式分散到从库中</span><br></code></pre></td></tr></table></figure></li>
<li>基于长连接的命令传播<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># repl_backlog_size:</span><br><span class="hljs-meta"># repl_backlog_buffer: 为了支持从库增量复制，主库上用于持续保持写操作的一块专用buffer, 所有从库共享</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>哨兵机制<br><img src="/misc/images/redis-sentinel.jpg" alt="哨兵机制任务"><figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml">  &gt; Redis主从集群中，哨兵机制实现主从库自动切换, 解决主从复制模式下故障转移<br>  # 哨兵集群:<br>    &gt; 采用多实例组成的集群模式进行部署, 引入多哨兵判断避免单个哨兵自身网络状态不好，误判主库下线<br>    &gt; N个哨兵实例，最好要有N/2+1实例判断主库为&quot;主观下线&quot;, 最终判定主库为“客观下线”<br><br>  # 哨兵负责的任务:<br>    -<span class="ruby"> 监控</span><br><span class="ruby"></span>      -<span class="ruby"> 周期性向所有的主从库发送PING命令</span><br><span class="ruby"></span>      -<span class="ruby"> 哨兵对主库下线判断:</span><br><span class="ruby"></span>        -<span class="ruby"> 主观下线: 哨兵进程使用PING命令检测自己和主、从库的网络连接情况，判断实例的状态</span><br><span class="ruby"></span>          -<span class="ruby"> 误判: 发生在集群网络压力较大、网络拥赛，或者主库本身压力较大</span><br><span class="ruby"></span>        -<span class="ruby"> 客观下线:</span><br><span class="ruby"></span>    -<span class="ruby"> 选主</span><br><span class="ruby"></span>      -<span class="ruby"> 主库挂了之后，哨兵需要从很多从库中选择一个从库实例</span><br><span class="ruby"></span>      -<span class="ruby"> <span class="hljs-string">&quot;筛选&quot;</span> + <span class="hljs-string">&quot;打分&quot;</span>:</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-string">&quot;筛选&quot;</span>: 检查从库的当前在线状态，判断网络连接状态</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-string">&quot;打分&quot;</span>: 从库优先级、从库复制进度以及从库ID号</span><br><span class="ruby"></span>          -<span class="ruby"> replica-priority <span class="hljs-number">100</span></span><br><span class="ruby"></span>    -<span class="ruby"> 通知</span><br><span class="ruby"></span>      -<span class="ruby"> 哨兵会把新主库的连接信息发给其他从库，让他们执行replicaof命令，和新主库建立连接，并进行数据复制,同时哨兵把新主库的连接信息通知给客户端，请求操作发到新主库上.</span><br><span class="ruby"></span><br># 基于pub/sub 机制的哨兵集群<br>  &gt; 哨兵只要和主库建立连接，就可以在主库上发布消息，比如发布自己的连接信息(IP和端口),从主库上订阅消息，获取其他哨兵发布的连接信息<br><br>  -<span class="ruby"> 哨兵获取从库的IP+端口</span><br><span class="ruby"></span>    -<span class="ruby"> 哨兵向主库发送INFO命令,查看从库列表,进而与从库建立连接</span><br><span class="ruby"></span>  -<span class="ruby"> pub/sub客户端事件通知</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Redis切片集群"><a href="#Redis切片集群" class="headerlink" title="Redis切片集群"></a>Redis切片集群</h2>  <figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">切片集群(分片集群)可以保存大量数据，对Redis主线程阻塞影响较小</span><br></code></pre></td></tr></table></figure>
<ul>
<li>纵向扩展(scale up):</li>
<li>横向扩展(scale out):<ul>
<li>Redis Cluster:<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala">&gt; Redis Cluster 采用哈希槽(Hash Slot)处理数据和实例之间的映射关系. <span class="hljs-number">2</span>^<span class="hljs-number">14</span><br><br><span class="hljs-meta"># key映射哈希slot</span><br>  <span class="hljs-number">1.</span> 根据键值key，按照CRC16算法计算<span class="hljs-number">16</span>-bit值，然后对<span class="hljs-number">16384</span>取模,每个摸数代表响应编号的哈希槽。<br><br><span class="hljs-meta"># 重定向机制</span><br>  &gt; 客户端给一个实例发送数据读写操作时，这个实例上并没有相应的数据，客户端要再给一个新实例发送操作命令<br>  <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; <span class="hljs-keyword">get</span> name<br>  -&gt; Redirected to slot [<span class="hljs-number">5798</span>] located at <span class="hljs-number">172.30</span><span class="hljs-number">.1</span><span class="hljs-number">.23</span>:<span class="hljs-number">6002</span><br>  <span class="hljs-string">&quot;chyiyaqing&quot;</span><br>  <span class="hljs-number">172.30</span><span class="hljs-number">.1</span><span class="hljs-number">.23</span>:<span class="hljs-number">6002</span>&gt;<br><br><span class="hljs-meta"># ASK:</span><br>  ASK命令并不会更新客户端缓存的哈希槽分配信息<br><span class="hljs-meta"># MOVED:</span><br>  更改本地缓存，让后续所有命令都发往新实例<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="Redis-应用场景-消息队列"><a href="#Redis-应用场景-消息队列" class="headerlink" title="Redis 应用场景 - 消息队列"></a>Redis 应用场景 - 消息队列</h2>  <figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 消息队列需要满足的功能:</span><br><br><span class="hljs-bullet">  1.</span> 支持阻塞等待拉取消息<br><span class="hljs-bullet">  2.</span> 支持发布/订阅模式<br><span class="hljs-bullet">  3.</span> 消费失败，可重新消费，消息不丢失<br><span class="hljs-bullet">  4.</span> 实例宕机，消息不丢失、数据可持久化<br><span class="hljs-bullet">  5.</span> 消息可堆积<br></code></pre></td></tr></table></figure>

<ul>
<li><p>List - 队列:</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><code class="hljs accesslog">ubuntu in ~ at 3BPlus<br>➜ redis-cli -c -p <span class="hljs-number">6001</span><br><span class="hljs-number">127.0.0.1:6001</span>&gt; ping<br>PONG<br><span class="hljs-number">127.0.0.1:6001</span>&gt; LPUSH queue msg1    # 增加消息<br>-&gt; Redirected to slot <span class="hljs-string">[13011]</span> located at <span class="hljs-number">172</span>.<span class="hljs-number">30</span>.<span class="hljs-number">1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6003</span><br>(integer) <span class="hljs-number">1</span><br><span class="hljs-number">172.30.1.23:6003</span>&gt; LPUSH queue msg2<br>(integer) <span class="hljs-number">2</span><br><span class="hljs-number">172.30.1.23:6003</span>&gt; RPOP queue        # 拉取消息<br><span class="hljs-string">&quot;msg1&quot;</span><br><span class="hljs-number">172.30.1.23:6003</span>&gt; RPOP queue<br><span class="hljs-string">&quot;msg2&quot;</span><br><span class="hljs-number">127.0.0.1:6001</span>&gt; RPOP queue          # 队列为空，RPOP返回NULL<br>-&gt; Redirected to slot <span class="hljs-string">[13011]</span> located at <span class="hljs-number">172</span>.<span class="hljs-number">30</span>.<span class="hljs-number">1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6003</span><br>(nil)<br><span class="hljs-number">127.0.0.1:6001</span>&gt; BRPOP queue <span class="hljs-number">5</span>       # BRPOP阻塞式拉取消息，支持传入超时时间<br>-&gt; Redirected to slot <span class="hljs-string">[13011]</span> located at <span class="hljs-number">172</span>.<span class="hljs-number">30</span>.<span class="hljs-number">1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6003</span><br>(nil)<br>(<span class="hljs-number">5</span>.00s)<br><span class="hljs-number">172.30.1.23:6003</span>&gt; BRPOP queue <span class="hljs-number">0</span>     # 不设置超时，直到有新消息才返回<br>^C<br><span class="hljs-number">172.30.1.23:6003</span>&gt; exit<br><br>注意: 如果设置超时时间太长，连接太久没有活跃，有可能会被Redis server判定为无效连接，之后Redis Server会强制把这个客户端踢下线，客户端要有重连机制<br><br><span class="hljs-number">1</span>. 不支持重复消费：消费者拉取消息后，该消息就从List中删除，无法被其他消费者在此消费，即不支持多个消费者消费同一批数据<br><span class="hljs-number">2</span>. 消息丢失，消费者拉取到消息后，如果发生异常宕机，这条消息就丢失<br><br># 单机测评<br>ubuntu in ~ at 3BPlus took 37s<br>➜ redis-benchmark -n <span class="hljs-number">1000000</span> -t lpush,rpop -P <span class="hljs-number">16</span> -q -h <span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span> -p <span class="hljs-number">6001</span> --cluster<br>Cluster has <span class="hljs-number">3</span> master nodes:<br><br>Master <span class="hljs-number">0</span>: a733c21d3b735b9d026eb4d462ef6b367d8ebb98 <span class="hljs-number">172</span>.<span class="hljs-number">30</span>.<span class="hljs-number">1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6002</span><br>Master <span class="hljs-number">1</span>: 9c35a4e211f6534861ed768dba592e85539b1377 <span class="hljs-number">172</span>.<span class="hljs-number">30</span>.<span class="hljs-number">1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6003</span><br>Master <span class="hljs-number">2</span>: a901e497cb72819cf0765e9e4eb16c36399c437b <span class="hljs-number">172</span>.<span class="hljs-number">30</span>.<span class="hljs-number">1</span>.<span class="hljs-number">23</span>:<span class="hljs-number">6001</span><br><br>LPUSH: <span class="hljs-number">41529</span>.<span class="hljs-number">96</span> requests per second, p50=<span class="hljs-number">17</span>.<span class="hljs-number">199</span> msec<br>RPOP: <span class="hljs-number">46539</span>.<span class="hljs-number">77</span> requests per second, p50=<span class="hljs-number">15</span>.<span class="hljs-number">463</span> msec<br></code></pre></td></tr></table></figure></li>
<li><p>Pub/Sub - 发布订阅模型</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># 消费者1</span><br>ubuntu <span class="hljs-keyword">in</span> ~ <span class="hljs-keyword">at</span> <span class="hljs-number">3</span>BPlus<br>➜ redis-cli -c -p <span class="hljs-number">6001</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; SUBSCRIBE queue<br>Reading messages... (press Ctrl-C <span class="hljs-keyword">to</span> quit)<br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;subscribe&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue&quot;</span><br><span class="hljs-number">3</span>) (<span class="hljs-built_in">integer</span>) <span class="hljs-number">1</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;message&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;msg1&quot;</span><br><br><span class="hljs-comment"># 消费者2</span><br>ubuntu <span class="hljs-keyword">in</span> ~ <span class="hljs-keyword">at</span> <span class="hljs-number">3</span>BPlus<br>➜ redis-cli -c -p <span class="hljs-number">6001</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; SUBSCRIBE queue<br>Reading messages... (press Ctrl-C <span class="hljs-keyword">to</span> quit)<br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;subscribe&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue&quot;</span><br><span class="hljs-number">3</span>) (<span class="hljs-built_in">integer</span>) <span class="hljs-number">1</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;message&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;msg1&quot;</span><br><br><span class="hljs-comment"># 生产者</span><br>ubuntu <span class="hljs-keyword">in</span> ~ <span class="hljs-keyword">at</span> <span class="hljs-number">3</span>BPlus<br>➜ redis-cli -c -p <span class="hljs-number">6001</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; PUBLISH queue msg1<br>(<span class="hljs-built_in">integer</span>) <span class="hljs-number">2</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; PUBLISH queue msg2<br>(<span class="hljs-built_in">integer</span>) <span class="hljs-number">2</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; <span class="hljs-keyword">exit</span><br><br><span class="hljs-comment"># Pub/Sub 支持阻塞式拉取消息，满足多组消费者，匹配订阅模式,允许消费者订阅多个队列</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; PUBLISH queue.p1 msg1       <span class="hljs-comment">-- 生产者</span><br>(<span class="hljs-built_in">integer</span>) <span class="hljs-number">1</span><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; PUBLISH queue.p2 msg2<br>(<span class="hljs-built_in">integer</span>) <span class="hljs-number">1</span><br><br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6001</span>&gt; PSUBSCRIBE queue.*          <span class="hljs-comment">-- 消费者 匹配订阅</span><br>Reading messages... (press Ctrl-C <span class="hljs-keyword">to</span> quit)<br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;psubscribe&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue.*&quot;</span><br><span class="hljs-number">3</span>) (<span class="hljs-built_in">integer</span>) <span class="hljs-number">1</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;pmessage&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue.*&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;queue.p1&quot;</span><br><span class="hljs-number">4</span>) <span class="hljs-string">&quot;msg1&quot;</span><br><span class="hljs-number">1</span>) <span class="hljs-string">&quot;pmessage&quot;</span><br><span class="hljs-number">2</span>) <span class="hljs-string">&quot;queue.*&quot;</span><br><span class="hljs-number">3</span>) <span class="hljs-string">&quot;queue.p2&quot;</span><br><span class="hljs-number">4</span>) <span class="hljs-string">&quot;msg2&quot;</span><br><br><span class="hljs-comment"># Pub/Sub 实现原理</span><br>&gt; 没有基于任何数据类型，没有做任何数据存储，只是单纯地为生产者、消费者建立数据转发通道，把符合规则的数据，从一端转发到另一端<br>&gt; **在使用Pub/Sub时，消费者必须先订阅队列，生产者才能发布消息，否则消息会丢失**<br>&gt; List属于“拉取模式”, Pub/Sub属于“推模式”<br><br><span class="hljs-comment"># 注意使用Pub/Sub会丢数据</span><br><span class="hljs-number">1.</span> 消费者下线,重新上线，只能接收新的消息，在下线期间生产者发布的消息，因为找不到消费者，会被丢弃掉.<br><span class="hljs-number">2.</span> Redis宕机, Pub/Sub相关操作，不会写入RDB和AOF中，当Redis宕机重启，Pub/Sub的数据会全部丢失<br><span class="hljs-number">3.</span> 消费堆积, 每个消费者订阅一个队列，Redis都会在Server给消费者分配一个【缓冲区】,这个缓冲区其实就是一块内存，当生产者发布消息时，Redis先把消息写到对应消费者的缓冲区,之后消费者不断从缓冲区读取、处理消息, 缓冲区上线,会被强制下线.<br></code></pre></td></tr></table></figure></li>
<li><p>Stream</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># Stream 通过XADD 和 XREAD完成简单的生产、消费模型</span><br>  XADD: 发布消息<br>  XREAD: 读取消息<br><br><span class="hljs-comment"># 生产者发布消息</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6001</span>&gt; XADD <span class="hljs-keyword">queue</span> * name <span class="hljs-number">2021</span>      <span class="hljs-comment"># * 表示自动生成唯一消息ID</span><br>-&gt; Redirected <span class="hljs-keyword">to</span> slot [<span class="hljs-number">13011</span>] located at <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span><br><span class="hljs-string">&quot;1630886765690-0&quot;</span>                           <span class="hljs-comment">#消息ID格式: 时间戳-自增序号</span><br><span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XADD <span class="hljs-keyword">queue</span> * name <span class="hljs-number">09</span>-<span class="hljs-number">06</span><br><span class="hljs-string">&quot;1630886777470-0&quot;</span><br><span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt;<br><br><span class="hljs-comment"># 消费者消费消息</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6001</span>&gt; XREAD COUNT <span class="hljs-number">5</span> STREAMS <span class="hljs-keyword">queue</span> <span class="hljs-number">0</span>-<span class="hljs-number">0</span>   <span class="hljs-comment"># 从开头读取5条消息，0-0表示从开头读取</span><br>-&gt; Redirected <span class="hljs-keyword">to</span> slot [<span class="hljs-number">13011</span>] located at <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span><br><span class="hljs-number">1</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;queue&quot;</span><br>   <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630886765690-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;2021&quot;</span><br>      <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630886777470-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;09-06&quot;</span><br><span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XREAD COUNT <span class="hljs-number">5</span> STREAMS <span class="hljs-keyword">queue</span> <span class="hljs-number">1630886777470</span>-<span class="hljs-number">0</span>  <span class="hljs-comment"># 继续拉取消息,传入上一条消息的ID</span><br><span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XREAD COUNT <span class="hljs-number">5</span> BLOCK <span class="hljs-number">0</span> STREAMS <span class="hljs-keyword">queue</span> <span class="hljs-number">1630886777470</span>-<span class="hljs-number">0</span>  <span class="hljs-comment"># BLOCK 阻塞式拉取消息</span><br><br><span class="hljs-comment"># Stream 支持发布/订阅模式</span><br>  - XGROUP: 创建消费者组<br>  - XREADGROUP: 在指定消费组下，开启消费者拉取消息<br><br>  <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XGROUP CREATE <span class="hljs-keyword">queue</span> group1 <span class="hljs-number">0</span>-<span class="hljs-number">0</span>  <span class="hljs-comment"># 创建消费者组1， 0-0表示从头拉取消费</span><br>  OK<br>  <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XGROUP CREATE <span class="hljs-keyword">queue</span> group2 <span class="hljs-number">0</span>-<span class="hljs-number">0</span>  <span class="hljs-comment"># 创建消费者组2，0-0</span><br>  OK<br><br>  <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XREADGROUP GROUP group1 consumer COUNT <span class="hljs-number">5</span> STREAMS <span class="hljs-keyword">queue</span> &gt;  <span class="hljs-comment"># group1 的consumer开始消费，&gt;表示拉取最新数据</span><br><span class="hljs-number">1</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;queue&quot;</span><br>   <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630886765690-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;2021&quot;</span><br>      <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630886777470-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;09-06&quot;</span><br>      <span class="hljs-number">3</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630887243865-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;08-14&quot;</span><br>  <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XREADGROUP GROUP group2 consumer COUNT <span class="hljs-number">5</span> STREAMS <span class="hljs-keyword">queue</span> &gt;<br><span class="hljs-number">1</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;queue&quot;</span><br>   <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630886765690-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;2021&quot;</span><br>      <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630886777470-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;09-06&quot;</span><br>      <span class="hljs-number">3</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;1630887243865-0&quot;</span><br>         <span class="hljs-number">2</span>) <span class="hljs-number">1</span>) <span class="hljs-string">&quot;name&quot;</span><br>            <span class="hljs-number">2</span>) <span class="hljs-string">&quot;08-14&quot;</span><br>  <span class="hljs-number">172.30</span>.<span class="hljs-number">1.23</span>:<span class="hljs-number">6003</span>&gt; XACK <span class="hljs-keyword">queue</span> group1 <span class="hljs-number">1630887243865</span>-<span class="hljs-number">0</span>  <span class="hljs-comment"># XACK 命令告知Redis消费者处理完</span><br>  (integer) <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Stream 数据会写入RDB和AOF做持久化A</span><br><span class="hljs-comment"># 消息堆积，Stream会只保留固定长度的新消息,当队列长度超过上限，就消息会被删除，只保留固定长度的新消息</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Redis面试"><a href="#Redis面试" class="headerlink" title="Redis面试"></a>Redis面试</h2><ul>
<li>击穿、穿透、雪崩?<ul>
<li>击穿<figure class="highlight gauss"><table><tr><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 击穿发生的原因?</span><br>  - <span class="hljs-built_in">Key</span>过期<br>    &gt; <span class="hljs-built_in">Key</span>有过期时间，如果某一个时刻<span class="hljs-built_in">Key</span>失效，那么之后的查询请求将全部压倒数据库上，导致数据库崩溃.<br>  - <span class="hljs-built_in">Key</span>被页面置换淘汰<br>    &gt; 内存有限，要时刻缓存新的数据，淘汰旧的数据<br><br><span class="hljs-meta"># 应对击穿的处理思路?</span><br>  &gt; 由于<span class="hljs-built_in">Key</span>过期在所难免，大流量来到Redis时，根据Redis的单线程特性，可以认为任务是在队列里一次执行，当请求到达redis发现<span class="hljs-built_in">key</span>过期，进行一个操作: 设置锁<br>    <span class="hljs-number">1.</span>请求到达Redis，发现Redis <span class="hljs-built_in">Key</span>过期，查看有没有锁，没有锁的话回到队列后面排队<br>    <span class="hljs-number">2.</span>设置锁，注意，这儿应该是<span class="hljs-built_in">setnx</span>(),而不是<span class="hljs-built_in">set</span>(),因为可能有其他县城已经设置锁了<br>    <span class="hljs-number">3.</span>获取锁，拿到就去数据库取数据，请求返回后释放锁<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ul>
<li><p>穿透</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">穿透主要原因是很多请求都在访问数据库不存在的数据，应对这种请求的处理办法对访问请求加一层过滤器(布隆过滤器、增强版布隆过滤器、布谷鸟过滤器)</span><br></code></pre></td></tr></table></figure></li>
<li><p>雪崩</p>
<figure class="highlight gauss"><table><tr><td class="code"><pre><code class="hljs gauss">&gt; 雪崩和击穿类似，不同的是击穿是一个热点<span class="hljs-built_in">Key</span>某时刻失效，而雪崩是大量的热点<span class="hljs-built_in">Key</span>在一瞬间失效<br><br><span class="hljs-meta"># 处理思路?</span><br>  <span class="hljs-number">1.</span> 查看<span class="hljs-built_in">Key</span>过期是不是时点性有关，时点性无关的话，可以随机过期时间解决<br>  <span class="hljs-number">2.</span> 如果是时点性有关，利用强依赖击穿方案，单飞策略(先过去的线程更新一下所有<span class="hljs-built_in">Key</span>,在后台更新热点<span class="hljs-built_in">Key</span>的同时，业务层将进来的请求延时一下)<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3>]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>echo-go-web-framework</title>
    <url>/2021/09/02/echo-go-web-framework/</url>
    <content><![CDATA[<h1 id="Echo"><a href="#Echo" class="headerlink" title="Echo"></a>Echo</h1><blockquote>
<p>高性能、可扩展、精简的Go Web框架</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown">➜ go run main.go<br><br>   <span class="hljs-strong">____</span>    <span class="hljs-strong">__</span><br><span class="hljs-strong">  / __</span>/<span class="hljs-strong">__<span class="hljs-emphasis">_/ /  <span class="hljs-strong">__<span class="hljs-emphasis">_</span></span></span></span><br><span class="hljs-emphasis"><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong"> / _</span>// __</span>/ _</span> \/ <span class="hljs-emphasis">_ \</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">/<span class="hljs-strong">__<span class="hljs-emphasis">_/\<span class="hljs-strong">__/<span class="hljs-emphasis">_//_</span>/\__</span>_</span>/ v4.5.0</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">High performance, minimalist Go web framework</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">https://echo.labstack.com</span></span></span><br><span class="hljs-strong"><span class="hljs-emphasis"><span class="hljs-strong">__</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">__O/__</span><span class="hljs-strong">____</span>_</span></span><br><span class="hljs-strong">                                    O\</span><br><span class="hljs-strong">⇨ http server started on [::]:8080</span><br></code></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="功能概述"><a href="#功能概述" class="headerlink" title="功能概述"></a>功能概述</h2><ul>
<li>Optimized HTTP router which smartly prioritize routes</li>
<li>Build robust and scalable RESTful APIs</li>
<li>Group APIs</li>
<li>Extensible middleware framework</li>
<li>Define middleware at root, group or route level</li>
<li>Data binding for JSON, XML and form payload</li>
<li>Handy functions to send variety of HTTP response</li>
<li>Centralized HTTP error handling</li>
<li>Template rendering with any template engine</li>
<li>Define your format for the logger</li>
<li>Highly customizable</li>
<li>Automatic TLS via Let’s Encrypt</li>
<li>HTTP/2 support</li>
</ul>
]]></content>
      <categories>
        <category>Web Framework</category>
      </categories>
  </entry>
  <entry>
    <title>Dev-Ops Tips &amp; Tracks</title>
    <url>/2021/09/03/Dev-Ops-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="DevOps-BOOTCAMP"><a href="#DevOps-BOOTCAMP" class="headerlink" title="DevOps BOOTCAMP"></a>DevOps BOOTCAMP</h1><span id="more"></span>

<h2 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h2><ul>
<li>Pipeline<figure class="highlight xl"><table><tr><td class="code"><pre><code class="hljs xl">C<span class="hljs-function"><span class="hljs-title">ollaborate</span> -&gt;</span> B<span class="hljs-function"><span class="hljs-title">uild</span> -&gt;</span> T<span class="hljs-function"><span class="hljs-title">est</span> -&gt;</span> D<span class="hljs-function"><span class="hljs-title">eploy</span> -&gt;</span> R<span class="hljs-function"><span class="hljs-title">un</span> -&gt;</span> C<span class="hljs-function"><span class="hljs-title">onfigure</span> -&gt;</span> Monitor<br></code></pre></td></tr></table></figure></li>
<li>Tradition: Development vs Operations<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Development</span><br><span class="hljs-bullet">  -</span> programming languages<br><span class="hljs-bullet">  -</span> test frameworks<br><span class="hljs-bullet">  -</span> databases<br><span class="hljs-bullet">  -</span> version control<br><br><span class="hljs-section"># Operations</span><br><span class="hljs-bullet">  -</span> OS, mostly Linux<br><span class="hljs-bullet">  -</span> command-line<br><span class="hljs-bullet">  -</span> scripting<br><span class="hljs-bullet">  -</span> monitoring tools<br></code></pre></td></tr></table></figure></li>
<li>DevOps culture<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> DevOps was just a way <span class="hljs-keyword">of</span> working <span class="hljs-keyword">between</span> DEV<span class="hljs-string">&#x27;s and OP&#x27;</span>s<br><span class="hljs-number">2.</span> Common <span class="hljs-keyword">language</span> <span class="hljs-keyword">to</span> communicate<br></code></pre></td></tr></table></figure></li>
<li>Waterfall vs. Agile<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Waterfall: 瀑布开发</span><br>  &gt; ineffective process<br>  &gt; over time new requirements may arise<br>  &gt; many places of failure and miscommunication<br><span class="hljs-bullet">  -</span> Requirements:<br><span class="hljs-bullet">    -</span> plan everything beforehend<br><span class="hljs-bullet">  -</span> Development:<br><span class="hljs-bullet">    -</span> developers code complete app<br><span class="hljs-bullet">  -</span> Testing:<br><span class="hljs-bullet">    -</span> testing after everything has developed<br><span class="hljs-bullet">  -</span> Operations:<br><span class="hljs-bullet">    -</span> huge preparation<br><br><span class="hljs-section"># Agile: 敏捷开发</span><br>  &gt; speed of development, testing and development cycles<br>  &gt; each feature gets tested, deployed<br>  &gt; immediate feedback<br>  &gt; fast development and deployment process<br><span class="hljs-bullet">  -</span> Continuous Integration:<br><span class="hljs-bullet">  -</span> Continuous Delivery:<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Operating-Systems"><a href="#Operating-Systems" class="headerlink" title="Operating Systems"></a>Operating Systems</h2><ul>
<li>OS &amp; Linux<figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml"># Intro Operating Systems<br>  -<span class="ruby"> Hardware of <span class="hljs-symbol">Computer:</span></span><br><span class="ruby"></span>    &gt; CPU + Memory + Storage + I/O devices<br>  -<span class="ruby"> Operating <span class="hljs-symbol">System:</span></span><br><span class="ruby"></span>    -<span class="ruby"> Translator</span><br><span class="ruby"></span>    -<span class="ruby"> Manages Resources</span><br><span class="ruby"></span>      -<span class="ruby"> CPU <span class="hljs-symbol">Management:</span></span><br><span class="ruby"></span>      -<span class="ruby"> Memory Management (RAM = Rapid Access Memory)</span><br><span class="ruby"></span>        -<span class="ruby"> Memory Swape (Swap-out/Swap-<span class="hljs-keyword">in</span>)</span><br><span class="ruby"></span>      -<span class="ruby"> Storage <span class="hljs-symbol">Management:</span></span><br><span class="ruby"></span>        -<span class="ruby"> Manage File <span class="hljs-symbol">System:</span></span><br><span class="ruby"></span>          -<span class="ruby"> stored <span class="hljs-keyword">in</span> a structured way</span><br><span class="ruby"></span>          -<span class="ruby"> <span class="hljs-keyword">in</span> Unix <span class="hljs-symbol">systems:</span> tree file system</span><br><span class="ruby"></span>          -<span class="ruby"> <span class="hljs-keyword">in</span> Windows <span class="hljs-symbol">OS:</span> multiple root folders (Called drives, uses backslashes <span class="hljs-keyword">for</span> paths)</span><br><span class="ruby"></span>      -<span class="ruby"> Management I/O Devices</span><br><span class="ruby"></span>      -<span class="ruby"> Security &amp; Networking</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-symbol">Security:</span></span><br><span class="ruby"></span>          -<span class="ruby"> managing users <span class="hljs-keyword">and</span> permissions</span><br><span class="ruby"></span>        -<span class="ruby"> <span class="hljs-symbol">Networking:</span></span><br><span class="ruby"></span>    -<span class="ruby"> Isolates(隔离) content of application</span><br><span class="ruby"></span>  -<span class="ruby"> Operating system <span class="hljs-symbol">Components:</span></span><br><span class="ruby"></span>    -<span class="ruby"> <span class="hljs-symbol">kernel:</span></span><br><span class="ruby"></span>      -<span class="ruby"> kernel is a program</span><br><span class="ruby"></span>      -<span class="ruby"> Consists of device drivers, dispatcher, scheduler, File System etc.</span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">POSIX:</span> Portable Operating System Interface</span><br><span class="ruby"></span>  -<span class="ruby"> Linux <span class="hljs-keyword">and</span> MacOS both POSIX compliant</span><br></code></pre></td></tr></table></figure></li>
<li>Windows &amp; Linux CLI</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Windows</th>
<th align="left">Linux</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">dir</td>
<td align="left">ls -l</td>
<td align="left">Directory Listing</td>
</tr>
<tr>
<td align="left">ren</td>
<td align="left">mv</td>
<td align="left">rename a files</td>
</tr>
<tr>
<td align="left">copy</td>
<td align="left">cp</td>
<td align="left">Copying a file</td>
</tr>
<tr>
<td align="left">move</td>
<td align="left">mv</td>
<td align="left">Moving a file</td>
</tr>
<tr>
<td align="left">cls</td>
<td align="left">clear</td>
<td align="left">Clear Screen</td>
</tr>
<tr>
<td align="left">del</td>
<td align="left">rm</td>
<td align="left">Delete file</td>
</tr>
<tr>
<td align="left">chdir</td>
<td align="left">pwd</td>
<td align="left">returns your current directory location</td>
</tr>
<tr>
<td align="left">time</td>
<td align="left">date</td>
<td align="left">displays the time</td>
</tr>
<tr>
<td align="left">cd</td>
<td align="left">cd</td>
<td align="left">Change the current directory</td>
</tr>
<tr>
<td align="left">md</td>
<td align="left">mkdir</td>
<td align="left">To create a new directory/folder</td>
</tr>
<tr>
<td align="left">echo</td>
<td align="left">echo</td>
<td align="left">To print something on the screen</td>
</tr>
</tbody></table>
<ul>
<li><p>Virtualization虚拟化</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># VirtualBox:</span><br>  &gt; VirtualBox takes<span class="hljs-built_in"> hardware </span>resources <span class="hljs-keyword">from</span> Host OS.<br>  &gt; Creates virtual CPU, virtual RAM, virtual storage <span class="hljs-keyword">for</span> each virtual machine.<br>  &gt;<span class="hljs-built_in"> Hardware </span>resources are shared<br><br><span class="hljs-comment"># Bare Metal(for server): Hardware -&gt; Hypervisor -&gt; Guest OS</span><br>  - wmware ESXi<br>  - Microsoft Hyper-v<br><br>  - Efficient usage of<span class="hljs-built_in"> hardware </span>resources<br>    - use all the resources of performant big<span class="hljs-built_in"> server</span><br><span class="hljs-built_in"></span>    -<span class="hljs-built_in"> Users </span>can choose any resources combinations<br>  - Abstraction of the Operating<span class="hljs-built_in"> System </span><span class="hljs-keyword">from</span> the<span class="hljs-built_in"> hardware</span><br><span class="hljs-built_in"></span>    - Secure very easily<br>    - Portable<br>    - <span class="hljs-keyword">Not</span> dependent on physical<span class="hljs-built_in"> server</span><br><span class="hljs-built_in"></span><span class="hljs-comment"># Sharing things is not good for isolation</span><br></code></pre></td></tr></table></figure></li>
<li><p>Linux File System</p>
<figure class="highlight tcl"><table><tr><td class="code"><pre><code class="hljs tcl">&gt; Everything in Linux is a File<br><span class="hljs-comment"># Linux File System</span><br>  - hierarchical tree structure<br>  - <span class="hljs-number">1</span> root folder<br>  - multiple users on computer<br>  - each user has its own space<br>  - each user can have own configurations<br>  - programs installed system wide, are avaiable <span class="hljs-keyword">for</span> all users<br><br>  ➜ tree / -L <span class="hljs-number">1</span><br>  /<br>  ├── bin -&gt; usr/bin      -- executables <span class="hljs-keyword">for</span> most essential user commands<br>  ├── boot                -- contains files required <span class="hljs-keyword">for</span> booting (Read Only Folders)<br>  ├── core<br>  ├── dev                 -- location of device files, like webcam, keyboard, hard drive etc.<br>  ├── etc                 -- place where configuration <span class="hljs-keyword">for</span> system-wide applications is stored<br>  ├── home<br>  ├── k8s_data<br>  ├── lib -&gt; usr/lib      -- Essential shared libraries that executables from /bin or /sbin use<br>  ├── lost+found<br>  ├── media               -- contains subdirectories, where removable media devices inserted into the computer are mounted.<br>  ├── mnt                 -- historically, sys admins mounted temporary <span class="hljs-keyword">file</span> systems there<br>  ├── opt                 -- third-party program you install<br>  ├── <span class="hljs-keyword">proc</span><br>  ├──<span class="hljs-title"> root</span><br>  ├──<span class="hljs-title"> run</span><br>  ├──<span class="hljs-title"> sbin</span> -&gt;<span class="hljs-title"> usr/sbin</span>    --<span class="hljs-title"> system</span> binaries:<span class="hljs-title"> essential</span> system<span class="hljs-title"> binaries</span> programs<span class="hljs-title"> that</span> admin<span class="hljs-title"> would</span> use (need<span class="hljs-title"> superuser</span> privilige)<br>  ├──<span class="hljs-title"> snap</span><br>  ├──<span class="hljs-title"> srv</span><br>  ├──<span class="hljs-title"> sys</span><br>  ├──<span class="hljs-title"> tmp</span>                 --<span class="hljs-title"> temporary</span> resources<span class="hljs-title"> required</span> for<span class="hljs-title"> some</span> process,<span class="hljs-title"> kept</span> here<span class="hljs-title"> temporarily</span><br>  ├──<span class="hljs-title"> usr</span>                 --<span class="hljs-title"> this</span> was<span class="hljs-title"> used</span> for<span class="hljs-title"> user</span> home<span class="hljs-title"> directories</span><br>    ├──<span class="hljs-title"> bin</span><br>    ├──<span class="hljs-title"> config</span><br>    ├──<span class="hljs-title"> games</span><br>    ├──<span class="hljs-title"> include</span><br>    ├──<span class="hljs-title"> lib</span><br>    ├──<span class="hljs-title"> libexec</span><br>    ├──<span class="hljs-title"> local</span>             --<span class="hljs-title"> Programs</span> that<span class="hljs-title"> you</span> install<span class="hljs-title"> on</span> the<span class="hljs-title"> computer;</span> will<span class="hljs-title"> be</span> avaiable<span class="hljs-title"> for</span> all<span class="hljs-title"> users</span> on<span class="hljs-title"> the</span> computer<br>    ├──<span class="hljs-title"> sbin</span><br>    ├──<span class="hljs-title"> share</span><br>    └──<span class="hljs-title"> src</span><br>  └──<span class="hljs-title"> var</span>                 --<span class="hljs-title"> contains</span> files<span class="hljs-title"> to</span> which<span class="hljs-title"> the</span> system<span class="hljs-title"> writes</span> data<br>    ├──<span class="hljs-title"> backups</span><br>    ├──<span class="hljs-title"> cache</span>             --<span class="hljs-title"> contains</span> cached<span class="hljs-title"> data</span> from<span class="hljs-title"> application</span> programs<br>    ├──<span class="hljs-title"> crash</span><br>    ├──<span class="hljs-title"> lib</span><br>    ├──<span class="hljs-title"> local</span><br>    ├──<span class="hljs-title"> lock</span> -&gt; /run/lock<br>    ├──<span class="hljs-title"> log</span>               --<span class="hljs-title"> contains</span> log<span class="hljs-title"> files</span><br>    ├──<span class="hljs-title"> mail</span><br>    ├──<span class="hljs-title"> opt</span><br>    ├──<span class="hljs-title"> run</span> -&gt; /run<br>    ├──<span class="hljs-title"> snap</span><br>    ├──<span class="hljs-title"> spool</span><br>    ├──<span class="hljs-title"> tmp</span><br>    └──<span class="hljs-title"> www</span><br>  21<span class="hljs-title"> directories,</span> 1<span class="hljs-title"> file</span><br><br>  - /usr/local<span class="hljs-title"> vs.</span> /opt<br>    - /usr/local:<br>      -<span class="hljs-title"> programs,</span> which<span class="hljs-title"> split</span> its<span class="hljs-title"> components</span><br>    - /opt:<br>      -<span class="hljs-title"> programs,</span> which<span class="hljs-title"> NOT</span> split<span class="hljs-title"> its</span> components<br><br>#<span class="hljs-title"> Hidden</span> Files<br>  -<span class="hljs-title"> ls</span> primarily<span class="hljs-title"> used</span> to<span class="hljs-title"> help</span> prevent<span class="hljs-title"> important</span> data<span class="hljs-title"> from</span> being<span class="hljs-title"> accientally</span> deleted<br>  -<span class="hljs-title"> Automatically</span> generated<span class="hljs-title"> by</span> programs<span class="hljs-title"> or</span> operating<span class="hljs-title"> system</span><br>  -<span class="hljs-title"> File</span> name<span class="hljs-title"> starts</span> with<span class="hljs-title"> a</span> dot<br>  -<span class="hljs-title"> In</span> UNIX<span class="hljs-title"> also</span> called &quot;dotfiles&quot;<br><br>#<span class="hljs-title"> Windows</span> File<span class="hljs-title"> System</span><br>  -<span class="hljs-title"> multiple</span> root<span class="hljs-title"> folders</span><br>  -<span class="hljs-title"> A,B:</span> Removable<span class="hljs-title"> Disks</span><br>  -<span class="hljs-title"> C:</span> Local<span class="hljs-title"> Disk</span> -<span class="hljs-title"> Internal</span> hard<span class="hljs-title"> drive</span><br></code></pre></td></tr></table></figure></li>
<li><p>Basic Linux Command</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment"># GUI vs. CLI</span><br>  - GUI = A graphical user interface<br>  - CLI = Command Line Interface<br><br>ubuntu <span class="hljs-keyword">in</span> ~ <span class="hljs-keyword">at</span> k8s-node1 via 🐹 v1<span class="hljs-number">.16</span><span class="hljs-number">.5</span> via 🐍 <span class="hljs-number">3.8</span><span class="hljs-number">.6</span><br>➜<br>  - ubuntu: user name<br>  - k8s-node1: computer name<br>  - ~: home <span class="hljs-built_in">directory</span><br>  - $: represents regular user<br>  - <span class="hljs-comment">#: sign for root user</span><br><br><span class="hljs-comment"># Folder Operations</span><br>  - pwd: Show current <span class="hljs-built_in">directory</span><br>  - ls: List <span class="hljs-built_in">folders</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">files</span><br>    - ls -<span class="hljs-keyword">a</span> = Show all (including hidden)<br>  - cd: Change <span class="hljs-built_in">directory</span> <span class="hljs-built_in">to</span> [dir]<br>  - mkdir: Make <span class="hljs-built_in">directory</span> [dirname]<br><br><span class="hljs-comment"># File Operations</span><br>  - touch [filename]: Create [filename]<br>  - rm [filename]: Delete [filename]<br>    - rm -r [dirname]: Delete <span class="hljs-keyword">a</span> non-<span class="hljs-literal">empty</span> <span class="hljs-built_in">directory</span> <span class="hljs-keyword">and</span> all <span class="hljs-keyword">the</span> <span class="hljs-built_in">files</span> <span class="hljs-keyword">within</span> <span class="hljs-keyword">it</span>.<br>    - rm -d [dirname] <span class="hljs-keyword">or</span> rmdir [dirname]: Delete <span class="hljs-keyword">an</span> <span class="hljs-literal">empty</span> <span class="hljs-built_in">directory</span><br>  - mv [filename] [new_filename] = Rename <span class="hljs-keyword">the</span> <span class="hljs-built_in">file</span> <span class="hljs-built_in">to</span> <span class="hljs-keyword">a</span> <span class="hljs-built_in">new</span> filename<br>  - cp -r [dirname] [new_dirname] = Copy dirname <span class="hljs-built_in">to</span> new_dirname<br><br><span class="hljs-comment"># Display OS Information</span><br>  - uname -<span class="hljs-keyword">a</span>: Show <span class="hljs-keyword">system</span> <span class="hljs-keyword">and</span> kernel<br>  Linux k8s-node1 <span class="hljs-number">5.4</span><span class="hljs-number">.0</span><span class="hljs-number">-1043</span>-raspi <span class="hljs-comment">#47-Ubuntu SMP PREEMPT Mon Aug 23 09:41:31 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux</span><br><br>  ➜ cat /etc/os-release<br>  NAME=<span class="hljs-string">&quot;Ubuntu&quot;</span><br>  VERSION=<span class="hljs-string">&quot;20.04.3 LTS (Focal Fossa)&quot;</span><br>  ID=ubuntu<br>  ID_LIKE=debian<br>  PRETTY_NAME=<span class="hljs-string">&quot;Ubuntu 20.04.3 LTS&quot;</span><br>  VERSION_ID=<span class="hljs-string">&quot;20.04&quot;</span><br>  HOME_URL=<span class="hljs-string">&quot;https://www.ubuntu.com/&quot;</span><br>  SUPPORT_URL=<span class="hljs-string">&quot;https://help.ubuntu.com/&quot;</span><br>  BUG_REPORT_URL=<span class="hljs-string">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span><br>  PRIVACY_POLICY_URL=<span class="hljs-string">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span><br>  VERSION_CODENAME=focal<br>  UBUNTU_CODENAME=focal<br><br>  - lscpu:<br>  - lsmem:<br>  - sudo: Allows regular users <span class="hljs-built_in">to</span> run programs <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> security privileges <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> superusere <span class="hljs-keyword">or</span> root<br>  - su - chyi: <span class="hljs-keyword">switch</span> user<br><br><span class="hljs-comment"># Some More Useful Commands</span><br>  - <span class="hljs-built_in">clear</span>: Clears <span class="hljs-keyword">the</span> terminal<br>  - history: Gives <span class="hljs-keyword">a</span> list <span class="hljs-keyword">of</span> all past commands typed <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> current terminal session<br>  - Ctrl + r: Search history<br>  - Ctrl + c: Stop current <span class="hljs-keyword">command</span><br>  - cat [filename]: Display <span class="hljs-keyword">the</span> <span class="hljs-built_in">file</span> content<br></code></pre></td></tr></table></figure></li>
<li><p>Package Manager</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">  <span class="hljs-number">1</span>. central plcae to install, upgrade,configure, remove software<br><br># APT - Advanced <span class="hljs-keyword">Package</span> <span class="hljs-title">Tool</span><br>  &gt; Dependencies are shared<br>  &gt; Only <span class="hljs-keyword">for</span> specific Linux distributions (<span class="hljs-keyword">package</span> <span class="hljs-title">type .deb)</span><br>  &gt; Manual Updates<br>  - apt search &lt;package_name&gt; = Search <span class="hljs-keyword">for</span> a given <span class="hljs-keyword">package</span><br>  <span class="hljs-title">- apt install &lt;package_name&gt; = Install a given <span class="hljs-keyword">package</span></span><br>  - apt remove &lt;package_name&gt; = Remove installed <span class="hljs-keyword">package</span><br>  <span class="hljs-title">- apt update = Updates the packages index</span><br><br># Repositories:<br>  &gt; storage location, containing thousands <span class="hljs-keyword">of</span> programs<br><br># Snap <span class="hljs-keyword">Package</span> <span class="hljs-title">Manager:</span><br>  &gt; A snap <span class="hljs-keyword">is</span> a bundle <span class="hljs-keyword">of</span> an app <span class="hljs-keyword">and</span> its dependencies<br>  &gt; Supports universal Linux packages (<span class="hljs-keyword">package</span> <span class="hljs-title">type .snap)</span><br>  &gt; Automatic Updates<br>  - Self-contained - dependencies contained <span class="hljs-keyword">in</span> the <span class="hljs-keyword">package</span><br><br><span class="hljs-title"># Add Repository to official l</span>ist <span class="hljs-keyword">of</span> repos (add-apt-repository)<br># PPA = Personal <span class="hljs-keyword">Package</span> <span class="hljs-title">Archive</span><br>  - PPAs are provided by the community<br><br># Debian Based:   <span class="hljs-comment">-- APT/APT-GET</span><br>  - Ubuntu<br>  - Debian<br>  - Mint<br># Red Had Based:  <span class="hljs-comment">-- Yum</span><br>  - RHEL<br>  - CentOS<br>  - Fedora<br></code></pre></td></tr></table></figure></li>
<li><p>Vim Editor</p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><code class="hljs n1ql"># Vim Mode:<br>  - Command Mode:<br>    - Navigate, Search, <span class="hljs-keyword">Delete</span>, Undo etc.<br>    - Whatever you <span class="hljs-built_in">type</span> <span class="hljs-keyword">is</span> interpreted <span class="hljs-keyword">as</span> a command<br>  - <span class="hljs-keyword">Insert</span> Mode:<br>#<br>- Press i <span class="hljs-keyword">key</span> = Switch <span class="hljs-keyword">to</span> <span class="hljs-keyword">insert</span> Mode<br>- Press esc <span class="hljs-keyword">key</span> = Switch <span class="hljs-keyword">to</span> Command Mode<br>- <span class="hljs-built_in">Type</span> dd = <span class="hljs-keyword">Delete</span> entire line<br>- <span class="hljs-built_in">Type</span> d10 = <span class="hljs-keyword">Delete</span> next <span class="hljs-number">10</span> lines<br>- <span class="hljs-built_in">Type</span> u = Undo<br>- <span class="hljs-built_in">Type</span> $ = Jump <span class="hljs-keyword">to</span> <span class="hljs-keyword">end</span> of the line<br>- <span class="hljs-built_in">Type</span> <span class="hljs-number">0</span> = Jump <span class="hljs-keyword">to</span> <span class="hljs-keyword">start</span> of the line<br>- <span class="hljs-built_in">Type</span> /pattern = Search <span class="hljs-keyword">for</span> pattern<br>- <span class="hljs-built_in">Type</span> :%s/old/new = <span class="hljs-built_in">Replace</span> old <span class="hljs-keyword">with</span> new throughout the file<br></code></pre></td></tr></table></figure></li>
<li><p>Users &amp; Permissions</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># User Accounts:</span><br>  - Superuser Account:<br>  - <span class="hljs-keyword">User</span> <span class="hljs-title">Account</span>:<br>  - Service Account:<br>    - Don&#x27;t run services with root user!<br><br>  - adduser <span class="hljs-tag">&lt;username&gt;</span> = Create a new <span class="hljs-keyword">user</span><br><br><span class="hljs-title"># Groups</span> &amp; Ownership<br>  - <span class="hljs-keyword">User</span> <span class="hljs-title">Level</span>:<br>  - <span class="hljs-keyword">Group</span> <span class="hljs-title">Level</span>:<br><br><span class="hljs-comment"># Access Control Files:</span><br>  - /etc/passwd:<br>    - Stores <span class="hljs-keyword">user</span> <span class="hljs-title">account</span> <span class="hljs-literal">inf</span>ormation<br>    - Everyone can <span class="hljs-keyword">read</span> it, but only root <span class="hljs-keyword">user</span> <span class="hljs-title">can</span> change the file<br><br>    ➜ cat /etc/passwd | grep pi<br>    pi:x:<span class="hljs-number">1000</span>:<span class="hljs-number">1000</span>:,,,:/home/pi:/usr/bin/zsh<br>    USERNAME:PASSWORD:UID:GID:GECOS:HOMEDIR:SHELL<br>      - PASSWORD(x) means, that encrypted password is stored <span class="hljs-keyword">in</span> /etc/shadow file<br>      - <span class="hljs-keyword">User</span> <span class="hljs-title">ID</span>(UID): Each <span class="hljs-keyword">user</span> <span class="hljs-title">has</span> a unique ID. UID <span class="hljs-number">0</span> is reserved for root<br>  - /etc/shadow<br>  - /etc/<span class="hljs-keyword">group</span><br><br><span class="hljs-title"># File</span> Permissions<br><br><span class="hljs-comment"># Linux Commands for Managing Users and their permissions</span><br>  - passwd <span class="hljs-tag">&lt;username&gt;</span> = Change password of a <span class="hljs-keyword">user</span><br>  <span class="hljs-title">- su</span> - <span class="hljs-tag">&lt;username&gt;</span> = Login as username (su = switch user)<br>  - su - = Login as root<br>  - groupadd <span class="hljs-tag">&lt;groupname&gt;</span> = Create new <span class="hljs-keyword">group</span><br>  <span class="hljs-title">- usermod</span> [OPTIONS] <span class="hljs-tag">&lt;username&gt;</span> = Modify a <span class="hljs-keyword">user</span> <span class="hljs-title">account</span><br>  - useradd [OPTIONS] <span class="hljs-tag">&lt;username&gt;</span> = Create a new <span class="hljs-keyword">user</span><br>  <span class="hljs-title">- groups</span><br><br><span class="hljs-comment"># Different User &amp; Group Commands</span><br>  - adduser/addgroup/deluser/delgroup:<br>    - More <span class="hljs-keyword">User</span> <span class="hljs-title">Friendly</span><br>  - useradd/groupadd/userdel/groupdel:<br>    - Low-level utilties<br></code></pre></td></tr></table></figure></li>
<li><p>Shell Scripting</p>
</li>
<li><p>Environmemt Variables</p>
</li>
<li><p>Networking</p>
</li>
<li><p>SSH - Secure Shell</p>
</li>
</ul>
<h2 id="Version-Control"><a href="#Version-Control" class="headerlink" title="Version Control"></a>Version Control</h2><ul>
<li>GUI Git<ul>
<li>github</li>
<li>gitlab<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> Git global setup</span><br><span class="hljs-meta">  $</span><span class="bash"> git config --global user.name <span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-meta">  $</span><span class="bash"> git config --global user.email <span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Create a new repository</span><br><span class="hljs-meta">  $</span><span class="bash"> git <span class="hljs-built_in">clone</span> git@gitlab.com:</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Push an existing folder</span><br><span class="hljs-meta">  $</span><span class="bash"> <span class="hljs-built_in">cd</span> existing_folder</span><br><span class="hljs-meta">  $</span><span class="bash"> git init</span><br><span class="hljs-meta">  $</span><span class="bash"> git remote add origin https://gitlab.com/chyiyaqing/my-project.git</span><br><span class="hljs-meta">  $</span><span class="bash"> git branch -M main</span><br><span class="hljs-meta">  $</span><span class="bash"> git push -uf origin main</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 使用SSH Key</span><br>  - GitHub/GitLab can authenticate us when pushing/pulling from repository<br>  - without providing username and password each time.<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Git<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Git Stages</span><br><span class="hljs-bullet">  -</span> Working Directory (git add -&gt; Staging Area)<br><span class="hljs-bullet">  -</span> Staging Area (git commit -&gt; Local Repository)<br><span class="hljs-bullet">  -</span> Local Repository<br><br><span class="hljs-section"># Git Command Tools</span><br><span class="hljs-bullet">  -</span> git status : status of local git repo<br><span class="hljs-bullet">  -</span> git add:<br><span class="hljs-bullet">  -</span> git commit:<br><span class="hljs-bullet">  -</span> git log: history of local repository changes<br><span class="hljs-bullet">  -</span> git init:<br><span class="hljs-bullet">  -</span> git pull:<br><span class="hljs-bullet">  -</span> git checkout <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">branch</span> <span class="hljs-attr">name</span>&gt;</span></span> = switch branches<br><span class="hljs-bullet">  -</span> git checkout -b <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">branch</span> <span class="hljs-attr">name</span>&gt;</span></span> = creating and switching to new branch<br><span class="hljs-section"># Branch</span><br><span class="hljs-bullet">  -</span> Master branch = main branch is created by default, when initializing a git repo<br><span class="hljs-bullet">    -</span> best practice: 1 branch per bugfix or feature<br><span class="hljs-bullet">    -</span> big feature branches long open, increase the chanceee of merge conflicts<br><span class="hljs-bullet">    -</span> only master branch for continuous integration/delivery<br><span class="hljs-bullet">    -</span> pipeline is triggered whenever feature/bugfix code is merged into master<br><span class="hljs-bullet">    -</span> must be stable and ready for production<br><span class="hljs-bullet">  -</span> Develop Branch<br><span class="hljs-bullet">    -</span> dev branch: intermediary master<br><span class="hljs-bullet">  -</span> Avoiding Merge Commits (rebase)<br><span class="hljs-bullet">    -</span> git pull(git fetch + git merge) vs. git pull --rebase (no merge commit, much cleaner project history)<br><span class="hljs-bullet">  -</span> Resolving Merge Conflicts<br><span class="hljs-bullet">  -</span> Don&#x27;t track certain files (.gitignore file)<br><span class="hljs-bullet">    -</span> .gitignore: to exclude certain folders or files from git to be tracked<br><span class="hljs-bullet">    -</span> git rm -r --cached : Stop tracking a file<br><span class="hljs-bullet">  -</span> Save work-in-progress changes (stash)<br><span class="hljs-bullet">    -</span> git stash (save un-committed (work-in-progress) changes, unfinished changes, which don&#x27;t want to commit yet)<br><span class="hljs-bullet">    -</span> git stash pop (get the changes back)<br><span class="hljs-bullet">  -</span> Going back in history<br><span class="hljs-bullet">    -</span> git checkout <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">commit</span> <span class="hljs-attr">hash</span>&gt;</span></span> (go back to a specific project version)<br><span class="hljs-bullet">    -</span> Each commit: (unique commit hash, commit message, author + date)<br><span class="hljs-bullet">  -</span> Undoing and changing commits<br><span class="hljs-bullet">    -</span> git reset --hard <span class="xml">&lt;HEAD~1&gt;</span> (removed old commit)<br><span class="hljs-bullet">    -</span> git reset --soft (keep the changes in your working directory)<br><span class="hljs-bullet">    -</span> git revert <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">commit</span> <span class="hljs-attr">hash</span>&gt;</span></span> (creates a new commit to revert the old commits changesj)<br><span class="hljs-bullet">    -</span> git commit --amend (changing the last commit)<br><span class="hljs-bullet">  -</span> Merging Branches<br><br><span class="hljs-section"># Merge Requests:</span><br><span class="hljs-bullet">  -</span> Best practice: Other developer reviews code changes before merging<br><span class="hljs-section"># Git 名词解释</span><br><span class="hljs-bullet">  -</span> origin = your remote git project/repo<br><br><span class="hljs-section"># Git for DevOps</span><br><span class="hljs-bullet">  -</span> Infrastructure as Code<br><span class="hljs-bullet">    -</span> Many Kubernetes Configuration Files (Yaml) (Deployment to Kubernetes)<br><span class="hljs-bullet">    -</span> Terraform and Ansible Configuration Files<br><span class="hljs-bullet">    -</span> Bash and Python Python Scripts<br><span class="hljs-bullet">    -</span> tracked - history of changes<br><span class="hljs-bullet">    -</span> securely stored in one place<br><span class="hljs-bullet">  -</span> CI/CD Pipeline and Build Automation<br><span class="hljs-bullet">    -</span> checkout code, test and build application, etc.<br><span class="hljs-bullet">    -</span> need integration for the build automation tool with application git repository<br></code></pre></td></tr></table></figure></li>
<li>Databases<figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml">&gt; Database are used to persist data!<br>-<span class="ruby"> DB endpoint &amp; credentials should <span class="hljs-keyword">not</span> be hardcode</span><br><span class="ruby"></span><br># DevOps Engineer<br>  -<span class="ruby"> how to configure DB</span><br><span class="ruby"></span>  -<span class="ruby"> hot to setup DB</span><br><span class="ruby"></span>  -<span class="ruby"> how to manage DB</span><br><span class="ruby"></span><br># Database Types<br>  -<span class="ruby"> Key-Value Database</span><br><span class="ruby"></span>    -<span class="ruby"> Redis</span><br><span class="ruby"></span>    -<span class="ruby"> Memcached</span><br><span class="ruby"></span>    -<span class="ruby"> etcd from Kubernetes</span><br><span class="ruby"></span>    # Best for:<br>      -<span class="ruby"> Caching</span><br><span class="ruby"></span>      -<span class="ruby"> Message Queue</span><br><span class="ruby"></span>  -<span class="ruby"> Wide Column Database (schema-less, scalable, no joins)</span><br><span class="ruby"></span>    -<span class="ruby"> Cassandra</span><br><span class="ruby"></span>    -<span class="ruby"> HBase</span><br><span class="ruby"></span>    # Best for:<br>      -<span class="ruby"> TIME-Series</span><br><span class="ruby"></span>      -<span class="ruby"> Iot-Records</span><br><span class="ruby"></span>      -<span class="ruby"> Historical-records</span><br><span class="ruby"></span>  -<span class="ruby"> Document Databases (schema-less)</span><br><span class="ruby"></span>    -<span class="ruby"> MongoDB</span><br><span class="ruby"></span>    -<span class="ruby"> DynamoDB</span><br><span class="ruby"></span>    -<span class="ruby"> CouchDB</span><br><span class="ruby"></span>    # Best for:<br>      -<span class="ruby"> Mobile Apps</span><br><span class="ruby"></span>      -<span class="ruby"> Game Apps</span><br><span class="ruby"></span>      -<span class="ruby"> Cms</span><br><span class="ruby"></span>      -<span class="ruby"> Most Apps</span><br><span class="ruby"></span>  -<span class="ruby"> Relational Databases (schema, structured query language )</span><br><span class="ruby"></span>    -<span class="ruby"> MySQL</span><br><span class="ruby"></span>    -<span class="ruby"> Postgresql</span><br><span class="ruby"></span>    # Best for:<br>      -<span class="ruby"> ACID (Atomicity, Consistency, Isolation, Durability)</span><br><span class="ruby"></span>  -<span class="ruby"> Graph Database (Nodes <span class="hljs-keyword">and</span> Edges)</span><br><span class="ruby"></span>    -<span class="ruby"> Neo4j</span><br><span class="ruby"></span>    -<span class="ruby"> Dgraph</span><br><span class="ruby"></span>    # Best for:<br>      -<span class="ruby"> Graphs</span><br><span class="ruby"></span>      -<span class="ruby"> Patterns</span><br><span class="ruby"></span>  -<span class="ruby"> Search Database</span><br><span class="ruby"></span>    -<span class="ruby"> ElasticSearch</span><br><span class="ruby"></span>    -<span class="ruby"> Solr</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Build-Tools-amp-Package-Manager"><a href="#Build-Tools-amp-Package-Manager" class="headerlink" title="Build Tools &amp; Package Manager"></a>Build Tools &amp; Package Manager</h2><ul>
<li>artifact<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Building the code:</span><br><span class="hljs-bullet">  -</span> compiling<br><span class="hljs-bullet">  -</span> Compress<br><br><span class="hljs-section"># Aritfact repositoy</span><br>  &gt; Keep artifact in storage<br>  &gt; to deploy it multiple times, have backup etc.<br><span class="hljs-bullet">  -</span> Nexus<br><span class="hljs-bullet">  -</span> JFrog<br><br><span class="hljs-section"># What kind of file is the artifact?</span><br><span class="hljs-bullet">  -</span> Java artifact (JAR or WAR file includes whole code plus dependencies)<br><br><span class="hljs-section"># Install Java and Build Tools</span><br><span class="hljs-bullet">  -</span> Install Java<br><span class="hljs-bullet">  -</span> Install Maven (mvn package)<br><span class="hljs-bullet">  -</span> Install Gradle (./gradlew build)<br><span class="hljs-bullet">  -</span> Install Node + npm<br><br><span class="hljs-section"># Build Aritifact</span><br><span class="hljs-bullet">  -</span> 1. Using a Build Tool (Install dependencies; Compile and compress your code)<br><span class="hljs-code">    Java: (JAR or WAR file)</span><br><span class="hljs-code">      - Maven (Using XML)</span><br><span class="hljs-code">        - mvn install</span><br><span class="hljs-code">        - mvn package (target/xxx-.jar)</span><br><span class="hljs-code">      - Gradle (Using Groovy)</span><br><span class="hljs-code">        - ./gradlew build (build/libs/xxx.jar)</span><br><span class="hljs-code">        - Note: Gradle-Java Version Compatibility (Change Java version less than 16)</span><br><span class="hljs-code"></span><br><span class="hljs-section"># Managing Dependencies</span><br>  &gt; Dependencies file = managing the dependencies for a project<br><span class="hljs-bullet">  -</span> maven (pom.xml)<br><span class="hljs-bullet">  -</span> gradle (build.gradle)<br><br><span class="hljs-bullet">  -</span> Local Dependency Repository(~/.m2/repository)<br><br><span class="hljs-section"># Run the application</span><br><span class="hljs-bullet">  -</span> JAR (java -jar <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">name</span> <span class="hljs-attr">of</span> <span class="hljs-attr">jar</span> <span class="hljs-attr">file</span>&gt;</span></span>)<br><br><span class="hljs-section"># Build JS Applications</span><br><span class="hljs-bullet">  -</span> no special artifact type (ZIP/TAR file)<br><span class="hljs-bullet">  -</span> npm and yarn<br><span class="hljs-bullet">  -</span> package.json file for dependencies<br><span class="hljs-bullet">  -</span> package managers and NOT build tools<br><span class="hljs-bullet">  -</span> install dependencies, but not used for transpiling JS code<br><span class="hljs-bullet">  -</span> Command Lint Tool - npm<br><span class="hljs-bullet">    -</span> npm install = install dependencies<br><span class="hljs-bullet">    -</span> npm start - start the application<br><span class="hljs-bullet">    -</span> npm stop - stop the application<br><span class="hljs-bullet">    -</span> npm test - run the tests<br><span class="hljs-bullet">    -</span> npm publish - publish the artifact<br><span class="hljs-bullet">    -</span> [ ] npm pack - package<br><span class="hljs-bullet">  -</span> zip/tar file include?<br><span class="hljs-bullet">    -</span> application code, but not the dependencies<br><span class="hljs-bullet">    -</span> must install the dependencies first<br><span class="hljs-bullet">    -</span> unpack zip/tar<br><span class="hljs-bullet">    -</span> run the APP (copy artifact &amp; package.json file)<br><br><span class="hljs-section"># Build Tool - Webpack</span><br>  &gt; transpiles(转译)|minifies(缩小)|bundles(捆绑)|compresses(压缩) the code<br><br><span class="hljs-section"># What are Build Tools for other programming language?</span><br><span class="hljs-bullet">  -</span> Python (pip)<br><br><span class="hljs-section"># Pattern in all these tools</span><br><span class="hljs-bullet">  -</span> dependecyfile<br><span class="hljs-bullet">    -</span> maven (pom.xml)<br><span class="hljs-bullet">    -</span> gradle (build.gradle)<br><span class="hljs-bullet">    -</span> npm (package.json)<br><span class="hljs-bullet">  -</span> repository for dependencies<br><span class="hljs-bullet">  -</span> command line tool<br><span class="hljs-bullet">  -</span> package managers<br><br><span class="hljs-section"># Build Tools for DevOps Engineers</span><br><span class="hljs-bullet">  -</span> Build Docker Image =&gt; Push to Repo =&gt; Run on Server<br><span class="hljs-bullet">  -</span> Install Dependencies =&gt; run tests =&gt; build/bundle app =&gt; push to repo<br><br>SDK = Software Development Kit<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Cloud-amp-Infrastructure-as-a-Service"><a href="#Cloud-amp-Infrastructure-as-a-Service" class="headerlink" title="Cloud &amp; Infrastructure as a Service"></a>Cloud &amp; Infrastructure as a Service</h2>  <figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># What is Infrastructure as a Service?</span><br>  - <span class="hljs-keyword">Buys </span>own server<br>    &gt; manage own server <span class="hljs-keyword">and </span>infrastructure<br>    &gt; if something <span class="hljs-keyword">breaks, </span>need to fix it<br>  - Delegate Infrastructure Management<br>    &gt; <span class="hljs-keyword">Move </span>your physical infrastructure to <span class="hljs-keyword">cloud</span><br><span class="hljs-keyword"></span>    &gt; <span class="hljs-keyword">Just </span>rent (租赁) the servers<br><br><span class="hljs-comment"># Infrastructure as a Service Providers?</span><br>  - Google <span class="hljs-keyword">Cloud</span><br><span class="hljs-keyword"></span>  - aws<br>  - <span class="hljs-keyword">DigitalOcean</span><br><span class="hljs-keyword"></span>  - Microsoft Azure<br><br>&gt; Inbound = Incoming Requests<br>&gt; Outbound = outgoing requests from server<br></code></pre></td></tr></table></figure>
<ul>
<li>Create a Linux User (Not use Root)<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># Security Best practice</span><br>  - Create separate <span class="hljs-keyword">User</span> <span class="hljs-title">for</span> every application<br>  - Give it only the permission it needs to run that App<br>  - Don&#x27;t work with the Root <span class="hljs-keyword">user</span><br><br>  <span class="hljs-title">&gt; create</span> username<br>  $ adduser <span class="hljs-tag">&lt;username&gt;</span><br><br>  &gt; Add <span class="hljs-keyword">user</span> <span class="hljs-title">to</span> <span class="hljs-string">&quot;sudo&quot;</span> <span class="hljs-keyword">group</span><br>  <span class="hljs-title">$</span> usermod -aG sudo <span class="hljs-tag">&lt;username&gt;</span><br><br>  &gt; switch to username<br>  $ su - <span class="hljs-tag">&lt;username&gt;</span><br><br>  $ = standard Linux <span class="hljs-keyword">User</span><br>  <span class="hljs-title"># = Root</span> User<br></code></pre></td></tr></table></figure></li>
<li>Nexus: Artifact Repository<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; Nexus <span class="hljs-keyword">is</span> one <span class="hljs-keyword">of</span> the most popular<br>&gt; upload <span class="hljs-keyword">and</span> store different built artifacts<br>&gt; retrieve(download) artifacts later<br>&gt; central <span class="hljs-keyword">storage</span><br>&gt; host own repositories<br>&gt; Proxy Repository<br>&gt; metadata tagging (labelling <span class="hljs-keyword">and</span> tagging artifacts)<br>&gt; cleanup policies<br>&gt; <span class="hljs-keyword">search</span> functionality<br>&gt; <span class="hljs-keyword">user</span> token support <span class="hljs-keyword">for</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">user</span> authentication<br><br># What <span class="hljs-keyword">is</span> an Artifact Repository?<br>  - Artifacts = Apps built <span class="hljs-keyword">into</span> a **single file**<br>  - Different Artifact formats (JAR, WAR, ZIP, TAR)<br>  - Artifact repository = <span class="hljs-keyword">storage</span> <span class="hljs-keyword">of</span> those artifacts<br><br># What <span class="hljs-keyword">is</span> an Artifact Repository Manager?<br>  - Repository Formats?<br>    - APT<br>    - Composer<br>    - Conan<br>    - CPAN<br>    - Docker<br>    - ELPA<br>    - Git LFS<br>    - Go<br>    - Helm<br>    - Maven<br>    - npm<br>    - NuGet<br>    - P2<br>    - PyPI<br>    - R<br>    - Raw<br>    - RubyGems<br>    - Yum<br><br>Jenkins <span class="hljs-comment">--&gt; push --&gt; Nexus &lt;-- pull &lt;-- Server</span><br><br># Nexus Install<br>  &gt; Download Nexus tar file<br>  $ wget https://download.sonatype.com/nexus/<span class="hljs-number">3</span>/latest-unix.tar.gz<br><br>  &gt; Untar file<br>  $ tar -xvf latest-unix.tar.gz<br><br>  chyi <span class="hljs-keyword">in</span> ~/Downloads at k8s-master<br>  ➜ ll<br>  total <span class="hljs-number">196</span>M<br>  -rw-r<span class="hljs-comment">--r--  1 chyi users 196M Oct 12 19:58 latest-unix.tar.gz</span><br>  drwxr-xr-x <span class="hljs-number">10</span> chyi users <span class="hljs-number">4.0</span>K Oct <span class="hljs-number">17</span> <span class="hljs-number">15</span>:<span class="hljs-number">08</span> nexus<span class="hljs-number">-3.35</span><span class="hljs-number">.0</span><span class="hljs-number">-02</span>      <span class="hljs-comment">-- Nexus folder: (contains runtime and application of Nexus)</span><br>  drwxr-xr-x  <span class="hljs-number">3</span> chyi users <span class="hljs-number">4.0</span>K Oct <span class="hljs-number">17</span> <span class="hljs-number">15</span>:<span class="hljs-number">08</span> sonatype-<span class="hljs-keyword">work</span>        <span class="hljs-comment">-- Sonatype-work: contains own config for Nexus and data</span><br>    - subdirectories depending <span class="hljs-keyword">on</span> your Nexus <span class="hljs-keyword">configuration</span><br>    - IP address that accessed Nexus<br>    - Logs <span class="hljs-keyword">of</span> Nexus App<br>    - Your uploaded files <span class="hljs-keyword">and</span> metadata<br><br># Staring Nexus<br>  - Services should <span class="hljs-keyword">not</span> run <span class="hljs-keyword">with</span> Root <span class="hljs-keyword">User</span> Permissions<br>  - Best practice: <span class="hljs-keyword">Create</span> own <span class="hljs-keyword">User</span> <span class="hljs-keyword">for</span> Service (e.g. Nexus - <span class="hljs-keyword">Only</span> the permission <span class="hljs-keyword">for</span> that specific Service)<br><br>  &gt; <span class="hljs-keyword">Create</span> <span class="hljs-keyword">User</span><br>  $ adduser nexus<br><br>  &gt; change folder <span class="hljs-keyword">owner</span><br>  &gt; Nexus <span class="hljs-keyword">User</span> <span class="hljs-keyword">execute</span> nexus executable<br>  &gt; Nexus <span class="hljs-keyword">read</span>/<span class="hljs-keyword">write</span> sonatype-<span class="hljs-keyword">work</span> folder<br>  $ chown -R nexus:nexus nexus<span class="hljs-number">-3</span><br>  $ chown -R nexus:nexus sonatype-<span class="hljs-keyword">work</span><br><br>  &gt; change run <span class="hljs-keyword">user</span><br>  $ sudo vim nexus<span class="hljs-number">-3</span>/bin/nexus.rc<br>    run_as_user=&quot;nexus&quot;<br><br>  &gt; <span class="hljs-keyword">start</span> nexus<br>  nexus@chyiyaqing-PowerEdge-R720:/opt$ ./nexus<span class="hljs-number">-3.35</span><span class="hljs-number">.0</span><span class="hljs-number">-02</span>/bin/nexus <span class="hljs-keyword">start</span><br>  Starting nexus<br><br>  &gt; <span class="hljs-keyword">check</span> nexus status<br>  nexus@chyiyaqing-PowerEdge-R720:/opt$ netstat -lnpt | grep <span class="hljs-number">8081</span><br>  (<span class="hljs-keyword">Not</span> <span class="hljs-keyword">all</span> processes could be identified, non-<span class="hljs-keyword">owned</span> process <span class="hljs-keyword">info</span><br>   will <span class="hljs-keyword">not</span> be shown, you would have <span class="hljs-keyword">to</span> be root <span class="hljs-keyword">to</span> see it <span class="hljs-keyword">all</span>.)<br>  tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">8081</span>            <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               <span class="hljs-keyword">LISTEN</span>      <span class="hljs-number">2732557</span>/java<br><br>  &gt; <span class="hljs-keyword">Access</span> Nexus <span class="hljs-keyword">from</span> Browser<br>  $ curl http://localhost:<span class="hljs-number">8081</span><br><br>  &gt; <span class="hljs-keyword">Create</span> <span class="hljs-built_in">new</span> Repository<br>  &gt; Hosted Repository<br>  &gt; <span class="hljs-keyword">Group</span> Repository<br><br># Publish artifact <span class="hljs-keyword">to</span> Nexus Repository<br>  &gt; Upload Jar File <span class="hljs-keyword">to</span> existing hosted repository <span class="hljs-keyword">on</span> Nexus<br>  &gt; Maven/Gradle command <span class="hljs-keyword">for</span> pushing <span class="hljs-keyword">to</span> remote repository<br>  &gt; Configure <span class="hljs-keyword">both</span> tools <span class="hljs-keyword">to</span> <span class="hljs-keyword">connect</span> <span class="hljs-keyword">to</span> Nexus (Nexus Repo URL + Credentials)<br>  &gt; Nexus <span class="hljs-keyword">User</span> <span class="hljs-keyword">with</span> permission <span class="hljs-keyword">to</span> upload<br><br>  - <span class="hljs-keyword">Create</span> Nexus <span class="hljs-keyword">User</span><br>  - Gradle Project Configure <span class="hljs-keyword">with</span> Nexus<br><br># Upload Jar File <span class="hljs-keyword">to</span> Nexus<br>  - Upload Jar File <span class="hljs-keyword">to</span> existing hosted repository <span class="hljs-keyword">on</span> Nexus<br>  - Maven/Gradle command <span class="hljs-keyword">for</span> pushing <span class="hljs-keyword">to</span> remote repository<br>  - Configure <span class="hljs-keyword">both</span> tools <span class="hljs-keyword">to</span> <span class="hljs-keyword">connect</span> <span class="hljs-keyword">to</span> Nexus(Nexus Repo URL + Credentials)<br>  - Nexus <span class="hljs-keyword">User</span> <span class="hljs-keyword">with</span> permission <span class="hljs-keyword">to</span> upload<br><br># Nexus API<br>  - Query Nexus Repository <span class="hljs-keyword">for</span> different information<br>    - Use a tool <span class="hljs-keyword">like</span> **curl** <span class="hljs-keyword">or</span> **wget** <span class="hljs-keyword">to</span> <span class="hljs-keyword">execute</span> http request<br>    # List <span class="hljs-keyword">all</span> repositories<br>    $ curl -u <span class="hljs-keyword">user</span>:pwd -X <span class="hljs-keyword">GET</span> <span class="hljs-string">&#x27;http://IP:HOST/service/rest/v1/repositories&#x27;</span><br>      [ &#123;<br>        &quot;name&quot; : &quot;nuget-group&quot;,<br>        &quot;format&quot; : &quot;nuget&quot;,<br>        &quot;type&quot; : &quot;group&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/nuget-group&quot;,<br>        &quot;attributes&quot; : &#123; &#125;<br>      &#125;, &#123;<br>        &quot;name&quot; : &quot;maven-snapshots&quot;,<br>        &quot;format&quot; : &quot;maven2&quot;,<br>        &quot;type&quot; : &quot;hosted&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/maven-snapshots&quot;,<br>        &quot;attributes&quot; : &#123; &#125;<br>      &#125;, &#123;<br>        &quot;name&quot; : &quot;maven-central&quot;,<br>        &quot;format&quot; : &quot;maven2&quot;,<br>        &quot;type&quot; : &quot;proxy&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/maven-central&quot;,<br>        &quot;attributes&quot; : &#123;<br>          &quot;proxy&quot; : &#123;<br>            &quot;remoteUrl&quot; : &quot;https://repo1.maven.org/maven2/&quot;<br>          &#125;<br>        &#125;<br>      &#125;, &#123;<br>        &quot;name&quot; : &quot;nuget.org-proxy&quot;,<br>        &quot;format&quot; : &quot;nuget&quot;,<br>        &quot;type&quot; : &quot;proxy&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/nuget.org-proxy&quot;,<br>        &quot;attributes&quot; : &#123;<br>          &quot;proxy&quot; : &#123;<br>            &quot;remoteUrl&quot; : &quot;https://api.nuget.org/v3/index.json&quot;<br>          &#125;<br>        &#125;<br>      &#125;, &#123;<br>        &quot;name&quot; : &quot;maven-releases&quot;,<br>        &quot;format&quot; : &quot;maven2&quot;,<br>        &quot;type&quot; : &quot;hosted&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/maven-releases&quot;,<br>        &quot;attributes&quot; : &#123; &#125;<br>      &#125;, &#123;<br>        &quot;name&quot; : &quot;nuget-hosted&quot;,<br>        &quot;format&quot; : &quot;nuget&quot;,<br>        &quot;type&quot; : &quot;hosted&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/nuget-hosted&quot;,<br>        &quot;attributes&quot; : &#123; &#125;<br>      &#125;, &#123;<br>        &quot;name&quot; : &quot;maven-public&quot;,<br>        &quot;format&quot; : &quot;maven2&quot;,<br>        &quot;type&quot; : &quot;group&quot;,<br>        &quot;url&quot; : &quot;http://172.30.1.12:8081/repository/maven-public&quot;,<br>        &quot;attributes&quot; : &#123; &#125;<br>      &#125; ]%<br><br>    # List components<br>    ➜ curl -u <span class="hljs-keyword">admin</span>:xx -X <span class="hljs-keyword">GET</span> <span class="hljs-string">&#x27;http://172.30.1.12:8081/service/rest/v1/components?repository=maven-snapshots&#x27;</span><br><br># Blob Stores<br>  - Nexus <span class="hljs-keyword">Storage</span> <span class="hljs-keyword">to</span> store <span class="hljs-keyword">all</span> the uploaded files<br>  - <span class="hljs-keyword">Storage</span> <span class="hljs-keyword">of</span> binary files<br>  - <span class="hljs-keyword">Local</span> <span class="hljs-keyword">Storage</span> <span class="hljs-keyword">or</span> Cloud <span class="hljs-keyword">Storage</span><br>  - <span class="hljs-keyword">Type</span> field = <span class="hljs-keyword">Storage</span> Backend<br>    - File: file <span class="hljs-keyword">system</span>-based <span class="hljs-keyword">storage</span><br>    - s3: cloud-based <span class="hljs-keyword">storage</span><br></code></pre></td></tr></table></figure>
<ul>
<li>Blob Stores: Configure local and cloud blob storage<br><img src="/misc/images/nexus-blob-stores.png" alt="Nexus Blob Stores"><figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">&gt; Blob store can&#x27;t be modified<br>&gt; Blob store used <span class="hljs-keyword">by</span> a repository can&#x27;t be deleted!<br><span class="hljs-comment"># Type:</span><br><span class="hljs-comment"># State: state of the blob store</span><br>  - started: indicates <span class="hljs-keyword">it</span>&#x27;s <span class="hljs-built_in">running</span> <span class="hljs-keyword">as</span> expected<br>  - failed: indicates a configuration issue<br><span class="hljs-comment"># Blob Count: number of blobs currently stored</span><br><span class="hljs-comment"># Total Size:</span><br><span class="hljs-comment"># Available space:</span><br></code></pre></td></tr></table></figure></li>
<li>Component vs Asset<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Component:</span><br><span class="hljs-bullet">  -</span> abstract<br><span class="hljs-bullet">  -</span> what we are uploading<br><span class="hljs-section"># Asset:</span><br><span class="hljs-bullet">  -</span> actual physical packages/files<br><span class="hljs-bullet">  -</span> 1 component = 1 or more assets<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Jenkins: Build Automation</li>
<li>LDAP</li>
</ul>
<h2 id="Infrastructure-Privisioning"><a href="#Infrastructure-Privisioning" class="headerlink" title="Infrastructure Privisioning"></a>Infrastructure Privisioning</h2><ul>
<li>Containers with Docker<ul>
<li>What is a Container?<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; A way to package application with all the necessary dependencies and configuration</span><br><span class="hljs-quote">&gt; Portable artifact, easily shared and moved around</span><br><br><span class="hljs-section"># Container Technologies</span><br><span class="hljs-bullet">  -</span> Docker<br><span class="hljs-bullet">  -</span> Containerd<br><span class="hljs-bullet">  -</span> CRI-O<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Container Vs Image<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># Docker Image:</span><br>  &gt; <span class="hljs-keyword">the</span> actual package<br>  - artifact, <span class="hljs-keyword">that</span> can be moved <span class="hljs-keyword">around</span><br><br><span class="hljs-comment"># Docker Container</span><br>  &gt; actually start <span class="hljs-keyword">the</span> <span class="hljs-built_in">application</span><br>  &gt; container environment <span class="hljs-keyword">is</span> created<br>  &gt; <span class="hljs-keyword">is</span> a <span class="hljs-built_in">running</span> environment <span class="hljs-keyword">for</span> Image<br>  - virtual File system<br>  - environment configs<br>  - <span class="hljs-built_in">application</span> images<br></code></pre></td></tr></table></figure></li>
<li>Docker vs Virtual Machine<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; Operating System have 2 Layers:</span><br><span class="hljs-bullet">  -</span> OS Kernel<br><span class="hljs-bullet">  -</span> Application [Docker]<br></code></pre></td></tr></table></figure></li>
<li>Docker Architecture &amp; Components<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Docker Engine:</span><br><span class="hljs-bullet">  -</span> Server:<br><span class="hljs-bullet">    -</span> Container Runtime:<br><span class="hljs-bullet">      -</span> pull images<br><span class="hljs-bullet">      -</span> managing images &amp; containers<br><span class="hljs-bullet">    -</span> Volumes:<br><span class="hljs-bullet">      -</span> persisting data<br><span class="hljs-bullet">    -</span> Network:<br><span class="hljs-bullet">      -</span> configuring network for container communication<br><span class="hljs-bullet">    -</span> build images:<br><span class="hljs-bullet">      -</span> build own Docker images<br><span class="hljs-bullet">  -</span> API:<br><span class="hljs-bullet">    -</span> interacting with Docker Server<br><span class="hljs-bullet">  -</span> CLI:<br><span class="hljs-bullet">    -</span> Command Line Interface: client to execute docker commands<br></code></pre></td></tr></table></figure></li>
<li>Main Docker commands<figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Images</span><br><br><span class="hljs-comment"># Container</span><br><br><span class="hljs-comment"># Container Port vs. Host Port</span><br><br><span class="hljs-comment"># Debugging Docker Containers</span><br><br><span class="hljs-variable">$</span> docker exec<br>  - docker exec <span class="hljs-literal">-it</span> container_id /bin/bash<br><span class="hljs-variable">$</span> docker pull<br><span class="hljs-variable">$</span> docker run<br>  <span class="hljs-literal">-d</span> : daemon<br>  docker run <span class="hljs-literal">-d</span> <span class="hljs-literal">-p6000</span>:<span class="hljs-number">6379</span> -<span class="hljs-literal">-name</span> redis redis:latest<br><span class="hljs-variable">$</span> docker exec <span class="hljs-literal">-it</span><br><span class="hljs-variable">$</span> docker logs<br><span class="hljs-variable">$</span> docker images<br><span class="hljs-variable">$</span> docker <span class="hljs-built_in">ps</span> = list running containers<br>  <span class="hljs-literal">-a</span> : lists running and stopped container<br><span class="hljs-variable">$</span> docker run = starts new container with a command<br><span class="hljs-variable">$</span> docker <span class="hljs-built_in">start</span> = starts the container<br><span class="hljs-variable">$</span> docker stop = stops the container<br><span class="hljs-variable">$</span> docker network <span class="hljs-built_in">ls</span><br></code></pre></td></tr></table></figure></li>
<li>Demo Overview<br><img src="/misc/images/docker-demo.png" alt="Demo Workflow with Docker"><ul>
<li>Develop with Docker<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Demo project</span><br><span class="hljs-bullet">  -</span> JS and Nodejs application<br><span class="hljs-bullet">    -</span> localhost:3000/my-app<br><span class="hljs-bullet">  -</span> MongoDB Docker Container<br><span class="hljs-bullet">    -</span> localhost:3001/db/my-db<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Run multiple containers - Docker Compose</li>
<li>Build Docker Image - Dockerfile<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># What is a Dockerfile?</span><br>  - Blueprint <span class="hljs-keyword">for</span> building images<br><br><span class="hljs-comment"># FROM : Start by basing it on another image</span><br>  <span class="hljs-keyword">FROM</span> node<br><br><span class="hljs-comment"># ENV var: Optionally define environment variables</span><br>  ENV <span class="hljs-attribute">MONGO_DB_USERNAME</span>=admin \<br>      <span class="hljs-attribute">MONGO_DB_PWD</span>=password<br><br><span class="hljs-comment"># RUN : execute any linux command</span><br>  <span class="hljs-builtin-name">RUN</span> mkdir -p /home/app<br><br><span class="hljs-comment"># COPY : execute on the HOST machine</span><br>  COPY . /home/app<br><br><span class="hljs-comment"># CMD : entrypoint command</span><br>  CMD [<span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;server.js&quot;</span>]<br><br>$ docker build -t my-app:version-1 .<br>$ docker <span class="hljs-builtin-name">run</span> my-app:version-1<br></code></pre></td></tr></table></figure></li>
<li>Push to private Docker Repository<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Docker private repository</span><br>  - Harbar:<br><br><span class="hljs-comment"># build &amp; tag an images</span><br>  docker tag chyiyaqing<span class="hljs-regexp">/alpine_sl harbor.chyidl.com/</span>chyiyaqing/alpine_sl<br><br><span class="hljs-comment"># docker login</span><br>  ➜ docker login -u admin -p macintosh harbor.chyidl.com<br>  WARNING! Using --password via the CLI is insecure. Use --password-stdin.<br>  WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> <span class="hljs-regexp">/home/</span>chyiyaqing<span class="hljs-regexp">/.docker/</span>config.json.<br>  Configure a credential helper to remove this warning. See<br>  https:<span class="hljs-regexp">//</span>docs.docker.com<span class="hljs-regexp">/engine/</span>reference<span class="hljs-regexp">/commandline/</span>login/<span class="hljs-comment">#credentials-store</span><br><br>  Login Succeeded<br><br><span class="hljs-comment"># docker push</span><br>  ➜ docker push harbor.chyidl.com<span class="hljs-regexp">/chyiyaqing/</span>alpine_sl<br>  Using default tag: latest<br>  The push refers to repository [harbor.chyidl.com<span class="hljs-regexp">/chyiyaqing/</span>alpine_sl]<br>  <span class="hljs-number">102</span>b73ff0977: Pushed<br>  e2eb06d8af82: Pushed<br>  latest: digest: sha256:<span class="hljs-number">500</span>e9b9536a4fec460c487867d3cd7084da934ba37151aa122f4be438cc06d57 size: <span class="hljs-number">739</span><br></code></pre></td></tr></table></figure></li>
<li>Persist data in Docker - Volumes<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># When do we need Docker Volumes?</span><br>  &gt; For data persistence<br><br><span class="hljs-comment"># What is Docker Volumes</span><br><br><span class="hljs-comment"># 3 Volumes Types</span><br>  - Host Volumes (you decide where on the host file system the reference is made)<br>    - -v <span class="hljs-regexp">/home/m</span>ount<span class="hljs-regexp">/data:/</span>var<span class="hljs-regexp">/lib/my</span>sql/data<br><br>  - Anonymous Volumes (automatically created by Docker)<br>    - -v <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/mysql/</span>data<br><br>  - Named Volumes<br>    - -v name:<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/mysql/</span>data<br><br><span class="hljs-comment"># Docker Volume Locations</span><br>  - Windows: C:\ProgramData\docker\volumes<br>  - Linux: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>volumes<br>  - MacOS: <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>volumes<br><br><span class="hljs-comment"># Docker for Mac</span><br>  &gt; creates a Linux virtual machine and stores all the Docker data here<br></code></pre></td></tr></table></figure></li>
<li>Push/Pull Nexus Repository<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Docker login to Nexus Docker Repo</span><br>  chyiyaqing <span class="hljs-keyword">in</span> ~ at chyiyaqing-PowerEdge-R720<br>  ➜ docker login <span class="hljs-number">172.30</span>.<span class="hljs-number">1.12</span>:<span class="hljs-number">8083</span><br>  Username: chyi<br>  Password:<br>  WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> <span class="hljs-regexp">/home/</span>chyiyaqing<span class="hljs-regexp">/.docker/</span>config.json.<br>  Configure a credential helper to remove this warning. See<br>  https:<span class="hljs-regexp">//</span>docs.docker.com<span class="hljs-regexp">/engine/</span>reference<span class="hljs-regexp">/commandline/</span>login/<span class="hljs-comment">#credentials-store</span><br><br>  Login Succeeded<br><br><span class="hljs-comment"># Push Images to Nexus Repo</span><br>  ➜ docker tag ubuntu:latest <span class="hljs-number">172.30</span>.<span class="hljs-number">1.12</span>:<span class="hljs-number">8083</span>/ubuntu:latest<br><br>  chyiyaqing <span class="hljs-keyword">in</span> ~ at chyiyaqing-PowerEdge-R720<br>  ➜ docker push <span class="hljs-number">172.30</span>.<span class="hljs-number">1.12</span>:<span class="hljs-number">8083</span>/ubuntu:latest<br>  The push refers to repository [<span class="hljs-number">172.30</span>.<span class="hljs-number">1.12</span>:<span class="hljs-number">8083</span>/ubuntu]<br>  <span class="hljs-number">9</span>f54eef41275: Pushed<br>  latest: digest: sha256:<span class="hljs-number">7</span>cc0576c7c0ec2384de5cbf245f41567e922aab1b075f3e8ad565f508032df17 size: <span class="hljs-number">529</span><br><br><span class="hljs-comment"># Fetch Docker Image from Nexus</span><br>  chyiyaqing <span class="hljs-keyword">in</span> ~ at chyiyaqing-PowerEdge-R720 took <span class="hljs-number">7</span>s<br>  ➜ curl -u chyi:macintosh -X GET <span class="hljs-string">&#x27;http://172.30.1.12:8081/service/rest/v1/components?repository=docker-hosted&#x27;</span><br>  &#123;<br>    <span class="hljs-string">&quot;items&quot;</span> : [ &#123;<br>      <span class="hljs-string">&quot;id&quot;</span> : <span class="hljs-string">&quot;ZG9ja2VyLWhvc3RlZDo3MWIyYzQyZWUyMjFkZTJlNzZlYTY4YjNmMGY1MTQ4Mw&quot;</span>,<br>      <span class="hljs-string">&quot;repository&quot;</span> : <span class="hljs-string">&quot;docker-hosted&quot;</span>,<br>      <span class="hljs-string">&quot;format&quot;</span> : <span class="hljs-string">&quot;docker&quot;</span>,<br>      <span class="hljs-string">&quot;group&quot;</span> : null,<br>      <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;ubuntu&quot;</span>,<br>      <span class="hljs-string">&quot;version&quot;</span> : <span class="hljs-string">&quot;latest&quot;</span>,<br>      <span class="hljs-string">&quot;assets&quot;</span> : [ &#123;<br>        <span class="hljs-string">&quot;downloadUrl&quot;</span> : <span class="hljs-string">&quot;http://172.30.1.12:8081/repository/docker-hosted/v2/ubuntu/manifests/latest&quot;</span>,<br>        <span class="hljs-string">&quot;path&quot;</span> : <span class="hljs-string">&quot;v2/ubuntu/manifests/latest&quot;</span>,<br>        <span class="hljs-string">&quot;id&quot;</span> : <span class="hljs-string">&quot;ZG9ja2VyLWhvc3RlZDoyNjlmOTEwOWZiZmIyMzlmNTc1OTU2MGQ1NmZjZTQ5Nw&quot;</span>,<br>        <span class="hljs-string">&quot;repository&quot;</span> : <span class="hljs-string">&quot;docker-hosted&quot;</span>,<br>        <span class="hljs-string">&quot;format&quot;</span> : <span class="hljs-string">&quot;docker&quot;</span>,<br>        <span class="hljs-string">&quot;checksum&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;sha1&quot;</span> : <span class="hljs-string">&quot;064d46bcae0d9c485376fbeabeed1f3e4f1c8679&quot;</span>,<br>          <span class="hljs-string">&quot;sha256&quot;</span> : <span class="hljs-string">&quot;7cc0576c7c0ec2384de5cbf245f41567e922aab1b075f3e8ad565f508032df17&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;contentType&quot;</span> : <span class="hljs-string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span>,<br>        <span class="hljs-string">&quot;lastModified&quot;</span> : <span class="hljs-string">&quot;2021-11-13T06:33:59.622+00:00&quot;</span>,<br>        <span class="hljs-string">&quot;blobCreated&quot;</span> : <span class="hljs-string">&quot;2021-11-13T06:33:59.622+00:00&quot;</span>,<br>        <span class="hljs-string">&quot;lastDownloaded&quot;</span> : null<br>      &#125; ]<br>    &#125; ],<br>    <span class="hljs-string">&quot;continuationToken&quot;</span> : null<br>  &#125;%<br></code></pre></td></tr></table></figure></li>
<li>Run Nexus as Docker Container<figure class="highlight xl"><table><tr><td class="code"><pre><code class="hljs xl"># Persistent Data<br>  $ docker volume create --<span class="hljs-keyword">name</span> nexus-<span class="hljs-keyword">data</span><br>  $ docker run -d -p <span class="hljs-number">8081</span>:<span class="hljs-number">8081</span> --<span class="hljs-keyword">name</span> nexus -v nexu-<span class="hljs-keyword">data</span>:/nexus-<span class="hljs-keyword">data</span> sonatype/nexus3<br>    -d = detached, run <span class="hljs-built_in">in</span> <span class="hljs-built_in">background</span><br>    -p <span class="hljs-number">8081</span>:<span class="hljs-number">8081</span> = make accessible <span class="hljs-built_in">at</span> <span class="hljs-number">8081</span><br>    --<span class="hljs-keyword">name</span> = container <span class="hljs-keyword">name</span><br>    -v = volume(named volume here)<br><br>  chyi <span class="hljs-built_in">in</span> ~ <span class="hljs-built_in">at</span> k8s-master<br>  ➜ netstat -lnpt | grep <span class="hljs-number">8081</span><br>  (Not all processes could be identified, non-owned process info<br>   will <span class="hljs-built_in">not</span> be shown, you would have to be root to see it all.)<br>  tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">8081</span>            <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      -<br><br>  chyi <span class="hljs-built_in">in</span> ~ <span class="hljs-built_in">at</span> k8s-master<br>  ➜ docker ps<br>  CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                    NAMES<br>  <span class="hljs-number">8630</span><span class="hljs-function"><span class="hljs-title">fd5d8faa</span>   sonatype/nexus3   &quot;sh -c $&#123;SONATYPE_DI…&quot;   26 seconds ago   Up 23 seconds   0.0.0.0:8081-&gt;</span><span class="hljs-number">8081</span>/tcp   nexus<br><br>chyi <span class="hljs-built_in">in</span> ~ <span class="hljs-built_in">at</span> k8s-master<br>➜ docker volume ls<br>DRIVER    VOLUME NAME<br>local     nexus-<span class="hljs-keyword">data</span><br><br>chyi <span class="hljs-built_in">in</span> ~ <span class="hljs-built_in">at</span> k8s-master<br>➜ docker inspect nexus-<span class="hljs-keyword">data</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;CreatedAt&quot;</span>: <span class="hljs-string">&quot;2021-11-13T15:09:41+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Mountpoint&quot;</span>: <span class="hljs-string">&quot;/mnt/INNERDISK/docker/volumes/nexus-data/_data&quot;</span>,<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;nexus-data&quot;</span>,<br>        <span class="hljs-string">&quot;Options&quot;</span>: &#123;&#125;,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span><br>    &#125;<br>]<br><br>chyi <span class="hljs-built_in">in</span> ~ <span class="hljs-built_in">at</span> k8s-master<br>➜ ls /mnt/INNERDISK/docker/volumes/nexus-<span class="hljs-keyword">data</span>/_<span class="hljs-keyword">data</span><br>blobs  db             etc                instances  karaf.pid  lock  orient  restore-from-backup<br>cache  elasticsearch  generated-bundles  javaprefs  keystores  <span class="hljs-built_in">log</span>   port    tmp<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Build-Automation-amp-CI-CD-with-Jenkins"><a href="#Build-Automation-amp-CI-CD-with-Jenkins" class="headerlink" title="Build Automation &amp; CI/CD with Jenkins"></a>Build Automation &amp; CI/CD with Jenkins</h2><ul>
<li><p>Introduction to Build Automation</p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><code class="hljs n1ql"># What is <span class="hljs-keyword">Build</span> Automation?<br>  Test Code -&gt; <span class="hljs-keyword">Build</span> Application -&gt; Push <span class="hljs-keyword">to</span> Repository -&gt; Deploy <span class="hljs-keyword">to</span> Server<br><br># What <span class="hljs-keyword">is</span> Jenkins?<br><br># What can you <span class="hljs-keyword">do</span> <span class="hljs-keyword">with</span> Jenkins?<br>  Run tests<br>  <span class="hljs-keyword">Build</span> artifacts<br>  Publish artifacts<br>  Deploy artifacts<br>  Send notifactions<br><br># Integration <span class="hljs-keyword">with</span> other technologies<br>  Docker<br>  Repositories<br>  <span class="hljs-keyword">Build</span> Tools<br>  Deployment Servers<br><br># What <span class="hljs-keyword">do</span> you need <span class="hljs-keyword">to</span> configure?<br>  Run test -- <span class="hljs-keyword">Build</span> Tools need <span class="hljs-keyword">to</span> be available<br>  <span class="hljs-keyword">Build</span> Application -- <span class="hljs-keyword">Build</span> Tools <span class="hljs-keyword">or</span> Docker available<br>  Publish Docker Image -- Store Credentials <span class="hljs-keyword">in</span> Jenkins<br></code></pre></td></tr></table></figure></li>
<li><p>Deploy Jenkins on DigitalOcean server</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle"># Install Jenkins directly on OS<br># Run Jenkins as Docker container<br>  $ docker run -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -p <span class="hljs-number">50000</span>:<span class="hljs-number">50000</span> -d -v jenkins_home:<span class="hljs-regexp">/var/</span>jenkins_home jenkins/jenkins:lts<br><br>  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took <span class="hljs-number">15</span>s<br>  ➜ docker ps | <span class="hljs-keyword">grep</span> jenkins<br>  e01cdfdb64f1   jenkins<span class="hljs-regexp">/jenkins:lts                                             &quot;/</span>sbin<span class="hljs-regexp">/tini -- /u</span>sr<span class="hljs-regexp">/…&quot;   14 seconds ago       Up 12 seconds                      0.0.0.0:8080-&gt;8080/</span>tcp, :::<span class="hljs-number">8080</span>-&gt;<span class="hljs-number">8080</span><span class="hljs-regexp">/tcp, 0.0.0.0:50000-&gt;50000/</span>tcp, :::<span class="hljs-number">50000</span>-&gt;<span class="hljs-number">50000</span>/tcp                                    brave_mcnulty<br><br>  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720<br>  ➜ docker volume <span class="hljs-keyword">inspect</span> jenkins_home<br>  [<br>      &#123;<br>          <span class="hljs-string">&quot;CreatedAt&quot;</span>: <span class="hljs-string">&quot;2021-11-14T02:04:28+08:00&quot;</span>,<br>          <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>          <span class="hljs-string">&quot;Labels&quot;</span>: <span class="hljs-keyword">null</span>,<br>          <span class="hljs-string">&quot;Mountpoint&quot;</span>: <span class="hljs-string">&quot;/var/lib/docker/volumes/jenkins_home/_data&quot;</span>,<br>          <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;jenkins_home&quot;</span>,<br>          <span class="hljs-string">&quot;Options&quot;</span>: <span class="hljs-keyword">null</span>,<br>          <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span><br>      &#125;<br>  ]<br></code></pre></td></tr></table></figure></li>
<li><p>Roles of Jenkins</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># Jenkins Administrator (Operations or DevOps teams)</span><br>  - administers <span class="hljs-keyword">and </span>manages <span class="hljs-keyword">Jenkins</span><br><span class="hljs-keyword"></span>  - sets up <span class="hljs-keyword">Jenkins </span>cluster<br>  - <span class="hljs-keyword">installs </span>plugins<br>  - <span class="hljs-keyword">backup </span><span class="hljs-keyword">Jenkins </span>data<br><br><span class="hljs-comment"># Jenkins User (Developer or DevOps teams)</span><br>  - creating the actual <span class="hljs-keyword">jobs </span>to run workflows<br></code></pre></td></tr></table></figure></li>
<li><p>Install and use Build Tools in Jenkins</p>
<figure class="highlight less"><table><tr><td class="code"><pre><code class="hljs less"># <span class="hljs-selector-tag">Create</span> <span class="hljs-selector-tag">Job</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">automate</span> <span class="hljs-selector-tag">your</span> <span class="hljs-selector-tag">apps</span> <span class="hljs-selector-tag">workflow</span><br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Java</span> <span class="hljs-selector-tag">App</span> (Maven)<br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Java</span> <span class="hljs-selector-tag">App</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">Maven</span> <span class="hljs-selector-tag">Build</span> <span class="hljs-selector-tag">Tool</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Run</span> <span class="hljs-selector-tag">Tests</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Build</span> <span class="hljs-selector-tag">Jar</span> <span class="hljs-selector-tag">File</span><br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">JavaScript</span> <span class="hljs-selector-tag">App</span> (npm)<br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Node</span> <span class="hljs-selector-tag">App</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Run</span> <span class="hljs-selector-tag">Tests</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Package</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">push</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">Repo</span><br><br># <span class="hljs-selector-tag">2</span> <span class="hljs-selector-tag">ways</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">configure</span> <span class="hljs-selector-tag">those</span> <span class="hljs-selector-tag">tools</span><br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Jenkins</span> <span class="hljs-selector-tag">Plugins</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">just</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">plugin</span> (via UI) <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">your</span> <span class="hljs-selector-tag">tool</span><br><br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Install</span> <span class="hljs-selector-tag">Tools</span> <span class="hljs-selector-tag">directly</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">Server</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">enter</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">remote</span> <span class="hljs-selector-tag">server</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">install</span><br>    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">inside</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">Docker</span> <span class="hljs-selector-tag">container</span>, <span class="hljs-keyword">when</span> Jenkins runs as container<br><br># Install npm <span class="hljs-keyword">and</span> Node in Jenkins container<br>  chyiyaqing in ~ at chyiyaqing-PowerEdge-R720 took <span class="hljs-number">19s</span><br>  ➜ docker exec -u <span class="hljs-number">0</span> -it e01cdfdb64f1 bash (root user)<br>  root<span class="hljs-variable">@e01cdfdb64f1</span>:/# cat /etc/issue<br>  Debian GNU/Linux <span class="hljs-number">11</span> \n \l<br><br>  root<span class="hljs-variable">@e01cdfdb64f1</span>:/# sed -i <span class="hljs-string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list (替换国内源)<br>  root<span class="hljs-variable">@e01cdfdb64f1</span>:/# curl -sL <span class="hljs-attribute">https</span>:<span class="hljs-comment">//deb.nodesource.com/setup_16.x -o nodesource_setup.sh</span><br>  root<span class="hljs-variable">@e01cdfdb64f1</span>:/# ls<br>  bin  boot  dev	etc  home  lib	lib64  media  mnt  nodesource_setup.sh	opt  proc  root  run  sbin  srv  sys  tmp  usr	var<br>  root<span class="hljs-variable">@e01cdfdb64f1</span>:/# bash nodesource_setup.sh<br><br>  ## Installing the NodeSource Node.js <span class="hljs-number">16</span>.x repo...<br></code></pre></td></tr></table></figure></li>
<li><p>Create Freestyle Job</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> Plugins<br><span class="hljs-bullet">-</span> Credentials<br><span class="hljs-bullet">-</span> Configure Git Repository<br><br><span class="hljs-bullet">-</span> Plugin Configuration<br><span class="hljs-bullet">  1.</span> Install directly on Server: more flexible<br><span class="hljs-bullet">  2.</span> Plugin: limited to provided input fields<br></code></pre></td></tr></table></figure></li>
<li><p>Docker in Jenkins</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><code class="hljs gams">chyiyaqing in ~/chyi at chyiyaqing-PowerEdge-R720<br>➜ docker run -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -p <span class="hljs-number">50000</span>:<span class="hljs-number">50000</span> -d \<br>➜ -v jenkins_home:/var/jenkins_home \<br>➜ -v /var/run/docker.sock:/var/run/docker.sock \<br>➜ -v <span class="hljs-symbol">$</span>(which docker):/usr/bin/docker jenkins/jenkins:lts<br><span class="hljs-number">9</span>b9acf0e8c13519d3bc5a96b8e7b2d251374e7112a796d2b9cc55e8ee53361a1<br><br>jenkins@<span class="hljs-number">9</span>b9acf0e8c13:/<span class="hljs-symbol">$</span> docker pull redis<br><span class="hljs-keyword">Using</span> default tag: latest<br>Got permission denied <span class="hljs-keyword">while</span> trying to connect to the Docker daemon socket at unix:<span class="hljs-comment">///var/run/docker.sock: Post &quot;http://%2Fvar%2Frun%2Fdocker.sock/v1.24/images/create?fromImage=redis&amp;tag=latest&quot;: dial unix /var/run/docker.sock: connect: permission denied</span><br>jenkins@<span class="hljs-number">9</span>b9acf0e8c13:/<span class="hljs-symbol">$</span><br><br># Build Docker Image<br><br># Push Image to DockerHub<br>  - Create DockerHub account<br>  - Configure that credentials in Jenkins<br><br># Push Docker Image to Nexus Repository<br><br># Freestyle to Pipeline Job<br>  - Freestyle Job with multiple Steps<br>    - Build Java App -&gt; Run Tests -&gt; Build Image -&gt; Push to private Repo<br><br># Pipeline Job<br>  - Pipeline script<br>    - Script is written in Groovy<br>    - Programming Language similar to Java<br><br>  - Required Fields of Jenkinsfile<br>    # pipeline must be top-level<br>    pipeline &#123;<br>        <span class="hljs-comment">// agent where to execute</span><br>        agent any<br><br>        <span class="hljs-comment">// Access Build Tools for your projects</span><br>        tools &#123;<br>          <span class="hljs-comment">// Only 3 Build tools available: gradle, maven and JDK!</span><br>        &#125;<br>        environment &#123;<br>          NEW_VERSION = <span class="hljs-string">&quot;1.0&quot;</span><br>          SERVER_CREDENTIALS = credential(<span class="hljs-string">&#x27;server-credentials&#x27;</span>)<br>        &#125;<br>        <span class="hljs-keyword">parameters</span> &#123;<br>          string(name: <span class="hljs-string">&#x27;VERSION&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;&#x27;</span>, description: <span class="hljs-string">&#x27;version to deploy on prod&#x27;</span>)<br>          choice(name: <span class="hljs-string">&#x27;VERSION&#x27;</span>, choices: [<span class="hljs-string">&#x27;1.1.0&#x27;</span>, <span class="hljs-string">&#x27;1.2.0&#x27;</span>], description: <span class="hljs-string">&#x27;&#x27;</span>)<br>        &#125;<br><br>        <span class="hljs-comment">// stages - where the work happens</span><br>        stages <span class="hljs-comment">&#123;</span><br>            stage(<span class="hljs-string">&quot;build&quot;</span>) &#123;<br>              when <span class="hljs-comment">&#123;</span><br>                expression <span class="hljs-comment">&#123;</span><br>                  expression <span class="hljs-comment">&#123;</span><br>                    BRANCH_NAME <span class="hljs-comment">==</span> <span class="hljs-comment">&quot;dev&quot;</span> || <span class="hljs-comment">CODE_CHANGES == true</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>                steps <span class="hljs-comment">&#123;</span><br>                  echo <span class="hljs-comment">&#x27;building the application...&#x27;</span><br>                  echo <span class="hljs-comment">&quot;building version $&#123;NEW_VERSION&#125;&quot;</span><br>                &#125;<br>            &#125;<br><br>            stage(<span class="hljs-string">&quot;test&quot;</span>) &#123;<br>              when <span class="hljs-comment">&#123;</span><br>                expression <span class="hljs-comment">&#123;</span><br>                  expression <span class="hljs-comment">&#123;</span><br>                    BRANCH_NAME <span class="hljs-comment">==</span> <span class="hljs-comment">&quot;dev&quot;</span> || <span class="hljs-comment">BRANCH_NAME ==</span> <span class="hljs-comment">&quot;master&quot;</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>              steps <span class="hljs-comment">&#123;</span><br>                  echo <span class="hljs-comment">&#x27;building the application...&#x27;</span><br>              &#125;<br>            &#125;<br><br>            stage(<span class="hljs-string">&quot;deploy&quot;</span>) &#123;<br>                steps <span class="hljs-comment">&#123;</span><br>                  echo <span class="hljs-comment">&#x27;building the application...&#x27;</span><br>                  echo <span class="hljs-comment">&quot;deploying with $(SERVER_CREDENTIALS)&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// Execute some logic AFTER all stages executed</span><br>        post <span class="hljs-comment">&#123;</span><br><br>          <span class="hljs-comment">// Conditions</span><br>          always <span class="hljs-comment">&#123;</span><br><br>          &#125;<br><br>          success <span class="hljs-comment">&#123;</span><br><br>          &#125;<br><br>          failure <span class="hljs-comment">&#123;</span><br><br>          &#125;<br>        &#125;<br>    &#125;<br><br># Jenkins <span class="hljs-comment">Variables</span><br>  $ http:<span class="hljs-comment">//172.30.1.12:8080/env-vars.html/</span><br></code></pre></td></tr></table></figure></li>
<li><p>Build scripted Pipeline</p>
</li>
<li><p>Henkinsfile in detail</p>
</li>
<li><p>Configure automated versioning</p>
</li>
<li><p>Jenkins Shared Library</p>
</li>
</ul>
<h2 id="Programming"><a href="#Programming" class="headerlink" title="Programming"></a>Programming</h2><h2 id="Containers"><a href="#Containers" class="headerlink" title="Containers"></a>Containers</h2><h2 id="Container-Orchestration"><a href="#Container-Orchestration" class="headerlink" title="Container Orchestration"></a>Container Orchestration</h2><h2 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h2><h2 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a>Monitoring</h2><h2 id="Command-Line-Commands"><a href="#Command-Line-Commands" class="headerlink" title="Command Line Commands"></a>Command Line Commands</h2><ul>
<li><p>scp = secure copy</p>
<blockquote>
<p>scp <file locally> <destination></p>
</blockquote>
</li>
<li><p>netstat</p>
<blockquote>
<p>netstat -lpnt</p>
</blockquote>
</li>
</ul>
<h2 id="专业名词"><a href="#专业名词" class="headerlink" title="专业名词"></a>专业名词</h2><ul>
<li>LTS = Long Term Support</li>
</ul>
<h2 id="Wrap-Up-总结"><a href="#Wrap-Up-总结" class="headerlink" title="Wrap Up: 总结"></a>Wrap Up: 总结</h2><ul>
<li>Pipeline<br><img src="/misc/images/devops-pipeline.png" alt="Pipeline 开发流程"></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.atlassian.com/git/tutorials/atlassian-git-cheatsheet">git cheatsheet</a></li>
</ul>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
  </entry>
  <entry>
    <title>Distribute Scraping for Gophers</title>
    <url>/2021/09/03/Distribute-Scraping-for-Gophers/</url>
    <content><![CDATA[<h1 id="分布式爬虫"><a href="#分布式爬虫" class="headerlink" title="分布式爬虫"></a>分布式爬虫</h1><blockquote>
<p>分布式爬虫是一套任务分发和执行系统，常见的任务分发，因为上下游存在速度不匹配问题，需要借助消息队列</p>
</blockquote>
<span id="more"></span>

<h2 id="分布式消息队列"><a href="#分布式消息队列" class="headerlink" title="分布式消息队列"></a>分布式消息队列</h2><ul>
<li>nats<blockquote>
<p>nats是Go实现的高性能分布式消息队列，适用于高并发吞吐量的消息分发场景.</p>
</blockquote>
</li>
</ul>
]]></content>
      <categories>
        <category>Distributed Systems</category>
      </categories>
  </entry>
  <entry>
    <title>Elasticsearch Tips &amp; Tracks</title>
    <url>/2021/09/03/Elasticsearch-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h1><blockquote>
<p>Elasticsearch是一个开源的分布式搜索与分析引擎，提供近实时搜索和聚合功能<br>Elastic Stack主要应用于：搜索、日志管理、安全分析、指标分析、业务分析、应用性能监控等多个领域<br>“Search is something that any application should have.”</p>
</blockquote>
<span id="more"></span>

<h2 id="Elastic-Stack-生态圈"><a href="#Elastic-Stack-生态圈" class="headerlink" title="Elastic Stack 生态圈"></a>Elastic Stack 生态圈</h2><ul>
<li><p>解决方案:</p>
<ul>
<li>搜索</li>
<li>日志分析</li>
<li>指标分析</li>
<li>安全分析</li>
</ul>
</li>
<li><p>可视化:</p>
<ul>
<li>Kibana: 可视化分析</li>
</ul>
</li>
<li><p>存储/计算:</p>
<ul>
<li>Elasticsearch: 核心引擎,提供数据存储、搜索和聚合的能力</li>
</ul>
</li>
<li><p>数据抓取:</p>
<ul>
<li>Logstash<blockquote>
<p>开源的服务器端数据处理管道，支持从不同来源采集数据，转换数据，并将数据发送到不同的存储库中</p>
</blockquote>
</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 特性:</span><br><span class="hljs-bullet">  1.</span> 实时解析和转换数据<br><span class="hljs-code">    &gt; 从IP地址破译地理位置</span><br><span class="hljs-code">    &gt; 从PII数据匿名化，排除敏感字段</span><br><span class="hljs-code">  2. 可扩展</span><br><span class="hljs-code">  3. 可靠性安全性</span><br><span class="hljs-code">    &gt; Logstash 通过持久化队列保证至少将运行中的事件送达一次</span><br><span class="hljs-code">    &gt; 数据传输加密</span><br><span class="hljs-code">  4. 加密</span><br></code></pre></td></tr></table></figure>

<ul>
<li>Beats<blockquote>
<p>轻量级别数据采集器</p>
</blockquote>
</li>
</ul>
</li>
<li><p>X-Pack: 商业化套件</p>
</li>
</ul>
<blockquote>
<p>Elasticsearch与数据库的集成</p>
</blockquote>
<p><img src="/misc/images/Elastichsearch.png" alt="Elastichsearch"></p>
<blockquote>
<p>指标分析/日志分析</p>
</blockquote>
<ul>
<li>Data Collection(beats) -&gt; Buffering(redis,Kafkak) -&gt; Data Aggregation &amp; Processing(logstash) -&gt; Indexing &amp; storage(elasticsearch) -&gt; Analysis &amp; visualization(Kbana)</li>
</ul>
<h2 id="Elasticsearch-1"><a href="#Elasticsearch-1" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><ul>
<li><p>Elasticsearch 目录结构</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><code class="hljs ada">ubuntu <span class="hljs-keyword">in</span> ~/elasticsearch-<span class="hljs-number">7.14</span>.<span class="hljs-number">1</span> <span class="hljs-keyword">at</span> k8s-node1 took <span class="hljs-number">45</span>s<br>➜ tree -L <span class="hljs-number">1</span><br>.<br>├── bin                 <span class="hljs-comment">-- 脚本文件，包括启动elasticsearch,安装插件，运行统计数据</span><br>├── config              <span class="hljs-comment">-- elasticsearch.yml 集群配置文件，user, role based 相关配置</span><br>├── jdk                 <span class="hljs-comment">-- Java 运行环境</span><br>├── lib                 <span class="hljs-comment">-- Java 类库</span><br>├── LICENSE.txt<br>├── logs                <span class="hljs-comment">-- path.log 日志文件</span><br>├── modules             <span class="hljs-comment">-- 包含所有ES模块</span><br>├── NOTICE.txt<br>├── plugins             <span class="hljs-comment">-- 包含所有已安装插件</span><br>└── README.asciidoc<br></code></pre></td></tr></table></figure></li>
<li><p>JVM 配置</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><code class="hljs gcode"><span class="hljs-attr"># 修改JVM - config/jvm.options</span><br><span class="hljs-attr">  -Xms和Xms 最小最大内存设置成一样</span><br><span class="hljs-attr">  -Xmx不超过机器内存的50</span><span class="hljs-meta">%</span><br></code></pre></td></tr></table></figure></li>
<li><p>Run</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><code class="hljs 1c">$ bin/elasticsearch<br><span class="hljs-symbol">~ took 11m 31s</span><br><span class="hljs-symbol">➜ curl http</span>:<span class="hljs-comment">//localhost:9200</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;a714f28827d5&quot;</span>,<br>  <span class="hljs-string">&quot;cluster_name&quot;</span> : <span class="hljs-string">&quot;docker-cluster&quot;</span>,<br>  <span class="hljs-string">&quot;cluster_uuid&quot;</span> : <span class="hljs-string">&quot;96jmRuNUQxqFsGeWJjIo6g&quot;</span>,<br>  <span class="hljs-string">&quot;version&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;number&quot;</span> : <span class="hljs-string">&quot;7.14.1&quot;</span>,<br>    <span class="hljs-string">&quot;build_flavor&quot;</span> : <span class="hljs-string">&quot;default&quot;</span>,<br>    <span class="hljs-string">&quot;build_type&quot;</span> : <span class="hljs-string">&quot;docker&quot;</span>,<br>    <span class="hljs-string">&quot;build_hash&quot;</span> : <span class="hljs-string">&quot;66b55ebfa59c92c15db3f69a335d500018b3331e&quot;</span>,<br>    <span class="hljs-string">&quot;build_date&quot;</span> : <span class="hljs-string">&quot;2021-08-26T09:01:05.390870785Z&quot;</span>,<br>    <span class="hljs-string">&quot;build_snapshot&quot;</span> : false,<br>    <span class="hljs-string">&quot;lucene_version&quot;</span> : <span class="hljs-string">&quot;8.9.0&quot;</span>,<br>    <span class="hljs-string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="hljs-string">&quot;6.8.0&quot;</span>,<br>    <span class="hljs-string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="hljs-string">&quot;6.0.0-beta1&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;tagline&quot;</span> : <span class="hljs-string">&quot;You Know, for Search&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Plugin 机制对系统扩展</p>
<blockquote>
<p>Discovery Plugin<br>Analysis Plugin<br>Security Plugin<br>Management Plugin<br>Ingest Plugin<br>Mapper Plugin<br>Backup Plugin</p>
</blockquote>
<figure class="highlight clean"><table><tr><td class="code"><pre><code class="hljs clean">ubuntu <span class="hljs-keyword">in</span> ~ at k8s-node1 via 🐍 <span class="hljs-number">3.8</span><span class="hljs-number">.6</span><br>➜ elasticsearch-plugin install analysis-icu  # 分词插件<br>-&gt; Installing analysis-icu<br>-&gt; Downloading analysis-icu <span class="hljs-keyword">from</span> elastic<br>[=================================================] <span class="hljs-number">100</span>%<br>-&gt; Installed analysis-icu<br>-&gt; Please restart Elasticsearch to activate any plugins installed<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at k8s-node1 via 🐍 <span class="hljs-number">3.8</span><span class="hljs-number">.6</span> took <span class="hljs-number">23</span>s<br>➜ elasticsearch-plugin list<br>analysis-icu<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at k8s-node1 via 🐍 <span class="hljs-number">3.8</span><span class="hljs-number">.6</span><br>➜ curl http:<span class="hljs-comment">//localhost:9200/_cat/plugins</span><br>k8s-node1 analysis-icu <span class="hljs-number">7.14</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure></li>
<li><p>多集群<br><a href="/misc/code/elasticsearch/docker-compose.yml">docker-compose.yml</a></p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><code class="hljs accesslog">➜ curl -X GET <span class="hljs-string">&quot;localhost:9200/_cat/nodes?v=true&amp;pretty&quot;</span><br>ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name<br><span class="hljs-number">172.24.0.2</span>           <span class="hljs-number">41</span>          <span class="hljs-number">97</span>  <span class="hljs-number">85</span>    <span class="hljs-number">4</span>.<span class="hljs-number">28</span>    <span class="hljs-number">1</span>.<span class="hljs-number">24</span>     <span class="hljs-number">0</span>.<span class="hljs-number">43</span> cdfhilmrstw -      es01<br><span class="hljs-number">172.24.0.3</span>           <span class="hljs-number">56</span>          <span class="hljs-number">97</span>  <span class="hljs-number">85</span>    <span class="hljs-number">4</span>.<span class="hljs-number">28</span>    <span class="hljs-number">1</span>.<span class="hljs-number">24</span>     <span class="hljs-number">0</span>.<span class="hljs-number">43</span> cdfhilmrstw -      es03<br><span class="hljs-number">172.24.0.4</span>           <span class="hljs-number">27</span>          <span class="hljs-number">97</span>  <span class="hljs-number">85</span>    <span class="hljs-number">4</span>.<span class="hljs-number">28</span>    <span class="hljs-number">1</span>.<span class="hljs-number">24</span>     <span class="hljs-number">0</span>.<span class="hljs-number">43</span> cdfhilmrstw *      es02<br></code></pre></td></tr></table></figure></li>
<li><p>Kibana:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">curl</span> http://localhost:<span class="hljs-number">5601</span><br><br><span class="hljs-comment"># Kibana Plugins 插件</span><br><span class="hljs-variable">$</span> kibana<span class="hljs-literal">-plugin</span> install<br><span class="hljs-variable">$</span> kibana<span class="hljs-literal">-plugin</span> list<br><span class="hljs-variable">$</span> kibana remove<br></code></pre></td></tr></table></figure></li>
<li><p>Logstash:</p>
<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Elasticsearch-基本概念"><a href="#Elasticsearch-基本概念" class="headerlink" title="Elasticsearch 基本概念"></a>Elasticsearch 基本概念</h2><ul>
<li><p>文档 Document</p>
<blockquote>
<p>Elasticsearch 是面向文档的，文档是所有可搜索数据的最小单位<br>文档会被序列化成JSON格式，保存在Elasticsearch中<br>每个文档都有一个Unique ID</p>
</blockquote>
<figure class="highlight elm"><table><tr><td class="code"><pre><code class="hljs elm"># 文档元数据<span class="hljs-type">Metadata</span> - 标注文档的相关信息<br>  _index - 文档所属的索引名<br>  _<span class="hljs-keyword">type</span>  - 文档所属类型名<br>  _id    - 文档唯一<span class="hljs-type">ID</span><br>  _source - 文档原始<span class="hljs-type">JSON</span>数据<br>  _version - 文档的版本信息 <span class="hljs-comment">-- 解决并发读写冲突</span><br>  _score  - 相关性打分<br></code></pre></td></tr></table></figure></li>
<li><p>索引 Index</p>
<blockquote>
<p>将文档写入Elasticsearch的过程叫索引indexing</p>
</blockquote>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Mapping:</span> 定义包含的文档的字段名和字段类型<br><span class="hljs-symbol">Setting:</span> 定义不同数据分布<br><span class="hljs-symbol">Shard:</span> 索引中的数据分散在Shards上<br></code></pre></td></tr></table></figure></li>
<li><p>节点 Node</p>
<blockquote>
<p>节点是Elasticsearch 实例</p>
</blockquote>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh">-E node.<span class="hljs-attr">name=</span>node1<br>每个节点启动后，会分配一个UID，保存在data目录下<br><br><span class="hljs-comment"># Master-eligible nodes 和 Master Node</span><br>  <span class="hljs-number">1</span>. 节点启动默认是一个<span class="hljs-literal">Master</span>-eligible节点, -E node.<span class="hljs-literal">master</span>:<span class="hljs-literal">false</span> 禁止<br>  <span class="hljs-number">2</span>. <span class="hljs-literal">Master</span>-eligible节点可以参加选主流程，称为<span class="hljs-literal">Master</span>节点<br>  <span class="hljs-number">3</span>. 每个节点都保存集群状态，只有<span class="hljs-literal">master</span>节点才能修改集群状态<br><br><span class="hljs-comment"># 集群状态 Cluster State</span><br>  <span class="hljs-number">1</span>. 所有节点信息<br>  <span class="hljs-number">2</span>. 所有的索引和相关Mapping 与 Setting信息<br>  <span class="hljs-number">3</span>. 分片的路由信息<br><br><span class="hljs-comment"># Data Node &amp; Coordinating Node</span><br>  <span class="hljs-number">1</span>. Data <span class="hljs-keyword">Node</span><span class="hljs-title">: 可以保存数据的节点，保存分片数据</span><br><span class="hljs-title">  2</span>. Coordinating <span class="hljs-keyword">Node</span><span class="hljs-title">: 负责接受Client</span>请求，将请求分发到合适的节点，最终把结果汇集到一起<br><br><span class="hljs-comment"># Hot &amp; Warm Node</span><br><span class="hljs-comment"># Machine Learning Node</span><br><span class="hljs-comment"># Tribe Node</span><br></code></pre></td></tr></table></figure></li>
<li><p>分片 Primary Shard &amp; Replica Shard</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section">#主分片: 解决数据水平扩展的问题</span><br><span class="hljs-bullet">  1.</span> 一个分片是一个运行的Lucene的实例<br><span class="hljs-bullet">  2.</span> 主分片在索引创建时指定，后续不允许修改,使用 Reindex修改<br><br><span class="hljs-section">#副本: 解决数据高可用的问题</span><br><span class="hljs-bullet">  1.</span> 副本分片数，可以动态调整<br><span class="hljs-bullet">  2.</span> 增加副本数，可以在一定程度上提高服务的可用性 (读取的吞吐)<br><br><span class="hljs-section">#分片设定-容量规划</span><br><span class="hljs-bullet">  1.</span> 分片数设置过小:<br><span class="hljs-code">    a. 后续无法增加节点实现水平扩展</span><br><span class="hljs-code">    b. 单个分片的数据量过大，导致数据重新分配耗时</span><br><span class="hljs-code">  2. 分片设置过大:</span><br><span class="hljs-code">    a. 影响搜索结果的相关性打分，影响统计结果准确性</span><br><span class="hljs-code"></span><br><span class="hljs-section"># 查看集群状态</span><br>  Green: 主分片和副片正常<br>  Yellow: 主分片正常，副片不正常<br>  Red: 主分片未能分配<br></code></pre></td></tr></table></figure></li>
<li><p>Elasticsearch vs 关系型数据库 抽象与类比</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">RDBMS</th>
<th align="left">Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Table</td>
<td align="left">Index</td>
</tr>
<tr>
<td align="left">Row</td>
<td align="left">Document</td>
</tr>
<tr>
<td align="left">Column</td>
<td align="left">Field</td>
</tr>
<tr>
<td align="left">Schema</td>
<td align="left">Mapping</td>
</tr>
<tr>
<td align="left">SQL</td>
<td align="left">DSL</td>
</tr>
</tbody></table>
<ul>
<li><p>文档Document CRUD</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>create document. 自动生成_id<br>POST users/_doc<br>&#123;<br>  <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;Mike&quot;</span>,<br>  <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;trying out Kibana&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>create document. 指定Id, 如果ID已经存在，报错<br>PUT users<span class="hljs-regexp">/_doc/</span><span class="hljs-number">1</span>?op_type=create<br>&#123;<br>  <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;Jack&quot;</span>,<br>  <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;trying out Elasticsearch&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>create document. 指定Id, 如果ID已经存在，报错<br>PUT users<span class="hljs-regexp">/_create/</span><span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;Jack&quot;</span>,<br>  <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;trying out Elasticsearch&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span> Get the document by ID<br>GET users<span class="hljs-regexp">/_doc/</span><span class="hljs-number">1</span><br><br><span class="hljs-regexp">//</span> Index<br>PUT users<span class="hljs-regexp">/_doc/</span><span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;Mike&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>Update 在原文档上增加字段<br>POST users<span class="hljs-regexp">/_update/</span><span class="hljs-number">1</span>/<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>:&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;trying out Elasticsearch 3&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><ul>
<li>Bulk API<figure class="highlight n1ql"><table><tr><td class="code"><pre><code class="hljs n1ql">1. 支持在一次API调用中，对不同的索引进行操作<br>2. 支持四种类型操作:<br>  <span class="hljs-keyword">Index</span><br>  <span class="hljs-keyword">Create</span><br>  <span class="hljs-keyword">Update</span><br>  <span class="hljs-keyword">Delete</span><br><span class="hljs-number">3.</span> 操作单条操作失败，不会影响其他操作<br><span class="hljs-number">4.</span> 返回结果包括每一条操作的执行结果<br><br>//Bulk操作<br>POST _bulk<br>&#123;<span class="hljs-string">&quot;index&quot;</span>: &#123;<span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;field1&quot;</span>: <span class="hljs-string">&quot;value1&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;delete&quot;</span>: &#123;<span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;create&quot;</span>: &#123;<span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test2&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;field1&quot;</span>: <span class="hljs-string">&quot;value3&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;update&quot;</span>: &#123;<span class="hljs-string">&quot;_id&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;doc&quot;</span>: &#123;<span class="hljs-string">&quot;field2&quot;</span>: <span class="hljs-string">&quot;value2&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>mget</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//mg</span>et -- 批量读取<br><span class="hljs-regexp">//</span>可以减少网络连接，提高性能<br>GET _mget<br>&#123;<br>  <span class="hljs-string">&quot;docs&quot;</span>: [<br>    &#123;<span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;users&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>:<span class="hljs-number">1</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;comment&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>:<span class="hljs-number">1</span>&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Elasticsearch-原理"><a href="#Elasticsearch-原理" class="headerlink" title="Elasticsearch 原理"></a>Elasticsearch 原理</h2><ul>
<li>图书和搜索引擎类比</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Type</th>
<th align="left">正排索引</th>
<th align="left">倒排索引</th>
</tr>
</thead>
<tbody><tr>
<td align="left">图书</td>
<td align="left">目录页</td>
<td align="left">索引页</td>
</tr>
<tr>
<td align="left">搜索引擎</td>
<td align="left">文档ID-&gt;文档内容和单词的关联</td>
<td align="left">单词到文档ID的关系</td>
</tr>
</tbody></table>
<ul>
<li><p>Elasticsearch 倒排索引</p>
<blockquote>
<p>Elasticsearch的JSON文档中每个字段，都有自己的倒排索引</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 单词词典(Term Dictionary)</span><br><span class="hljs-quote">&gt; 记录所有文档的单词，记录单词到倒排列表的关联关系</span><br><span class="hljs-quote">&gt; 通过B+树或哈希链表实现，满足高性能的插入与查询</span><br><br><span class="hljs-section"># 倒排列表(Posting List)</span><br><span class="hljs-quote">&gt; 记录单词对应的文档结合</span><br><span class="hljs-bullet">  -</span> 倒排索引项(Posting)<br><span class="hljs-bullet">    -</span> 文档ID<br><span class="hljs-bullet">    -</span> 词频TF - 单词在文档出现的次数<br><span class="hljs-bullet">    -</span> 位置Position - 单词在文档中分词的位置，用于语句搜索 phrase query<br><span class="hljs-bullet">    -</span> 偏移Offset - 记录单词的开始结束位置，实现高量显示<br></code></pre></td></tr></table></figure></li>
<li><p>Elasticsearch 分词器</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Analysis</span><br>  - Analysis: 文本分析是把全文本转换一系列单词 term/token的过程<br>  - Analysis是通过Analyzer实现<br><br><span class="hljs-comment"># Analyzer:</span><br>  - Character Filters: 针对原始文本处理<br>    - HTML strip - 去除html标签<br>    - Mapping - 字符串替换<br>    - Pattern repalce - 正则匹配替换<br><br>  - Tokenizer: 将原始的文本按照一定的规则，切分为词 term or token<br>    - whitespace<br>    - standard<br>    - uax_url_email<br>    - pattern<br>    - keyward<br>    - path hierarchy<br><br>  - Token Filter: 将切分的单词进行加工，小写，删除stopwords,增加同义词<br>    - Lowercase<br>    - stop<br><br><span class="hljs-comment"># Elasticsearch内置分词器</span><br><span class="hljs-regexp">//</span>默认分词器 standard<br><span class="hljs-regexp">//</span> 按词切分，小写处理<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>Simple Analyzer<br><span class="hljs-regexp">//</span> 按照非字母切分，非字母被去除<br><span class="hljs-regexp">//</span> 小写处理<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;simple&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span> Whitespace Analyzer<br><span class="hljs-regexp">//</span> 按照空格切分<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;whitespace&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span> Stop Analyzer<br><span class="hljs-regexp">//</span> stop filter: 去除the, a, is 修饰性词<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;stop&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>Keyward Analyzer<br><span class="hljs-regexp">//</span>不分词，直接将输入当输出<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>正则表达式进行分词<br><span class="hljs-regexp">//</span>默认非字符的符号进行分隔<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;pattern&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span>english<br>GET _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;english&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span><br>&#125;<br><br><span class="hljs-regexp">//</span> analysis_icu<br><span class="hljs-regexp">//</span> elasticsearch-plugin install analysis_icu<br>POST _analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;icu_analyzer&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>:<span class="hljs-string">&quot;他说的确实在理&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Search API</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># URI Search - 通过URI query实现搜索</span><br>  q: 指定查询语句, 使用Query String Syntax<br>  df: 默认字段, 不指定会对所有字段进行查询<br>  Sort: 排序/from 和 size 用于分页<br>  Profile: 查看查询是如何被执行<br><br>  <span class="hljs-number">1</span>. 指定字段 vs. 泛查询<br>  <span class="hljs-regexp">//</span>带profile 普通查询<br>  GET <span class="hljs-regexp">/movies/</span>_search?q=<span class="hljs-number">2012</span>&amp;df=title<br>  &#123;<br>    <span class="hljs-string">&quot;profile&quot;</span>: <span class="hljs-string">&quot;true&quot;</span><br>  &#125;<br><br>  <span class="hljs-regexp">//</span>带profile 泛查询<br>  GET <span class="hljs-regexp">/movies/</span>_search?q=<span class="hljs-number">2012</span><br>  &#123;<br>    <span class="hljs-string">&quot;profile&quot;</span>: <span class="hljs-string">&quot;true&quot;</span><br>  &#125;<br><br>  <span class="hljs-regexp">//</span>带profile 指定字段<br>  GET <span class="hljs-regexp">/movies/</span>_search?q=title:<span class="hljs-number">2012</span><br>  &#123;<br>    <span class="hljs-string">&quot;profile&quot;</span>: <span class="hljs-string">&quot;true&quot;</span><br>  &#125;<br><br>  <span class="hljs-number">2</span>. Term vs. Phrase<br>    <span class="hljs-comment"># Term: Beautiful Mind 等效于 Beautiful OR Mind</span><br>    <span class="hljs-comment"># Phrase: &quot;Beautifuk Mind&quot; 等效于 Beautiful And Mind, 前后顺序保持一致</span><br>  <span class="hljs-regexp">//</span>使用引号 查询<br>  GET <span class="hljs-regexp">/movies/</span>_search?q=title:<span class="hljs-string">&quot;Beautiful Mind&quot;</span><br>  &#123;<br>    <span class="hljs-string">&quot;profile&quot;</span>:<span class="hljs-string">&quot;true&quot;</span><br>  &#125;<br><br>  <span class="hljs-regexp">//</span>使用引号 Mind 泛 查询<br>  GET <span class="hljs-regexp">/movies/</span>_search?q=title:Beautiful Mind<br>  &#123;<br>    <span class="hljs-string">&quot;profile&quot;</span>:<span class="hljs-string">&quot;true&quot;</span><br>  &#125;<br><br>  <span class="hljs-regexp">//</span>使用引号 Bool 泛 查询<br>  GET <span class="hljs-regexp">/movies/</span>_search?q=title:(Beautiful Mind)<br>  &#123;<br>    <span class="hljs-string">&quot;profile&quot;</span>:<span class="hljs-string">&quot;true&quot;</span><br>  &#125;<br><br>  <span class="hljs-number">3</span>. 布尔操作<br>    AND <span class="hljs-regexp">/ OR /</span> NOT 或者 &amp;&amp; <span class="hljs-regexp">/ || /</span> !<br>    title:(matrix NOT reloaded)<br><br>  <span class="hljs-number">4</span>. 分组<br>    + 表示 must<br>    - 表示 must_not<br>    title:(+matrix -reloaded)<br><br>  <span class="hljs-number">5</span>. 范围查询<br>    []闭区间 &#123;&#125;开区间<br><br>  <span class="hljs-number">6</span>. 算数符号<br>    year:&gt;<span class="hljs-number">2010</span><br><br>  <span class="hljs-number">7</span>. 通配符查询(通配符查询效率低，占用内存大，不建议使用)<br>    ? 代表<span class="hljs-number">1</span>个字符<br>    * 代表<span class="hljs-number">0</span>或多个字符<br><br>  <span class="hljs-number">8</span>. 正则表达式<br>    title:[bt]oy<br><br>  <span class="hljs-number">9</span>. 模糊匹配与近似查询<br>    title:befutifl~<span class="hljs-number">1</span><br><br><span class="hljs-comment"># Request Body Search</span><br>  <span class="hljs-number">1</span>. 分页:<br>    from, size<br><br>  <span class="hljs-number">2</span>. sort:<br><br>  <span class="hljs-number">3</span>. _source filtering: 如果_source没有存储，就只返回匹配的文档的元数据<br><br>  <span class="hljs-number">4</span>. 脚本字段:<br><br>  <span class="hljs-number">5</span>. 查询表达式 - Match<br><br>  <span class="hljs-number">6</span>. Match<br><br><span class="hljs-comment"># Page Rank算法</span><br>  <span class="hljs-number">1</span>. 衡量相关性 Information Retrieval<br>    a. Precision (查准率) - 尽可能返回较少的无关文档<br>    b. Recall(查全率)     - 尽量返回较多的相关文档<br>    c. Ranking            - 是否能够按照相关度进行排序<br></code></pre></td></tr></table></figure></li>
<li><p>Mapping</p>
<blockquote>
<p>类似数据库中的scehma定义</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> 定义索引中的字段名称<br><span class="hljs-number">2.</span> 定义字段的数据类型<br><span class="hljs-keyword">Mapping</span> 把<span class="hljs-type">JSON</span>文档映射成Lucene所需要的扁平格式<br>一个<span class="hljs-keyword">Mapping</span>属于一个索引的<span class="hljs-keyword">type</span><br><br># 四种不同级别的<span class="hljs-keyword">Index</span> <span class="hljs-keyword">Options</span> - 控制倒排索引记录的内容<br>  docs - 记录doc id<br>  freqs - 记录 doc id 和 term frequencies<br>  positions - 记录 doc id/term frequencies/term position<br>  offsets - 记录 doc id/term frequencies/term position/<span class="hljs-type">character</span> offsets<br></code></pre></td></tr></table></figure></li>
<li><p>数据类型<br>JSON -&gt; Elasticsearch类型</p>
<table>
<thead>
<tr>
<th align="left">JSON类型</th>
<th align="left">Elasticsearch 类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">字符串</td>
<td align="left">匹配日期格式 -&gt; Date</td>
</tr>
<tr>
<td align="left">布尔值</td>
<td align="left">boolean</td>
</tr>
<tr>
<td align="left">浮点数</td>
<td align="left">float</td>
</tr>
<tr>
<td align="left">整数</td>
<td align="left">long</td>
</tr>
<tr>
<td align="left">对象</td>
<td align="left">Object</td>
</tr>
<tr>
<td align="left">数组</td>
<td align="left">由第一个非空数值的类型所决定</td>
</tr>
<tr>
<td align="left">空值</td>
<td align="left">忽略</td>
</tr>
</tbody></table>
</li>
</ul>
  <figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 简单类型:</span><br><span class="hljs-bullet">  1.</span> Text/Keyword<br><span class="hljs-bullet">  2.</span> Date<br><span class="hljs-bullet">  3.</span> Integer / Floating<br><span class="hljs-bullet">  4.</span> Boolean<br><span class="hljs-bullet">  5.</span> IPv4 &amp; IPv6<br><br><span class="hljs-section"># 复杂类型 - 对象和嵌套对象</span><br>  对象类型/嵌套类型<br><br><span class="hljs-section"># 特殊类型</span><br>  geo<span class="hljs-emphasis">_point &amp; geo_</span>shape / percolator<br></code></pre></td></tr></table></figure>

<h2 id="Elasticsearch-聚合-Aggregation"><a href="#Elasticsearch-聚合-Aggregation" class="headerlink" title="Elasticsearch 聚合 (Aggregation)"></a>Elasticsearch 聚合 (Aggregation)</h2><blockquote>
<p>Elasticsearch 除了搜索以外还提供针对ES数据进行统计分析</p>
</blockquote>
<ul>
<li>集合分类<figure class="highlight q"><table><tr><td class="code"><pre><code class="hljs q"><span class="hljs-number">1.</span> Bucket Aggregation: 满足特定条件的文档集合<br>  <span class="hljs-built_in">group</span> <span class="hljs-keyword">by</span><br><br><span class="hljs-number">2.</span> Metric Aggregation: 数学运算，对文档字段统计分析<br>  <span class="hljs-built_in">min</span>/<span class="hljs-built_in">max</span>/<span class="hljs-built_in">sum</span>/<span class="hljs-built_in">avg</span>/cardinality<br><br><span class="hljs-number">3.</span> Pipeline Aggregation: 对聚合结果进行二次聚合<br><span class="hljs-number">4.</span> Matrix Aggregation: 支持多个字段的操作并提供结果矩阵<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Elasticsearch-分布式结构"><a href="#Elasticsearch-分布式结构" class="headerlink" title="Elasticsearch 分布式结构"></a>Elasticsearch 分布式结构</h2><ul>
<li><p>高可用</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 服务可用性 - 允许有节点停止服务<br><span class="hljs-bullet">2.</span> 数据可用性 - 部分节点丢失，不会丢失数据<br></code></pre></td></tr></table></figure></li>
<li><p>可扩展性</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 请求量提升/数据不断增加(将数据分布到所有节点上)<br></code></pre></td></tr></table></figure></li>
<li><p>Elasticsearch分布式架构</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> 不同的集群通过不同的名字区分，-E <span class="hljs-keyword">cluster</span>.name=geektime<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="ELK-大数据分析"><a href="#ELK-大数据分析" class="headerlink" title="ELK 大数据分析"></a>ELK 大数据分析</h2>]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>golang pkg Tips &amp; Tracks</title>
    <url>/2021/09/03/golang-pkg-Tips-Tracks/</url>
    <content><![CDATA[<h2 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h2><ul>
<li>Goals<blockquote>
<p>The efficientcy of a statically-typed compiled language with the ease of programming of a dynamic language.<br>Safety: type-safe and memory-safe<br>Good support for concurrency and communication.<br>Efficient, latency-free garbage collection.<br>High-speed compilation.</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<ul>
<li><p>Design principles</p>
<blockquote>
<p>Keep concept orthogonal(正交).<br>Keep the grammar regular and simple.<br>Reduce typing. Let the language work things out.<br>Reduce typing. Keep the type system clear.</p>
</blockquote>
</li>
<li><p>The Big Picture</p>
<blockquote>
<p>Fundamentals:</p>
</blockquote>
<ul>
<li>Clean, concise syntax.</li>
<li>Lightweight type system.</li>
<li>No implicit conversions: keep things explicit.</li>
<li>Untyped unsized constants:</li>
<li>Strict separation of interface and implementation.<blockquote>
<p>Run-time:</p>
</blockquote>
</li>
<li>Garbage collection.</li>
<li>Strings, maps, communication channels</li>
<li>Concurrency.<blockquote>
<p>Package model:<br>Explicit dependencies to enable faster builds.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h2 id="Go-Identifiers"><a href="#Go-Identifiers" class="headerlink" title="Go Identifiers"></a>Go Identifiers</h2><h2 id="Go-项目组织"><a href="#Go-项目组织" class="headerlink" title="Go 项目组织"></a>Go 项目组织</h2><ul>
<li><p>Go应用</p>
<blockquote>
<p>编写高质量的Go应用</p>
</blockquote>
<ul>
<li>代码结构<ol>
<li>目录结构</li>
<li>按功能拆分模块</li>
</ol>
<ul>
<li>层次拆分 - MVC</li>
<li>功能拆分 - 实现高内聚低耦合的设计哲学</li>
</ul>
</li>
<li>代码规范 - UBer_Go_Guid</li>
<li>代码质量</li>
<li>编程哲学<ul>
<li>面向接口编程<ol>
<li>代码扩展性更强</li>
<li>解耦上下游的实现</li>
<li>提高代码的可测性</li>
</ol>
</li>
<li>面向“对象”编程<ol>
<li>类、抽象、封装通过结构体来实现</li>
<li>实例通过结构体变量来实现</li>
<li>继承通过组合来实现,一个结构体嵌到另一个结构体，称作组合</li>
<li>多态通过结构来实现<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// 基类: Bird</span><br><span class="hljs-keyword">type</span> Bird <span class="hljs-keyword">struct</span> &#123;<br>  Type <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// 鸟来的类别</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(bird *Bird)</span> <span class="hljs-title">Class</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>  <span class="hljs-keyword">return</span> bird.Type<br>&#125;<br><br><span class="hljs-comment">// 定义鸟类</span><br><span class="hljs-keyword">type</span> Birds <span class="hljs-keyword">interface</span> &#123;<br>  Name() <span class="hljs-keyword">string</span><br>  Class() <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// 鸟类: 金丝雀</span><br><span class="hljs-keyword">type</span> Canary <span class="hljs-keyword">struct</span> &#123;<br>  Bird<br>  name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Canary)</span> <span class="hljs-title">Name</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>  <span class="hljs-keyword">return</span> c.name<br>&#125;<br><br><span class="hljs-comment">// 鸟类: 乌鸦</span><br><span class="hljs-keyword">type</span> Crow <span class="hljs-keyword">struct</span> &#123;<br>  Bird<br>  name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Crow)</span> <span class="hljs-title">Name</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>  <span class="hljs-keyword">return</span> c.name<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCrow</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Crow</span></span> &#123;<br>  <span class="hljs-keyword">return</span> &amp;Crow&#123;<br>    Bird: Bird&#123;<br>      Type: <span class="hljs-string">&quot;Crow&quot;</span>,<br>    &#125;,<br>    name: name,<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCanary</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Canary</span></span> &#123;<br>  <span class="hljs-keyword">return</span> &amp;Canary&#123;<br>    Bird: Bird&#123;<br>      Type: <span class="hljs-string">&quot;Canary&quot;</span>,<br>    &#125;,<br>    name: name,<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BirdInfo</span><span class="hljs-params">(birds Birds)</span></span> &#123;<br>  fmt.Printf(<span class="hljs-string">&quot;I&#x27;m %s, I belong to %s bird class!\n&quot;</span>, birds.Name(), birds.Class())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  canary := NewCanary(<span class="hljs-string">&quot;CanaryA&quot;</span>)<br>  crow := NewCrow(<span class="hljs-string">&quot;CrowA&quot;</span>)<br>  BirdInfo(canary)<br>  BirdInfo(crow)<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
</li>
<li>软件设计方法<ul>
<li>设计模式 Design Pattern<blockquote>
<p>针对特定场景总结出来的最佳实现方式，特点是解决场景比较具体，实施起来比较简单</p>
</blockquote>
<ul>
<li>创建型模式 Creational Patterns<blockquote>
<p>提供一种在创建对象的同时隐藏创建逻辑的方式，不使用new运算符直接实例化对象</p>
</blockquote>
<ul>
<li>单例模式 Singleton Pattern<blockquote>
<p>单例模式使全局只有一个实例,并且负责创建自己的对象，比较适合全局共享一个实例，且只需要被初始化一次的场景. [数据库实例、全局配置、全局任务池]</p>
</blockquote>
<ul>
<li>饿汉模式: 全局实例在包被加载时创建<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> singleton<br><br><span class="hljs-keyword">type</span> singleton <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-keyword">var</span> ins *singleton<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">//导入时 初始化静态实例</span><br>  ins = &amp;singleton&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetInsOr</span><span class="hljs-params">()</span> *<span class="hljs-title">singleton</span></span> &#123;<br>  <span class="hljs-comment">// 返回创建好的初始化实例</span><br>  <span class="hljs-keyword">return</span> ins<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
<li>懒汉模式: 全局实例在包被使用时创建<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> singleton<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-keyword">type</span> singleton <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-keyword">var</span> ins *singleton<br><span class="hljs-keyword">var</span> once sync.Once<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetInsOr</span><span class="hljs-params">()</span> *<span class="hljs-title">singleton2</span></span> &#123;<br>  <span class="hljs-comment">// Do is intended for initialization that must be run exactly once</span><br>	once.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		ins2 = &amp;singleton&#123;<span class="hljs-string">&quot;Chyi&quot;</span>&#125;<br>	&#125;)<br>	<span class="hljs-keyword">return</span> ins<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>简单工厂模式<blockquote>
<p>传入参数并返回一个结构体的实例</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> factory<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-keyword">string</span><br>	Age  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span> <span class="hljs-title">Greet</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Printf(<span class="hljs-string">&quot;Hi! My name is %s&quot;</span>, p.Name)<br>&#125;<br><br><span class="hljs-comment">// 简单工厂模式确保我们创建的实例具有需要的参数，进而保证实例按照预期执行</span><br><span class="hljs-comment">// 返回非指针的实例，可以确保实例属性避免属性被意外/任意修改</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPerson</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, age <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">Person</span></span> &#123;<br>	<span class="hljs-keyword">return</span> Person&#123;<br>		Name: name,<br>		Age:  age,<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
<li>抽象工厂模式<blockquote>
<p>与简单工厂模式区别是返回的是接口而不是结构体, 在不公开内部实现的情况下，让调用者使用</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> abstract_factory<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">interface</span> &#123;<br>	Greet()<br>&#125;<br><br><span class="hljs-keyword">type</span> person <span class="hljs-keyword">struct</span> &#123;<br>	name <span class="hljs-keyword">string</span><br>	age  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p person)</span> <span class="hljs-title">Greet</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Printf(<span class="hljs-string">&quot;Hi!, my name is %s&quot;</span>, p.name)<br>&#125;<br><br><span class="hljs-comment">// Here, NewPerson returns an interface, and not the person struct iteself</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPerson</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, age <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">Person</span></span> &#123;<br>	<span class="hljs-keyword">return</span> person&#123;<br>		name: name,<br>		age:  age,<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
<li>工厂方法模式<blockquote>
<p>依赖工厂接口，通过实现工厂接口来创建多种工厂，将对象创建从一个对象负责所有集体类的实例化，编程由一群子类负责对具体类的实例化,从而将过程解耦</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> method_factory<br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	name <span class="hljs-keyword">string</span><br>	age  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPersonFactory</span><span class="hljs-params">(age <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">func</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Person</span></span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Person</span></span> &#123;<br>		<span class="hljs-keyword">return</span> Person&#123;<br>			name: name,<br>			age:  age,<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>建造者模式</li>
<li>原型模式</li>
</ul>
</li>
<li>结构型模式 Structural Patterns<ul>
<li>访问者模式</li>
<li>模版模式 Template Pattern<blockquote>
<p>将一个类中能够公共使用的方法放置在抽象类中实现，将不能公共使用的方法作为抽象方法，强制子类实现，这样就做到一个类作为模版，让开发者填充需要填充的地方</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> template<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Cooker <span class="hljs-keyword">interface</span> &#123;<br>	fire()<br>	cooke()<br>	outfire()<br>&#125;<br><br><span class="hljs-comment">// 类似一个抽象类</span><br><span class="hljs-keyword">type</span> CookMenu <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(CookMenu)</span> <span class="hljs-title">fire</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;开火&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// 做菜 交给具体的子类实现</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(CookMenu)</span> <span class="hljs-title">cooke</span><span class="hljs-params">()</span></span> &#123;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(CookMenu)</span> <span class="hljs-title">outfire</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;关火&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// 封装具体步骤</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doCook</span><span class="hljs-params">(cook Cooker)</span></span> &#123;<br>	cook.fire()<br>	cook.cooke()<br>	cook.outfire()<br>&#125;<br><br><span class="hljs-keyword">type</span> XiHongShi <span class="hljs-keyword">struct</span> &#123;<br>	CookMenu<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*XiHongShi)</span> <span class="hljs-title">cooke</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;做西红柿&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> ChaoJiDan <span class="hljs-keyword">struct</span> &#123;<br>	CookMenu<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ChaoJiDan)</span> <span class="hljs-title">cooke</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;做炒鸡蛋&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestTemplate</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br> <span class="hljs-comment">// 做西红柿</span><br> xihongshi := &amp;XiHongShi&#123;&#125;<br>  doCook(xihongshi)<br><br>  <span class="hljs-comment">// 做炒鸡蛋</span><br>  chaojidan := &amp;ChaoJiDan&#123;&#125;<br>  doCook(chaojidan)<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>策略模式 Strategy Pattern<blockquote>
<p>采用不同策略的场景</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> strategy<br><br><span class="hljs-comment">// 策略模式</span><br><br><span class="hljs-comment">// 定义一个策略类</span><br><span class="hljs-keyword">type</span> IStrategy <span class="hljs-keyword">interface</span> &#123;<br>	do(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>) <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// 策略实现: 加</span><br><span class="hljs-keyword">type</span> add <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*add)</span> <span class="hljs-title">do</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>	<span class="hljs-keyword">return</span> a + b<br>&#125;<br><br><span class="hljs-comment">// 策略实现: 减</span><br><span class="hljs-keyword">type</span> reduce <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*reduce)</span> <span class="hljs-title">do</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>	<span class="hljs-keyword">return</span> a - b<br>&#125;<br><br><span class="hljs-comment">// 具体策略的执行者</span><br><span class="hljs-keyword">type</span> Operator <span class="hljs-keyword">struct</span> &#123;<br>	strategy IStrategy<br>&#125;<br><br><span class="hljs-comment">// 设置策略</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(operator *Operator)</span> <span class="hljs-title">setStrategy</span><span class="hljs-params">(strategy IStrategy)</span></span> &#123;<br>	operator.strategy = strategy<br>&#125;<br><br><span class="hljs-comment">// 调用策略中的方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(operator *Operator)</span> <span class="hljs-title">calculate</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>	<span class="hljs-keyword">return</span> operator.strategy.do(a, b)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestStrategy</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	operator := Operator&#123;&#125;<br><br>	operator.setStrategy(&amp;add&#123;&#125;)<br>	result := operator.calculate(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>	fmt.Println(<span class="hljs-string">&quot;add:&quot;</span>, result)<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>状态模式</li>
<li>观察者模式</li>
<li>备忘录模式</li>
<li>中介者模式</li>
<li>迭代器模式</li>
<li>解释器模式</li>
<li>命令模式</li>
<li>责任链模式</li>
</ul>
</li>
<li>行为型模式 Behavioral Patterns<blockquote>
<p>关注对象之间的通信</p>
</blockquote>
<ul>
<li>适配器模式</li>
<li>桥接模式</li>
<li>组合模式</li>
<li>装饰模式</li>
<li>外观模式</li>
<li>享元模式</li>
<li>代理模式 Proxy Pattern<blockquote>
<p>可以为另一个对象提供一个替身或者占位符，以控制对这个对象的访问</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><code class="hljs reasonml">package proxy<br><br>import <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Seller interface &#123;<br>	sell(name <span class="hljs-built_in">string</span>)<br>&#125;<br><br><span class="hljs-comment">// 火车站</span><br><span class="hljs-keyword">type</span> Station <span class="hljs-keyword">struct</span> &#123;<br>	stock <span class="hljs-built_in">int</span> <span class="hljs-comment">// 库存</span><br>&#125;<br><br>func (station *Station) sell(name <span class="hljs-built_in">string</span>) &#123;<br>	<span class="hljs-keyword">if</span> station.stock &gt; <span class="hljs-number">0</span> &#123;<br>		station.stock--<br>		fmt.<span class="hljs-constructor">Printf(<span class="hljs-string">&quot;代理点中: %s买了一张票，剩余: %d \n&quot;</span>, <span class="hljs-params">name</span>, <span class="hljs-params">station</span>.<span class="hljs-params">stock</span>)</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.<span class="hljs-constructor">Println(<span class="hljs-string">&quot;票已售空&quot;</span>)</span><br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 火车代理点</span><br><br><span class="hljs-keyword">type</span> StationProxy <span class="hljs-keyword">struct</span> &#123;<br>	station *Station <span class="hljs-comment">// 持有火车站对象</span><br>&#125;<br><br>func (proxy *StationProxy) sell(name <span class="hljs-built_in">string</span>) &#123;<br>	<span class="hljs-keyword">if</span> proxy.station.stock &gt; <span class="hljs-number">0</span> &#123;<br>		proxy.station.stock--<br>		fmt.<span class="hljs-constructor">Printf(<span class="hljs-string">&quot;代理点中: %s买了一张票,剩余: %d \n&quot;</span>, <span class="hljs-params">name</span>, <span class="hljs-params">proxy</span>.<span class="hljs-params">station</span>.<span class="hljs-params">stock</span>)</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.<span class="hljs-constructor">Println(<span class="hljs-string">&quot;票已售空&quot;</span>)</span><br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
<li>选项模式 Options Pattern<blockquote>
<p>结构体参数很多，期望创建一个携带默认值的结构体变量，并选择性修改其中一些参数的值</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> options<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> &#123;<br>	addr    <span class="hljs-keyword">string</span><br>	cache   <span class="hljs-keyword">bool</span><br>	timeout time.Duration<br>&#125;<br><br><span class="hljs-keyword">const</span> (<br>	defaultTimeout = <span class="hljs-number">10</span><br>	defaultCaching = <span class="hljs-literal">false</span><br>)<br><br><span class="hljs-keyword">type</span> options <span class="hljs-keyword">struct</span> &#123;<br>	timeout time.Duration<br>	caching <span class="hljs-keyword">bool</span><br>&#125;<br><br><span class="hljs-comment">// Option override behavior of Connect</span><br><span class="hljs-keyword">type</span> Option <span class="hljs-keyword">interface</span> &#123;<br>	apply(*options)<br>&#125;<br><br><span class="hljs-keyword">type</span> optionFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*options)</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f optionFunc)</span> <span class="hljs-title">apply</span><span class="hljs-params">(o *options)</span></span> &#123;<br>	f(o)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(t time.Duration)</span> <span class="hljs-title">Option</span></span> &#123;<br>	<span class="hljs-keyword">return</span> optionFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(o *options)</span></span> &#123;<br>		o.timeout = t<br>	&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCaching</span><span class="hljs-params">(cache <span class="hljs-keyword">bool</span>)</span> <span class="hljs-title">Option</span></span> &#123;<br>	<span class="hljs-keyword">return</span> optionFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(o *options)</span></span> &#123;<br>		o.caching = cache<br>	&#125;)<br>&#125;<br><br><span class="hljs-comment">// NewConnect create a connection.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConnect</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>, opts ...Option)</span> <span class="hljs-params">(*Connection, error)</span></span> &#123;<br>	options := options&#123;<br>		timeout: defaultTimeout,<br>		caching: defaultCaching,<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> _, o := <span class="hljs-keyword">range</span> opts &#123;<br>		o.apply(&amp;options)<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> &amp;Connection&#123;<br>		addr:    addr,<br>		cache:   options.caching,<br>		timeout: options.timeout,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOptions</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br> connect, err := NewConnect(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, WithCaching(<span class="hljs-literal">true</span>), WithTimeout(<span class="hljs-number">5</span>))<br> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>  log.Fatal(err)<br> &#125;<br> fmt.Println(connect)<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>SOLID原则<blockquote>
<p>侧重设计原则,设计代码指导方针</p>
</blockquote>
<ul>
<li>SRP: 单一功能原则, 一个类或者模块只负责完成一个指责</li>
<li>OCP: 开闭原则,软件实体应该对扩展开放，对修改关闭</li>
<li>LSP: 里氏替换原则, 如果S是T的子类型，则类型T的对象可以替换为类型S的对象，而不会破坏程序</li>
<li>DIP: 依赖倒置原则，依赖于抽象而不是一个实例，其本质是要面向接口编程，不要面向实现编程</li>
<li>ISP: 接口分离原则，客户端程序不应该依赖它不需要的方法</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>项目管理</p>
</li>
<li><p>项目文档</p>
</li>
</ul>
<h2 id="Go-工具集"><a href="#Go-工具集" class="headerlink" title="Go 工具集"></a>Go 工具集</h2><table>
<thead>
<tr>
<th align="left">工具名</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left">golines</td>
<td align="left">格式化长行</td>
</tr>
<tr>
<td align="left">goimports</td>
<td align="left">导入包管理，自动增删依赖包，按照字母排序</td>
</tr>
<tr>
<td align="left">mockgen</td>
<td align="left">接口Mock工具</td>
</tr>
<tr>
<td align="left">gotests</td>
<td align="left">根据Go代码自动生成单元测试模版</td>
</tr>
<tr>
<td align="left">go-junit-report</td>
<td align="left">go test输出转换为junit xml</td>
</tr>
<tr>
<td align="left">richgo</td>
<td align="left">用文本装饰丰富go test的输出</td>
</tr>
<tr>
<td align="left">golangci-lint</td>
<td align="left">静态代码检查工具</td>
</tr>
<tr>
<td align="left">rts</td>
<td align="left">response to struct 根据服务器的响应生成Go结构体</td>
</tr>
<tr>
<td align="left">protoc-go-inject-tag</td>
<td align="left">通过protoc工具生成pb.go文件中注入自定义标签</td>
</tr>
<tr>
<td align="left">db2struct</td>
<td align="left">将数据库表一键转换为go struct,支持自定义Tag和多种命名格式配置</td>
</tr>
<tr>
<td align="left">gsemver</td>
<td align="left">根据git commit规范自动生成语义化版本</td>
</tr>
<tr>
<td align="left">git-chglog</td>
<td align="left">根据git commit 自动生成CHANGELOG</td>
</tr>
<tr>
<td align="left">github-release</td>
<td align="left">命令行工具，创建、修改github release</td>
</tr>
<tr>
<td align="left">go-mod-outdated</td>
<td align="left">检查依赖包是否有更新</td>
</tr>
<tr>
<td align="left">depth</td>
<td align="left">通过分析导入的库，将某个包的依赖关系用树状结构显示出来</td>
</tr>
<tr>
<td align="left">go-callvis</td>
<td align="left">可视化显示Go调用关系</td>
</tr>
<tr>
<td align="left">cfssl</td>
<td align="left">CouldFlare的PKI的TLS工具集</td>
</tr>
<tr>
<td align="left">addllicense</td>
<td align="left">通过扫描指定文件的文件，确保源码文件有版权头</td>
</tr>
<tr>
<td align="left">gothanks</td>
<td align="left">自动在github上Star项目的依赖包所在的github repository</td>
</tr>
<tr>
<td align="left">swagger</td>
<td align="left">自动生成Go Swagger文档</td>
</tr>
</tbody></table>
<h2 id="Go-Guide"><a href="#Go-Guide" class="headerlink" title="Go Guide"></a>Go Guide</h2><h2 id="Golang-Frequently-Asked-Questions-FAQ"><a href="#Golang-Frequently-Asked-Questions-FAQ" class="headerlink" title="Golang Frequently Asked Questions (FAQ)"></a>Golang Frequently Asked Questions (FAQ)</h2><ul>
<li><p>Map access is unsafe only when updates are occurring.</p>
</li>
<li><p>How can I gurantee my type satisfies an interface?</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> I <span class="hljs-keyword">interface</span> &#123;<br>    Say(<span class="hljs-keyword">string</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> T <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *T)</span> <span class="hljs-title">Say</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span></span> &#123;<br>    fmt.Println(s)<br>&#125;<br><br><span class="hljs-comment">// 用于触发编译期的接口的合理性检查机制</span><br><span class="hljs-comment">// 如果T没有实现I，会在编译期报错</span><br><span class="hljs-comment">// 赋值右边是断言类型的零值，对于指针类型、切片、map是nil，对于结构体类型是空结构</span><br><span class="hljs-comment">// Ask the compiler to check that the type T implements the interface I by</span><br><span class="hljs-keyword">var</span> _ I = (*T)(<span class="hljs-literal">nil</span>) <span class="hljs-comment">// Verify that *T implements I.</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    t := T&#123;&#125;<br>    t.Say(<span class="hljs-string">&quot;Say Hello&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Should I define methods on values or pointers?</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">func (s *MyStruct) pointerMethod() &#123;&#125;   // <span class="hljs-keyword">method</span> <span class="hljs-keyword">on</span> pointer<br>func (s MyStruct) valueMethod() &#123;&#125;      // <span class="hljs-keyword">method</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">value</span><br><br>&gt; <span class="hljs-keyword">When</span> defining a <span class="hljs-keyword">method</span> <span class="hljs-keyword">on</span> a <span class="hljs-keyword">type</span>, the receiver behaves exactly <span class="hljs-keyword">as</span> <span class="hljs-keyword">if</span> it were an argument <span class="hljs-keyword">to</span> the <span class="hljs-keyword">method</span>. Whether <span class="hljs-keyword">to</span> define the receiver <span class="hljs-keyword">as</span> a <span class="hljs-keyword">value</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">as</span> a pointer <span class="hljs-keyword">is</span> the same question, <span class="hljs-keyword">then</span>, <span class="hljs-keyword">as</span> whether a <span class="hljs-keyword">function</span> argument should be a <span class="hljs-keyword">value</span> <span class="hljs-keyword">or</span> poiner.<br><br><span class="hljs-number">1.</span> First, <span class="hljs-keyword">and</span> most important, does the <span class="hljs-keyword">method</span> need <span class="hljs-keyword">to</span> modify the receiver?<br><span class="hljs-number">2.</span> Second <span class="hljs-keyword">is</span> the consideration <span class="hljs-keyword">of</span> efficiency. <span class="hljs-keyword">If</span> the receiver <span class="hljs-keyword">is</span> <span class="hljs-keyword">large</span>, a big struct <span class="hljs-keyword">for</span> instance, it will be much cheaper <span class="hljs-keyword">to</span> use a pointer receiver.<br></code></pre></td></tr></table></figure></li>
<li><p>What operations are atomic? What about mutexes?</p>
<blockquote>
<p>Do not communicate by sharing memory. Instead, share memory by communicating.</p>
</blockquote>
</li>
<li><p>How can I control the number of CPUs?</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><code class="hljs smali">The runtime can allocate more threads than the value of GOMAXPROCS to service multiple outstanding I/O requests. GOMAXPROCS only affects how many goroutines can actually<span class="hljs-built_in"> execute </span>at once; arbitrarily more may be blocked in<span class="hljs-keyword"> system</span> calls.<br></code></pre></td></tr></table></figure></li>
<li><p>Who do I write a unit test?</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><code class="hljs reasonml"><span class="hljs-number">1.</span> Create a <span class="hljs-keyword">new</span> file ending <span class="hljs-keyword">in</span> <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_test</span>.</span></span>go <span class="hljs-keyword">in</span> the same directory <span class="hljs-keyword">as</span> your package sources. Inside that file, import <span class="hljs-string">&quot;testing&quot;</span> <span class="hljs-keyword">and</span> write functions <span class="hljs-keyword">of</span> the form<br><br>func <span class="hljs-constructor">TestFoo(<span class="hljs-params">t</span> <span class="hljs-operator">*</span><span class="hljs-params">testing</span>.T)</span> &#123;<br>  …<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>What compiler technology is used to build the compilers?</p>
<blockquote>
<p>The default compiler, gc, was originally written in C, but since the Go 1.5 release the compiler has been a Go program.</p>
</blockquote>
</li>
<li><p>Why do garbage collection? Won’t it be too expensive?</p>
<figure class="highlight mercury"><table><tr><td class="code"><pre><code class="hljs mercury">The current <span class="hljs-keyword">implementation</span> <span class="hljs-keyword">is</span> a mark-and-sweep collector.<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="User-Go语言编码规范"><a href="#User-Go语言编码规范" class="headerlink" title="User Go语言编码规范"></a>User Go语言编码规范</h2><ul>
<li><p>指导原则:</p>
<ul>
<li><p>指向interface的指针</p>
<ol>
<li>使用指针传递才能通过接口方法修改基础数据</li>
</ol>
</li>
<li><p>Interface 合理性验证</p>
<ol>
<li>var _ http.Handler = (*Handler)(nil)  // 触发编译期的接口合理性检查机制，如果Handler没有实现Http.Handler 会报错</li>
<li>赋值右边是断言类型的零值，指针类型、切片和映射都是nil,对于结构类型是空结构</li>
</ol>
</li>
<li><p>接收器receiver与接口</p>
<ol>
<li>使用值接收器的方法即可以通过值调用，也可以通过指针调用</li>
<li>带指针接收器的方法只能通过指针调用<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 一个类型可以有值接收器方法集和指针接收器方法集<br>  一个值接收器方法集是指针接收器方法集的子集<br><span class="hljs-bullet">2.</span> 值对象只可以使用值接收器方法集,指针对象可以使用值接收器方法集+指针接收器方法集<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>零值 Mutex</p>
<blockquote>
<p>零值sync.Mutex, sync.RWMutx是有效的，指向Mutex的指针基本是不必要的</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 使用结构体指针，mutex应该作为结构体的非指针字段，即使该结构体不被导出，不要将mutex嵌入到结构体中<br></code></pre></td></tr></table></figure></li>
<li><p>边界处拷贝Slices和Maps</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> 接收Slices 和 Maps: 当<span class="hljs-built_in">map</span>或<span class="hljs-built_in">slice</span>作为函数参数传入时，用户可以对其进行修改<br><span class="hljs-number">2.</span> 注意用户对报漏内部状态的<span class="hljs-built_in">map</span>或<span class="hljs-built_in">slice</span>的修改<br></code></pre></td></tr></table></figure></li>
<li><p>使用defer释放资源</p>
</li>
<li><p>Channel的size要么是1，要么是无缓冲的</p>
</li>
<li><p>枚举从1开始:</p>
</li>
<li><p>使用time处理时间</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><code class="hljs coq"><span class="hljs-number">1.</span> <span class="hljs-built_in">time</span>.<span class="hljs-keyword">Time</span>表示瞬时时间<br><span class="hljs-number">2.</span> <span class="hljs-built_in">time</span>.Duration表示时间段<br><span class="hljs-number">3.</span> <span class="hljs-keyword">Time</span>.<span class="hljs-keyword">Add</span>: 某个时刻比前一个时刻晚<br><span class="hljs-number">4.</span> <span class="hljs-keyword">Time</span>.AddDate: 下一个日历日<br></code></pre></td></tr></table></figure></li>
<li><p>错误类型</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> errors.New: 对于简单静态字符串的错误<br><span class="hljs-bullet">2.</span> fmt.Errorf: 对于格式化的错误字符串<br><span class="hljs-bullet">3.</span> 实现Error()方法的自定义类型<br><span class="hljs-bullet">4.</span> errors.Wrap: Wrapped errors<br></code></pre></td></tr></table></figure></li>
<li><p>错误包装 Error Wrapping</p>
</li>
<li><p>处理类型断言失败</p>
</li>
<li><p>追加时优先执行切片容量</p>
</li>
</ul>
</li>
<li><p>性能</p>
<ul>
<li>将原语转换为字符串或从字符串转换时，strconv速度比fmt快</li>
<li>指定容器容量,以便为容器预先分配内存，将在添加元素时最小化后续分配 – 容量提示</li>
<li>指定切片容量,编译器为其提供make()的slice的容量分配足够的内存</li>
</ul>
</li>
<li><p>规范</p>
<ul>
<li><p>包名</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 全部小写，没有大写或下划线<br><span class="hljs-bullet">2.</span> 不使用复数<br><span class="hljs-bullet">3.</span> 不要用 common, util, shared, lib<br></code></pre></td></tr></table></figure></li>
<li><p>导入别名</p>
<blockquote>
<p>除非导入之间有直接冲突，否则避免导入别名</p>
</blockquote>
</li>
<li><p>减少嵌套</p>
<blockquote>
<p>代码通过尽可能先处理错误情况/特殊情况今早返回或继续循环减少嵌套，减少嵌套多个级别的代码的代码</p>
</blockquote>
</li>
<li><p>顶层变量声明</p>
</li>
</ul>
</li>
</ul>
<h2 id="Golang-Tips-amp-Tracks"><a href="#Golang-Tips-amp-Tracks" class="headerlink" title="Golang Tips &amp; Tracks"></a>Golang Tips &amp; Tracks</h2><ul>
<li><strong>负载均衡算法对比</strong><blockquote>
<p>负载均衡最重要的就是均衡</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;math/rand&quot;</span><br>  <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>  rand.Seed(time.Now().UnixNano())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">normal_shuffle</span><span class="hljs-params">(slice []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(slice); i++ &#123;<br>    a := rand.Intn(<span class="hljs-built_in">len</span>(slice))<br>    b := rand.Intn(<span class="hljs-built_in">len</span>(slice))<br>    slice[a], slice[b] = slice[b], slice[a]<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shuffle</span><span class="hljs-params">(indexes []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>  <span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(indexes); i &gt; <span class="hljs-number">0</span>; i-- &#123;<br>    lastIdx := i - <span class="hljs-number">1</span><br>    idx := rand.Intn(i)<br>    indexes[lastIdx], indexes[idx] = indexes[idx], indexes[lastIdx]<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">var</span> cnt1 = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">int</span>&#123;&#125;<br>  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br>    <span class="hljs-keyword">var</span> sl = []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>    normal_shuffle(sl)<br>    cnt1[sl[<span class="hljs-number">0</span>]]++<br>  &#125;<br><br>  <span class="hljs-keyword">var</span> cnt2 = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">int</span>&#123;&#125;<br>  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br>    <span class="hljs-keyword">var</span> sl = []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>    shuffle(sl)<br>    cnt2[sl[<span class="hljs-number">0</span>]]++<br>  &#125;<br><br>  fmt.Println(<span class="hljs-string">&quot;normal shuffle: &quot;</span>, cnt1)<br>  fmt.Println(<span class="hljs-string">&quot;fisher yates  : &quot;</span>, cnt2)<br>&#125;<br><br>chyi/<span class="hljs-keyword">go</span>-awesome-prj/shuffle via 🐹 v1<span class="hljs-number">.17</span> took <span class="hljs-number">38</span>s<br>➜ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span><br>normal shuffle:  <span class="hljs-keyword">map</span>[<span class="hljs-number">0</span>:<span class="hljs-number">224558</span> <span class="hljs-number">1</span>:<span class="hljs-number">128887</span> <span class="hljs-number">2</span>:<span class="hljs-number">129201</span> <span class="hljs-number">3</span>:<span class="hljs-number">129493</span> <span class="hljs-number">4</span>:<span class="hljs-number">129487</span> <span class="hljs-number">5</span>:<span class="hljs-number">129202</span> <span class="hljs-number">6</span>:<span class="hljs-number">129172</span>]<br>fisher yates  :  <span class="hljs-keyword">map</span>[<span class="hljs-number">0</span>:<span class="hljs-number">142974</span> <span class="hljs-number">1</span>:<span class="hljs-number">143116</span> <span class="hljs-number">2</span>:<span class="hljs-number">142768</span> <span class="hljs-number">3</span>:<span class="hljs-number">142660</span> <span class="hljs-number">4</span>:<span class="hljs-number">142930</span> <span class="hljs-number">5</span>:<span class="hljs-number">142505</span> <span class="hljs-number">6</span>:<span class="hljs-number">143047</span>]<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>CS - Basic Introduction</title>
    <url>/2021/09/06/CS-Time/</url>
    <content><![CDATA[<blockquote>
<p>计算机通识介绍</p>
</blockquote>
<span id="more"></span>

<h2 id="Time-时间"><a href="#Time-时间" class="headerlink" title="Time 时间"></a>Time 时间</h2><ul>
<li><p>Universal Time: 世界时</p>
<blockquote>
<p>依靠观测天文现象来测量时间，基于地球自转规律</p>
</blockquote>
</li>
<li><p>International Atomic Time: 国际原子时</p>
<blockquote>
<p>以微观时间铯原子的震荡频率为基准，制造原子钟</p>
</blockquote>
</li>
<li><p>Coordinated Universal Time: 协调世界时</p>
<blockquote>
<p>根据世间时和原子时，最终确立新的时间标准，定义成为全球的时间标准</p>
</blockquote>
</li>
<li><p>NTP Network Time Protocol 同步时间</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-number">1</span>. NTP如何同步时间<br>  &gt; 假设网络来回路径对称，并且延迟相同<br>  网络延时 = (t4 - t1) - (t3 - t2)<br>  时间差 = t2 - t1 - 网络延迟<span class="hljs-regexp">/2 = ((t2-t1) + (t3-t4))/</span><span class="hljs-number">2</span><br><span class="hljs-number">2</span>. 同步时间时，对正在运行的程序有没有影响<br>  <span class="hljs-comment"># 墙上时钟: 世界协调时UTC，校准时间后，可能发生回拨</span><br>  <span class="hljs-comment"># 单调时钟: 计算机自启动以后的纳秒数，不会回拨</span><br><br>NTP校准时间提供<span class="hljs-number">2</span>中方式:<br>  <span class="hljs-number">1</span>. ntpdate: 一切已服务器端时间为准，强制修改本机时间<br>  <span class="hljs-number">2</span>. ntpd: 把时间差均摊到每次小的调整上 -- 避免发生倒流<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Computer Science</category>
      </categories>
  </entry>
  <entry>
    <title>Middleware Tips &amp; Tracks</title>
    <url>/2021/09/06/Middleware-Tips-Tracks/</url>
    <content><![CDATA[<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><blockquote>
<p>面对技术选型时，就是一个关于如何取舍的问题，不要不经过思考就觉得那个方案好，那个方案不好。需要根据具体场景分析<br>技术选型不只是技术问题，还与团队、管理、组织结构有关</p>
</blockquote>
<ul>
<li>业务功能角度</li>
<li>技术资源角度<blockquote>
<p>所处的环境、技术资源能否匹配这些技术方案</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<h2 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h2><figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml"># 专业消息中间件需要满足:<br>  1. 消息不丢失<br>    a. 生产者会不会丢消息?<br>      -<span class="ruby"> 消息没发送出去: 网络故障或者其他原因导致发布失败，中间件直接返回失败</span><br><span class="ruby"></span>      -<span class="ruby"> 不确定是否发送成功: 网络问题导致发布超时，可能数据已发送成功，但是读取响应结果超时</span><br><span class="ruby"></span><br>      生产者设置最大重试次数，超过上限依旧失败，需要记录日志报警处理, 生产者会不会丢消息，取决于生产者对于异常情况的处理是否合理, 保证消息不丢，宁可重发，也不能丢弃<br>    b. 消费者会不会丢消息?<br>      -<span class="ruby"> 消费者在处理完消息后，必须告知队列中间件，队列中间件才会把标记已处理，否则仍旧把这些数据发给消费者</span><br><span class="ruby"></span>    c. 队列中间件会不会丢消息?<br>      -<span class="ruby"> 生产者在发布消息时，队列中间件通常会写多个节点，以此保证消息的完整性，即便其中一个节点挂，也能保证集群数据不丢失</span><br><span class="ruby"></span>  2. 消息可堆积<br></code></pre></td></tr></table></figure>
<ul>
<li>Redis 作为消息中间件<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> Redis本身可能会丢数据<br><span class="hljs-bullet">2.</span> 面对消息积压，Redis内存资源紧张<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>Protocol Buffer Intro</title>
    <url>/2021/09/07/Protocol-Buffer-Intro/</url>
    <content><![CDATA[<h1 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h1><blockquote>
<p>Google 开发的一套对数据结构进行序列化的方法，可用作数据通信协议、数据存储格式。</p>
</blockquote>
<ul>
<li>主要特征<ul>
<li>更快的数据传输速度：protobuf传输将数据序列化为二进制数据，JSON文本传输格式 节省大量IO操作，提高数据传输速度</li>
<li>跨平台多语言：protobuf编译工具protoc基于protobuf定义文件，编译出不同语言的客户端或者服务端</li>
<li>良好的扩展性和兼容性:</li>
<li>基于IDL文件定义服务，通过proto3工具生成指定语言的数据结构,服务端和客户端接口</li>
</ul>
</li>
</ul>
<span id="more"></span>


]]></content>
      <categories>
        <category>Microservice</category>
      </categories>
  </entry>
  <entry>
    <title>API Design</title>
    <url>/2021/09/07/RESTful-API-Design/</url>
    <content><![CDATA[<blockquote>
<p>目前业界常用的API风格</p>
</blockquote>
<ul>
<li>RESTful</li>
<li>RPC</li>
<li>GraphQL</li>
</ul>
<span id="more"></span>

<h2 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h2><blockquote>
<p>Representational State Transfer - 表现层状态转移<br>REST是一种软件架构风格，是一组架构约束条件和原则<br>REST规范把所有内容都视为资源<br>REST是一种规范，而RESTful API则是满足这种规范的API接口</p>
</blockquote>
<ul>
<li><p>HTTP动词与REST风格CRUD对应关系</p>
<table>
<thead>
<tr>
<th align="left">HTTP方法</th>
<th align="left">行为</th>
<th align="left">URI</th>
<th align="left">示例说明</th>
<th align="left">是否安全</th>
<th align="left">是否幂等</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">获取资源列表</td>
<td align="left">/users</td>
<td align="left">获取用户列表</td>
<td align="left">是</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">GET</td>
<td align="left">获取一个具体资源</td>
<td align="left">/users/admin</td>
<td align="left">获取admin用户的详细信息</td>
<td align="left">是</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">POST</td>
<td align="left">创建一个新的资源</td>
<td align="left">/users</td>
<td align="left">创建一个新用户</td>
<td align="left">否</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">PUT</td>
<td align="left">以整体的方式更新一个资源</td>
<td align="left">/users/admin</td>
<td align="left">更新user为admin的用户</td>
<td align="left">否</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">DELETE</td>
<td align="left">删除服务器上的一个资源</td>
<td align="left">/users/admin</td>
<td align="left">删除user为admin的用户</td>
<td align="left">否</td>
<td align="left">是</td>
</tr>
</tbody></table>
<figure class="highlight basic"><table><tr><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1</span>. <span class="hljs-keyword">GET</span>,<span class="hljs-keyword">PUT</span>,POST操作的资源属性一致<br><span class="hljs-number">2</span>. 资源进行状态/属性变更，要用<span class="hljs-keyword">PUT</span>方法，POST方法用来创建或者批量删除<br></code></pre></td></tr></table></figure>

<ul>
<li><p>核心特点</p>
<ol>
<li>以资源resource为中心, 所有的东西都抽象称资源，所有的行为都应该是在资源上的CRUD操作</li>
<li>资源是有状态的，使用JSON/XML等在HTTP Body里表征资源的状态</li>
<li>客户端通过四个HTTP动词，对服务器资源进行操作, 实现“表现层状态转化”</li>
<li>无状态, 对于服务端的弹性扩容是很重要的</li>
</ol>
</li>
<li><p>RESTful API 设计原则</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># URI设计</span><br>  1. 资源名使用名词而不是动词,并且用名词复数表示<br>  2. URI结尾不包含/<br>  3. URI中不能出现下划线,必须使用中杠代替<br>  4. URI路径shying小写，不使用大写<br>  5. 避免层级过深的URI，超过2层的资源嵌套会很乱,建议其他资源转换为?参数<br><br><span class="hljs-comment"># 安全性: 不会改变资源状态</span><br><span class="hljs-comment"># 幂等性: 执行1次和执行N次，对资源状态改变的效果是等价的</span><br><br><span class="hljs-comment"># API版本管理</span><br>  1. URL中 <span class="hljs-string">/v1/users</span><br>  2. HTTP Header中, Accept: <span class="hljs-keyword">version</span>=1.0<br>  3. Form参数中, <span class="hljs-string">/users</span>?<span class="hljs-keyword">version</span>=v1<br><br><span class="hljs-comment"># API命名:</span><br>  1. 驼峰命名法 serverAddress<br>  2. 蛇形命名法 server_address<br>  3. 脊柱命名法 server-address -- GitHub API 使用的脊柱命名<br><br><span class="hljs-comment"># 统一分页/过滤/排序/搜索功能</span><br>  1. 分页: <span class="hljs-string">/users</span>?offset=0&amp;limit20<br>  2. 过滤: <span class="hljs-string">/users</span>?fields=email,username,address<br>  3. 排序: <span class="hljs-string">/users</span>?sort=age,desc<br>  4. 搜索:<br><br><span class="hljs-comment"># 域名</span><br>  1. https:<span class="hljs-string">//chyidl.com/api</span> : 这种方式适合API不会有进一步扩展的情况<br>  2. https:<span class="hljs-string">//storage.api.chyidl.com</span> : chyidl.com域名下会新增另一个系统API<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="RPC-API"><a href="#RPC-API" class="headerlink" title="RPC API"></a>RPC API</h2><blockquote>
<p>RPC (Remote Procedure Call) 远程过程调用</p>
</blockquote>
<ul>
<li><p>RPC调用流程</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1.</span> <span class="hljs-built_in">Client</span> 通过本地调用<span class="hljs-built_in">Client</span> Stub --<br><span class="hljs-number">2.</span> <span class="hljs-built_in">Client</span> Stub将参数打包称一个消息，然后发送这个消息<br><span class="hljs-number">3.</span> <span class="hljs-built_in">Client</span>所在的OS将消息发送给<span class="hljs-built_in">Server</span><br><span class="hljs-number">4.</span> <span class="hljs-built_in">Server</span>端接收到消息后，将消息传递给<span class="hljs-built_in">Server</span> Stub<br><span class="hljs-number">5.</span> <span class="hljs-built_in">Server</span> Stub将消息解包，得到参数<br><span class="hljs-number">6.</span> <span class="hljs-built_in">Server</span> Stub调用服务端的子程序，处理完后，最终结果按照相反的步骤返回给<span class="hljs-built_in">Client</span><br><br>Stub: 负责调用参数和返回值的流化serialization、参数的打包和解包、以及网络层的通信.<br><br>google gRPC<br>Facebook Thrift<br></code></pre></td></tr></table></figure></li>
<li><p>RESTful VS gRPC</p>
<table>
<thead>
<tr>
<th align="left">对比项</th>
<th align="left">RESTful</th>
<th align="left">gRPC</th>
</tr>
</thead>
<tbody><tr>
<td align="left">优点</td>
<td align="left">1. REST更规范、更标准、更通用 无论那种语言都支持HTTP协议，可以对接外部很多系统</td>
<td align="left">1. 屏蔽网络细节，调用远程接口像调用本地方法一样，调用简单、方便</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">2. RESTful接口采用JSON作为数据通信格式，JSON格式可读性强</td>
<td align="left">2. gRPC采用Protocol Buffer作为数据传输格式，效率高</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">3. 客户端和服务端松耦合</td>
<td align="left">3.gRPC基于HTTP/2协议标准，性能更高</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">1.扩展性差，随着需求变化</td>
<td align="left">1.Protobuf数据格式可读性差</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">2.性能相对于gRPC偏低</td>
<td align="left">2.gRPC不支持浏览器调用,调试不方便</td>
</tr>
<tr>
<td align="left">使用场景</td>
<td align="left">1. 接口对外，需要接口规范易懂</td>
<td align="left">1.消息密集型、对系统性能和延时要求比较高</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">2.系统能要求不高</td>
<td align="left">2.偏向内部的API</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">3.提供API天生围绕资源、对象、管理展开</td>
<td align="left">3.提供API很难进行资源、对象抽象</td>
</tr>
</tbody></table>
</li>
</ul>
]]></content>
      <categories>
        <category>Microservice</category>
      </categories>
  </entry>
  <entry>
    <title>gRPC Intro</title>
    <url>/2021/09/07/gRPC-Intro/</url>
    <content><![CDATA[<h1 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h1><blockquote>
<p>Google开发共性能、开源、跨编程语言的通用RPC框架，基于HTTP2.0协议开发，默认采用Protocol Buffers数据序列化协议</p>
</blockquote>
]]></content>
      <categories>
        <category>Microservice</category>
      </categories>
  </entry>
  <entry>
    <title>Gin Crash Course</title>
    <url>/2021/09/08/Gin-Crash-Course/</url>
    <content><![CDATA[<h1 id="Gin-Web-Framework"><a href="#Gin-Web-Framework" class="headerlink" title="Gin Web Framework"></a>Gin Web Framework</h1><blockquote>
<p>Gin是Go语言编写的Web框架，功能完善，使用简单，性能高，Gin核心的路由功能是通过HttpRouter实现，具有很高的路由性能.</p>
</blockquote>
<span id="more"></span>

<h2 id="Web服务核心功能"><a href="#Web服务核心功能" class="headerlink" title="Web服务核心功能"></a>Web服务核心功能</h2><ul>
<li><p>基础功能</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 通信协议: HTTP/HTTPS/gRPC</span><br><span class="hljs-meta"># 通信格式: JSON/Protobuf</span><br><span class="hljs-meta"># 路由匹配</span><br>  &gt; HTTP方法，请求路径匹配到处理这个请求的函数,最终由改函数处理这次请求，并返回结果<br><span class="hljs-meta"># 路由分组</span><br><span class="hljs-meta"># 一进程多服务</span><br><span class="hljs-meta"># 业务处理</span><br>  <span class="hljs-number">1.</span> 参数解析<br>  <span class="hljs-number">2.</span> 参数校验<br>  <span class="hljs-number">3.</span> 逻辑处理<br>  <span class="hljs-number">4.</span> 返回结果<br></code></pre></td></tr></table></figure></li>
<li><p>高级功能</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># 中间件</span><br>  &gt; Gin支持中间件，HTTP请求在转发到实际的处理函数之前，会被一系列加载的中间件进行处理<br>  gin.Engine.<span class="hljs-keyword">Use</span>() 方法加载中间件<br></code></pre></td></tr></table></figure>
<p>gin.Logger(): Logger中间件将日志写到gin.DefaultWriter, gin.DefaultWriter默认为os.Stdout<br>gin.Recovery(): Recovery中间件可以从任何panic恢复，并写入500状态<br>gin.CustomRecovery(handle gin.RecoverFunc):<br>gin.BasicAuth(): HTTP 请求基本认证</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><code class="hljs gherkin"><br>|<span class="hljs-string">中间件   </span>|<span class="hljs-string"> 功能                  </span>|<br>|<span class="hljs-string">:--------</span>|<span class="hljs-string">:----------------------</span>|<br>|<span class="hljs-string"> gin-jwt </span>|<span class="hljs-string"> JWT中间件，实现JWT认证</span>|<br>|<span class="hljs-string"> gin-swagger</span>|<span class="hljs-string"> 自动生成Swagger 2.0格式的RESTful API文档</span>|<br>|<span class="hljs-string"> cors</span>|<span class="hljs-string"> 实现HTTP请求跨域</span>|<br>|<span class="hljs-string">sessions</span>|<span class="hljs-string">会话管理中间件</span>|<br>|<span class="hljs-string">authz</span>|<span class="hljs-string"> 基于casbin授权中间件</span>|<br>|<span class="hljs-string">pprof</span>|<span class="hljs-string"> gin pprof 中间件</span>|<br>|<span class="hljs-string">go-gin-prometheus</span>|<span class="hljs-string">Prometheus metrics exporter</span>|<br>|<span class="hljs-string">gzip</span>|<span class="hljs-string"> 支持HTTP请求和响应的gzip压缩</span>|<br>|<span class="hljs-string">gin-limit</span>|<span class="hljs-string">HTTP请求并发控制中间件</span>|<br>|<span class="hljs-string">requestid</span>|<span class="hljs-string">给每个Request生成uuid,并添加在返回的X-Request-ID Header中</span>|<br><br>  <span class="hljs-comment"># 认证</span><br></code></pre></td></tr></table></figure>
<p>认证: Authentication: 用来验证某个用户是否具有访问系统的权限 – 证明你是谁<br>授权: Authorization: 用来验证某个用户是否具有访问某个资源的权限 – 决定你能做什么</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> Basic: 基础认证<br></code></pre></td></tr></table></figure>
<p>   用户名:密码: base64编码后，放到HTTP Authorization Header<br>  github.com/chyidl/noone via 🐹 v1.17<br>  ➜ basic=<code>echo -n &#39;admin:Admin@2021&#39;|base64</code></p>
<p>  github.com/chyidl/noone via 🐹 v1.17<br>  ➜ echo $basic<br>  YWRtaW46QWRtaW5AMjAyMQ==</p>
<p>  github.com/chyidl/noone via 🐹 v1.17<br>  ➜ echo $basic | base64 –decode<br>  admin:Admin@2021%</p>
<p>Basic认证简单,但是不安全, 使用Basic认证+SSL配合使用确保整个认证过程安全</p>
<blockquote>
<p>不要再请求参数中使用明文密码，不要在任何存储中保存明文密码</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">2.</span> Digest<br><span class="hljs-bullet">3.</span> OAuth<br><span class="hljs-bullet">4.</span> Bearer<br><span class="hljs-quote">&gt; Bearer认证称为令牌认证。是一种HTTP身份验证方式. Bearer认证的核心是bearer token.</span><br></code></pre></td></tr></table></figure>
<p>bearer token: 是一个加密字符串，由服务端根据密钥生成, 客户端在请求服务端时，必须在请求头包含Authorization: Bearer <token>. 服务端收到请求头，解析出<token>.校验<token>合法性，Bearer认证配合HTTPS使用，保证认证安全性</p>
<p>JSON Web Token: JWT<br>JWT是Bearer Token一个具体实现，由JSON数据格式组成, 通过HASH散列算法生成字符串.</p>
<h1 id="JWT-认证流程"><a href="#JWT-认证流程" class="headerlink" title="JWT 认证流程:"></a>JWT 认证流程:</h1><blockquote>
<p>不要存放敏感信息到Token中<br>Payload exp值不要设置太大，一般开发版本2小时，上线版本7天</p>
</blockquote>
<ol>
<li>客户端使用用户名和密码请求登陆</li>
<li>服务端收到请求后，会验证用户名和密码，如果用户名和密码验证成功，服务端签发Token返回给客户端</li>
<li>客户端收到请求后将Token缓存起来 Cookie中或者LocalStorage,之后每次请求都会携带该Token</li>
<li>服务端收到请求后，验证请求中的Token,验证通过则进行业务逻辑处理，处理完返回处理结果</li>
</ol>
<h1 id="JWT格式"><a href="#JWT格式" class="headerlink" title="JWT格式:"></a>JWT格式:</h1><p>  1.Header</p>
<div class="code-wrapper"><pre><code class="hljs">- 类型声明 JWT
- 声明加密算法 HMAC SHA256
- 密钥ID 可选
  &#123;
    &quot;typ&quot;: &quot;JWT&quot;,
    &quot;alg&quot;: &quot;HS256&quot;
    &quot;kid&quot;: &quot;youknowwhoami&quot;
  &#125;
  Header进行base64编码
  github.com/chyidl/noone via 🐹 v1.17
  ➜ echo -n &#39;&#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;,&quot;kid&quot;:&quot;youknowwhoami&quot;&#125;&#39;|base64
  eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiIsImtpZCI6InlvdWtub3d3aG9hbWkifQ==
</code></pre></div>
<p>  2.Payload</p>
<div class="code-wrapper"><pre><code class="hljs">- JWT标准中注册的声明
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">iss</span><span class="hljs-params">(Issuer)</span></span>: JWT Token的签发者<br><span class="hljs-function"><span class="hljs-title">sub</span><span class="hljs-params">(Subject)</span></span>: 主题<br><span class="hljs-function"><span class="hljs-title">exp</span><span class="hljs-params">(Expiration Time)</span></span>: JWT Token过期时间<br><span class="hljs-function"><span class="hljs-title">aud</span><span class="hljs-params">(Audience)</span></span>: 接受JWT Token的一方<br><span class="hljs-function"><span class="hljs-title">iat</span><span class="hljs-params">(Issued At)</span></span>: JWT Token签发时间<br><span class="hljs-function"><span class="hljs-title">nbf</span><span class="hljs-params">(Not Before)</span></span>: JWT Token生效时间<br><span class="hljs-function"><span class="hljs-title">jti</span><span class="hljs-params">(JWT ID)</span></span>: JWT Token ID,令牌的唯一标识符<br></code></pre></td></tr></table></figure>
- 公共的声明
  &gt; 添加用户相关信息或者其他业务需要信息
- 私有的声明
  &gt; 客户端和服务端共同定义的声明，base64是对称加密，不建议存放敏感信息
</code></pre>
<p>  3.Signature 签名</p>
<div class="code-wrapper"><pre><code class="hljs">- header(base64后的)
- payload(base64后)
- secretKey: 密钥，保存在服务器中，通过配置文件保存
- Salt(加密盐)
<figure class="highlight gauss"><table><tr><td class="code"><pre><code class="hljs gauss">服务端收到<span class="hljs-built_in">Token</span>后会解析出header.payload 然后用相同的加密算法和密钥对header.payload在进行一次加密，并对加密后的<span class="hljs-built_in">Token</span>和收到的<span class="hljs-built_in">Token</span>是否相同，如果相同则验证通过，不相同返回HTTP <span class="hljs-number">401</span> Unauthrozied<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h1 id="RequestID"><a href="#RequestID" class="headerlink" title="RequestID"></a>RequestID</h1><div class="code-wrapper"><pre><code class="hljs">&gt; 定于和跟踪RequestID
</code></pre></div>
<h1 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h1><div class="code-wrapper"><pre><code class="hljs">&gt; 当前软件架构中采用前后端分离，前端访问地址和后端方法地址不同，Web服务需要处理浏览器跨域请求
</code></pre></div>
<h1 id="优雅关停"><a href="#优雅关停" class="headerlink" title="优雅关停"></a>优雅关停</h1>  <figure class="highlight stata"><table><tr><td class="code"><pre><code class="hljs stata">```<br><span class="hljs-comment">// main.go</span><br>package main<br><br>import (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;log&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/sync/errgroup&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Product struct &#123;<br>	Username    string    `json:<span class="hljs-string">&quot;username&quot;</span> binding:<span class="hljs-string">&quot;required&quot;</span>`<br>	Name        string    `json:<span class="hljs-string">&quot;name&quot;</span> binding:<span class="hljs-string">&quot;required&quot;</span>`<br>	Category    string    `json:<span class="hljs-string">&quot;category&quot;</span> binding:<span class="hljs-string">&quot;required&quot;</span>`<br>	Price       int       `json:<span class="hljs-string">&quot;price&quot;</span> binding:<span class="hljs-string">&quot;gte=0&quot;</span>`<br>	Description string    `json:<span class="hljs-string">&quot;description&quot;</span>`<br>	CreatedAt   time.Time `json:<span class="hljs-string">&quot;createdAt&quot;</span>`<br>&#125;<br><br><span class="hljs-keyword">type</span> productHandler struct &#123;<br>	sync.RWMutex<br>	products map[string]Product<br>&#125;<br><br>func newProductHandler() *productHandler &#123;<br>	<span class="hljs-keyword">return</span> &amp;productHandler&#123;<br>		products: make(map[string]Product),<br>	&#125;<br>&#125;<br><br>func (<span class="hljs-keyword">u</span> *productHandler) Create(c *gin.Context) &#123;<br>	<span class="hljs-keyword">u</span>.Lock()<br>	defer <span class="hljs-keyword">u</span>.Unlock()<br><br>	<span class="hljs-comment">// 1. 参数解析</span><br>	<span class="hljs-keyword">var</span> product Product<br>  <span class="hljs-comment">// 将Body中JSON格式数据解析到指定的Struct中</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> := c.ShouldBindJSON(&amp;product); <span class="hljs-keyword">err</span> != nil &#123;<br>    <span class="hljs-comment">// 返回JSON格式数据</span><br>		c.JSON(http.StatusBadRequest, gin.<span class="hljs-keyword">H</span>&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-keyword">err</span>.<span class="hljs-keyword">Error</span>()&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// 2. 参数校验</span><br>	<span class="hljs-keyword">if</span> _, ok := <span class="hljs-keyword">u</span>.products[product.Name]; ok &#123;<br>		c.JSON(http.StatusBadRequest, gin.<span class="hljs-keyword">H</span>&#123;<span class="hljs-string">&quot;error&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;product %s already exist&quot;</span>, product.Name)&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	product.CreatedAt = time.Now()<br><br>	<span class="hljs-comment">// 3. 逻辑处理</span><br>	<span class="hljs-keyword">u</span>.products[product.Name] = product<br>	<span class="hljs-keyword">log</span>.Printf(<span class="hljs-string">&quot;Register product %s success&quot;</span>, product.Name)<br><br>	<span class="hljs-comment">// 4. 返回结果</span><br>	c.JSON(http.StatusOK, product)<br>&#125;<br><br>func (<span class="hljs-keyword">u</span> *productHandler) <span class="hljs-built_in">Get</span>(c *gin.Context) &#123;<br>	<span class="hljs-keyword">u</span>.Lock()<br>	defer <span class="hljs-keyword">u</span>.Unlock()<br><br>	product, ok := <span class="hljs-keyword">u</span>.products[c.Param(<span class="hljs-string">&quot;name&quot;</span>)]<br>	<span class="hljs-keyword">if</span> !ok &#123;<br><br>		c.JSON(http.StatusNotFound, gin.<span class="hljs-keyword">H</span>&#123;<span class="hljs-string">&quot;error&quot;</span>: fmt.Errorf(<span class="hljs-string">&quot;can not found product %s&quot;</span>, c.Param(<span class="hljs-string">&quot;name&quot;</span>))&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	c.JSON(http.StatusOK, product)<br>&#125;<br><br>func router() http.Handler &#123;<br>	router := gin.Default()<br>	productHandler := newProductHandler()<br>	<span class="hljs-comment">// 路由分组/中间件/认证</span><br>	v1 := router.<span class="hljs-built_in">Group</span>(<span class="hljs-string">&quot;/v1&quot;</span>)<br>	productv1 := v1.<span class="hljs-built_in">Group</span>(<span class="hljs-string">&quot;/products&quot;</span>)<br>	productv1.<span class="hljs-keyword">POST</span>(<span class="hljs-string">&quot;&quot;</span>, productHandler.Create)<br>  <span class="hljs-comment">// Gin支持两种路由匹配规则</span><br>  <span class="hljs-comment">//  /products/:name 精确匹配</span><br>  <span class="hljs-comment">//  /products/*name 模糊匹配</span><br>	productv1.<span class="hljs-built_in">GET</span>(<span class="hljs-string">&quot;:name&quot;</span>, productHandler.Get)<br>	<span class="hljs-keyword">return</span> router<br>&#125;<br><br>func main() &#123;<br>	<span class="hljs-keyword">var</span> eg errgroup.Group<br><br>	<span class="hljs-comment">// 一进程多端口</span><br>  <span class="hljs-comment">// Gin是基于net/http包封装的web框架</span><br>	insecureServer := &amp;http.Server&#123;<br>		Addr:         <span class="hljs-string">&quot;:8080&quot;</span>,<br>		Handler:      router(),<br>		ReadTimeout:  5 * time.Second,<br>		WriteTimeout: 10 * time.Second,<br>	&#125;<br><br>	secureServer := &amp;http.Server&#123;<br>		Addr:         <span class="hljs-string">&quot;:8443&quot;</span>,<br>		Handler:      router(),<br>		ReadTimeout:  5 * time.Second,<br>		WriteTimeout: 10 * time.Second,<br>	&#125;<br><br>	eg.Go(func() <span class="hljs-keyword">error</span> &#123;<br>		<span class="hljs-keyword">err</span> := insecureServer.ListenAndServe()<br>		<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &amp;&amp; <span class="hljs-keyword">err</span> != http.ErrServerClosed &#123;<br>			<span class="hljs-keyword">log</span>.Fatal(<span class="hljs-keyword">err</span>)<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">err</span><br>	&#125;)<br><br>	eg.Go(func() <span class="hljs-keyword">error</span> &#123;<br>		path, <span class="hljs-keyword">err</span> := os.Getwd()<br>		<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>			<span class="hljs-keyword">log</span>.Println(<span class="hljs-keyword">err</span>)<br>		&#125;<br>		<span class="hljs-keyword">log</span>.Println(path)<br>		<span class="hljs-keyword">err</span> = secureServer.ListenAndServeTLS(<span class="hljs-string">&quot;./server.pem&quot;</span>, <span class="hljs-string">&quot;./server.key&quot;</span>)<br>		<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &amp;&amp; <span class="hljs-keyword">err</span> != http.ErrServerClosed &#123;<br>			<span class="hljs-keyword">log</span>.Fatal(<span class="hljs-keyword">err</span>)<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">err</span><br>	&#125;)<br><br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> := eg.Wait(); <span class="hljs-keyword">err</span> != nil &#123;<br>		<span class="hljs-keyword">log</span>.Fatal(<span class="hljs-keyword">err</span>)<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>支持HTTP方法: GET/POST/PUT/PATCH/DELETE/OPTIONS</li>
<li>支持不同位置的HTTP参数:<ul>
<li>路径参数 path tag uri /user/:name name就是路径参数<figure class="highlight makefile"><table><tr><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">路径参数: ShouldBindUri, BindUri</span><br></code></pre></td></tr></table></figure></li>
<li>查询字符串参数 query tag form /welcome?firstname=xx firstname就是查询参数<figure class="highlight makefile"><table><tr><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">查询字符串参数: ShouldBindQuery, BindQuery</span><br></code></pre></td></tr></table></figure></li>
<li>表单参数 form tag form curl -X POST -F ‘username=colins’ <a href="http://mydomain.com/login">http://mydomain.com/login</a>, username就是表单参数<figure class="highlight makefile"><table><tr><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">表单参数: ShouldBind</span><br></code></pre></td></tr></table></figure></li>
<li>HTTP头参数 header tag header curl -X POST -H ‘Content-Type:application/json’ <a href="http://mydomain.com/login">http://mydomain.com/login</a> Content-Type就是HTTP头参数<figure class="highlight ldif"><table><tr><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">HTTP头参数</span>: ShouldBindHeader, BindHeader<br></code></pre></td></tr></table></figure></li>
<li>消息体参数 body tag json/xml curl -X POST -H ‘Content-Type:application/json’ -d ‘{“username”:”colins”}’ <a href="http://mydomain.com/login">http://mydomain.com/login</a>, username就是消息体参数<figure class="highlight makefile"><table><tr><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">消息体参数: ShouldBindJSON, BindJSON</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>支持HTTP路由和路由分组</li>
<li>支持自定义Log</li>
<li>支持binding和validation,</li>
<li>支持重定向</li>
<li>支持basic auth middleware</li>
<li>支持自定义HTTP配置</li>
<li>支持优雅关闭</li>
<li>支持HTTP2</li>
<li>支持设置获取cookie</li>
</ul>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><ul>
<li><p>ping-pong</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;net/http&quot;</span><br><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	r := gin.Default()<br>	r.GET(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>		c.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span>&#125;)<br>	&#125;)<br><br>	r.Run()<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>启动 &amp; 运行<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">➜ go run main.go<br>[GIN-<span class="hljs-keyword">debug</span>] [<span class="hljs-built_in">WARNING</span>] Creating an Engine instance <span class="hljs-keyword">with</span> the Logger <span class="hljs-keyword">and</span> Recovery middleware already attached.<br><br>[GIN-<span class="hljs-keyword">debug</span>] [<span class="hljs-built_in">WARNING</span>] Running <span class="hljs-keyword">in</span> &quot;debug&quot; mode. Switch <span class="hljs-keyword">to</span> &quot;release&quot; mode <span class="hljs-keyword">in</span> production.<br> - <span class="hljs-keyword">using</span> env:	export GIN_MODE=<span class="hljs-keyword">release</span><br> - <span class="hljs-keyword">using</span> code:	gin.SetMode(gin.ReleaseMode)<br><br>[GIN-<span class="hljs-keyword">debug</span>] <span class="hljs-keyword">GET</span>    /ping                     <span class="hljs-comment">--&gt; main.main.func1 (3 handlers)</span><br>[GIN-<span class="hljs-keyword">debug</span>] Environment variable PORT <span class="hljs-keyword">is</span> undefined. <span class="hljs-keyword">Using</span> port :<span class="hljs-number">8080</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span><br>[GIN-<span class="hljs-keyword">debug</span>] Listening <span class="hljs-keyword">and</span> serving HTTP <span class="hljs-keyword">on</span> :<span class="hljs-number">8080</span><br><br># 调用<br>➜ curl -X <span class="hljs-keyword">GET</span> http://localhost:<span class="hljs-number">8080</span>/ping<br>&#123;&quot;message&quot;:&quot;pong&quot;&#125;%<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>源码分析</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"># gin.Default<br><br><span class="hljs-comment">// Default returns an Engine instance with the Logger and Recovery middleware already attached.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Default</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>	debugPrintWARNINGDefault()  <span class="hljs-comment">// 检查Go版本是否达到Gin最低要求</span><br>	engine := New()<br>	engine.Use(Logger(), Recovery()) <span class="hljs-comment">// 引入中间件</span><br>	<span class="hljs-keyword">return</span> engine<br>&#125;<br><br># gin.New<br><span class="hljs-comment">// New returns a new blank Engine instance without any middleware attached.</span><br><span class="hljs-comment">// By default the configuration is:</span><br><span class="hljs-comment">// - RedirectTrailingSlash:  true</span><br><span class="hljs-comment">// - RedirectFixedPath:      false</span><br><span class="hljs-comment">// - HandleMethodNotAllowed: false</span><br><span class="hljs-comment">// - ForwardedByClientIP:    true</span><br><span class="hljs-comment">// - UseRawPath:             false</span><br><span class="hljs-comment">// - UnescapePathValues:     true</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>	debugPrintWARNINGNew()<br>	engine := &amp;Engine&#123; <span class="hljs-comment">// 初始化</span><br>		RouterGroup: RouterGroup&#123; <span class="hljs-comment">// 路由组</span><br>			Handlers: <span class="hljs-literal">nil</span>,<br>			basePath: <span class="hljs-string">&quot;/&quot;</span>,<br>			root:     <span class="hljs-literal">true</span>,<br>		&#125;,<br>		FuncMap:                template.FuncMap&#123;&#125;,<br>		RedirectTrailingSlash:  <span class="hljs-literal">true</span>,<br>		RedirectFixedPath:      <span class="hljs-literal">false</span>,<br>		HandleMethodNotAllowed: <span class="hljs-literal">false</span>,<br>		ForwardedByClientIP:    <span class="hljs-literal">true</span>,<br>		RemoteIPHeaders:        []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;X-Forwarded-For&quot;</span>, <span class="hljs-string">&quot;X-Real-IP&quot;</span>&#125;,<br>		TrustedProxies:         []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;0.0.0.0/0&quot;</span>&#125;,<br>		AppEngine:              defaultAppEngine,<br>		UseRawPath:             <span class="hljs-literal">false</span>,<br>		RemoveExtraSlash:       <span class="hljs-literal">false</span>,<br>		UnescapePathValues:     <span class="hljs-literal">true</span>,<br>		MaxMultipartMemory:     defaultMultipartMemory, <span class="hljs-comment">// const defaultMultipartMemory = 32 &lt;&lt; 20 // 32 MB</span><br>		trees:                  <span class="hljs-built_in">make</span>(methodTrees, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>),<br>		delims:                 render.Delims&#123;Left: <span class="hljs-string">&quot;&#123;&#123;&quot;</span>, Right: <span class="hljs-string">&quot;&#125;&#125;&quot;</span>&#125;, <span class="hljs-comment">// HTML 模版左右定界符</span><br>		secureJSONPrefix:       <span class="hljs-string">&quot;while(1);&quot;</span>,<br>	&#125;<br>	engine.RouterGroup.engine = engine<br>	engine.pool.New = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br>		<span class="hljs-keyword">return</span> engine.allocateContext()<br>	&#125;<br>	<span class="hljs-keyword">return</span> engine<br>&#125;<br><br># r.GET()<br><br>  <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(group *RouterGroup)</span> <span class="hljs-title">handle</span><span class="hljs-params">(httpMethod, relativePath <span class="hljs-keyword">string</span>, handlers HandlersChain)</span> <span class="hljs-title">IRoutes</span></span> &#123;<br>    absolutePath := group.calculateAbsolutePath(relativePath) <span class="hljs-comment">// 计算路由的绝对路径</span><br>    handlers = group.combineHandlers(handlers)<br>    group.engine.addRoute(httpMethod, absolutePath, handlers) <span class="hljs-comment">// 追加到树</span><br>    <span class="hljs-keyword">return</span> group.returnObj()<br>  &#125;<br><br># r.Run()<br><br><span class="hljs-comment">// Run attaches the router to a http.Server and starts listening and serving HTTP requests.</span><br><span class="hljs-comment">// It is a shortcut for http.ListenAndServe(addr, router)</span><br><span class="hljs-comment">// Note: this method will block the calling goroutine indefinitely unless an error happens.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span> <span class="hljs-title">Run</span><span class="hljs-params">(addr ...<span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; debugPrintError(err) &#125;()<br><br>	trustedCIDRs, err := engine.prepareTrustedCIDRs()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	engine.trustedCIDRs = trustedCIDRs<br>	address := resolveAddress(addr)<br>	debugPrint(<span class="hljs-string">&quot;Listening and serving HTTP on %s\n&quot;</span>, address)<br>	err = http.ListenAndServe(address, engine)<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// 上下文池化防止频繁生成上下文对象，提高性能</span><br><span class="hljs-comment">// ServeHTTP conforms to the http.Handler interface.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;<br>	c := engine.pool.Get().(*Context) <span class="hljs-comment">// sync.Pool 对象池中获取一个上下文对象</span><br>	c.writermem.reset(w)<br>	c.Request = req<br>	c.reset()<br><br>	engine.handleHTTPRequest(c)<br><br>	engine.pool.Put(c) <span class="hljs-comment">// 返回对象池</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Web Framework</category>
      </categories>
  </entry>
  <entry>
    <title>Makefile Intro</title>
    <url>/2021/09/08/Makefile-Intro/</url>
    <content><![CDATA[<h1 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h1><blockquote>
<p>Makefile 关系到整个工程的编译规则(先后顺序)<br>make: 一个解释makefile中指令的命令工具</p>
</blockquote>
<span id="more"></span>

<h2 id="课前小知识"><a href="#课前小知识" class="headerlink" title="课前小知识"></a>课前小知识</h2><ul>
<li>编译(compile)、链接(link)、库文件(Library File)<ul>
<li> 编译: 将源文件编译成中间代码文件(windows .obj文件, Unix下的.o文件)</li>
<li>编译器值检测程序语法和函数、变量是否被声明.</li>
<li> 链接: 将大量的Object File合成执行文件</li>
<li>链接器会在所有的Object File中寻找函数的实现</li>
<li> 库文件: 将编译的中间文件打包(windows .lib文件, Unix .a Archive File)</li>
</ul>
</li>
</ul>
<h2 id="Makefile-1"><a href="#Makefile-1" class="headerlink" title="Makefile"></a>Makefile</h2><ul>
<li>规则<blockquote>
<p>prerequisties中如果有一个以上的文件比target文件要新的话，command所定义的命令就会被执行</p>
</blockquote>
</li>
</ul>
  <figure class="highlight jboss-cli"><table><tr><td class="code"><pre><code class="hljs jboss-cli">target <span class="hljs-string">...</span> : prerequisities <span class="hljs-string">...</span><br>  <span class="hljs-keyword">command</span><br>  <span class="hljs-string">...</span><br>  <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>
<div class="code-wrapper"><pre><code class="hljs">- target:
  - object file 目标文件:
  - execute file 可执行文件:
  - label 标签:
- prerequisites:
  - 依赖的文件
- command:
  - 执行的命令
</code></pre></div>
<ul>
<li>make如何工作<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"># makefile<br><span class="hljs-keyword">edit</span> : main.<span class="hljs-keyword">o</span> kbd.<span class="hljs-keyword">o</span> <span class="hljs-keyword">command</span>.<span class="hljs-keyword">o</span> <span class="hljs-keyword">display</span>.<span class="hljs-keyword">o</span> \<br>&gt; <span class="hljs-keyword">make</span> 会一层层找文件的依赖关系，知道最终编译初第一个目标文件, <span class="hljs-keyword">make</span>只关注文件的依赖性.<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>[跟我一起写Makefile (PDF重制版)] (<a href="https://seisman.github.io/how-to-write-makefile/Makefile.pdf">https://seisman.github.io/how-to-write-makefile/Makefile.pdf</a>)</li>
</ul>
]]></content>
      <categories>
        <category>Computer Science</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL Index Intro</title>
    <url>/2021/09/08/MySQL-Index-Intro/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>数据结构-Radix-Tree</title>
    <url>/2021/09/08/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-Radix-Tree/</url>
    <content><![CDATA[<h1 id="Radix-Tree-基数树"><a href="#Radix-Tree-基数树" class="headerlink" title="Radix Tree - 基数树"></a>Radix Tree - 基数树</h1><blockquote>
<p>radix tree用于表示一种空间优化的tree. 假如树中的一个节点是父节点的唯一子节点，那么该节点将会与父节点进行合并 radix tree的边沿edges可以是一个或者多个元素<br>元素个数不是太多，但是元素之间通常有很长的相同前缀时很适合采用radix tree存储<br>Golang的web框架gin使用radix tree作为路由查找的算法.</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"># gin/gin.go<br><br>// <span class="hljs-keyword">method</span> -&gt; HTTP <span class="hljs-keyword">Method</span> &#123;<span class="hljs-keyword">GET</span>,PUT,POST,<span class="hljs-keyword">DELETE</span>&#125;<br>func (engine *Engine) addRoute(<span class="hljs-keyword">method</span>, <span class="hljs-type">path</span> string, handlers HandlersChain) &#123;<br>	assert1(<span class="hljs-type">path</span>[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;/&#x27;</span>, &quot;path must begin with &#x27;/&#x27;&quot;)<br>	assert1(<span class="hljs-keyword">method</span> != &quot;&quot;, &quot;HTTP method can not be empty&quot;)<br>	assert1(len(handlers) &gt; <span class="hljs-number">0</span>, &quot;there must be at least one handler&quot;)<br><br>	debugPrintRoute(<span class="hljs-keyword">method</span>, <span class="hljs-type">path</span>, handlers)<br><br>  // 每一个<span class="hljs-keyword">method</span>对应一颗radix tree<br>	root := engine.trees.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">method</span>)<br>	<span class="hljs-keyword">if</span> root == nil &#123;<br>    // 如果获取不到<span class="hljs-keyword">method</span>对应的树，就创建<br>		root = <span class="hljs-built_in">new</span>(node)<br>		root.fullPath = &quot;/&quot;<br>		engine.trees = append(engine.trees, methodTree&#123;<span class="hljs-keyword">method</span>: <span class="hljs-keyword">method</span>, root: root&#125;)<br>	&#125;<br>	root.addRoute(<span class="hljs-type">path</span>, handlers)<br><br>	// <span class="hljs-keyword">Update</span> maxParams<br>	<span class="hljs-keyword">if</span> paramsCount := countParams(<span class="hljs-type">path</span>); paramsCount &gt; engine.maxParams &#123;<br>		engine.maxParams = paramsCount<br>	&#125;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Computer Science</category>
      </categories>
  </entry>
  <entry>
    <title>静态代码检查 golangci-lint</title>
    <url>/2021/09/08/%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5-golangci-lint/</url>
    <content><![CDATA[<h1 id="静态代码检查"><a href="#静态代码检查" class="headerlink" title="静态代码检查"></a>静态代码检查</h1><span id="more"></span>

<h2 id="golangci-lint"><a href="#golangci-lint" class="headerlink" title="golangci-lint"></a>golangci-lint</h2><blockquote>
<p>golangci-lint is a fast Go linters runner. It runs linters in parallel, uses caching, supports yaml config, has integrations with all major IDE and has dozens of linters included.</p>
</blockquote>
]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Error Code Design Intro</title>
    <url>/2021/09/09/Error-Code-Design-Intro/</url>
    <content><![CDATA[<h1 id="错误码设计"><a href="#错误码设计" class="headerlink" title="错误码设计"></a>错误码设计</h1><ul>
<li>错误码实现方式<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-number">1</span>. 无论请求成功或失败，始终返回<span class="hljs-number">200</span> http status <span class="hljs-selector-tag">code</span><br> &gt; 每次请求，都需要解析HTTP <span class="hljs-selector-tag">Body</span>,从中解析出错误码和错误信息.<br><span class="hljs-number">2</span>. 返回合适的HTTP <span class="hljs-selector-tag">Code</span>. 并在<span class="hljs-selector-tag">Body</span>中返回错误信息和自定义业务<span class="hljs-selector-tag">Code</span><br><span class="hljs-number">3</span>. 返回合适的HTTP <span class="hljs-selector-tag">Code</span>, 并在<span class="hljs-selector-tag">Body</span>中详尽的错误信息<br></code></pre></td></tr></table></figure></li>
<li>业务Code码设计<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">  <br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Microservice</category>
      </categories>
  </entry>
  <entry>
    <title>SwaggerAPI intro</title>
    <url>/2021/09/09/SwaggerAPI-intro/</url>
    <content><![CDATA[<h1 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h1><blockquote>
<p>Swagger是一套围绕OpenAPI规范构建的开源工具,可以设计·构建·编写·使用RESTAPI</p>
</blockquote>
<ul>
<li>Swagger编辑器:</li>
<li>Swagger UI: 将OpenAPI规范呈现为交互式API文档，并可以在浏览器中尝试API调用</li>
<li>Swagger Codegen: 根据OpenAPI规范，生成服务器存根和客户端代码库</li>
</ul>
<span id="more"></span>

<h2 id="Swagger和OpenAPI区别"><a href="#Swagger和OpenAPI区别" class="headerlink" title="Swagger和OpenAPI区别"></a>Swagger和OpenAPI区别</h2><ul>
<li>OpenAPI<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm">OpenAPI是一个API规范，前身是<span class="hljs-keyword">Swagger规范. </span><span class="hljs-keyword">Swagger是实现规范的工具</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="go-swagger生成Swagger-API-文档"><a href="#go-swagger生成Swagger-API-文档" class="headerlink" title="go-swagger生成Swagger API 文档"></a>go-swagger生成Swagger API 文档</h2><ul>
<li><p>go-swagger特征</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 根据Swagger定义文件生成服务端代码<br><span class="hljs-bullet">2.</span> 根据Swagger定义文件生成客户端代码<br><span class="hljs-bullet">3.</span> 校验Swagger定义文件是否正确<br><span class="hljs-bullet">4.</span> 启动一个HTTP服务器，使我们可以通过浏览器访问API文档<br><span class="hljs-bullet">5.</span> 根据Swagger文档定义的参数生成Go Model结构体定义<br></code></pre></td></tr></table></figure></li>
<li><p>Swagger工具</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">github.com<span class="hljs-regexp">/chyidl/</span>noone via 🐹 v1.<span class="hljs-number">17</span><br>➜ go get -u github.com<span class="hljs-regexp">/go-swagger/g</span>o-swagger<span class="hljs-regexp">/cmd/</span>swagger<br><br>github.com<span class="hljs-regexp">/chyidl/</span>noone via 🐹 v1.<span class="hljs-number">17</span> took <span class="hljs-number">25</span>s<br>➜ swagger version<br>version: v0.<span class="hljs-number">27.0</span><br>commit: (unknown, mod sum: <span class="hljs-string">&quot;h1:K7+nkBuf4oS1jTBrdvWqYFpqD69V5CN8HamZzCDDhAI=&quot;</span>)<br><br>github.com<span class="hljs-regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="hljs-number">17</span><br>➜ swagger generate spec -o swagger.yaml<br>  -o: 指定输出文件名<br><br>github.com<span class="hljs-regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="hljs-number">17</span><br>➜ ls<br>api          docs         go.mod       main.go      swagger.yaml<br>github.com<span class="hljs-regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="hljs-number">17</span><br>➜ swagger serve --no-open -F=swagger --port <span class="hljs-number">36666</span> swagger.yaml<br><span class="hljs-number">2021</span><span class="hljs-regexp">/09/</span><span class="hljs-number">09</span> <span class="hljs-number">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">09</span> serving docs at http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">36666</span>/docs<br>  --no-open: 禁止调用浏览器打开<br>  -F: 指定文档风格<br>  --port: 指定启动的HTTP服务监听<br><br>github.com<span class="hljs-regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="hljs-number">17</span><br>➜ swagger generate spec -i .<span class="hljs-regexp">/swagger.yaml -o ./</span>swagger.json<br><br><span class="hljs-regexp">//</span> swagger:route POST /users user createUserRequest<br><span class="hljs-regexp">//</span> Create a user <span class="hljs-keyword">in</span> memory.<br><span class="hljs-regexp">//</span> responses:<br><span class="hljs-regexp">//</span>   <span class="hljs-number">200</span>: createUserResponse<br><span class="hljs-regexp">//</span>   default: errResponse<br><br><span class="hljs-regexp">//</span> swagger:route GET <span class="hljs-regexp">/users/</span>&#123;name&#125; user getUserRequest<br><span class="hljs-regexp">//</span> Get a user from memory.<br><span class="hljs-regexp">//</span> responses:<br><span class="hljs-regexp">//</span>   <span class="hljs-number">200</span>: getUserResponse<br><span class="hljs-regexp">//</span>   default: errResponse<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Computer Science</category>
      </categories>
  </entry>
  <entry>
    <title>gorm intro</title>
    <url>/2021/09/09/gorm-intro/</url>
    <content><![CDATA[<h1 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h1>]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Go Concurrency Patterns</title>
    <url>/2021/09/10/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><ul>
<li><p>Simplicity: 简单</p>
<blockquote>
<p>Simplicity is prerequisite for reliability. 简单是可靠的先觉条件</p>
</blockquote>
</li>
<li><p>Readablity: 可读性</p>
<blockquote>
<p>Readability is essential for maintainablity. 可读性对于可维护性至关重要<br>Programs must be written for people to read, and only incidentally for machine to execute. 程序必须是为人们阅读而编写的，而偶然为及其执行而编写</p>
</blockquote>
</li>
<li><p>Productivity: 生产力</p>
<blockquote>
<p>Design is the art of arranging code to work today, and be changeable forever.</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<h2 id="A-First-Look-Go-Programming-Language"><a href="#A-First-Look-Go-Programming-Language" class="headerlink" title="A First Look - Go Programming Language"></a>A First Look - Go Programming Language</h2><ul>
<li><p>Hello World</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">package main                    <span class="hljs-regexp">//</span> 声明本文件的包名<br><br><span class="hljs-regexp">//</span> <span class="hljs-number">1</span>. 在import中可以使用相对路径 .<span class="hljs-regexp">/ ../</span> 引入package<br><span class="hljs-regexp">//</span> <span class="hljs-number">2</span>. 如果没有相对路径 Go会从<span class="hljs-variable">$GOPATH</span><span class="hljs-regexp">/src/</span>目录寻找<br>import <span class="hljs-string">&quot;fmt&quot;</span>                    <span class="hljs-regexp">//</span> import语言的fmt库 - 用于输出<br><br><span class="hljs-keyword">func</span> main() &#123;<br>	fmt.Println(<span class="hljs-string">&quot;hello world&quot;</span>)<br><br>  <span class="hljs-regexp">//</span> fmt 输出格式<br>  fmt.Printf(<span class="hljs-string">&quot;%t\n&quot;</span>, <span class="hljs-number">1</span> == <span class="hljs-number">2</span>)<br> fmt.Printf(<span class="hljs-string">&quot;二进制: %b\n&quot;</span>, <span class="hljs-number">255</span>)<br> fmt.Printf(<span class="hljs-string">&quot;八进制: %o\n&quot;</span>, <span class="hljs-number">255</span>)<br> fmt.Printf(<span class="hljs-string">&quot;十六进制: %x\n&quot;</span>, <span class="hljs-number">255</span>)<br> fmt.Printf(<span class="hljs-string">&quot;浮点数: %f\n&quot;</span>, math.Pi)<br> fmt.Printf(<span class="hljs-string">&quot;字符串: %s\n&quot;</span>, <span class="hljs-string">&quot;hello world&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>var &amp; const</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 声明初始化一个变量</span><br><span class="hljs-keyword">var</span> x <span class="hljs-keyword">int</span> = <span class="hljs-number">100</span><br><span class="hljs-keyword">var</span> str <span class="hljs-keyword">string</span> = <span class="hljs-string">&quot;hello world&quot;</span><br><span class="hljs-comment">// 声明初始化多个变量</span><br><span class="hljs-keyword">var</span> i, j, k <span class="hljs-keyword">int</span> = <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span><br><span class="hljs-comment">// 不指明类型，通过初始化值推导</span><br><span class="hljs-keyword">var</span> b = <span class="hljs-literal">true</span> <span class="hljs-comment">// bool 类型</span><br>x := <span class="hljs-number">100</span><br><br><span class="hljs-comment">// 常量</span><br><span class="hljs-keyword">const</span> p <span class="hljs-keyword">string</span> = <span class="hljs-string">&quot;hello world&quot;</span><br><span class="hljs-keyword">const</span> pi <span class="hljs-keyword">float32</span> = <span class="hljs-number">3.1415926</span><br></code></pre></td></tr></table></figure></li>
<li><p>Array &amp; Slice</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">// Slices in the runtime are represented by three components:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// type slice struct &#123;</span><br><span class="hljs-comment">// 	ptr unsafe.Pointer          // 指向存放数据的数组指针</span><br><span class="hljs-comment">// 	len int                     // 长度有多大</span><br><span class="hljs-comment">// 	cap int                     // 容量有多大</span><br><span class="hljs-comment">// &#125;</span><br><br># 使用反射reflect.DeepEqual() 进行深度比较<br><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> data <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-built_in">len</span> <span class="hljs-keyword">int</span><br>	p   *<span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// 比较两个结构体中数据是否相同</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	v1 := data&#123;&#125;<br>	v2 := data&#123;&#125;<br>	fmt.Println(<span class="hljs-string">&quot;v1 == v2:&quot;</span>, reflect.DeepEqual(v1, v2))<br>	<span class="hljs-comment">// prints: v1 == v2: true</span><br><br>	m1 := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;one&quot;</span>: <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;two&quot;</span>: <span class="hljs-string">&quot;b&quot;</span>&#125;<br>	m2 := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;two&quot;</span>: <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;one&quot;</span>: <span class="hljs-string">&quot;a&quot;</span>&#125;<br>	fmt.Println(<span class="hljs-string">&quot;m1 == m2:&quot;</span>, reflect.DeepEqual(m1, m2))<br>	<span class="hljs-comment">// prints: m1 == m2: true</span><br><br>	s1 := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br>	s2 := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br>	fmt.Println(<span class="hljs-string">&quot;s1 == s2:&quot;</span>, reflect.DeepEqual(s1, s2))<br>	<span class="hljs-comment">// prints: s1 == s2: true</span><br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Go-Model-CSP"><a href="#Go-Model-CSP" class="headerlink" title="Go Model: CSP"></a>Go Model: CSP</h2><ul>
<li>CSP:<blockquote>
<p>Communicating Sequential Processes</p>
</blockquote>
</li>
</ul>
<h2 id="并发-Concurrency-amp-amp-并行-Parallelism"><a href="#并发-Concurrency-amp-amp-并行-Parallelism" class="headerlink" title="并发(Concurrency) &amp;&amp; 并行(Parallelism)"></a>并发(Concurrency) &amp;&amp; 并行(Parallelism)</h2><ul>
<li><p>并发(Concurrency):</p>
<blockquote>
<p>Programming as the composition of independently executing processes.<br>Concurrency is about dealing with lots of things at once.<br>Concurreny is about structure</p>
</blockquote>
</li>
<li><p>并行(Parallelism)</p>
<blockquote>
<p>programming as the simultaneous execution of computations.<br>Parallelism is about doing lots of things at once.<br>Parallelism is about execution</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>A well-written concurrent program might run efficiently in parallel on a multiprocessor.</p>
</blockquote>
<h2 id="进程-amp-线程"><a href="#进程-amp-线程" class="headerlink" title="进程 &amp; 线程"></a>进程 &amp; 线程</h2><blockquote>
<p>进程 Process: 一般是资源分配单元，一个进程拥有堆、栈、虚存空间(页表)、文件描述符<br>线程 Thread: CPU进行调度和执行的实体<br>主进程/主线程: 如果一个进程启动后，没有在创建额外的线程，那么这个进程一般称为主进程或主线程。</p>
</blockquote>
<h2 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h2><blockquote>
<p>Concurrent execution<br>A goroutine is a function running independently in the same address space as other goroutines<br>has its own call stack, which grows and shrinks as required.</p>
</blockquote>
<ul>
<li>goroutine 生命周期管理<ul>
<li>尽量避免在请求中直接启动goroutine处理问题，通过启动worker进行消费，避免由于请求量大，创建大量的goroutine导致OOM<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;context&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;log&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 初始化操作</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	setup()<br><br>	<span class="hljs-comment">// 监听服务退出</span><br>	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error, <span class="hljs-number">2</span>)<br>	<span class="hljs-comment">// 控制服务退出</span><br>	stop := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment">// for debug</span><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		done &lt;- pprof(stop)<br>	&#125;()<br><br>	<span class="hljs-comment">// 主程序</span><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		done &lt;- app(stop)<br>	&#125;()<br><br>	<span class="hljs-keyword">var</span> stoped <span class="hljs-keyword">bool</span><br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">cap</span>(done); i++ &#123;<br>		<span class="hljs-keyword">if</span> err := &lt;-done; err != <span class="hljs-literal">nil</span> &#123;<br>			log.Printf(<span class="hljs-string">&quot;server exit err: %+v&quot;</span>, err)<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> !stoped &#123;<br>			stoped = <span class="hljs-literal">true</span><br>			<span class="hljs-built_in">close</span>(stop)<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">app</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>	mux := http.NewServeMux()<br>	mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>		w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>	&#125;)<br><br>	<span class="hljs-keyword">return</span> server(mux, <span class="hljs-string">&quot;:8080&quot;</span>, stop)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pprof</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		server(http.DefaultServeMux, <span class="hljs-string">&quot;:8081&quot;</span>, stop)<br>	&#125;()<br><br>	time.Sleep(<span class="hljs-number">5</span> * time.Second)<br>	<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;mock pprof exit&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// 启动服务</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">server</span><span class="hljs-params">(handler http.Handler, addr <span class="hljs-keyword">string</span>, stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>	s := http.Server&#123;<br>		Handler: handler,<br>		Addr:    addr,<br>	&#125;<br><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		&lt;-stop<br>		log.Printf(<span class="hljs-string">&quot;server will exiting, addr: %s&quot;</span>, addr)<br>		s.Shutdown(context.Background())<br>	&#125;()<br><br>	<span class="hljs-keyword">return</span> s.ListenAndServe()<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h2><blockquote>
<p>Synchronization and messaging<br>Channels are typed values that allow goroutines to synchronize and exchange information<br>Channels are first-class values<br>A channel in Go provides a connection between two goroutines, allowing them to communicate</p>
</blockquote>
<ul>
<li><p>无缓冲通道 no-buffer channel</p>
<blockquote>
<p>发送者sender 和 接收者 receiver 必须同时准备好才能进行下去</p>
</blockquote>
</li>
<li><p>缓冲通道 buffer channel</p>
<blockquote>
<p>缓冲通道解决同步等待问题</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Declaring and initializing</span><br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br><br><span class="hljs-comment">// Sending on a channel.</span><br>c &lt;- <span class="hljs-number">1</span><br><br><span class="hljs-comment">// Receiving from a channel</span><br><span class="hljs-comment">// The &quot;arrow&quot; indicates the direction of data flow.</span><br>value = &lt;-c<br><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><blockquote>
<p>Multi-way concurrent control<br>The select statement is like a switch, but the decision is based on ability to communicate rather than equal values</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Fan-in using select</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fanIn</span><span class="hljs-params">(input1, input2 &lt;- <span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)</span> &lt;- <span class="hljs-title">chan</span> <span class="hljs-title">string</span></span> &#123;<br>  c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br>  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br>      <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> s := &lt;-input1: c &lt;- s<br>        <span class="hljs-keyword">case</span> s := &lt;-input2: c &lt;- s<br>      &#125;<br>    &#125;<br>  &#125;()<br>  <span class="hljs-keyword">return</span> c<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="Closures"><a href="#Closures" class="headerlink" title="Closures"></a>Closures</h2><h3 id="Demo-Project"><a href="#Demo-Project" class="headerlink" title="Demo Project"></a>Demo Project</h3><blockquote>
<p>Always use the right tool for the job</p>
</blockquote>
<ul>
<li>Google Search: A fake framework<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> google_search_test<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;math/rand&quot;</span><br>	<span class="hljs-string">&quot;testing&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Result <span class="hljs-keyword">string</span><br><br><span class="hljs-keyword">var</span> (<br>	Web    = fakeSearch(<span class="hljs-string">&quot;web&quot;</span>)<br>	Web1   = fakeSearch(<span class="hljs-string">&quot;web1&quot;</span>)<br>	Web2   = fakeSearch(<span class="hljs-string">&quot;web2&quot;</span>)<br>	Image  = fakeSearch(<span class="hljs-string">&quot;image&quot;</span>)<br>	Image1 = fakeSearch(<span class="hljs-string">&quot;Image1&quot;</span>)<br>	Image2 = fakeSearch(<span class="hljs-string">&quot;Image2&quot;</span>)<br>	Video  = fakeSearch(<span class="hljs-string">&quot;video&quot;</span>)<br>	Video1 = fakeSearch(<span class="hljs-string">&quot;Video1&quot;</span>)<br>	Video2 = fakeSearch(<span class="hljs-string">&quot;Video2&quot;</span>)<br>)<br><br><span class="hljs-keyword">type</span> Search <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Result</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fakeSearch</span><span class="hljs-params">(kind <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Search</span></span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Result</span></span> &#123;<br>		time.Sleep(time.Duration(rand.Intn(<span class="hljs-number">100</span>)) * time.Millisecond)<br>		<span class="hljs-keyword">return</span> Result(fmt.Sprintf(<span class="hljs-string">&quot;%s result for %q\n&quot;</span>, kind, query))<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Google</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(results []Result)</span></span> &#123;<br>	results = <span class="hljs-built_in">append</span>(results, Web(query))<br>	results = <span class="hljs-built_in">append</span>(results, Image(query))<br>	results = <span class="hljs-built_in">append</span>(results, Video(query))<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoogleV2</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(results []Result)</span></span> &#123;<br>	<span class="hljs-comment">// Run the Web, Image, and Video searches concurrently</span><br>	c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- Web(query) &#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- Image(query) &#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- Video(query) &#125;()<br><br>	<span class="hljs-comment">// wait for all results</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ &#123;<br>		result := &lt;-c<br>		results = <span class="hljs-built_in">append</span>(results, result)<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoogleV21</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(results []Result)</span></span> &#123;<br>	<span class="hljs-comment">// Don;t wait for slow servers. No locks. No condition variables.</span><br>	c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- Web(query) &#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- Image(query) &#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- Video(query) &#125;()<br><br>	timeout := time.After(<span class="hljs-number">80</span> * time.Millisecond)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> result := &lt;-c:<br>			results = <span class="hljs-built_in">append</span>(results, result)<br>		<span class="hljs-keyword">case</span> &lt;-timeout:<br>			fmt.Println(<span class="hljs-string">&quot;timed out&quot;</span>)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GoogleV3</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(results []Result)</span></span> &#123;<br>	c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- First(query, Web1, Web2) &#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- First(query, Image1, Image2) &#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c &lt;- First(query, Video1, Video2) &#125;()<br>	timeout := time.After(<span class="hljs-number">80</span> * time.Millisecond)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> result := &lt;-c:<br>			results = <span class="hljs-built_in">append</span>(results, result)<br>		<span class="hljs-keyword">case</span> &lt;-timeout:<br>			fmt.Println(<span class="hljs-string">&quot;timed out&quot;</span>)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">First</span><span class="hljs-params">(query <span class="hljs-keyword">string</span>, replicas ...Search)</span> <span class="hljs-title">Result</span></span> &#123;<br>	c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result)<br>	searchReplica := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123; c &lt;- replicas[i](query) &#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> replicas &#123;<br>		<span class="hljs-keyword">go</span> searchReplica(i)<br>	&#125;<br>	<span class="hljs-keyword">return</span> &lt;-c<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGoogle</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	rand.Seed(time.Now().UnixNano())<br>	start := time.Now()<br>	results := Google(<span class="hljs-string">&quot;golang&quot;</span>)<br>	elapsed := time.Since(start)<br>	fmt.Println(results)<br>	fmt.Println(elapsed)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGoogleV2</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	rand.Seed(time.Now().UnixNano())<br>	start := time.Now()<br>	results := GoogleV2(<span class="hljs-string">&quot;golang&quot;</span>)<br>	elapsed := time.Since(start)<br>	fmt.Println(results)<br>	fmt.Println(elapsed)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGoogleV21</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	rand.Seed(time.Now().UnixNano())<br>	start := time.Now()<br>	results := GoogleV21(<span class="hljs-string">&quot;golang&quot;</span>)<br>	elapsed := time.Since(start)<br>	fmt.Println(results)<br>	fmt.Println(elapsed)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGoogleV3</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	rand.Seed(time.Now().UnixNano())<br>	start := time.Now()<br>	results := GoogleV3(<span class="hljs-string">&quot;golang&quot;</span>)<br>	elapsed := time.Since(start)<br>	fmt.Println(results)<br>	fmt.Println(elapsed)<br>&#125;<br><br><br><span class="hljs-comment">// ➜ go test -v google_search_test.go</span><br><span class="hljs-comment">// === RUN   TestGoogle</span><br><span class="hljs-comment">// [web result for &quot;golang&quot;</span><br><span class="hljs-comment">//  image result for &quot;golang&quot;</span><br><span class="hljs-comment">//  video result for &quot;golang&quot;</span><br><span class="hljs-comment">// ]</span><br><span class="hljs-comment">// 31.882269ms</span><br><span class="hljs-comment">// --- PASS: TestGoogle (0.03s)</span><br><span class="hljs-comment">// === RUN   TestGoogleV2</span><br><span class="hljs-comment">// [web result for &quot;golang&quot;</span><br><span class="hljs-comment">//  image result for &quot;golang&quot;</span><br><span class="hljs-comment">//  video result for &quot;golang&quot;</span><br><span class="hljs-comment">// ]</span><br><span class="hljs-comment">// 49.036197ms</span><br><span class="hljs-comment">// --- PASS: TestGoogleV2 (0.05s)</span><br><span class="hljs-comment">// === RUN   TestGoogleV21</span><br><span class="hljs-comment">// [web result for &quot;golang&quot;</span><br><span class="hljs-comment">//  video result for &quot;golang&quot;</span><br><span class="hljs-comment">//  image result for &quot;golang&quot;</span><br><span class="hljs-comment">// ]</span><br><span class="hljs-comment">// 53.507162ms</span><br><span class="hljs-comment">// --- PASS: TestGoogleV21 (0.05s)</span><br><span class="hljs-comment">// === RUN   TestGoogleV3</span><br><span class="hljs-comment">// [Video2 result for &quot;golang&quot;</span><br><span class="hljs-comment">//  web1 result for &quot;golang&quot;</span><br><span class="hljs-comment">//  Image1 result for &quot;golang&quot;</span><br><span class="hljs-comment">// ]</span><br><span class="hljs-comment">// 41.612001ms</span><br><span class="hljs-comment">// --- PASS: TestGoogleV3 (0.04s)</span><br><span class="hljs-comment">// PASS</span><br><span class="hljs-comment">// ok  	command-line-arguments	0.301s</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Best-Practice-Writing-Go-Code-最佳实践"><a href="#Best-Practice-Writing-Go-Code-最佳实践" class="headerlink" title="Best Practice Writing Go Code: 最佳实践"></a>Best Practice Writing Go Code: 最佳实践</h2><ul>
<li>software programming 软件编程</li>
<li>software engineering 软件工程</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">Practical Go: Real world advice for writing maintainable Go Programs</a></li>
</ul>
]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Ansible Intro</title>
    <url>/2021/09/11/Ansible-Intro/</url>
    <content><![CDATA[<h1 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a>Ansible</h1><blockquote>
<p>Tool to automate IT tasks.</p>
</blockquote>
<ul>
<li>SIMPLE<ul>
<li>Human readable automation</li>
<li>No special coding skills needed</li>
<li>Tasks executed in order</li>
</ul>
</li>
<li>POWERFUL<ul>
<li>App deployment</li>
<li>Configuration management</li>
<li>Workflow orchestration</li>
</ul>
</li>
<li>AGENTLESS<ul>
<li>Agentless architecture</li>
<li>Use OpenSSH &amp; WinRM</li>
</ul>
</li>
</ul>
<h2 id="What-Can-I-Use-Ansible-To-Do"><a href="#What-Can-I-Use-Ansible-To-Do" class="headerlink" title="What Can I Use Ansible To Do?"></a>What Can I Use Ansible To Do?</h2><ul>
<li>Config Management</li>
<li>App deployment</li>
<li>Provisioning</li>
<li>Continuous delivery</li>
<li>Security &amp; Compliance</li>
<li>orchestration</li>
</ul>
<h2 id="Ansible-Architecture"><a href="#Ansible-Architecture" class="headerlink" title="Ansible Architecture"></a>Ansible Architecture</h2><p><img src="/misc/images/ansible-architecture.png" alt="ansible architecture"></p>
<ul>
<li>MODULES:</li>
</ul>
<h2 id="Quick-Start-Ansible"><a href="#Quick-Start-Ansible" class="headerlink" title="Quick Start Ansible"></a>Quick Start Ansible</h2><ul>
<li>Installing an Ansible<figure class="highlight dsconfig"><table><tr><td class="code"><pre><code class="hljs dsconfig">$ <span class="hljs-string">curl</span> <span class="hljs-string">https</span>://<span class="hljs-string">bootstrap</span>.<span class="hljs-string">pypa</span>.<span class="hljs-string">io</span>/<span class="hljs-built_in">get-pip.py</span> -<span class="hljs-string">o</span> <span class="hljs-built_in">get-pip.py</span><br>$ <span class="hljs-string">python</span> <span class="hljs-built_in">get-pip.py</span> <span class="hljs-built_in">--user</span><br>$ <span class="hljs-string">python</span> -<span class="hljs-string">m</span> <span class="hljs-string">pip</span> <span class="hljs-string">install</span> <span class="hljs-built_in">--user</span> <span class="hljs-string">ansible</span><br><br>➜ <span class="hljs-string">ansible</span> <span class="hljs-built_in">--version</span><br><span class="hljs-string">ansible</span> [<span class="hljs-string">core</span> <span class="hljs-string">2</span>.<span class="hljs-string">11</span>.<span class="hljs-string">4</span>]<br>  <span class="hljs-string">config</span> <span class="hljs-string">file</span> = <span class="hljs-string">None</span><br>  <span class="hljs-string">configured</span> <span class="hljs-string">module</span> <span class="hljs-string">search</span> <span class="hljs-string">path</span> = [<span class="hljs-string">&#x27;/Users/chyiyaqing/.ansible/plugins/modules&#x27;</span>, <span class="hljs-string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]<br>  <span class="hljs-string">ansible</span> <span class="hljs-string">python</span> <span class="hljs-string">module</span> <span class="hljs-string">location</span> = /<span class="hljs-string">usr</span>/<span class="hljs-string">local</span>/<span class="hljs-string">lib</span>/<span class="hljs-string">python3</span>.<span class="hljs-string">9</span>/<span class="hljs-string">site-packages</span>/<span class="hljs-string">ansible</span><br>  <span class="hljs-string">ansible</span> <span class="hljs-string">collection</span> <span class="hljs-string">location</span> = /<span class="hljs-string">Users</span>/<span class="hljs-string">chyiyaqing</span>/.<span class="hljs-string">ansible</span>/<span class="hljs-string">collections</span>:/<span class="hljs-string">usr</span>/<span class="hljs-string">share</span>/<span class="hljs-string">ansible</span>/<span class="hljs-string">collections</span><br>  <span class="hljs-string">executable</span> <span class="hljs-string">location</span> = /<span class="hljs-string">usr</span>/<span class="hljs-string">local</span>/<span class="hljs-string">bin</span>/<span class="hljs-string">ansible</span><br>  <span class="hljs-string">python</span> <span class="hljs-string">version</span> = <span class="hljs-string">3</span>.<span class="hljs-string">9</span>.<span class="hljs-string">6</span> (<span class="hljs-string">default</span>, <span class="hljs-string">Jun</span> <span class="hljs-string">29</span> <span class="hljs-string">2021</span>, <span class="hljs-string">05:25:</span><span class="hljs-string">02</span>) [<span class="hljs-string">Clang</span> <span class="hljs-string">12</span>.<span class="hljs-string">0</span>.<span class="hljs-string">5</span> (<span class="hljs-string">clang-1205</span>.<span class="hljs-string">0</span>.<span class="hljs-string">22</span>.<span class="hljs-string">9</span>)]<br>  <span class="hljs-string">jinja</span> <span class="hljs-string">version</span> = <span class="hljs-string">2</span>.<span class="hljs-string">10</span>.<span class="hljs-string">1</span><br>  <span class="hljs-string">libyaml</span> = <span class="hljs-string">True</span><br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
  </entry>
  <entry>
    <title>Go CLI Intro</title>
    <url>/2021/09/11/Go-CLI-Intro/</url>
    <content><![CDATA[<h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><blockquote>
<p>命令行flag解析</p>
</blockquote>
<ul>
<li><p>flag 长短选项</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-keyword">func</span> main() &#123;<br>	var name string<br><br>  <span class="hljs-regexp">//</span> -flag: 仅支持布尔类型<br>  <span class="hljs-regexp">//</span> -flag x: 仅支持非布尔类型<br>  <span class="hljs-regexp">//</span> -flag=x: 均支持<br>  <span class="hljs-regexp">//</span> 长短选项 分开两次调用<br>	flag.StringVar(&amp;name, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Golang flag tour&quot;</span>, <span class="hljs-string">&quot;help&quot;</span>)<br>	flag.StringVar(&amp;name, <span class="hljs-string">&quot;n&quot;</span>, <span class="hljs-string">&quot;Golang flag tour&quot;</span>, <span class="hljs-string">&quot;help&quot;</span>)<br>	flag.Parse()<br><br>	log.Printf(<span class="hljs-string">&quot;name: %s&quot;</span>, name)<br>&#125;<br><br><span class="hljs-regexp">//</span> ➜ go run flag/demo.go -name=<span class="hljs-string">&#x27;hello world&#x27;</span> -n <span class="hljs-string">&#x27;hello world&#x27;</span><br><span class="hljs-regexp">//</span> <span class="hljs-number">2021</span><span class="hljs-regexp">/09/</span><span class="hljs-number">11</span> <span class="hljs-number">18</span>:<span class="hljs-number">26</span>:<span class="hljs-number">39</span> name: hello world<br></code></pre></td></tr></table></figure></li>
<li><p>flag 子命令</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-keyword">func</span> main() &#123;<br>	var name string<br><br>	flag.Parse()<br>	args := flag.Args()<br>	<span class="hljs-keyword">if</span> len(args) &lt;= <span class="hljs-number">0</span> &#123;<br>		return<br>	&#125;<br><br>	switch args[<span class="hljs-number">0</span>] &#123;<br>	case <span class="hljs-string">&quot;go&quot;</span>:<br>		goCmd := flag.NewFlagSet(<span class="hljs-string">&quot;go&quot;</span>, flag.ExitOnError)<br>		goCmd.StringVar(&amp;name, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Golang language&quot;</span>, <span class="hljs-string">&quot;help&quot;</span>)<br>		_ = goCmd.Parse(args[<span class="hljs-number">1</span>:])<br>	case <span class="hljs-string">&quot;py&quot;</span>:<br>		pyCmd := flag.NewFlagSet(<span class="hljs-string">&quot;py&quot;</span>, flag.ExitOnError)<br>		pyCmd.StringVar(&amp;name, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Python language&quot;</span>, <span class="hljs-string">&quot;help&quot;</span>)<br>		_ = pyCmd.Parse(args[<span class="hljs-number">1</span>:])<br>	&#125;<br><br>	log.Printf(<span class="hljs-string">&quot;name: %s&quot;</span>, name)<br>&#125;<br><br><span class="hljs-regexp">//</span> ➜ go run flag/flag_sub_cli.go go -name=golang<br><span class="hljs-regexp">//</span> <span class="hljs-number">2021</span><span class="hljs-regexp">/09/</span><span class="hljs-number">11</span> <span class="hljs-number">18</span>:<span class="hljs-number">39</span>:<span class="hljs-number">47</span> name: golang<br><span class="hljs-regexp">//</span><br><span class="hljs-regexp">//</span> ➜ go run flag/flag_sub_cli.go go -n=python<br><span class="hljs-regexp">//</span> flag provided but not defined: -n<br><span class="hljs-regexp">//</span> Usage of go:<br><span class="hljs-regexp">//</span>   -name string<br><span class="hljs-regexp">//</span>     	help (default <span class="hljs-string">&quot;Golang language&quot;</span>)<br><span class="hljs-regexp">//</span> <span class="hljs-keyword">exit</span> status <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure></li>
<li><p>flag 源码分析</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"># flag.Parse<br><br><span class="hljs-comment">// CommandLine is the default set of command-line flags, parsed from os.Args.</span><br><span class="hljs-comment">// The top-level functions such as BoolVar, Arg, and so on are wrappers for the</span><br><span class="hljs-comment">// methods of CommandLine.</span><br><span class="hljs-keyword">var</span> CommandLine = NewFlagSet(os.Args[<span class="hljs-number">0</span>], ExitOnError)<br><br><span class="hljs-comment">// Parse parses the command-line flags from os.Args[1:]. Must be called</span><br><span class="hljs-comment">// after all flags are defined and before flags are accessed by the program.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Parse</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// Ignore errors; CommandLine is set for ExitOnError.</span><br>	CommandLine.Parse(os.Args[<span class="hljs-number">1</span>:])<br>&#125;<br><br># FlagSet.Parse<br>&gt; parse异常分流处理<br><span class="hljs-comment">// Parse parses flag definitions from the argument list, which should not</span><br><span class="hljs-comment">// include the command name. Must be called after all flags in the FlagSet</span><br><span class="hljs-comment">// are defined and before flags are accessed by the program.</span><br><span class="hljs-comment">// The return value will be ErrHelp if -help or -h were set but not defined.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *FlagSet)</span> <span class="hljs-title">Parse</span><span class="hljs-params">(arguments []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>	f.parsed = <span class="hljs-literal">true</span><br>	f.args = arguments<br>	<span class="hljs-keyword">for</span> &#123;<br>		seen, err := f.parseOne()<br>		<span class="hljs-keyword">if</span> seen &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>		<span class="hljs-keyword">switch</span> f.errorHandling &#123;<br>		<span class="hljs-keyword">case</span> ContinueOnError:<br>			<span class="hljs-keyword">return</span> err<br>		<span class="hljs-keyword">case</span> ExitOnError:<br>			<span class="hljs-keyword">if</span> err == ErrHelp &#123;<br>				os.Exit(<span class="hljs-number">0</span>)<br>			&#125;<br>			os.Exit(<span class="hljs-number">2</span>)<br>		<span class="hljs-keyword">case</span> PanicOnError:<br>			<span class="hljs-built_in">panic</span>(err)<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br># FlagSet.parseOne<br><span class="hljs-comment">// parseOne parses one flag. It reports whether a flag was seen.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *FlagSet)</span> <span class="hljs-title">parseOne</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">bool</span>, error)</span></span> &#123;<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(f.args) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>	&#125;<br>	s := f.args[<span class="hljs-number">0</span>]<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s) &lt; <span class="hljs-number">2</span> || s[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;-&#x27;</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>	&#125;<br>	numMinuses := <span class="hljs-number">1</span><br>	<span class="hljs-keyword">if</span> s[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;-&#x27;</span> &#123;<br>		numMinuses++<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s) == <span class="hljs-number">2</span> &#123; <span class="hljs-comment">// &quot;--&quot; terminates the flags</span><br>			f.args = f.args[<span class="hljs-number">1</span>:]<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>		&#125;<br>	&#125;<br>	name := s[numMinuses:]<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(name) == <span class="hljs-number">0</span> || name[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;-&#x27;</span> || name[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;=&#x27;</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, f.failf(<span class="hljs-string">&quot;bad flag syntax: %s&quot;</span>, s)<br>	&#125;<br><br>	<span class="hljs-comment">// it&#x27;s a flag. does it have an argument?</span><br>	f.args = f.args[<span class="hljs-number">1</span>:]<br>	hasValue := <span class="hljs-literal">false</span><br>	value := <span class="hljs-string">&quot;&quot;</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(name); i++ &#123; <span class="hljs-comment">// equals cannot be first</span><br>		<span class="hljs-keyword">if</span> name[i] == <span class="hljs-string">&#x27;=&#x27;</span> &#123;<br>			value = name[i+<span class="hljs-number">1</span>:]<br>			hasValue = <span class="hljs-literal">true</span><br>			name = name[<span class="hljs-number">0</span>:i]<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br>	m := f.formal<br>	flag, alreadythere := m[name] <span class="hljs-comment">// BUG</span><br>	<span class="hljs-keyword">if</span> !alreadythere &#123;<br>		<span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;help&quot;</span> || name == <span class="hljs-string">&quot;h&quot;</span> &#123; <span class="hljs-comment">// special case for nice help message.</span><br>			f.usage()<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, ErrHelp<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, f.failf(<span class="hljs-string">&quot;flag provided but not defined: -%s&quot;</span>, name)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> fv, ok := flag.Value.(boolFlag); ok &amp;&amp; fv.IsBoolFlag() &#123; <span class="hljs-comment">// special case: doesn&#x27;t need an arg</span><br>		<span class="hljs-keyword">if</span> hasValue &#123;<br>			<span class="hljs-keyword">if</span> err := fv.Set(value); err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, f.failf(<span class="hljs-string">&quot;invalid boolean value %q for -%s: %v&quot;</span>, value, name, err)<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">if</span> err := fv.Set(<span class="hljs-string">&quot;true&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, f.failf(<span class="hljs-string">&quot;invalid boolean flag %s: %v&quot;</span>, name, err)<br>			&#125;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// It must have a value, which might be the next argument.</span><br>		<span class="hljs-keyword">if</span> !hasValue &amp;&amp; <span class="hljs-built_in">len</span>(f.args) &gt; <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-comment">// value is the next arg</span><br>			hasValue = <span class="hljs-literal">true</span><br>			value, f.args = f.args[<span class="hljs-number">0</span>], f.args[<span class="hljs-number">1</span>:]<br>		&#125;<br>		<span class="hljs-keyword">if</span> !hasValue &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, f.failf(<span class="hljs-string">&quot;flag needs an argument: -%s&quot;</span>, name)<br>		&#125;<br>		<span class="hljs-keyword">if</span> err := flag.Value.Set(value); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, f.failf(<span class="hljs-string">&quot;invalid value %q for flag -%s: %v&quot;</span>, value, name, err)<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> f.actual == <span class="hljs-literal">nil</span> &#123;<br>		f.actual = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*Flag)<br>	&#125;<br>	f.actual[name] = flag<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Cobra"><a href="#Cobra" class="headerlink" title="Cobra"></a>Cobra</h2>]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Go Constants</title>
    <url>/2021/09/12/Go-Constants/</url>
    <content><![CDATA[<h1 id="Constants-常量"><a href="#Constants-常量" class="headerlink" title="Constants 常量"></a>Constants 常量</h1><blockquote>
<p>Go是静态类型语言，不允许同步类型的数值类型进行计算. 不允许float64 + int 甚至 int32 + int. 如果你希望不同类型进行计算需要显式转换后在进行 int(float64) + int.</p>
</blockquote>
<span id="more"></span>

<h2 id="字符串常量"><a href="#字符串常量" class="headerlink" title="字符串常量"></a>字符串常量</h2><blockquote>
<p>字符串常量使用双引号(Go可以使用<code>raw string</code>)<br>  <figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># hello 是一个无类型的字符串常量, 赋值给有类型的变量不会引起类型错误.</span><br><span class="hljs-keyword">const</span> hello = <span class="hljs-string">&quot;Hello, 世界&quot;</span><br><br><span class="hljs-meta"># hello是一个字符串常量</span><br><span class="hljs-keyword">const</span> typedHello <span class="hljs-keyword">string</span> = <span class="hljs-string">&quot;Hello, 世界&quot;</span><br></code></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="默认类型"><a href="#默认类型" class="headerlink" title="默认类型"></a>默认类型</h2>  <figure class="highlight hsp"><table><tr><td class="code"><pre><code class="hljs hsp"><span class="hljs-meta"># str := <span class="hljs-meta-string">&quot;Hello, 世界&quot;</span></span><br>可能会有疑惑，如果常量是没有类型的，<span class="hljs-keyword">str</span>变量如何获取到类型? 答案就是无类型的常量有一个默认类型，如果变量<span class="hljs-keyword">str</span>没有声明类型会使用右边表达式中的默认类型.<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Go PProf Intro</title>
    <url>/2021/09/13/Go-PProf-Intro/</url>
    <content><![CDATA[<h1 id="Go-Profling-剖析"><a href="#Go-Profling-剖析" class="headerlink" title="Go Profling - 剖析"></a>Go Profling - 剖析</h1><blockquote>
<p>Using “pprof” to profiling your program<br>Go语言可视化性能分析工具,PProf以profile.proto读取分析样本集合，并生成报告可视化帮助分析数据(支持文本和图形报告)</p>
</blockquote>
<ul>
<li><p>使用场景</p>
<ul>
<li>runtime/pprof: 采集程序指定区块的运行数据分析</li>
<li>net/http/pprof: 基于HTTP Server运行,采集运行时数据分析</li>
<li>go test: 通过运行测试用例，指定所需标识进行采样</li>
</ul>
</li>
<li><p>安装可视化工具graphviz查看profile</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># Mac: $ brew install graphviz</span><br><span class="hljs-meta"># Linux: $ sudo apt install graphviz</span><br></code></pre></td></tr></table></figure></li>
<li><p>支持模式</p>
<ul>
<li>报告生成 Report generation</li>
<li>交互终端使用 Interactive terminal use</li>
<li>Web页面 Web interface</li>
</ul>
</li>
<li><p>可以做那些</p>
<ul>
<li>CPU Profiling: CPU分析<ul>
<li>按照一定频率采集监听应用程序CPU使用情况，确定应用程序的主动消耗CPU周期时花费时间的位置</li>
</ul>
</li>
<li>Memory Profiling: 内存分析<ul>
<li>程序进行堆分配时记录堆栈跟踪，监视当前和历史内存使用情况，检查内存泄漏</li>
</ul>
</li>
<li>Block Profiling: 阻塞分析<ul>
<li>记录Goroutine阻塞等待同步的位置，默认不开启，需要调用runtime.SetBlockProfileRate 设置</li>
</ul>
</li>
<li>Mutex Profiling: 互斥锁分析<ul>
<li>报告互斥锁的竞争情况, 默认不开启, runtime.SetMutexProfileFraction 设置</li>
</ul>
</li>
<li>Goroutine Profiling: Goroutine分析<ul>
<li>对当前应用程序正在运行的Goroutine进行堆栈跟踪和分析</li>
</ul>
</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h2 id="How-to-Use"><a href="#How-to-Use" class="headerlink" title="How to Use"></a>How to Use</h2><ul>
<li>runtime/pprof<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># pprof useful command:</span><br>  <span class="hljs-built_in">text</span>: show <span class="hljs-keyword">the</span> cpu report <span class="hljs-keyword">in</span> <span class="hljs-built_in">text</span> form<br>  web: visualize graph <span class="hljs-keyword">through</span> web browser<br>  top &lt;n&gt;: <span class="hljs-built_in">list</span> <span class="hljs-keyword">the</span> n highest entries <span class="hljs-keyword">in</span> <span class="hljs-built_in">text</span> form<br>  <span class="hljs-built_in">list</span> &lt;function <span class="hljs-built_in">name</span>&gt;: reveal <span class="hljs-keyword">the</span> <span class="hljs-built_in">running</span> <span class="hljs-built_in">time</span> <span class="hljs-keyword">of</span> function<br>  traces<br></code></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">package main<br><br>import (<br>	<span class="hljs-string">&quot;log&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br>var datas []string<br><br><span class="hljs-keyword">func</span> main() &#123;<br>	go <span class="hljs-keyword">func</span>() &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			log.Printf(<span class="hljs-string">&quot;len: %d&quot;</span>, Add(<span class="hljs-string">&quot;go-programming-tour-book&quot;</span>))<br>			time.Sleep(time.Millisecond * <span class="hljs-number">10</span>)<br>		&#125;<br>	&#125;()<br><br>	_ = http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, nil)<br>&#125;<br><br><span class="hljs-keyword">func</span> Add(str string) int &#123;<br>	data := []byte(str)<br>	datas = append(datas, string(data))<br>	return len(datas)<br>&#125;<br><br><span class="hljs-regexp">//</span> 访问 http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-regexp">/debug/</span>pprof<br><span class="hljs-regexp">//</span> <span class="hljs-regexp">/debug/</span>pprof/<br><span class="hljs-regexp">//</span><br><span class="hljs-regexp">//</span> Types of profiles available:<br><span class="hljs-regexp">//</span> Count	Profile<br><span class="hljs-regexp">//</span> <span class="hljs-number">3</span>	allocs                -- 查看过去内存分配样本<br><span class="hljs-regexp">//</span> <span class="hljs-number">0</span>	block                 -- 查看阻塞<br><span class="hljs-regexp">//</span> <span class="hljs-number">0</span>	cmdline               -- 命令行调用路径<br><span class="hljs-regexp">//</span> <span class="hljs-number">5</span>	goroutine             -- goroutine堆栈跟踪<br><span class="hljs-regexp">//</span> <span class="hljs-number">3</span>	heap                  -- 堆上内存分配<br><span class="hljs-regexp">//</span> <span class="hljs-number">0</span>	mutex                 -- 互斥锁竞争持有者堆栈跟踪<br><span class="hljs-regexp">//</span> <span class="hljs-number">0</span>	profile               -- 默认<span class="hljs-number">30</span>秒CPU Profiling<br><span class="hljs-regexp">//</span> <span class="hljs-number">7</span>	threadcreate          --<br><span class="hljs-regexp">//</span> <span class="hljs-number">0</span>	trace<br><span class="hljs-regexp">//</span> full goroutine stack dump<br></code></pre></td></tr></table></figure>

<ul>
<li><p>CPU Profiling</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">➜ <span class="hljs-keyword">go</span> tool pprof http://localhos<span class="hljs-variable">t:8080</span>/<span class="hljs-keyword">debug</span>/pprof/<span class="hljs-keyword">profile</span>\?seconds\=<span class="hljs-number">5</span><br>Fetching <span class="hljs-keyword">profile</span> over HTTP from http://localhos<span class="hljs-variable">t:8080</span>/<span class="hljs-keyword">debug</span>/pprof/<span class="hljs-keyword">profile</span>?seconds=<span class="hljs-number">5</span><br>Saved <span class="hljs-keyword">profile</span> in /Users/chyiyaqing/pprof/pprof.samples.cpu.<span class="hljs-number">001</span>.pb.gz<br>Type: cpu<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">5</span>:<span class="hljs-number">22</span>pm (CST)<br>Duration: <span class="hljs-number">5</span>s, Total samples = <span class="hljs-number">20</span>ms (  <span class="hljs-number">0.4</span>%)<br>Entering interactive <span class="hljs-keyword">mode</span> (<span class="hljs-built_in">type</span> <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">&quot;o&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">options</span>)<br>(pprof) top10<br>Showing nodes accounting <span class="hljs-keyword">for</span> <span class="hljs-number">20</span>ms, <span class="hljs-number">100</span>% of <span class="hljs-number">20</span>ms total<br>Showing top <span class="hljs-number">10</span> nodes out of <span class="hljs-number">11</span><br>      flat  flat%   sum%        cum   cum%<br>      <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>% <span class="hljs-number">50.00</span>%       <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%  <span class="hljs-keyword">runtime</span>.kevent<br>      <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%  <span class="hljs-keyword">runtime</span>.pthread_cond_wait<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">20</span>ms   <span class="hljs-number">100</span>%  <span class="hljs-keyword">runtime</span>.findrunnable<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%  <span class="hljs-keyword">runtime</span>.mPark<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">20</span>ms   <span class="hljs-number">100</span>%  <span class="hljs-keyword">runtime</span>.mcall<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%  <span class="hljs-keyword">runtime</span>.netpoll<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%  <span class="hljs-keyword">runtime</span>.notesleep<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">20</span>ms   <span class="hljs-number">100</span>%  <span class="hljs-keyword">runtime</span>.park_m<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">20</span>ms   <span class="hljs-number">100</span>%  <span class="hljs-keyword">runtime</span>.schedule<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">10</span>ms <span class="hljs-number">50.00</span>%  <span class="hljs-keyword">runtime</span>.semasleep<br><br>fla<span class="hljs-variable">t:</span> 函数自身运行耗时<br>flat%: 函数自身在CPU运行耗时总比例<br>sum%: 函数自身累计使用CPU比例<br>cum%: 函数自身及其调用函数运行总耗时<br>cum%: 函数自身及其调用函数的运行耗时总比例<br>Name: 函数名<br></code></pre></td></tr></table></figure></li>
<li><p>Heap Profiling</p>
<ul>
<li>inuse_space: 分析常驻内存占用<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">➜ go tool pprof -inuse_space http:<span class="hljs-comment">//localhost:8080/debug/pprof/heap</span><br>Fetching profile over HTTP <span class="hljs-keyword">from</span> http:<span class="hljs-comment">//localhost:8080/debug/pprof/heap</span><br>Saved profile in <span class="hljs-regexp">/Users/</span>chyiyaqing<span class="hljs-regexp">/pprof/</span>pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.<span class="hljs-number">002</span>.pb.gz<br>Type: inuse_space<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">5</span>:<span class="hljs-number">30</span>pm (CST)<br>Entering interactive mode (type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">&quot;o&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">options</span>)<br>(pprof) top<br>Showing nodes accounting <span class="hljs-keyword">for</span> <span class="hljs-number">6951.53</span>kB, <span class="hljs-number">100</span>% of <span class="hljs-number">6951.53</span>kB total<br>Showing top <span class="hljs-number">10</span> nodes out of <span class="hljs-number">18</span><br>      flat  flat%   sum%        cum   cum%<br> <span class="hljs-number">4898.20</span>kB <span class="hljs-number">70.46</span>% <span class="hljs-number">70.46</span>%  <span class="hljs-number">4898.20</span>kB <span class="hljs-number">70.46</span>%  main.Add (inline)<br> <span class="hljs-number">1025.12</span>kB <span class="hljs-number">14.75</span>% <span class="hljs-number">85.21</span>%  <span class="hljs-number">1025.12</span>kB <span class="hljs-number">14.75</span>%  <span class="hljs-keyword">runtime</span>.allocm<br>  <span class="hljs-number">516.01</span>kB  <span class="hljs-number">7.42</span>% <span class="hljs-number">92.63</span>%   <span class="hljs-number">516.01</span>kB  <span class="hljs-number">7.42</span>%  unicode.init<br>  <span class="hljs-number">512.20</span>kB  <span class="hljs-number">7.37</span>%   <span class="hljs-number">100</span>%   <span class="hljs-number">512.20</span>kB  <span class="hljs-number">7.37</span>%  <span class="hljs-keyword">runtime</span>.malg<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%  <span class="hljs-number">4898.20</span>kB <span class="hljs-number">70.46</span>%  main.main.func1<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%   <span class="hljs-number">516.01</span>kB  <span class="hljs-number">7.42</span>%  <span class="hljs-keyword">runtime</span>.doInit<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%   <span class="hljs-number">516.01</span>kB  <span class="hljs-number">7.42</span>%  <span class="hljs-keyword">runtime</span>.main<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%  <span class="hljs-number">1025.12</span>kB <span class="hljs-number">14.75</span>%  <span class="hljs-keyword">runtime</span>.mstart<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%  <span class="hljs-number">1025.12</span>kB <span class="hljs-number">14.75</span>%  <span class="hljs-keyword">runtime</span>.mstart0<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%  <span class="hljs-number">1025.12</span>kB <span class="hljs-number">14.75</span>%  <span class="hljs-keyword">runtime</span>.mstart1<br>(pprof) traces<br>Type: alloc_objects<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">5</span>:<span class="hljs-number">57</span>pm (CST)<br>-----------+-------------------------------------------------------<br>     bytes:  <span class="hljs-number">256</span>kB<br>         <span class="hljs-number">2</span>   compress/flate.(*compressor).init<br>             compress/flate.<span class="hljs-keyword">NewWriter</span><br>             compress/gzip.(*Writer).<span class="hljs-keyword">Write</span><br>             <span class="hljs-keyword">runtime</span>/pprof.(*profileBuilder).build<br>             <span class="hljs-keyword">runtime</span>/pprof.printCountProfile<br>             <span class="hljs-keyword">runtime</span>/pprof.writeRuntimeProfile<br>             <span class="hljs-keyword">runtime</span>/pprof.writeGoroutine<br>             <span class="hljs-keyword">runtime</span>/pprof.(*Profile).WriteTo<br>             net<span class="hljs-regexp">/http/</span>pprof.handler.ServeHTTP<br>             net<span class="hljs-regexp">/http/</span>pprof.Index<br>             net/http.HandlerFunc.ServeHTTP<br>             net/http.(*ServeMux).ServeHTTP<br>             net/http.serverHandler.ServeHTTP<br>             net/http.(*conn).serve<br>-----------+-------------------------------------------------------<br></code></pre></td></tr></table></figure></li>
<li>alloc_space: 分析分配内存空间大小</li>
<li>alloc_objects:</li>
<li>inuse_objects:</li>
</ul>
</li>
</ul>
<ul>
<li><p>Goroutine Profiling</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">➜ go tool pprof http:<span class="hljs-comment">//localhost:8080/debug/pprof/goroutine</span><br>Fetching profile over HTTP from http:<span class="hljs-comment">//localhost:8080/debug/pprof/goroutine</span><br>Saved profile <span class="hljs-keyword">in</span> /Users/chyiyaqing/pprof/pprof<span class="hljs-selector-class">.goroutine</span>.<span class="hljs-number">001</span><span class="hljs-selector-class">.pb</span><span class="hljs-selector-class">.gz</span><br>Type: goroutine<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">5</span>:<span class="hljs-number">54</span>pm (CST)<br>Entering interactive mode (type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">&quot;o&quot;</span> <span class="hljs-keyword">for</span> options)<br>(pprof) traces  <span class="hljs-comment">// 打印调用栈</span><br>Type: goroutine<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">5</span>:<span class="hljs-number">54</span>pm (CST)<br>-----------+-------------------------------------------------------<br>         <span class="hljs-number">1</span>   runtime<span class="hljs-selector-class">.gopark</span><br>             runtime<span class="hljs-selector-class">.netpollblock</span><br>             internal/poll<span class="hljs-selector-class">.runtime_pollWait</span><br>             internal/poll.(*pollDesc)<span class="hljs-selector-class">.wait</span><br>             internal/poll.(*pollDesc)<span class="hljs-selector-class">.waitRead</span> (inline)<br>             internal/poll.(*FD)<span class="hljs-selector-class">.Read</span><br>             net.(*netFD)<span class="hljs-selector-class">.Read</span><br>             net.(*conn)<span class="hljs-selector-class">.Read</span><br>             net/http.(*connReader)<span class="hljs-selector-class">.backgroundRead</span><br>-----------+-------------------------------------------------------<br>         <span class="hljs-number">1</span>   runtime<span class="hljs-selector-class">.gopark</span><br>             runtime<span class="hljs-selector-class">.netpollblock</span><br>             internal/poll<span class="hljs-selector-class">.runtime_pollWait</span><br>             internal/poll.(*pollDesc)<span class="hljs-selector-class">.wait</span><br>             internal/poll.(*pollDesc)<span class="hljs-selector-class">.waitRead</span> (inline)<br>             internal/poll.(*FD)<span class="hljs-selector-class">.Accept</span><br>             net.(*netFD)<span class="hljs-selector-class">.accept</span><br>             net.(*TCPListener)<span class="hljs-selector-class">.accept</span><br>             net.(*TCPListener)<span class="hljs-selector-class">.Accept</span><br>             net/http.(*Server)<span class="hljs-selector-class">.Serve</span><br>             net/http.(*Server)<span class="hljs-selector-class">.ListenAndServe</span><br>             net/http<span class="hljs-selector-class">.ListenAndServe</span> (inline)<br>             <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.main</span><br>             runtime<span class="hljs-selector-class">.main</span><br>-----------+-------------------------------------------------------<br>         <span class="hljs-number">1</span>   runtime<span class="hljs-selector-class">.gopark</span><br>             <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Sleep</span><br>             <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.main</span><span class="hljs-selector-class">.func1</span><br>-----------+-------------------------------------------------------<br>         <span class="hljs-number">1</span>   runtime/pprof<span class="hljs-selector-class">.runtime_goroutineProfileWithLabels</span><br>             runtime/pprof<span class="hljs-selector-class">.writeRuntimeProfile</span><br>             runtime/pprof<span class="hljs-selector-class">.writeGoroutine</span><br>             runtime/pprof.(*Profile)<span class="hljs-selector-class">.WriteTo</span><br>             net/http/pprof<span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.ServeHTTP</span><br>             net/http/pprof<span class="hljs-selector-class">.Index</span><br>             net/http<span class="hljs-selector-class">.HandlerFunc</span><span class="hljs-selector-class">.ServeHTTP</span><br>             net/http.(*ServeMux)<span class="hljs-selector-class">.ServeHTTP</span><br>             net/http<span class="hljs-selector-class">.serverHandler</span><span class="hljs-selector-class">.ServeHTTP</span><br>             net/http.(*conn)<span class="hljs-selector-class">.serve</span><br>-----------+-------------------------------------------------------<br></code></pre></td></tr></table></figure></li>
<li><p>Mutex Profiling</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">➜ go tool pprof http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-regexp">/debug/</span>pprof/mutex<br>Fetching profile over HTTP from http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-regexp">/debug/</span>pprof/mutex<br>Saved profile <span class="hljs-keyword">in</span> <span class="hljs-regexp">/Users/</span>chyiyaqing<span class="hljs-regexp">/pprof/</span>pprof.contentions.delay.<span class="hljs-number">003</span>.pb.gz<br>Type: delay<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">6</span>:<span class="hljs-number">05</span>pm (CST)<br>Entering interactive mode (type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">&quot;o&quot;</span> <span class="hljs-keyword">for</span> options)<br>(pprof) top<br>Showing nodes accounting <span class="hljs-keyword">for</span> <span class="hljs-number">941.98</span>us, <span class="hljs-number">100</span>% of <span class="hljs-number">941.98</span>us total<br>      flat  flat%   sum%        cum   cum%<br>  <span class="hljs-number">941.98</span>us   <span class="hljs-number">100</span>%   <span class="hljs-number">100</span>%   <span class="hljs-number">941.98</span>us   <span class="hljs-number">100</span>%  sync.(*Mutex).Unlock<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%   <span class="hljs-number">941.98</span>us   <span class="hljs-number">100</span>%  main.main.func1<br>(pprof) list main<br>Total: <span class="hljs-number">941.98</span>us<br>ROUTINE ======================== main.main.func1 <span class="hljs-keyword">in</span> <span class="hljs-regexp">/Users/</span>chyiyaqing<span class="hljs-regexp">/Downloads/</span>pprof<span class="hljs-regexp">/pprof/m</span>ain2.go<br>         <span class="hljs-number">0</span>   <span class="hljs-number">941.98</span>us (flat, cum)   <span class="hljs-number">100</span>% of Total<br>         .          .     <span class="hljs-number">18</span>:	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">999</span>; i++ &#123;<br>         .          .     <span class="hljs-number">19</span>:		go <span class="hljs-keyword">func</span>(i int) &#123;<br>         .          .     <span class="hljs-number">20</span>:			m.Lock()<br>         .          .     <span class="hljs-number">21</span>:			defer m.Unlock()<br>         .          .     <span class="hljs-number">22</span>:			datas[i] = struct&#123;&#125;&#123;&#125;<br>         .   <span class="hljs-number">941.98</span>us     <span class="hljs-number">23</span>:		&#125;(i)<br>         .          .     <span class="hljs-number">24</span>:	&#125;<br>         .          .     <span class="hljs-number">25</span>:<br>         .          .     <span class="hljs-number">26</span>:	_ = http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, nil)<br>         .          .     <span class="hljs-number">27</span>:&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Block Profiling</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">➜ go tool pprof http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-regexp">/debug/</span>pprof/block<br>Fetching profile over HTTP from http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span><span class="hljs-regexp">/debug/</span>pprof/block<br>Saved profile <span class="hljs-keyword">in</span> <span class="hljs-regexp">/Users/</span>chyiyaqing<span class="hljs-regexp">/pprof/</span>pprof.contentions.delay.<span class="hljs-number">005</span>.pb.gz<br>Type: delay<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">6</span>:<span class="hljs-number">17</span>pm (CST)<br>Entering interactive mode (type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">&quot;o&quot;</span> <span class="hljs-keyword">for</span> options)<br>(pprof) top<br>Showing nodes accounting <span class="hljs-keyword">for</span> <span class="hljs-number">92.66</span>ms, <span class="hljs-number">100</span>% of <span class="hljs-number">92.67</span>ms total<br>Dropped <span class="hljs-number">4</span> nodes (cum &lt;= <span class="hljs-number">0.46</span>ms)<br>      flat  flat%   sum%        cum   cum%<br>   <span class="hljs-number">92.66</span>ms   <span class="hljs-number">100</span>%   <span class="hljs-number">100</span>%    <span class="hljs-number">92.66</span>ms   <span class="hljs-number">100</span>%  sync.(*Mutex).Lock (inline)<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%    <span class="hljs-number">92.66</span>ms   <span class="hljs-number">100</span>%  main.main.func1<br>(pprof) list<br>command list requires an argument<br>(pprof) list main<br>Total: <span class="hljs-number">92.67</span>ms<br>ROUTINE ======================== main.main.func1 <span class="hljs-keyword">in</span> <span class="hljs-regexp">/Users/</span>chyiyaqing<span class="hljs-regexp">/Downloads/</span>pprof<span class="hljs-regexp">/pprof/m</span>ain2.go<br>         <span class="hljs-number">0</span>    <span class="hljs-number">92.66</span>ms (flat, cum)   <span class="hljs-number">100</span>% of Total<br>         .          .     <span class="hljs-number">17</span>:<span class="hljs-keyword">func</span> main() &#123;<br>         .          .     <span class="hljs-number">18</span>:	var m sync.Mutex<br>         .          .     <span class="hljs-number">19</span>:	var datas = make(map[int]struct&#123;&#125;)<br>         .          .     <span class="hljs-number">20</span>:	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">999</span>; i++ &#123;<br>         .          .     <span class="hljs-number">21</span>:		go <span class="hljs-keyword">func</span>(i int) &#123;<br>         .    <span class="hljs-number">92.66</span>ms     <span class="hljs-number">22</span>:			m.Lock()<br>         .          .     <span class="hljs-number">23</span>:			defer m.Unlock()<br>         .          .     <span class="hljs-number">24</span>:			datas[i] = struct&#123;&#125;&#123;&#125;<br>         .          .     <span class="hljs-number">25</span>:		&#125;(i)<br>         .          .     <span class="hljs-number">26</span>:	&#125;<br>         .          .     <span class="hljs-number">27</span>:<br></code></pre></td></tr></table></figure></li>
<li><p>查看可视化界面</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf">➜ wget http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>/<span class="hljs-keyword">debug</span>/pprof/<span class="hljs-keyword">profile</span><br>--<span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">13</span> <span class="hljs-number">18</span>:<span class="hljs-number">25</span>:<span class="hljs-number">42</span>--  http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>/<span class="hljs-keyword">debug</span>/pprof/<span class="hljs-keyword">profile</span><br>Connecting <span class="hljs-keyword">to</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>... connected.<br>HTTP request sent, awaiting response... <span class="hljs-number">200</span> OK<br>Length: <span class="hljs-number">1290</span> (<span class="hljs-number">1.3</span>K) [application/octet-stream]<br>Saving <span class="hljs-keyword">to</span>: ‘<span class="hljs-keyword">profile</span>’<br><br><span class="hljs-keyword">profile</span>                            <span class="hljs-number">100</span>%[================================================================&gt;]   <span class="hljs-number">1.26</span>K  --.-KB/s    <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>s<br><br><span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">13</span> <span class="hljs-number">18</span>:<span class="hljs-number">26</span>:<span class="hljs-number">12</span> (<span class="hljs-number">205</span> MB/s) - ‘<span class="hljs-keyword">profile</span>’ saved [<span class="hljs-number">1290</span>/<span class="hljs-number">1290</span>]<br><br><span class="hljs-comment"># 方法一</span><br>➜ go tool pprof -http=:<span class="hljs-number">6001</span> <span class="hljs-keyword">profile</span><br>Serving web UI <span class="hljs-keyword">on</span> http://localhost:<span class="hljs-number">6001</span><br>  <span class="hljs-comment"># Top</span><br>  <span class="hljs-comment"># Graph: 函数调用流程</span><br>  <span class="hljs-comment"># Peek: 上下文信息</span><br>  <span class="hljs-comment"># Source: 源代码的追踪和分析</span><br>  <span class="hljs-comment"># Flame Graph:</span><br><br><span class="hljs-comment"># 方法二</span><br>➜ go tool pprof <span class="hljs-keyword">profile</span><br>Type: cpu<br>Time: Sep <span class="hljs-number">13</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">6</span>:<span class="hljs-number">25</span>pm (CST)<br>Duration: <span class="hljs-number">30</span>s, Total samples = <span class="hljs-number">240</span>ms (  <span class="hljs-number">0.8</span>%)<br>Entering interactive mode (type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">&quot;o&quot;</span> <span class="hljs-keyword">for</span> options)<br>(pprof) web<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Huawei LiteOS Intro</title>
    <url>/2021/09/14/Huawei-LiteOS-Intro/</url>
    <content><![CDATA[<h1 id="Huawei-LiteOS"><a href="#Huawei-LiteOS" class="headerlink" title="Huawei LiteOS"></a>Huawei LiteOS</h1><blockquote>
<p>面向IOT领域，构建轻量级物联网操作系统, 目前支持ARM64,ARM Contex-A, ARM Cortex-M0, Cortex-M3, Cortex-M4, Cortex-M7</p>
</blockquote>
<ul>
<li>优势:<ul>
<li>高实时性,高稳定性</li>
<li>超小内核，基础内核体积可以裁剪至不到10K</li>
<li>低功耗</li>
<li>支持功能静态裁剪</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h2 id="架构框图"><a href="#架构框图" class="headerlink" title="架构框图"></a>架构框图</h2><p><img src="/misc/images/huawei-liteos-architecture.png" alt="Artecture"></p>
<ul>
<li>基础内核:<ul>
<li>极小内核<ul>
<li>任务管理</li>
<li>内存管理</li>
<li>中断管理</li>
<li>异常管理</li>
<li>系统时钟</li>
</ul>
</li>
<li>可裁剪其他模块<ul>
<li>信号量</li>
<li>互斥锁</li>
<li>队列管理</li>
<li>事件管理</li>
<li>软件定时器</li>
</ul>
</li>
</ul>
</li>
<li>内核增强<ul>
<li>C++ 支持</li>
<li>调测组件</li>
<li>shell命令</li>
<li>Trace事件跟踪</li>
<li>CPU占用率</li>
<li>LMS</li>
</ul>
</li>
<li>文件系统<ul>
<li>vfs</li>
<li>ramfs</li>
<li>fatfs</li>
</ul>
</li>
<li>系统库接口<ul>
<li>libc</li>
<li>libm</li>
<li>posix</li>
<li>cmsis</li>
</ul>
</li>
<li>网络协议栈<ul>
<li>CoAP</li>
<li>LwM2M</li>
<li>MQTT</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>OS</category>
      </categories>
  </entry>
  <entry>
    <title>Blockchain Intro</title>
    <url>/2021/09/17/Blockchain-Intro/</url>
    <content><![CDATA[<h1 id="Blockchain"><a href="#Blockchain" class="headerlink" title="Blockchain"></a>Blockchain</h1><blockquote>
<p>区块链技术萌芽于比特币，诞生在以太坊, 区块链是价值的载体，是一种新型的社会生产关系。基于区块链技术，打通现实世界与网络世界的屏障，将物质虚拟化，将价值实体化.</p>
</blockquote>
<span id="more"></span>

<ul>
<li>数字货币<ul>
<li>BTC:<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript"><span class="hljs-number">2008</span>年,金融危机背景下，中本聪看到现代金融体系的不足，创建基于密码学而非信任关系的数字货币系统 -- 比特币</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">在比特币中，矿工通过计算满足条件的区块获得挖矿奖励，且大概每四年减半，比特币的货币供应随着时间逐渐减少，是一种通缩型数字货币.</span><br></code></pre></td></tr></table></figure></li>
<li>Etherenum:<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">V神在比特币的基础上，将智能合约于区块链结合,创立去中心化应用平台 -- 以太坊</span><br></code></pre></td></tr></table></figure>
<ul>
<li>硬分叉分裂:<ul>
<li>ETH:</li>
<li>ETC:</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>软分叉: 可兼容的程序版本更新</li>
<li>硬分叉: 不可兼容的程序版本更新</li>
<li>公链圈: 专注于有币的共有开放区块链网络<figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml"># 应用层面:<br>  -<span class="ruby"> 去中心化金融: Decentralised Finance</span><br><span class="ruby"></span>    -<span class="ruby"> 金融: 通过重新分配资产来获得资产增值的一种渠道，本质在于信用、风险和杠杆，金融成立的前提就是控制不确定性风险。</span><br><span class="ruby"></span>  -<span class="ruby"> 去中心化存储:</span><br><span class="ruby"></span>    &gt; 一种利用分布式存储技术，将文件分块存储在不同存储节点的应用型创新. 相较于中心化存储，拥有更高级别的隐私保护，存储成本更低，且具备更冗余的数据备份副本，能有效避免单点故障<br>    -<span class="ruby"> 面临的问题:</span><br><span class="ruby"></span>      -<span class="ruby"> <span class="hljs-number">1</span>. 币价波动导致成本不确定性</span><br><span class="ruby"></span>      -<span class="ruby"> <span class="hljs-number">2</span>. 受制于网络环境以及硬盘本身，整个去中心化网络存储性能不高，远不如中心化存储，只适用冷数据以及个人数据存储.</span><br><span class="ruby"></span># 技术创新层面:<br>  &gt; 跨链: 不同区块链网络是独立，是一个个数据孤岛，跨链技术是在这些岛之间构建互通的桥梁,提供不同链之间数据互通的可能性.<br></code></pre></td></tr></table></figure></li>
<li>联盟链圈: 专注于区块链技术在企业领域的研究<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 数据存证:</span><br>  &gt; 区块链技术具有时间连续，不可篡改，可回溯等特性，非常适合留存证据的数据存储。大多数应用在区块链上存储只是数据证明，而非原始数据。<br><br><span class="hljs-meta"># 数据交换:</span><br>  &gt; 通过区块链技术解决多方数据交互需求，各方部署区块链节点，只需与自身节点交互，区块链机制自动将数据同步至其他参与方，任一节点数据更新，区块链通知机制自动通知各放<br><br><span class="hljs-meta"># 价值转移:</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="BTC-比特币白皮书-–-阅读"><a href="#BTC-比特币白皮书-–-阅读" class="headerlink" title="BTC 比特币白皮书 – 阅读"></a>BTC 比特币白皮书 – 阅读</h2><blockquote>
<p>一种P2P电子货币系统，基于密码学原理而不是信任的电子支付系统，该系统允许任何有交易意愿的双方能直接交易而不需要一个可信任第三方。只要诚实节点集体控制的CPU算力大于每一个合作攻击节点群的CPU算力，这个系统就是安全的。</p>
</blockquote>
<p><a href="https://bitcoin.org/zh_CN/bitcoin-paper">BTC白皮书</a></p>
<ul>
<li>交易</li>
<li>事件戳服务器</li>
<li>工作量证明</li>
<li>网络</li>
<li>激励</li>
<li>回收磁盘空间</li>
<li>合并和分割交易额</li>
<li>隐私</li>
<li>计算</li>
</ul>
<h2 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h2><ul>
<li><p>区块链特征:</p>
<ul>
<li>去中心化<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">区块链存在的初衷就是去除中心化的第三方机构，整个网络的数据以及状态是由网络中所有的节点共同维护，任一节点离线不会影响系统的运作.</span><br><br><span class="hljs-meta">&gt;</span> <span class="javascript">节点互为彼此的数据生产者及消费者</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">现阶段区块链去中心化本质是相对去中心化(多中心化)</span><br></code></pre></td></tr></table></figure></li>
<li>可追溯性<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">区块链被认为是时序数据库,对节点数据库存储响应的数据以及日志，且每份数据是按照顺序前后关联在一起，新的数据一定从某一组之前已存在的数据派生而来</span><br></code></pre></td></tr></table></figure></li>
<li>不可篡改<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 密码学</span><br><span class="hljs-bullet">  -</span> 哈希算法: 任意数据转换为固定长度的数据指纹, 形成一条由数据指纹串联的信息链条<br><span class="hljs-section"># 共识算法</span><br><span class="hljs-bullet">  -</span> 大多数共识算法遵循少数服从多数的原则<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>存储:<br><img src="/misc/images/blockchain_store.jpg" alt="区块链存储"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 存储冗余</span><br><span class="hljs-bullet">  -</span> 比特币网络累计超过350G的历史数据, 以太坊但节点超过8700G的历史数据<br><span class="hljs-bullet">  -</span> 数据归档: 的本质是在保持不可篡改的前提下牺牲部分可追溯性<br><span class="hljs-bullet">  -</span> 节点角色:<br><span class="hljs-bullet">    -</span> Bitcoin Core 全节点: 路由、链存储、挖矿、钱包<br><span class="hljs-bullet">    -</span> 普通全节点: 路由、链存储<br><span class="hljs-bullet">    -</span> SPV钱包节点: 路由、钱包<br><span class="hljs-bullet">    -</span> 挖矿节点: 路由、链存储、挖矿<br><br><span class="hljs-section"># Transaction: 交易</span><br>  &gt; 交易是区块链网络中数据的最小组成部分, 交易提交后只能有两种状态(成功/失败)<br>  &gt; 区块链中所有的交易基本都是从区块链外部发起，区块链网络只接收交易而不生产交易, 且不对交易做任何改动。<br><span class="hljs-bullet">  -</span> 交易属性:<br><span class="hljs-bullet">    -</span> From: 交易的发起方<br><span class="hljs-bullet">    -</span> To: 交易的接收方<br><span class="hljs-bullet">    -</span> 智能合约: 执行智能合约的名称<br><span class="hljs-bullet">    -</span> 方法名称<br><span class="hljs-bullet">    -</span> 参数列表<br><span class="hljs-bullet">    -</span> 签名: 私钥对交易进行签名<br><span class="hljs-bullet">    -</span> 时间戳: 交易在客户端构建的时间<br><span class="hljs-section"># 区块</span><br>  &gt; 区块链是时间段的数据前后关联依次串联整合成的信息链条，而每一个时间段的数据称为区块Block<br>  &gt; 区块是指将节点一段时间内收到的所有(有效)交易打包而形成的一种数据结构.<br><span class="hljs-bullet">  -</span> 区块结构:<br><span class="hljs-bullet">    -</span> 区块头:<br><span class="hljs-bullet">      -</span> 前置区块哈希: 区块间的关联<br><span class="hljs-bullet">      -</span> 交易根哈希: 区块与交易的关联<br><span class="hljs-bullet">      -</span> 区块高度: 当前区块在区块链中的位置<br><span class="hljs-bullet">      -</span> 时间戳: 区块打包的时间<br><span class="hljs-bullet">    -</span> 区块体: 保存交易并按照交易时间排序<br><span class="hljs-bullet">  -</span> 区块间关联:<br><span class="hljs-bullet">    -</span> 每个区块都会包含前置区块哈希作为逻辑关联两个区块的锚点<br><br><span class="hljs-section"># 莫克尔树:</span><br>  &gt; 树状结构，至少三层，分别是叶子结点, 中间节点，根节点<br><span class="hljs-bullet">  -</span> 构建逻辑:<br><span class="hljs-code">    &gt; 相邻叶子结点进行哈希运算，得到哈希值作为两个叶子节点的父节点，这样由哈希值构成的莫克尔树</span><br><span class="hljs-code"></span><br><span class="hljs-section"># State状态</span><br><span class="hljs-bullet">  -</span> 有限状态机:<br><span class="hljs-code">    &gt; 在一个封闭的系统中，如果状态起始条件一致，状态改变条件顺序一致，最终一定会得到一致的结果</span><br><span class="hljs-code">    &gt; 区块链也是一种有限状态机</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">  -</span> 状态模型:<br><span class="hljs-bullet">    -</span> UTXO(Unspent Trasaction Outputs - 未花费的交易输出)模型:<br><span class="hljs-bullet">      -</span> 未花费的交易输入告知货币是从哪里来，未花费的交易输出告知货币往哪里去<br><span class="hljs-bullet">    -</span> 账户模型: 实现账户间余额的动态平衡<br><span class="hljs-bullet">    -</span> 通用模型: 没有内置状态属性，可存储任意自定义数据<br></code></pre></td></tr></table></figure></li>
<li><p>密码学算法</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><code class="hljs haml"># 哈希算法<br>  &gt; 哈希算法称为散列函数，可以将任意长度的数据转换成短的、固定长度的数据指纹<br>  -<span class="ruby"> 常用的哈希算法:</span><br><span class="ruby"></span>    &gt; 哈希算法相当于是对信息提取摘要,是数据的指纹.用于数据完整性校验<br>    -<span class="ruby"> <span class="hljs-symbol">MD5:</span> <span class="hljs-number">32</span> byte</span><br><span class="ruby"></span>    -<span class="ruby"> SHA-<span class="hljs-number">256</span>:</span><br><span class="ruby"></span>  -<span class="ruby"> 哈希算法标准</span><br><span class="ruby"></span>    -<span class="ruby"> 正向快速:</span><br><span class="ruby"></span>    -<span class="ruby"> 逆向困难:</span><br><span class="ruby"></span>    -<span class="ruby"> 输入敏感:</span><br><span class="ruby"></span>    -<span class="ruby"> 避免碰撞:</span><br><span class="ruby"></span><br># 非对称加密算法:<br>  &gt; 非对称分为公钥和私钥, 公钥加密 -&gt; 私钥解密; 私钥加密 -&gt; 公钥解密<br>  &gt; 区块链中使用的非对称加密算法并不是直接用于数据加密，而是主要用作交易签名, 数字签名集成了哈希算法与非对称加密算法的双重特征，在保证交易完整性的同时，证明交易发起人的身份.<br>  -<span class="ruby"> <span class="hljs-symbol">RSA:</span></span><br><span class="ruby"></span>  -<span class="ruby"> <span class="hljs-symbol">ECC:</span></span><br><span class="ruby"></span># 对称加密算法:<br>  &gt; 对称表示加密和解密都使用同一套密钥<br># 数字签名:<br>  &gt; 区块链中不直接使用非对称加密算法，而是使用数字签名<br></code></pre></td></tr></table></figure></li>
<li><p>网络模型</p>
<ul>
<li>客户端/服务端模型<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">客户端/服务端模型：属于中心化的网络架构，服务能力取决于中心的服务器</span><br></code></pre></td></tr></table></figure></li>
<li>点对点网络模型<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
<li>网络拓扑结构<ul>
<li>中心索引节点<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">中心索引节点保存所有节点的接入信息，新节点的加入将自身信息传入中心节点，从而换取已在网络中其他节点的连接信息, 有可能存在单点故障的可能性，一旦中心索引节点宕机，新节点将无法加入网络<br></code></pre></td></tr></table></figure></li>
<li>无为而治<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">新节点选择连接一个已存在网络中的节点，被连接的节点可以告知新节点连接的其他节点信息，这样新节点可以随机选择连接其他节点<br></code></pre></td></tr></table></figure></li>
<li>整体分散局部集中的混合结构<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">整个网络由多个种子节点形成主干网络，其他普通节点则连接到某个子节点，就形成整体分散局部集中的混合结构<br></code></pre></td></tr></table></figure></li>
<li>有序结构化网络<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>区块链网络拓扑:<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> BTC</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 采用混合型的网络拓扑结构，一个新节点的加入需要给节点指定几个已在BTC网络中的相邻节点(普通节点或种子节点)信息, 当建立节点间连接以后，新节点将自身信息发送给相邻节点，相邻节点再将新节点的信息依次转发给各自相邻节点，从而选择性连接更多节点，增强节点自身与整体网络连接的稳定性</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> ETC</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 以太坊采用结构化网络拓扑，基于分布式哈希表Kademlia算法。</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 节点间的距离是逻辑距离，而非物理距离.</span><br></code></pre></td></tr></table></figure></li>
<li>交易扩散<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; Gossip 八卦协议:</span><br><span class="hljs-bullet">-</span> ETC: 以太坊网络的节点只与自己最近距离的相邻节点连接，交易的扩散不存在回路的可能性，扩散更像是一种持续向外广播。交易会逐渐远离最初的节点，交易扩散效率较高<br><span class="hljs-bullet">-</span> BTC: 网络拓扑是随机的，交易扩散是扩散到连接节点，扩散前无法指导对方是否已经接收到相同的交易，网络扩散的效率较低<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>共识算法</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">共识算法的基础是少数服从多数</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">区块链引入共识算法保证节点间状态的一致</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">区块链中对状态的共识实质就是对区块的共识, 只要区块一致状态就一定一致</span><br># 拜占庭将军问题:<br></code></pre></td></tr></table></figure>
<ul>
<li>激励共识:<ul>
<li>PoW - 工作量证明算法<figure class="highlight erlang-repl"><table><tr><td class="code"><pre><code class="hljs erlang-repl">利用哈希算法计算区块哈希，使得区块哈希以N个<span class="hljs-number">0</span>开头,<br>比特币网络允许有多条区块链存在，但只认同节点能接收到的最长的那条区块链是全网网络共识的链<br>对比特币网络的篡改，实质是对计算资源(算力)的争夺，谁拥有更多的计算资源，睡的话语权就大，就是通常听到的<span class="hljs-number">51</span><span class="hljs-comment">%攻击</span><br></code></pre></td></tr></table></figure></li>
<li>PoS - 权益证明算法</li>
<li>DPos - 委托权益证明算法</li>
</ul>
</li>
<li>BPFT - 拜占庭容错算法<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">只要共识网络中作恶节点的数量未超过总节点数的<span class="hljs-number">1</span>/<span class="hljs-number">3</span>，共识依旧可以达成</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">BFT类的共识算法主要用在联盟链中，因为联盟链主要参与对象是企业，有准入机制的存在，一条链的参与方不会很多也很少存在动态增删节点的情形</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h2><div class="code-wrapper"><pre><code class="hljs"><figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">传统意义上的合同协议的约束力来自于权威机构背书<br>智能合约实质是一段计算机程序代码<br>智能合约的标准化是价值网络落地的前提<br></code></pre></td></tr></table></figure>
- NTF - 非同质化代币
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">NTF - 一种手段将虚拟与现实的价值锚定.</span><br></code></pre></td></tr></table></figure>
- 元宇宙
<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">元宇宙代表的是一个沉浸式的虚拟世界，玩家能在其中进行文化、社交、娱乐等活动<br>元宇宙是由区块链、游戏、网络和显示四大技术融合而成的虚拟世界<br></code></pre></td></tr></table></figure>
</code></pre>
<h2 id="量子计算"><a href="#量子计算" class="headerlink" title="量子计算"></a>量子计算</h2><ul>
<li>经典计算机与量子计算机存储数据区别<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">经典计算机存储具体的值</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">量子计算存储值的概率</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="区块链"><a href="#区块链" class="headerlink" title="区块链+"></a>区块链+</h2><ul>
<li>可信上链<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown">1.确保区块链上链数据的真实性?<br><span class="hljs-bullet">  -</span> 权威机构的信息发布<br><span class="hljs-bullet">  -</span> 摆脱数据的认为干预<br></code></pre></td></tr></table></figure></li>
<li>预言机<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">将外界真实的信息输入到区块链网络中，实现链外与链内的数据互通.</span><br></code></pre></td></tr></table></figure></li>
<li>5G 物联网<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">5G 依托全新的网络架构，具备高速率、低延迟、高可靠性、大带宽等优势，可以满足人与人之间的通信需求，解决物与物的通信连接问题.</span><br></code></pre></td></tr></table></figure></li>
<li>数字人民币<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; 数字人民币是中国人民银行发行的法定货币的数字化，是由国家信用在背后作支撑，其发行权属于国家.</span><br><span class="hljs-quote">&gt; 数字人民币的定位是现金类支付凭证，意味着数字人民币和纸币、硬币的定位是一致的</span><br><br><span class="hljs-bullet">-</span> 不计利息<br><span class="hljs-bullet">-</span> 无手续费<br><span class="hljs-bullet">-</span> 可控匿名: 小额匿名、大额依法可溯<br><br><span class="hljs-bullet">-</span> 数字人民币的发行是不比使用区块链技术的<br></code></pre></td></tr></table></figure></li>
<li>数字社会<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> 云计算:<br><span class="hljs-bullet">  -</span> 云计算利用虚拟化技术将物理服务器、存储和网络等硬件以服务的形式提供给用户使用<br><span class="hljs-bullet">-</span> 区块链:<br><span class="hljs-bullet">  -</span> 区块链与云计算的结合催生出区块链即服务平台<br><span class="hljs-bullet">  -</span> Baas, Blockchain as a Service<br><span class="hljs-bullet">  -</span> Paas, Platform as a service<br><span class="hljs-bullet">-</span> 大数据:<br><span class="hljs-bullet">  -</span> Volume: 数据量大，通过大数据的数据量是以TB，PB来计算<br><span class="hljs-bullet">  -</span> Volocity: 高速, 大数据需要用较高的速度接收甚至是处理数据<br><span class="hljs-bullet">  -</span> Variety: 多样性, 大数据的数据源很多，且大多数属于非结构化的数据<br><span class="hljs-bullet">  -</span> Value: 价值, 大数据所面对的数据是海量的，但并不是所有的数据都有价值，需要通过数据清洗、过滤出有价值的数据<br><span class="hljs-bullet">  -</span> Veracity: 真实, 需要保证数据的真实性、准确性，才能提高数据质量<br><span class="hljs-bullet">-</span> 人工智能:<br><span class="hljs-bullet">  -</span> 语音识别<br><span class="hljs-bullet">  -</span> 图像识别<br><span class="hljs-bullet">  -</span> 自然语言处理<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Blockchain</category>
      </categories>
  </entry>
  <entry>
    <title>Raspberry Pico Intro</title>
    <url>/2021/09/17/Raspberry-Pico-Intro/</url>
    <content><![CDATA[<h1 id="Raspberry-Pi-Pico"><a href="#Raspberry-Pi-Pico" class="headerlink" title="Raspberry Pi Pico"></a>Raspberry Pi Pico</h1><blockquote>
<p>a microcontroller development board,</p>
</blockquote>
<ul>
<li><p>RP2040</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; new microcontroller chip designed by Raspberry Pi in the UK.</span><br><span class="hljs-bullet">  -</span> dual-core Arm Cortex-M0+<br><span class="hljs-bullet">  -</span> 264KB RAM<br><span class="hljs-bullet">  -</span> 16MB off-chip Flash<br></code></pre></td></tr></table></figure></li>
<li><p>Micro USB Port</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">- provide power make Pico <span class="hljs-builtin-name">run</span><br>- USB<span class="hljs-built_in"> port </span>talk <span class="hljs-keyword">to</span> pico<br></code></pre></td></tr></table></figure></li>
<li><p>BOOTSEL</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm">- <span class="hljs-keyword">BOOTSEL </span>is <span class="hljs-keyword">short </span>for <span class="hljs-keyword">boot </span>selection.<br></code></pre></td></tr></table></figure></li>
</ul>
<span id="more"></span>

<h2 id="Raspberry-Pico’s-pins"><a href="#Raspberry-Pico’s-pins" class="headerlink" title="Raspberry Pico’s pins"></a>Raspberry Pico’s pins</h2><p><img src="/misc/images/pico-pins.png" alt="The Raspberry Pi Pico&#39;s pins"></p>
<ul>
<li><p>Raspberry Pi Pico pins functions</p>
<table>
<thead>
<tr>
<th align="left">…</th>
<th align="left">…</th>
<th align="left">…</th>
</tr>
</thead>
<tbody><tr>
<td align="left">3V3</td>
<td align="left">3.3 volts power</td>
<td align="left">Pico 3.3V 从 VSYS 获取</td>
</tr>
<tr>
<td align="left">VSYS</td>
<td align="left">~2-5 volts power</td>
<td align="left">连接Pico内部电源</td>
</tr>
<tr>
<td align="left">VBUS</td>
<td align="left">5 volts power</td>
<td align="left">5V power taken from Pico’s micro USB port</td>
</tr>
<tr>
<td align="left">GND</td>
<td align="left">0 volts ground</td>
<td align="left">地</td>
</tr>
<tr>
<td align="left">GPxx</td>
<td align="left">General-purpose input/output pin</td>
<td align="left">通用GPIO口</td>
</tr>
<tr>
<td align="left">GPxx_ADCx</td>
<td align="left">GPIO/ADC input</td>
<td align="left">普通GPIO口或ADC输入口</td>
</tr>
<tr>
<td align="left">ADC_VREF</td>
<td align="left">Analogue-to-digital coverter (ADC) voltage reference</td>
<td align="left">模拟数字转换参考电压输入</td>
</tr>
<tr>
<td align="left">AGND</td>
<td align="left">Anaglogue-to-digital coverter (ADC) 0 volts ground</td>
<td align="left">ADC输入电压参考0volts</td>
</tr>
<tr>
<td align="left">RUN</td>
<td align="left">Enable/disable Pico</td>
<td align="left">启动/关闭Pico</td>
</tr>
</tbody></table>
</li>
<li><p>MicroPython - Hello, LED!</p>
<figure class="highlight vhdl"><table><tr><td class="code"><pre><code class="hljs vhdl">import machine<br>import utime<br><br># <span class="hljs-keyword">on</span>-board LED <span class="hljs-keyword">is</span> connected <span class="hljs-keyword">to</span> one <span class="hljs-keyword">of</span> RP2040<span class="hljs-symbol">&#x27;s</span> general-purpose input/output pins. GP25.<br>led_onboard = machine.Pin(<span class="hljs-number">25</span>, machine.Pin.<span class="hljs-keyword">OUT</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    led_onboard.toggle()<br>    utime.sleep(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="MicroPython-on-Raspberry-Pi-Pico"><a href="#MicroPython-on-Raspberry-Pi-Pico" class="headerlink" title="MicroPython on Raspberry Pi Pico"></a>MicroPython on Raspberry Pi Pico</h2><ul>
<li><p>Installing MicroPython</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">&gt; MicroPython is <span class="hljs-keyword">a</span> full implementation <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> Python <span class="hljs-number">3</span> Programming language that runs directly <span class="hljs-keyword">on</span> <span class="hljs-title">embedded</span> <span class="hljs-title">hardware</span> <span class="hljs-title">like</span> <span class="hljs-title">Raspberry</span> <span class="hljs-title">Pi</span> <span class="hljs-title">Pico</span>.<br><span class="hljs-comment"># Hold BOOTSEL button down 3 seconds then let go</span><br>  /Volumes/RPI-RP2<br>  ➜ tree<br>  .<br>  ├── INDEX.HTM<br>  └── INFO_UF2.TXT  <span class="hljs-comment">-- hold information about your Pico</span><br><br>  <span class="hljs-number">0</span> <span class="hljs-built_in">directories</span>, <span class="hljs-number">2</span> <span class="hljs-built_in">files</span><br><br><span class="hljs-comment"># Darg-and-Drop MicroPython</span><br>  - Drag <span class="hljs-keyword">and</span> drop <span class="hljs-keyword">the</span> MicroPython UF2 onto <span class="hljs-keyword">the</span> RPI-RP2 volume, auto flash <span class="hljs-keyword">the</span> firmware onto its internal storage.<br></code></pre></td></tr></table></figure></li>
<li><p>Programming with MicroPython</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">&gt; MicroPython <span class="hljs-keyword">is</span> a Python-compatible programming language developed specifically <span class="hljs-keyword">for</span> microcontrollers.<br><br><span class="hljs-comment"># Thonny - IDE</span><br>MicroPython v1<span class="hljs-number">.17</span> on <span class="hljs-number">2021</span>-09-02; Raspberry Pi Pico <span class="hljs-keyword">with</span> RP2040<br><span class="hljs-type">Type</span> <span class="hljs-string">&quot;help()&quot;</span> <span class="hljs-keyword">for</span> more information.<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, World!&quot;</span>)<br>Hello, World!<br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Rust-on-Raspberry-Pi-Pico"><a href="#Rust-on-Raspberry-Pi-Pico" class="headerlink" title="Rust on Raspberry Pi Pico"></a>Rust on Raspberry Pi Pico</h2><h2 id="Getting-Started-with-FreeRTOS-on-the-Raspberry-Pi-Pico"><a href="#Getting-Started-with-FreeRTOS-on-the-Raspberry-Pi-Pico" class="headerlink" title="Getting Started with FreeRTOS on the Raspberry Pi Pico"></a>Getting Started with FreeRTOS on the Raspberry Pi Pico</h2><blockquote>
<p>RTOS - Real Time Operating System</p>
<blockquote>
<p>Allows multiple tasks to execute “at the same time”<br>Schedules based on task priority<br>“Task Priority” allows the programmer to define what needs to happen first</p>
</blockquote>
</blockquote>
]]></content>
      <categories>
        <category>Hardware</category>
      </categories>
  </entry>
  <entry>
    <title>Dell PowerEdge R720 Intro</title>
    <url>/2021/09/18/Dell-PowerEdge-R720-Intro/</url>
    <content><![CDATA[<h1 id="Dell-EMC-PowerEdge-R720"><a href="#Dell-EMC-PowerEdge-R720" class="headerlink" title="Dell EMC PowerEdge R720"></a>Dell EMC PowerEdge R720</h1><span id="more"></span>

<h2 id="Dell-iDRAC"><a href="#Dell-iDRAC" class="headerlink" title="Dell iDRAC"></a>Dell iDRAC</h2><figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">iDRAC (Integrated Dell Remote Access Controller) 远程控制卡, iDRAC相当于附加在服务器上计算机，可以实现一对一的服务器远程管理与监控，通过与服务器主板上的管理芯片BMC进行通信,监控和管理服务器的硬件状态信息，拥有自己的系统和IP地址，与服务器上的OS无关,是管理员进行远程访问和管理的利器.</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">iDRAC登陆界面默认的用户名是root密码calvin</span><br></code></pre></td></tr></table></figure>

<h2 id="vSphere-ESXi-vCenter-区别"><a href="#vSphere-ESXi-vCenter-区别" class="headerlink" title="vSphere,ESXi,vCenter 区别"></a>vSphere,ESXi,vCenter 区别</h2><ul>
<li>VMware Inc. 软件公司提供包括云产品，数据中心产品和桌面产品</li>
<li>vSphere<figure class="highlight axapta"><table><tr><td class="code"><pre><code class="hljs axapta">数据中心产品下的一套软件, 包括vCenter, EXSi和vSphere <span class="hljs-keyword">client</span>, vSphere不是一个可以安装使用的软件，只是一个包含其他组件的集合.<br></code></pre></td></tr></table></figure></li>
<li>vSphere client<figure class="highlight axapta"><table><tr><td class="code"><pre><code class="hljs axapta">vSphere <span class="hljs-keyword">client</span>允许管理员访问ESXi服务并管理虚拟机。vSphere <span class="hljs-keyword">client</span>是安装在客户端上面，vSphere <span class="hljs-keyword">client</span>用来连接ESXi服务器和管理任务, 用来访问ESXi服务安装和管理上面的虚拟机<br>vSphere <span class="hljs-keyword">client</span>可以在小环境中直接管理ESXi服务，可以在大规模的环境中，通过vCenter服务间接管理ESXi服务<br></code></pre></td></tr></table></figure></li>
<li>EXSi<figure class="highlight erlang"><table><tr><td class="code"><pre><code class="hljs erlang">ESXi是虚拟化服务，所有的虚拟机都运行在ESXi服务上面,为了安装，管理和访问虚拟机，需要vSphere client或vCenter.<br>ESXi安装在物理机上面的服务.<br></code></pre></td></tr></table></figure></li>
<li>vCenter server<figure class="highlight axapta"><table><tr><td class="code"><pre><code class="hljs axapta">VMware vCenter <span class="hljs-keyword">server</span>是一个企业级别的产品, 中心化的管理应用，可以通过管理所有的虚拟机和ESXi物理机<br>vCenter服务用在有很多EXSi服务和许多虚拟机的大规模环境中<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Install-Ubuntu-20-04-on-R720"><a href="#Install-Ubuntu-20-04-on-R720" class="headerlink" title="Install Ubuntu 20.04 on R720"></a>Install Ubuntu 20.04 on R720</h2><ul>
<li>Show Hardware and Network Infomation<figure class="highlight tcl"><table><tr><td class="code"><pre><code class="hljs tcl">chyiyaqing in ~ at chyiyaqing-PowerEdge-R720<br>➜ wget -qO- bench.sh | bash<br><br>grep: /<span class="hljs-keyword">proc</span>/1/environ:<span class="hljs-title"> Permission</span> denied<br>----------------------------------------------------------------------<span class="hljs-title"></span><br><span class="hljs-title"> CPU</span> Model             :<span class="hljs-title"> Intel(R)</span> Xeon(R)<span class="hljs-title"> CPU</span> E5-2650<span class="hljs-title"> v2</span> @ 2.60GHz<span class="hljs-title"></span><br><span class="hljs-title"> CPU</span> Cores             : 32<span class="hljs-title"></span><br><span class="hljs-title"> CPU</span> Frequency         : 1204.573<span class="hljs-title"> MHz</span><br><span class="hljs-title"> CPU</span> Cache             : 20480<span class="hljs-title"> KB</span><br><span class="hljs-title"> Total</span> Disk            : 1127.3<span class="hljs-title"> GB</span> (9.2<span class="hljs-title"> GB</span> Used)<span class="hljs-title"></span><br><span class="hljs-title"> Total</span> Mem             : 32106<span class="hljs-title"> MB</span> (1015<span class="hljs-title"> MB</span> Used)<span class="hljs-title"></span><br><span class="hljs-title"> Total</span> Swap            : 2047<span class="hljs-title"> MB</span> (0<span class="hljs-title"> MB</span> Used)<span class="hljs-title"></span><br><span class="hljs-title"> System</span> uptime         : 0<span class="hljs-title"> days,</span> 0<span class="hljs-title"> hour</span> 22<span class="hljs-title"> min</span><br><span class="hljs-title"> Load</span> average          : 0.07, 0.09, 0.17<span class="hljs-title"></span><br><span class="hljs-title"> OS</span>                    :<span class="hljs-title"> Ubuntu</span> 20.04.3<span class="hljs-title"> LTS</span><br><span class="hljs-title"> Arch</span>                  :<span class="hljs-title"> x86_64</span> (64<span class="hljs-title"> Bit)</span><br><span class="hljs-title"> Kernel</span>                : 5.11.0-36-generic<span class="hljs-title"></span><br><span class="hljs-title"> TCP</span> CC                :<span class="hljs-title"> cubic</span><br><span class="hljs-title"> Virtualization</span>        :<span class="hljs-title"> Dedicated</span><br>----------------------------------------------------------------------<span class="hljs-title"></span><br><span class="hljs-title"> I/O</span> Speed(1st<span class="hljs-title"> run)</span>    : 323<span class="hljs-title"> MB/s</span><br><span class="hljs-title"> I/O</span> Speed(2nd<span class="hljs-title"> run)</span>    : 267<span class="hljs-title"> MB/s</span><br><span class="hljs-title"> I/O</span> Speed(3rd<span class="hljs-title"> run)</span>    : 275<span class="hljs-title"> MB/s</span><br><span class="hljs-title"> Average</span> I/O<span class="hljs-title"> speed</span>     : 288.3<span class="hljs-title"> MB/s</span><br>----------------------------------------------------------------------<span class="hljs-title"></span><br><span class="hljs-title"> Node</span> Name<span class="hljs-title">        Upload</span> Speed<span class="hljs-title">      Download</span> Speed<span class="hljs-title">      Latency</span><br><span class="hljs-title"> Shanghai</span> <span class="hljs-title">  CT</span>    49.45<span class="hljs-title"> Mbps</span>        256.81<span class="hljs-title"> Mbps</span>         9.34<span class="hljs-title"> ms</span><br><span class="hljs-title"> Shanghai</span> <span class="hljs-title">  CU</span>    50.03<span class="hljs-title"> Mbps</span>        263.91<span class="hljs-title"> Mbps</span>         17.96<span class="hljs-title"> ms</span><br><span class="hljs-title"> Guangzhou</span> <span class="hljs-title"> CT</span>    55.97<span class="hljs-title"> Mbps</span>        264.49<span class="hljs-title"> Mbps</span>         35.69<span class="hljs-title"> ms</span><br><span class="hljs-title"> Guangzhou</span> <span class="hljs-title"> CU</span>    50.19<span class="hljs-title"> Mbps</span>        257.02<span class="hljs-title"> Mbps</span>         31.51<span class="hljs-title"> ms</span><br>----------------------------------------------------------------------<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Hardware</category>
      </categories>
  </entry>
  <entry>
    <title>Rust language Intro</title>
    <url>/2021/09/18/Rust-language-Intro/</url>
    <content><![CDATA[<h1 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h1><blockquote>
<p>一门非常重视开发者用户体验的语言<br>如果你想从其他语言迁移到Rust,必须经过一段时期的思维转换(Paradigm Shift)<br>  <figure class="highlight gcode"><table><tr><td class="code"><pre><code class="hljs gcode">命令式<span class="hljs-comment">(imperative)</span>编程语言转换为函数式<span class="hljs-comment">(function)</span>编程语言<br>变量的可变性<span class="hljs-comment">(mutable)</span>迁移到不可变性<span class="hljs-comment">(immutable)</span><br>弱类型语言迁移到强类型语言<br>从手工或者自动内存管理到通过生命周期来管理内存<br></code></pre></td></tr></table></figure><br>Rust最大的思维转换就是变量的所有权和声明周期</p>
</blockquote>
<span id="more"></span>

<h2 id="1-前置知识篇"><a href="#1-前置知识篇" class="headerlink" title="1. 前置知识篇"></a>1. 前置知识篇</h2><ul>
<li>内存<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"># 栈<br><span class="hljs-meta">&gt;</span> <span class="javascript">栈自上而下增长</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">栈是程序运行的基础，每当一个函数被调用时，一块连续的内存就会被栈顶分配出来，这块内存被称为帧(frame)</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">在编译时，一切无法确定大小或者大小可以改变的数据,都无法放在栈上，只能放在堆上</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">存放栈上的值，它的大小在编译期就需要确定</span><br><br># 堆<br><span class="hljs-meta">&gt;</span> <span class="javascript">堆自下而上增长</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">堆上分配内存时，一般都会预留一些空间</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">动态分配大小的内存需要被分配到堆上，动态声明周期的内存也需要分配到堆上.</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">堆上分配出来的每一块内存需要显式地释放，这就使堆山内存有更加灵活的声明周期，可以在不同的调用栈之间共享数据</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">堆可以存放大小未知或者动态伸缩的数据类型</span><br><br>栈上存放的数据时静态的，静态大小，静态生命周期，堆上存放的数据时动态的，动态大小，动态生命周期<br><br># GC vs ARC<br>  1. GC在内存分配和释放上无需额外操作，而ARC添加了大量的额外代码处理引用计数，所以GC效率更高，吞吐量(throughput)更大<br>  2. GC释放内存的时机不确定，释放时引发的STW(Stop The World)会导致代码执行的延迟latency.一般携带GC的编程语言不适合做嵌入式系统或者实时系统<br></code></pre></td></tr></table></figure></li>
<li>数据<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; 程序操作的对象</span><br><br><span class="hljs-section"># 值和类型</span><br><span class="hljs-quote">&gt; 编程语言的类型可以分为原生类型和组合类型</span><br><span class="hljs-bullet">  -</span> 原生类型(primitive type) : 所有原生类型的大小都是固定的，因此他们可以被分配到栈上<br><span class="hljs-bullet">    -</span> 字符<br><span class="hljs-bullet">    -</span> 整数<br><span class="hljs-bullet">    -</span> 浮点数<br><span class="hljs-bullet">    -</span> 布尔值<br><span class="hljs-bullet">    -</span> 数组array<br><span class="hljs-bullet">    -</span> 元组tuple<br><span class="hljs-bullet">    -</span> 指针<br><span class="hljs-bullet">      -</span> 胖指针(fat poiner): 比正常指针携带更多信息的指针<br><span class="hljs-bullet">  -</span> 组合类型(composite type) : 由一组原生类型和其它类型组合而成的类型<br><span class="hljs-bullet">    -</span> 结构体(structure type): 多个类型组合在一起共同表达一个值的复杂数据结构<br><span class="hljs-bullet">    -</span> 标签联合(tagged union): 不相交并集<br></code></pre></td></tr></table></figure></li>
<li>指针和引用<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">指针和应用都指向内存地址，只不过二者在解引用时的行为不一样<br>引用只能解引用到原来的数据类型<br></code></pre></td></tr></table></figure></li>
<li>函数<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">函数时代码中重复行为的抽象</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">方法时对象内部定义的函数</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">函数是编程语言的基本要素,是对完成某个功能的一组相关语句和表达式的封装</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">函数往往是一等公民，意味着函数可以作为参数传递，或者作为返回值返回，也可以作为符合类型中的一个组成部分</span><br></code></pre></td></tr></table></figure></li>
<li>闭包<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">闭包是一种特殊的函数，会捕获函数体内使用到的上下文中的自由变量,作为闭包成员的一部分</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">闭包是将函数和其环境一起存储的一种数据结构</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">闭包引用的上下文中的自由变量会被捕获到闭包的结构中，成为闭包类型的一部分</span><br></code></pre></td></tr></table></figure></li>
<li>接口&amp;&amp;虚表<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 接口</span><br><span class="hljs-quote">&gt; 作为一个抽象层,接口将使用方和实现方隔离开来，使两者不直接有依赖关系，大大提高了复用性和扩展性</span><br><br><span class="hljs-section"># 虚表 virtual table</span><br><span class="hljs-quote">&gt; 虚表是指向一张涵盖接口所支持方法的列表</span><br></code></pre></td></tr></table></figure></li>
<li>并发(concurreny)与并行(parallel)<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 并发</span><br><span class="hljs-quote">&gt; 并发是同时与多件事情打交道的能力，比如系统可以在任务1做到一定程度后，保存该任务的上下文，挂起并切换到任务2，然后过段时间在切换回任务1</span><br><br><span class="hljs-section"># 并行</span><br><span class="hljs-quote">&gt; 并行是同时处理多件事情的手段，任务1和任务2可以在同一个时间片下工作,无需上下文切换</span><br><br>拥有高并发处理能力的编程语言会在用户程序中嵌入一个M:N的调度器，把M个并行任务，合理地分配在N个CPU core上并行运行,让程序的吞吐量达到最大<br></code></pre></td></tr></table></figure></li>
<li>同步和异步<figure class="highlight coffeescript"><table><tr><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-comment"># 同步</span><br>&gt; 指一个任务开始执行后，后续的操作回阻塞，直到这个任务结束<br>&gt; 同步执行保证了代码的因果关系(causality),是程序正确性的保证<br><br><span class="hljs-comment"># 异步</span><br>&gt; 指一个任务开始执行后，与它没有因果关系的其他任务可以正常执行，不必等待前一个任务结束<br>  - <span class="hljs-built_in">Promise</span>(future/delay/deferred): 对象用来描述未来某个时刻才能获得的结果的值<br>    - 初始状态: <span class="hljs-built_in">Promise</span>还未运行<br>    - 等待pending状态: <span class="hljs-built_in">Promise</span>已经运行，但还没有结束<br>    - 结束状态: promise成功解析出一个值，或者执行失败<br>  - <span class="hljs-keyword">async</span>/<span class="hljs-keyword">await</span><br>    &gt; <span class="hljs-keyword">async</span>/<span class="hljs-keyword">await</span>是一个语法糖(syntactic sugar)使用状态机将promise包装起来，让异步调用的使用感觉和同步调用非常类型<br>    - <span class="hljs-keyword">async</span>定义一个可以并发执行的任务<br>    - <span class="hljs-keyword">await</span>触发并发执行<br></code></pre></td></tr></table></figure></li>
<li>编程泛式<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 泛型编程</span><br><span class="hljs-bullet">  -</span> 数据结构的泛型<br><span class="hljs-bullet">  -</span> 代码的泛型化<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-基础知识篇"><a href="#2-基础知识篇" class="headerlink" title="2. 基础知识篇"></a>2. 基础知识篇</h2><ul>
<li>第一个程序<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">➜ tree scrape_url<br>scrape_url<br>├── Cargo<span class="hljs-selector-class">.lock</span><br>├── Cargo<span class="hljs-selector-class">.toml</span>      -- Rust项目的配置管理文件<br>├── <span class="hljs-attribute">src</span><br>│   └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.rs</span><br>└── target<br>    ├── CACHEDIR<span class="hljs-selector-class">.TAG</span><br>    └── debug<br>        ├── build<br>        ├── deps<br>        │   ├── libscrape_url-f8d1878e1d7fc033<span class="hljs-selector-class">.rmeta</span><br>        │   └── scrape_url-f8d1878e1d7fc033<span class="hljs-selector-class">.d</span><br>        ├── examples<br>        └── incremental<br>            └── scrape_url-<span class="hljs-number">2</span>n1xt1o9t0ikb<br>                ├── s-g4eprmaq6h-ez2nl7-<span class="hljs-number">1</span>g41whu33uaqz<br>                │   ├── dep-graph<span class="hljs-selector-class">.bin</span><br>                │   ├── query-cache<span class="hljs-selector-class">.bin</span><br>                │   └── work-products<span class="hljs-selector-class">.bin</span><br>                └── s-g4eprmaq6h-ez2nl7<span class="hljs-selector-class">.lock</span><br><br><span class="hljs-number">9</span> directories, <span class="hljs-number">10</span> files<br><br>scrape_url on  <span class="hljs-selector-tag">main</span> <span class="hljs-selector-attr">[?]</span> is 📦 v0.<span class="hljs-number">1.0</span> via 🦀 v1.<span class="hljs-number">52.0</span> took <span class="hljs-number">8s</span><br>➜ cargo run<br>   Compiling scrape_url v0.<span class="hljs-number">1.0</span> (/Users/chyiyaqing/chyi/github.com/begin-rust/scrape_url)<br>    Finished dev <span class="hljs-selector-attr">[unoptimized + debuginfo]</span> target(s) <span class="hljs-keyword">in</span> <span class="hljs-number">3.13s</span><br>     Running `target/debug/scrape_url`<br>Fetching url: https:<span class="hljs-comment">//www.rust-lang.org/</span><br>Converting <span class="hljs-selector-tag">html</span> to markdown...<br>Converted markdown has been saved <span class="hljs-keyword">in</span> rust<span class="hljs-selector-class">.md</span>.<br><br>&gt; Rust使用cargo工具管理项目<br>&gt; Rust整体语法偏向C/C++风格<br>&gt; Rust支持面向接口编程和泛型编程<br>&gt; Rust有非常丰富的数据类型和强大的标准库<br>&gt; Rust有非常丰富的控制流程<br>&gt; Rust默认变量不可变，可以添加mut关键字让变量具备可变性<br>&gt; Rust项目的组织可以用mod来组织代码<br>&gt; Rust一个项目被称为crate (cargo new &lt;name&gt; -- lib 创建一个库)<br></code></pre></td></tr></table></figure></li>
<li>Rust变量的所有权和生命周期</li>
<li>Rust内存管理方式</li>
<li>C的手工管理</li>
<li>Java的GC</li>
<li>Swift的ARC</li>
<li>Rust语言特性<ul>
<li>函数式编程特性</li>
<li>类型系统</li>
<li>范性编程</li>
<li>错误处理</li>
</ul>
</li>
</ul>
<h2 id="3-进阶篇"><a href="#3-进阶篇" class="headerlink" title="3. 进阶篇"></a>3. 进阶篇</h2><p>  *</p>
<h2 id="4-并发篇"><a href="#4-并发篇" class="headerlink" title="4. 并发篇"></a>4. 并发篇</h2><ul>
<li>无畏并发(Fearless Concurrency)</li>
</ul>
<h2 id="5-实战篇"><a href="#5-实战篇" class="headerlink" title="5. 实战篇"></a>5. 实战篇</h2><ul>
<li>HTTPie<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><blockquote>
<p>学习过程就像《中庸》里谈治学的方法：博学之、审问之、慎思之、明辨之、笃(du)行之<br>算法+数据结构=程序, Pascal之父,图灵奖得主Niklaus Wirth</p>
</blockquote>
<ul>
<li>Paradigm Shift : 思维转换</li>
<li>Stack Overflow: 栈溢出</li>
<li>heap out of bounds: 堆越界</li>
<li>use after free : 堆上的内存被释放，但栈上指向堆上内存的响应指针没有被清空</li>
<li>Tracing GC : 追踪式垃圾回收(通过定期标记mark找出不再被引用的对象，然后将其清理sweep掉，来自动管理内存)</li>
<li>Automatic Reference Counting: 自动引用计数 (编译时，为每个函数插入retain/release语句来自动维护堆上对象的引用计数，当引用计数为零的时候，release语句就释放对象)</li>
<li>throughput: 吞吐量</li>
<li>syntactic sugar: 语法糖</li>
<li>Principle of Least Privilege: 最小权限原则</li>
<li>derive macro : 派生宏</li>
</ul>
<h2 id="阅读资料"><a href="#阅读资料" class="headerlink" title="阅读资料"></a>阅读资料</h2><ul>
<li><a href="https://github.com/chyidl/begin-rust.git">begin-rust</a></li>
<li><a href="https://doc.rust-lang.org/book/">The Rust Programming Language</a></li>
</ul>
]]></content>
      <categories>
        <category>Programming Language</category>
      </categories>
  </entry>
  <entry>
    <title>Kubernetes Intro</title>
    <url>/2021/09/19/Kubernetes-Intro/</url>
    <content><![CDATA[<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><span id="more"></span>

<h2 id="容器基础"><a href="#容器基础" class="headerlink" title="容器基础"></a>容器基础</h2><blockquote>
<p>容器技术的核心功能，就是通过约束和修改进程的动态表现，从而为其创建出一个“边界”<br>容器，其实是一种特殊的单进程模型而已<br>同一台机器上的所有容器，都共享宿主机操作系统的内核</p>
</blockquote>
  <figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># Cgroups技术用来限制</span><br><span class="hljs-comment"># Namespace技术则是用隔离</span><br>  - Mount Namespace 跟其他Namespace使用略有不同，它对容器进程视图的改变一定是伴随着挂载操作mount才能生效<br>  - <span class="hljs-keyword">chroot</span> (change root file <span class="hljs-keyword">system</span>): 改变进程的根目录到指定位置<br><span class="hljs-comment"># rootfs 根文件系统 (不包括系统内核)</span><br>  &gt; 由于rootfs里打包的不只是应用，而是整个操作系统的文件和目录 (对于一个应用来说，操作系统本身才是它圆形所需要的最完整的<span class="hljs-string">&quot;依赖库&quot;</span>)<br>  - pivot_root<br>  - <span class="hljs-keyword">chroot</span><br></code></pre></td></tr></table></figure>
<ul>
<li><p>Cgroups</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Linux Cgroups是Linux内核中用来为进程设置资源限制的一个重要功能</span><br><span class="hljs-comment"># Linux Cgroups全称 Linux Control Group,主要作用就是限制进程组能够使用的资源上限，CPU、内存、磁盘、网络带宽</span><br><br>➜ mount -t cgroup<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)                        -- 为块设备设置I/O限制，一般用于磁盘等设备<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/m</span>emory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)                      -- 为进程设置内存使用限制<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)                      -- 为进程分配单独的CPU核和对应的内存节点<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)<br>cgroup on <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)<br><br>➜ ls  <span class="hljs-regexp">/sys/</span>fs<span class="hljs-regexp">/cgroup/</span>cpu<br>cgroup.clone_children  cpuacct.usage             cpuacct.usage_percpu_user  cpu.cfs_quota_us  init.scope         system.slice<br>cgroup.procs           cpuacct.usage_all         cpuacct.usage_sys          cpu.shares        kubepods.slice     tasks<br>cgroup.sane_behavior   cpuacct.usage_percpu      cpuacct.usage_user         cpu.stat          notify_on_release  user.slice<br>cpuacct.stat           cpuacct.usage_percpu_sys  cpu.cfs_period_us          docker            release_agent<br></code></pre></td></tr></table></figure></li>
<li><p>Docker vs Hypervisor</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 用户运行在容器里的应用进程根宿主主机上的其他进程一样，都由宿主主机操作系统同一管理，只不过这些被隔离的进程拥有额外设置过的Namesapce参数, 而Docker项目在这里扮演的角色更多的是旁路式的辅助和管理工作<br><span class="hljs-bullet">2.</span> Hypervisor虚拟化作为应用沙盒，必须由Hypervisor负责创建虚拟机，这个虚拟机真实存在，并且运行完整的GuestOS才能执行用户的应用进程.<br></code></pre></td></tr></table></figure></li>
<li><p>容器化</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"> &gt; Dockerd实际上是在创建容器进程时，指定进程所需要启动的一组Namespace参数，这样，容器只能“看”到当前Namespace所限定的资源、文件、设备、状态、或配置，而对于宿主机以及其他不相关的程序，就完全看不到<br><span class="hljs-meta">&gt;</span> <span class="javascript"><span class="hljs-string">&quot;敏捷&quot;</span>和<span class="hljs-string">&quot;高性能&quot;</span>是容器相较于虚拟机最大的优势，也是它能够在PaaS这种更细粒度的资源管理平台上大行其道的重要原因.</span><br><br>- 容器和应用的同生命周期<br></code></pre></td></tr></table></figure></li>
<li><p>Docker镜像</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash"> Docker镜像的设计中引入层layer,用户制作镜像的每一步操作都会生成一个层，也就是一个增量rootfs</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Union File System 联合文件系统</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 将多个不同位置的目录联合挂在(Union mount)到同一个目录下</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> overlay2</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> overlay2, <span class="hljs-built_in">which</span> has potential performance advantages over the aufs storage driver.</span><br></code></pre></td></tr></table></figure></li>
<li><p>容器</p>
<blockquote>
<p>是由Linux Namespace、Linux Cgroups和rootfs第三种技术构建出来的进程隔离环境</p>
</blockquote>
</li>
<li><p>Linux容器</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 容器镜像 - 静态视图</span><br>  &gt; 一组联合rootfs<br><br><span class="hljs-meta"># 容器运行时 - 动态视图</span><br>  &gt; 一组Namespace + Cgroups 构成的隔离环境<br><br><span class="hljs-meta"># 容器编排工具:</span><br>  - Docker: Compose+Swarm<br>  - Google+ReadHat: Kubernetes<br></code></pre></td></tr></table></figure></li>
<li><p>Kubernetes全局架构<br><img src="/misc/images/kubernetes-global-articture.png" alt="Kubernetes 全局架构"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> Master(控制节点):<br>  &gt; 如何编排、管理、调度用户提交的作业<br><span class="hljs-bullet">  -</span> kube-controller-manager: Controller Manager<br><span class="hljs-bullet">  -</span> kube-apiserver: API Server (整个集群的持久化数据由kube-apiserver处理后保存在Etcd中)<br><span class="hljs-bullet">  -</span> kube-scheduler: Scheduler<br><br><span class="hljs-bullet">-</span> Node(计算节点):<br><span class="hljs-bullet">  -</span> kubelet: kubelet主要责任同容器运行时(docker)交互<br><span class="hljs-bullet">  -</span> CNI : kubelet + Networking - 网络插件为容器配置网络<br><span class="hljs-bullet">  -</span> CRI : kubectl + Container Runtime Interface (接口定义容器运行时的各项核心操作)<br><span class="hljs-bullet">  -</span> CSI : kubectl + Volume Plugin - 存储插件为容器持久化存储<br><span class="hljs-bullet">  -</span> OCI : Container Runtime Interface (容器运行时规范同底层Linux操作系统进行交互, 即将CRI请求翻译成Linux系统操作调用 Namespace + Cgroups)<br><span class="hljs-bullet">  -</span> grpc: kubelet + Device Plugin (Kubernetes项目管理宿主主机物理设备的主要组件)<br><br><span class="hljs-quote">&gt; Kubernetes项目关心解决的问题是&quot;运行在大规模集群中的各种任务之间，实际上存在着各种各样的关系，这些关系的处理，才是作业编排和管理系统最困难的地方&quot;</span><br></code></pre></td></tr></table></figure></li>
<li><p>Kubernetes 核心功能<br><img src="/misc/images/kubernetes-pod-road-map.png" alt="Kubernetes 核心功能"></p>
<figure class="highlight vala"><table><tr><td class="code"><pre><code class="hljs vala">&gt; Kubernetes项目的本质是为用户提供一个具有普遍意义的容器编排工具<br><br><span class="hljs-meta"># Pod:</span><br>  &gt; Pod里的容器共享同一个Network Namespace,同一组数据卷，从而达到高效交换信息的目的<br>  &gt; Pod就是Kubenetes世界里的<span class="hljs-string">&quot;应用&quot;</span>,而一个应用，可以由多个容器组成<br><br><span class="hljs-meta"># Service:</span><br>  &gt; Service服务作为Pod代理入口(Portal)从而代替Pod对外暴露一个固定的网络地址<br><br><span class="hljs-meta"># Deployment:</span><br>  &gt; Pod多实例管理器<br><br><span class="hljs-meta"># Secret:</span><br>  &gt; Secret对象是保存在Etcd里的键值对数据<br><br><span class="hljs-meta"># Job:</span><br>  &gt; 描述一次性运行Pod<br><br><span class="hljs-meta"># CronJob:</span><br>  &gt; 描述定时任务<br><br><span class="hljs-meta"># DaemonSet:</span><br>  &gt; 描述每个宿主机上必须且只能运行一个副本的守护进程服务<br><br><br><span class="hljs-meta"># 编排对象 - 描述管理的应用</span><br>  - Pod<br>  - Job<br>  - CronJob<br><br><span class="hljs-meta"># 服务对象 - 负责平台级功能</span><br>  - Service<br>  - Secret<br>  - Horizontal Pod Autoscaler(自动水平扩展器)<br><br><span class="hljs-meta"># 声明式API</span><br>  &gt; 这种API对应的<span class="hljs-string">&quot;编排对象&quot;</span>和<span class="hljs-string">&quot;服务对象&quot;</span>都是Kubernetes项目中的API对象(API <span class="hljs-built_in">Object</span>)<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Kubernetes-概念"><a href="#Kubernetes-概念" class="headerlink" title="Kubernetes 概念"></a>Kubernetes 概念</h2><ul>
<li>概述<ul>
<li>Kubernetes是什么<br><img src="/misc/images/container_evolution.svg" alt="容器演进过程"><figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; Kubernetes 是一个可移植的，可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化.</span><br><span class="hljs-quote">&gt; Kubernetes源于希腊语,意为&quot;舵手&quot;或&quot;飞行员&quot;</span><br><span class="hljs-quote">&gt; Kubernetes建立在Google在大规模运行生产工作负载方面拥有十几年的经验的基础上，结合社区中最好的想法和实践.</span><br><br><span class="hljs-section"># 传统部署时代:</span><br><span class="hljs-bullet">  -</span> 资源分配问题<br><br><span class="hljs-section"># 虚拟化部署时代:</span><br><span class="hljs-bullet">  -</span> 虚拟化技术允许在单个物理服务器的CPU上运行多个虚拟机VM,虚拟化允许应用程序在VM之间隔离,并提供一定成都的安全，因为一个应用程序的信息不能被另一个应用程序随意访问<br><span class="hljs-bullet">  -</span> 虚拟化技术能够更好的利用物理服务器上的资源，因为可轻松地添加或更新应用程序而可以实现更好的可伸缩性，降低硬件成本<br><span class="hljs-bullet">  -</span> 每一个VM是一台完整的计算机，在虚拟化硬件之上运行所有组件，包括其自己的操作系统<br><br><span class="hljs-section"># 容器部署时代:</span><br><span class="hljs-bullet">  -</span> 容器类似于VM，但是具有被放宽的隔离属性，可以在应用程序之间共享操作系统OS<br><span class="hljs-bullet">  -</span> 容器与VM具有自己的文件系统、CPU、内存、进程空间<br><span class="hljs-bullet">  -</span> 容器的好处:<br><span class="hljs-bullet">    -</span> 敏捷应用程序的创建和部署: 与使用VM镜像相比，提高容器镜像创建的便捷性和效率<br><span class="hljs-bullet">    -</span> 持续开发、集成和部署: 通过快速简单的回滚(由于镜像不可变性)，支持可靠且频繁的容器镜像构建和部署<br><span class="hljs-bullet">    -</span> 开发与运维的分离: 在构建/发布时而不是在部署时创建应用程序容器镜像,从而将应用程序于基础架构分离<br><span class="hljs-bullet">    -</span> 可观察性: 显示操作系统级别的信息和指标，显示应用程序的运行状态和其他指标信号<br><span class="hljs-bullet">    -</span> 跨开发、测试和生产的环境一致性: 在便携计算机上与云中相同地运行<br><span class="hljs-bullet">    -</span> 跨云和操作系统发型版本的可移植性: 可在Ubuntu,RHEL,CoreOS,本地<br><span class="hljs-bullet">    -</span> 以应用程序为中心的管理: 提高抽象级别，从在虚拟硬件上运行OS到使用逻辑资源在OS上运行应用程序<br><span class="hljs-bullet">    -</span> 松散耦合、分布式、弹性、解放的微服务: 应用程序被分解成较小的独立部分，并且可以动态部署和管理-而不是在一台大型单机上整体运行<br><span class="hljs-bullet">    -</span> 资源隔离: 可预测的应用程序性能<br><span class="hljs-bullet">    -</span> 资源利用: 高效率和高密度<br><br><span class="hljs-section"># Kubernetes 提供功能:</span><br><span class="hljs-bullet">  -</span> 服务发现和负载均衡<br><span class="hljs-bullet">  -</span> 存储编排<br><span class="hljs-bullet">  -</span> 自动部署和回滚:<br><span class="hljs-bullet">  -</span> 自动完成装箱计算:<br><span class="hljs-code">    &gt; Kubernetes 允许指定每个容器所需CPU和内存RAM 当容器指定资源请求时，Kubernetes可以做出更好的决策来管理容器资源</span><br><span class="hljs-code">  - 自我修复</span><br><span class="hljs-code">  - 密钥与配置管理:</span><br><span class="hljs-code">    &gt; Kubernetes存储和管理敏感信息</span><br><span class="hljs-code"></span><br><span class="hljs-section"># Kubernetes 不提供:</span><br><span class="hljs-bullet">  -</span> 不限制支持的应用程序类型: Kubernetes支持及其多种多样的工作负载，包括无状态、有状态和数据处理工作负载。如果应用程序可以在容器中运行，那么他应该可以在Kubernetes上很好的运行.<br><span class="hljs-bullet">  -</span> 不部署源代码，也不构建应用: 持续集成CI、交付和部署CI/CD工作流<br><span class="hljs-bullet">  -</span> 不提供应用程序级别的服务作为内置服务<br><span class="hljs-bullet">  -</span> 不提供日志记录、监控或报警解决方案: 提供一些集成作为概念证明并提供收集和到处指标的机制<br><span class="hljs-bullet">  -</span> 不提供不采用任何全面的机器配置、维护、管理或自我修复系统<br><br><span class="hljs-quote">&gt; Kubernetes 不仅仅是一个编排系统，实际上消除了编排的需要，编排的技术定义是执行已定义的工作流程，首先执行A，然后执行B，在执行C，Kubernetes包含一组独立的，可组合的控制过程，这些过程联系地将当前状态驱动到所提供状态，如何从A到C的方式无关紧要，也不需要几种控制，使得系统更易于使用且功能更强大、系统更健壮、更为弹性和扩展性.</span><br></code></pre></td></tr></table></figure></li>
<li>Kubernetes 组件<br><img src="/misc/images/components-of-kubernetes.svg" alt="Kubernetes关联组件"><figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Control Plane Compoenents 控制平面组件</span><br>  &gt; 控制平面组件对集群做出全局决策(调度),以及检测和响应集群事件<br>  &gt; 控制平面组件可以在集群中的任何节点上运行<br><br><span class="hljs-bullet">  -</span> kube-apiserver:<br><span class="hljs-code">    &gt; 该组件公开Kubernetes API, API服务器是Kubernetes控制面的前端</span><br><span class="hljs-code">    &gt; 运行kube-apiserver多个实例并在这些实例之间平衡流量</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">  -</span> etcd:<br><span class="hljs-code">    &gt; etcd 是兼顾一致性和高可用性的键值数据库,作为保存Kubernetes所有集群数据的后台数据库</span><br></code></pre></td></tr></table></figure></li>
<li>PV、PVC、StorageClass<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Kubernetes 容器持久化存储</span><br><span class="hljs-bullet">  -</span> PV: 持久化存储的实现<br><span class="hljs-code">    &gt; 持久化存储数据卷,定义的是一个持久化存储在宿主主机上的目录</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">  -</span> PVC: 持久化存储的接口<br><span class="hljs-code">    &gt; 描述的持久化存储的属性 (Volume存储大小,可读写权限)</span><br><span class="hljs-code">    &gt; PVC必须和某个符合条件的PV进行绑定</span><br><span class="hljs-code">      - 1. PV 和 PVC 的spec字段, PV的存储(storage)大小,必须满足PVC的要求</span><br><span class="hljs-code">      - 2. PV 和 PVC 的storageClassName字段必须一样</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">  -</span> Volume Controller: 持久化存储控制器<br><span class="hljs-bullet">    -</span> PersistentVolumeController:<br><span class="hljs-code">      &gt; 不断查看当前每一个PVC是否已经处于Bound状态,如果不是，就会遍历所有的、可用的PV,尝试将其PVC进行绑定</span><br><span class="hljs-code"></span><br><span class="hljs-section"># 持久化Volume</span><br><span class="hljs-bullet">  -</span> 远程文件存储<br><span class="hljs-bullet">    -</span> NFS<br><span class="hljs-bullet">    -</span> GlusterFS<br><span class="hljs-bullet">  -</span> 远程快存储<br><span class="hljs-bullet">    -</span> 公有云提供的远程磁盘<br><br><span class="hljs-section"># 准备&quot;持久化&quot;宿主机目录</span><br><span class="hljs-bullet">  -</span> 第一阶段 (Attch) -- nodeName<br><span class="hljs-code">    &gt; 默认情况下，kubelet 为 Volume创建的目录是 /var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/kubernetes.io-&lt;Volume类型&gt;/&lt;Volume名字&gt;</span><br><span class="hljs-code">    &gt; AttachDetachController (运行在Master节点上)</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">  -</span> 第二阶段 (Mount) -- dir<br><span class="hljs-code">    &gt; 格式化磁盘设备,然后将其挂在到宿主机指定的挂载点上</span><br><span class="hljs-code">    &gt; VolumeManagerReconciler (运行在Node节点上,是一个独立于kubelet主循环的goroutine)</span><br><span class="hljs-code"></span><br><span class="hljs-section"># StorageClass:</span><br>  &gt; Kubernetes 提供一套可以自动创建PV的机制，Dynamic Provisioning<br>  &gt; 手动创建PV的方式叫做 Staic Provisioning<br>  &gt; StorageClass的作用就是创建PV的模板<br><span class="hljs-bullet">  -</span> 1. PV的属性 (存储类型、Volume大小)<br><span class="hljs-bullet">  -</span> 2. 创建PV需要用到的存储插件(Ceph, NFS)<br>  &gt; Kubernetes根据用户提交的PVC，找到对应的StorageClass,然后调用该StorageClass声明的存储插件，创建出需要的PV<br></code></pre></td></tr></table></figure>
<img src="/misc/images/kubernetes-storageclass.png" alt="StorageClass 流程"><ul>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">搭建StorageClass + NFS</a><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">1. 创建一个可用的NFS<span class="hljs-built_in"> Server</span><br><span class="hljs-built_in"></span>  IP: 172.30.1.14<br>  <span class="hljs-builtin-name">Export</span> PATH: /export/K8sData/<br><br>  $ sudo apt-<span class="hljs-builtin-name">get</span> install nfs-common cifs-utils<br><br>2. 创建Service Account. 管控NFS Provisioner在K8s集群中运行的权限<br><br>3. 创建StorageClass.负责建立PVC并调用NFS provisioner进行预定的工作，并让PV与PVC建立管理<br>4. 创建NFS Provisioner,在NFS共享目录下创建挂载点(volume),建立PV并将PV与NFS的挂在点建立关联<br><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="部署Kubernetes"><a href="#部署Kubernetes" class="headerlink" title="部署Kubernetes"></a>部署Kubernetes</h2><ul>
<li><p>kubeadm</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 创建一个Master节点</span><br>$ kubeadm init<br><br><span class="hljs-section"># 将一个Node节点加入当前集群</span><br>$ kubeadm join <span class="xml">&lt;Master节点的IP和端口&gt;</span><br><br><span class="hljs-section"># kubeadm 工作原理</span><br><span class="hljs-bullet">  -</span> kubelet 是Kubernetes项目用来操作Docker等容器运行时的核心组件,除了跟容器运行时交互外，kubelet在配置容器网络、管理容器数据卷时，都需要直接操作宿主机.<br>  &gt; Kubeadm选择一种妥协方案，把kubelet直接运行在宿主机上，然后使用容器部署其他的Kubernetes组件.<br><br><span class="hljs-section"># kubeadm init工作流程</span><br><span class="hljs-bullet">  -</span> 1. Preflight Checks 检查工作, 确定机器可以用来部署Kubernetes<br><span class="hljs-bullet">    -</span> Linux Kernal必须&gt;= 3.10<br><span class="hljs-bullet">    -</span> Linux Cgroups 模块是否可用<br><span class="hljs-bullet">    -</span> 机器的hostname是否标准<br><span class="hljs-bullet">    -</span> 安装的kubeadm和kubelet版本是否匹配<br><span class="hljs-bullet">    -</span> 机器上是不是已经安装Kubernetes二进制文件<br><span class="hljs-bullet">    -</span> Kubernetes工作端口10250/10251/10252端口是否占用<br><span class="hljs-bullet">    -</span> ip, mount Linux指令是否存在<br><span class="hljs-bullet">    -</span> docker是否安装<br><span class="hljs-bullet">  -</span> 2. 生成 kubernetes对外提供服务所需要的各种证书和目录<br><span class="hljs-bullet">    -</span> Kubernetes对外提供服务时，除非专门开启&quot;不安全模式&quot;,否则都要通过HTTPS才能访问kube-apiserver,需要kubernetes集群配置证书文件<br><span class="hljs-bullet">    -</span> /etc/kubernetes/pki (kubeadm为kubernetes项目生成的证书文件)<br><span class="hljs-bullet">  -</span> 3. kubeadm为其他组件生成访问kube-apiserver所需的配置文件<br><span class="hljs-bullet">    -</span> /etc/kubernetes/xxx.cnf<br><span class="hljs-bullet">  -</span> 4. kubeadm为Master组件生成Pod配置文件<br><span class="hljs-bullet">    -</span> kube-apiserver<br><span class="hljs-bullet">    -</span> kube-controller-manager<br><span class="hljs-bullet">    -</span> kube-scheduler<br><span class="hljs-bullet">    -</span> ETCD<br><span class="hljs-code">    &gt; 在Kubernetes中，特殊的容器启动方法&quot;Static Pod&quot;,允许把要部署的Pod的YAML文件放在一个指定的目录里，当kubelet启动时会自动检查次目录，加载所有的PodYAML文件</span><br><span class="hljs-code">  - 5. kubeadm检查localhost:6443/healthz 等待Master组件完全运行起来</span><br><span class="hljs-code">  - 6. kubeadm为集群生成一个bootstrap token.</span><br><span class="hljs-code">    - 剩余的Node节点可以通过此token加入到集群中</span><br><span class="hljs-code">  - 7. 安装插件kube-proxy和DNS</span><br><span class="hljs-code">    - kube-proxy: 集群的服务发现</span><br><span class="hljs-code">    - DNS:</span><br><span class="hljs-code"></span><br><span class="hljs-section"># kubeadm join工作流程</span><br><span class="hljs-bullet">  -</span> bootstrap token<br><span class="hljs-code">    &gt; kubeadm至少需要发起一次&quot;不安全模式&quot;的访问kube-apiserver,从而拿到保存在ConfigMap中的cluster-info(保存了APIServer的授权信息),而bootstrap token扮演的就是这个过程中的安全验证角色</span><br><span class="hljs-code"></span><br><span class="hljs-section"># kubeadm部署参数配置文件(kubeadm.yaml)</span><br>  $ kubeadm init --config kubeadm.yaml<br></code></pre></td></tr></table></figure></li>
<li><p>installing kubeadm, kubelet and kubectl</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">- kubeadm: the command <span class="hljs-keyword">to</span> bootstrap the <span class="hljs-keyword">cluster</span><br>- kubelet: the component that runs <span class="hljs-keyword">on</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">of</span> the machines <span class="hljs-keyword">in</span> your <span class="hljs-keyword">cluster</span> <span class="hljs-keyword">and</span> does things <span class="hljs-keyword">like</span> starting pods <span class="hljs-keyword">and</span> containers.<br>- kubectl: the command <span class="hljs-type">line</span> util <span class="hljs-keyword">to</span> talk <span class="hljs-keyword">to</span> your <span class="hljs-keyword">cluster</span><br></code></pre></td></tr></table></figure></li>
<li><p>container runtimes</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"># common container <span class="hljs-keyword">runtime</span><span class="hljs-variable">s:</span><br>  - containerd<br>  - CRI-O<br>  - Docker<br><br># Cgroup(Control groups) driver<span class="hljs-variable">s:</span><br>  &gt; used <span class="hljs-keyword">to</span> constrain(限制) resources that are allocated <span class="hljs-keyword">to</span> processes.<br>  &gt; Changing the settings such that your container <span class="hljs-keyword">runtime</span> <span class="hljs-built_in">and</span> kubelet use systemd <span class="hljs-keyword">as</span> the cgroup stabilized the <span class="hljs-built_in">system</span>.<br><br># Cgroup V2<br>  &gt; <span class="hljs-keyword">is</span> the <span class="hljs-keyword">next</span> <span class="hljs-keyword">version</span> of cgroup Linux API.<br>  - cleaner <span class="hljs-built_in">and</span> easier <span class="hljs-keyword">to</span> use API<br>  - safe sub-tree delegation <span class="hljs-keyword">to</span> containers<br>  - newer features like Pressure Stall Information<br><br># Migrating <span class="hljs-keyword">to</span> the systemd driver in kubeadm managed clusters<br>  - Docker:<br>    sudo <span class="hljs-built_in">mkdir</span> /etc/docker<br>    <span class="hljs-keyword">cat</span> &lt;&lt;EOF | sudo tee /etc/docker/daemon.json<br>    &#123;<br>      <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>      <span class="hljs-string">&quot;log-driver&quot;</span>: <span class="hljs-string">&quot;json-file&quot;</span>,<br>      <span class="hljs-string">&quot;log-opts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;max-size&quot;</span>: <span class="hljs-string">&quot;100m&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;storage-driver&quot;</span>: <span class="hljs-string">&quot;overlay2&quot;</span><br>    &#125;<br>    EOF<br><br>  - Restart Docker <span class="hljs-built_in">and</span> enable <span class="hljs-keyword">on</span> boo<span class="hljs-variable">t:</span><br>    sudo systemctl enable docker<br>    sudo systemctl daemon-reload<br>    sudo systemctl restart docker<br></code></pre></td></tr></table></figure></li>
<li><p>kubeadm部署</p>
<blockquote>
<p>kubeadm目前欠缺部署高可用Kubernetes集群,ETCD、Master组件都应该是多节点集群</p>
</blockquote>
</li>
</ul>
  <figure class="highlight stata"><table><tr><td class="code"><pre><code class="hljs stata"> # 创建一个Master节点 (--image-repository指定容器镜像地址使用阿里云)<br> ➜ sudo kubeadm init [--image-repository=&#x27;registry.cn-hangzhou.aliyuncs.com/google_containers&#x27;]<br> [init] Using Kubernetes <span class="hljs-keyword">version</span>: v1.22.2<br> [preflight] Running pre-flight checks<br> [preflight] Pulling images required <span class="hljs-keyword">for</span> setting up a Kubernetes <span class="hljs-keyword">cluster</span><br> [preflight] This might take a minute or <span class="hljs-keyword">two</span>, depending <span class="hljs-keyword">on</span> the speed of your internet connection<br> [preflight] You can also perform this action <span class="hljs-keyword">in</span> beforehand using &#x27;kubeadm config images pull&#x27;<br> [certs] Using certificateDir folder <span class="hljs-string">&quot;/etc/kubernetes/pki&quot;</span><br> [certs] Generating <span class="hljs-string">&quot;ca&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;apiserver&quot;</span> certificate and key<br> [certs] apiserver serving cert is signed <span class="hljs-keyword">for</span> DNS names [chyiyaqing-poweredge-r720 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.<span class="hljs-keyword">cluster</span>.<span class="hljs-keyword">local</span>] and IPs [10.96.0.1 192.168.50.57]<br> [certs] Generating <span class="hljs-string">&quot;apiserver-kubelet-client&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;front-proxy-ca&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;front-proxy-client&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;etcd/ca&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;etcd/server&quot;</span> certificate and key<br> [certs] etcd/server serving cert is signed <span class="hljs-keyword">for</span> DNS names [chyiyaqing-poweredge-r720 localhost] and IPs [192.168.50.57 127.0.0.1 ::1]<br> [certs] Generating <span class="hljs-string">&quot;etcd/peer&quot;</span> certificate and key<br> [certs] etcd/peer serving cert is signed <span class="hljs-keyword">for</span> DNS names [chyiyaqing-poweredge-r720 localhost] and IPs [192.168.50.57 127.0.0.1 ::1]<br> [certs] Generating <span class="hljs-string">&quot;etcd/healthcheck-client&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;apiserver-etcd-client&quot;</span> certificate and key<br> [certs] Generating <span class="hljs-string">&quot;sa&quot;</span> key and public key<br> [kubeconfig] Using kubeconfig folder <span class="hljs-string">&quot;/etc/kubernetes&quot;</span><br> [kubeconfig] Writing <span class="hljs-string">&quot;admin.conf&quot;</span> kubeconfig <span class="hljs-keyword">file</span><br> [kubeconfig] Writing <span class="hljs-string">&quot;kubelet.conf&quot;</span> kubeconfig <span class="hljs-keyword">file</span><br> [kubeconfig] Writing <span class="hljs-string">&quot;controller-manager.conf&quot;</span> kubeconfig <span class="hljs-keyword">file</span><br> [kubeconfig] Writing <span class="hljs-string">&quot;scheduler.conf&quot;</span> kubeconfig <span class="hljs-keyword">file</span><br> [kubelet-start] Writing kubelet environment <span class="hljs-keyword">file</span> with flags to <span class="hljs-keyword">file</span> <span class="hljs-string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br> [kubelet-start] Writing kubelet configuration to <span class="hljs-keyword">file</span> <span class="hljs-string">&quot;/var/lib/kubelet/config.yaml&quot;</span><br> [kubelet-start] Starting the kubelet<br> [control-plane] Using manifest folder <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span><br> [control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-apiserver&quot;</span><br> [control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-controller-manager&quot;</span><br> [control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-scheduler&quot;</span><br> [etcd] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-keyword">local</span> etcd <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span><br> [wait-control-plane] Waiting <span class="hljs-keyword">for</span> the kubelet to <span class="hljs-keyword">boot</span> up the control plane <span class="hljs-keyword">as</span> static Pods from directory <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s<br> [apiclient] All control plane components are healthy after 9.004478 seconds<br> [upload-config] Storing the configuration used <span class="hljs-keyword">in</span> ConfigMap <span class="hljs-string">&quot;kubeadm-config&quot;</span> <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;kube-system&quot;</span> Namespace<br> [kubelet] Creating a ConfigMap <span class="hljs-string">&quot;kubelet-config-1.22&quot;</span> <span class="hljs-keyword">in</span> namespace kube-system with the configuration <span class="hljs-keyword">for</span> the kubelets <span class="hljs-keyword">in</span> the <span class="hljs-keyword">cluster</span><br> [upload-certs] Skipping phase. Please see --upload-certs<br> [<span class="hljs-keyword">mark</span>-control-plane] Marking the node chyiyaqing-poweredge-r720 <span class="hljs-keyword">as</span> control-plane <span class="hljs-keyword">by</span> adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]<br> [<span class="hljs-keyword">mark</span>-control-plane] Marking the node chyiyaqing-poweredge-r720 <span class="hljs-keyword">as</span> control-plane <span class="hljs-keyword">by</span> adding the taints [node-role.kubernetes.io/master:NoSchedule]<br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] Using <span class="hljs-keyword">token</span>: z7bgdd.d4lm4cueg5vo9krh<br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] Configuring <span class="hljs-keyword">bootstrap</span> tokens, <span class="hljs-keyword">cluster</span>-info ConfigMap, RBAC Roles<br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] configured RBAC rules to allow Node <span class="hljs-keyword">Bootstrap</span> tokens to get nodes<br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] configured RBAC rules to allow Node <span class="hljs-keyword">Bootstrap</span> tokens to <span class="hljs-keyword">post</span> CSRs <span class="hljs-keyword">in</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">for</span> nodes to get long term certificate credentials<br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node <span class="hljs-keyword">Bootstrap</span> <span class="hljs-keyword">Token</span><br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] configured RBAC rules to allow certificate rotation <span class="hljs-keyword">for</span> all node client certificates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">cluster</span><br> [<span class="hljs-keyword">bootstrap</span>-<span class="hljs-keyword">token</span>] Creating the <span class="hljs-string">&quot;cluster-info&quot;</span> ConfigMap <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;kube-public&quot;</span> namespace<br> [kubelet-finalize] Updating <span class="hljs-string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key<br> [addons] Applied essential addon: CoreDNS<br> [addons] Applied essential addon: kube-proxy<br><br> Your Kubernetes control-plane has initialized successfully!<br><br> To start using your <span class="hljs-keyword">cluster</span>, you need to <span class="hljs-keyword">run</span> the following <span class="hljs-keyword">as</span> a regular user:<br><br>   <span class="hljs-keyword">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>   sudo cp -i /etc/kubernetes/admin.<span class="hljs-keyword">conf</span> <span class="hljs-variable">$HOME</span>/.kube/config<br>   sudo chown $(id -<span class="hljs-keyword">u</span>):$(id -<span class="hljs-keyword">g</span>) <span class="hljs-variable">$HOME</span>/.kube/config<br><br> Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can <span class="hljs-keyword">run</span>:<br><br>   export KUBECONFIG=/etc/kubernetes/admin.<span class="hljs-keyword">conf</span><br><br> You should now deploy a pod network to the <span class="hljs-keyword">cluster</span>.<br> <span class="hljs-keyword">Run</span> <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with <span class="hljs-keyword">one</span> of the options listed at:<br>   https:<span class="hljs-comment">//kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><br> Then you can join any number of worker nodes <span class="hljs-keyword">by</span> running the following <span class="hljs-keyword">on</span> each <span class="hljs-keyword">as</span> root:<br><br> kubeadm join 192.168.50.57:6443 --<span class="hljs-keyword">token</span> z7bgdd.d4lm4cueg5vo9krh \<br>--discovery-<span class="hljs-keyword">token</span>-<span class="hljs-keyword">ca</span>-cert-hash sha256:f56091fb52dddc01e552ad110b3479015f4bcdaba5fadec6d76eadab1b3ee48b<br><br> # 将一个Node节点加入当前集群<br> $ kubeadm join &lt;Master节点的IP和端口&gt;<br><br> # 获取kubeadm临时生成的<span class="hljs-keyword">token</span><br> ➜ kubeadm <span class="hljs-keyword">token</span> <span class="hljs-keyword">list</span><br> <span class="hljs-keyword">TOKEN</span>                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS<br> z1ktsy.k2dzz0m17d42nsem   23h         2021-10-15T05:26:51Z   authentication,signing   The default <span class="hljs-keyword">bootstrap</span> <span class="hljs-keyword">token</span> generated <span class="hljs-keyword">by</span> &#x27;kubeadm init&#x27;.   system:bootstrappers:kubeadm:default-node-<span class="hljs-keyword">token</span><br><br> # 查看nodes<br> ➜ kubectl get nodes<br> NAME                        STATUS   ROLES                  AGE     <span class="hljs-keyword">VERSION</span><br> chyiyaqing-poweredge-r720   Ready    control-plane,master   4m49s   v1.22.2<br><br> # 查看Pod运行情况<br> ➜ kubectl get pod -A<br> NAMESPACE     NAME                                                READY   STATUS              RESTARTS   AGE<br> kube-system   coredns-7d89d9b6b8-cch8p                            0/1     ContainerCreating   0          5m10s<br> kube-system   coredns-7d89d9b6b8-vkzw7                            0/1     ContainerCreating   0          5m10s<br> kube-system   etcd-chyiyaqing-poweredge-r720                      1/1     Running             0          5m15s<br> kube-system   kube-apiserver-chyiyaqing-poweredge-r720            1/1     Running             0          5m15s<br> kube-system   kube-controller-manager-chyiyaqing-poweredge-r720   1/1     Running             0          5m17s<br> kube-system   kube-proxy-smnf2                                    1/1     Running             0          5m10s<br> kube-system   kube-scheduler-chyiyaqing-poweredge-r720            1/1     Running             0          5m14s<br><br> # kubectl <span class="hljs-keyword">describe</span> 查看节点详细信息、状态和事件Event<br> ➜ kubectl <span class="hljs-keyword">describe</span> pod coredns-7d89d9b6b8-cch8p -<span class="hljs-keyword">n</span> kube-system<br> Name:                 coredns-7d89d9b6b8-cch8p<br> Namespace:            kube-system<br> Priority:             2000000000<br> Priority <span class="hljs-keyword">Class</span> Name:  system-<span class="hljs-keyword">cluster</span>-critical<br> Node:                 chyiyaqing-poweredge-r720/192.168.50.57<br> Start Time:           Thu, 14 Oct 2021 13:27:02 +0800<br> Labels:               k8s-<span class="hljs-keyword">app</span>=kube-dns<br>                       pod-template-hash=7d89d9b6b8<br> Annotations:          &lt;none&gt;<br> Status:               Pending<br> IP:<br> IPs:                  &lt;none&gt;<br> Controlled <span class="hljs-keyword">By</span>:        ReplicaSet/coredns-7d89d9b6b8<br> Containers:<br>   coredns:<br>     Container ID:<br>     Image:         registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4<br>     Image ID:<br>     Ports:         53/UDP, 53/TCP, 9153/TCP<br>     Host Ports:    0/UDP, 0/TCP, 0/TCP<br>     <span class="hljs-keyword">Args</span>:<br>       -<span class="hljs-keyword">conf</span><br>       /etc/coredns/Corefile<br>     State:          Waiting<br>       Reason:       ContainerCreating<br>     Ready:          False<br>     Restart <span class="hljs-keyword">Count</span>:  0<br>     Limits:<br>       <span class="hljs-keyword">memory</span>:  170Mi<br>     Requests:<br>       cpu:        100m<br>       <span class="hljs-keyword">memory</span>:     70Mi<br>     Liveness:     http-get http:<span class="hljs-comment">//:8080/health delay=60s timeout=5s period=10s #success=1 #failure=5</span><br>     Readiness:    http-get http:<span class="hljs-comment">//:8181/ready delay=0s timeout=1s period=10s #success=1 #failure=3</span><br>     Environment:  &lt;none&gt;<br>     Mounts:<br>       /etc/coredns from config-volume (ro)<br>       /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">run</span>/secrets/kubernetes.io/serviceaccount from kube-api-access-qdx6w (ro)<br> Conditions:<br>   <span class="hljs-keyword">Type</span>              Status<br>   Initialized       True<br>   Ready             False<br>   ContainersReady   False<br>   PodScheduled      True<br> Volumes:<br>   config-volume:<br>     <span class="hljs-keyword">Type</span>:      ConfigMap (a volume populated <span class="hljs-keyword">by</span> a ConfigMap)<br>     Name:      coredns<br>     Optional:  false<br>   kube-api-access-qdx6w:<br>     <span class="hljs-keyword">Type</span>:                    Projected (a volume that contains injected data from multiple sources)<br>     TokenExpirationSeconds:  3607<br>     ConfigMapName:           kube-root-<span class="hljs-keyword">ca</span>.crt<br>     ConfigMapOptional:       &lt;nil&gt;<br>     DownwardAPI:             true<br> QoS <span class="hljs-keyword">Class</span>:                   Burstable<br> Node-Selectors:              kubernetes.io/os=linux<br> Tolerations:                 CriticalAddonsOnly op=Exists<br>                              node-role.kubernetes.io/control-plane:NoSchedule<br>                              node-role.kubernetes.io/master:NoSchedule<br>                              node.kubernetes.io/not-ready:NoExecute op=Exists <span class="hljs-keyword">for</span> 300s<br>                              node.kubernetes.io/unreachable:NoExecute op=Exists <span class="hljs-keyword">for</span> 300s<br> Events:<br>   <span class="hljs-keyword">Type</span>     Reason                  Age                  From               Message<br>   ----     ------                  ----                 ----               -------<br>   Warning  FailedScheduling        6m12s                default-scheduler  0/1 nodes are available: 1 node(s) had taint &#123;node.kubernetes.io/not-ready: &#125;, that the pod didn&#x27;t tolerate.<br>   Normal   Scheduled               6m7s                 default-scheduler  Successfully assigned kube-system/coredns-7d89d9b6b8-cch8p to chyiyaqing-poweredge-r720<br>   Warning  FailedCreatePodSandBox  6m6s                 kubelet            Failed to create pod sandbox: rpc <span class="hljs-keyword">error</span>: code = Unknown <span class="hljs-keyword">desc</span> = [failed to <span class="hljs-keyword">set</span> up sandbox container <span class="hljs-string">&quot;d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span> network <span class="hljs-keyword">for</span> pod <span class="hljs-string">&quot;coredns-7d89d9b6b8-cch8p&quot;</span>: networkPlugin cni failed to <span class="hljs-keyword">set</span> up pod <span class="hljs-string">&quot;coredns-7d89d9b6b8-cch8p_kube-system&quot;</span> network: unable to allocate IP address: <span class="hljs-keyword">Post</span> <span class="hljs-string">&quot;http://127.0.0.1:6784/ip/d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span>: dial tcp 127.0.0.1:6784: connect: connection refused, failed to clean up sandbox container <span class="hljs-string">&quot;d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span> network <span class="hljs-keyword">for</span> pod <span class="hljs-string">&quot;coredns-7d89d9b6b8-cch8p&quot;</span>: networkPlugin cni failed to teardown pod <span class="hljs-string">&quot;coredns-7d89d9b6b8-cch8p_kube-system&quot;</span> network: Delete <span class="hljs-string">&quot;http://127.0.0.1:6784/ip/d165e9f1f627d4a9c1f0eac4492ae7d1db6a7a1fe2a92dd435380cac57b35011&quot;</span>: dial tcp 127.0.0.1:6784: connect: connection refused]<br>   Normal   SandboxChanged          63s (x25 over 6m5s)  kubelet            Pod sandbox changed, it will be killed and re-created.<br><br> # 通过Taint/Toleration 调整Master执行Pod的策略 (由于本地搭建环境kubeamd只有一个Master节点)<br> &gt; 默认情况下Master节点是不允许运行用户Pod的, Kubernetes依赖Taint/Toleration机制<br>   - 为节点打上污点(Taint)<br>     &gt; $ kubectl taint nodes &lt;node-1&gt; foo=bar:NoSchedule<br>   - 删除Taint<br>     ➜ kubectl taint nodes --all node-role.kubernetes.io/master-<br>     node/chyiyaqing-poweredge-r720 untainted<br> # 安装网络插件<br>     ➜ kubectl apply -f <span class="hljs-string">&quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot;</span><br><br>     serviceaccount/weave-<span class="hljs-keyword">net</span> created<br>     clusterrole.rbac.authorization.k8s.io/weave-<span class="hljs-keyword">net</span> created<br>     clusterrolebinding.rbac.authorization.k8s.io/weave-<span class="hljs-keyword">net</span> created<br>     role.rbac.authorization.k8s.io/weave-<span class="hljs-keyword">net</span> created<br>     rolebinding.rbac.authorization.k8s.io/weave-<span class="hljs-keyword">net</span> created<br>     daemonset.apps/weave-<span class="hljs-keyword">net</span> created<br></code></pre></td></tr></table></figure>
<ul>
<li><p>kubernetes CNI (Container Network Interface)<br><img src="/misc/images/kubernetes-cni-architecture.png" alt="CNI plugin architecture"></p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">&gt; Kubernetes supports CNI plugins <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> communication <span class="hljs-keyword">between</span> pods.<br>&gt; kubeadm <span class="hljs-keyword">does</span> <span class="hljs-keyword">not</span> support kubenet. you should use a CNI plugin<br><br><span class="hljs-comment"># Kubernetes impose(施加) following rules for network communication:</span><br>  - All containers can communicate <span class="hljs-keyword">with</span> all other containers <span class="hljs-keyword">without</span> NAT<br>  - All nodes can communicate <span class="hljs-keyword">with</span> all container (<span class="hljs-keyword">and</span> vice-versa) <span class="hljs-keyword">without</span> NAT<br>  - The IP <span class="hljs-keyword">that</span> a container sees itself <span class="hljs-keyword">as</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">the</span> same IP <span class="hljs-keyword">that</span> others see <span class="hljs-keyword">it</span> <span class="hljs-keyword">as</span>.<br><br>CNI plugins generally use kube-proxy <span class="hljs-keyword">or</span> directory iptables <span class="hljs-keyword">for</span> routing. However, Cilium <span class="hljs-keyword">is</span> based <span class="hljs-keyword">on</span> BPF <span class="hljs-keyword">and</span> XDP <span class="hljs-keyword">to</span> provide a faster <span class="hljs-keyword">and</span> more scalable option.<br><br><span class="hljs-comment"># Plugins:</span><br>  - Flannel:<br>    - provides VXLAN tunneling solution 隧道解决方案<br>    - configuration <span class="hljs-keyword">and</span> management are very simple<br>    - <span class="hljs-keyword">does</span> <span class="hljs-keyword">not</span> support Network Policies<br>  - Calico:<br>    - default choice <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> most <span class="hljs-keyword">of</span> kubernetes platform (kubespary, docker enterprise)<br>    - uses BGP <span class="hljs-keyword">and</span> Bird, a daemon called Felix configures routes <span class="hljs-keyword">on</span> Bird<br>    - supports IP-IP encapsulation <span class="hljs-keyword">if</span> BGP cannot be used.<br>    - supports Network Policies<br>    - uses iptables <span class="hljs-keyword">for</span> routing <span class="hljs-keyword">but</span> <span class="hljs-keyword">it</span> can be configured <span class="hljs-keyword">to</span> use kube-proxy&#x27;s IPVS mode.<br>  - Weave:<br>    - Provides VXLAN tunneling solution<br>    - all <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> nodes are connected <span class="hljs-keyword">as</span> mesh which allows <span class="hljs-keyword">it</span> <span class="hljs-keyword">to</span> <span class="hljs-built_in">run</span> <span class="hljs-keyword">on</span> paritially connected networks.<br>    - stores configuration files <span class="hljs-keyword">on</span> pods <span class="hljs-keyword">instead of</span> kubernetes CRDs <span class="hljs-keyword">or</span> etcd<br>    - has an encryption library<br>    - supports Network Policies<br>  - Cilium<br>    - Linux kernel must be <span class="hljs-keyword">at</span> least <span class="hljs-number">4.9</span><br>  - kube-router:<br>    -<br></code></pre></td></tr></table></figure>
<ul>
<li>Terminology<ul>
<li>kube-proxy<ul>
<li>Kube-proxy tree mods: 三个模组<ul>
<li>userspace:<br><img src="/misc/images/kube-proxy-userspace-mode.png" alt="kube-proxy Userspace mode"><figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">&gt; It adds rules <span class="hljs-keyword">to</span> iptables so <span class="hljs-keyword">that</span> all communication redirects <span class="hljs-keyword">through</span> proxy server. It <span class="hljs-keyword">is</span> no longer used <span class="hljs-keyword">since</span> <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> much slower compared <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> other modes.<br></code></pre></td></tr></table></figure></li>
<li>Iptables:<br><img src="/misc/images/kube-proxy-iptables-mode.png" alt="kube-proxy iptables mode"><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; This mode adds rules <span class="hljs-keyword">to</span> iptables so that iptables redirects straight <span class="hljs-keyword">to</span> pods <span class="hljs-keyword">without</span> <span class="hljs-keyword">using</span> a proxy <span class="hljs-keyword">server</span>. It <span class="hljs-keyword">is</span> the <span class="hljs-keyword">default</span> mode <span class="hljs-keyword">of</span> kube-proxy.<br></code></pre></td></tr></table></figure></li>
<li>IPVS:<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">IPVS (IP Virtual <span class="hljs-keyword">Server</span>) <span class="hljs-keyword">is</span> layer<span class="hljs-number">-4</span> <span class="hljs-keyword">load</span> balancer inside the Linux kernel. It <span class="hljs-keyword">is</span> built <span class="hljs-keyword">on</span> top <span class="hljs-keyword">of</span> netfilter <span class="hljs-keyword">like</span> iptables. It utilizes hash <span class="hljs-keyword">table</span> <span class="hljs-keyword">instead</span> <span class="hljs-keyword">of</span> chain <span class="hljs-keyword">as</span> <span class="hljs-keyword">in</span> iptables.<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>Network policy<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">Kubernetes specification <span class="hljs-keyword">that</span> can be used <span class="hljs-keyword">to</span> control traffic <span class="hljs-keyword">between</span> pods.<br></code></pre></td></tr></table></figure></li>
<li>Overlay Networks<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">An overlay network abstracts <span class="hljs-keyword">a</span> physical (underlay) network <span class="hljs-built_in">to</span> <span class="hljs-built_in">create</span> virtual network. It provides simpler interface <span class="hljs-keyword">by</span> hiding complexities <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> underlay.<br></code></pre></td></tr></table></figure></li>
<li>VXLAN<br><img src="/misc/images/vxlan-architecture.png" alt="VXLAN architecture"><figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">VXLAN <span class="hljs-keyword">is</span> a network tunneling(隧道) protocol <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> Linux Kernel. Network tunneling means hiding protocol (VXLAN) within another protocol (TCP/IP).VXLAN tuneels layer <span class="hljs-number">2</span> frames inside <span class="hljs-keyword">of</span> Layer <span class="hljs-number">4</span> UDP datagrams.<br><br><span class="hljs-comment"># Linux network structure in VXLAN:</span><br>  - veth: Virtual ethernet pair, <span class="hljs-keyword">it</span> connects network namespaces<br>  - bridge: It <span class="hljs-keyword">is</span> used <span class="hljs-keyword">to</span> connect ethernet pairs <span class="hljs-keyword">in</span> Linux<br>  - vtep: VXLAN tunnel endpoint, <span class="hljs-keyword">it</span>&#x27;s entry/<span class="hljs-keyword">exit</span> point <span class="hljs-keyword">for</span> VXLAN tunnels<br></code></pre></td></tr></table></figure></li>
<li>BGP(Border gateway protocol) - 边界网关协议</li>
<li>BPF(Berkeley Packet Filter) - 伯克利数据包过滤器</li>
<li>XDP (eXpress Data Path)<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">XDP <span class="hljs-keyword">is</span> a data <span class="hljs-type">path</span> recently added <span class="hljs-keyword">to</span> Linux kernel. It relies <span class="hljs-keyword">on</span> eBPF <span class="hljs-keyword">to</span> <span class="hljs-keyword">perform</span> fast packet processing.<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>kubernetes安装Metrics Server</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">&gt; Metrics Server是集群中资源使用情况的聚合器, Metrics Server从kubelets收集资源指标，并通过Metrics API将他们暴露在Kubernetes apiserver中,以供Horizontal Pod Autoscaler和Vertical Pod Autoscaler使用.<br>&gt; Metrics Server不适用与非自动缩放目的，不要使用他将指标转发到监控解决方案，或作为监控解决方案指标的来源,这种情况可以使用kuberlet<span class="hljs-regexp">/metrics/</span>resource 端点收集指标<br><br><span class="hljs-comment"># Installation</span><br>- kubectl apply -f https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/kubernetes-sigs/m</span>etrics-server<span class="hljs-regexp">/releases/</span>latest<span class="hljs-regexp">/download/</span>components.yaml<br><br><span class="hljs-comment"># Fix: (cannot validate certificate, doesn&#x27;t contain any IP SANs)</span><br>  - $ kubectl edit deployment metrics-server -n kube-system<br>    &gt; modifying the metrics-server deployment template, and adding the argument - --kubelet-insecure-tls to the container args<br></code></pre></td></tr></table></figure></li>
<li><p>Kubernetes集群安装Dashboard</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Dashboard(Web界面) 可视化插件</span><br>  ➜ wget kubectl apply -f https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/kubernetes/</span>dashboard<span class="hljs-regexp">/v2.2.0/</span>aio<span class="hljs-regexp">/deploy/</span>recommended.yaml<br>  namespace/kubernetes-dashboard created<br>  serviceaccount/kubernetes-dashboard created<br>  service/kubernetes-dashboard created<br>  secret/kubernetes-dashboard-certs created<br>  secret/kubernetes-dashboard-csrf created<br>  secret/kubernetes-dashboard-key-holder created<br>  configmap/kubernetes-dashboard-settings created<br>  role.rbac.authorization.k8s.io/kubernetes-dashboard created<br>  clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created<br>  rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created<br>  clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created<br>  deployment.apps/kubernetes-dashboard created<br>  service/dashboard-metrics-scraper created<br>  Warning: spec.template.metadata.annotations[seccomp.security.alpha.kubernetes.io/pod]: deprecated since v1.<span class="hljs-number">19</span>; use the <span class="hljs-string">&quot;seccompProfile&quot;</span> field instead<br>  deployment.apps/dashboard-metrics-scraper created<br><br><span class="hljs-comment"># 查看Dashboard对应的Pod状态</span><br>➜ kubectl get pods -n kubernetes-dashboard<br>NAME                                         READY   STATUS    RESTARTS   AGE<br>dashboard-metrics-scraper-<span class="hljs-number">856586</span>f554-w4vvw   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>m19s<br>kubernetes-dashboard-<span class="hljs-number">78</span>c79f97b4-l8nmb        <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>m19s<br><br><span class="hljs-comment"># 命令行代理 kubectl 访问DashBoard</span><br>$ kubectl proxy --address=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span> --port=<span class="hljs-number">8001</span> --accept-hosts=<span class="hljs-string">&#x27;.*&#x27;</span><br><br><span class="hljs-comment"># 从集群外部访问Dashboard 需要使用Ingress</span><br></code></pre></td></tr></table></figure></li>
<li><p>Kubernetes部署存储插件</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; 容器持久化存储,用来保存容器存储状态,存储插件会在容器中挂在一个基于网络或者其他机制的远程数据卷. 使得在容器里创建的文件，实际上保存在远程存储服务器上,<br><br># Kubernetes 存储插件 - Rook<br>  &gt; Rook项目是一个基于Ceph的Kubernetes存储插件，不同于Ceph的简单封装，Rook加入了对平扩展、迁移、灾难备份、监控等大量的企业级功能.<br>  - 部署基于Rook持久化存储集群以容器方式运行<br>    $ git clone <span class="hljs-comment">--single-branch --branch release-1.7 https://github.com/rook/rook.git</span><br>    cd rook/<span class="hljs-keyword">cluster</span>/examples/kubernetes/ceph<br>    kubectl <span class="hljs-keyword">create</span> -f crds.yaml -f common.yaml -f <span class="hljs-keyword">operator</span>.yaml<br>    kubectl <span class="hljs-keyword">create</span> -f <span class="hljs-keyword">cluster</span>.yaml<br><br>  - 查看Rook部署的Namespace<br>    ➜ k <span class="hljs-keyword">get</span> pods -n rook-ceph<br>    <span class="hljs-type">NAME</span>                                           READY   STATUS    RESTARTS   AGE<br>    csi-cephfsplugin<span class="hljs-number">-7</span>l9xb                         <span class="hljs-number">3</span>/<span class="hljs-number">3</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">15</span>m<br>    csi-cephfsplugin-provisioner<span class="hljs-number">-689686</span>b44-qpt5q   <span class="hljs-number">6</span>/<span class="hljs-number">6</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">15</span>m<br>    csi-rbdplugin-provisioner<span class="hljs-number">-5775</span>fb866b<span class="hljs-number">-25224</span>     <span class="hljs-number">6</span>/<span class="hljs-number">6</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">15</span>m<br>    csi-rbdplugin-vvq94                            <span class="hljs-number">3</span>/<span class="hljs-number">3</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">15</span>m<br>    rook-ceph-<span class="hljs-keyword">operator</span><span class="hljs-number">-7</span>bdb744878-zz2fm            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">24</span>m<br><br>  &gt; Kubernetes项目创建的所有Pod就能够通过Persistent Volume (PV) 和 Persistent Volume Claim (PVC) 的方式，在容器里挂载由Ceph提供的数据卷<br><br>  - <span class="hljs-keyword">Storage</span><br>    - Block: <span class="hljs-keyword">Create</span> block <span class="hljs-keyword">storage</span> <span class="hljs-keyword">to</span> be consumed <span class="hljs-keyword">by</span> a pod (RWO)<br>      &gt; <span class="hljs-keyword">Before</span> Rook can provision <span class="hljs-keyword">storage</span>, a **StorageClass** <span class="hljs-keyword">and</span> **CephBlockPool** need <span class="hljs-keyword">to</span> be created.<br>    - Shared FileSystem: <span class="hljs-keyword">Create</span> a filesystem <span class="hljs-keyword">to</span> be shared across multiple pods (RWX)<br>    - <span class="hljs-keyword">Object</span>: <span class="hljs-keyword">Create</span> an <span class="hljs-keyword">object</span> store that <span class="hljs-keyword">is</span> accessible inside <span class="hljs-keyword">or</span> outside the Kubernetes <span class="hljs-keyword">cluster</span><br></code></pre></td></tr></table></figure></li>
<li><p>HELM</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; Helm is the package manager for Kubernetes</span><br><br><span class="hljs-section"># Helm 三大概念</span><br><span class="hljs-bullet">  -</span> Chart: helm包<br><span class="hljs-code">    &gt; 包含Kubernetes集群内部运行应用程序,工具或服务所需的所有资源定义</span><br><span class="hljs-code">  - Repository: 仓库</span><br><span class="hljs-code">    &gt; 存放和共享charts</span><br><span class="hljs-code">  - Release:</span><br><span class="hljs-code">    &gt; 运行在Kubernetes集群中的chart实例</span><br><span class="hljs-code"></span><br><span class="hljs-section"># helm search - 查找Charts</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Kubernetes-IN-Docker-Kind"><a href="#Kubernetes-IN-Docker-Kind" class="headerlink" title="Kubernetes IN Docker (Kind)"></a>Kubernetes IN Docker (Kind)</h2><blockquote>
<p>local clusters for testing Kubernetes</p>
</blockquote>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><code class="hljs n1ql"># Installation<br>  $ go install sigs.k8s.io/kind@v0.11.1<br><br># Creating a Cluster<br>  $ kind <span class="hljs-keyword">create</span> <span class="hljs-keyword">cluster</span> # Default <span class="hljs-keyword">cluster</span> context name <span class="hljs-keyword">is</span> <span class="hljs-symbol">`kind`</span><br>  Creating <span class="hljs-keyword">cluster</span> <span class="hljs-string">&quot;kind&quot;</span> ...<br>   ✓ Ensuring node image (kindest/node:v1<span class="hljs-number">.21</span><span class="hljs-number">.1</span>) 🖼<br>   ✓ Preparing nodes 📦<br>   ✓ Writing configuration 📜<br>   ✓ Starting control-plane 🕹️<br>   ✓ Installing CNI 🔌<br>   ✓ Installing StorageClass 💾<br>  <span class="hljs-keyword">Set</span> kubectl context <span class="hljs-keyword">to</span> <span class="hljs-string">&quot;kind-kind&quot;</span><br>  You can now <span class="hljs-keyword">use</span> your <span class="hljs-keyword">cluster</span> <span class="hljs-keyword">with</span>:<br><br>  kubectl <span class="hljs-keyword">cluster</span>-info --context kind-kind<br><br>  <span class="hljs-keyword">Not</span> sure what <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span> next? 😅  Check out https://kind.sigs.k8s.io/docs/<span class="hljs-keyword">user</span>/quick-<span class="hljs-keyword">start</span>/<br><br>  ❯ kubectl <span class="hljs-keyword">cluster</span>-info --context kind-kind  # interact <span class="hljs-keyword">with</span> a specific <span class="hljs-keyword">cluster</span><br>  Kubernetes control plane <span class="hljs-keyword">is</span> running at https://<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">45967</span><br>  CoreDNS <span class="hljs-keyword">is</span> running at https://<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">45967</span>/api/v1/namespaces/kube-<span class="hljs-keyword">system</span>/services/kube-dns:dns/proxy<br><br>  <span class="hljs-keyword">To</span> further debug <span class="hljs-keyword">and</span> diagnose <span class="hljs-keyword">cluster</span> problems, <span class="hljs-keyword">use</span> <span class="hljs-string">&#x27;kubectl cluster-info dump&#x27;</span>.<br><br>  ❯ kind get clusters  # list kind clusters<br>  kind<br></code></pre></td></tr></table></figure>

<h2 id="容器化应用"><a href="#容器化应用" class="headerlink" title="容器化应用"></a>容器化应用</h2><ul>
<li>Kubernetes API 对象定义<figure class="highlight gauss"><table><tr><td class="code"><pre><code class="hljs gauss">&gt; Kubernetes 不推荐使用命令行方式直接运行容器(kubectl <span class="hljs-keyword">run</span>), 而是希望使用YAML方式(kubectl <span class="hljs-keyword">create</span> -f yaml)<br>&gt; 使用一个API对象(Deployment)管理另一种API对象(Pod)的方式叫做“控制器”模式 (Controller pattern)<br>&gt; Pod 是Kubernetes世界里的“应用”,而一个应用可以由多个容器组成.<br><br>- metadata: API对象的元数据<br>- spec: 描述它要表达的功能<br>- labels: 一组<span class="hljs-built_in">key</span>-value格式的标签<br>- spec.selector.matchLabels: Label Selector 标签选择器<br>- annotations: 一组<span class="hljs-built_in">key</span>-value格式的内部信息(kubernetes组件本身感兴趣, 在Kubernetes运行过程中被自动加载到API对象上)<br><br>➜ k get pods -l app=nginx<br>NAME                                READY   STATUS    RESTARTS   AGE<br>nginx-deployment<span class="hljs-number">-5</span>d59d67564<span class="hljs-number">-8</span>qtq5   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">11</span>m<br>nginx-deployment<span class="hljs-number">-5</span>d59d67564-xx29g   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">11</span>m<br><br><span class="hljs-meta"># 使用kubectl apply 统一进行kubernetes对象的创建和更新操作</span><br>$ k apply -f nginx-deployment.yaml<br>$ k <span class="hljs-built_in">exec</span> -it nginx-deployment<span class="hljs-number">-748</span>c6fff66-plhwq -- /bin/bash<br>$ k <span class="hljs-keyword">delete</span> -f nginx-deployment.yaml<br><br><span class="hljs-meta"># emptyDir</span><br>  &gt; 不显式声明宿主主机目录的<span class="hljs-built_in">Volume</span>,Kubernetes会在宿主主机上创建一个临时目录,这个目录会被绑定到容器所声明的<span class="hljs-built_in">Volume</span>目录上(Kubernetes的emptyDir类型，只是把kubernetes创建的临时目录作为<span class="hljs-built_in">Volume</span>宿主机目录，交给Docker)<br><br><span class="hljs-meta"># hostPath</span><br>  &gt; 显式的<span class="hljs-built_in">Volume</span>定义<br>  ...<br>    volumes:<br>      - name: nginx-vol<br>        hostPath:<br>          path: <span class="hljs-string">&quot; /var/data&quot;</span><br></code></pre></td></tr></table></figure></li>
<li>Pod实现原理<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">Pod是Kuberntes项目的原子调度单位,kubernetes项目的调度器是统一按照Pod而非容器的资源需求进行计算</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Docker容器的本质<span class="hljs-string">&quot;Namespace隔离，Cgroups限制，rootfs文件系统&quot;</span></span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Pod是Kubernetes里院子调度单位，Kubernetes项目的调度器是统一按照Pod而非容器的资源需求进行计算.</span><br><br># 展示系统中正在运行的进程树状结构<br>$ pstree - display a tree of process<br><br><span class="hljs-meta">&gt;</span> <span class="javascript">容器的<span class="hljs-string">&quot;单进程模型&quot;</span>并不是指容器里只能运行<span class="hljs-string">&quot;一个&quot;</span>进程,而是指容器没有管理多个进程的能力,</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Pod在Kubernetes项目里“容器设计模型”</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Pod其实是一组共享了某些资源的容器;Pod里的所有容器共享的是一个Network Namespace,并且可以声明共享一个Volume.</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Pod实际上扮演传统基础设施里<span class="hljs-string">&quot;虚拟机&quot;</span>的角色，而容器则是这个虚拟机里运行的用户程序</span><br></code></pre></td></tr></table></figure>
<ul>
<li>Pod Infra容器<br><img src="/misc/images/kubernetes-pod-infra.png" alt="Pod Infra"><figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">Kubernetes项目中Pod实现使用一个中间容器，这个容器叫做Infra容器,在Pod中,Infra容器都是第一个被创建的容器</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Infra 容器使用k8s.gcr.io/pause镜像使用汇编语言编写，永远处于<span class="hljs-string">&quot;暂停&quot;</span>状态的容器,解压后大小只有<span class="hljs-number">100</span>～200KB</span><br><span class="hljs-meta">&gt;</span> <span class="javascript">Pod声明周期只跟Infra容器一致，而与容器A和B无关</span><br></code></pre></td></tr></table></figure></li>
<li>容器设计模式<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> sidecar</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 我们可以在一个Pod中启动一个辅助容器，来完成一些独立主容器之外的工作</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Istio - 微服务治理项目</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 使用sidecar容器完成微服务治理的原理</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>深入解析Pod对象(-): 基本概念<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; Kubernetes 项目的最小编排单元 &quot;Pod&quot;</span><br><span class="hljs-quote">&gt; Pod扮演的是传统部署环境里&quot;虚拟机&quot;的角色</span><br><br><span class="hljs-section"># Pod属性</span><br><span class="hljs-bullet">  -</span> 调度、网络、存储、安全<br><span class="hljs-bullet">  -</span> NodeSelector (将Pod与Node进行绑定的字段)<br><span class="hljs-bullet">  -</span> NodeName: (调度的结果)<br><span class="hljs-bullet">  -</span> 凡是Pod中的容器要共享宿主机的Namespace,一定是Pod级别的定义<br><br><span class="hljs-section"># Container属性</span><br><span class="hljs-bullet">  -</span> ImagePullPolicy: 镜像拉取策略<br><br><span class="hljs-section"># Pod对象在Kubernetes中的声明周期</span><br><span class="hljs-bullet">  -</span> phase:<br><span class="hljs-bullet">    -</span> Pending: Pod的YAML文件已经提交Kubernetes, API对象已经被创建保存在Etcd当中<br><span class="hljs-bullet">    -</span> Running: Pod已经调度成功,与具体节点绑定<br><span class="hljs-bullet">    -</span> Succeeded: Pod中所有容器都正常运行完毕，并且已经退出<br><span class="hljs-bullet">    -</span> Failed: Pod中至少有一个容器以不正常的状态退出<br><span class="hljs-bullet">    -</span> Unknown: Pod状态不能持续被kubelet上报给kube-apiserver<br><span class="hljs-bullet">  -</span> status.condation<br><span class="hljs-bullet">    -</span> PodScheduled:<br><span class="hljs-bullet">    -</span> Initialized<br><span class="hljs-bullet">    -</span> Ready<br><span class="hljs-bullet">    -</span> ContainersReady<br><span class="hljs-section"># Volume</span><br><span class="hljs-bullet">  -</span> Projected Volume<br><span class="hljs-bullet">    -</span> Secret: 加密数据存放在Etcd,通过Pod容器挂载Volume方式访问Secret,Secret对象存储数据经过base64转码<br><span class="hljs-bullet">    -</span> ConfigMap: 保存不需要加密、应用所需的配置信息<br><span class="hljs-bullet">    -</span> Downward API: 直接获取Pod API 对象本身的信息<br><span class="hljs-bullet">      -</span> spec.nodeName: 宿主机名字<br><span class="hljs-bullet">      -</span> status.hostIP: 宿主机IP<br><span class="hljs-bullet">      -</span> metadata.name: Pod名字<br><span class="hljs-bullet">      -</span> metadata.namespace: Pod的Namespace<br><span class="hljs-bullet">      -</span> status.podIP: Pod的IP<br><span class="hljs-bullet">      -</span> spec.serviceAccountName:<br><span class="hljs-bullet">      -</span> metadata.uid<br><span class="hljs-bullet">      -</span> metadata.labels<br><span class="hljs-bullet">      -</span> metadata.annotations<br><span class="hljs-bullet">      -</span> metadata.labels<br><span class="hljs-bullet">      -</span> metadata.annotations<br><span class="hljs-bullet">    -</span> ServiceAccountToken<br><span class="hljs-code">      &gt; Service Account对象是Kubernetes系统内置的一种&quot;服务账户&quot;,是Kubernetes进行权限分配的对象</span><br><span class="hljs-code"></span><br>环境变量获取信息的方式不具备自动更新的能力,建议使用Volume文件的方式获取这些信息<br>这种把Kubernetes客户端以容器的方式运行在集群里，然后使用default Service Account自动授权的方式，称作&quot;InClusterConfig&quot;，Kubernetes API编程的授权方式<br><br><span class="hljs-section"># 容器健康检查和恢复机制</span><br><span class="hljs-bullet">  -</span> Probe(探针)<br><br>  &gt; Kubernetes中并没有Docker的Stop,虽然是Restart,<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Kubernetes-技能图谱"><a href="#Kubernetes-技能图谱" class="headerlink" title="Kubernetes 技能图谱"></a>Kubernetes 技能图谱</h2><p><img src="/misc/images/kubernetes-rollmap.jpg" alt="Kubernetes 技能图谱"></p>
<h2 id="Awesome-Tools"><a href="#Awesome-Tools" class="headerlink" title="Awesome Tools"></a>Awesome Tools</h2><ul>
<li><a href="https://github.com/ahmetb/kubectx">kubectx + kubens: Power tools for kubectl</a></li>
<li><a href="https://github.com/ktr0731/evans">evans Universal gRPC client</a></li>
</ul>
<h3 id="WarmUp"><a href="#WarmUp" class="headerlink" title="WarmUp"></a>WarmUp</h3><ul>
<li>一旦要追求项目的普适性，那就一定要从顶层开始做好设计</li>
</ul>
<h3 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语"></a>专业术语</h3><ul>
<li>PaaS (Platform as a Service): 平台即服务</li>
<li>BaaS (Backend as a Service): 后端即服务</li>
<li>GA (General Availability): 一般可用性</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/overview/">Kubernetes文档</a></li>
<li><a href="https://www.usenix.org/system/files/conference/hotcloud16/hotcloud16_burns.pdf">容器设计模式</a></li>
</ul>
]]></content>
      <categories>
        <category>Cloud Native</category>
      </categories>
  </entry>
  <entry>
    <title>Prometheus+Grafana Intro</title>
    <url>/2021/09/19/Prometheus-Grafana-Intro/</url>
    <content><![CDATA[<h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><ul>
<li>First Steps<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Downloading Prometheus</span><br>  ➜ wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/prometheus/</span>prometheus<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v2.30.0/</span>prometheus-<span class="hljs-number">2.30</span>.<span class="hljs-number">0</span>.linux-arm64.tar.gz<br>  ➜ tar -xvf prometheus-<span class="hljs-number">2.30</span>.<span class="hljs-number">0</span>.linux-arm64.tar.gz<br>  ➜ cd prometheus-<span class="hljs-number">2.30</span>.<span class="hljs-number">0</span>.linux-arm64<br><br><span class="hljs-comment"># Configuring Prometheus</span><br>  ➜ tree -L <span class="hljs-number">1</span><br>  .<br>  ├── console_libraries<br>  ├── consoles<br>  ├── LICENSE<br>  ├── NOTICE<br>  ├── prometheus<br>  ├── prometheus.yml      -- a sample configuration<br>  └── promtool<br><br>  <span class="hljs-number">2</span> directories, <span class="hljs-number">5</span> files<br><br><span class="hljs-comment"># Starting Prometheus</span><br><br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>Cloud Native</category>
      </categories>
  </entry>
  <entry>
    <title>Cyclic redundancy check Intro</title>
    <url>/2021/09/21/Cyclic-redundancy-check-Intro/</url>
    <content><![CDATA[<h1 id="CRC-Cyclic-redundancy-check"><a href="#CRC-Cyclic-redundancy-check" class="headerlink" title="CRC - Cyclic redundancy check"></a>CRC - Cyclic redundancy check</h1><blockquote>
<p>A cyclic redundancy check (CRC) is an error-detecting code commonly used in digital network and storage device to detect accidental changes to raw data.</p>
</blockquote>
<h2 id="CRC-16-校验码"><a href="#CRC-16-校验码" class="headerlink" title="CRC-16 校验码"></a>CRC-16 校验码</h2>]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
  </entry>
  <entry>
    <title>Have Read - Structure and Interpretation of Computer Programs</title>
    <url>/2021/09/21/Have-Read-Structure-and-Interpretation-of-Computer-Programs/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Docker Intro</title>
    <url>/2021/09/26/Docker-Intro/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Go Tips Tracks</title>
    <url>/2021/09/27/Go-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="Go-Tips-Tracks"><a href="#Go-Tips-Tracks" class="headerlink" title="Go Tips Tracks"></a>Go Tips Tracks</h1><span id="more"></span>

<h2 id="Go-Tips"><a href="#Go-Tips" class="headerlink" title="Go Tips"></a>Go Tips</h2><ul>
<li><p><strong>Go Tip #1</strong>: Go’s Package Management and Module Systems</p>
<figure class="highlight vhdl"><table><tr><td class="code"><pre><code class="hljs vhdl">&gt; A <span class="hljs-keyword">package</span> manager <span class="hljs-keyword">is</span> a tool <span class="hljs-keyword">for</span> automating the <span class="hljs-keyword">process</span> <span class="hljs-keyword">of</span> building<br>&gt; <span class="hljs-keyword">in</span> <span class="hljs-number">2018</span>, Go team finally introduced Go modules Go <span class="hljs-number">1.11</span> but wasn<span class="hljs-symbol">&#x27;t</span> enabled by <span class="hljs-keyword">default</span>. <span class="hljs-keyword">To</span> turn it <span class="hljs-keyword">on</span>, $ GO111MODULE = <span class="hljs-keyword">on</span>, Go <span class="hljs-number">1.14</span>, modules are now enabled by <span class="hljs-keyword">default</span><br><br># GOPATH (Go workspace)<br>  &gt; assumed $HOME/go <span class="hljs-keyword">on</span> Unix system, %USERPROFILE%\go <span class="hljs-keyword">on</span> Windows<br>  &gt; As <span class="hljs-keyword">of</span> Go v1.<span class="hljs-number">13</span>, $GOPATH mechanics <span class="hljs-keyword">is</span> now largely irrelevant(无关紧要).<br><br># Getting started <span class="hljs-keyword">with</span> Modules<br>  $ go <span class="hljs-keyword">mod</span> init &lt;module name&gt; (The module name doubles as the import path, which allows internal imports <span class="hljs-keyword">to</span> be resolved inside the module.)<br><br># Installing dependencies<br>  $ go get k8s.io/client-go@latest (adds a <span class="hljs-keyword">new</span> dependency )<br>  $ go get -u &lt;&gt; (-u=patch <span class="hljs-keyword">to</span> upgrade a dependency <span class="hljs-keyword">to</span> a <span class="hljs-keyword">new</span> minor <span class="hljs-keyword">or</span> patch version)<br>  // indirect comment indicates that this <span class="hljs-keyword">package</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> currently being used <span class="hljs-keyword">in</span> the project<br><br>  $ go <span class="hljs-keyword">mod</span> tidy (cleans up unused dependencies <span class="hljs-keyword">or</span> adds missing depenencies)<br>  $ go <span class="hljs-keyword">mod</span> vendor (create a vendor directory <span class="hljs-keyword">in</span> your project root. <span class="hljs-keyword">all</span> the project dependencies (direct <span class="hljs-keyword">and</span> indirect) required <span class="hljs-keyword">to</span> build your project are copied over <span class="hljs-keyword">to</span> the directory)<br>  $ go build (compile packages <span class="hljs-keyword">and</span> dependencies)<br><br># Using replace <span class="hljs-keyword">in</span> go.<span class="hljs-keyword">mod</span> <span class="hljs-keyword">to</span> point <span class="hljs-keyword">to</span> your local module<br>  &gt; point <span class="hljs-keyword">to</span> the local version <span class="hljs-keyword">of</span> a dependency <span class="hljs-keyword">in</span> Go rather than the one over the web, <span class="hljs-keyword">use</span> the replace keyword.<br>  $ go <span class="hljs-keyword">mod</span> edit -replace github.com/pselle/bar=/Users/pselle/Projects/bar<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Go Tip #2</strong>: Go module proxy</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">&gt; Goproxy.<span class="hljs-keyword">cn</span> <span class="hljs-built_in">has</span> fully implemented the GOPROXY protocol. provide <span class="hljs-keyword">a</span> free, trusted, always <span class="hljs-keyword">on</span>, <span class="hljs-built_in">and</span> globally CDNed Go module proxy <span class="hljs-keyword">for</span> Gophers in China.<br><br>$ <span class="hljs-keyword">go</span> env -<span class="hljs-keyword">w</span> GO111MODULE=<span class="hljs-keyword">on</span><br>$ <span class="hljs-keyword">go</span> env -<span class="hljs-keyword">w</span> GOPROXY=http<span class="hljs-variable">s:</span>//goproxy.<span class="hljs-keyword">cn</span>,direct<br><br># Linux<br>  $ <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;export GO111MODULE=on&quot;</span> &gt;&gt; ~/.<span class="hljs-keyword">profile</span><br>  $ <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;export GOPROXY=https://goproxy.cn&quot;</span> &gt;&gt; ~/.<span class="hljs-keyword">profile</span><br>  $ <span class="hljs-keyword">source</span> ~/.<span class="hljs-keyword">profile</span><br></code></pre></td></tr></table></figure></li>
<li><p><strong>Go Tip #3</strong>: GOPATH, GOROOT, GOBIN</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># GOPATH: is the root of the workspace and contains the following folders</span><br>  - src : <span class="hljs-keyword">location</span> <span class="hljs-title">of</span> source files: .go,.c,.g,.s<br>  - pkg : <span class="hljs-keyword">location</span> <span class="hljs-title">of</span> compiled packages (.a files)<br>  - bin : <span class="hljs-keyword">location</span> <span class="hljs-title">of</span> executables built by Go<br><span class="hljs-comment"># GOBIN:</span><br>  &gt; The directory where **go install** <span class="hljs-keyword">and</span> **go get** will place binaries after building main packages.<br><span class="hljs-comment"># GOROOT:</span><br>  &gt; The <span class="hljs-keyword">location</span> <span class="hljs-title">of</span> your Go installation. It is used to find the standard libraries.<br></code></pre></td></tr></table></figure></li>
<li><p><strong>Go Tip #4</strong>: Go Version Management goenv</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># goenv</span><br><span class="hljs-bullet">  -</span> <br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Awesome Tools Intro</title>
    <url>/2021/09/28/Awesome-Tools-Intro/</url>
    <content><![CDATA[<h1 id="工欲善其事-必先利其器"><a href="#工欲善其事-必先利其器" class="headerlink" title="工欲善其事 必先利其器"></a>工欲善其事 必先利其器</h1><blockquote>
<p>If you want to do good things, you must first sharpen your tools.</p>
</blockquote>
<span id="more"></span>
]]></content>
      <categories>
        <category>Computer Science</category>
      </categories>
  </entry>
  <entry>
    <title>Code Review Intro</title>
    <url>/2021/09/28/Code-Review-Intro/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Hyperledger Fabric Intro</title>
    <url>/2021/09/28/Hyperledger-Fabric-Intro/</url>
    <content><![CDATA[<h1 id="Hyperledger-Fabric"><a href="#Hyperledger-Fabric" class="headerlink" title="Hyperledger Fabric"></a>Hyperledger Fabric</h1><blockquote>
<p>Hyperledger Fabric 1.4 LTS - long-term support release<br>Hyperledger Fabric is a permissioned blockchain network(许可区块链网络).</p>
</blockquote>
<span id="more"></span>

<h2 id="Hyperledger-Fabric-Architecture"><a href="#Hyperledger-Fabric-Architecture" class="headerlink" title="Hyperledger Fabric Architecture"></a>Hyperledger Fabric Architecture</h2><ul>
<li>Simplest Hyperledger Fabric network with two organizations joining the same channel<br><img src="/misc/images/fabric-network-1.png" alt="Simplest Fabric network with two organizations joining the same channel"></li>
</ul>
  <figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># Fabric components</span><br>  - Peer:<br>    &gt; is blockchain node that stores <span class="hljs-literal">all</span> transactions <span class="hljs-keyword">on</span> a joining channel.<br><br>  - Orderer:<br>    &gt; is the most important components used <span class="hljs-keyword">in</span> the Farbic consensus mechanism (共识机制)<br>    &gt; is a service responsible <span class="hljs-keyword">for</span> ordering transactions(交易排序), creating a new <span class="hljs-built_in">block</span> of ordered transactions, and distributing a newly created <span class="hljs-built_in">block</span> <span class="hljs-keyword">to</span> <span class="hljs-literal">all</span> peers <span class="hljs-keyword">on</span> a relevant channel.<br><br>  - CA (Certificate Authority) 证书颁发机构:<br>    - 管理用户证书:<br>      - <span class="hljs-keyword">user</span> registration: 用户注册<br>      - <span class="hljs-keyword">user</span> enrollment: 用户登记<br>      - <span class="hljs-keyword">user</span> revocation: 用户撤销<br><br>    - standard certificate: 标准证书<br>      - Hyperledger Fabric uses an X.<span class="hljs-number">509</span> srandard certificate <span class="hljs-keyword">to</span> represent permissions, roles, and attributes <span class="hljs-keyword">to</span> each <span class="hljs-keyword">user</span>.<br>      - <span class="hljs-keyword">user</span> is able <span class="hljs-keyword">to</span> query or invoke <span class="hljs-literal">any</span> transaction <span class="hljs-keyword">on</span> <span class="hljs-literal">any</span> channel based <span class="hljs-keyword">on</span> permissions, roles, and attributes possesses.<br><br>  - Client:<br>    &gt; is considered <span class="hljs-keyword">to</span> be an application that interacts with Fabric blockchain network.<br></code></pre></td></tr></table></figure>

<ul>
<li><p>Endorsing Peer(背书) vs Committing Peer()<br><img src="/misc/images/fabric_endorse_peer_commit_peer.png" alt="Endorsing Peer vs Committing Peer"></p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># Chaincode (Smart Contract)</span><br>  - three language (Golang, Nodejs, Java) program Fabric chaincode - 链码<br>  - 要部署链码，网络管理员将链码安装到目标peer,然后调用orderer排序节点将链码实例化到特定channel通道上.<br>  - Endorsement policy defines which peers need <span class="hljs-keyword">to</span> agree <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> results <span class="hljs-keyword">of</span> a <span class="hljs-keyword">transaction</span> <span class="hljs-keyword">before</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">transaction</span> can be added <span class="hljs-keyword">onto</span> ledgers <span class="hljs-keyword">of</span> all peers <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> channel.<br>  - A chaincode developer must opt <span class="hljs-keyword">to</span> use either LevelDB <span class="hljs-keyword">or</span> CouchDB when developing a chaincode.<br><br><span class="hljs-comment"># Endorsing Peer 背书节点</span><br>  &gt; which consists <span class="hljs-keyword">of</span> an installed chaincode <span class="hljs-keyword">and</span> a <span class="hljs-keyword">local</span> ledger <span class="hljs-keyword">on</span> <span class="hljs-keyword">it</span><br><br><span class="hljs-comment"># Committing Peer</span><br>  &gt; would have only a <span class="hljs-keyword">local</span> ledger <span class="hljs-keyword">on</span> <span class="hljs-keyword">it</span>.<br></code></pre></td></tr></table></figure></li>
<li><p>Interior components inside the Peer’s ledger<br><img src="/misc/images/fabric-ledger-components.png" alt="Interior components inside the Peer&#39;s ledger"></p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># Blockchain</span><br>  &gt; the history of alll transactions <span class="hljs-keyword">for</span> every chaincode <span class="hljs-keyword">on</span> a particular channel.<br><br><span class="hljs-comment"># World State:</span><br>  &gt; maintains the current <span class="hljs-keyword">state</span> of variables <span class="hljs-keyword">for</span> each specific chaincode.<br><br>  - Two type database:<br>    - LevelDB:<br>      &gt; key-value database built <span class="hljs-keyword">on</span> Fabric Peer<br><br>    - CouchDB:<br>      &gt; JSON-based database supporting rich querying operations based <span class="hljs-keyword">on</span> JSON objects.<br></code></pre></td></tr></table></figure></li>
<li><p>Fabric network with chaincodes and ledgers attached multiple channels<br><img src="/misc/images/fabric-network-2.png" alt="Fabric network with chaincodes and ledgers attached"></p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">&gt; Actually, <span class="hljs-keyword">the</span> <span class="hljs-keyword">system</span> chaincodes <span class="hljs-keyword">and</span> ledgers are also deployed <span class="hljs-keyword">on</span> <span class="hljs-title">peers</span><br><br><span class="hljs-comment"># System Chaincodes</span><br>  &gt; collect network, channel, <span class="hljs-keyword">and</span> underlying <span class="hljs-keyword">system</span> configurations <span class="hljs-keyword">for</span> Fabric virtual machine <span class="hljs-built_in">to</span> work properly.<br><br>  - QSCC (Query System Chaincode): <span class="hljs-keyword">for</span> ledger <span class="hljs-keyword">and</span> Fabric-related queries<br>  - CSCC (Configuration System Chaincode): which helps regulate access control<br>  - LSCC (Lifecycle System Chaincode): which defines <span class="hljs-keyword">the</span> rules <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> channel<br>  - ESCC (Endorsement System Chaincode): endorsing transactions<br>  - VSCC (Validation System Chaincode): validating transactions<br><br><span class="hljs-comment"># System Ledgers</span><br><br><span class="hljs-comment"># Channel</span><br>  &gt; organizations that join <span class="hljs-keyword">the</span> same channel can secretly share business transaction <span class="hljs-keyword">or</span> information together <span class="hljs-keyword">with</span> confidence.<br><br><span class="hljs-comment"># Chaincode:</span><br>  - <span class="hljs-literal">one</span> chaincode can call another chaincode <span class="hljs-keyword">on</span> <span class="hljs-title">the</span> <span class="hljs-title">same</span> <span class="hljs-title">channel</span>.<br></code></pre></td></tr></table></figure></li>
<li><p>Fabric transaction invocation workflow (投票流程图)<br><img src="/misc/images/fabric-transaction-invocation-workflow.png" alt="Fabric transaction invocation workflow"></p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># consensus(共识) divided into tree phases</span><br>  - <span class="hljs-number">1</span>. Endorsement (背书) (Steps <span class="hljs-number">1</span>-<span class="hljs-number">3</span>)<br>  - <span class="hljs-number">2</span>. Ordering (排序) (Steps <span class="hljs-number">4</span>-<span class="hljs-number">5</span>)<br>  - <span class="hljs-number">3</span>. Validation and Commitment(验证和承诺) (Steps <span class="hljs-number">6</span>)<br><br><span class="hljs-comment"># Fabric transaction workflow:</span><br>  - <span class="hljs-number">1</span>. Client:创建交易提议，并使用用户证书进行签名，然后发送交易到特定通道上预先确定的背书节点上<br>  - <span class="hljs-number">2</span>. (Endorsing Peer) 首先从交易提议中验证用户身份和授权, 验证通过后，背书节点模拟交易, 生成相应和读写集，并使用证书对生成的响应进行背书<br>  - <span class="hljs-number">3</span>. Client: accumulate并检查来自背书节点的背书提案响应.<br>  - <span class="hljs-number">4</span>. Client: 将附有背书提案响应的交易发给Orderer.<br>  - <span class="hljs-number">5</span>. Orderer: 对接收到的交易进行排序，生成一个新的有序交易快，并用其证书对生成的快进行签名<br>  - <span class="hljs-number">6</span>. Orderer: 将生成的快广播给相关通道上的所有对等(endorse peer, commit peer)节点. 然后每个Peer确保接收到的区块中的每次交易都由适当的背书(Endorsing Peers)签名(根据调用的链码的背书策略确定)并且存在足够的背书. 之后，将进行版本检查(Multi-version concurrency control MVCC 检查) 以验证接收到的快的交易的正确性. 每一个Peer节点都会将每个交易的readset与其分类帐的世界状态进行比较，如果验证检查通过，则交易被标记为有效，并且每个Peer的word <span class="hljs-keyword">state</span>都会更新, 否则，交易被标记为无效而不更新world <span class="hljs-keyword">state</span>. 最后，无论该<span class="hljs-built_in">block</span>是否包含任何无效的交易，接收到的<span class="hljs-built_in">block</span>都会追加到Peer节点的本地blockchain中.<br>  - <span class="hljs-number">7</span>. Client: 客户端从EventHub服务接受订阅的事件<br></code></pre></td></tr></table></figure></li>
<li><p>Fabric Orderer Service</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm">&gt; It acts as a Hub for <span class="hljs-keyword">distributing </span><span class="hljs-keyword">blocks </span>of transactions to all peers on a relevant channel.<br>&gt; <span class="hljs-keyword">Orderer </span>might <span class="hljs-keyword">be </span>considered to <span class="hljs-keyword">be </span>the weakest point in the Fabric network.<br><br><span class="hljs-comment"># two type of Fabric Orderer service</span><br>  - Solo-<span class="hljs-keyword">based </span><span class="hljs-keyword">ordering </span>service (仅用于开发阶段)<br><br>  - Kafka-<span class="hljs-keyword">based </span><span class="hljs-keyword">ordering </span>service (搭建Kafka集群)<br>    - Kafka provide Crash Fault tolerance (CFT崩溃容错) consensus(共识)<br></code></pre></td></tr></table></figure></li>
<li><p>Fabric network in a production environment<br><img src="/misc/images/fabric-network-production.png" alt="Fabric network in a production environment"></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Client application interact with Fabric blockchain network in two ways:</span><br><span class="hljs-bullet">  -</span> Fabric SDK<br><span class="hljs-code">    &gt; Fabric SDK supports Go, Node.js and Java language</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">  -</span> Fabric CLI<br><span class="hljs-code">    &gt; use in development or maintenance mode</span><br><span class="hljs-code"></span><br><span class="hljs-section"># CA: 用户管理和证书颁发</span><br><span class="hljs-bullet">  -</span> Two ways to deploy Fabric CA:<br><span class="hljs-bullet">    -</span> 1. Fabric CA without LDAP Server:<br><span class="hljs-code">      &gt; Fabric CA 负责 用户注册、用户认证、颁发用户证书.</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    -</span> 2. Fabric CA with LDAP Server:<br><span class="hljs-code">      &gt; Fabric CA 负责颁发用户证书</span><br><span class="hljs-code">      &gt; LDAP Server 负责 用户注册、用户认证、撤销用户</span><br><span class="hljs-code">      &gt; 这种方式适合组织存在的AD,LDAP or Radius server.</span><br><span class="hljs-code"></span><br><span class="hljs-section"># CouchDB:</span><br>  &gt; 支持JSON 查询，数据库索引，数据拷贝，ACID 属性<br><br><span class="hljs-section"># LevelDB:</span><br>  &gt; 支持有限的操作<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Private-Data-Collection"><a href="#Private-Data-Collection" class="headerlink" title="Private Data Collection"></a>Private Data Collection</h2>  <figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">Fabric <span class="hljs-number">1.2</span>支持该特性</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>Overview of Private Data Collection<br><img src="/misc/images/fabric-private-data-collection.png" alt="Peer&#39;s ledger enabled for Private Data Collection use"></p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf"><span class="hljs-comment"># public data section:</span><br>  - public <span class="hljs-built_in">block</span> storage: 公共快存储<br>    &gt; is a blockchain that holds the history of <span class="hljs-literal">all</span> public transactions <span class="hljs-keyword">for</span> every chaincode instantiated <span class="hljs-keyword">on</span> a channel.<br><br>  - public <span class="hljs-keyword">state</span> database 公共状态数据库<br>    &gt; maintains the current <span class="hljs-keyword">state</span> of public variables <span class="hljs-keyword">for</span> a specific chaincode.<br><br>  &gt; 对于任何特定通道channel,即公共数据部分仅包含单个公共快存储(public <span class="hljs-built_in">block</span> storage)实例, 但该部分可以包含基于在通道上实例化的多个链码(chaincode)的多个公共状态数据库实例.<br><br><span class="hljs-comment"># private data section:</span><br>  - private writeset storage: 私有写入集存储<br>    &gt; 收集特定私有数据集合的所有私有交易的历史记录<br>    &gt; 这种存储不是区块链，而是一种典型的日志持久化数据库<br><br>  - private <span class="hljs-keyword">state</span> database:<br>    &gt;<br><br>  - transient store database: 瞬态存储数据库<br>    &gt; 这种数据库用作临时数据库，用于在交易调用过程中临时存储私有数据<br></code></pre></td></tr></table></figure></li>
<li><p>Peers maintaining multiple Private Data Collections<br><img src="/misc/images/fabric-private-data-collection-2.png" alt="Peers maintaining multiple Private Data Collections"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">Public State Database:</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> (公共状态数据库)存储特定链码的公共变量的当前值, 还存储与该特定链码关联的修改后的私有数据集的哈希值.</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Private data collections:</span><br><span class="hljs-meta">  &gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Fabric-1-4-12-源代码分析"><a href="#Fabric-1-4-12-源代码分析" class="headerlink" title="Fabric (1.4.12) 源代码分析"></a>Fabric (1.4.12) 源代码分析</h2>  <figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 下载docker镜像、预编译程序</span><br>➜ curl -sSL https:<span class="hljs-regexp">//</span>bit.ly/<span class="hljs-number">2</span>ysbOFE | bash -s <span class="hljs-number">1.4</span>.<span class="hljs-number">12</span><br><br>$ cat https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/hyperledger/</span>fabric<span class="hljs-regexp">/blob/</span>release-<span class="hljs-number">1.4</span><span class="hljs-regexp">/scripts/</span>bootstrap.sh<br>  export VERSION=<span class="hljs-number">1.4</span>.<span class="hljs-number">12</span><br>  export CA_VERSION=<span class="hljs-number">1.4</span>.<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure>

<h3 id="Fabric-Tips-amp-amp-Tracks"><a href="#Fabric-Tips-amp-amp-Tracks" class="headerlink" title="Fabric Tips &amp;&amp; Tracks"></a>Fabric Tips &amp;&amp; Tracks</h3><ul>
<li>Read-Write set semantics<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语:"></a>专业术语:</h3><ul>
<li><p>transaction (交易):</p>
<blockquote>
<p>chaincode的invoke或instantiate操作，invoke是从ledger中请求read-write set, instantiate是请求在peer上启动chaincode容器</p>
</blockquote>
</li>
<li><p>system chain (系统链):</p>
<blockquote>
<p>包含在系统级定义网络的配置区块中，系统链存在与ordering service中,与channel类似.</p>
</blockquote>
</li>
<li><p>state database (stateDB):</p>
<blockquote>
<p>current state数据存储在stateDB中，包括levelDB和couchDB.</p>
</blockquote>
</li>
<li><p>proposal(提案):</p>
<blockquote>
<p>一种对channel中某peer的背书请求，每个proposal要么是chaincode instantiate(实例),要么是chaincode invoke(调用).</p>
</blockquote>
</li>
<li><p>policy(策略):</p>
</li>
<li><p>peer(节点):</p>
<blockquote>
<p>网络实体,维护ledger并运行chaincode容器来对ledger执行read-write操作</p>
</blockquote>
</li>
<li><p>ordering service(排序服务/共识服务):</p>
<blockquote>
<p>将交易排序放入block的节点的集合,以先进先得的方式为网络上所有的channel提供交易排序服务.</p>
</blockquote>
</li>
<li><p>membership services(成员服务):</p>
<blockquote>
<p>在许可的区块链网络上认证、授权和管理身份. 在peer和order中运行的成员服务的代码都会认证和授权区块链操作, 他是基于PKI的MSP实现的.<br>fabric-ca 组件实现了成员服务以管理身份，处理ECert和TCert的颁发和撤销<br>ECert是长期的身份凭证，TCert是短期身份凭证</p>
</blockquote>
</li>
<li><p>membership service provider (MSP):</p>
<blockquote>
</blockquote>
</li>
<li><p>Member(成员):</p>
<blockquote>
</blockquote>
</li>
<li><p>Ledger (账本):</p>
<blockquote>
</blockquote>
</li>
<li><p>leading peer (主导节点):</p>
<blockquote>
<p>每一个member在其订阅的channel上可以拥有多个peer, 其中一个peer会作为channel的leading peer代表该member与ordering service通信. ordering service将block传递给leading peer, 该peer再将block分发给同一member下的其他peer.</p>
</blockquote>
</li>
<li><p>invoke (调用):</p>
<blockquote>
<p>调用chaincode内的函数, invoke结构就是一个函数和一个参数数组.</p>
</blockquote>
</li>
<li><p>instantiate (实例化):</p>
<blockquote>
<p>启动chaincode容器的过程</p>
</blockquote>
</li>
<li><p>gossip protocol (Gossip 协议):</p>
<blockquote>
<p>Gossip 数据传输协议有三项功能: 管理peer discovery和channel 成员; 在channel上所有的peer间广播账本数据;在channel上所有的peer间同步账本数据</p>
</blockquote>
</li>
<li><p>genesis block (初始化区块):</p>
<blockquote>
<p>genesis block是初始化区块链网络或channel的配置区块，也是链上的第一个区块</p>
</blockquote>
</li>
<li><p>fabric-ca:</p>
<blockquote>
<p>默认的证书管理组件，向网络成员及其用户颁发基于PKI的证书，CA为每个成员颁发一个根证书(rootCert), 为每一个授权用户颁发一个注册证书(eCert), 每一个注册证书颁发大量交易证书(tCert)</p>
</blockquote>
</li>
<li><p>endorser:</p>
<blockquote>
<p>背书节点</p>
</blockquote>
</li>
<li><p>dynamic membership (动态成员):</p>
<blockquote>
<p>fabric 支持动态添加、移除members、peers和ordering服务节点, 而不会影响整个网络的操作性. 当业务系统调整或因各种原因需要添加、移除实体时.</p>
</blockquote>
</li>
<li><p>consensus (共识):</p>
<blockquote>
<p>用于产生一个对于排序的同意书和确认构成区块的交易集的正确性</p>
</blockquote>
</li>
<li><p>concurrency control version check (并发控制版本检查):</p>
<blockquote>
<p>CCVC时保持通道中各对等节点间状态同步的一种方式，对等节点并行的执行交易</p>
</blockquote>
</li>
<li><p>committer:</p>
<blockquote>
<p>提交者</p>
</blockquote>
</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>  <a href="https://medium.com/coinmonks/demystifying-hyperledger-fabric-2-3-private-data-collection-164220ecafa5">Demystifying Hyperledger Fabric</a></p>
]]></content>
      <categories>
        <category>Blockchain</category>
      </categories>
  </entry>
  <entry>
    <title>LevelDB Intro</title>
    <url>/2021/09/28/LevelDB-Intro/</url>
    <content><![CDATA[<h1 id="LevelDB"><a href="#LevelDB" class="headerlink" title="LevelDB"></a>LevelDB</h1><blockquote>
<p>LevelDB is a fast key-value storage library written at Google that provides an ordered mapping from string keys to string values.</p>
</blockquote>
<span id="more"></span>

<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>key和value支持存储任意长度的字节数组</li>
<li>数据存储根据Key排序</li>
<li>支持自定义排序规则</li>
<li>基本操作是Put(Key,value), Get(Key), Delete(Key)</li>
<li>支持批量原子操作</li>
<li>支持创建事务快照获取一致性视图数据</li>
<li>Forward and backward iteration is supported over the data.</li>
<li>自动使用Snappy算法压缩数据</li>
</ul>
<h2 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h2><ul>
<li>Not SQL database</li>
<li>Only a single process (possibly multi-threaded) can access a particular database at a time</li>
<li>No client-server support builtin to the library</li>
</ul>
]]></content>
      <categories>
        <category>Middleware</category>
      </categories>
  </entry>
  <entry>
    <title>Bash Script CheetSheet</title>
    <url>/2021/10/09/Bash-Script-CheetSheet/</url>
    <content><![CDATA[<h1 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h1><blockquote>
<p>Bash is a name of the unix shell, which was also distributed as the shell for the GNU operating system and as the default shell on most linux distros.</p>
</blockquote>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/env bash</span><br><span class="hljs-comment"># First line of the script is the shebang which tells the system how to execute</span><br><span class="hljs-comment"># the script</span><br><br><span class="hljs-comment"># Simple hello world example:</span><br><span class="hljs-built_in">echo</span> Hello world!  <span class="hljs-comment"># =&gt; Hello world!</span><br><br><span class="hljs-comment"># Each command starts on a new line, or after a semicolon:</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;This is the first line&#x27;</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;This is the second line&#x27;</span><br><span class="hljs-comment"># =&gt; This is the first line</span><br><span class="hljs-comment"># =&gt; This is the second line</span><br><br><span class="hljs-comment"># Declaring a variable looks like this:</span><br>Variable=<span class="hljs-string">&quot;Some string&quot;</span><br><br><span class="hljs-comment"># Using the variable:</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$Variable</span>  <span class="hljs-comment"># =&gt; Some string</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$Variable</span>&quot;</span> <span class="hljs-comment"># =&gt; Some string</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;$Variable&#x27;</span> <span class="hljs-comment"># =&gt; $Variable</span><br><span class="hljs-comment"># When you use the variable itself - assign it, export it, or else - you write</span><br><span class="hljs-comment"># its name without $. If you want to use the variable&#x27;s value, you should use $.</span><br><span class="hljs-comment"># Not that &#x27; (single quote) wan&#x27;t expand the variables!</span><br><br><span class="hljs-comment"># Parameter expansion $&#123; &#125;:</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Variable&#125;</span> <span class="hljs-comment"># =&gt; Some string</span><br><span class="hljs-comment"># This is a simple usage of parameter expansion</span><br><span class="hljs-comment"># Parameter Expansion gets a value from a variable.</span><br><span class="hljs-comment"># It &quot;expands&quot; or prints the value</span><br><span class="hljs-comment"># During the expansion time the value or parameter can be modified</span><br><span class="hljs-comment"># Below are other modifications that add onto this expansion</span><br><br><span class="hljs-comment"># String substitution in variables</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Variable/Some/A&#125;</span> <span class="hljs-comment"># =&gt; A string</span><br><span class="hljs-comment"># This will substitute the first occurrence of &quot;Some&quot; with &quot;A&quot;</span><br><br><span class="hljs-comment"># Substring from a variable</span><br>Length=7<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Variable:0:Length&#125;</span> <span class="hljs-comment"># =&gt; Some st</span><br><span class="hljs-comment"># This will return only the first 7 characters of the value</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Variable: -5&#125;</span> <span class="hljs-comment"># =&gt; tring</span><br><span class="hljs-comment"># This will return the last 5 characters (note the space before -5)</span><br><br><span class="hljs-comment"># String length</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;#Variable&#125;</span> <span class="hljs-comment"># =&gt; 11</span><br><br><span class="hljs-comment"># Indirect expansion</span><br>OtherVariable=<span class="hljs-string">&quot;Variable&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;!OtherVariable&#125;</span> <span class="hljs-comment"># =&gt; Some String</span><br><span class="hljs-comment"># This will expand the value of OtherVariable</span><br><br><span class="hljs-comment"># Default value for variable</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;Foo:-&quot;DefaultValueIfFooIsMissingOrEmpty&quot;&#125;</span><br><span class="hljs-comment"># =&gt; DefaultValueIfFooIsMissingOrEmpty</span><br><span class="hljs-comment"># This works for null (Foo=) and empty string (Foo=&quot;&quot;); zero (Foo=0) returns 0.</span><br><span class="hljs-comment"># Note that it only returns default value and doesn&#x27;t change variable value.</span><br><br><span class="hljs-comment"># Declare an array with 6 elements</span><br>array0=(one two three four five six)<br><span class="hljs-comment"># Print first element</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$array0</span> <span class="hljs-comment"># =&gt; &quot;one&quot;</span><br><span class="hljs-comment"># Print first element</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;array0[0]&#125;</span> <span class="hljs-comment"># =&gt; &quot;one&quot;</span><br><span class="hljs-comment"># Print all elements</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;array0[@]&#125;</span> <span class="hljs-comment"># =&gt; &quot;one two three four five six&quot;</span><br><span class="hljs-comment"># Print number of elements</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;#array0[@]&#125;</span> <span class="hljs-comment"># =&gt; &quot;6&quot;</span><br><span class="hljs-comment"># Print number of characters in third element</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;#array0[2]&#125;</span> <span class="hljs-comment"># =&gt; &quot;5&quot;</span><br><span class="hljs-comment"># Print 2 elements starting from forth</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;array0[@]:3:2&#125;</span> <span class="hljs-comment"># =&gt; &quot;four five&quot;</span><br><span class="hljs-comment"># Print all elements. Each of them on new line.</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;array0[@]&#125;</span>&quot;</span>; <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$i</span>&quot;</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># Brace Expansion &#123; &#125;</span><br><span class="hljs-comment"># Used to generate arbitrary strings</span><br><span class="hljs-built_in">echo</span> &#123;1..10&#125; <span class="hljs-comment"># =&gt; 1 2 3 4 5 6 7 8 9 10</span><br><span class="hljs-built_in">echo</span> &#123;a..z&#125; <span class="hljs-comment"># =&gt; a b c d e f g h i j k l m n o p q r s t u v w x y z</span><br><span class="hljs-comment"># This will output the range from the start value to the end value</span><br><br><span class="hljs-comment"># Built-in variables:</span><br><span class="hljs-comment"># There are some useful built-in variables, like</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Last program&#x27;s return value: $?&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Script&#x27;s PID: $$&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Number of arguments passed to script: <span class="hljs-variable">$#</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;All arguments passed to script: <span class="hljs-variable">$@</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Script&#x27;s arguments separated into different variables: <span class="hljs-variable">$1</span> <span class="hljs-variable">$2</span>...&quot;</span><br><br><span class="hljs-comment"># Now that we know how to echo and use variables,</span><br><span class="hljs-comment"># let&#x27;s learn some of the other basics of bash!</span><br><br><span class="hljs-comment"># Our current directory is available through the command `pwd`.</span><br><span class="hljs-comment"># `pwd` stands for &quot;print working directory&quot;.</span><br><span class="hljs-comment"># We can also use the built-in variable `$PWD`.</span><br><span class="hljs-comment"># Observe that the following are equivalent:</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;I&#x27;m in <span class="hljs-subst">$(pwd)</span>&quot;</span> <span class="hljs-comment"># execs `pwd` and interpolates output</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;I&#x27;m in <span class="hljs-variable">$PWD</span>&quot;</span> <span class="hljs-comment"># interpolates the variable</span><br><br><span class="hljs-comment"># If you get too much output in your terminal, or from a script, the command</span><br><span class="hljs-comment"># `clear` clears your screen</span><br>clear<br><span class="hljs-comment"># Ctrl-L also works for clearing output</span><br><br><span class="hljs-comment"># Reading a value from input:</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;What&#x27;s your name?&quot;</span><br><span class="hljs-built_in">read</span> Name <span class="hljs-comment"># Note that we didn&#x27;t need to declare a new variable</span><br><span class="hljs-built_in">echo</span> Hello, <span class="hljs-variable">$Name</span>!<br><br><span class="hljs-comment"># We have the usual if structure:</span><br><span class="hljs-comment"># use `man test` for more info about conditionals</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$Name</span> != <span class="hljs-variable">$USER</span> ]<br><span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Your name isn&#x27;t your username&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Your name is your username&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment"># True if the value of $Name is not equal to the current user&#x27;s login username</span><br><br><span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> if $Name is empty, bash sees the above condition as:</span><br><span class="hljs-keyword">if</span> [ != <span class="hljs-variable">$USER</span> ]<br><span class="hljs-comment"># which is invalid syntax</span><br><span class="hljs-comment"># so the &quot;safe&quot; way to use potentially empty variables in bash is:</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$Name</span>&quot;</span> != <span class="hljs-variable">$USER</span> ] ...<br><span class="hljs-comment"># which, when $Name is empty, is seen by bash as:</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;&quot;</span> != <span class="hljs-variable">$USER</span> ] ...<br><span class="hljs-comment"># which works as expected</span><br><br><span class="hljs-comment"># There is also conditional execution</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Always executed&quot;</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Only executed if first command fails&quot;</span><br><span class="hljs-comment"># =&gt; Always executed</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Always executed&quot;</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Only executed if first command does NOT fail&quot;</span><br><span class="hljs-comment"># =&gt; Always executed</span><br><span class="hljs-comment"># =&gt; Only executed if first command does NOT fail</span><br><br><br><span class="hljs-comment"># To use &amp;&amp; and || with if statements, you need multiple pairs of square brackets:</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$Name</span>&quot;</span> == <span class="hljs-string">&quot;Steve&quot;</span> ] &amp;&amp; [ <span class="hljs-string">&quot;<span class="hljs-variable">$Age</span>&quot;</span> -eq 15 ]<br><span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;This will run if <span class="hljs-variable">$Name</span> is Steve AND <span class="hljs-variable">$Age</span> is 15.&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$Name</span>&quot;</span> == <span class="hljs-string">&quot;Daniya&quot;</span> ] || [ <span class="hljs-string">&quot;<span class="hljs-variable">$Name</span>&quot;</span> == <span class="hljs-string">&quot;Zach&quot;</span> ]<br><span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;This will run if <span class="hljs-variable">$Name</span> is Daniya OR Zach.&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># There is also the `=~` operator, which tests a string against a Regex pattern:</span><br>Email=me@example.com<br><span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$Email</span>&quot;</span> =~ [a-z]+@[a-z]&#123;2,&#125;\.(com|net|org) ]]<br><span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Valid email!&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment"># Note that =~ only works within double [[ ]] square brackets,</span><br><span class="hljs-comment"># which are subtly different from single [ ].</span><br><span class="hljs-comment"># See https://www.gnu.org/software/bash/manual/bashref.html#Conditional-Constructs for more on this.</span><br><br><span class="hljs-comment"># Redefine command `ping` as alias to send only 5 packets</span><br><span class="hljs-built_in">alias</span> ping=<span class="hljs-string">&#x27;ping -c 5&#x27;</span><br><span class="hljs-comment"># Escape the alias and use command with this name instead</span><br>\ping 192.168.1.1<br><span class="hljs-comment"># Print all aliases</span><br><span class="hljs-built_in">alias</span> -p<br><br><span class="hljs-comment"># Expressions are denoted with the following format:</span><br><span class="hljs-built_in">echo</span> $(( <span class="hljs-number">10</span> + <span class="hljs-number">5</span> )) <span class="hljs-comment"># =&gt; 15</span><br><br><span class="hljs-comment"># Unlike other programming languages, bash is a shell so it works in the context</span><br><span class="hljs-comment"># of a current directory. You can list files and directories in the current</span><br><span class="hljs-comment"># directory with the ls command:</span><br>ls <span class="hljs-comment"># Lists the files and subdirectories contained in the current directory</span><br><br><span class="hljs-comment"># This command has options that control its execution:</span><br>ls -l <span class="hljs-comment"># Lists every file and directory on a separate line</span><br>ls -t <span class="hljs-comment"># Sorts the directory contents by last-modified date (descending)</span><br>ls -R <span class="hljs-comment"># Recursively `ls` this directory and all of its subdirectories</span><br><br><span class="hljs-comment"># Results of the previous command can be passed to the next command as input.</span><br><span class="hljs-comment"># The `grep` command filters the input with provided patterns.</span><br><span class="hljs-comment"># That&#x27;s how we can list .txt files in the current directory:</span><br>ls -l | grep <span class="hljs-string">&quot;\.txt&quot;</span><br><br><span class="hljs-comment"># Use `cat` to print files to stdout:</span><br>cat file.txt<br><br><span class="hljs-comment"># We can also read the file using `cat`:</span><br>Contents=$(cat file.txt)<br><span class="hljs-comment"># &quot;\n&quot; prints a new line character</span><br><span class="hljs-comment"># &quot;-e&quot; to interpret the newline escape characters as escape characters</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;START OF FILE\n<span class="hljs-variable">$Contents</span>\nEND OF FILE&quot;</span><br><span class="hljs-comment"># =&gt; START OF FILE</span><br><span class="hljs-comment"># =&gt; [contents of file.txt]</span><br><span class="hljs-comment"># =&gt; END OF FILE</span><br><br><span class="hljs-comment"># Use `cp` to copy files or directories from one place to another.</span><br><span class="hljs-comment"># `cp` creates NEW versions of the sources,</span><br><span class="hljs-comment"># so editing the copy won&#x27;t affect the original (and vice versa).</span><br><span class="hljs-comment"># Note that it will overwrite the destination if it already exists.</span><br>cp srcFile.txt clone.txt<br>cp -r srcDirectory/ dst/ <span class="hljs-comment"># recursively copy</span><br><br><span class="hljs-comment"># Look into `scp` or `sftp` if you plan on exchanging files between computers.</span><br><span class="hljs-comment"># `scp` behaves very similarly to `cp`.</span><br><span class="hljs-comment"># `sftp` is more interactive.</span><br><br><span class="hljs-comment"># Use `mv` to move files or directories from one place to another.</span><br><span class="hljs-comment"># `mv` is similar to `cp`, but it deletes the source.</span><br><span class="hljs-comment"># `mv` is also useful for renaming files!</span><br>mv s0urc3.txt dst.txt <span class="hljs-comment"># sorry, l33t hackers...</span><br><br><span class="hljs-comment"># Since bash works in the context of a current directory, you might want to</span><br><span class="hljs-comment"># run your command in some other directory. We have cd for changing location:</span><br><span class="hljs-built_in">cd</span> ~    <span class="hljs-comment"># change to home directory</span><br><span class="hljs-built_in">cd</span>      <span class="hljs-comment"># also goes to home directory</span><br><span class="hljs-built_in">cd</span> ..   <span class="hljs-comment"># go up one directory</span><br>        <span class="hljs-comment"># (^^say, from /home/username/Downloads to /home/username)</span><br><span class="hljs-built_in">cd</span> /home/username/Documents   <span class="hljs-comment"># change to specified directory</span><br><span class="hljs-built_in">cd</span> ~/Documents/..    <span class="hljs-comment"># still in home directory..isn&#x27;t it??</span><br><span class="hljs-built_in">cd</span> -    <span class="hljs-comment"># change to last directory</span><br><span class="hljs-comment"># =&gt; /home/username/Documents</span><br><br><span class="hljs-comment"># Use subshells to work across directories</span><br>(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;First, I&#x27;m here: <span class="hljs-variable">$PWD</span>&quot;</span>) &amp;&amp; (<span class="hljs-built_in">cd</span> someDir; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Then, I&#x27;m here: <span class="hljs-variable">$PWD</span>&quot;</span>)<br><span class="hljs-built_in">pwd</span> <span class="hljs-comment"># still in first directory</span><br><br><span class="hljs-comment"># Use `mkdir` to create new directories.</span><br>mkdir myNewDir<br><span class="hljs-comment"># The `-p` flag causes new intermediate directories to be created as necessary.</span><br>mkdir -p myNewDir/with/intermediate/directories<br><span class="hljs-comment"># if the intermediate directories didn&#x27;t already exist, running the above</span><br><span class="hljs-comment"># command without the `-p` flag would return an error</span><br><br><span class="hljs-comment"># You can redirect command input and output (stdin, stdout, and stderr).</span><br><span class="hljs-comment"># Read from stdin until ^EOF$ and overwrite hello.py with the lines</span><br><span class="hljs-comment"># between &quot;EOF&quot;:</span><br>cat &gt; hello.py &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">#!/usr/bin/env python</span><br><span class="hljs-string">from __future__ import print_function</span><br><span class="hljs-string">import sys</span><br><span class="hljs-string">print(&quot;#stdout&quot;, file=sys.stdout)</span><br><span class="hljs-string">print(&quot;#stderr&quot;, file=sys.stderr)</span><br><span class="hljs-string">for line in sys.stdin:</span><br><span class="hljs-string">    print(line, file=sys.stdout)</span><br><span class="hljs-string">EOF</span><br><span class="hljs-comment"># Variables will be expanded if the first &quot;EOF&quot; is not quoted</span><br><br><span class="hljs-comment"># Run the hello.py Python script with various stdin, stdout, and</span><br><span class="hljs-comment"># stderr redirections:</span><br>python hello.py &lt; <span class="hljs-string">&quot;input.in&quot;</span> <span class="hljs-comment"># pass input.in as input to the script</span><br><br>python hello.py &gt; <span class="hljs-string">&quot;output.out&quot;</span> <span class="hljs-comment"># redirect output from the script to output.out</span><br><br>python hello.py 2&gt; <span class="hljs-string">&quot;error.err&quot;</span> <span class="hljs-comment"># redirect error output to error.err</span><br><br>python hello.py &gt; <span class="hljs-string">&quot;output-and-error.log&quot;</span> 2&gt;&amp;1<br><span class="hljs-comment"># redirect both output and errors to output-and-error.log</span><br><br>python hello.py &gt; /dev/null 2&gt;&amp;1<br><span class="hljs-comment"># redirect all output and errors to the black hole, /dev/null, i.e., no output</span><br><br><span class="hljs-comment"># The output error will overwrite the file if it exists,</span><br><span class="hljs-comment"># if you want to append instead, use &quot;&gt;&gt;&quot;:</span><br>python hello.py &gt;&gt; <span class="hljs-string">&quot;output.out&quot;</span> 2&gt;&gt; <span class="hljs-string">&quot;error.err&quot;</span><br><br><span class="hljs-comment"># Overwrite output.out, append to error.err, and count lines:</span><br>info bash <span class="hljs-string">&#x27;Basic Shell Features&#x27;</span> <span class="hljs-string">&#x27;Redirections&#x27;</span> &gt; output.out 2&gt;&gt; error.err<br>wc -l output.out error.err<br><br><span class="hljs-comment"># Run a command and print its file descriptor (e.g. /dev/fd/123)</span><br><span class="hljs-comment"># see: man fd</span><br><span class="hljs-built_in">echo</span> &lt;(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#helloworld&quot;</span>)<br><br><span class="hljs-comment"># Overwrite output.out with &quot;#helloworld&quot;:</span><br>cat &gt; output.out &lt;(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#helloworld&quot;</span>)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#helloworld&quot;</span> &gt; output.out<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#helloworld&quot;</span> | cat &gt; output.out<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#helloworld&quot;</span> | tee output.out &gt;/dev/null<br><br><span class="hljs-comment"># Cleanup temporary files verbosely (add &#x27;-i&#x27; for interactive)</span><br><span class="hljs-comment"># WARNING: `rm` commands cannot be undone</span><br>rm -v output.out error.err output-and-error.log<br>rm -r tempDir/ <span class="hljs-comment"># recursively delete</span><br><span class="hljs-comment"># You can install the `trash-cli` Python package to have `trash`</span><br><span class="hljs-comment"># which puts files in the system trash and doesn&#x27;t delete them directly</span><br><span class="hljs-comment"># see https://pypi.org/project/trash-cli/ if you want to be careful</span><br><br><span class="hljs-comment"># Commands can be substituted within other commands using $( ):</span><br><span class="hljs-comment"># The following command displays the number of files and directories in the</span><br><span class="hljs-comment"># current directory.</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;There are <span class="hljs-subst">$(ls | wc -l)</span> items here.&quot;</span><br><br><span class="hljs-comment"># The same can be done using backticks `` but they can&#x27;t be nested -</span><br><span class="hljs-comment"># the preferred way is to use $( ).</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;There are `ls | wc -l` items here.&quot;</span><br><br><span class="hljs-comment"># Bash uses a `case` statement that works similarly to switch in Java and C++:</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$Variable</span>&quot;</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-comment"># List patterns for the conditions you want to meet</span><br>    0) <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;There is a zero.&quot;</span>;;<br>    1) <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;There is a one.&quot;</span>;;<br>    *) <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;It is not null.&quot;</span>;;  <span class="hljs-comment"># match everything</span><br><span class="hljs-keyword">esac</span><br><br><span class="hljs-comment"># `for` loops iterate for as many arguments given:</span><br><span class="hljs-comment"># The contents of $Variable is printed three times.</span><br><span class="hljs-keyword">for</span> Variable <span class="hljs-keyword">in</span> &#123;1..3&#125;<br><span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$Variable</span>&quot;</span><br><span class="hljs-keyword">done</span><br><span class="hljs-comment"># =&gt; 1</span><br><span class="hljs-comment"># =&gt; 2</span><br><span class="hljs-comment"># =&gt; 3</span><br><br><br><span class="hljs-comment"># Or write it the &quot;traditional for loop&quot; way:</span><br><span class="hljs-keyword">for</span> ((a=1; a &lt;= 3; a++))<br><span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$a</span><br><span class="hljs-keyword">done</span><br><span class="hljs-comment"># =&gt; 1</span><br><span class="hljs-comment"># =&gt; 2</span><br><span class="hljs-comment"># =&gt; 3</span><br><br><span class="hljs-comment"># They can also be used to act on files..</span><br><span class="hljs-comment"># This will run the command `cat` on file1 and file2</span><br><span class="hljs-keyword">for</span> Variable <span class="hljs-keyword">in</span> file1 file2<br><span class="hljs-keyword">do</span><br>    cat <span class="hljs-string">&quot;<span class="hljs-variable">$Variable</span>&quot;</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># ..or the output from a command</span><br><span class="hljs-comment"># This will `cat` the output from `ls`.</span><br><span class="hljs-keyword">for</span> Output <span class="hljs-keyword">in</span> $(ls)<br><span class="hljs-keyword">do</span><br>    cat <span class="hljs-string">&quot;<span class="hljs-variable">$Output</span>&quot;</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># Bash can also accept patterns, like this to `cat`</span><br><span class="hljs-comment"># all the Markdown files in current directory</span><br><span class="hljs-keyword">for</span> Output <span class="hljs-keyword">in</span> ./*.markdown<br><span class="hljs-keyword">do</span><br>    cat <span class="hljs-string">&quot;<span class="hljs-variable">$Output</span>&quot;</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># while loop:</span><br><span class="hljs-keyword">while</span> [ <span class="hljs-literal">true</span> ]<br><span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;loop body here...&quot;</span><br>    <span class="hljs-built_in">break</span><br><span class="hljs-keyword">done</span><br><span class="hljs-comment"># =&gt; loop body here...</span><br><br><span class="hljs-comment"># You can also define functions</span><br><span class="hljs-comment"># Definition:</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">foo</span></span> ()<br>&#123;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Arguments work just like script arguments: <span class="hljs-variable">$@</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;And: <span class="hljs-variable">$1</span> <span class="hljs-variable">$2</span>...&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;This is a function&quot;</span><br>    <span class="hljs-built_in">return</span> 0<br>&#125;<br><span class="hljs-comment"># Call the function `foo` with two arguments, arg1 and arg2:</span><br>foo arg1 arg2<br><span class="hljs-comment"># =&gt; Arguments work just like script arguments: arg1 arg2</span><br><span class="hljs-comment"># =&gt; And: arg1 arg2...</span><br><span class="hljs-comment"># =&gt; This is a function</span><br><br><span class="hljs-comment"># or simply</span><br><span class="hljs-function"><span class="hljs-title">bar</span></span> ()<br>&#123;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Another way to declare functions!&quot;</span><br>    <span class="hljs-built_in">return</span> 0<br>&#125;<br><span class="hljs-comment"># Call the function `bar` with no arguments:</span><br>bar <span class="hljs-comment"># =&gt; Another way to declare functions!</span><br><br><span class="hljs-comment"># Calling your function</span><br>foo <span class="hljs-string">&quot;My name is&quot;</span> <span class="hljs-variable">$Name</span><br><br><span class="hljs-comment"># There are a lot of useful commands you should learn:</span><br><span class="hljs-comment"># prints last 10 lines of file.txt</span><br>tail -n 10 file.txt<br><br><span class="hljs-comment"># prints first 10 lines of file.txt</span><br>head -n 10 file.txt<br><br><span class="hljs-comment"># sort file.txt&#x27;s lines</span><br>sort file.txt<br><br><span class="hljs-comment"># report or omit repeated lines, with -d it reports them</span><br>uniq -d file.txt<br><br><span class="hljs-comment"># prints only the first column before the &#x27;,&#x27; character</span><br>cut -d <span class="hljs-string">&#x27;,&#x27;</span> -f 1 file.txt<br><br><span class="hljs-comment"># replaces every occurrence of &#x27;okay&#x27; with &#x27;great&#x27; in file.txt</span><br><span class="hljs-comment"># (regex compatible)</span><br>sed -i <span class="hljs-string">&#x27;s/okay/great/g&#x27;</span> file.txt<br><span class="hljs-comment"># be aware that this -i flag means that file.txt will be changed</span><br><span class="hljs-comment"># -i or --in-place erase the input file (use --in-place=.backup to keep a back-up)</span><br><br><span class="hljs-comment"># print to stdout all lines of file.txt which match some regex</span><br><span class="hljs-comment"># The example prints lines which begin with &quot;foo&quot; and end in &quot;bar&quot;</span><br>grep <span class="hljs-string">&quot;^foo.*bar$&quot;</span> file.txt<br><br><span class="hljs-comment"># pass the option &quot;-c&quot; to instead print the number of lines matching the regex</span><br>grep -c <span class="hljs-string">&quot;^foo.*bar$&quot;</span> file.txt<br><br><span class="hljs-comment"># Other useful options are:</span><br>grep -r <span class="hljs-string">&quot;^foo.*bar$&quot;</span> someDir/ <span class="hljs-comment"># recursively `grep`</span><br>grep -n <span class="hljs-string">&quot;^foo.*bar$&quot;</span> file.txt <span class="hljs-comment"># give line numbers</span><br>grep -rI <span class="hljs-string">&quot;^foo.*bar$&quot;</span> someDir/ <span class="hljs-comment"># recursively `grep`, but ignore binary files</span><br><br><span class="hljs-comment"># perform the same initial search, but filter out the lines containing &quot;baz&quot;</span><br>grep <span class="hljs-string">&quot;^foo.*bar$&quot;</span> file.txt | grep -v <span class="hljs-string">&quot;baz&quot;</span><br><br><span class="hljs-comment"># if you literally want to search for the string,</span><br><span class="hljs-comment"># and not the regex, use `fgrep` (or `grep -F`)</span><br>fgrep <span class="hljs-string">&quot;foobar&quot;</span> file.txt<br><br><span class="hljs-comment"># The `trap` command allows you to execute a command whenever your script</span><br><span class="hljs-comment"># receives a signal. Here, `trap` will execute `rm` if it receives any of the</span><br><span class="hljs-comment"># three listed signals.</span><br><span class="hljs-built_in">trap</span> <span class="hljs-string">&quot;rm <span class="hljs-variable">$TEMP_FILE</span>; exit&quot;</span> SIGHUP SIGINT SIGTERM<br><br><span class="hljs-comment"># `sudo` is used to perform commands as the superuser</span><br><span class="hljs-comment"># usually it will ask interactively the password of superuser</span><br>NAME1=$(whoami)<br>NAME2=$(sudo whoami)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Was <span class="hljs-variable">$NAME1</span>, then became more powerful <span class="hljs-variable">$NAME2</span>&quot;</span><br><br><span class="hljs-comment"># Read Bash shell built-ins documentation with the bash `help` built-in:</span><br><span class="hljs-built_in">help</span><br><span class="hljs-built_in">help</span> <span class="hljs-built_in">help</span><br><span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span><br><span class="hljs-built_in">help</span> <span class="hljs-built_in">return</span><br><span class="hljs-built_in">help</span> <span class="hljs-built_in">source</span><br><span class="hljs-built_in">help</span> .<br><br><span class="hljs-comment"># Read Bash manpage documentation with `man`</span><br>apropos bash<br>man 1 bash<br>man bash<br><br><span class="hljs-comment"># Read info documentation with `info` (`?` for help)</span><br>apropos info | grep <span class="hljs-string">&#x27;^info.*(&#x27;</span><br>man info<br>info info<br>info 5 info<br><br><span class="hljs-comment"># Read bash info documentation:</span><br>info bash<br>info bash <span class="hljs-string">&#x27;Bash Features&#x27;</span><br>info bash 6<br>info --apropos bash<br></code></pre></td></tr></table></figure>

<h2 id="Tips-amp-amp-Tracks"><a href="#Tips-amp-amp-Tracks" class="headerlink" title="Tips &amp;&amp; Tracks"></a>Tips &amp;&amp; Tracks</h2><ul>
<li>set<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">&gt; <span class="hljs-builtin-name">set</span> 命令修改Shell环境的运行参数<br>  -x: <span class="hljs-builtin-name">Print</span> a trace of<span class="hljs-built_in"> simple </span>commands<br>  Using <span class="hljs-string">&#x27;+&#x27;</span> rather than <span class="hljs-string">&#x27;-&#x27;</span> causes these options <span class="hljs-keyword">to</span> be turned off.<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Refrence"><a href="#Refrence" class="headerlink" title="Refrence"></a>Refrence</h2><ul>
<li><a href="https://devhints.io/bash">Bash scripting cheatsheet</a></li>
<li><a href="https://linuxhint.com/bash_operator_examples/">74 Bash Operators Examples</a></li>
</ul>
]]></content>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Rust vs. Go</title>
    <url>/2021/10/09/Rust-vs-Go/</url>
    <content><![CDATA[<h2 id="When-to-use-Rust-and-when-to-use-Go"><a href="#When-to-use-Rust-and-when-to-use-Go" class="headerlink" title="When to use Rust and when to use Go"></a>When to use Rust and when to use Go</h2><span id="more"></span>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">Go has a stronger focus on building web APIs and small services that can scale endlessly, especially <span class="hljs-keyword">with</span> the power <span class="hljs-keyword">of</span> goroutines.</span><br><br><span class="hljs-meta">&gt;</span> <span class="javascript">Rust works well <span class="hljs-keyword">for</span> processing large amounts <span class="hljs-keyword">of</span> data and other CPU-intensive operations, such <span class="hljs-keyword">as</span> executing algorithms.</span><br></code></pre></td></tr></table></figure>

<h3 id="Gettting-started-Rust"><a href="#Gettting-started-Rust" class="headerlink" title="Gettting started Rust"></a>Gettting started Rust</h3><blockquote>
<p>Quickly set up a Rust development environment and write a small app!</p>
</blockquote>
<ul>
<li>Rustup<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">&gt; <span class="hljs-keyword">the</span> Rust installer <span class="hljs-keyword">and</span> <span class="hljs-built_in">version</span> management tool<br>➜ curl <span class="hljs-comment">--proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><br>info: downloading installer<br><br>Welcome <span class="hljs-keyword">to</span> Rust!<br><br>This will download <span class="hljs-keyword">and</span> install <span class="hljs-keyword">the</span> official compiler <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> Rust<br>programming language, <span class="hljs-keyword">and</span> <span class="hljs-keyword">its</span> package manager, Cargo.<br><br>Rustup metadata <span class="hljs-keyword">and</span> toolchains will be installed <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> Rustup<br>home directory, located <span class="hljs-keyword">at</span>:<br><br>  /home/chyiyaqing/.rustup<br><br>This can be modified <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> RUSTUP_HOME environment variable.<br><br>The Cargo home directory located <span class="hljs-keyword">at</span>:<br><br>  /home/chyiyaqing/.cargo<br><br>This can be modified <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> CARGO_HOME environment variable.<br><br>The cargo, rustc, rustup <span class="hljs-keyword">and</span> other commands will be added <span class="hljs-keyword">to</span><br>Cargo&#x27;s bin directory, located <span class="hljs-keyword">at</span>:<br><br>  /home/chyiyaqing/.cargo/bin<br><br>This path will <span class="hljs-keyword">then</span> be added <span class="hljs-keyword">to</span> your PATH environment variable <span class="hljs-keyword">by</span><br>modifying <span class="hljs-keyword">the</span> profile files located <span class="hljs-keyword">at</span>:<br><br>  /home/chyiyaqing/.profile<br>  /home/chyiyaqing/.bashrc<br>  /home/chyiyaqing/.zshenv<br><br>You can uninstall <span class="hljs-keyword">at</span> any <span class="hljs-built_in">time</span> <span class="hljs-keyword">with</span> rustup self uninstall <span class="hljs-keyword">and</span><br>these changes will be reverted.<br><br>Current installation options:<br><br><br>   default host triple: x86_64-unknown-linux-gnu<br>     default toolchain: stable (default)<br>               profile: default<br>  modify PATH variable: yes<br><br><span class="hljs-number">1</span>) Proceed <span class="hljs-keyword">with</span> installation (default)<br><span class="hljs-number">2</span>) Customize installation<br><span class="hljs-number">3</span>) Cancel installation<br><br><span class="hljs-comment"># rustup: Toolchain management</span><br>  - rustup update<br><br><span class="hljs-comment"># Cargo: the Rust build tool and package manager, used to install dependencies and manage the building, testing, running, and publishing of your project.</span><br>  - cargo build : build your project<br>  - cargo <span class="hljs-built_in">run</span>: <span class="hljs-built_in">run</span> your project<br>  - cargo test: test your project<br>  - cargo doc: build documentation <span class="hljs-keyword">for</span> your project<br>  - cargo publish: publish a library <span class="hljs-keyword">to</span> crates.io<br><br><span class="hljs-comment"># rustc: the Rust compiler</span><br>  &gt; rustc <span class="hljs-keyword">is</span> invoked indirectly <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> **cargo build** <span class="hljs-keyword">or</span> **cargo <span class="hljs-built_in">run</span>** commands.<br></code></pre></td></tr></table></figure></li>
<li>Toolchain overview<br><img src="/misc/images/rust-toolchain-overview.png" alt="Rust toolchain and ecosystem"><figure class="highlight tap"><table><tr><td class="code"><pre><code class="hljs tap">-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 cargo          -- package manager<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 cargo-clippy<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 cargo-fmt<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 cargo-miri<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 clippy-driver<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rls<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rustc          -- rust compiler<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rustdoc<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rustfmt<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rust-gdb<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rust-lldb<br>-rwxr-xr-x<span class="hljs-number"> 12 </span>chyiyaqing chyiyaqing 15M Oct <span class="hljs-number"> 9 </span>09:49 rustup         -- toolchain installer<br><br>creates.io                                                          -- package repository<br>docs.rs                                                             -- create documentation<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><ul>
<li><p>Go</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; Go take advantage <span class="hljs-keyword">of</span> the concurrency the <span class="hljs-keyword">language</span> offers. The <span class="hljs-keyword">language</span> provides goroutines that <span class="hljs-keyword">enable</span> run <span class="hljs-keyword">function</span> <span class="hljs-keyword">as</span> subprocesses.<br>&gt; Go concurrency model allows <span class="hljs-keyword">to</span> deploy workloads across multiple CPU cores, making it efficient <span class="hljs-keyword">language</span><br></code></pre></td></tr></table></figure></li>
<li><p>Rust</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><code class="hljs angelscript">&gt; Rust <span class="hljs-keyword">is</span> more efficient <span class="hljs-keyword">in</span> execution algorithms <span class="hljs-keyword">and</span> resource-<span class="hljs-built_in">int</span>ensive operations.<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h3><ul>
<li><p>Go</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">&gt; Go support concurrency.<br>&gt; For example, yo<span class="hljs-string">u&#x27;re running a web server that handles API requests. use Go&#x27;</span>s goroutines to run each request <span class="hljs-keyword">as</span> a subprocess, maximizing efficiency by offloading tasks to <span class="hljs-built_in">all</span> available CPU cores.<br><br></code></pre></td></tr></table></figure></li>
<li><p>Rust</p>
<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
<li><p>Channel</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css">&gt; <span class="hljs-selector-tag">A</span> channel helps transfer <span class="hljs-selector-tag">a</span> message <span class="hljs-selector-tag">from</span> one thread <span class="hljs-selector-tag">to</span> another.<br></code></pre></td></tr></table></figure></li>
<li><p>Lock</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; Data <span class="hljs-keyword">is</span> <span class="hljs-keyword">only</span> accessible <span class="hljs-keyword">when</span> the <span class="hljs-keyword">lock</span> <span class="hljs-keyword">is</span> held. Rust relies <span class="hljs-keyword">on</span> the principle <span class="hljs-keyword">of</span> locking data <span class="hljs-keyword">instead</span> <span class="hljs-keyword">of</span> cod<br></code></pre></td></tr></table></figure></li>
<li><p>Memory safety</p>
<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="https://blog.logrocket.com/getting-up-to-speed-with-rust/">Getting up to speed with Rust</a></li>
<li><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/rust-go.html">基准测试</a></li>
<li><a href="https://bitbucket.org/blog/why-rust">Bitbucket</a></li>
<li><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/rust-go.html">bechmarksgame</a></li>
<li><a href="https://blog.rust-lang.org/2015/04/10/Fearless-Concurrency.html">可证明正确的并发</a></li>
<li><a href="https://doc.rust-lang.org/stable/rust-by-example/std_misc/channels.html">通道</a></li>
<li><a href="https://doc.rust-lang.org/std/primitive.pointer.html">指针</a></li>
<li><a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html">锁</a></li>
<li><a href="https://blog.rust-lang.org/2015/04/10/Fearless-Concurrency.html">使用Rust进行无所畏惧的并发</a></li>
<li><a href="https://en.wikipedia.org/wiki/Type_safety">类型安全</a></li>
<li><a href="https://kristoff.it/blog/why-go-and-not-rust/">Loris Cro</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>In Memory of Steve Jobs</title>
    <url>/2021/10/10/In-Memory-of-Steve-Jobs/</url>
    <content><![CDATA[<h1 id="Steve-Jobs"><a href="#Steve-Jobs" class="headerlink" title="Steve Jobs"></a>Steve Jobs</h1><span id="more"></span>
<p><img src="/misc/images/steve-jobs/In-memory-of-Steve-Jobs.jpg" alt="Steve Jobs"></p>
]]></content>
  </entry>
  <entry>
    <title>Vim Tips &amp; Tracks</title>
    <url>/2021/10/10/Vim-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="Why-I-Still-Use-Vim"><a href="#Why-I-Still-Use-Vim" class="headerlink" title="Why I Still Use Vim"></a>Why I Still Use Vim</h1><ul>
<li>Vim is exists on all Unix systems, support all file formats and programming languages</li>
<li>Mouse free navigation</li>
<li>Vim is very light-weight and fast.</li>
<li>Vim is highly configurable. (~/.vimrc)</li>
<li>Memory Usage Low</li>
<li>Startup Time short</li>
</ul>
<span id="more"></span>

<h2 id="Installing"><a href="#Installing" class="headerlink" title="Installing"></a>Installing</h2><figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">&gt; Since VIM comes <span class="hljs-keyword">pre</span>-installed <span class="hljs-keyword">on</span> <span class="hljs-keyword">a</span> <span class="hljs-keyword">number</span> of *nix systems, <span class="hljs-keyword">let</span><span class="hljs-string">&#x27;s first check to see if it&#x27;</span>s installed<br>  $ <span class="hljs-keyword">vim</span> --<span class="hljs-keyword">version</span><br><br># *NIX/Linux (Debian <span class="hljs-built_in">or</span> Ubuntu)<br>  $ sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-built_in">remove</span> <span class="hljs-keyword">vim</span>-tiny<br>  $ sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-keyword">update</span><br>  $ sudo apt-<span class="hljs-built_in">get</span> install <span class="hljs-keyword">vim</span><br></code></pre></td></tr></table></figure>
<ul>
<li><p>VIM Extensions</p>
<ul>
<li>vim-plug<blockquote>
<p>Minimalist Vim Plugin Manager</p>
</blockquote>
</li>
</ul>
<figure class="highlight pony"><table><tr><td class="code"><pre><code class="hljs pony"><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">&quot; junegunn/vim-plug -- 🌺  Minimalist Vim Plugin Manager</span><br><span class="hljs-string">&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="hljs-string">&quot;&quot;&quot;&quot;&quot;&quot;</span><br><span class="hljs-keyword">if</span> empty(glob(<span class="hljs-string">&#x27;~/.vim/autoload/plug.vim&#x27;</span>))<br>  silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs<br>   \ https:<span class="hljs-comment">//raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim</span><br>  autocmd <span class="hljs-type">VimEnter</span> * <span class="hljs-type">PlugInstall</span> --sync | source $<span class="hljs-type">MYVIMRC</span><br>endif<br><br><span class="hljs-string">&quot; vim-plug configuration</span><br><span class="hljs-string">&quot;</span> <span class="hljs-type">For</span> <span class="hljs-type">Mac</span>/<span class="hljs-type">Linux</span> users<br><span class="hljs-string">&quot; Plugins will be download under the specified directory.</span><br><span class="hljs-string">call plug#begin(&#x27;~/.vim/plugged&#x27;)</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;</span><span class="hljs-type">List</span> ends here. <span class="hljs-type">Plugins</span> become visible to <span class="hljs-type">Vim</span> after <span class="hljs-literal">this</span> call.<br>call plug#<span class="hljs-keyword">end</span>()<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Vim-Tips"><a href="#Vim-Tips" class="headerlink" title="Vim Tips"></a>Vim Tips</h2><ul>
<li><strong>Pro Tip #1</strong>: Make sure to utilize tab completion to find files after typing</li>
<li><strong>Pro Tip #2</strong>: Specify different areas of the screen where the splits should occur by adding the following lines to the .vimrc file<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">set</span> splitbelow<br><span class="hljs-builtin-name">set</span> splitright<br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #3</strong>: Jump between splits with just one key combination<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"><span class="hljs-comment">&quot; split navigations</span><br><span class="hljs-keyword">nnoremap</span> <span class="hljs-symbol">&lt;C-J&gt;</span> <span class="hljs-symbol">&lt;C-W&gt;</span><span class="hljs-symbol">&lt;C-J&gt;</span><br><span class="hljs-keyword">nnoremap</span> <span class="hljs-symbol">&lt;C-K&gt;</span> <span class="hljs-symbol">&lt;C-W&gt;</span><span class="hljs-symbol">&lt;C-K&gt;</span><br><span class="hljs-keyword">nnoremap</span> <span class="hljs-symbol">&lt;C-L&gt;</span> <span class="hljs-symbol">&lt;C-W&gt;</span><span class="hljs-symbol">&lt;C-L&gt;</span><br><span class="hljs-keyword">nnoremap</span> <span class="hljs-symbol">&lt;C-H&gt;</span> <span class="hljs-symbol">&lt;C-W&gt;</span><span class="hljs-symbol">&lt;C-H&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #4</strong>: Buffers<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"># :<span class="hljs-keyword">ls</span> - <span class="hljs-keyword">to</span> <span class="hljs-keyword">list</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">buffers</span><br># :<span class="hljs-keyword">b</span> &lt;<span class="hljs-keyword">buffer</span> <span class="hljs-keyword">number</span>&gt; - pick the <span class="hljs-keyword">buffer</span> immediately<br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #5</strong>: Code Folding<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"># Collapse (<span class="hljs-built_in">or</span> <span class="hljs-keyword">fold</span>) methods <span class="hljs-built_in">and</span> classes<br><span class="hljs-comment">&quot; Enable folding</span><br><span class="hljs-keyword">set</span> foldmethod=<span class="hljs-built_in">indent</span><br><span class="hljs-keyword">set</span> <span class="hljs-built_in">foldlevel</span>=<span class="hljs-number">99</span><br><br><span class="hljs-comment">&quot; Enable folding with the spacebar</span><br><span class="hljs-keyword">nnoremap</span> <span class="hljs-symbol">&lt;space&gt;</span> za<br><br># VimL Script<br>plug <span class="hljs-string">&quot;tmhedberg/SimpylFold&quot;</span><br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">g:SimpylFold_docstring_preview</span>=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #6</strong>: PEP 8<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"><span class="hljs-comment">&quot; Add the proper PEP 8 indentation</span><br><span class="hljs-keyword">au</span> BufNewFile,BufRead *.<span class="hljs-keyword">py</span><br>    \ <span class="hljs-keyword">set</span> tabstop=<span class="hljs-number">4</span><br>    \ <span class="hljs-keyword">set</span> softtabstop=<span class="hljs-number">4</span><br>    \ <span class="hljs-keyword">set</span> <span class="hljs-built_in">shiftwidth</span>=<span class="hljs-number">4</span><br>    \ <span class="hljs-keyword">set</span> textwidth=<span class="hljs-number">79</span><br>    \ <span class="hljs-keyword">set</span> expandtab<br>    \ <span class="hljs-keyword">set</span> autoindent<br>    \ <span class="hljs-keyword">set</span> fileformat=unix<br><br><span class="hljs-comment">&quot; full stack development</span><br><span class="hljs-keyword">au</span> BufNewFile,BufRead *.js, *.html, *.css<br>    \ <span class="hljs-keyword">set</span> tabstop=<span class="hljs-number">2</span><br>    \ <span class="hljs-keyword">set</span> softtabstop=<span class="hljs-number">2</span><br>    \ <span class="hljs-keyword">set</span> <span class="hljs-built_in">shiftwidth</span>=<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #7</strong>: Flagging Unnecessary Whitespace<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">au</span> BufRead,BufNewFile <span class="hljs-regexp">*.py</span>,<span class="hljs-regexp">*.pyw</span>,<span class="hljs-regexp">*.c</span>,<span class="hljs-regexp">*.h</span> match BadWhitespace /\s\+$/<br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #8</strong>: UTF-8 Support<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">set</span> <span class="hljs-attribute">encoding</span>=utf-8<br></code></pre></td></tr></table></figure></li>
<li><strong>Pro Tip #9</strong>: Syntax Checking/Highlighting<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"># <span class="hljs-keyword">check</span> syntax <span class="hljs-keyword">on</span> <span class="hljs-keyword">each</span> save <span class="hljs-keyword">with</span> the syntastic <span class="hljs-keyword">extension</span><br>Plug <span class="hljs-string">&#x27;vim-syntastic/syntastic&#x27;</span><br><br># <span class="hljs-keyword">add</span> PEP <span class="hljs-number">8</span> checking <span class="hljs-keyword">with</span> this nifty little plugin<br>Plug <span class="hljs-string">&#x27;nvie/vim-flake8&#x27;</span><br><br>let python_highlight_all=<span class="hljs-number">1</span><br>syntax <span class="hljs-keyword">on</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="File-Browsing"><a href="#File-Browsing" class="headerlink" title="File Browsing"></a>File Browsing</h3><ul>
<li>NERDTree<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; File <span class="hljs-keyword">system</span> explorer <span class="hljs-keyword">for</span> the Vim. It enables you <span class="hljs-keyword">to</span> visually browse complex directory hierarchies, quickly <span class="hljs-keyword">open</span> files <span class="hljs-keyword">for</span> reading <span class="hljs-keyword">or</span> editing, <span class="hljs-keyword">and</span> <span class="hljs-keyword">perform</span> basic file <span class="hljs-keyword">system</span> operations.<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="Super-Searching"><a href="#Super-Searching" class="headerlink" title="Super Searching"></a>Super Searching</h3><ul>
<li>ctrlP<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">Plug <span class="hljs-string">&#x27;kien/ctrlp.vim&#x27;</span><br><br>Ctrl + P : <span class="hljs-keyword">enable</span> the <span class="hljs-keyword">search</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Using-Vim-for-Python-Development"><a href="#Using-Vim-for-Python-Development" class="headerlink" title="Using Vim for Python Development"></a>Using Vim for Python Development</h2><ul>
<li>Verifying VIM Install<figure class="highlight coffeescript"><table><tr><td class="code"><pre><code class="hljs coffeescript">Make sure have installed VIM &gt; <span class="hljs-number">7.3</span> <span class="hljs-keyword">with</span> Python support.<br><br>  :python3 <span class="hljs-keyword">import</span> sys; <span class="hljs-built_in">print</span>(sys.version)<br>  <span class="hljs-number">3.8</span><span class="hljs-number">.10</span> (<span class="hljs-keyword">default</span>, Sep <span class="hljs-number">28</span> <span class="hljs-number">2021</span>, <span class="hljs-number">16</span>:<span class="hljs-number">10</span>:<span class="hljs-number">42</span>)<br>  [GCC <span class="hljs-number">9.3</span><span class="hljs-number">.0</span>]<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Using-Vim-for-Go-Development"><a href="#Using-Vim-for-Go-Development" class="headerlink" title="Using Vim for Go Development"></a>Using Vim for Go Development</h2><ul>
<li>vim-go<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">&gt; Go development plugin <span class="hljs-keyword">for</span> Vim. It has everything you need <span class="hljs-keyword">for</span> Go development.<br><br>:GoBuild - Compile package<br>:GoInstall - Install <span class="hljs-keyword">it</span><br>:GoTest - Test <span class="hljs-keyword">it</span><br>:GoRun - Quickly execute current <span class="hljs-built_in">file</span><br>:GoDef - Go <span class="hljs-keyword">to</span> symbol/declaration<br>:GoDoc - look up documentation<br>:GoDocBrowser -<br><br><span class="hljs-comment"># Auto Completion</span><br>  &gt; It&#x27;s really hard <span class="hljs-keyword">to</span> code <span class="hljs-keyword">without</span> auto-completion <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> being able <span class="hljs-keyword">to</span> going <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> definition.<br>  &gt; Vim-go use **gopls** <span class="hljs-keyword">for</span> completion etc. Completion(Ctrl-x Ctrl-p) <span class="hljs-keyword">is</span> enabled <span class="hljs-keyword">by</span> default via omnifunc.<br><br>  <span class="hljs-comment"># check if vim-go has been configured correctly for autocompletetion</span><br>  :verbose setlocal omnifunc?<br><br>  <span class="hljs-comment"># autocomplete prompt to appear automatically whenever you press the dot(.)</span><br>  au filetype go inoremap &lt;buffer&gt; . .&lt;C-x&gt;&lt;C-o&gt;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Vim-and-Rust"><a href="#Vim-and-Rust" class="headerlink" title="Vim and Rust"></a>Vim and Rust</h2><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://www.amazon.com/Practical-Vim-Edit-Speed-Thought/dp/1680501275/ref=as_li_ss_tl?ie=UTF8&qid=1501817867&sr=8-3&keywords=vim&linkCode=sl1&tag=caspbeye-20&linkId=6c394064b4e6f05b198e68c64a6f4d76">Practical Vim - Edit Text at the Speed of Thought</a></li>
<li><a href="http://vimcasts.org/">VIM CASTS.org</a></li>
<li><a href="https://realpython.com/vim-and-python-a-match-made-in-heaven/">VIM and Python - A Match Made in Heaven</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>XMind Intro</title>
    <url>/2021/10/10/XMind-Intro/</url>
    <content><![CDATA[<h1 id="XMind"><a href="#XMind" class="headerlink" title="XMind"></a>XMind</h1><blockquote>
<p>XMind是风靡全球的思维导图和头脑风暴软件.作为学习、工作、生活的效率工具.<br>XMind思维导图是一个可视化的图形思维工具.</p>
</blockquote>
<span id="more"></span>

<h2 id="主题类型"><a href="#主题类型" class="headerlink" title="主题类型"></a>主题类型</h2><ul>
<li><p>中心主题</p>
<blockquote>
<p>中心主题是导图的核心也是画布的中心，每张思维导图有且仅由一个中心主题</p>
</blockquote>
</li>
<li><p>分支主题</p>
<blockquote>
<p>中心主题发散出来的第一级主题为分支主题</p>
</blockquote>
</li>
<li><p>子主题</p>
<blockquote>
<p>分支主题发散出来的下一级主题为子主题</p>
</blockquote>
</li>
<li><p>自由主题</p>
<blockquote>
<p>自由主题是在思维导图结构外独立存在的主题</p>
</blockquote>
</li>
</ul>
<p>  <img src="/misc/images/xmind-point.jpg" alt="主题类型"></p>
<h2 id="逻辑元素"><a href="#逻辑元素" class="headerlink" title="逻辑元素"></a>逻辑元素</h2><ul>
<li><p>联系</p>
<blockquote>
<p>思维导图中任意两个主题之间用于显示特殊关系的自定义连接线</p>
</blockquote>
</li>
<li><p>概要</p>
<blockquote>
<p>当对几个主题进行总结和概述，进一步对主题进行总结和升华时，可以添加概要</p>
</blockquote>
</li>
<li><p>外框</p>
<blockquote>
<p>围绕主题的封闭区域</p>
</blockquote>
</li>
<li><p>笔记</p>
<blockquote>
<p>笔记用于注释主题的富文本</p>
</blockquote>
</li>
</ul>
<h2 id="逻辑结构"><a href="#逻辑结构" class="headerlink" title="逻辑结构"></a>逻辑结构</h2><ul>
<li><p>思维导图</p>
<blockquote>
<p>发散和纵深思考</p>
</blockquote>
</li>
<li><p>鱼骨图</p>
<blockquote>
<p>比较清晰地表达因果关系</p>
</blockquote>
</li>
<li><p>矩阵图</p>
<blockquote>
<p>用来左项目的任务管理或者个人的技术</p>
</blockquote>
</li>
<li><p>时间轴</p>
<blockquote>
<p>表示事件顺序或者事情的先后逻辑</p>
</blockquote>
</li>
<li><p>组织结构图</p>
<blockquote>
<p>可以做组织层次的人员构成</p>
</blockquote>
</li>
<li><p>逻辑图</p>
<blockquote>
<p>表达总分关系或分总关系</p>
</blockquote>
</li>
</ul>
]]></content>
      <tags>
        <tag>思维导图</tag>
        <tag>头脑风暴</tag>
      </tags>
  </entry>
  <entry>
    <title>Go Web Framework</title>
    <url>/2021/10/11/Go-Web-Framework/</url>
    <content><![CDATA[<h1 id="Go-Web-Frameworks"><a href="#Go-Web-Frameworks" class="headerlink" title="Go Web Frameworks"></a>Go Web Frameworks</h1><ul>
<li>Web框架分类<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 运行性能:</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 追求性能的框架很简洁，包含东西很少，一个路由一个MVC, 比如Gin</span><br><span class="hljs-meta"></span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 开发效率:</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 封装很好，集成很多功能, 比如Beego</span><br></code></pre></td></tr></table></figure></li>
<li>Web框架选型<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 对于中小型项目，开发效率往往是业务的第一需求, 任何领域做到第一名的产品基本上都有一个共性: 开发、迭代速度快<br><span class="hljs-bullet">2.</span> 好的框架要能区分清楚业务团队和架构团队的边界，什么应该是业务负责，什么应该是架构负责,<br><span class="hljs-bullet">3.</span> 架构是为加速业务发展而生，需要兼顾业务的开发效率和底层的性能效率<br></code></pre></td></tr></table></figure>
<span id="more"></span></li>
</ul>
<h2 id="Go-语言特性"><a href="#Go-语言特性" class="headerlink" title="Go 语言特性"></a>Go 语言特性</h2><ul>
<li>Goroutine<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">Goroutine设计，提供“一个请求一个协程”的请求模型.对比PHP的“一个请求一个进程”的模型，提升后端资源占用和调度负载。<br></code></pre></td></tr></table></figure></li>
<li>Runtime<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">Go的<span class="hljs-keyword">Runtime</span>机制让运行程序不再依赖各种环境和库<br></code></pre></td></tr></table></figure></li>
<li>compile<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs">Go提供交叉编译、数据结构、channel等语言级别提醒，让处理Web请求变得简单<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="First-Step"><a href="#First-Step" class="headerlink" title="First Step:"></a>First Step:</h2><ul>
<li>net, net/http<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Web Server</span><br> &gt; Web Server的本质，实际上就是接收、解析HTTP请求传输的文本字符，理解这些文本字符的指令，然后计算、在将返回值组织成HTTP响应的文本字符，通过TCP网络输出回去<br> &gt; 是一个通过HTTP协议处理Web请求的计算机系统<br><span class="hljs-bullet">  -</span> HTTP协议: 超文本传输协议<br><span class="hljs-bullet">    -</span> HTTP Head: 描述一般是和业务无关与传输相关的信息(请求地址、编码格式、缓存时长)<br><span class="hljs-bullet">    -</span> HTTP Body: 描述的是与业务相关的信息<br><span class="hljs-section"># net 库</span><br>  &gt; 对应OSI的TCP层<br><br><span class="hljs-section"># net/http库</span><br>  &gt; 对应OSI的HTTP层, 解析HTTP消息体<br><br><span class="hljs-section"># net/http 标准库源代码</span><br>  &gt; 阅读代码库的技巧: 库函数(function) &gt; 结构定义(struct/class) &gt; 结构函数(method)<br><span class="hljs-bullet">    -</span> 库函数: 这个库要提供的功能<br><span class="hljs-bullet">    -</span> 结构定义: 这个库分为几个核心模块<br><span class="hljs-bullet">    -</span> 结构函数: 每个核心模块应该提供的能力<br></code></pre></td></tr></table></figure></li>
<li>context</li>
<li>router</li>
<li>middleware</li>
<li>encapsulation</li>
<li>restart</li>
</ul>
<h2 id="Second-Step"><a href="#Second-Step" class="headerlink" title="Second Step:"></a>Second Step:</h2><ul>
<li>面向接口编程</li>
<li>设计目录结构</li>
<li>命令行交互</li>
<li>定时任务</li>
<li>配置和环境</li>
<li>多输出日志</li>
</ul>
<h2 id="Third-Step"><a href="#Third-Step" class="headerlink" title="Third Step:"></a>Third Step:</h2><ul>
<li>一体化、自动化</li>
<li>调试模式</li>
<li>进程、接口管理</li>
<li>GORM</li>
<li>缓存服务</li>
<li>发布与维护</li>
</ul>
<h2 id="Fourth-Step"><a href="#Fourth-Step" class="headerlink" title="Fourth Step:"></a>Fourth Step:</h2><ul>
<li>设计需求分析</li>
<li>技术方案设计</li>
<li>网站统计服务</li>
<li>一站式前后台</li>
</ul>
<h3 id="毒鸡汤"><a href="#毒鸡汤" class="headerlink" title="毒鸡汤"></a>毒鸡汤</h3><figure class="highlight node-repl"><table><tr><td class="code"><pre><code class="hljs node-repl"><span class="hljs-meta">&gt;</span> <span class="javascript">了解一个东西最好的办法就是去实现它</span><br></code></pre></td></tr></table></figure>


<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://github.com/valyala/fasthttp">High Performance FastHTTP</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Tech Interview Handbook</title>
    <url>/2021/10/11/Tech-Interview-Handbook/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Uber Zap Intro</title>
    <url>/2021/10/12/Uber-Zap-Intro/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Apache APISIX Intro</title>
    <url>/2021/10/13/Apache-APISIX-Intro/</url>
    <content><![CDATA[<h1 id="Apache-APISIX"><a href="#Apache-APISIX" class="headerlink" title="Apache APISIX"></a>Apache APISIX</h1><blockquote>
<p>云原生微服务API网关，高性能、安全性、开源可扩展的服务平台<br>APISIX 基于Nginx, Etcd.与传统的API 网关相比，具有动态路由和热插拔加载，适合微服务系统下的API管理.</p>
</blockquote>
<span id="more"></span>

<h2 id="API-Gateway"><a href="#API-Gateway" class="headerlink" title="API Gateway"></a>API Gateway</h2><blockquote>
<p>API网关将微服务的通用功能作为中间层, 比如统计、安全、限速、限流和缓存,这样每个服务只需要关注自己的业务，无关的需求被抛给API网关.</p>
</blockquote>
<ul>
<li>Traditional vs. Cloud Native<figure class="highlight less"><table><tr><td class="code"><pre><code class="hljs less"># 传统的<span class="hljs-selector-tag">API</span>网关功能<br>  <span class="hljs-selector-tag">-</span> 覆盖了<span class="hljs-selector-tag">Nginx</span>所有的功能, 包括 <span class="hljs-selector-tag">reverse</span> <span class="hljs-selector-tag">proxy</span>(反向代理)、<span class="hljs-selector-tag">load</span> <span class="hljs-selector-tag">balancing</span>(负载均衡)、<span class="hljs-selector-tag">caching</span>(缓存)、<span class="hljs-selector-tag">secure</span> <span class="hljs-selector-tag">authentication</span>(安全认证)、<span class="hljs-selector-tag">rate-limiting</span>(限流)、<span class="hljs-selector-tag">speed-limiting</span>(限速).<br>  <span class="hljs-selector-tag">-</span> 支持传统的<span class="hljs-selector-tag">Web</span>服务无法实现的功能，比如<span class="hljs-selector-tag">dynamic</span> <span class="hljs-selector-tag">upstream</span>(动态上行)、<span class="hljs-selector-tag">dynamic</span> <span class="hljs-selector-tag">SSL</span> <span class="hljs-selector-tag">certificate</span>(动态SSL证书)、<span class="hljs-selector-tag">dynamic</span> <span class="hljs-selector-tag">rate-limiting</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">speed-limiting</span>(动态限流限速)、<span class="hljs-selector-tag">active</span>/<span class="hljs-selector-tag">passive</span> <span class="hljs-selector-tag">health</span> <span class="hljs-selector-tag">check</span>(主动/被动健康检查)、<span class="hljs-selector-tag">service</span> <span class="hljs-selector-tag">disconnection</span>(服务断线)。<br>  <span class="hljs-selector-tag">-</span> 提供生命周期管理,在<span class="hljs-selector-tag">API</span>网关领域，<span class="hljs-selector-tag">Google</span>是最大的参与者，<span class="hljs-selector-tag">Google</span>在收购<span class="hljs-selector-tag">Apigee</span>后，整合了除反向代理、负载均衡、限流限速功能外，<span class="hljs-selector-tag">API</span>网关还包括<span class="hljs-selector-tag">API</span>的设计、文件管理和测试.从项目设计到产品测试一系列功能都包含在<span class="hljs-selector-tag">API</span>网关的生命周期管理中.<br><br># 云原生下<span class="hljs-selector-tag">API</span>网关的新特性<br>  <span class="hljs-selector-tag">-</span> 需要对接云环境下的<span class="hljs-selector-tag">Prometheus</span>(系统监控报警组件)、<span class="hljs-selector-tag">Zipkin</span>(分布式日志追踪系统)、<span class="hljs-selector-tag">Skywalking</span>(观察性分析平台和应用程序性能管理系统).<br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">gRPC</span> 代理和协议转换(REST &lt;=&gt; gRPC). 现在<span class="hljs-selector-tag">HTTP</span>在微服务中使用较少，开始使用<span class="hljs-selector-tag">gRPC</span><br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">identify</span> <span class="hljs-selector-tag">authentication</span>(身份认证的变化): 在传统的<span class="hljs-selector-tag">Nginx</span>中，一般流量进来之后，根据路由规则执行反向代理和负载均衡的功能，发送流量的客户端的身份很少经过身份验证，但是在云原生计算中，由于很多流量都在微服务中，必须进行严格的身份认证，包括加密和<span class="hljs-selector-tag">OpenID</span><br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Serverless</span>今年来非常有名的概念，如果你想在边缘节点动态运行一个函数或停止一个函数.或者动态改变内容，可以在边缘节点部署<span class="hljs-selector-tag">API</span>网关,使用<span class="hljs-selector-tag">FaaS</span>(Function as a Service),边缘节点将更加灵活. <span class="hljs-selector-tag">Apache</span> <span class="hljs-selector-tag">APISIX</span>最近支持<span class="hljs-selector-tag">Serverless</span>,可以让<span class="hljs-selector-tag">Lua</span>函数在边缘节点动态运行.<br>  <span class="hljs-selector-tag">-</span> 保持无状态，动态缩容/扩容的功能,云原生计算下的一个重要标准是所有的服务都可以通过容器随意扩容和缩容对<span class="hljs-selector-tag">Kubernetes</span>友好.<br>  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Support</span> <span class="hljs-selector-tag">multiple</span> <span class="hljs-selector-tag">clouds</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">hybrid</span> <span class="hljs-selector-tag">clouds</span>.<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="Nginx-vs-OpenResty"><a href="#Nginx-vs-OpenResty" class="headerlink" title="Nginx vs OpenResty"></a>Nginx vs OpenResty</h3><ul>
<li>Nginx<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; A high performance free <span class="hljs-keyword">open</span> source web <span class="hljs-keyword">server</span> powering busiest sites <span class="hljs-keyword">on</span> the Internet.<br>&gt; nginx [engine x] <span class="hljs-keyword">is</span> an HTTP <span class="hljs-keyword">and</span> <span class="hljs-keyword">reverse</span> proxy <span class="hljs-keyword">server</span>, <span class="hljs-keyword">as</span> well <span class="hljs-keyword">as</span> a mail proxy <span class="hljs-keyword">server</span><br></code></pre></td></tr></table></figure></li>
<li>OpenResty<figure class="highlight less"><table><tr><td class="code"><pre><code class="hljs less">&gt; <span class="hljs-selector-tag">OpenResty</span> (aka. ngx_openresty) <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">full-fledged</span>(成熟)的<span class="hljs-selector-tag">web</span>应用程序服务器,基于标准的<span class="hljs-selector-tag">Nginx</span>核心和许多第三方<span class="hljs-selector-tag">Nginx</span>模块以及第三方外部依赖.<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://medium.com/@ming_wen/apache-apisixs-technology-selection-testing-and-continuous-integration-313221b02542">Apache APISIX’s technology selection,testing and continuous integration</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Apple Silicon M1 New product experience</title>
    <url>/2021/10/15/Apple-Silicon-M1-New-product-experience/</url>
    <content><![CDATA[<h1 id="Apple-Silicon-M1-MacBook-Pro"><a href="#Apple-Silicon-M1-MacBook-Pro" class="headerlink" title="Apple Silicon M1 MacBook Pro"></a>Apple Silicon M1 MacBook Pro</h1><blockquote>
<p>“Ths best way to predict the future is to invent it” - Alan Kay</p>
</blockquote>
<p><img src="/misc/images/macbookpro" alt="MacBook Pro"></p>
<span id="more"></span>

<h2 id="Apple-switching-Mac-to-ARM-Architecture"><a href="#Apple-switching-Mac-to-ARM-Architecture" class="headerlink" title="Apple switching Mac to ARM Architecture"></a>Apple switching Mac to ARM Architecture</h2><ul>
<li>Pros and Cons 优缺点<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># Pros优点</span><br>  - <span class="hljs-number">1</span>. ARM processors use significantly less amount of power<br>  - <span class="hljs-number">2</span>. MacOS is based on the [Darwin](https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/apple/</span>darwin-xnu)<br><br><span class="hljs-comment"># Cons缺点</span><br>  - [<span class="hljs-string">&quot;Hackintosh&quot;</span>](https:<span class="hljs-regexp">//</span>hackintosh.com/) future will be doomed.<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="ARM64-amp-amp-Intel-x86-Virtual-Machines"><a href="#ARM64-amp-amp-Intel-x86-Virtual-Machines" class="headerlink" title="ARM64 &amp;&amp; Intel x86 Virtual Machines"></a>ARM64 &amp;&amp; Intel x86 Virtual Machines</h2><ul>
<li>ARM64<figure class="highlight delphi"><table><tr><td class="code"><pre><code class="hljs delphi">&gt; Apple Silicon <span class="hljs-keyword">is</span> an ARM <span class="hljs-keyword">platform</span> (RISC)<br></code></pre></td></tr></table></figure></li>
<li>Intel x86<figure class="highlight delphi"><table><tr><td class="code"><pre><code class="hljs delphi">&gt; Intel x86 <span class="hljs-keyword">is</span> a CISC <span class="hljs-keyword">platform</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="How-to-run-x86-Virtual-Machine-on-Apple-M1"><a href="#How-to-run-x86-Virtual-Machine-on-Apple-M1" class="headerlink" title="How to run x86 Virtual Machine on Apple M1"></a>How to run x86 Virtual Machine on Apple M1</h2><ul>
<li>Virtualization or Emulation<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> Virtualization:</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 创建虚拟的副本(虚拟硬件和设备、存储设备和网络资源)</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Emulation:</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> (<span class="hljs-built_in">emulate</span> different CPU architecture ) 模拟不同的CPU架构</span><br><br>  - QEMU : a king of emulation<br>  - UTM : emulation and virtualization solution<br></code></pre></td></tr></table></figure></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Harbor Intro</title>
    <url>/2021/10/15/Harbor-Intro/</url>
    <content><![CDATA[<h1 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h1><blockquote>
<p>Kubernetes 值得信赖的云原生镜像存储库(Image Registry)</p>
</blockquote>
<span id="more"></span>

<h2 id="Prerequisties"><a href="#Prerequisties" class="headerlink" title="Prerequisties"></a>Prerequisties</h2><ul>
<li>Domain mapped to A record to get letsencrypt certificate</li>
<li>Internet connection to the server.</li>
<li>Latest version of docker and docker-compose installed.</li>
</ul>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2>  <figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># update package repository</span><br>$ sudo apt update<br><br><span class="hljs-comment"># install the certificate</span><br>$ sudo apt install certbot -y<br><br><span class="hljs-comment"># generate a sertificate (Using domain name and email)</span><br>❯ sudo certbot certonly --standalone -d <span class="hljs-string">&quot;harbor.chyidl.com&quot;</span> --preferred-challenges http --agree-tos -n -m <span class="hljs-string">&quot;xxx@gmail.com&quot;</span> --keep-until-expiring<br>Saving debug log to <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/letsencrypt/</span>letsencrypt.log<br>Plugins selected: Authenticator standalone, Installer None<br>Obtaining a new certificate<br>Performing the following challenges:<br>http-<span class="hljs-number">01</span> challenge <span class="hljs-keyword">for</span> harbor.xx.com<br>Waiting <span class="hljs-keyword">for</span> verification...<br>Cleaning up challenges<br><br>IMPORTANT NOTES:<br> - Congratulations! Your certificate and chain have been saved at:<br> -    <span class="hljs-regexp">/etc/</span>letsencrypt<span class="hljs-regexp">/live/</span>harbor.xx.com/fullchain.pem<br> -    Your key file has been saved at:<br> -    <span class="hljs-regexp">/etc/</span>letsencrypt<span class="hljs-regexp">/live/</span>harbor.xx.com/privkey.pem<br> -    Your cert will expire on <span class="hljs-number">2022</span>-<span class="hljs-number">01</span>-<span class="hljs-number">15</span>. To obtain a new or tweaked<br> -    version of this certificate <span class="hljs-keyword">in</span> the future, simply run certbot<br> -    again. To non-interactively renew *all* of your certificates, run<br> -    <span class="hljs-string">&quot;certbot renew&quot;</span><br> -    - If you like Certbot, please consider supporting our work by:<br>   Donating to ISRG <span class="hljs-regexp">/ Let&#x27;s Encrypt:   https:/</span><span class="hljs-regexp">/letsencrypt.org/</span>donate<br>      Donating to EFF:                    https:<span class="hljs-regexp">//</span>eff.org/donate-le<br><br><span class="hljs-comment"># certificate are generated in /etc/letsencrypt/live/harbor.xxx.com/</span><br>root <span class="hljs-keyword">in</span> unreal-pod-<span class="hljs-number">1</span> <span class="hljs-keyword">in</span> ~/Downloads took <span class="hljs-number">8</span>s<br>❯ cd <span class="hljs-regexp">/etc/</span>letsencrypt<span class="hljs-regexp">/live/</span>harbor.xx.com/<br><br>root <span class="hljs-keyword">in</span> unreal-pod-<span class="hljs-number">1</span> <span class="hljs-keyword">in</span> letsencrypt<span class="hljs-regexp">/live/</span>harbor.xx.com<br>❯ ll<br>total <span class="hljs-number">4.0</span>K<br>lrwxrwxrwx <span class="hljs-number">1</span> root root  <span class="hljs-number">41</span> Oct <span class="hljs-number">18</span> <span class="hljs-number">00</span>:<span class="hljs-number">31</span> cert.pem -&gt; ..<span class="hljs-regexp">/../</span>archive<span class="hljs-regexp">/harbor.xx.com/</span>cert1.pem<br>lrwxrwxrwx <span class="hljs-number">1</span> root root  <span class="hljs-number">42</span> Oct <span class="hljs-number">18</span> <span class="hljs-number">00</span>:<span class="hljs-number">31</span> chain.pem -&gt; ..<span class="hljs-regexp">/../</span>archive<span class="hljs-regexp">/harbor.xx.com/</span>chain1.pem<br>lrwxrwxrwx <span class="hljs-number">1</span> root root  <span class="hljs-number">46</span> Oct <span class="hljs-number">18</span> <span class="hljs-number">00</span>:<span class="hljs-number">31</span> fullchain.pem -&gt; ..<span class="hljs-regexp">/../</span>archive<span class="hljs-regexp">/harbor.xx.com/</span>fullchain1.pem<br>lrwxrwxrwx <span class="hljs-number">1</span> root root  <span class="hljs-number">44</span> Oct <span class="hljs-number">18</span> <span class="hljs-number">00</span>:<span class="hljs-number">31</span> privkey.pem -&gt; ..<span class="hljs-regexp">/../</span>archive<span class="hljs-regexp">/harbor.xx.com/</span>privkey1.pem<br>-rw-r--r-- <span class="hljs-number">1</span> root root <span class="hljs-number">692</span> Oct <span class="hljs-number">18</span> <span class="hljs-number">00</span>:<span class="hljs-number">31</span> README<br><br><span class="hljs-comment"># download the harbor package</span><br>$ curl -s https:<span class="hljs-regexp">//</span>api.github.com<span class="hljs-regexp">/repos/g</span>oharbor<span class="hljs-regexp">/harbor/</span>releases/latest | grep browser_download_url | cut -d <span class="hljs-string">&#x27;&quot;&#x27;</span> -f <span class="hljs-number">4</span> | grep <span class="hljs-string">&#x27;\.tgz$&#x27;</span> | wget -i -<br><br><span class="hljs-comment"># Extract the harbor</span><br>$ tar xvf harbor-offline-installer-v2.<span class="hljs-number">3.3</span>.tgz<br>$ cd harbor<br><br><span class="hljs-comment"># copy example of configuration</span><br>$ cp harbor.yml.tmpl harbor.yml<br><br><span class="hljs-comment"># open harbor.yaml</span><br>$ vim harbor.yaml<br>  hostname:<br>  http.port:<br>  https.port<br>    certificate:<br>    private_key:<br>  harbor_admin_password:<br>  database.password:<br>  database.max_idle_conns:<br>  database.max_open_conns:<br>  data_volume:<br><br><span class="hljs-comment"># notary helps to digitally sign images using keys that verify content and publish them securely</span><br>$ sudo ./install.sh --with-notary --with-chartmuseum<br><br><span class="hljs-comment"># Harbor web access</span><br>&gt; https:<span class="hljs-regexp">//</span>harbor.xxx.com (modify <span class="hljs-regexp">/etc/</span>hosts add records)<br><br>&gt; login  harbor.xxx.com<br>$ docker login -u admin_zcm -p abc@<span class="hljs-number">123</span>A harbor.xxx.com<br></code></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Kubernetes分析源码</title>
    <url>/2021/10/15/Kubernetes%E5%88%86%E6%9E%90%E6%BA%90%E7%A0%81/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Learning Helm: Managing Apps on Kubernetes</title>
    <url>/2021/10/15/Learning-Helm-Managing-Apps-on-Kubernetes/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>NFS Mount Intro</title>
    <url>/2021/10/15/NFS-Mount-Intro/</url>
    <content><![CDATA[<h1 id="NFS-or-Network-File-System"><a href="#NFS-or-Network-File-System" class="headerlink" title="NFS, or Network File System"></a>NFS, or Network File System</h1><blockquote>
<p>一种分布式文件系统协议，允许你在服务器上挂载远程目录，你可以管理不同位置的存储空间并从多客户端写入该空间. NFS提供一种相对标准和高效的方式来通过网络访问远程系统。并且适合访问共享资源的情况.</p>
</blockquote>
<span id="more"></span>

<h2 id="Step-1-Download-and-Install-the-Components"><a href="#Step-1-Download-and-Install-the-Components" class="headerlink" title="Step 1 - Download and Install the Components"></a>Step 1 - Download and Install the Components</h2><ul>
<li>On the Host<figure class="highlight elixir"><table><tr><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>sudo apt update<br><br><span class="hljs-variable">$ </span>sudo apt install nfs-kernel-server (允许你分享文件目录)<br></code></pre></td></tr></table></figure></li>
<li>On the Client<figure class="highlight elixir"><table><tr><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>sudo apt update<br><span class="hljs-variable">$ </span>sudo apt install nfs-common<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Step-2-Create-the-Share-DIrectories-on-the-Host"><a href="#Step-2-Create-the-Share-DIrectories-on-the-Host" class="headerlink" title="Step 2 - Create the Share DIrectories on the Host"></a>Step 2 - Create the Share DIrectories on the Host</h2><ul>
<li>Example 1: Exporting a General Purpose Mount<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">ubuntu <span class="hljs-keyword">in</span> ~ at k8s-node1 via 🐍 <span class="hljs-number">3.8</span>.<span class="hljs-number">6</span><br>➜ sudo mkdir <span class="hljs-regexp">/var/</span>nfs/general -p  <span class="hljs-comment"># 创建目录</span><br><br>ubuntu <span class="hljs-keyword">in</span> ~ at k8s-node1 via 🐍 <span class="hljs-number">3.8</span>.<span class="hljs-number">6</span><br>➜ ls -la <span class="hljs-regexp">/var/</span>nfs/general<br>total <span class="hljs-number">8</span><br>drwxr-xr-x <span class="hljs-number">2</span> root root <span class="hljs-number">4096</span> Oct <span class="hljs-number">15</span> <span class="hljs-number">13</span>:<span class="hljs-number">41</span> .<br>drwxr-xr-x <span class="hljs-number">3</span> root root <span class="hljs-number">4096</span> Oct <span class="hljs-number">15</span> <span class="hljs-number">13</span>:<span class="hljs-number">41</span> ..<br><br>&gt; NFS会将客户端上的任何根操作转换为nobody:nogroup凭证作为安全措施，因此我们需要更改目录所有权匹配这些凭证.<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at k8s-node1 via 🐍 <span class="hljs-number">3.8</span>.<span class="hljs-number">6</span><br>➜ sudo chown nobody:nogroup <span class="hljs-regexp">/var/</span>nfs/general<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Step-3-Configuring-the-NFS-Exports-on-the-Host-Server"><a href="#Step-3-Configuring-the-NFS-Exports-on-the-Host-Server" class="headerlink" title="Step 3 - Configuring the NFS Exports on the Host Server"></a>Step 3 - Configuring the NFS Exports on the Host Server</h2>  <figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">chyi in ~ at k8s-master<br>➜ sudo <span class="hljs-keyword">vim</span> /etc/exports<br>  # This <span class="hljs-keyword">file</span> <span class="hljs-keyword">is</span> auto-generated by openmediavault (http<span class="hljs-variable">s:</span>//www.openmediavault.org)<br>  # WARNING: Do not <span class="hljs-keyword">edit</span> this <span class="hljs-keyword">file</span>, your <span class="hljs-keyword">changes</span> will <span class="hljs-built_in">get</span> lost.<br><br>  # directory_to_share  client(share_option1,...,share_optionN)<br><br>  # /etc/export<span class="hljs-variable">s:</span> the access control <span class="hljs-keyword">list</span> <span class="hljs-keyword">for</span> filesystems which may <span class="hljs-keyword">be</span> exported<br>  #               <span class="hljs-keyword">to</span> NFS clients.  See exports(<span class="hljs-number">5</span>).<br>  /export/K8sData <span class="hljs-number">172.30</span>.<span class="hljs-number">1.0</span>/<span class="hljs-number">24</span>(fsid=<span class="hljs-number">2</span>,rw,subtree_check,insecure)<br>    - r<span class="hljs-variable">w:</span> 此选项为客户端计算机提供对卷的读写访问权限<br>    - <span class="hljs-keyword">sync</span>: 此选项强制NFS在响应恢复之前将更改写入磁盘，会导致更稳定和一致的环境，因为恢复响应远程卷的世纪状态，但是他也降低了文件操作的速度.<br>    - no_subtree_check: 此选项防止子树检查，这是一个过程，主机必须检查该文件是否在每个请求的导出树中实际上仍然可用，在客户端打开文件和重命名文件时<br>    - no_root_squash: 默认情况下，NFS将来自root用户的远程请求转换为服务器上的非特权用户，这是为了防止客户端上的root账户以root身份使用主机的文件系统的安全功能<br><br>$ sudo systemctl restart nfs-kernel-server<br></code></pre></td></tr></table></figure>

<h2 id="Step-4-Create-Mount-Points-and-Mount-Directories-on-the-Client"><a href="#Step-4-Create-Mount-Points-and-Mount-Directories-on-the-Client" class="headerlink" title="Step 4 - Create Mount Points and Mount Directories on the Client"></a>Step 4 - Create Mount Points and Mount Directories on the Client</h2>  <figure class="highlight elixir"><table><tr><td class="code"><pre><code class="hljs elixir">&gt; 为了使远程共享在客户端可用，我们需要将主机上要共享的目录挂载到客户端上的空目录中<br>&gt; 如果你的挂载点中有文件和目录，一旦你挂载NFS共享，他们就会被隐藏，为了避免丢失重要文件，请确保你挂载在已存在的目录中，并且该目录为空.<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at <span class="hljs-number">3</span>B<br>➜ sudo mkdir /k8s_data<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at <span class="hljs-number">3</span>B<br>➜ sudo mount <span class="hljs-number">172.30</span>.<span class="hljs-number">1.14</span><span class="hljs-symbol">:/export/K8sData</span> /k8s_data<br></code></pre></td></tr></table></figure>

<h2 id="Step-5-Mounting-the-Remote-NFS-Directories-at-Boot"><a href="#Step-5-Mounting-the-Remote-NFS-Directories-at-Boot" class="headerlink" title="Step 5 - Mounting the Remote NFS Directories at Boot"></a>Step 5 - Mounting the Remote NFS Directories at Boot</h2>  <figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">&gt; 通过将远程NFS共享添加到客户端上的<span class="hljs-regexp">/etc/</span>fstab文件，可以在启动是自动挂载远程NFS共享<br><br>ubuntu <span class="hljs-keyword">in</span> ~ at <span class="hljs-number">3</span>B<br>➜ sudo vim <span class="hljs-regexp">/etc/</span>fstab<br><br>  <span class="hljs-number">172.30</span>.<span class="hljs-number">1.14</span>:<span class="hljs-regexp">/export/</span>K8sData /k8s_data nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=<span class="hljs-number">1800</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<h2 id="Step-6-Unmounting-an-NFS-Remote-Share"><a href="#Step-6-Unmounting-an-NFS-Remote-Share" class="headerlink" title="Step 6 - Unmounting an NFS Remote Share"></a>Step 6 - Unmounting an NFS Remote Share</h2>  <figure class="highlight elixir"><table><tr><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>sudo umount /k8s_data<br></code></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Rancher Intro</title>
    <url>/2021/10/18/Rancher-Intro/</url>
    <content><![CDATA[<h1 id="Rancher"><a href="#Rancher" class="headerlink" title="Rancher"></a>Rancher</h1><span id="more"></span>
]]></content>
  </entry>
  <entry>
    <title>数据库迁移 MySQL -&gt; Postgres</title>
    <url>/2021/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB-MySQL-Postgres/</url>
    <content><![CDATA[<h1 id="数据库迁移-MySQL-gt-Postgres"><a href="#数据库迁移-MySQL-gt-Postgres" class="headerlink" title="数据库迁移 MySQL -&gt; Postgres"></a>数据库迁移 MySQL -&gt; Postgres</h1><span id="more"></span>

<h2 id="MySQL-to-PostgreSQL-Types-Mapping"><a href="#MySQL-to-PostgreSQL-Types-Mapping" class="headerlink" title="MySQL to PostgreSQL Types Mapping"></a>MySQL to PostgreSQL Types Mapping</h2><ul>
<li><p>Types Mapping</p>
<table>
<thead>
<tr>
<th align="left">MySQL</th>
<th align="left">PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="left">BIGINT</td>
<td align="left">BIGINT</td>
</tr>
<tr>
<td align="left">BINARY(n)</td>
<td align="left">BYTEA</td>
</tr>
<tr>
<td align="left">BIT</td>
<td align="left">BOOLEAN</td>
</tr>
<tr>
<td align="left">CHAR(n), CHARACTER(n)</td>
<td align="left">CHAR(n), CHARACTER(n)</td>
</tr>
<tr>
<td align="left">DATE</td>
<td align="left">DATE</td>
</tr>
<tr>
<td align="left">DATETIME</td>
<td align="left">TIMESTAMP [WITHOUT TIME ZONE]</td>
</tr>
<tr>
<td align="left">DECIMAL(p,s), DEC(p,s)</td>
<td align="left">DECIMAL(p,s), DEC(p,s)</td>
</tr>
<tr>
<td align="left">DOUBLE</td>
<td align="left">DOUBLE PERCISION</td>
</tr>
<tr>
<td align="left">FLOAT</td>
<td align="left">REAL</td>
</tr>
<tr>
<td align="left">INT, INTEGER</td>
<td align="left">INT, INTEGER</td>
</tr>
<tr>
<td align="left">MEDIUMINT</td>
<td align="left">INTEGER</td>
</tr>
<tr>
<td align="left">NUMERIC(p,s)</td>
<td align="left">NUMERIC(p,s)</td>
</tr>
<tr>
<td align="left">SMALLINT</td>
<td align="left">SMALLINT</td>
</tr>
<tr>
<td align="left">TINYINT</td>
<td align="left">SMALLINT</td>
</tr>
<tr>
<td align="left">TINYTEXT, TEXT, MEDIUMTEXT, LONGTEXT</td>
<td align="left">TEXT</td>
</tr>
<tr>
<td align="left">TIME</td>
<td align="left">TIME [WITHOUT TIME ZONE]</td>
</tr>
<tr>
<td align="left">TIMESTAMP</td>
<td align="left">TIMESTAMP [WITHOUT TIME ZONE]</td>
</tr>
<tr>
<td align="left">VARBINARY(n), VARBINARY(max)</td>
<td align="left">BYTEA</td>
</tr>
<tr>
<td align="left">VARCHAR(n)</td>
<td align="left">VARCHAR(n)</td>
</tr>
<tr>
<td align="left">VARCHAR(max)</td>
<td align="left">TEXT</td>
</tr>
</tbody></table>
</li>
<li><p>MySQL auto_increment</p>
<table>
<thead>
<tr>
<th align="left">MySQL</th>
<th align="left">PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="left">BIGINT AUTO_INCREMENT</td>
<td align="left">BIGSERIAL</td>
</tr>
<tr>
<td align="left">INTEGER AUTO_INCREMENT</td>
<td align="left">SERIAL</td>
</tr>
<tr>
<td align="left">SMALLINT AUTO_INCREMENT</td>
<td align="left">SMALLSERIAL</td>
</tr>
<tr>
<td align="left">TINYINT AUTO_INCREMENT</td>
<td align="left">SMALLSERIAL</td>
</tr>
</tbody></table>
</li>
<li><p>MySQL integer types (tinyint, smallint, int, bigint) UNSIGNED</p>
<table>
<thead>
<tr>
<th align="left">MySQL</th>
<th align="left">PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="left">BIGINT UNSIGNED</td>
<td align="left">NUMERIC(20)</td>
</tr>
<tr>
<td align="left">INT UNSIGNED</td>
<td align="left">BIGINT</td>
</tr>
<tr>
<td align="left">MEDIUMINT UNSIGNED</td>
<td align="left">INTEGER</td>
</tr>
<tr>
<td align="left">SMALLINT UNSIGNED</td>
<td align="left">INTEGER</td>
</tr>
<tr>
<td align="left">TINYINT UNSIGNED</td>
<td align="left">INTEGER</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="使用pgloader将MySQL数据库迁移到PostgreSQL"><a href="#使用pgloader将MySQL数据库迁移到PostgreSQL" class="headerlink" title="使用pgloader将MySQL数据库迁移到PostgreSQL"></a>使用pgloader将MySQL数据库迁移到PostgreSQL</h2><ul>
<li><p>PGLOADER</p>
<ul>
<li><p>Supported operations include</p>
<ul>
<li>Migrate from MySQL to PostgreSQL</li>
<li>Migrate from SQLite to PostgreSQL</li>
<li>Migrate from MS SQL Server to PostgreSQL</li>
</ul>
</li>
<li><p>Install</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; pgloader使用postgresql的COPY命令将数据从源数据库或文件复制到目标PostgreSQL数据库中.</span><br><span class="hljs-bullet">  -</span> sbcl: 一个Common Lisp编译器<br><span class="hljs-bullet">  -</span> unzip: .zip文件的unzip器<br><span class="hljs-bullet">  -</span> libsqlite3-dev: SQLite3的开发文件集合<br><span class="hljs-bullet">  -</span> gawk: GNU awk 的缩写，是一种模式扫描和处理语言<br><span class="hljs-bullet">  -</span> curl: 用于从URL传输数据的命令行工具<br><span class="hljs-bullet">  -</span> make: 用于管理包编译的实用程序<br><span class="hljs-bullet">  -</span> freetds-dev: MS SQL和Sybase数据库的客户端库<br><span class="hljs-bullet">  -</span> libzip-dev:用于读取，穿件和修改zip存档的库<br><span class="hljs-section"># 安装依赖项</span><br>$ sudo apt install sbcl unzip libsqlite3-dev gawk curl make freetds-dev libzip-dev<br><br><span class="hljs-section"># 下载pgloader</span><br>$ wget https://github.com/dimitri/pgloader/releases/download/v3.6.2/pgloader-bundle-3.6.2.tgz<br><br><span class="hljs-section"># 提取tarball</span><br>$ tar -xvf pgloader-bundle<br><br><span class="hljs-section"># 构建pgloader二进制文件</span><br><span class="hljs-section"># make pgloader</span><br></code></pre></td></tr></table></figure></li>
<li><p>Migrate from MySQL to PostgreSQL</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">  &gt; Migrate <span class="hljs-selector-tag">a</span> whole MySQL database, including its schema definition of tables and indexes, primary key and foreign key constraints, comments and default values, even when they require installing <span class="hljs-selector-tag">a</span> trigger <span class="hljs-keyword">in</span> PostgreSQL.<br><br>	chyiyaqing <span class="hljs-keyword">in</span> ~ at chyiyaqing-PowerEdge-R720<br>➜ pgloader mysql:<span class="hljs-comment">//admin:x@172.16.1.129:31540/stdb pgsql://kingbasees:x@180.76.152.26:5432/stdb</span><br><span class="hljs-number">2021</span>-<span class="hljs-number">10</span>-<span class="hljs-number">29</span>T18:<span class="hljs-number">31</span>:<span class="hljs-number">21.028000</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span> LOG pgloader version <span class="hljs-string">&quot;3.6.2&quot;</span><br><span class="hljs-number">2021</span>-<span class="hljs-number">10</span>-<span class="hljs-number">29</span>T18:<span class="hljs-number">31</span>:<span class="hljs-number">21.453000</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span> LOG Migrating from #&lt;MYSQL-CONNECTION mysql:<span class="hljs-comment">//admin@172.16.1.129:31540/stdb &#123;10054E05A3&#125;&gt;</span><br><span class="hljs-number">2021</span>-<span class="hljs-number">10</span>-<span class="hljs-number">29</span>T18:<span class="hljs-number">31</span>:<span class="hljs-number">21.453000</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span> LOG Migrating into #&lt;PGSQL-CONNECTION pgsql:<span class="hljs-comment">//kingbasees@180.76.152.26:5432/stdb &#123;10056315A3&#125;&gt;</span><br><span class="hljs-number">2021</span>-<span class="hljs-number">10</span>-<span class="hljs-number">29</span>T18:<span class="hljs-number">32</span>:<span class="hljs-number">49.847000</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span> LOG report <span class="hljs-selector-tag">summary</span> reset<br>                  <span class="hljs-selector-tag">table</span> name     errors       rows      bytes      total <span class="hljs-selector-tag">time</span><br>----------------------------  ---------  ---------  ---------  --------------<br>             fetch meta data          <span class="hljs-number">0</span>        <span class="hljs-number">159</span>                     <span class="hljs-number">1.411s</span><br>              Create Schemas          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">0.253s</span><br>            Create SQL Types          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">0.152s</span><br>               Create tables          <span class="hljs-number">0</span>        <span class="hljs-number">134</span>                    <span class="hljs-number">25.585s</span><br>              Set Table OIDs          <span class="hljs-number">0</span>         <span class="hljs-number">67</span>                     <span class="hljs-number">0.080s</span><br>----------------------------  ---------  ---------  ---------  --------------<br>             stdb<span class="hljs-selector-class">.access_key</span>          <span class="hljs-number">0</span>          <span class="hljs-number">6</span>     <span class="hljs-number">1.6</span> kB          <span class="hljs-number">0.588s</span><br>          stdb<span class="hljs-selector-class">.alert_history</span>          <span class="hljs-number">0</span>      <span class="hljs-number">84369</span>    <span class="hljs-number">28.7</span> MB         <span class="hljs-number">28.544s</span><br>        stdb<span class="hljs-selector-class">.analysis_result</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">6.861s</span><br>             stdb<span class="hljs-selector-class">.auth_group</span>          <span class="hljs-number">0</span>          <span class="hljs-number">2</span>     <span class="hljs-number">0.1</span> kB          <span class="hljs-number">7.222s</span><br>  stdb<span class="hljs-selector-class">.baas_contract_cluster</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">7.661s</span><br>                  stdb<span class="hljs-selector-class">.cache</span>          <span class="hljs-number">0</span>        <span class="hljs-number">300</span>    <span class="hljs-number">49.2</span> kB          <span class="hljs-number">8.278s</span><br>            stdb<span class="hljs-selector-class">.auth_client</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">2.851s</span><br>          stdb<span class="hljs-selector-class">.certification</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">8.631s</span><br>           stdb<span class="hljs-selector-class">.auth_history</span>          <span class="hljs-number">0</span>         <span class="hljs-number">20</span>     <span class="hljs-number">1.6</span> kB          <span class="hljs-number">3.268s</span><br>          stdb<span class="hljs-selector-class">.chain_account</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">8.968s</span><br>stdb<span class="hljs-selector-class">.baas_contract_warehouse</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">3.595s</span><br>            stdb<span class="hljs-selector-class">.config_info</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">9.251s</span><br>                   stdb<span class="hljs-selector-class">.cert</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">4.014s</span><br>        stdb<span class="hljs-selector-class">.contract_entity</span>          <span class="hljs-number">0</span>          <span class="hljs-number">1</span>     <span class="hljs-number">0.5</span> kB          <span class="hljs-number">9.452s</span><br>                  stdb<span class="hljs-selector-class">.chain</span>          <span class="hljs-number">0</span>        <span class="hljs-number">163</span>   <span class="hljs-number">118.5</span> kB          <span class="hljs-number">4.337s</span><br> stdb<span class="hljs-selector-class">.contract_invoke_record</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">9.598s</span><br>      stdb<span class="hljs-selector-class">.chain_transaction</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">4.221s</span><br>   stdb<span class="hljs-selector-class">.contract_market_info</span>          <span class="hljs-number">0</span>         <span class="hljs-number">25</span>     <span class="hljs-number">3.5</span> kB          <span class="hljs-number">9.774s</span><br>       stdb<span class="hljs-selector-class">.contract_address</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">4.065s</span><br>      stdb<span class="hljs-selector-class">.contract_template</span>          <span class="hljs-number">0</span>        <span class="hljs-number">129</span>    <span class="hljs-number">79.5</span> kB         <span class="hljs-number">10.058s</span><br>          stdb<span class="hljs-selector-class">.contract_info</span>          <span class="hljs-number">0</span>          <span class="hljs-number">8</span>     <span class="hljs-number">1.0</span> kB          <span class="hljs-number">4.046s</span><br>             stdb<span class="hljs-selector-class">.credential</span>          <span class="hljs-number">0</span>         <span class="hljs-number">41</span>    <span class="hljs-number">48.5</span> kB         <span class="hljs-number">10.322s</span><br>        stdb<span class="hljs-selector-class">.contract_market</span>          <span class="hljs-number">0</span>         <span class="hljs-number">16</span>    <span class="hljs-number">37.8</span> kB          <span class="hljs-number">4.197s</span><br>                 stdb<span class="hljs-selector-class">.driver</span>          <span class="hljs-number">0</span>         <span class="hljs-number">14</span>    <span class="hljs-number">94.6</span> kB         <span class="hljs-number">10.825s</span><br>        stdb<span class="hljs-selector-class">.contract_sample</span>          <span class="hljs-number">0</span>        <span class="hljs-number">664</span>     <span class="hljs-number">9.2</span> MB         <span class="hljs-number">14.125s</span><br>     stdb<span class="hljs-selector-class">.file_system_entity</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">11.247s</span><br>         stdb<span class="hljs-selector-class">.gas_distribute</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">11.666s</span><br>              stdb<span class="hljs-selector-class">.grade_one</span>          <span class="hljs-number">0</span>        <span class="hljs-number">664</span>    <span class="hljs-number">64.3</span> kB         <span class="hljs-number">11.957s</span><br>  stdb<span class="hljs-selector-class">.contract_version_info</span>          <span class="hljs-number">0</span>          <span class="hljs-number">1</span>     <span class="hljs-number">0.1</span> kB          <span class="hljs-number">3.688s</span><br>       stdb<span class="hljs-selector-class">.debug_properties</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">4.150s</span><br>              stdb<span class="hljs-selector-class">.err_event</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">4.543s</span><br>     stdb<span class="hljs-selector-class">.hibernate_sequence</span>          <span class="hljs-number">0</span>          <span class="hljs-number">1</span>     <span class="hljs-number">0.0</span> kB         <span class="hljs-number">11.902s</span><br>                   stdb<span class="hljs-selector-class">.form</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">5.003s</span><br>         stdb<span class="hljs-selector-class">.instance_event</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">12.349s</span><br>            stdb<span class="hljs-selector-class">.grade_group</span>          <span class="hljs-number">0</span>          <span class="hljs-number">5</span>     <span class="hljs-number">1.1</span> kB          <span class="hljs-number">5.484s</span><br>       stdb<span class="hljs-selector-class">.integral_account</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">12.779s</span><br>             stdb<span class="hljs-selector-class">.grpc_event</span>          <span class="hljs-number">0</span>       <span class="hljs-number">4002</span>   <span class="hljs-number">894.1</span> kB          <span class="hljs-number">9.082s</span><br>       stdb<span class="hljs-selector-class">.java_file_entity</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">13.242s</span><br>        stdb<span class="hljs-selector-class">.license_history</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">13.717s</span><br>               stdb<span class="hljs-selector-class">.instance</span>          <span class="hljs-number">0</span>         <span class="hljs-number">70</span>   <span class="hljs-number">122.2</span> kB          <span class="hljs-number">9.365s</span><br>            stdb<span class="hljs-selector-class">.log_operate</span>          <span class="hljs-number">0</span>        <span class="hljs-number">439</span>   <span class="hljs-number">103.6</span> kB         <span class="hljs-number">14.198s</span><br>               stdb<span class="hljs-selector-class">.integral</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">9.765s</span><br>     stdb<span class="hljs-selector-class">.monitor_indicators</span>          <span class="hljs-number">0</span>         <span class="hljs-number">52</span>    <span class="hljs-number">10.0</span> kB         <span class="hljs-number">14.635s</span><br>   stdb<span class="hljs-selector-class">.integral_transaction</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">10.234s</span><br>                 stdb<span class="hljs-selector-class">.notice</span>          <span class="hljs-number">0</span>        <span class="hljs-number">270</span>   <span class="hljs-number">385.6</span> kB         <span class="hljs-number">15.572s</span><br>    stdb<span class="hljs-selector-class">.java_project_entity</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">10.688s</span><br>               stdb<span class="hljs-selector-class">.log_file</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">11.105s</span><br>           stdb<span class="hljs-selector-class">.organization</span>          <span class="hljs-number">0</span>         <span class="hljs-number">34</span>     <span class="hljs-number">8.1</span> kB         <span class="hljs-number">15.521s</span><br>          stdb<span class="hljs-selector-class">.monitor_alert</span>          <span class="hljs-number">0</span>         <span class="hljs-number">14</span>    <span class="hljs-number">11.2</span> kB         <span class="hljs-number">11.741s</span><br>                  stdb<span class="hljs-selector-class">.panel</span>          <span class="hljs-number">0</span>        <span class="hljs-number">169</span>     <span class="hljs-number">7.5</span> kB         <span class="hljs-number">15.474s</span><br>                   stdb<span class="hljs-selector-class">.node</span>          <span class="hljs-number">0</span>        <span class="hljs-number">333</span>   <span class="hljs-number">150.5</span> kB         <span class="hljs-number">12.311s</span><br>                stdb<span class="hljs-selector-class">.renewal</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">15.791s</span><br>                   stdb<span class="hljs-selector-class">.role</span>          <span class="hljs-number">0</span>          <span class="hljs-number">6</span>     <span class="hljs-number">7.5</span> kB         <span class="hljs-number">15.830s</span><br>    stdb<span class="hljs-selector-class">.order_resource_ship</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">12.207s</span><br>              stdb<span class="hljs-selector-class">.rule_type</span>          <span class="hljs-number">0</span>         <span class="hljs-number">11</span>     <span class="hljs-number">1.1</span> kB         <span class="hljs-number">15.752s</span><br>                 stdb<span class="hljs-selector-class">.output</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">12.650s</span><br>              stdb<span class="hljs-selector-class">.secretkey</span>          <span class="hljs-number">0</span>         <span class="hljs-number">48</span>    <span class="hljs-number">23.2</span> kB         <span class="hljs-number">16.119s</span><br>             stdb<span class="hljs-selector-class">.prometheus</span>          <span class="hljs-number">0</span>        <span class="hljs-number">283</span>    <span class="hljs-number">56.8</span> kB         <span class="hljs-number">12.608s</span><br>  stdb<span class="hljs-selector-class">.third_contract_market</span>          <span class="hljs-number">0</span>          <span class="hljs-number">2</span>     <span class="hljs-number">0.4</span> kB         <span class="hljs-number">16.107s</span><br>       stdb<span class="hljs-selector-class">.report_id_entity</span>          <span class="hljs-number">0</span>          <span class="hljs-number">5</span>     <span class="hljs-number">0.1</span> kB         <span class="hljs-number">13.235s</span><br>           stdb<span class="hljs-selector-class">.user_setting</span>          <span class="hljs-number">0</span>          <span class="hljs-number">7</span>     <span class="hljs-number">0.5</span> kB         <span class="hljs-number">16.055s</span><br>                   stdb<span class="hljs-selector-class">.rule</span>          <span class="hljs-number">0</span>         <span class="hljs-number">39</span>    <span class="hljs-number">13.0</span> kB         <span class="hljs-number">13.143s</span><br>    stdb<span class="hljs-selector-class">.verification_result</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">16.398s</span><br>     stdb<span class="hljs-selector-class">.sample_grade_model</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">13.639s</span><br>           stdb<span class="hljs-selector-class">.subscription</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">13.503s</span><br>                 stdb.<span class="hljs-string">&quot;user&quot;</span>          <span class="hljs-number">0</span>         <span class="hljs-number">34</span>    <span class="hljs-number">29.2</span> kB         <span class="hljs-number">14.018s</span><br>           stdb<span class="hljs-selector-class">.user_use_gas</span>          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                    <span class="hljs-number">13.895s</span><br>----------------------------  ---------  ---------  ---------  --------------<br>     COPY Threads Completion          <span class="hljs-number">0</span>          <span class="hljs-number">4</span>                    <span class="hljs-number">28.540s</span><br>              Create Indexes          <span class="hljs-number">0</span>         <span class="hljs-number">92</span>                    <span class="hljs-number">19.382s</span><br>      Index Build Completion          <span class="hljs-number">0</span>         <span class="hljs-number">92</span>                     <span class="hljs-number">1.384s</span><br>             Reset Sequences          <span class="hljs-number">0</span>         <span class="hljs-number">16</span>                     <span class="hljs-number">0.746s</span><br>                Primary Keys          <span class="hljs-number">0</span>         <span class="hljs-number">66</span>                    <span class="hljs-number">12.146s</span><br>         Create Foreign Keys          <span class="hljs-number">0</span>          <span class="hljs-number">0</span>                     <span class="hljs-number">0.000s</span><br>             Create Triggers          <span class="hljs-number">0</span>         <span class="hljs-number">14</span>                     <span class="hljs-number">2.716s</span><br>             Set Search Path          <span class="hljs-number">0</span>          <span class="hljs-number">1</span>                     <span class="hljs-number">0.306s</span><br>            Install Comments          <span class="hljs-number">0</span>         <span class="hljs-number">74</span>                    <span class="hljs-number">13.552s</span><br>----------------------------  ---------  ---------  ---------  --------------<br>           Total import <span class="hljs-selector-tag">time</span>          ✓      <span class="hljs-number">92247</span>    <span class="hljs-number">40.2</span> MB       <span class="hljs-number">1</span>m18.<span class="hljs-number">772s</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="使用pgbench测试PostgreSQL"><a href="#使用pgbench测试PostgreSQL" class="headerlink" title="使用pgbench测试PostgreSQL"></a>使用pgbench测试PostgreSQL</h2><ul>
<li>pgbench</li>
</ul>
<h2 id="Mysql-SQL-迁移-Postgres"><a href="#Mysql-SQL-迁移-Postgres" class="headerlink" title="Mysql SQL 迁移 Postgres"></a>Mysql SQL 迁移 Postgres</h2>  <figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># Limit 用法</span><br><span class="hljs-bullet">  -</span> mysql limit 0,1<br><span class="hljs-bullet">  -</span> postgres limit 1 offset 0<br><br><span class="hljs-section"># REGEXP 用法</span><br><span class="hljs-bullet">  -</span> mysql REGEXP<br><span class="hljs-bullet">  -</span> postgres ~<br></code></pre></td></tr></table></figure>

<h2 id="路上遇到的坑"><a href="#路上遇到的坑" class="headerlink" title="路上遇到的坑"></a>路上遇到的坑</h2><ul>
<li>PostgreSQL列名区分大小写<figure class="highlight gherkin"><table><tr><td class="code"><pre><code class="hljs gherkin">blocface=<span class="hljs-comment"># \d public.alert</span><br>                                         Table <span class="hljs-string">&quot;public.alert&quot;</span><br>   Column    |<span class="hljs-string">            Type             </span>|<span class="hljs-string"> Collation </span>|<span class="hljs-string"> Nullable </span>|<span class="hljs-string">              Default</span><br><span class="hljs-string">-------------+-----------------------------+-----------+----------+-----------------------------------</span><br><span class="hljs-string"> id          </span>|<span class="hljs-string"> integer                     </span>|<span class="hljs-string">           </span>|<span class="hljs-string"> not null </span>|<span class="hljs-string"> nextval(&#x27;alert_id_seq&#x27;::regclass)</span><br><span class="hljs-string"> time_create </span>|<span class="hljs-string"> timestamp without time zone </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> time_update |<span class="hljs-string"> timestamp without time zone </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> time_delete |<span class="hljs-string"> timestamp without time zone </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> name        |<span class="hljs-string"> character varying(255)      </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> mode        |<span class="hljs-string"> integer                     </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> condition   |<span class="hljs-string"> integer                     </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> silence     |<span class="hljs-string"> integer                     </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> user_id     |<span class="hljs-string"> character varying(64)       </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> group_id    |<span class="hljs-string"> character varying(64)       </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> viewer      |<span class="hljs-string"> character varying(32)       </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<br> isDeleted   |<span class="hljs-string"> integer                     </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          </span>|<span class="hljs-string"> 0</span><br><span class="hljs-string">Indexes:</span><br><span class="hljs-string">    &quot;alert_pkey&quot; PRIMARY KEY, btree (id)</span><br><span class="hljs-string">    &quot;IDX_alert_time_delete&quot; btree (time_delete)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 所有未双引号的标识符(包括列名)在PostgreSQL中被折叠为小写，用双引号创建的列名并因此保留了大写字母，必须在余下的时间将双引号括起来(&quot;first_Name&quot;)</span><br><span class="hljs-string">blocface=# SELECT isDeleted from public.alert;</span><br><span class="hljs-string">ERROR:  column &quot;isdeleted&quot; does not exist</span><br><span class="hljs-string">LINE 1: SELECT isDeleted from public.alert;</span><br><span class="hljs-string">               ^</span><br><span class="hljs-string">HINT:  Perhaps you meant to reference the column &quot;alert.isDeleted&quot;.</span><br><span class="hljs-string">blocface=# SELECT &quot;isDeleted&quot; from public.alert;</span><br><span class="hljs-string"> isDeleted</span><br><span class="hljs-string">-----------</span><br><span class="hljs-string">(0 rows)</span><br></code></pre></td></tr></table></figure></li>
<li>PostgreSQL Duplicate Key Violates unique constraint<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">Q: the <span class="hljs-keyword">sequence</span> was <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> sync <span class="hljs-keyword">and</span> <span class="hljs-keyword">no</span> more records<br>A: the <span class="hljs-keyword">sequence</span> must be synchronized mannually.<br>  The <span class="hljs-type">name</span> <span class="hljs-keyword">of</span> the <span class="hljs-keyword">sequence</span> can be determined <span class="hljs-keyword">with</span> teh command PG_GET_SERIAL_SEQUENCE<br>  # Command <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> the <span class="hljs-keyword">sequence</span> <span class="hljs-type">name</span>:<br>  # the <span class="hljs-keyword">table</span> <span class="hljs-type">name</span> must be <span class="hljs-keyword">in</span> <span class="hljs-type">double</span> quotes, surrounded <span class="hljs-keyword">by</span> single quotes<br>  &gt; <span class="hljs-keyword">SELECT</span> PG_GET_SERIAL_SEQUENCE(<span class="hljs-string">&#x27;&quot;foo&quot;&#x27;</span>, <span class="hljs-string">&#x27;foo_id&#x27;</span>)<br><br>  # <span class="hljs-keyword">Validate</span>, the <span class="hljs-keyword">sequence</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span>-<span class="hljs-keyword">of</span>-sync<br>  # <span class="hljs-keyword">When</span> the <span class="hljs-keyword">Current</span> <span class="hljs-keyword">Value</span> <span class="hljs-keyword">is</span> less than Max <span class="hljs-keyword">Value</span>, your <span class="hljs-keyword">sequence</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span>-<span class="hljs-keyword">of</span>-sync<br>  &gt; <span class="hljs-keyword">SELECT</span> CURRVAL(PG_GET_SERIAL_SEQUENCE(<span class="hljs-string">&#x27;&quot;foo&quot;&#x27;</span>, <span class="hljs-string">&#x27;foo_id&#x27;</span>)) <span class="hljs-keyword">AS</span> &quot;Current Value&quot;, MAX(&quot;foo_id&quot;) <span class="hljs-keyword">AS</span> &quot;Max Value&quot; <span class="hljs-keyword">FROM</span> &quot;foo&quot;;<br><br>  # Correction<br>  &gt; <span class="hljs-keyword">SELECT</span> SETVAL((<span class="hljs-keyword">SELECT</span> PG_GET_SERIAL_SEQUENCE(<span class="hljs-string">&#x27;&quot;foo&quot;&#x27;</span>, <span class="hljs-string">&#x27;foo_id&#x27;</span>)), (<span class="hljs-keyword">SELECT</span> (MAX(&quot;foo_id&quot;) + <span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> &quot;foo&quot;), <span class="hljs-keyword">FALSE</span>);<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.howtoing.com/how-to-migrate-mysql-database-to-postgres-using-pgloader">如果使用pgloader将MySQL数据库迁移到PostgreSQL</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Build Go Executables for Multiple Platforms</title>
    <url>/2021/10/26/Build-Go-Executables-for-Multiple-Platforms/</url>
    <content><![CDATA[<h1 id="构建Go可执行文件"><a href="#构建Go可执行文件" class="headerlink" title="构建Go可执行文件"></a>构建Go可执行文件</h1><blockquote>
<p>Go most powerful features is the ability to cross-build(跨平台交叉编译构建可执行文件)executables for any Go-supported foreign platform.</p>
</blockquote>
<span id="more"></span>

<h2 id="Installing-Go-Programs-from-Version-Control"><a href="#Installing-Go-Programs-from-Version-Control" class="headerlink" title="Installing Go Programs from Version Control"></a>Installing Go Programs from Version Control</h2><figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go">$ <span class="hljs-keyword">go</span> get -u <span class="hljs-keyword">package</span>-<span class="hljs-keyword">import</span>-path<br></code></pre></td></tr></table></figure>

<h2 id="Building-an-Executable"><a href="#Building-an-Executable" class="headerlink" title="Building an Executable"></a>Building an Executable</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># This command creates the executable, and also create the ./build directory if it doesn&#x27;t exist</span><br>$ go build -o build<span class="hljs-regexp">/caddy-server github.com/m</span>holt<span class="hljs-regexp">/caddy/</span>caddy<br></code></pre></td></tr></table></figure>

<h2 id="Installing-an-Executable"><a href="#Installing-an-Executable" class="headerlink" title="Installing an Executable"></a>Installing an Executable</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ go install github.com<span class="hljs-regexp">/mholt/</span>caddy/caddy<br></code></pre></td></tr></table></figure>

<h2 id="Cross-Compiling"><a href="#Cross-Compiling" class="headerlink" title="Cross Compiling"></a>Cross Compiling</h2><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">&gt; Cross-compiling works <span class="hljs-keyword">by</span> setting required environment variables that specify <span class="hljs-keyword">the</span> target operating <span class="hljs-keyword">system</span> <span class="hljs-keyword">and</span> architecture.<br>   - GOOS: <span class="hljs-keyword">the</span> target operating <span class="hljs-keyword">system</span><br>   - GOARCH: <span class="hljs-keyword">the</span> target architecture<br><br><span class="hljs-comment"># the env command runs a program in a modified environment.</span><br>$ env GOOS=target-OS GOARCH=target-architecture go build package-import-path<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">GOOS - Target Operating System</th>
<th align="center">GOARCH - Target Platform</th>
</tr>
</thead>
<tbody><tr>
<td align="center">android</td>
<td align="center">arm</td>
</tr>
<tr>
<td align="center">darwin</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">darwin</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">darwin</td>
<td align="center">arm</td>
</tr>
<tr>
<td align="center">darwin</td>
<td align="center">arm64</td>
</tr>
<tr>
<td align="center">dragonfly</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">freebsd</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">freebsd</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">freebsd</td>
<td align="center">arm</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">arm</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">arm64</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">ppc64</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">ppc64le</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">mips</td>
</tr>
<tr>
<td align="center">linux</td>
<td align="center">mips64le</td>
</tr>
<tr>
<td align="center">netbsd</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">netbsd</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">netbsd</td>
<td align="center">arm</td>
</tr>
<tr>
<td align="center">openbsd</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">openbsd</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">openbsd</td>
<td align="center">arm</td>
</tr>
<tr>
<td align="center">plan9</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">plan9</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">solaris</td>
<td align="center">amd64</td>
</tr>
<tr>
<td align="center">windows</td>
<td align="center">386</td>
</tr>
<tr>
<td align="center">windows</td>
<td align="center">amd64</td>
</tr>
</tbody></table>
<h2 id="Creating-a-Script-to-Automate-Cross-Compilation"><a href="#Creating-a-Script-to-Automate-Cross-Compilation" class="headerlink" title="Creating a Script to Automate Cross-Compilation"></a>Creating a Script to Automate Cross-Compilation</h2><figure class="highlight clean"><table><tr><td class="code"><pre><code class="hljs clean">$ cd ~<br>$ vim go-executable-build.sh<br>#!/usr/bin/env bash<br><br>######################################################################<br># @author      : chyiyaqing (<span class="hljs-number">404</span>@gmail.com)<br># @file        : go-executable-build<br># @created     : Tuesday Oct <span class="hljs-number">26</span>, <span class="hljs-number">2021</span> <span class="hljs-number">18</span>:<span class="hljs-number">22</span>:<span class="hljs-number">35</span> CST<br>#<br># @description : Creating a Script to Automate Cross-Compilation go build<br>######################################################################<br><br># $<span class="hljs-number">0</span> -- contains the name <span class="hljs-keyword">of</span> the script you executed<br>package=$<span class="hljs-number">1</span><br><br># Make sure the user provided this value<br><span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">&quot;$package&quot;</span>  ]]; then<br>   echo <span class="hljs-string">&quot;usage: $0 &lt;package-name&gt;&quot;</span><br>   # <span class="hljs-number">0</span> for successful executions and any non-zero value for unsuccessful executions<br>   exit <span class="hljs-number">1</span><br>fi<br><br># extract the package name <span class="hljs-keyword">from</span> the ath<br>package_split=($&#123;package<span class="hljs-comment">//\// &#125;)</span><br>package_name=$&#123;package_split[<span class="hljs-number">-1</span>]&#125;<br><br>platforms=(<span class="hljs-string">&quot;linux/amd64&quot;</span>, <span class="hljs-string">&quot;darwin/amd64&quot;</span>, <span class="hljs-string">&quot;linux/arm64&quot;</span>, <span class="hljs-string">&quot;darwin/arm64&quot;</span>)<br><br># ierate though the array <span class="hljs-keyword">of</span> platforms, split each platform into values for the GOOS and GOARCH<br>for platform <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;$&#123;platform[@]&#125;&quot;</span><br>do<br>   platform_split = ($&#123;platform<span class="hljs-comment">//\// &#125;)</span><br>   GOOS=$&#123;platform_split[<span class="hljs-number">0</span>]&#125;<br>   GOARCH=$&#123;platform_split[<span class="hljs-number">1</span>]&#125;<br><br>   output_name=$package_name<span class="hljs-string">&#x27;-&#x27;</span>$GOOS<span class="hljs-string">&#x27;-&#x27;</span>$GOARCH<br><br>   <span class="hljs-keyword">if</span> [ $GOOS = <span class="hljs-string">&quot;windows&quot;</span>  ]; then<br>    ¦   output_name+=<span class="hljs-string">&#x27;.exe&#x27;</span><br>   fi<br><br>   env GOOS=$GOOS GOARCH=$GOARCH go build -o $output_name $package<br><br>   # check <span class="hljs-keyword">if</span> there were errors building the executable<br>   <span class="hljs-keyword">if</span> [ $? -ne <span class="hljs-number">0</span>  ]; then<br>      echo <span class="hljs-string">&#x27;An error has occurred! Aborting the script execution...&#x27;</span><br>     ¦exec <span class="hljs-number">1</span><br>   fi<br>done<br></code></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Git Intro</title>
    <url>/2021/10/26/Git-Intro/</url>
    <content><![CDATA[<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><span id="more"></span>

<h2 id="git-commit-message"><a href="#git-commit-message" class="headerlink" title="git commit message"></a>git commit message</h2><ul>
<li>git commit -m “<type>(<scope>): <subject>“<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># type:</span><br><span class="hljs-bullet">  -</span> feat: feature<br><span class="hljs-bullet">  -</span> fix: fix bug<br><span class="hljs-bullet">  -</span> docs: 修改README<br><span class="hljs-bullet">  -</span> style: 格式化<br><span class="hljs-bullet">  -</span> refactor: 代码重构<br><span class="hljs-bullet">  -</span> test: 测试<br><span class="hljs-bullet">  -</span> chore: 改变构建流程，增加依赖库<br><span class="hljs-bullet">  -</span> perf: 性能优化<br><span class="hljs-bullet">  -</span> revert: 回滚到上一个版本<br><br><span class="hljs-section"># scope:</span><br>  &gt; 说明commit影响的范围 [数据层、控制层、视图层]<br><br><span class="hljs-section"># subject:</span><br>  &gt; commit目的的简短描述,不超过50个字符<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Git-Stats"><a href="#Git-Stats" class="headerlink" title="Git Stats"></a>Git Stats</h2><ul>
<li><ol>
<li>Roll your own stats with git’s command line options<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Unix&amp;Linux FAQ</title>
    <url>/2021/10/27/Unix-Linux-FAQ/</url>
    <content><![CDATA[<h2 id="查看状态信息"><a href="#查看状态信息" class="headerlink" title="查看状态信息"></a>查看状态信息</h2><ul>
<li><ol>
<li>calculate total disk space<figure class="highlight brainfuck"><table><tr><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">$</span> <span class="hljs-comment">df</span> <span class="hljs-literal">-</span><span class="hljs-comment">h</span> --<span class="hljs-comment">output=size</span> --<span class="hljs-comment">total</span><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="2">
<li>dig &amp; nslookup<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash"> dig, nslookup 用于网络故障排除和收集有关域名的信息</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Dig: Domain Information Gopher</span><br><span class="hljs-meta">  &gt;</span><span class="bash"> 一种DNS查找程序,用于探测DNS服务器并对与DNS服务相关的问题进行故障排查</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> Nslookup:</span> <br></code></pre></td></tr></table></figure>
<h2 id="内核参数调优"><a href="#内核参数调优" class="headerlink" title="内核参数调优"></a>内核参数调优</h2></li>
</ol>
</li>
<li></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Hacker Scripts</title>
    <url>/2021/10/31/Hacker-Scripts/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>My World</title>
    <url>/2021/11/03/My-World/</url>
    <content><![CDATA[<h1 id="My-World-我的世界"><a href="#My-World-我的世界" class="headerlink" title="My World (我的世界)"></a>My World (我的世界)</h1><span id="more"></span>
<h2 id="Jargon"><a href="#Jargon" class="headerlink" title="Jargon"></a>Jargon</h2><ul>
<li>IMO: In My Opinion</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>School of SRE</title>
    <url>/2021/11/16/School-of-SRE/</url>
    <content><![CDATA[<h1 id="SRE-Site-Reliability-Engineers"><a href="#SRE-Site-Reliability-Engineers" class="headerlink" title="SRE (Site Reliability Engineers)"></a>SRE (Site Reliability Engineers)</h1><ul>
<li>Level 101<ul>
<li><a href="#fundamentals-series">Fundamentals Series</a><ul>
<li>Linux Basics</li>
<li>Git</li>
<li>Linux Networking</li>
</ul>
</li>
<li><a href="#python-and-web">Python and Web</a></li>
<li>Data<ul>
<li>Relational databasees(MySQL)</li>
<li>NoSQL concepts</li>
<li>Big Data</li>
</ul>
</li>
<li>Systems Design</li>
<li>Metrics and Monitoring</li>
<li>Security</li>
</ul>
</li>
<li>Level 102<ul>
<li>Linux Intermediate</li>
<li>Linux Advanced<ul>
<li>Containers and orchestration</li>
<li>System Calls and Signals</li>
</ul>
</li>
<li>Networking</li>
<li>System Design</li>
<li>System troubleshooting and performance improvements</li>
<li>Continuous Integration and Continuous Delivery</li>
</ul>
</li>
</ul>
<span id="more"></span>


<h2 id="Fundamentals-Series"><a href="#Fundamentals-Series" class="headerlink" title="Fundamentals Series"></a>Fundamentals Series</h2><figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-built_in">say</span> hello<br></code></pre></td></tr></table></figure>

<h2 id="Python-and-Web"><a href="#Python-and-Web" class="headerlink" title="Python and Web"></a>Python and Web</h2><figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-built_in">say</span> python<br></code></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>Markdown Intro</title>
    <url>/2021/11/18/Markdown-Intro/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Patterns of Distributed Systems</title>
    <url>/2021/11/25/Patterns-of-Distributed-Systems/</url>
    <content><![CDATA[<h1 id="Patterns-of-Distributed-Systems"><a href="#Patterns-of-Distributed-Systems" class="headerlink" title="Patterns of Distributed Systems"></a>Patterns of Distributed Systems</h1><ul>
<li>Distributed systems - An implementation perspective<table>
<thead>
<tr>
<th align="left">Type of platform/framework</th>
<th align="left">Example</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Databases</td>
<td align="left">Cassandra, HBase, Riak</td>
</tr>
<tr>
<td align="left">Message Brokers</td>
<td align="left">Kafka, Pulsar</td>
</tr>
<tr>
<td align="left">Infrastructure</td>
<td align="left">Kubernetes, Mesos, Zookeeper, etcd, Consul</td>
</tr>
<tr>
<td align="left">In Memory Data/Compute Grids</td>
<td align="left">Hazelcast, Pivotal Gemfire</td>
</tr>
<tr>
<td align="left">Stateful Microservices</td>
<td align="left">Akka Actors, Axon</td>
</tr>
<tr>
<td align="left">File Systems</td>
<td align="left">HDFS, Ceph</td>
</tr>
</tbody></table>
</li>
</ul>
<span id="more"></span>


<h2 id="Problems-and-Their-Recurriing-Solutions"><a href="#Problems-and-Their-Recurriing-Solutions" class="headerlink" title="Problems and Their Recurriing Solutions"></a>Problems and Their Recurriing Solutions</h2><blockquote>
<p>Serveral things can go wrong when data is stored on multiple servers.</p>
</blockquote>
<ul>
<li><p>Process crashes</p>
<ul>
<li>It can be taken down for routine maintenance by system administrators</li>
<li>It can be killed doing some file IO because the disk if full and the exception is not properly handled.</li>
<li>It cloud environments, it can be even trickier, as some unrelated events can bring the servers down.<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">&gt; Flushing data <span class="hljs-keyword">to</span> the disk <span class="hljs-keyword">is</span> one <span class="hljs-keyword">of</span> the most <span class="hljs-type">time</span> consuming operations, <span class="hljs-keyword">not</span> every <span class="hljs-keyword">insert</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">to</span> the <span class="hljs-keyword">storage</span> can be flushed <span class="hljs-keyword">to</span> disk.<br><br># <span class="hljs-keyword">Write</span>-Ahead <span class="hljs-keyword">Log</span><br>&gt; Servers store <span class="hljs-keyword">each</span> state change <span class="hljs-keyword">as</span> a command <span class="hljs-keyword">in</span> an append-<span class="hljs-keyword">only</span> file <span class="hljs-keyword">on</span> a hard disk. Appending a file <span class="hljs-keyword">is</span> generally a very fast operation, so it can be done <span class="hljs-keyword">without</span> impacting performance. This gives a durability guarantee. The data will <span class="hljs-keyword">not</span> <span class="hljs-keyword">get</span> lost even <span class="hljs-keyword">if</span> the <span class="hljs-keyword">server</span> abruptly crashes <span class="hljs-keyword">and</span> <span class="hljs-keyword">then</span> restarts<br><br>&gt; But clients will <span class="hljs-keyword">not</span> be able <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> <span class="hljs-keyword">or</span> store <span class="hljs-keyword">any</span> data till the <span class="hljs-keyword">server</span> <span class="hljs-keyword">is</span> back up. lack availability <span class="hljs-keyword">in</span> the <span class="hljs-keyword">case</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">server</span> failure. One <span class="hljs-keyword">of</span> the obvious solutions <span class="hljs-keyword">is</span> <span class="hljs-keyword">to</span> store the data <span class="hljs-keyword">on</span> multiple servers. So we can replicate the <span class="hljs-keyword">write</span> ahead <span class="hljs-keyword">log</span> <span class="hljs-keyword">on</span> multiple servers.<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Network delays(延迟)</p>
<blockquote>
<p>In the TCP/IP protocol stack, there is no upper bound on delays caused in transmitting messages across a network.</p>
</blockquote>
<ul>
<li>A particular server can not wait indefinitely(无期限) to know if another server has crashed.<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">&gt; To tackle <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> problem, every server sends <span class="hljs-keyword">a</span> HeartBeat message <span class="hljs-built_in">to</span> other servers <span class="hljs-keyword">at</span> <span class="hljs-keyword">a</span> regular interval.<br></code></pre></td></tr></table></figure></li>
<li>There should not be two set of servers, each considering another set to have failed, and therefore continuing to serve different sets of clients. This is called the split brain(脑裂)<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">In gneral, If we want <span class="hljs-built_in">to</span> tolerate f failures we need <span class="hljs-built_in">to</span> cluster size <span class="hljs-keyword">of</span> <span class="hljs-number">2</span>f + <span class="hljs-number">1.</span><br><br>Leader <span class="hljs-keyword">and</span> Followers is used <span class="hljs-keyword">in</span> this situation. One <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> servers is elected <span class="hljs-keyword">a</span> leader <span class="hljs-keyword">and</span> <span class="hljs-keyword">the</span> other servers acts <span class="hljs-keyword">as</span> followers.<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Process Pauses</p>
<ul>
<li>Generation Clock<blockquote>
<p>A monotenically increasing number indicating the generation of the server.</p>
</blockquote>
</li>
</ul>
</li>
<li><p>Unsynchronized Clocks and Ordering Events</p>
<blockquote>
<p>The main reason we can not use system clocks is that system clocks across servers are not guaranteed to be synchronized. A time-of-the day clock in a computer is amanaged by a quartz crystal and measures time based on the oscilations of the crystal.<br>The clocks across a set of servers are synchronized by a service called NTP. This service periodically checks a set of global time servers, and adjusts the computer clock accordingly.</p>
</blockquote>
<ul>
<li>Lamport(烂波特) Clock<blockquote>
<p>Use logical timestamps as a version for a value to allow ordering of values across servers.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h2 id="Pattern-Sequence"><a href="#Pattern-Sequence" class="headerlink" title="Pattern Sequence"></a>Pattern Sequence</h2><blockquote>
<p>In very simple terms, Consensus(共识) refers to a set of servers which agree on stored data, the order in which the data is stored and when to make that data visible to the clients.</p>
</blockquote>
<ul>
<li>Pattern Sequence(序列) for implementing consensus<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf">Consensus implementations use <span class="hljs-keyword">state</span> machine replication <span class="hljs-keyword">to</span> achieve fault tolerance.<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><ul>
<li>Raft</li>
<li>Zab</li>
<li>Cassandra</li>
<li>Epoch’s in Kafka</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>websocket intro</title>
    <url>/2021/12/01/websocket-intro/</url>
    <content><![CDATA[<h1 id="The-Websocket-Protocol"><a href="#The-Websocket-Protocol" class="headerlink" title="The Websocket Protocol"></a>The Websocket Protocol</h1><ul>
<li><p>Introduction</p>
<ul>
<li><p>Background</p>
<ul>
<li>variety of problem<ul>
<li>The server is forced to use a number of different underlying TCP connections for each client: one for sending information to the client and a new one for each incoming message.</li>
<li>The wire protocol has a high overhead, with each client-to-server message having an HTTP header.</li>
<li>The client-side script is forced to maintain a mapping from the outgoing connections to the incoming connection to track replies.</li>
</ul>
</li>
</ul>
</li>
<li><p>Protocol Overview</p>
<ul>
<li>The protocol has two parts: a handshake and the data transfer.<ul>
<li>The handshake from the client looks as follows<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<span id="more"></span>

<ul>
<li>publisher-subscriber server<ul>
<li>(as known as a bus, message broker, or event-channel)<ul>
<li>receive notifications about state changes on the one hand, and subscriptions for such notifications on the other.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/misc/images/websocket.png" alt="websocket"></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p>[]</p>
]]></content>
  </entry>
  <entry>
    <title>RAID Intro</title>
    <url>/2021/12/12/RAID-Intro/</url>
    <content><![CDATA[<h1 id="RAID"><a href="#RAID" class="headerlink" title="RAID"></a>RAID</h1><blockquote>
<p>stands for Redundant Array of Inexpensive Disks(廉价磁盘冗余阵列)</p>
</blockquote>
<ul>
<li><p>Hardware RAID</p>
<blockquote>
<p>Hardware RAID using controllers or RAID cards to manage the RAID configuration independently from the operating system.</p>
</blockquote>
</li>
<li><p>Software RAID</p>
<blockquote>
<p>Software RAID tends to be slower than hardware RAID.</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<h2 id="RAID-Level-Comparision"><a href="#RAID-Level-Comparision" class="headerlink" title="RAID Level Comparision"></a>RAID Level Comparision</h2><ul>
<li><p>RAID 0<br><img src="/misc/images/raid/raid0.jpg" alt="raid 0"></p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">&gt; data are <span class="hljs-built_in">split</span> up <span class="hljs-keyword">into</span> blocks that <span class="hljs-built_in">get</span> written across all <span class="hljs-keyword">the</span> drivers <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> array. By <span class="hljs-keyword">using</span> multiple disks (<span class="hljs-keyword">at</span> least <span class="hljs-number">2</span>) <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> same <span class="hljs-built_in">time</span>, this offers fast <span class="hljs-built_in">read</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">write</span> speeds.<br><span class="hljs-comment"># Downside</span><br>  - RAID <span class="hljs-number">0</span> is <span class="hljs-keyword">not</span> redundant, <span class="hljs-keyword">the</span> loss <span class="hljs-keyword">of</span> <span class="hljs-keyword">any</span> individual will cause complete data loss.<br></code></pre></td></tr></table></figure></li>
<li><p>RAID 1<br><img src="/misc/images/raid/raid1.jpg" alt="raid 1"></p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">RAID <span class="hljs-number">1</span> is setup <span class="hljs-keyword">of</span> <span class="hljs-keyword">at</span> least <span class="hljs-literal">two</span> drives.<br>RAID <span class="hljs-number">1</span> is high <span class="hljs-built_in">read</span> performance, <span class="hljs-keyword">as</span> data can be <span class="hljs-built_in">read</span> off <span class="hljs-keyword">any</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> drives <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> array.<br>Since <span class="hljs-keyword">the</span> data needs <span class="hljs-built_in">to</span> be written <span class="hljs-built_in">to</span> all <span class="hljs-keyword">the</span> drives <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> array, <span class="hljs-keyword">the</span> <span class="hljs-built_in">write</span> speed is slower than <span class="hljs-keyword">a</span> RAID <span class="hljs-number">0</span> array.<br></code></pre></td></tr></table></figure></li>
<li><p>RAID 5<br><img src="/misc/images/raid/raid5.jpg" alt="raid 5"></p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-string">&quot;parity&quot;</span> distributed across <span class="hljs-keyword">the</span> drives.<br>READ speed <span class="hljs-keyword">is</span> very fast <span class="hljs-keyword">but</span> <span class="hljs-built_in">write</span> speed <span class="hljs-keyword">is</span> somewhat slower due <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> partity <span class="hljs-keyword">that</span> has <span class="hljs-keyword">to</span> be calculated.<br></code></pre></td></tr></table></figure></li>
<li><p>RAID 6<br><img src="/misc/images/raid/raid6.jpg" alt="raid 6"></p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">Read speed <span class="hljs-keyword">is</span> <span class="hljs-keyword">as</span> fast <span class="hljs-keyword">as</span> RAID <span class="hljs-number">5</span>, <span class="hljs-keyword">but</span> <span class="hljs-built_in">write</span> speed <span class="hljs-keyword">is</span> slower than RAID <span class="hljs-number">5.</span><br>RAID <span class="hljs-number">6</span> <span class="hljs-keyword">is</span> a very good option <span class="hljs-keyword">for</span> a standard web server, <span class="hljs-keyword">where</span> most <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> transactions are reads, <span class="hljs-keyword">but</span> <span class="hljs-keyword">its</span> <span class="hljs-keyword">not</span> recommanded <span class="hljs-keyword">for</span> a heavy <span class="hljs-built_in">write</span> environment.<br></code></pre></td></tr></table></figure></li>
<li><p>RAID 10<br><img src="/misc/images/raid/raid10.jpg" alt="raid 10"></p>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">RAID</span> <span class="hljs-number">10</span> can provide the speed of RAID <span class="hljs-number">0</span> with the redundancy of RAID <span class="hljs-number">1</span>.<br></code></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight tcl"><table><tr><td class="code"><pre><code class="hljs tcl">chyiyaqing in ~ at chyiyaqing-PowerEdge-R720<br>➜ cat /<span class="hljs-keyword">proc</span>/scsi/scsi<span class="hljs-title"></span><br><span class="hljs-title">Attached</span> devices:<span class="hljs-title"></span><br><span class="hljs-title">Host:</span> scsi0<span class="hljs-title"> Channel:</span> 02<span class="hljs-title"> Id:</span> 00<span class="hljs-title"> Lun:</span> 00<span class="hljs-title"></span><br><span class="hljs-title">  Vendor:</span> DELL<span class="hljs-title">     Model:</span> PERC<span class="hljs-title"> H710</span> <span class="hljs-title">       Rev:</span> 3.13<span class="hljs-title"></span><br><span class="hljs-title">  Type:</span> <span class="hljs-title">  Direct-Access</span> <span class="hljs-title">                   ANSI</span> <span class="hljs-title"> SCSI</span> revision: 05<br></code></pre></td></tr></table></figure>


<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://medium.com/@dataplugshk/raid-level-comparison-raid-0-raid-1-raid-5-raid-6-and-raid-10-6d64210544a9">raid level</a></p>
]]></content>
  </entry>
  <entry>
    <title>Kubernetes NodePort vs LoadBalancer vs Ingress Intro</title>
    <url>/2021/12/13/Kubernetes-NodePort-vs-LoadBalancer-vs-Ingress-Intro/</url>
    <content><![CDATA[<h1 id="NodePort-vs-LoadBalancer-vs-Ingress"><a href="#NodePort-vs-LoadBalancer-vs-Ingress" class="headerlink" title="NodePort vs LoadBalancer vs Ingress"></a>NodePort vs LoadBalancer vs Ingress</h1><span id="more"></span>

<h2 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h2><blockquote>
<p>A ClusterIP service is the default Kubernetes service. It gives you a service inside your cluster that other apps inside your cluster can access. There is no external access.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-internal-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br></code></pre></td></tr></table></figure>
<p><img src="/misc/images/k8s_clusterip.png" alt="Kubernetes ClusterIP"></p>
<h2 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h2><blockquote>
<p>NodePort, opens a specific port on all the Nodes, and any traffic that is sent to this port is forwarded to the service.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-nodeport-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30036</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br></code></pre></td></tr></table></figure>

<p><img src="/misc/images/k8s_nodeport.png" alt="Kubernetes NodePort"></p>
<figure class="highlight vhdl"><table><tr><td class="code"><pre><code class="hljs vhdl"><span class="hljs-number">1</span>. You can only have one service per <span class="hljs-keyword">port</span><br><span class="hljs-number">2</span>. You can only <span class="hljs-keyword">use</span> ports <span class="hljs-number">30000</span>-<span class="hljs-number">32767</span><br><span class="hljs-number">3</span>. You need <span class="hljs-keyword">to</span> track which node have pods <span class="hljs-keyword">with</span> exposed ports<br><br>Don<span class="hljs-symbol">&#x27;t</span> recommand using this method <span class="hljs-keyword">in</span> production <span class="hljs-keyword">to</span> directly expose your service.<br></code></pre></td></tr></table></figure>

<h2 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h2><blockquote>
<p>A LoadBalancer service is the standard way to expose a service to the interne.</p>
</blockquote>
<p><img src="/misc/images/k8s_loadbalancer.png" alt="Kubernetes LoadBalancer"></p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">Traffic <span class="hljs-keyword">on</span> the port you specify will be forwarded <span class="hljs-keyword">to</span> the service. There <span class="hljs-keyword">is</span> <span class="hljs-keyword">no</span> filtering, <span class="hljs-keyword">no</span> routing, etc. This means you can send almost <span class="hljs-keyword">any</span> kind <span class="hljs-keyword">of</span> traffic <span class="hljs-keyword">to</span> it. <span class="hljs-keyword">like</span> HTTP, TCP, UDP, Websockets, gRPC, <span class="hljs-keyword">or</span> whatever.<br></code></pre></td></tr></table></figure>

<h2 id="Ingress-L7-HTTP-Load-Balancer"><a href="#Ingress-L7-HTTP-Load-Balancer" class="headerlink" title="Ingress - L7 HTTP Load Balancer"></a>Ingress - L7 HTTP Load Balancer</h2><blockquote>
<p>Ingress is not a type of service, Instead, it sits in front of multiple services and act as a “smart router” or entrypoint into your cluster.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">backend:</span><br>    <span class="hljs-attr">serviceName:</span> <span class="hljs-string">other</span><br>    <span class="hljs-attr">servicePort:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">foo.mydomain.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>        <span class="hljs-attr">serviceName:</span> <span class="hljs-string">foo</span><br>        <span class="hljs-attr">servicePort:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">mydomain.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/bar/*</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">seviceName:</span> <span class="hljs-string">bar</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>

<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">Ingress is <span class="hljs-keyword">the</span> most useful <span class="hljs-keyword">if</span> you want <span class="hljs-built_in">to</span> expose multiple services under <span class="hljs-keyword">the</span> same IP address, <span class="hljs-keyword">and</span> these servcies all use same L7 protocol<br><br>Under <span class="hljs-keyword">the</span> hood, Ingress will use <span class="hljs-keyword">a</span> NodePort <span class="hljs-keyword">or</span> LoadBalancer service <span class="hljs-built_in">to</span> expose itself <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> world so <span class="hljs-keyword">it</span> can act <span class="hljs-keyword">as</span> that proxy.<br></code></pre></td></tr></table></figure>

<h2 id="Cheat-Sheet"><a href="#Cheat-Sheet" class="headerlink" title="Cheat Sheet"></a>Cheat Sheet</h2><table>
<thead>
<tr>
<th align="left"></th>
<th align="left">NodePort</th>
<th align="left">LoadBalancer</th>
<th align="left">Ingress</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Supported by core Kubernetes</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Works on every platform Kubernetes will deploy</td>
<td align="left">Yes</td>
<td align="left">Only supports a few public clouds. MetalLB project allows use on-premises.</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Direct access to service</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">Proxies each service through third party(NGINX, HAProxy)</td>
<td align="left">No</td>
<td align="left">No</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Multiple ports per service</td>
<td align="left">No</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Multiple services per IP</td>
<td align="left">Yes</td>
<td align="left">No</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Allows use of standard service ports (80,443,etc)</td>
<td align="left">No</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Have to track individual node IPs</td>
<td align="left">Yes</td>
<td align="left">No</td>
<td align="left">Yes, When using NodePort; No, when using LoadBalancer</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Cloud Native</category>
      </categories>
  </entry>
  <entry>
    <title>Kubernetes Volumes Intro</title>
    <url>/2021/12/16/Kubernetes-Volumes-Intro/</url>
    <content><![CDATA[<h1 id="Volumes-in-Kubernetes"><a href="#Volumes-in-Kubernetes" class="headerlink" title="Volumes in Kubernetes"></a>Volumes in Kubernetes</h1><span id="more"></span>

<h2 id="Types-of-Kubernetes-Volumes"><a href="#Types-of-Kubernetes-Volumes" class="headerlink" title="Types of Kubernetes Volumes"></a>Types of Kubernetes Volumes</h2><ul>
<li>emptyDir:</li>
</ul>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">It <span class="hljs-keyword">is</span> a type <span class="hljs-keyword">of</span> volume <span class="hljs-keyword">is</span> created when a Pod <span class="hljs-keyword">is</span> <span class="hljs-keyword">first</span> assigned <span class="hljs-keyword">to</span> a Node. It remains active <span class="hljs-keyword">as</span> long <span class="hljs-keyword">as</span> <span class="hljs-keyword">the</span> Pod <span class="hljs-keyword">is</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">that</span> node. The volume <span class="hljs-keyword">is</span> initially empty <span class="hljs-keyword">and</span> <span class="hljs-keyword">the</span> containers <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> pod can <span class="hljs-built_in">read</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">write</span> <span class="hljs-keyword">the</span> files <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> emptyDir volume. Once <span class="hljs-keyword">the</span> Pod <span class="hljs-keyword">is</span> removed <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> node, <span class="hljs-keyword">the</span> data <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> emptyDir <span class="hljs-keyword">is</span> erased.<br></code></pre></td></tr></table></figure>

<ul>
<li>hostPath:</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">This type <span class="hljs-keyword">of</span> volume mounts <span class="hljs-keyword">a</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">directory</span> <span class="hljs-built_in">from</span> <span class="hljs-keyword">the</span> host node<span class="hljs-string">&#x27;s filesystem into your pod.</span><br></code></pre></td></tr></table></figure>

<ul>
<li>gcePersistentDisk</li>
</ul>
<figure class="highlight haskell"><table><tr><td class="code"><pre><code class="hljs haskell"><span class="hljs-type">This</span> <span class="hljs-class"><span class="hljs-keyword">type</span> of volume mounts a <span class="hljs-type">Google</span> <span class="hljs-type">Compute</span> <span class="hljs-type">Engine</span> (<span class="hljs-type">GCE</span>) <span class="hljs-type">Persistent</span> <span class="hljs-type">Disk</span> into your <span class="hljs-type">Pod</span>. <span class="hljs-type">The</span> <span class="hljs-keyword">data</span> in gcePersistentDisk remains intact when the <span class="hljs-type">Pod</span> is removed from the node.</span><br></code></pre></td></tr></table></figure>

<ul>
<li>awsElasticBlockStore</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><code class="hljs livecodeserver">This type <span class="hljs-keyword">of</span> volume mounts <span class="hljs-keyword">an</span> Amazon Web Services (AWS) Elastic Block Store <span class="hljs-keyword">into</span> your Pod. Just like gcePersistentDisk, <span class="hljs-keyword">the</span> data <span class="hljs-keyword">in</span> <span class="hljs-keyword">an</span> awsElasticBlockStore remains intact when <span class="hljs-keyword">the</span> Pod is removed <span class="hljs-built_in">from</span> <span class="hljs-keyword">the</span> node.<br></code></pre></td></tr></table></figure>

<ul>
<li>nfs</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">An nfs volume allows an existing NFS (Network File <span class="hljs-keyword">System</span>) <span class="hljs-keyword">to</span> be mounted <span class="hljs-keyword">into</span> your Pod. the data <span class="hljs-keyword">in</span> an nfs volume <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> erased <span class="hljs-keyword">when</span> the Pod <span class="hljs-keyword">is</span> removed <span class="hljs-keyword">from</span> the node. The volume <span class="hljs-keyword">is</span> <span class="hljs-keyword">only</span> unmounted<br></code></pre></td></tr></table></figure>

<ul>
<li>gitRepo</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Cloud Native</category>
      </categories>
  </entry>
  <entry>
    <title>Virsh Commands CheatSheet Intro</title>
    <url>/2021/12/28/Virsh-Commands-CheatSheet-Intro/</url>
    <content><![CDATA[<h1 id="Virsh-Commands-CheatSheet"><a href="#Virsh-Commands-CheatSheet" class="headerlink" title="Virsh Commands CheatSheet"></a>Virsh Commands CheatSheet</h1><blockquote>
<p>Virsh interacts with Libviry which is a library aimed at providing a long-term stable C API. It currently supports Xen, QEMU, KVM, LXC, OpenVZ, VirtualBox and VMware ESX.</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">$ virsh [OPTION]… <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">domain</span>&gt;</span> [ARG]…<br></code></pre></td></tr></table></figure>

<span id="more"></span>

<ul>
<li><ol>
<li>Virsh displat node information<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[blocface@centos ~]</span>$ sudo virsh nodeinfo<br>setlocale: No such file or directory<br>CPU model:           x86_64<br><span class="hljs-function"><span class="hljs-title">CPU</span><span class="hljs-params">(s)</span></span>:              <span class="hljs-number">48</span><br>CPU frequency:       <span class="hljs-number">1883</span> MHz<br>CPU socket(s):       <span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-title">Core</span><span class="hljs-params">(s)</span></span> per socket:  <span class="hljs-number">12</span><br><span class="hljs-function"><span class="hljs-title">Thread</span><span class="hljs-params">(s)</span></span> per core:  <span class="hljs-number">2</span><br>NUMA cell(s):        <span class="hljs-number">2</span><br>Memory size:         <span class="hljs-number">131608380</span> KiB<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="2">
<li>Virsh list all domains<figure class="highlight asciidoc"><table><tr><td class="code"><pre><code class="hljs asciidoc">[blocface@centos ~]$ sudo virsh list --all<br>setlocale: No such file or directory<br><span class="hljs-section"> Id    Name                           State</span><br><span class="hljs-section">----------------------------------------------------</span><br><span class="hljs-code"> 4     node4                          running</span><br><span class="hljs-code"> 14    node1                          running</span><br><span class="hljs-code"> 15    node5                          running</span><br><span class="hljs-code"> 17    node3                          running</span><br><span class="hljs-code"> 18    node2                          running</span><br><span class="hljs-code"> -     centos                         shut off</span><br><span class="hljs-code"> -     template                       shut off</span><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="3">
<li>Virsh rename domain<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h2 id="参考手册"><a href="#参考手册" class="headerlink" title="参考手册"></a>参考手册</h2><ul>
<li><a href="https://computingforgeeks.com/virsh-commands-cheatsheet/">Virsh Commands</a></li>
</ul>
]]></content>
      <categories>
        <category>CLI</category>
      </categories>
  </entry>
  <entry>
    <title>Service Mesh And API Gateway</title>
    <url>/2022/01/05/Service-Mesh-And-API-Gateway/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>南北&amp;东西流量</title>
    <url>/2022/01/05/%E5%8D%97%E5%8C%97-%E4%B8%9C%E8%A5%BF%E6%B5%81%E9%87%8F/</url>
    <content><![CDATA[<h1 id="南北流量-amp-东西流量"><a href="#南北流量-amp-东西流量" class="headerlink" title="南北流量 &amp; 东西流量"></a>南北流量 &amp; 东西流量</h1><blockquote>
<p>南北流量和东西流量是数据中心环境中网络流量模式.</p>
</blockquote>
<ul>
<li><ol>
<li>什么是南北向流量?</li>
</ol>
</li>
<li><ol start="2">
<li>什么是东西向流量?</li>
</ol>
</li>
<li><ol start="3">
<li>什么是动态流量?</li>
</ol>
</li>
</ul>
<blockquote>
<p>当我们访问web应用时，会发生一下类型的网络流量:</p>
<blockquote>
<p>1.客户端(位于数据中心一侧的浏览器)与负载均衡器(位于数据中心)之间的网络流量.<br>2.负载均衡器、应用服务器、数据库等之间的网络流量，他们都位于数据中心.</p>
</blockquote>
</blockquote>
<p><img src="/misc/images/north-south-east-west-traffic.png" alt="网络流量"></p>
<span id="more"></span>

<h2 id="Traffic-Trends-In-Data-Center"><a href="#Traffic-Trends-In-Data-Center" class="headerlink" title="Traffic Trends In Data Center"></a>Traffic Trends In Data Center</h2><p><img src="/misc/images/traffic-trends-in-data-center.png" alt="Traffic Trends In Data Center"></p>
<h2 id="南北流量-North-South-traffic"><a href="#南北流量-North-South-traffic" class="headerlink" title="南北流量(North-South traffic)"></a>南北流量(North-South traffic)</h2><blockquote>
<p>南北流量是server-client流量</p>
</blockquote>
<h2 id="东西流量-East-West-traffic"><a href="#东西流量-East-West-traffic" class="headerlink" title="东西流量(East-West traffic)"></a>东西流量(East-West traffic)</h2><blockquote>
<p>不同服务器之间的流量与数据中心或不同数据中心之间的网络流被称为东西流量, 东西流量是server-server流量.<br>server-server流量远大于server-client流量<br>东西流量、南北流量这样命名来自于绘制典型network diagrams的习惯，在图表中，通常核心网络组件绘制在底部部(South),客户端会在顶部(North). 而数据中心内的不同服务器水平之间(East-West)绘制.</p>
</blockquote>
]]></content>
  </entry>
</search>
