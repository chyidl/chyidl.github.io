<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Docker Tips &amp; Tricks</title>
    <url>/2021/09/01/docker/</url>
    <content><![CDATA[<h2 id="Docker-Info"><a href="#Docker-Info" class="headerlink" title="Docker  Info"></a>Docker  Info</h2><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">容器技术的核心功能，就是通过约束和修改进程的动态表现，从而为其创造出一个“边界”</span><br><span class="line"></span><br><span class="line">Cgroups技术是用来制造约束的主要手段</span><br><span class="line"><span class="keyword">Namespace</span>技术则是用来修改进程试图的主要方法</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="Docker-architecture"><a href="#Docker-architecture" class="headerlink" title="Docker architecture"></a>Docker architecture</h2><blockquote>
<p>Docker uses a client-server architecture.</p>
</blockquote>
<p><img src="/misc/images/architecture.svg" alt="docker architecture"></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Docker 仓库操作</span></span><br><span class="line">  docker pull/push</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker 镜像管理</span></span><br><span class="line">  docker images/rmi/build</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker 生命周期管理</span></span><br><span class="line">  docker run/<span class="built_in">start</span>/stop/<span class="built_in">rm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># to delete all containers including its volumes use,</span></span><br><span class="line"><span class="variable">$</span> docker <span class="built_in">rm</span> <span class="literal">-vf</span> <span class="variable">$</span>(docker <span class="built_in">ps</span> <span class="literal">-a</span> <span class="literal">-q</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># to delete all the images</span></span><br><span class="line"><span class="variable">$</span> docker rmi <span class="operator">-f</span> <span class="variable">$</span>(docker images <span class="literal">-a</span> <span class="literal">-q</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Docker-Tips"><a href="#Docker-Tips" class="headerlink" title="Docker Tips"></a>Docker Tips</h2><ul>
<li><p><strong>Docker Tip #1</strong>: Docker 容器进程</p>
<blockquote>
<p>A Docker container is just a process/service that runs directly on your machine. It is slightly different than a regular process because the Docker daemon along with the linux kernel do a few things(<strong>Cgroups</strong>、<strong>Namespace</strong>) to ensure it runs in total isolation<br>Docker容器是一种特殊的进程,和虚拟机差别很大</p>
</blockquote>
</li>
<li><p><strong>Docker Tip #2</strong>: COPY vs. ADD in a Dockerfile</p>
<blockquote>
<p>COPY 和 ADD 功能很相似，都可以从指定目录拷贝数据到Docker镜像中.</p>
</blockquote>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"># <span class="keyword">COPY</span> 和 <span class="keyword">ADD</span> 区别</span><br><span class="line"><span class="number">1</span>. <span class="keyword">COPY</span>: 只能从本机文件或目录中拷贝到镜像中</span><br><span class="line"><span class="number">2</span>. <span class="keyword">ADD</span>: 不仅可以从本机文件或目录中拷贝，还可以使用URL引入外部的文件地址拷贝到镜像中</span><br><span class="line">  $ <span class="keyword">ADD</span> rootfs.tar.gz /</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #3</strong>: 追加 Docker Run 指令减少镜像大小</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Before Dockerfile -- 新增三个层lager</span></span><br><span class="line">RUN wget -O myfile.tar.gz http:<span class="regexp">//</span>example.com/myfile.tar.gz</span><br><span class="line">RUN tar -xvf myfile.tar.gz -C <span class="regexp">/usr/</span>src/myapp</span><br><span class="line">RUN rm myfile.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># After Dockerfile -- 新增一个层layer</span></span><br><span class="line">RUN wget -O myfile.tar.gz http:<span class="regexp">//</span>example.com/myfile.tar.gz \</span><br><span class="line">  &amp;&amp; tar -xvf myfile.tar.gz -C <span class="regexp">/usr/</span>src/myapp \</span><br><span class="line">  &amp;&amp; rm myfile.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #4</strong>: Docker Base镜像OS和Host OS没有关系</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">Docker <span class="built_in">Image</span> OS: 定义在Dockerfile文件的Base镜像的系统</span><br><span class="line">Host OS: 运行Docker <span class="built_in">image</span>的环境</span><br><span class="line">You can use whatever base <span class="built_in">image</span> you want <span class="keyword">for</span> your Docker images.</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #5</strong>: 使用相同Base镜像的好处</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">You could use a different base OS <span class="keyword">for</span> <span class="keyword">each</span> Docker image, but <span class="keyword">then</span> you lose <span class="keyword">out</span> <span class="keyword">on</span> the ability <span class="keyword">to</span> <span class="keyword">cache</span> it across all of your images</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #6</strong>: RUN vs. CMD in a Dockerfile</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">RUN:</span> 在镜像内执行命令，这些指令仅仅在构建build镜像中执行一次，并且将构建结果写入新larger层中.</span><br><span class="line"><span class="symbol">CMD:</span> 在启动容器时定义默认的运行的指令, 这种动作发生运行时run-time, 覆盖方式</span><br><span class="line"><span class="symbol">ENTRYPOINT:</span> 执行命令参数追加方式</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #7</strong>: Base Docker Image Alpine</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">Why Alpine?</span><br><span class="line">&gt; Small. Simple. Secure. Alpine Linux is a security-<span class="keyword">oriented, </span>lightweight Linux <span class="keyword">distribution </span><span class="keyword">based </span>on musl libc <span class="keyword">and </span><span class="keyword">busybox.</span></span><br><span class="line"><span class="keyword"></span>&gt; Alpine is about <span class="number">30</span>x smaller than Debian.</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #8</strong>: Project Structure with Multiple Dockerfiles and Docker Compose</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">ubuntu in ~/chyi/micro-services at <span class="number">3</span>BPlus <span class="keyword">on</span> 🐳 v20.<span class="number">10.8</span></span><br><span class="line">➜ tree -L <span class="number">2</span></span><br><span class="line">.</span><br><span class="line">├── auth</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">├── billing</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">├── contact</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── user</span><br><span class="line">    └── Dockerfile</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">5</span> <span class="keyword">files</span></span><br><span class="line"></span><br><span class="line">The docker-compose.yaml</span><br><span class="line">ubuntu in ~/chyi/micro-services at <span class="number">3</span>BPlus <span class="keyword">on</span> 🐳 v20.<span class="number">10.8</span></span><br><span class="line">➜ <span class="keyword">cat</span> docker-compose.yml</span><br><span class="line"><span class="keyword">version</span>: <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line">service<span class="variable">s:</span></span><br><span class="line">    auth:</span><br><span class="line">        build: <span class="string">&#x27;./auth&#x27;</span></span><br><span class="line">    billin<span class="variable">g:</span></span><br><span class="line">        build: <span class="string">&#x27;./billing&#x27;</span></span><br><span class="line">    contac<span class="variable">t:</span></span><br><span class="line">        build: <span class="string">&#x27;./contact&#x27;</span></span><br><span class="line">    user:</span><br><span class="line">        build: <span class="string">&#x27;./user&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #9</strong>: 使用Volumes</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yaml</span></span><br><span class="line"><span class="attr">services</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">app</span>:<span class="string"></span></span><br><span class="line"><span class="comment">    # Mount the crrent directoy into `/app` inside the running container.</span></span><br><span class="line">    <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">&#x27;.:/app&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #10</strong>: Published Ports</p>
<blockquote>
<p>Creates a firwaall rule which maps a container port to a port on the Docker host to the outside world.</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Flag value</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-p 8080:80</td>
<td align="left">Map TCP port 80 in the container to port 8080 on the Docker host.</td>
</tr>
<tr>
<td align="left">-p 192.168.1.100:8080:80</td>
<td align="left">Map TCP port 80 in the container to port 8080 on the Docker host for connections to host IP 192.168.1.100.</td>
</tr>
<tr>
<td align="left">-p 8080:80/udp</td>
<td align="left">Map UDP port 80 in the container to port 8080 on the Docker host.</td>
</tr>
<tr>
<td align="left">-p 8080:80/tcp -p 8080:80/udp</td>
<td align="left">Map TCP port 80 in the container to TCP port 8080 on the Docker host, and map UDP port 80 in the container to UDP port 8080 on the Docker host.</td>
</tr>
</tbody></table>
<ul>
<li><p><strong>Docker Tip #11</strong>: dockerignore file</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="string">.dockerignore</span>: ignore certain files and folders from your Docker images</span><br><span class="line">  <span class="string">.git</span></span><br><span class="line">  <span class="string">.dockerignore</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #12</strong>: Manage Docker without sudo on Linux</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Add a docker group and then add your user to it:</span></span><br><span class="line"><span class="variable">$ </span>sudo groupadd docker</span><br><span class="line"><span class="variable">$ </span>docker usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #13</strong>: Measure Docker Container’s Resources</p>
<blockquote>
<p>How much resources containers are using</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">$ docker stats</span><br><span class="line">CONTAINER ID   NAME                                                                                         <span class="meta">CPU</span> %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O         PIDS</span><br><span class="line">298d90f942e1   k8s_POD_kafka-zookeeper-0_default_a243d677-<span class="number">101b</span>-493b-a076-d94f46785f22_0                     <span class="number">0.00</span>%     724KiB / <span class="number">3.</span>704GiB     <span class="number">0.02</span>%     <span class="number">0B</span> / <span class="number">0B</span>     <span class="number">0B</span> / <span class="number">0B</span>           <span class="number">1</span></span><br><span class="line">1d92a13e4a6f   k8s_POD_kafka-0_default_f7374645-<span class="number">9904</span>-436c-bc8d-43ed415833c1_0                               <span class="number">0.00</span>%     872KiB / <span class="number">3.</span>704GiB     <span class="number">0.02</span>%     <span class="number">0B</span> / <span class="number">0B</span>     <span class="number">0B</span> / <span class="number">0B</span>           <span class="number">1</span></span><br><span class="line">b638c1bbd855   k8s_POD_postgres-postgresql-0_infrastructure_d9067ee1-<span class="number">6874</span>-<span class="number">4018</span>-a008-09362ad9330d_16         <span class="number">0.00</span>%     868KiB / <span class="number">3.</span>704GiB     <span class="number">0.02</span>%     <span class="number">0B</span> / <span class="number">0B</span>     <span class="number">0B</span> / <span class="number">0B</span>           <span class="number">1</span></span><br><span class="line">0fdc76799b4e   k8s_kube-flannel_kube-flannel-<span class="built_in">ds</span>-nk6tj_kube-system_0a186e7a-c0d7-<span class="number">4282</span>-9f5d-65ee20d0e13a_12   <span class="number">0.07</span>%     <span class="number">15.</span>4MiB / 50MiB       <span class="number">30.80</span>%    <span class="number">0B</span> / <span class="number">0B</span>     <span class="number">33.</span>1MB / <span class="number">0B</span>       <span class="number">11</span></span><br><span class="line">4c3705247efa   k8s_kube-proxy_kube-proxy-xwfvl_kube-system_f46216cb-d018-4d82-b510-9be5e01cefca_12          <span class="number">0.00</span>%     <span class="number">23.</span>36MiB / <span class="number">3.</span>704GiB   <span class="number">0.62</span>%     <span class="number">0B</span> / <span class="number">0B</span>     <span class="number">43.</span>7MB / <span class="number">12.</span>3kB   <span class="number">8</span></span><br><span class="line">16d5db1e7447   k8s_POD_kube-proxy-xwfvl_kube-system_f46216cb-d018-4d82-b510-9be5e01cefca_13                 <span class="number">0.00</span>%     <span class="number">1.</span>996MiB / <span class="number">3.</span>704GiB   <span class="number">0.05</span>%     <span class="number">0B</span> / <span class="number">0B</span>     487kB / <span class="number">0B</span>        <span class="number">1</span></span><br><span class="line">496aacf5fddf   k8s_POD_kube-flannel-<span class="built_in">ds</span>-nk6tj_kube-system_0a186e7a-c0d7-<span class="number">4282</span>-9f5d-65ee20d0e13a_13            <span class="number">0.00</span>%     768KiB / <span class="number">3.</span>704GiB     <span class="number">0.02</span>%     <span class="number">0B</span> / <span class="number">0B</span>     <span class="number">0B</span> / <span class="number">0B</span>           <span class="number">1</span></span><br><span class="line">1e328afeb116   dapr_zipkin                                                                                  <span class="number">0.17</span>%     <span class="number">250.</span>2MiB / <span class="number">3.</span>704GiB   <span class="number">6.60</span>%     18MB / <span class="number">0B</span>   60MB / <span class="number">0B</span>         <span class="number">55</span></span><br><span class="line">27872f88cae3   dapr_placement                                                                               <span class="number">0.11</span>%     <span class="number">5.</span>992MiB / <span class="number">3.</span>704GiB   <span class="number">0.16</span>%     18MB / <span class="number">0B</span>   <span class="number">13.</span>6MB / <span class="number">0B</span>       <span class="number">10</span></span><br><span class="line">27c1f6daa81c   dapr_redis                                                                                   <span class="number">0.35</span>%     <span class="number">5.</span>633MiB / <span class="number">3.</span>704GiB   <span class="number">0.15</span>%     18MB / <span class="number">0B</span>   <span class="number">10.</span>7MB / <span class="number">0B</span>       <span class="number">5</span></span><br><span class="line"></span><br><span class="line">$ docker stats --format <span class="string">&quot;table &#123;&#123;.Container&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;&quot;</span></span><br><span class="line">CONTAINER      <span class="meta">CPU</span> %     MEM USAGE / LIMIT</span><br><span class="line">298d90f942e1   <span class="number">0.00</span>%     724KiB / <span class="number">3.</span>704GiB</span><br><span class="line">1d92a13e4a6f   <span class="number">0.00</span>%     872KiB / <span class="number">3.</span>704GiB</span><br><span class="line">b638c1bbd855   <span class="number">0.00</span>%     868KiB / <span class="number">3.</span>704GiB</span><br><span class="line">0fdc76799b4e   <span class="number">2.37</span>%     <span class="number">15.</span>42MiB / 50MiB</span><br><span class="line">4c3705247efa   <span class="number">0.00</span>%     <span class="number">23.</span>36MiB / <span class="number">3.</span>704GiB</span><br><span class="line">16d5db1e7447   <span class="number">0.00</span>%     <span class="number">1.</span>996MiB / <span class="number">3.</span>704GiB</span><br><span class="line">496aacf5fddf   <span class="number">0.00</span>%     768KiB / <span class="number">3.</span>704GiB</span><br><span class="line">1e328afeb116   <span class="number">0.21</span>%     <span class="number">250.</span>2MiB / <span class="number">3.</span>704GiB</span><br><span class="line">27872f88cae3   <span class="number">0.12</span>%     <span class="number">5.</span>992MiB / <span class="number">3.</span>704GiB</span><br><span class="line">27c1f6daa81c   <span class="number">0.34</span>%     <span class="number">5.</span>633MiB / <span class="number">3.</span>704GiB</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #14</strong>: Docker Compose vs Docker Stack</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Docker Compose: is an official tool that helps you manage your Docker containers by letting you define everything through a docker-compose.yml file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker stack: is a command that&#x27;s embedded into the Docker CLI. Lets you manage a cluster of Docker containers through Docker Swarm.</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #15</strong>: Metadata Docker Images with Labels</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Dockerfile example of adding 2 labels with 1 LABEL instruction:</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> &lt;key&gt;=&lt;value&gt;</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> version=<span class="string">&quot;1.0&quot;</span> maintainer=<span class="string">&quot;chyi &lt;nick.chyi@gmail.com&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker build example to add dynamic labels to your Docker images:</span></span><br><span class="line">$ docker build . --<span class="keyword">label</span><span class="bash"> <span class="string">&quot;version=1.0&quot;</span> --label <span class="string">&quot;maintaner=chyi &lt;nick.chyi@gmail.com&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker inspect images</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #16</strong>: Named Volumes vs Path Based Volumes</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Named volumes</span></span><br><span class="line">  postgres:<span class="regexp">/var/</span>lib<span class="regexp">/postgresql/</span>data</span><br><span class="line"></span><br><span class="line">  docker-compose automatically create the postgres volume, <span class="keyword">if</span> not you could running __$ docker volume create postgres__.</span><br><span class="line">  On Linux, the volume will get saved to <span class="regexp">/var/</span>lib<span class="regexp">/docker/</span>volumes<span class="regexp">/postgres/</span>_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path based volumes</span></span><br><span class="line">  .<span class="regexp">/postgres:/</span>var<span class="regexp">/lib/</span>postgresql/data</span><br><span class="line"></span><br><span class="line">  postgres/ directory would get created <span class="keyword">in</span> the current directory on the Docker host.</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #17</strong>: The Volume or Mount Flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Setting up a volume the old way with docker run:</span></span><br><span class="line">$ docker container run … -v <span class="string">&quot;<span class="subst">$(pwd)</span>&quot;</span>:/myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setting up the same volumes using the mount flag with docker run:</span></span><br><span class="line">$ docker container run … --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=<span class="string">&quot;<span class="subst">$(pwd)</span>&quot;</span>,target=/myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker compose</span></span><br><span class="line">volumes:</span><br><span class="line">  - <span class="built_in">type</span>: <span class="string">&quot;bind&quot;</span></span><br><span class="line">    <span class="built_in">source</span>: <span class="string">&quot;.&quot;</span></span><br><span class="line">    target: <span class="string">&quot;/myapp&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #18</strong>: Connect to a Service Running on Docker Host</p>
<blockquote>
<p>Implementation of connecting to Docker host over a custom network with a static IP address.</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Create a custom bridge Docker network</span></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ at <span class="number">3</span>BPlus</span><br><span class="line">➜ docker network create -d bridge --subnet <span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">24</span> --gateway <span class="number">192.168</span>.<span class="number">0.1</span> mynet</span><br><span class="line"><span class="number">0330</span>b879fcc8fb23eeb092cb66fd86f1796e7f0abe37df4978903cf8fd07217b</span><br><span class="line"></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ at <span class="number">3</span>BPlus</span><br><span class="line">➜ ifconfig</span><br><span class="line">br-<span class="number">0330</span>b879fcc8: flags=<span class="number">4099</span>&lt;UP,BROADCAST,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">192.168</span>.<span class="number">0.1</span>  netmask <span class="number">255.255</span>.<span class="number">255.0</span>  broadcast <span class="number">192.168</span>.<span class="number">0.255</span></span><br><span class="line">        ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">16</span>:<span class="number">0</span>c:c0:<span class="number">51</span>  txqueuelen <span class="number">0</span>  (Ethernet)</span><br><span class="line">        RX packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0.0</span> B)</span><br><span class="line">        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        TX packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0.0</span> B)</span><br><span class="line">        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start the Alpine container and drop into a Shell prompt.</span></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ at <span class="number">3</span>BPlus</span><br><span class="line">➜ docker container run --rm -it alpine sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install the ping utility.</span></span><br><span class="line">/ <span class="comment"># apk update &amp;&amp; apk add iputils</span></span><br><span class="line">fetch https:<span class="regexp">//</span>dl-cdn.alpinelinux.org<span class="regexp">/alpine/</span>v3.<span class="number">14</span><span class="regexp">/main/</span>aarch64/APKINDEX.tar.gz</span><br><span class="line">fetch https:<span class="regexp">//</span>dl-cdn.alpinelinux.org<span class="regexp">/alpine/</span>v3.<span class="number">14</span><span class="regexp">/community/</span>aarch64/APKINDEX.tar.gz</span><br><span class="line">v3.<span class="number">14.2</span>-<span class="number">5</span>-gd4163d4c6c [https:<span class="regexp">//</span>dl-cdn.alpinelinux.org<span class="regexp">/alpine/</span>v3.<span class="number">14</span>/main]</span><br><span class="line">v3.<span class="number">14.2</span>-<span class="number">4</span>-ga15b4dc067 [https:<span class="regexp">//</span>dl-cdn.alpinelinux.org<span class="regexp">/alpine/</span>v3.<span class="number">14</span>/community]</span><br><span class="line">OK: <span class="number">14810</span> distinct packages available</span><br><span class="line">(<span class="number">1</span>/<span class="number">2</span>) Installing libcap (<span class="number">2.50</span>-r0)</span><br><span class="line">(<span class="number">2</span>/<span class="number">2</span>) Installing iputils (<span class="number">20210202</span>-r0)</span><br><span class="line">Executing busybox-<span class="number">1.33</span>.<span class="number">1</span>-r3.trigger</span><br><span class="line">OK: <span class="number">6</span> MiB <span class="keyword">in</span> <span class="number">16</span> packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ping the custom IP address we set up.</span></span><br><span class="line">/ <span class="comment"># ping 192.168.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You should see this output (hit CTRL+C to stop it)</span></span><br><span class="line">PING <span class="number">192.168</span>.<span class="number">0.1</span> (<span class="number">192.168</span>.<span class="number">0.1</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">192.168</span>.<span class="number">0.1</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.336</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">192.168</span>.<span class="number">0.1</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.293</span> ms</span><br><span class="line">^C</span><br><span class="line">--- <span class="number">192.168</span>.<span class="number">0.1</span> ping statistics ---</span><br><span class="line"><span class="number">2</span> packets transmitted, <span class="number">2</span> received, <span class="number">0</span>% packet loss, time <span class="number">1013</span>ms</span><br><span class="line">rtt min<span class="regexp">/avg/m</span>ax<span class="regexp">/mdev = 0.293/</span><span class="number">0.314</span><span class="regexp">/0.336/</span><span class="number">0.021</span> ms</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #19</strong>: Show Total Disk Space Used by Docker</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">ubuntu in ~ at 3BPlus</span><br><span class="line">➜ docker system df</span><br><span class="line">TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE</span><br><span class="line">Images         <span class="number"> 3 </span>       <span class="number"> 2 </span>        203.9MB   198.5MB (97%)</span><br><span class="line">Containers     <span class="number"> 3 </span>       <span class="number"> 1 </span>        2.524MB   0B (0%)</span><br><span class="line">Local Volumes  <span class="number"> 1 </span>       <span class="number"> 0 </span>        0B        0B</span><br><span class="line">Build Cache    <span class="number"> 0 </span>       <span class="number"> 0 </span>        0B        0B</span><br><span class="line"></span><br><span class="line"><span class="comment"># -v flag (verbose) - will show the unique image size for each image</span></span><br><span class="line">ubuntu in ~ at 3BPlus</span><br><span class="line">➜ docker system df -v</span><br><span class="line">Images space usage:</span><br><span class="line"></span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED       SIZE      SHARED SIZE   UNIQUE SIZE   CONTAINERS</span><br><span class="line">alpine                latest    bb3de5531c18  <span class="number"> 4 </span>days ago    5.337MB   0B            5.337MB       2</span><br><span class="line">hello-world           latest    bc11b176a293  <span class="number"> 7 </span>weeks ago   9.136kB   0B            9.136kB       1</span><br><span class="line">bahamat/unix-1st-ed   latest    37aa142d2113  <span class="number"> 5 </span>years ago   198.5MB   0B            198.5MB       0</span><br><span class="line"></span><br><span class="line">Containers space usage:</span><br><span class="line"></span><br><span class="line">CONTAINER ID   IMAGE         COMMAND            LOCAL VOLUMES   SIZE      CREATED       STATUS                   NAMES</span><br><span class="line">9023720cdee7   alpine        &quot;sh&quot;              <span class="number"> 0 </span>              2.52MB   <span class="number"> 5 </span>hours ago   Up<span class="number"> 5 </span>hours               upbeat_kepler</span><br><span class="line">9e272ab58362   alpine        &quot;sh -c &#x27;exit 1&#x27;&quot;  <span class="number"> 0 </span>              0B       <span class="number"> 6 </span>hours ago   Exited (1)<span class="number"> 6 </span>hours ago   naughty_blackburn</span><br><span class="line">d95cc7e19d43   hello-world   &quot;/hello&quot;          <span class="number"> 0 </span>              0B       <span class="number"> 7 </span>weeks ago   Exited (0)<span class="number"> 7 </span>weeks ago   nifty_hellman</span><br><span class="line"></span><br><span class="line">Local Volumes space usage:</span><br><span class="line"></span><br><span class="line">VOLUME NAME   LINKS     SIZE</span><br><span class="line">user_my-db   <span class="number"> 0 </span>        0B</span><br><span class="line"></span><br><span class="line">Build cache usage: 0B</span><br><span class="line"></span><br><span class="line">CACHE ID   CACHE TYPE   SIZE      CREATED   LAST USED   USAGE     SHARED</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #20</strong>: Docker Compose Stop vs Down</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker-compose stop</span></span><br><span class="line">&gt; stop container, <span class="keyword">but</span> <span class="keyword">it</span> won&#x27;t remove them</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose down</span></span><br><span class="line">&gt; stop container, removes <span class="keyword">the</span> stopped containers <span class="keyword">as</span> well <span class="keyword">as</span> any networks <span class="keyword">that</span> were created.</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose down -v</span></span><br><span class="line">&gt; add remove all volumes too.</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Docker Tip #21</strong>: Difference between Docker Create, Start and Run</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Create:</span></span><br><span class="line">  adds a writeable container <span class="keyword">on</span> top <span class="keyword">of</span> your image <span class="keyword">and</span> sets <span class="keyword">it</span> up <span class="keyword">for</span> <span class="built_in">running</span> whatever command you specified <span class="keyword">in</span> you CMD. The container ID <span class="keyword">is</span> reported <span class="keyword">back</span> <span class="keyword">but</span> <span class="keyword">it</span>&#x27;s <span class="keyword">not</span> started.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start:</span></span><br><span class="line">  will start any stopped container.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run:</span></span><br><span class="line">  combination <span class="keyword">of</span> create <span class="keyword">and</span> start, It creates <span class="keyword">the</span> container <span class="keyword">and</span> starts <span class="keyword">it</span>.</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Have-a-Fun"><a href="#Have-a-Fun" class="headerlink" title="Have a Fun"></a>Have a Fun</h2><ul>
<li>Run the First Edition of Unix (1972) with Docker<blockquote>
<p>Run a PDP-11 simulator through Docker to interact with Unix as it was back in 1972</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">$ docker <span class="keyword">run</span> --<span class="keyword">rm</span> -it bahamat/unix-1st-<span class="keyword">ed</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>Dockerfile</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-next-gitalk</title>
    <url>/2021/09/01/hexo-next-gitalk/</url>
    <content><![CDATA[<h3 id="站点搭建过程"><a href="#站点搭建过程" class="headerlink" title="站点搭建过程"></a>站点搭建过程</h3><ul>
<li><a href="https://hexo.io/zh-cn/">hexo</a> : 快速、简洁且高校的博客框架</li>
<li><a href="https://github.com/next-theme/hexo-theme-next/blob/master/docs/zh-CN/README.md">next</a> : Hexo主题</li>
<li><a href="https://github.com/gitalk/gitalk">gitalk</a> : 依靠GitHub issue的评论系统</li>
</ul>
<span id="more"></span>

<h3 id="Settings-amp-Tips"><a href="#Settings-amp-Tips" class="headerlink" title="Settings &amp; Tips"></a>Settings &amp; Tips</h3><ul>
<li><p><strong>Show descripion</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># 修改themes/next/_config.yml</span><br><span class="line">excerpt_description: true</span><br><span class="line"></span><br><span class="line"># 文章截断</span><br><span class="line"><span class="comment">&lt;!--more--&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>字数统计</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装插件 hexo-symbols-count-time</span></span><br><span class="line"><span class="string">$</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-symbols-count-time</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改hexo配置文件_config.yml</span></span><br><span class="line">  <span class="comment"># Symbols count and time to read of articles for Hexo.</span></span><br><span class="line">  <span class="attr">symbols_count_time:</span></span><br><span class="line">      <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">total_symbols:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">total_time:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改Next配置文件</span></span><br><span class="line">  <span class="comment"># Post wordcount display settings</span></span><br><span class="line">  <span class="comment"># Dependencies: https://github.com/next-theme/hexo-word-counter</span></span><br><span class="line">  <span class="attr">symbols_count_time:</span></span><br><span class="line">    <span class="attr">separated_meta:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">item_text_post:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">item_text_total:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">awl:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">wpm:</span> <span class="number">275</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>blog</tag>
      </tags>
  </entry>
  <entry>
    <title>micro-services</title>
    <url>/2021/09/01/micro-services/</url>
    <content><![CDATA[<blockquote>
<p>项目工程化、微服务相关介绍</p>
</blockquote>
<span id="more"></span>

<h2 id="项目工程化"><a href="#项目工程化" class="headerlink" title="项目工程化"></a>项目工程化</h2><ul>
<li><p>开源规范</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 开源协议</span></span><br><span class="line"><span class="bullet">  1.</span> GPL - General Public License</span><br><span class="line"><span class="code">    &gt; 衍生代码的分发需要开源并且也要遵守此协议</span></span><br><span class="line"><span class="code">  2. MPL</span></span><br><span class="line"><span class="code">    &gt; 允许免费重发布、免费修改，但要求修改的代码版权归软件发起者，这种授权维护了商业软件的利益，要求基于这种软件的修改无偿贡献版权给该软件</span></span><br><span class="line"><span class="code">  3. LGPL</span></span><br><span class="line"><span class="code">  4. Apache</span></span><br><span class="line"><span class="code">    &gt; Apache 2.0协议除了为用户提供版权许可之外，还有专利许可，适合设计专利内容的项目</span></span><br><span class="line"><span class="code">  5. BSD</span></span><br><span class="line"><span class="code">    &gt;</span></span><br><span class="line"><span class="code">  6. MIT</span></span><br><span class="line"><span class="code">    &gt; MIT 协议是所有开源许可中最宽松的一个，除了细笔包含许可声明之外，再无任何限制</span></span><br></pre></td></tr></table></figure></li>
<li><p>开源规范</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 项目结构:</span><br><span class="line"><span class="bullet">2.</span> 严格遵循代码规范:</span><br><span class="line"><span class="bullet">3.</span> 代码质量:</span><br><span class="line"><span class="bullet">4.</span> 单元测试覆盖率:</span><br><span class="line"><span class="bullet">5.</span> 版本发布规范:</span><br><span class="line"><span class="bullet">6.</span> 向下兼容:</span><br><span class="line"><span class="bullet">7.</span> 详细的文档说明:</span><br><span class="line"><span class="bullet">8.</span> 安全:</span><br></pre></td></tr></table></figure></li>
<li><p>文档规范</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> README文档</span><br><span class="line">  介绍项目功能、安装、部署、使用</span><br><span class="line"><span class="bullet">2.</span> 项目文档</span><br><span class="line">  开发文档: 说明项目的开发流程</span><br><span class="line">  用户文档:</span><br><span class="line"><span class="bullet">3.</span> API接口文档</span><br></pre></td></tr></table></figure></li>
<li><p>版本规范</p>
<figure class="highlight tp"><table><tr><td class="code"><pre><span class="line">语义化版本规范: SemVer: 主版本号.次版本号.修订号 (<span class="keyword">X</span>.<span class="keyword">Y</span>.<span class="keyword">Z</span>), XYZ为非负的整数，禁止在数字前方补零</span><br><span class="line">  主版本号: MAJOR: 当做了不兼容API修改</span><br><span class="line">  次版本号: MINOR: 当做了向下兼容的功能新增及修改 -- 偶数为稳定版本，奇数为开发版本</span><br><span class="line">  修订号:PATCH: 向下兼容问题修正</span><br><span class="line"></span><br><span class="line"><span class="keyword">X</span>.<span class="keyword">Y</span>.<span class="keyword">Z</span>[-先行版本号][+版本编译元数据]</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 实际开发的时候，使用<span class="number">0</span><span class="number">.1</span><span class="number">.0</span>作为第一开发版本号</span><br><span class="line">fix类型的commit 可以将修订号+<span class="number">1</span></span><br><span class="line">feat类型的commit可以将次版本号+<span class="number">1</span></span><br><span class="line">breaking change的commit将主版本号+<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p>Commit 规范</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">Commit Message包含三部分:</span><br><span class="line"><span class="symbol">  Header:</span> <span class="params">&lt;type&gt;</span>[optional scope]: <span class="params">&lt;description&gt;</span></span><br><span class="line"><span class="symbol">    type:</span></span><br><span class="line"><span class="symbol">      feat:</span> 新增功能</span><br><span class="line"><span class="symbol">      fix:</span> Bug修复</span><br><span class="line"><span class="symbol">      perf:</span> 提高代码性能的变更</span><br><span class="line"><span class="symbol">      style:</span> 代码格式类的变更</span><br><span class="line"><span class="symbol">      refactor:</span> 其他代码类的变更，这些变更不属于feat,fix,perf和style. 简化代码，重命名变量、删除冗余代码</span><br><span class="line"><span class="symbol">      test:</span> 新增测试用例或是更新现有测试用例</span><br><span class="line"><span class="symbol">      ci:</span> 持续集成和部署想干改动，</span><br><span class="line"><span class="symbol">      docs:</span> 文档类更新</span><br><span class="line"><span class="symbol">      chore:</span> 其他类型，构建流程、依赖管理或者辅助工具的变动</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">    scope:</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">    description:</span> 动词开头，使用现在时</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  Body:</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">  Footer:</span></span><br><span class="line"></span><br><span class="line">git rebase: 重写历史</span><br><span class="line">  git rebase -i <span class="params">&lt;commit ID&gt;</span> 这里是需要合并commit中最旧commit的父commit ID</span><br><span class="line"></span><br><span class="line">git reset HEAD~<span class="number">3</span>A 撤销过去的commit,重新提交</span><br><span class="line"></span><br><span class="line">git commit --amend: 修改最近一次commit 的 message</span><br><span class="line"></span><br><span class="line">Commit Message是commit数据结构中的一个属性，如果Commit Message有变更，则commit ID一定会变，git commit --amend只会变更最后一次的commit ID, git rebase -i 会变更父commit ID之后的所有提交commit ID.</span><br><span class="line"></span><br><span class="line">如果当前分之有未commit的代码，需要先执行git stash将工作状态进行暂存，当修改完成后在执行git stash pop恢复之前的工作状态</span><br></pre></td></tr></table></figure></li>
<li><p>目录结构设计</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 结构化目录结构</span></span><br><span class="line">  /cmd            <span class="comment">-- 组件</span></span><br><span class="line">  /internal       <span class="comment">-- 私有应用和库代码,不希望在其他应用和库中被导入</span></span><br><span class="line">  /pkg            <span class="comment">-- 存放可以被外部应用使用的代码库</span></span><br><span class="line"><span class="comment"># 平铺式目录结构</span></span><br><span class="line">  &gt; 这种方式在很多框架/库中存在,好处式引用路径长度短</span><br></pre></td></tr></table></figure></li>
<li><p>工作流设计</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 集中式工作流</span></span><br><span class="line">  &gt; 适用于团队人数少、开发不频繁、不需要同时维护多个版本的小项目</span><br><span class="line"></span><br><span class="line"><span class="comment"># 功能分支工作流</span></span><br><span class="line">  &gt; 不同功能在不同的分支进行开发，最后合并到<span class="literal">master</span>分支</span><br><span class="line">  Merge pull request:</span><br><span class="line">    <span class="number">1</span>. Create a merge commit: git merge --no-ff. feature分支上所有的commit都会加到<span class="literal">master</span>分支上，并且会生成一个merge commit。</span><br><span class="line">    <span class="number">2</span>. Squash <span class="keyword">and</span> merge: git merge --squash. feature分支上所有的commit都合并成一个commit.然后加到<span class="literal">master</span>分支,原来的commit历史会丢失</span><br><span class="line">    <span class="number">3</span>. Rebase <span class="keyword">and</span> merge: git rebase. 将pull request上所有提交历史按照原有顺序依次添加到<span class="literal">master</span>分支的头部HEAD.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Git Flow工作流</span></span><br><span class="line">  &gt; 比较适合大型的项目或者迭代速度快的项目</span><br><span class="line">  <span class="literal">master</span>: 该分支最新代码是发布状态，不能直接在该分支上开发，<span class="literal">master</span>分支每合并一个hotfix/release分支，都会打一个版本标签</span><br><span class="line">  develop: 该分支是开发中的最新代码，该分支只做合并操作，不能直接在该分支上开发</span><br><span class="line">  feature: 功能开发,基于develop分支新建一个feature分支，feature分支合并之前先pull一下develop分支，</span><br><span class="line">  release: 在发布阶段作为版本发布的预发布分支，基于develop分支创建, 测试通过后，将release分支合并到<span class="literal">master</span>和develop，并在<span class="literal">master</span>分支上版本标签，最后删除release版本分支</span><br><span class="line">  hotfix: 在维护阶段做紧急Bug修复分支，hotfix分支合并到<span class="literal">master</span>和develop分支，并在<span class="literal">master</span>分支打上修复后的版本标签,最后删除hotfix分支</span><br><span class="line"></span><br><span class="line"><span class="comment"># Forking 工作流</span></span><br><span class="line">  项目远程仓库和开发者远程仓库完全独立，开发者通过Pull Request的方式给远程仓库贡献代码，项目维护者选择性地接收任何开发者的提交，通过这种方式，可以避免开发者项目远程仓库的权限,从而提高项目远程仓库的安全性</span><br></pre></td></tr></table></figure></li>
<li><p>研发流程</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 需求阶段</span></span><br><span class="line"><span class="bullet">  1.</span> 市场调研 - PDM(Product Manager) 产品经理</span><br><span class="line"><span class="bullet">  2.</span> 需求分析 - PM(Project Manager) 项目经理</span><br><span class="line"><span class="bullet">  3.</span> 需求文档 - 最终产物</span><br><span class="line"><span class="bullet">  4.</span> 需求评审</span><br><span class="line"></span><br><span class="line"><span class="section"># 设计阶段</span></span><br><span class="line"><span class="bullet">  1.</span> 交互设计 - UX(User Experience) 交互设计师</span><br><span class="line"><span class="bullet">  2.</span> 视觉设计 - UI(User Interface) 视觉设计师</span><br><span class="line"><span class="bullet">  3.</span> 技术设计</span><br><span class="line"><span class="bullet">  4.</span> 技术评审 - 最终产物</span><br><span class="line"><span class="bullet">  5.</span> 需求排期</span><br><span class="line"></span><br><span class="line"><span class="section"># 开发阶段</span></span><br><span class="line"><span class="bullet">  -</span> 开发 - Makefile - RD(Research and Development engineer) 研发工程师</span><br><span class="line"><span class="bullet">    1.</span> Git Flow工作流</span><br><span class="line"><span class="bullet">    2.</span> 生成代码 -- 尽可能自动生成代码</span><br><span class="line"><span class="bullet">    3.</span> 版权检查</span><br><span class="line"><span class="bullet">    4.</span> 静态代码检查</span><br><span class="line"><span class="bullet">    5.</span> 单元测试</span><br><span class="line"><span class="bullet">    6.</span> 编译</span><br><span class="line"><span class="bullet">    7.</span> 自测</span><br><span class="line"><span class="bullet">    8.</span> Code Review</span><br><span class="line"><span class="bullet">    9.</span> Merge</span><br><span class="line"><span class="bullet">  -</span> 构建 - CI/CD</span><br><span class="line"><span class="bullet">    1.</span> 代码扫描</span><br><span class="line"><span class="bullet">    2.</span> 单元测试</span><br><span class="line"><span class="bullet">    3.</span> 编译打包</span><br><span class="line"><span class="bullet">    4.</span> 归档[镜像仓库]</span><br><span class="line"></span><br><span class="line"><span class="section"># 测试阶段</span></span><br><span class="line">  &gt; 测试阶段为了不阻塞测试，确保项目按时发布，研发人员应该优先解决测试同学的Bug,至少是阻塞类的Bug</span><br><span class="line"><span class="bullet">  1.</span> 功能测试 - QA(Quality Assurance) 质量管理工程师</span><br><span class="line"><span class="bullet">  2.</span> 性能测试 - QE(Quality Engineering) 质量工程师</span><br><span class="line"><span class="bullet">  3.</span> 集成测试</span><br><span class="line"><span class="bullet">  4.</span> 系统测试</span><br><span class="line"></span><br><span class="line"><span class="section"># 发布阶段</span></span><br><span class="line"><span class="bullet">  -</span> 代码发布</span><br><span class="line"><span class="bullet">    1.</span> 合并到主干 - Master分支</span><br><span class="line"><span class="bullet">    2.</span> 生成版本号</span><br><span class="line"><span class="bullet">    3.</span> 打标签</span><br><span class="line"><span class="bullet">    4.</span> 代码扫描</span><br><span class="line"><span class="bullet">    5.</span> 单元测试</span><br><span class="line"><span class="bullet">    6.</span> 编译</span><br><span class="line"><span class="bullet">    7.</span> 发布构建产物</span><br><span class="line"><span class="bullet">  -</span> 发布审批</span><br><span class="line"><span class="bullet">    1.</span> 资源申请</span><br><span class="line"><span class="bullet">    2.</span> 创建发布计划</span><br><span class="line"><span class="bullet">    3.</span> 创建发布单</span><br><span class="line"><span class="bullet">    4.</span> 发布单审批</span><br><span class="line"><span class="bullet">  -</span> 服务发布</span><br><span class="line"><span class="bullet">    1.</span> 预发部署</span><br><span class="line"><span class="bullet">    2.</span> 预发验证</span><br><span class="line"><span class="bullet">    3.</span> 现网部署</span><br><span class="line"><span class="bullet">    4.</span> 现网验证</span><br><span class="line"></span><br><span class="line"><span class="section"># 运营阶段</span></span><br><span class="line"><span class="bullet">  -</span> 产品运营</span><br><span class="line"><span class="bullet">    1.</span> 技术沙龙</span><br><span class="line"><span class="bullet">    2.</span> 技术推文</span><br><span class="line"><span class="bullet">  -</span> 运维运营 - OP(Operation) 运维工程师</span><br><span class="line"><span class="bullet">    1.</span> 运维工具</span><br><span class="line"><span class="bullet">    2.</span> 日志系统</span><br><span class="line"><span class="bullet">    3.</span> 监控告警</span><br></pre></td></tr></table></figure></li>
<li><p>应用生命周期管理</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 研发模式</span></span><br><span class="line"><span class="bullet">  -</span> 瀑布模式</span><br><span class="line"><span class="bullet">    -</span> 优点:</span><br><span class="line"><span class="bullet">      1.</span> 严格按照研发阶段推进研发进度，流程清晰，适合按项目交付的应用</span><br><span class="line"><span class="bullet">    -</span> 缺点:</span><br><span class="line"><span class="bullet">      1.</span> 变更困难</span><br><span class="line"><span class="bullet">      2.</span> 研发周期长</span><br><span class="line"><span class="bullet">  -</span> 迭代模式</span><br><span class="line"><span class="code">    &gt; 不要求每个阶段的任务做到最完美，而是先把主要功能搭建起来，然后通过客户的反馈信息不断完善</span></span><br><span class="line"><span class="code">  - 敏捷模式</span></span><br><span class="line"><span class="code">    &gt; 敏捷模式把一个大的需求分成多个、可分阶段完成的小迭代，每个迭代交付的都是一个可使用的软件，开发过程中，软件要一致处于可使用状态</span></span><br><span class="line"><span class="code">    - Scrum开发模式</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># CI/CD</span></span><br><span class="line">  CI: Continuous Integration, 持续集成</span><br><span class="line">  CD: Continous Delivery, 持续交付</span><br><span class="line">  CD: Continous Deployment, 持续部署</span><br><span class="line"></span><br><span class="line"><span class="section"># DevOps: 研发运维一体化</span></span><br><span class="line"><span class="bullet">  -</span> AIOps: 职能运维</span><br><span class="line"><span class="bullet">  -</span> ChatOps: 通过聊天窗口的机器人Bot出发任务</span><br><span class="line"><span class="bullet">  -</span> GitOps:</span><br><span class="line"><span class="code">    &gt; 开发人员开发完代码后推送Git仓库，触发CI流程，CI流程通过编译构建出Docker镜像，并将镜像push到Docker镜像仓库，Push动作触发Push事件，通过webhook形式通知Config Updater服务，Config Updater服务从镜像仓库中下载镜像，并更新Git仓库中的kubernetes YAML文件</span></span><br><span class="line"><span class="code">  - NoOps:</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="介绍Web框架"><a href="#介绍Web框架" class="headerlink" title="介绍Web框架"></a>介绍Web框架</h2><ul>
<li>Gin<blockquote>
<p>Go编写的web框架，是一个类似martini性能更好的API框架</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> Engine: 初始化gin对象实例，</span><br><span class="line">  日志</span><br><span class="line">  中间件</span><br><span class="line">  路由控制</span><br><span class="line">  handlercontext</span><br><span class="line"><span class="bullet">2.</span> Router: 定义各种路由规则和条件</span><br><span class="line"><span class="bullet">3.</span> Context: 允许在中间件中共享变量，管理整个流程，验证请求的json以及提供</span><br><span class="line"><span class="bullet">4.</span> Bind:</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="介绍微服务架构设计"><a href="#介绍微服务架构设计" class="headerlink" title="介绍微服务架构设计"></a>介绍微服务架构设计</h2><ul>
<li><p>服务化基础设施技术选型</p>
<ul>
<li>服务间通信中间件<ul>
<li>同步方式: RPC</li>
<li>异步方式: MQ</li>
</ul>
</li>
</ul>
</li>
<li><p>客户端一致性</p>
<blockquote>
<p>共享相同connection可以在同一个事务里</p>
</blockquote>
<figure class="highlight sas"><table><tr><td class="code"><pre><span class="line">1. begin tx 开启本地事务</span><br><span class="line">2. <span class="meta">do</span> work 执行业务操作</span><br><span class="line">3. <span class="meta">insert</span> <span class="meta">message</span> 向同实例消息库插入消息</span><br><span class="line">4. <span class="meta">end</span> tx 事务提交</span><br><span class="line">5. send <span class="meta">message</span> 网络向server发送消息</span><br><span class="line">6. response server 回应消息</span><br><span class="line">7. <span class="meta">delete</span> <span class="meta">message</span> 如果server回复成功则删除消息</span><br><span class="line">8. scan <span class="meta">message</span> 补偿任务扫描未发送消息</span><br><span class="line">9. send <span class="meta">message</span> 补偿任务补偿消息</span><br><span class="line">10. <span class="meta">delete</span> <span class="meta">message</span> 补偿任务删除补偿成功的消息</span><br></pre></td></tr></table></figure></li>
<li><p>服务端存储模型</p>
<figure class="highlight node-repl"><table><tr><td class="code"><pre><span class="line"># Kafka RocketMQ基于partition存储模型</span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">每个subject分为一个或多个partition，而Server收到消息后将其分发到某个partition上，而concumer消费的时候与partition对应。合理的分配策略是partition个数与consumer个数成倍数关系.</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">静态绑定关系导致consumer扩容缩容比较麻烦</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">顺序append文件，提供很好的性能</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">顺序消费文件，使用offset表示消费进度，不给给个消息记录消费状态,成本极低</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">将所有subject的消息合并在一起</span></span><br><span class="line"></span><br><span class="line"># 业务使用消息 vs. 数据流处理区别</span><br><span class="line">  &gt; 数据流中消息主题少，每个消息主题的吞吐量极大</span><br><span class="line">  &gt; 业务中消息主题极多，很多主题量级很小</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h2><ul>
<li>计算中所有文件都可以通过添加一个中间层来解决，一个中间层解决不了就添加两个</li>
</ul>
]]></content>
      <categories>
        <category>计算机科学</category>
      </categories>
      <tags>
        <tag>微服务</tag>
        <tag>DDD</tag>
        <tag>分布式</tag>
        <tag>工程化</tag>
      </tags>
  </entry>
  <entry>
    <title>Distributed ID Generator</title>
    <url>/2021/09/02/Distributed-ID-Generator/</url>
    <content><![CDATA[<blockquote>
<p>分布式ID生成器</p>
</blockquote>
<span id="more"></span>

<h1 id="Distributed-ID-Generator"><a href="#Distributed-ID-Generator" class="headerlink" title="Distributed ID Generator"></a>Distributed ID Generator</h1><ul>
<li>UUID<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">  <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/google/uuid&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func BenchmarkUUID(t *testing.B) &#123;</span><br><span class="line">  for i := 0; i &lt; t.N; i++ &#123;</span><br><span class="line">    _ = uuid.New()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~/Downloads/uuid_demo via 🐹 v1.17 took 13s</span><br><span class="line">➜ go test -bench=.</span><br><span class="line"><span class="section">goos: darwin</span></span><br><span class="line"><span class="section">goarch: amd64</span></span><br><span class="line"><span class="section">pkg: uuid_demo</span></span><br><span class="line"><span class="section">cpu: Intel(R) Core(TM) i5-5257U CPU @ 2.70GHz</span></span><br><span class="line">BenchmarkUUID-4   	 1390710	       844.7 ns/op</span><br><span class="line">PASS</span><br><span class="line">ok  	uuid_demo	2.351s</span><br><span class="line"></span><br><span class="line"><span class="comment"># UUIDs are 128-bit hexadecimal numbers that are globally unique</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 优点:</span></span><br><span class="line">  1. 生成足够简单，本地生成无网络消耗，具有唯一性</span><br><span class="line"><span class="comment"># 缺点:</span></span><br><span class="line">  1. 无序的字符串，不具备趋势自增特性</span><br><span class="line">  2. 没有具体的业务含义</span><br><span class="line">  3. 长度过长16字节128位,36位长度的字符串,存储以及查询数据库性能消耗较大,数据库建议主键尽量越短越好，作为数据库主键UUID的无序性会导致数据位置频繁变动，严重影响性能</span><br></pre></td></tr></table></figure></li>
<li>基于数据库自增ID<blockquote>
<p>基于数据库的auto_increment自增ID完成可以充当分布式ID</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># 创建数据表</span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SEQUENCE_ID (id <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> auto_increment, <span class="keyword">value</span> <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>, <span class="keyword">PRIMARY KEY</span> (id)) ENGINE=MyISAM;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> <span class="built_in">warning</span> (<span class="number">0.08</span> sec)</span><br><span class="line"></span><br><span class="line"># MySQL使用存储过程插入数据</span><br><span class="line"><span class="keyword">delimiter</span> $$<span class="pgsql"></span></span><br><span class="line"><span class="pgsql"><span class="keyword">create</span> <span class="keyword">procedure</span> bench_insert(count <span class="type">int</span> unsigned)</span></span><br><span class="line"><span class="pgsql"><span class="keyword">BEGIN</span></span></span><br><span class="line"><span class="pgsql">  <span class="keyword">declare</span> num <span class="type">int</span> unsigned <span class="keyword">default</span> <span class="number">1</span>;</span></span><br><span class="line"><span class="pgsql">  <span class="keyword">declare</span> c <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">default</span> repeat(<span class="string">&#x27;c&#x27;</span>,<span class="number">10</span>);</span></span><br><span class="line"><span class="pgsql">  <span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span></span><br><span class="line"><span class="pgsql">  <span class="keyword">while</span> num &lt;= count <span class="keyword">DO</span></span></span><br><span class="line"><span class="pgsql">    <span class="keyword">insert</span> <span class="keyword">into</span> SEQUENCE_ID(`<span class="keyword">value</span>`) <span class="keyword">values</span>(c);</span></span><br><span class="line"><span class="pgsql">    <span class="keyword">set</span> num=num+<span class="number">1</span>;</span></span><br><span class="line"><span class="pgsql">  <span class="keyword">end</span> <span class="keyword">while</span>;</span></span><br><span class="line"><span class="pgsql"><span class="keyword">COMMIT</span>;</span></span><br><span class="line"><span class="pgsql"><span class="keyword">END</span>$$</span> <span class="keyword">delimiter</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> bench_insert(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">PROCEDURE</span> bench_insert;</span><br><span class="line"></span><br><span class="line"># 当需要ID的时候，向表中插入记录返回主键ID.</span><br><span class="line"></span><br><span class="line"># 优点:</span><br><span class="line">  <span class="number">1.</span> 实现简单、ID单调自增、数值类型查询速度快</span><br><span class="line"></span><br><span class="line">缺点:</span><br><span class="line">  <span class="number">1.</span> DB单点存在宕机风险，无法扛住高并发场景</span><br></pre></td></tr></table></figure></li>
<li>基于数据库集群模式<blockquote>
<p>多数据库实例单独生产自增ID</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 设置启始值和自增布长</span><br><span class="line">  DB1:</span><br><span class="line">    <span class="keyword">set</span> @<span class="variable">@auto</span>_increment_offset <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- 起始值</span></span><br><span class="line">    <span class="keyword">set</span> @<span class="variable">@auto</span>_increment_increment <span class="operator">=</span> <span class="number">2</span>; <span class="comment">-- 步长</span></span><br><span class="line">  DB2:</span><br><span class="line">    <span class="keyword">set</span> @<span class="variable">@auto</span>_increment_offset <span class="operator">=</span> <span class="number">2</span>; <span class="comment">-- 起始值</span></span><br><span class="line">    <span class="keyword">set</span> @<span class="variable">@auto</span>_increment_increment <span class="operator">=</span> <span class="number">2</span>; <span class="comment">-- 步长</span></span><br><span class="line"></span><br><span class="line"># 优点:</span><br><span class="line">  解决DB单点问题</span><br><span class="line"></span><br><span class="line"># 缺点:</span><br><span class="line">  不利于后续扩容，而且实际上单个数据库自身压力还是很大，依旧无法满足高并发场景</span><br></pre></td></tr></table></figure></li>
<li>基于数据库的号段模式<blockquote>
<p>号段模式是分布式ID生成器主流实现方式之一，批量获取自增ID，每次从数据库取出一个号段范围，具体业务服务将本号段生成的自增ID加载内存</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">  mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> id_generator (id <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, max_id <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;当前最大id&#x27;</span>, step <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;号段的布长&#x27;</span>, biz_type <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;业务类型&#x27;</span>, <span class="keyword">version</span> <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;版本号&#x27;</span>, <span class="keyword">PRIMARY KEY</span>(`id`));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">5</span> warnings (<span class="number">0.11</span> sec)</span><br><span class="line"></span><br><span class="line">  mysql&gt; describe id_generator;</span><br><span class="line">  +<span class="comment">----------+--------+------+-----+---------+-------+</span></span><br><span class="line">  | Field    | <span class="keyword">Type</span>   | <span class="keyword">Null</span> | Key | <span class="keyword">Default</span> | Extra |</span><br><span class="line">  +<span class="comment">----------+--------+------+-----+---------+-------+</span></span><br><span class="line">  | id       | <span class="type">int</span>    | <span class="keyword">NO</span>   | PRI | <span class="keyword">NULL</span>    |       |</span><br><span class="line">  | max_id   | <span class="type">bigint</span> | <span class="keyword">NO</span>   |     | <span class="keyword">NULL</span>    |       |  <span class="comment">-- 当前最大的可用id</span></span><br><span class="line">  | step     | <span class="type">int</span>    | <span class="keyword">NO</span>   |     | <span class="keyword">NULL</span>    |       |  <span class="comment">-- 代表号段的长度</span></span><br><span class="line">  | biz_type | <span class="type">int</span>    | <span class="keyword">NO</span>   |     | <span class="keyword">NULL</span>    |       |  <span class="comment">-- 不同业务类型</span></span><br><span class="line">  | <span class="keyword">version</span>  | <span class="type">int</span>    | <span class="keyword">NO</span>   |     | <span class="keyword">NULL</span>    |       |  <span class="comment">-- 乐观锁，每次都更新version，保证并发时数据的正确性</span></span><br><span class="line">  +<span class="comment">----------+--------+------+-----+---------+-------+</span></span><br><span class="line">  <span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">update</span> id_generator <span class="keyword">set</span> max_id = #&#123;max_id+step&#125;, version = <span class="keyword">version</span> + <span class="number">1</span> <span class="keyword">where</span> version = # &#123;<span class="keyword">version</span>&#125; <span class="keyword">and</span> biz_type = XXX</span><br></pre></td></tr></table></figure></li>
<li>基于Redis模式<blockquote>
<p>利用redis Incr 原子性自增</p>
</blockquote>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="number">172.30.1.23</span>:<span class="number">6002</span>&gt; set seq_id <span class="number">1</span></span><br><span class="line">  OK</span><br><span class="line">  <span class="number">172.30.1.23</span>:<span class="number">6002</span>&gt; incr seq_id</span><br><span class="line">  (integer) <span class="number">2</span></span><br><span class="line">  <span class="number">172.30.1.23</span>:<span class="number">6002</span>&gt; get seq_id</span><br><span class="line">  &quot;<span class="number">2</span>&quot;</span><br><span class="line">  <span class="number">172.30.1.23</span>:<span class="number">6002</span>&gt;</span><br><span class="line"></span><br><span class="line"># Benchmark</span><br><span class="line">ubuntu in ~ at <span class="number">3</span>BPlus took <span class="number">4</span>s</span><br><span class="line">➜ redis-benchmark -n <span class="number">1000000</span> -t set,get,incr -P <span class="number">16</span> -q -h <span class="number">127.0.0.1</span> -p <span class="number">6001</span> --cluster</span><br><span class="line">Cluster has <span class="number">3</span> master nodes:</span><br><span class="line"></span><br><span class="line">Master <span class="number">0</span>: a733c21d3b735b9d026eb4d462ef6b367d8ebb<span class="number">98 172.30.1</span>.<span class="number">23</span>:<span class="number">6002</span></span><br><span class="line">Master <span class="number">1</span>: <span class="number">9</span>c35a4e211f6534861ed768dba592e<span class="number">85539b1377</span> <span class="number">172.30.1.23</span>:<span class="number">6003</span></span><br><span class="line">Master <span class="number">2</span>: a901e497cb72819cf0765e9e4eb16c36399c437b <span class="number">172.30.1.23</span>:<span class="number">6001</span></span><br><span class="line"></span><br><span class="line">SET: <span class="number">47001.32</span> requests per second, p<span class="number">50=15.199</span> msec</span><br><span class="line">GET: <span class="number">101936.80</span> requests per second, p<span class="number">50=5.679</span> msec</span><br><span class="line">INCR: <span class="number">46496.49</span> requests per second, p<span class="number">50=13.879</span> msec   -- 并发<span class="number">5</span>万/s</span><br></pre></td></tr></table></figure></li>
<li>twitter snowflake<blockquote>
<p>雪花算法 (Snowflake) Twitter内部分布式采用的ID生成算法</p>
</blockquote>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="section"># The default Twitter format shown below.</span></span><br><span class="line"><span class="section">+--------------------------------------------------------------------------+</span></span><br><span class="line"><span class="section">| 1 Bit Unused | 41 Bit Timestamp |  10 Bit NodeID  |   12 Bit Sequence ID |</span></span><br><span class="line"><span class="section">+--------------------------------------------------------------------------+</span></span><br><span class="line"></span><br><span class="line">41 bits: store a timestamp with millisecond precision</span><br><span class="line">10 bits: store a node id - a range from 0 through 1023</span><br><span class="line">12 bits: store a sequence number - a range from 0 through 4095</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>分布式</tag>
        <tag>ID Generator</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka Tips &amp; Tracks</title>
    <url>/2021/09/02/Kafka-Tips-Tracks/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>MySQL Tips &amp; Tracks</title>
    <url>/2021/09/02/MySQL-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="数据库-三大范式"><a href="#数据库-三大范式" class="headerlink" title="数据库-三大范式"></a>数据库-三大范式</h1><ul>
<li>原子性: 字段不可分</li>
<li>唯一性: 有主键(没有主键就没有唯一性)，非主键字段依赖主键</li>
<li>消除冗余: 每列都与主键有直接关系, 非主键字段不能相互依赖</li>
</ul>
<span id="more"></span>


<h2 id="MySQL事务模型-ACID"><a href="#MySQL事务模型-ACID" class="headerlink" title="MySQL事务模型 ACID"></a>MySQL事务模型 ACID</h2><blockquote>
<p>MySQL事务的四个特性中ACD三个特性是通过Redo Log(重做日志)和Undo Log(撤销日志)实现,而I隔离型通过Lock实现</p>
</blockquote>
<ul>
<li><p>事务是可以提交或回滚的原子工作单元</p>
</li>
<li><p>ACID模型是一组数据库设计原则</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">A:</span> atomicity原子性: 事务中一系列的操作，要么全部都执行，要么全部都不执行</span><br><span class="line"><span class="symbol">C:</span> consistency一致性(通过AID保证): 数据库事务不能破坏关系数据的完整性以及业务逻辑上的一致性</span><br><span class="line"><span class="symbol">I:</span> isolation 隔离性(事务的隔离级别): 并发环境下，不同事务同时操作相同的数据，每个事务都有各自的完成数据空间</span><br><span class="line"><span class="symbol">D:</span> durability持久性: 只要事务成功结束，对数据库所做的更新就永久保存下来，即使发生系统崩溃，重新启动数据库，数据库还能恢复到事务成功结束时的状态</span><br></pre></td></tr></table></figure></li>
<li><p>InnoDB 存储引擎架构<br><img src="/misc/images/InnoDB-architecture.jpeg" alt="InnoDB Architecture"></p>
</li>
<li><p>并发问题</p>
<ul>
<li>脏读: Drity Read: 读取到未提交的数据</li>
<li>不可重复读: Non-repeatable read: 两次读取结果不同</li>
<li>幻读 Phantom Read: select操作得到的结果所表证的数据状态无法支撑后续的业务操作</li>
</ul>
</li>
<li><p>InnoDB 四种隔离级别</p>
<ul>
<li>READ UNCOMMITED 读未提交 –&gt; 脏读</li>
<li>READ COMMITTED 读已提交 –&gt;  不可重复读</li>
<li>REPEATABLE READ 可重复读 –&gt; 幻读</li>
<li>SERIALIZABLE 串行化</li>
</ul>
</li>
</ul>
<h2 id="数据库日志"><a href="#数据库日志" class="headerlink" title="数据库日志"></a>数据库日志</h2><ul>
<li><p>重做日志 - redo log</p>
<blockquote>
<p>记录修改后的数据<br>用于异常恢复<br>循环写文件</p>
<blockquote>
<p>write Pos: 写入位置<br>Check Point: 刷盘位置<br>Check Point -&gt; Write Pos: 待落盘<br>innodb_flush_log_at_trx_commit: 刷盘时机</p>
<blockquote>
<p>0 commit 每秒写文件,并刷盘<br>1 commit 每次提交时写文件，</p>
</blockquote>
</blockquote>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># MySQL redo-log:</span></span><br><span class="line"><span class="bullet">  1.</span> 体积小，记录页的修改，比写入页代价低</span><br><span class="line"><span class="bullet">  2.</span> 末尾追加，随机写变顺序写，发生改变的页不固定</span><br></pre></td></tr></table></figure></li>
<li><p>回滚日志 - Undo Log</p>
<blockquote>
<p>回滚日志记录的集合，包含如何撤销事务对聚集索引记录的最新更新的信息</p>
</blockquote>
<ul>
<li><p>保证事务原子性</p>
</li>
<li><p>实现数据多版本</p>
</li>
<li><p>delete undo log: 用于回滚，提交即清理</p>
</li>
<li><p>update undo log:</p>
</li>
<li><p>undo log如何清理:</p>
<ul>
<li>依据系统活跃的最小活跃事务ID Read view</li>
</ul>
</li>
<li><h2 id="为什么InnoDB-count-这么慢"><a href="#为什么InnoDB-count-这么慢" class="headerlink" title="为什么InnoDB count(*) 这么慢?"></a>为什么InnoDB count(*) 这么慢?</h2></li>
</ul>
</li>
</ul>
<h2 id="MySQl多版本并发控制-MVCC"><a href="#MySQl多版本并发控制-MVCC" class="headerlink" title="MySQl多版本并发控制 - MVCC"></a>MySQl多版本并发控制 - MVCC</h2><blockquote>
<p>使得InnoDB的事务隔离级别下执行一致性读操作有保证, 查询一个被另一个事务更新的行，可以看到被更新之前的值<br>多版本并发控制，解决读写冲突问题</p>
</blockquote>
<ul>
<li>InnoDB MVCC实现<ul>
<li>当前读 – Select for update</li>
<li>快照读 – Select Current_TRX_ID</li>
<li>可见性判断<ul>
<li>创建快照这一刻，还未提交的事务，在此生命周期中无法读取</li>
<li>创建快照之后创建的事务无法读取</li>
</ul>
</li>
<li>Read View<ul>
<li>快照读 活跃事务列表</li>
<li>活跃事务列表中最小事务ID</li>
<li>活跃事务列表中最大事务ID<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">InnoDB</span>向数据库中存储的每一行数据添加三个字段隐藏字段</span><br><span class="line"><span class="attribute">1</span>. DB_TRX_ID: <span class="number">6</span>字节 表示插入或更新最后一个事务的事务标识符 全局递增</span><br><span class="line"><span class="attribute">2</span>. DB_ROLL_PTR: <span class="number">7</span>字节 回滚指针 roll pointer, 指向写入回滚段撤销日志Undo Log</span><br><span class="line"><span class="attribute">3</span>. DB_ROW_ID: <span class="number">6</span>字节 随着新行插入而单调增加的行ID</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>  <img src="/misc/images/mvcc.jpeg" alt="mvcc"></p>
<ul>
<li>InnoDB Locking<ul>
<li>Shared and Exclusive Locks - 共享锁和排他锁<ul>
<li>A Shared Lock 允许持有锁的事务读取该行</li>
<li>An Exclusive Lock 允许持有锁的事务更新和删除该行<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">假设事务T1对数据行r持有共享锁(Shared <span class="keyword">Lock</span>),另一个事务T2对同一数据行r的操作分下面两种情况:</span><br><span class="line">  <span class="number">1.</span> T2对数据行r仅仅是读取请求持有(Shared <span class="keyword">Lock</span>)成功，结果是T1和T2对数据行r都持有共享锁</span><br><span class="line">  <span class="number">2.</span> T2对数据行人需要<span class="keyword">Update</span>请求持有(<span class="keyword">Exclusive</span> <span class="keyword">Lock</span>)会失败</span><br><span class="line"></span><br><span class="line">假设事务T1对数据行r持有排他锁(<span class="keyword">exclusive</span> <span class="keyword">lock</span>),另一个事务T2对同一数据行r的锁请求(共享锁/排他锁)都会失败,事务T2不得不等待事务T1释放锁</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="MySQL-存储引擎"><a href="#MySQL-存储引擎" class="headerlink" title="MySQL 存储引擎"></a>MySQL 存储引擎</h2><ul>
<li><p>InnoDB内存管理<br>Buffer Pool: 预分配的内存池<br>Page: Buffer Pool 的最小单位<br>Free List: 空闲Page组成的链表<br>Flush List: 脏页链表<br>Page Hash表:<br>  维护内存Page和文件Page的映射关系<br>LRU: 内存淘汰算法 - 冷热分离<br>  LRU_new: 存储热数据<br>  LRU_old: 存储冷数据<br>  Midpoint:</p>
<p>页面淘汰:<br>  LRU尾部淘汰<br>  Flush LRU淘汰</p>
<ul>
<li>预分配内存空间<ul>
<li>Buffer Pool: 预分配内存池, 页面加载单位Page</li>
</ul>
</li>
<li>数据加载单元</li>
<li>数据内外存交换<ul>
<li>内存池</li>
<li>内存页面管理<ul>
<li>空闲页</li>
<li>数据页<ul>
<li>脏页: 数据被Update 需要刷盘</li>
</ul>
</li>
<li>页面映射</li>
<li>页面数据管理</li>
</ul>
</li>
<li>数据淘汰<ul>
<li>LRU: 最经常被访问的数据放在表头，默认删除表尾</li>
<li>LFU: 使用频率淘汰算法</li>
<li>双LRU: 热表LRU，冷表LRU</li>
<li>全表扫描对内存的影响?<blockquote>
<p>导致热数据被替换; 缓冲区被污染，导致数据库性能下降</p>
</blockquote>
</li>
<li><h2 id="避免全表扫描对热数据的影响"><a href="#避免全表扫描对热数据的影响" class="headerlink" title="避免全表扫描对热数据的影响"></a>避免全表扫描对热数据的影响</h2></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="MySQL-锁实现原理"><a href="#MySQL-锁实现原理" class="headerlink" title="MySQL 锁实现原理"></a>MySQL 锁实现原理</h2><ul>
<li><p>锁颗粒度</p>
<ul>
<li>行级锁<ul>
<li>作用在索引(聚簇索引、二级索引)行</li>
<li>是否是唯一索引</li>
</ul>
</li>
<li>间隙锁<ul>
<li>解决可重复读模式下的幻读问题</li>
<li>GAP锁不是加载记录上</li>
<li>GAP锁锁住的位置是两条记录之间的GAP</li>
<li>保证两次当前读返回一致的记录</li>
</ul>
</li>
<li>表级锁<ul>
<li>lock tables</li>
<li>元数据锁(meta data lock, MDL)</li>
<li>全表扫描”表锁”</li>
</ul>
</li>
</ul>
</li>
<li><p>类型</p>
<ul>
<li>共享锁S<ul>
<li>读锁，可以同时被多个事务获取，阻止其他事务对记录的修改</li>
</ul>
</li>
<li>排他锁X<ul>
<li>写锁</li>
</ul>
</li>
</ul>
</li>
<li><h2 id="所有当前读加排他锁"><a href="#所有当前读加排他锁" class="headerlink" title="所有当前读加排他锁:"></a>所有当前读加排他锁:</h2></li>
</ul>
<h2 id="数据库索引"><a href="#数据库索引" class="headerlink" title="数据库索引"></a>数据库索引</h2><ul>
<li><p>in, not in, exists, not exists</p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">➜ mysql -h 127.0.0.1 -u chyi -P 13306 -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 223</span><br><span class="line">Server version: 8.0.26-0ubuntu0.20.04.2 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">&#x27;help;&#x27;</span> or <span class="emphasis">&#x27;\h&#x27;</span> for help. Type <span class="emphasis">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; use develop;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; DROP TABLE IF EXISTS <span class="code">`t1`</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE TABLE <span class="code">`t1`</span> (<span class="code">`id`</span> int(11) NOT NULL AUTO_INCREMENT, <span class="code">`name`</span> varchar(255) DEFAULT NULL, <span class="code">`addreee`</span> varchar(255) DEFAULT NULL, PRIMARY KEY(<span class="code">`id`</span>)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.06 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO <span class="string">`t1` VALUES (&#x27;</span>1001&#x27;, <span class="emphasis">&#x27;张三&#x27;</span>, <span class="emphasis">&#x27;北京&#x27;</span>), (<span class="emphasis">&#x27;1002&#x27;</span>, <span class="emphasis">&#x27;李四&#x27;</span>, <span class="emphasis">&#x27;天津&#x27;</span>), (<span class="emphasis">&#x27;1003&#x27;</span>, <span class="emphasis">&#x27;王五&#x27;</span>, <span class="emphasis">&#x27;北京&#x27;</span>), (<span class="emphasis">&#x27;1004&#x27;</span>, <span class="emphasis">&#x27;赵六&#x27;</span>, <span class="emphasis">&#x27;河北&#x27;</span>), (<span class="emphasis">&#x27;1005&#x27;</span>, <span class="emphasis">&#x27;杰克&#x27;</span>, <span class="emphasis">&#x27;河南&#x27;</span>), (<span class="emphasis">&#x27;1006&#x27;</span>, <span class="emphasis">&#x27;汤姆&#x27;</span>, <span class="emphasis">&#x27;河南&#x27;</span>), (<span class="emphasis">&#x27;1007&#x27;</span>, <span class="emphasis">&#x27;贝尔&#x27;</span>, <span class="emphasis">&#x27;上海&#x27;</span>), (<span class="emphasis">&#x27;1008&#x27;</span>, <span class="emphasis">&#x27;孙琪&#x27;</span>, <span class="emphasis">&#x27;北京&#x27;</span>);</span><br><span class="line">Query OK, 8 rows affected (0.04 sec)</span><br><span class="line">Records: 8  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="section">mysql&gt; select * from t1;</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1001 | 张三   | 北京    |</span><br><span class="line">| 1002 | 李四   | 天津    |</span><br><span class="line">| 1003 | 王五   | 北京    |</span><br><span class="line">| 1004 | 赵六   | 河北    |</span><br><span class="line">| 1005 | 杰克   | 河南    |</span><br><span class="line">| 1006 | 汤姆   | 河南    |</span><br><span class="line">| 1007 | 贝尔   | 上海    |</span><br><span class="line"><span class="section">| 1008 | 孙琪   | 北京    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">8 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DROP TABLE IF EXISTS <span class="code">`t2`</span>;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE TABLE <span class="code">`t2`</span> (<span class="code">`id`</span> int(11) NOT NULL AUTO_INCREMENT, <span class="code">`name`</span> varchar(255), <span class="code">`address`</span> varchar(255), PRIMARY KEY(<span class="code">`id`</span>)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.06 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1001, &#x27;</span>张三<span class="emphasis">&#x27;, &#x27;</span>北京<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1004, &#x27;</span>赵六<span class="emphasis">&#x27;, &#x27;</span>河北<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.05 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1005, &#x27;</span>杰克<span class="emphasis">&#x27;, &#x27;</span>河南<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1007, &#x27;</span>贝尔<span class="emphasis">&#x27;, &#x27;</span>上海<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.03 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1008, &#x27;</span>孙琪<span class="emphasis">&#x27;, &#x27;</span>北京<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1009, &#x27;</span>曹操<span class="emphasis">&#x27;, &#x27;</span>魏国<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1010, &#x27;</span>刘备<span class="emphasis">&#x27;, &#x27;</span>蜀国<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1011, &#x27;</span>孙权<span class="emphasis">&#x27;, &#x27;</span>吴国<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1012, &#x27;</span>诸葛亮<span class="emphasis">&#x27;, &#x27;</span>蜀国<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span>mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1013, &#x27;</span>典韦<span class="emphasis">&#x27;, &#x27;</span>魏国<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span><span class="section">mysql&gt; select * FROM t1 where name not in (select name from t2);</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1002 | 李四   | 天津    |</span><br><span class="line">| 1003 | 王五   | 北京    |</span><br><span class="line"><span class="section">| 1006 | 汤姆   | 河南    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"><span class="section">mysql&gt; select * from t1 where not exists (select name from t2 where t1.name = t2.name);</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1002 | 李四   | 天津    |</span><br><span class="line">| 1003 | 王五   | 北京    |</span><br><span class="line"><span class="section">| 1006 | 汤姆   | 河南    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO <span class="string">`t2` VALUES (1014, NULL, &#x27;</span>魏国<span class="emphasis">&#x27;);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.05 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"></span># not in 需要保证自查询的匹配字段是非空的</span><br><span class="line">mysql&gt; select * FROM t1 where name not in (select name from t2);</span><br><span class="line">Empty set (0.04 sec)</span><br><span class="line"></span><br><span class="line"># exists 返回的结果是一个boolean值 true或者false,而不关心某个结果集</span><br><span class="line"><span class="section">mysql&gt; select * from t1 where not exists (select name from t2 where t1.name = t2.name);</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1002 | 李四   | 天津    |</span><br><span class="line">| 1003 | 王五   | 北京    |</span><br><span class="line"><span class="section">| 1006 | 汤姆   | 河南    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"># 自查询中name可以修改为其他任意的字段,执行效率上1&gt;column&gt;*</span><br><span class="line"><span class="section">mysql&gt; select * from t1 where not exists (select 1 from t2 where t1.name = t2.name);</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1002 | 李四   | 天津    |</span><br><span class="line">| 1003 | 王五   | 北京    |</span><br><span class="line"><span class="section">| 1006 | 汤姆   | 河南    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"># in, exists 执行流程</span><br><span class="line"># 对于in查询来说，会先执行子查询，然后把查询得到的结果和外表t1做笛卡尔，通过条件进行筛选(name是否相等)</span><br><span class="line"><span class="section">mysql&gt; select * from t1 where name in (select name from t2);</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1001 | 张三   | 北京    |</span><br><span class="line">| 1004 | 赵六   | 河北    |</span><br><span class="line">| 1005 | 杰克   | 河南    |</span><br><span class="line">| 1007 | 贝尔   | 上海    |</span><br><span class="line"><span class="section">| 1008 | 孙琪   | 北京    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">5 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"># exists,先查询便利外表t1,然后每次遍历时，在检查内标是否符合匹配条件</span><br><span class="line"><span class="section">mysql&gt; select * from t1 where exists (select 1 from t2 where t1.name = t2.name);</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line"><span class="section">| id   | name   | addreee |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">| 1001 | 张三   | 北京    |</span><br><span class="line">| 1004 | 赵六   | 河北    |</span><br><span class="line">| 1005 | 杰克   | 河南    |</span><br><span class="line">| 1007 | 贝尔   | 上海    |</span><br><span class="line"><span class="section">| 1008 | 孙琪   | 北京    |</span></span><br><span class="line"><span class="section">+------+--------+---------+</span></span><br><span class="line">5 rows in set (0.03 sec)</span><br><span class="line"></span><br><span class="line"># 当 in 值多了之后，就不走索引了; 推测MySQL对in查询的成本优化器CBO</span><br><span class="line"><span class="section">mysql&gt; explain select * from t1 where id in (1001, 1002, 1003, 1004, 1005, 1006, 1007);</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="section">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="section">|  1 | SIMPLE      | t1    | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL |    7 |   100.00 | Using where |</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in set, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">mysql&gt; explain select * from t1 where id in (1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010);</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="section">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="section">|  1 | SIMPLE      | t1    | NULL       | ALL  | PRIMARY       | NULL | NULL    | NULL |    8 |   100.00 | Using where |</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in set, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line"># 如果查询的两个表大小相当，用in和exist差别不大，如果两个表中一个较小一个较大，则子查询表大的用exists,子查询表小的用in.</span><br><span class="line"></span><br><span class="line"><span class="section">mysql&gt; explain select * from t1 where id in (select id from t2);</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------------+</span></span><br><span class="line"><span class="section">| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref           | rows | filtered | Extra       |</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | t1    | NULL       | ALL    | PRIMARY       | NULL    | NULL    | NULL          |    8 |   100.00 | NULL        |</span><br><span class="line"><span class="section">|  1 | SIMPLE      | t2    | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | develop.t1.id |    1 |   100.00 | Using index |</span></span><br><span class="line"><span class="section">+----+-------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------------+</span></span><br><span class="line">2 rows in set, 1 warning (0.05 sec)</span><br><span class="line"></span><br><span class="line"># 本意显示警告信息，但是和explain使用，会显示优化后的sql</span><br><span class="line"><span class="section">mysql&gt; show warnings;</span></span><br><span class="line"><span class="section">+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="section">| Level | Code | Message                                                                                                                                                                                                           |</span></span><br><span class="line"><span class="section">+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="section">| Note  | 1003 | /* select#1 */ select `develop`.`t1`.`id` AS `id`,`develop`.`t1`.`name` AS `name`,`develop`.`t1`.`addreee` AS `addreee` from `develop`.`t2` join `develop`.`t1` where (`develop`.`t2`.`id` = `develop`.`t1`.`id`) |</span></span><br><span class="line"><span class="section">+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">1 row in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"># 外层大表内存小表，用in, 外层小表内层大表，in和exists效率差不多.</span><br></pre></td></tr></table></figure></li>
<li><p>join 嵌套循环 Nested-Loop Join</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. 简单嵌套循环连接 Simple <span class="keyword">Nested</span>-<span class="keyword">Loop</span> <span class="keyword">Join</span></span><br><span class="line">  inner <span class="keyword">join</span> - 内连接 双层循环遍历两张表</span><br><span class="line">  一般sql中会以小表作为驱动表，外层循环，内层循环作为被驱动表</span><br><span class="line"><span class="number">2</span>. 索引嵌套循环连接</span><br><span class="line">  内存表列要有索引</span><br><span class="line"><span class="number">3</span>. 快索引嵌套连接 <span class="keyword">Block</span> <span class="keyword">Nested</span> <span class="keyword">Loop</span> <span class="keyword">Join</span></span><br><span class="line">  &gt; 缓存外层表的数据到<span class="keyword">join</span> buffer中，然后buffer中数据批量和内层表数据进行匹配，从而减少内存循环的次数</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>数据库</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis Tips &amp; Tracks</title>
    <url>/2021/09/02/Redis-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><blockquote>
<p>Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache, and message broker.</p>
</blockquote>
<span id="more"></span>

<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><ul>
<li>通信协议<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">redis客户端和服务器发送的命令和数据一律以\r\n (<span class="literal">CR</span> LF)结尾</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求协议:</span></span><br><span class="line">  *&lt;参数数量&gt; <span class="literal">CR</span> LF</span><br><span class="line">  $&lt;参数的字节数量&gt; <span class="literal">CR</span> LF</span><br><span class="line">  &lt;参数的数据&gt; <span class="literal">CR</span> LF</span><br><span class="line"></span><br><span class="line">  ubuntu <span class="keyword">in</span> /  <span class="keyword">at</span> <span class="number">3</span>BPlus took <span class="number">11</span>s</span><br><span class="line">  ➜ tail appendonly.aof</span><br><span class="line">  $<span class="number">3</span></span><br><span class="line">  <span class="built_in">set</span></span><br><span class="line">  $<span class="number">4</span></span><br><span class="line">  name</span><br><span class="line">  $<span class="number">10</span></span><br><span class="line">  chyiyaqing</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回复协议:</span></span><br><span class="line">  &gt; 在回复协议中，可以通过检查第一个字节，确定这个回复是什么类型</span><br><span class="line">  - 状态回复 (status reply) 第一个字节是 <span class="string">&quot;+&quot;</span></span><br><span class="line">  - 错误回复 (error reply) 第一个字节是 <span class="string">&quot;-&quot;</span></span><br><span class="line">  - 整数回复 (<span class="keyword">integer</span> reply) 第一个字节是 <span class="string">&quot;.&quot;</span></span><br><span class="line">  - 批量回复 (bulk reply) 第一个字节是 <span class="string">&quot;$&quot;</span></span><br><span class="line">  - 多条批量回复 (multi bulk reply) 第一个字节是 <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><blockquote>
<p>Redis 持久化主要两大机制: AOF (Append Only File) 日志和RDB 快照</p>
</blockquote>
<ul>
<li><p>AOF - Append Only File</p>
<blockquote>
<p>AOF日志是Redis执行完命令，把数据写入内存，然后才记录日志,记录的是Redis收到的每一条命令</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 写后日志这种方式，先让系统执行命令，只有命令执行成功，才会被记录到日志中，避免出现记录错误命令的情况</span></span><br><span class="line"><span class="section"># AOF 是在命令执行后才记录日志，不会阻塞当前写操作</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 写回磁盘策略 appendfsync</span></span><br><span class="line"><span class="bullet">  1.</span> Always: 同步写回, 每个写命令执行完，立马同步将日志写回磁盘</span><br><span class="line"><span class="code">    &gt; 落盘操作属于慢速，回影响主线程性能</span></span><br><span class="line"><span class="code">  2. Everysec: 每秒写回,每个写命令执行完，先把日志写到AOF文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘</span></span><br><span class="line"><span class="code">    &gt; 在避免影响主线程和避免数据丢失两者之间trade-off方式</span></span><br><span class="line"><span class="code">  3. No: 操作系统控制写回，每个写命令执行完，只是先把日志写到AOF文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span></span><br><span class="line"><span class="code">    &gt; 落盘时机交给操作系统，只要AOF记录没有写回磁盘，宕机对应的数据就丢失</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># 解决AOF文件过大的性能问题: AOF 重写</span></span><br><span class="line"></span><br><span class="line">  问题:</span><br><span class="line"><span class="bullet">    1.</span> 文件系统本身对文件大小有限制，无法保存过大的文件</span><br><span class="line"><span class="bullet">    2.</span> 文件过大，追加命令记录效率变低</span><br><span class="line"><span class="bullet">    3.</span> 发生宕机，AOF记录命令要被重新执行，故障恢复比较缓慢，会影响Redis正常使用</span><br><span class="line"></span><br><span class="line">  AOF重写:</span><br><span class="line"><span class="code">    &gt; 重写机制可以将旧日志文件中的多条命令，在重写后的新日志中变成一条命令</span></span><br><span class="line"><span class="code">    &gt; AOF重写过程是由后台子进程bgrewriteaof完成，避免阻塞主线程，导致性能下降</span></span><br><span class="line"><span class="code">    &gt; 每次AOF重写时，Redis会执行一个内存拷贝，用于重写，然后使用两个日志保证重写过程中，新写入的数据不会丢失，而且，Redis采用额外的线程进行数据重写，过程不会阻塞主线程</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure></li>
<li><p>RDB - 内存快照</p>
<blockquote>
<p>内存快照：指内存中的数据在某一个时刻的状态记录</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># Redis两种命令生成RDB文件</span></span><br><span class="line"><span class="bullet">  1.</span> save: 在主线程执行，会导致阻塞</span><br><span class="line"><span class="bullet">  2.</span> bgsave: 创建子进程，专门用于写入RDB文件，避免主线程阻塞</span><br><span class="line"><span class="code">    &gt; bgsave子进程由主线程fork生成，共享主线程的所有内存数据，bgsave子进程运行后，开始读取主线程的内存数据，并把数据写入RDB文件</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># 增量快照:</span></span><br><span class="line"><span class="quote">&gt; 做一次全量快照后，后续的快照支队修改的数据进行快照记录，可以避免每次全量快照的开销</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 混合使用AOF日志和内存快照</span></span><br><span class="line"><span class="quote">&gt; 内存快照以一定的频率执行，两次快照之间，使用AOF日志记录这期间的所有命令操作</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Redis-应用场景-消息队列"><a href="#Redis-应用场景-消息队列" class="headerlink" title="Redis 应用场景 - 消息队列"></a>Redis 应用场景 - 消息队列</h2>  <figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 消息队列需要满足的功能:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  1.</span> 支持阻塞等待拉取消息</span><br><span class="line"><span class="bullet">  2.</span> 支持发布/订阅模式</span><br><span class="line"><span class="bullet">  3.</span> 消费失败，可重新消费，消息不丢失</span><br><span class="line"><span class="bullet">  4.</span> 实例宕机，消息不丢失、数据可持久化</span><br><span class="line"><span class="bullet">  5.</span> 消息可堆积</span><br></pre></td></tr></table></figure>

<ul>
<li><p>List - 队列:</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line">ubuntu in ~ at 3BPlus</span><br><span class="line">➜ redis-cli -c -p <span class="number">6001</span></span><br><span class="line"><span class="number">127.0.0.1:6001</span>&gt; ping</span><br><span class="line">PONG</span><br><span class="line"><span class="number">127.0.0.1:6001</span>&gt; LPUSH queue msg1    # 增加消息</span><br><span class="line">-&gt; Redirected to slot <span class="string">[13011]</span> located at <span class="number">172</span>.<span class="number">30</span>.<span class="number">1</span>.<span class="number">23</span>:<span class="number">6003</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">172.30.1.23:6003</span>&gt; LPUSH queue msg2</span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">172.30.1.23:6003</span>&gt; RPOP queue        # 拉取消息</span><br><span class="line"><span class="string">&quot;msg1&quot;</span></span><br><span class="line"><span class="number">172.30.1.23:6003</span>&gt; RPOP queue</span><br><span class="line"><span class="string">&quot;msg2&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6001</span>&gt; RPOP queue          # 队列为空，RPOP返回NULL</span><br><span class="line">-&gt; Redirected to slot <span class="string">[13011]</span> located at <span class="number">172</span>.<span class="number">30</span>.<span class="number">1</span>.<span class="number">23</span>:<span class="number">6003</span></span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0.0.1:6001</span>&gt; BRPOP queue <span class="number">5</span>       # BRPOP阻塞式拉取消息，支持传入超时时间</span><br><span class="line">-&gt; Redirected to slot <span class="string">[13011]</span> located at <span class="number">172</span>.<span class="number">30</span>.<span class="number">1</span>.<span class="number">23</span>:<span class="number">6003</span></span><br><span class="line">(nil)</span><br><span class="line">(<span class="number">5</span>.00s)</span><br><span class="line"><span class="number">172.30.1.23:6003</span>&gt; BRPOP queue <span class="number">0</span>     # 不设置超时，直到有新消息才返回</span><br><span class="line">^C</span><br><span class="line"><span class="number">172.30.1.23:6003</span>&gt; exit</span><br><span class="line"></span><br><span class="line">注意: 如果设置超时时间太长，连接太久没有活跃，有可能会被Redis server判定为无效连接，之后Redis Server会强制把这个客户端踢下线，客户端要有重连机制</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 不支持重复消费：消费者拉取消息后，该消息就从List中删除，无法被其他消费者在此消费，即不支持多个消费者消费同一批数据</span><br><span class="line"><span class="number">2</span>. 消息丢失，消费者拉取到消息后，如果发生异常宕机，这条消息就丢失</span><br><span class="line"></span><br><span class="line"># 单机测评</span><br><span class="line">ubuntu in ~ at 3BPlus took 37s</span><br><span class="line">➜ redis-benchmark -n <span class="number">1000000</span> -t lpush,rpop -P <span class="number">16</span> -q -h <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -p <span class="number">6001</span> --cluster</span><br><span class="line">Cluster has <span class="number">3</span> master nodes:</span><br><span class="line"></span><br><span class="line">Master <span class="number">0</span>: a733c21d3b735b9d026eb4d462ef6b367d8ebb98 <span class="number">172</span>.<span class="number">30</span>.<span class="number">1</span>.<span class="number">23</span>:<span class="number">6002</span></span><br><span class="line">Master <span class="number">1</span>: 9c35a4e211f6534861ed768dba592e85539b1377 <span class="number">172</span>.<span class="number">30</span>.<span class="number">1</span>.<span class="number">23</span>:<span class="number">6003</span></span><br><span class="line">Master <span class="number">2</span>: a901e497cb72819cf0765e9e4eb16c36399c437b <span class="number">172</span>.<span class="number">30</span>.<span class="number">1</span>.<span class="number">23</span>:<span class="number">6001</span></span><br><span class="line"></span><br><span class="line">LPUSH: <span class="number">41529</span>.<span class="number">96</span> requests per second, p50=<span class="number">17</span>.<span class="number">199</span> msec</span><br><span class="line">RPOP: <span class="number">46539</span>.<span class="number">77</span> requests per second, p50=<span class="number">15</span>.<span class="number">463</span> msec</span><br></pre></td></tr></table></figure></li>
<li><p>Pub/Sub - 发布订阅模型</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 消费者1</span></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ <span class="keyword">at</span> <span class="number">3</span>BPlus</span><br><span class="line">➜ redis-cli -c -p <span class="number">6001</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; SUBSCRIBE queue</span><br><span class="line">Reading messages... (press Ctrl-C <span class="keyword">to</span> quit)</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line"><span class="number">3</span>) (<span class="built_in">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;message&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;msg1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者2</span></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ <span class="keyword">at</span> <span class="number">3</span>BPlus</span><br><span class="line">➜ redis-cli -c -p <span class="number">6001</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; SUBSCRIBE queue</span><br><span class="line">Reading messages... (press Ctrl-C <span class="keyword">to</span> quit)</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line"><span class="number">3</span>) (<span class="built_in">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;message&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;msg1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产者</span></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ <span class="keyword">at</span> <span class="number">3</span>BPlus</span><br><span class="line">➜ redis-cli -c -p <span class="number">6001</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; PUBLISH queue msg1</span><br><span class="line">(<span class="built_in">integer</span>) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; PUBLISH queue msg2</span><br><span class="line">(<span class="built_in">integer</span>) <span class="number">2</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pub/Sub 支持阻塞式拉取消息，满足多组消费者，匹配订阅模式,允许消费者订阅多个队列</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; PUBLISH queue.p1 msg1       <span class="comment">-- 生产者</span></span><br><span class="line">(<span class="built_in">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; PUBLISH queue.p2 msg2</span><br><span class="line">(<span class="built_in">integer</span>) <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6001</span>&gt; PSUBSCRIBE queue.*          <span class="comment">-- 消费者 匹配订阅</span></span><br><span class="line">Reading messages... (press Ctrl-C <span class="keyword">to</span> quit)</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;psubscribe&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue.*&quot;</span></span><br><span class="line"><span class="number">3</span>) (<span class="built_in">integer</span>) <span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;pmessage&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue.*&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;queue.p1&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;msg1&quot;</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;pmessage&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;queue.*&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;queue.p2&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;msg2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pub/Sub 实现原理</span></span><br><span class="line">&gt; 没有基于任何数据类型，没有做任何数据存储，只是单纯地为生产者、消费者建立数据转发通道，把符合规则的数据，从一端转发到另一端</span><br><span class="line">&gt; **在使用Pub/Sub时，消费者必须先订阅队列，生产者才能发布消息，否则消息会丢失**</span><br><span class="line">&gt; List属于“拉取模式”, Pub/Sub属于“推模式”</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意使用Pub/Sub会丢数据</span></span><br><span class="line"><span class="number">1.</span> 消费者下线,重新上线，只能接收新的消息，在下线期间生产者发布的消息，因为找不到消费者，会被丢弃掉.</span><br><span class="line"><span class="number">2.</span> Redis宕机, Pub/Sub相关操作，不会写入RDB和AOF中，当Redis宕机重启，Pub/Sub的数据会全部丢失</span><br><span class="line"><span class="number">3.</span> 消费堆积, 每个消费者订阅一个队列，Redis都会在Server给消费者分配一个【缓冲区】,这个缓冲区其实就是一块内存，当生产者发布消息时，Redis先把消息写到对应消费者的缓冲区,之后消费者不断从缓冲区读取、处理消息, 缓冲区上线,会被强制下线.</span><br></pre></td></tr></table></figure></li>
<li><p>Stream</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Stream 通过XADD 和 XREAD完成简单的生产、消费模型</span></span><br><span class="line">  XADD: 发布消息</span><br><span class="line">  XREAD: 读取消息</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产者发布消息</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6001</span>&gt; XADD <span class="keyword">queue</span> * name <span class="number">2021</span>      <span class="comment"># * 表示自动生成唯一消息ID</span></span><br><span class="line">-&gt; Redirected <span class="keyword">to</span> slot [<span class="number">13011</span>] located at <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span></span><br><span class="line"><span class="string">&quot;1630886765690-0&quot;</span>                           <span class="comment">#消息ID格式: 时间戳-自增序号</span></span><br><span class="line"><span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XADD <span class="keyword">queue</span> * name <span class="number">09</span>-<span class="number">06</span></span><br><span class="line"><span class="string">&quot;1630886777470-0&quot;</span></span><br><span class="line"><span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者消费消息</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6001</span>&gt; XREAD COUNT <span class="number">5</span> STREAMS <span class="keyword">queue</span> <span class="number">0</span>-<span class="number">0</span>   <span class="comment"># 从开头读取5条消息，0-0表示从开头读取</span></span><br><span class="line">-&gt; Redirected <span class="keyword">to</span> slot [<span class="number">13011</span>] located at <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span></span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line">   <span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;1630886765690-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;2021&quot;</span></span><br><span class="line">      <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;1630886777470-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;09-06&quot;</span></span><br><span class="line"><span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XREAD COUNT <span class="number">5</span> STREAMS <span class="keyword">queue</span> <span class="number">1630886777470</span>-<span class="number">0</span>  <span class="comment"># 继续拉取消息,传入上一条消息的ID</span></span><br><span class="line"><span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XREAD COUNT <span class="number">5</span> BLOCK <span class="number">0</span> STREAMS <span class="keyword">queue</span> <span class="number">1630886777470</span>-<span class="number">0</span>  <span class="comment"># BLOCK 阻塞式拉取消息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Stream 支持发布/订阅模式</span></span><br><span class="line">  - XGROUP: 创建消费者组</span><br><span class="line">  - XREADGROUP: 在指定消费组下，开启消费者拉取消息</span><br><span class="line"></span><br><span class="line">  <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XGROUP CREATE <span class="keyword">queue</span> group1 <span class="number">0</span>-<span class="number">0</span>  <span class="comment"># 创建消费者组1， 0-0表示从头拉取消费</span></span><br><span class="line">  OK</span><br><span class="line">  <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XGROUP CREATE <span class="keyword">queue</span> group2 <span class="number">0</span>-<span class="number">0</span>  <span class="comment"># 创建消费者组2，0-0</span></span><br><span class="line">  OK</span><br><span class="line"></span><br><span class="line">  <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XREADGROUP GROUP group1 consumer COUNT <span class="number">5</span> STREAMS <span class="keyword">queue</span> &gt;  <span class="comment"># group1 的consumer开始消费，&gt;表示拉取最新数据</span></span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line">   <span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;1630886765690-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;2021&quot;</span></span><br><span class="line">      <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;1630886777470-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;09-06&quot;</span></span><br><span class="line">      <span class="number">3</span>) <span class="number">1</span>) <span class="string">&quot;1630887243865-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;08-14&quot;</span></span><br><span class="line">  <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XREADGROUP GROUP group2 consumer COUNT <span class="number">5</span> STREAMS <span class="keyword">queue</span> &gt;</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;queue&quot;</span></span><br><span class="line">   <span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;1630886765690-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;2021&quot;</span></span><br><span class="line">      <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;1630886777470-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;09-06&quot;</span></span><br><span class="line">      <span class="number">3</span>) <span class="number">1</span>) <span class="string">&quot;1630887243865-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;08-14&quot;</span></span><br><span class="line">  <span class="number">172.30</span>.<span class="number">1.23</span>:<span class="number">6003</span>&gt; XACK <span class="keyword">queue</span> group1 <span class="number">1630887243865</span>-<span class="number">0</span>  <span class="comment"># XACK 命令告知Redis消费者处理完</span></span><br><span class="line">  (integer) <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Stream 数据会写入RDB和AOF做持久化A</span></span><br><span class="line"><span class="comment"># 消息堆积，Stream会只保留固定长度的新消息,当队列长度超过上限，就消息会被删除，只保留固定长度的新消息</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>缓存</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>echo-go-web-framework</title>
    <url>/2021/09/02/echo-go-web-framework/</url>
    <content><![CDATA[<h1 id="Echo"><a href="#Echo" class="headerlink" title="Echo"></a>Echo</h1><blockquote>
<p>高性能、可扩展、精简的Go Web框架</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">➜ go run main.go</span><br><span class="line"></span><br><span class="line">   <span class="strong">____</span>    <span class="strong">__</span></span><br><span class="line"><span class="strong">  / __</span>/<span class="strong">__<span class="emphasis">_/ /  <span class="strong">__<span class="emphasis">_</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"> / _</span>// __</span>/ _</span> \/ <span class="emphasis">_ \</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">/<span class="strong">__<span class="emphasis">_/\<span class="strong">__/<span class="emphasis">_//_</span>/\__</span>_</span>/ v4.5.0</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">High performance, minimalist Go web framework</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">https://echo.labstack.com</span></span></span></span><br><span class="line"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__O/__</span><span class="strong">____</span>_</span></span></span><br><span class="line"><span class="strong">                                    O\</span></span><br><span class="line"><span class="strong">⇨ http server started on [::]:8080</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="功能概述"><a href="#功能概述" class="headerlink" title="功能概述"></a>功能概述</h2><ul>
<li>Optimized HTTP router which smartly prioritize routes</li>
<li>Build robust and scalable RESTful APIs</li>
<li>Group APIs</li>
<li>Extensible middleware framework</li>
<li>Define middleware at root, group or route level</li>
<li>Data binding for JSON, XML and form payload</li>
<li>Handy functions to send variety of HTTP response</li>
<li>Centralized HTTP error handling</li>
<li>Template rendering with any template engine</li>
<li>Define your format for the logger</li>
<li>Highly customizable</li>
<li>Automatic TLS via Let’s Encrypt</li>
<li>HTTP/2 support</li>
</ul>
]]></content>
      <tags>
        <tag>框架</tag>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>Dev-Ops Tips &amp; Tracks</title>
    <url>/2021/09/03/Dev-Ops-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h1><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> Programming</span><br><span class="line"><span class="bullet">2.</span> Software Testing</span><br><span class="line"><span class="bullet">3.</span> Operations</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>DevOps</tag>
      </tags>
  </entry>
  <entry>
    <title>Distribute Scraping for Gophers</title>
    <url>/2021/09/03/Distribute-Scraping-for-Gophers/</url>
    <content><![CDATA[<h1 id="分布式爬虫"><a href="#分布式爬虫" class="headerlink" title="分布式爬虫"></a>分布式爬虫</h1><blockquote>
<p>分布式爬虫是一套任务分发和执行系统，常见的任务分发，因为上下游存在速度不匹配问题，需要借助消息队列</p>
</blockquote>
<span id="more"></span>

<h2 id="分布式消息队列"><a href="#分布式消息队列" class="headerlink" title="分布式消息队列"></a>分布式消息队列</h2><ul>
<li>nats<blockquote>
<p>nats是Go实现的高性能分布式消息队列，适用于高并发吞吐量的消息分发场景.</p>
</blockquote>
</li>
</ul>
]]></content>
      <tags>
        <tag>分布式</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearch Tips &amp; Tracks</title>
    <url>/2021/09/03/Elasticsearch-Tips-Tracks/</url>
    <content><![CDATA[<h1 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h1><blockquote>
<p>Elasticsearch是一个开源的分布式搜索与分析引擎，提供近实时搜索和聚合功能<br>Elastic Stack主要应用于：搜索、日志管理、安全分析、指标分析、业务分析、应用性能监控等多个领域<br>“Search is something that any application should have.”</p>
</blockquote>
<span id="more"></span>

<h2 id="Elastic-Stack-生态圈"><a href="#Elastic-Stack-生态圈" class="headerlink" title="Elastic Stack 生态圈"></a>Elastic Stack 生态圈</h2><ul>
<li><p>解决方案:</p>
<ul>
<li>搜索</li>
<li>日志分析</li>
<li>指标分析</li>
<li>安全分析</li>
</ul>
</li>
<li><p>可视化:</p>
<ul>
<li>Kibana: 可视化分析</li>
</ul>
</li>
<li><p>存储/计算:</p>
<ul>
<li>Elasticsearch: 核心引擎,提供数据存储、搜索和聚合的能力</li>
</ul>
</li>
<li><p>数据抓取:</p>
<ul>
<li>Logstash<blockquote>
<p>开源的服务器端数据处理管道，支持从不同来源采集数据，转换数据，并将数据发送到不同的存储库中</p>
</blockquote>
</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 特性:</span></span><br><span class="line"><span class="bullet">  1.</span> 实时解析和转换数据</span><br><span class="line"><span class="code">    &gt; 从IP地址破译地理位置</span></span><br><span class="line"><span class="code">    &gt; 从PII数据匿名化，排除敏感字段</span></span><br><span class="line"><span class="code">  2. 可扩展</span></span><br><span class="line"><span class="code">  3. 可靠性安全性</span></span><br><span class="line"><span class="code">    &gt; Logstash 通过持久化队列保证至少将运行中的事件送达一次</span></span><br><span class="line"><span class="code">    &gt; 数据传输加密</span></span><br><span class="line"><span class="code">  4. 加密</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Beats<blockquote>
<p>轻量级别数据采集器</p>
</blockquote>
</li>
</ul>
</li>
<li><p>X-Pack: 商业化套件</p>
</li>
</ul>
<blockquote>
<p>Elasticsearch与数据库的集成</p>
</blockquote>
<p><img src="/misc/images/Elastichsearch.png" alt="Elastichsearch"></p>
<blockquote>
<p>指标分析/日志分析</p>
</blockquote>
<ul>
<li>Data Collection(beats) -&gt; Buffering(redis,Kafkak) -&gt; Data Aggregation &amp; Processing(logstash) -&gt; Indexing &amp; storage(elasticsearch) -&gt; Analysis &amp; visualization(Kbana)</li>
</ul>
<h2 id="Elasticsearch-1"><a href="#Elasticsearch-1" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><ul>
<li><p>Elasticsearch 目录结构</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">ubuntu <span class="keyword">in</span> ~/elasticsearch-<span class="number">7.14</span>.<span class="number">1</span> <span class="keyword">at</span> k8s-node1 took <span class="number">45</span>s</span><br><span class="line">➜ tree -L <span class="number">1</span></span><br><span class="line">.</span><br><span class="line">├── bin                 <span class="comment">-- 脚本文件，包括启动elasticsearch,安装插件，运行统计数据</span></span><br><span class="line">├── config              <span class="comment">-- elasticsearch.yml 集群配置文件，user, role based 相关配置</span></span><br><span class="line">├── jdk                 <span class="comment">-- Java 运行环境</span></span><br><span class="line">├── lib                 <span class="comment">-- Java 类库</span></span><br><span class="line">├── LICENSE.txt</span><br><span class="line">├── logs                <span class="comment">-- path.log 日志文件</span></span><br><span class="line">├── modules             <span class="comment">-- 包含所有ES模块</span></span><br><span class="line">├── NOTICE.txt</span><br><span class="line">├── plugins             <span class="comment">-- 包含所有已安装插件</span></span><br><span class="line">└── README.asciidoc</span><br></pre></td></tr></table></figure></li>
<li><p>JVM 配置</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="attr"># 修改JVM - config/jvm.options</span></span><br><span class="line"><span class="attr">  -Xms和Xms 最小最大内存设置成一样</span></span><br><span class="line"><span class="attr">  -Xmx不超过机器内存的50</span><span class="meta">%</span></span><br></pre></td></tr></table></figure></li>
<li><p>Run</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">$ bin/elasticsearch</span><br><span class="line"><span class="symbol">~ took 11m 31s</span></span><br><span class="line"><span class="symbol">➜ curl http</span>:<span class="comment">//localhost:9200</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;a714f28827d5&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;docker-cluster&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;96jmRuNUQxqFsGeWJjIo6g&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;7.14.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_type&quot;</span> : <span class="string">&quot;docker&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;66b55ebfa59c92c15db3f69a335d500018b3331e&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2021-08-26T09:01:05.390870785Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : false,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;8.9.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;6.8.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Plugin 机制对系统扩展</p>
<blockquote>
<p>Discovery Plugin<br>Analysis Plugin<br>Security Plugin<br>Management Plugin<br>Ingest Plugin<br>Mapper Plugin<br>Backup Plugin</p>
</blockquote>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">ubuntu <span class="keyword">in</span> ~ at k8s-node1 via 🐍 <span class="number">3.8</span><span class="number">.6</span></span><br><span class="line">➜ elasticsearch-plugin install analysis-icu  # 分词插件</span><br><span class="line">-&gt; Installing analysis-icu</span><br><span class="line">-&gt; Downloading analysis-icu <span class="keyword">from</span> elastic</span><br><span class="line">[=================================================] <span class="number">100</span>%</span><br><span class="line">-&gt; Installed analysis-icu</span><br><span class="line">-&gt; Please restart Elasticsearch to activate any plugins installed</span><br><span class="line"></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ at k8s-node1 via 🐍 <span class="number">3.8</span><span class="number">.6</span> took <span class="number">23</span>s</span><br><span class="line">➜ elasticsearch-plugin list</span><br><span class="line">analysis-icu</span><br><span class="line"></span><br><span class="line">ubuntu <span class="keyword">in</span> ~ at k8s-node1 via 🐍 <span class="number">3.8</span><span class="number">.6</span></span><br><span class="line">➜ curl http:<span class="comment">//localhost:9200/_cat/plugins</span></span><br><span class="line">k8s-node1 analysis-icu <span class="number">7.14</span><span class="number">.1</span></span><br></pre></td></tr></table></figure></li>
<li><p>多集群<br><a href="/misc/code/elasticsearch/docker-compose.yml">docker-compose.yml</a></p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line">➜ curl -X GET <span class="string">&quot;localhost:9200/_cat/nodes?v=true&amp;pretty&quot;</span></span><br><span class="line">ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name</span><br><span class="line"><span class="number">172.24.0.2</span>           <span class="number">41</span>          <span class="number">97</span>  <span class="number">85</span>    <span class="number">4</span>.<span class="number">28</span>    <span class="number">1</span>.<span class="number">24</span>     <span class="number">0</span>.<span class="number">43</span> cdfhilmrstw -      es01</span><br><span class="line"><span class="number">172.24.0.3</span>           <span class="number">56</span>          <span class="number">97</span>  <span class="number">85</span>    <span class="number">4</span>.<span class="number">28</span>    <span class="number">1</span>.<span class="number">24</span>     <span class="number">0</span>.<span class="number">43</span> cdfhilmrstw -      es03</span><br><span class="line"><span class="number">172.24.0.4</span>           <span class="number">27</span>          <span class="number">97</span>  <span class="number">85</span>    <span class="number">4</span>.<span class="number">28</span>    <span class="number">1</span>.<span class="number">24</span>     <span class="number">0</span>.<span class="number">43</span> cdfhilmrstw *      es02</span><br></pre></td></tr></table></figure></li>
<li><p>Kibana:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">curl</span> http://localhost:<span class="number">5601</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kibana Plugins 插件</span></span><br><span class="line"><span class="variable">$</span> kibana<span class="literal">-plugin</span> install</span><br><span class="line"><span class="variable">$</span> kibana<span class="literal">-plugin</span> list</span><br><span class="line"><span class="variable">$</span> kibana remove</span><br></pre></td></tr></table></figure></li>
<li><p>Logstash:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Elasticsearch-基本概念"><a href="#Elasticsearch-基本概念" class="headerlink" title="Elasticsearch 基本概念"></a>Elasticsearch 基本概念</h2><ul>
<li><p>文档 Document</p>
<blockquote>
<p>Elasticsearch 是面向文档的，文档是所有可搜索数据的最小单位<br>文档会被序列化成JSON格式，保存在Elasticsearch中<br>每个文档都有一个Unique ID</p>
</blockquote>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line"># 文档元数据<span class="type">Metadata</span> - 标注文档的相关信息</span><br><span class="line">  _index - 文档所属的索引名</span><br><span class="line">  _<span class="keyword">type</span>  - 文档所属类型名</span><br><span class="line">  _id    - 文档唯一<span class="type">ID</span></span><br><span class="line">  _source - 文档原始<span class="type">JSON</span>数据</span><br><span class="line">  _version - 文档的版本信息 <span class="comment">-- 解决并发读写冲突</span></span><br><span class="line">  _score  - 相关性打分</span><br></pre></td></tr></table></figure></li>
<li><p>索引 Index</p>
<blockquote>
<p>将文档写入Elasticsearch的过程叫索引indexing</p>
</blockquote>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">Mapping:</span> 定义包含的文档的字段名和字段类型</span><br><span class="line"><span class="symbol">Setting:</span> 定义不同数据分布</span><br><span class="line"><span class="symbol">Shard:</span> 索引中的数据分散在Shards上</span><br></pre></td></tr></table></figure></li>
<li><p>节点 Node</p>
<blockquote>
<p>节点是Elasticsearch 实例</p>
</blockquote>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">-E node.<span class="attr">name=</span>node1</span><br><span class="line">每个节点启动后，会分配一个UID，保存在data目录下</span><br><span class="line"></span><br><span class="line"><span class="comment"># Master-eligible nodes 和 Master Node</span></span><br><span class="line">  <span class="number">1</span>. 节点启动默认是一个<span class="literal">Master</span>-eligible节点, -E node.<span class="literal">master</span>:<span class="literal">false</span> 禁止</span><br><span class="line">  <span class="number">2</span>. <span class="literal">Master</span>-eligible节点可以参加选主流程，称为<span class="literal">Master</span>节点</span><br><span class="line">  <span class="number">3</span>. 每个节点都保存集群状态，只有<span class="literal">master</span>节点才能修改集群状态</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群状态 Cluster State</span></span><br><span class="line">  <span class="number">1</span>. 所有节点信息</span><br><span class="line">  <span class="number">2</span>. 所有的索引和相关Mapping 与 Setting信息</span><br><span class="line">  <span class="number">3</span>. 分片的路由信息</span><br><span class="line"></span><br><span class="line"><span class="comment"># Data Node &amp; Coordinating Node</span></span><br><span class="line">  <span class="number">1</span>. Data <span class="keyword">Node</span><span class="title">: 可以保存数据的节点，保存分片数据</span></span><br><span class="line"><span class="title">  2</span>. Coordinating <span class="keyword">Node</span><span class="title">: 负责接受Client</span>请求，将请求分发到合适的节点，最终把结果汇集到一起</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hot &amp; Warm Node</span></span><br><span class="line"><span class="comment"># Machine Learning Node</span></span><br><span class="line"><span class="comment"># Tribe Node</span></span><br></pre></td></tr></table></figure></li>
<li><p>分片 Primary Shard &amp; Replica Shard</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section">#主分片: 解决数据水平扩展的问题</span></span><br><span class="line"><span class="bullet">  1.</span> 一个分片是一个运行的Lucene的实例</span><br><span class="line"><span class="bullet">  2.</span> 主分片在索引创建时指定，后续不允许修改,使用 Reindex修改</span><br><span class="line"></span><br><span class="line"><span class="section">#副本: 解决数据高可用的问题</span></span><br><span class="line"><span class="bullet">  1.</span> 副本分片数，可以动态调整</span><br><span class="line"><span class="bullet">  2.</span> 增加副本数，可以在一定程度上提高服务的可用性 (读取的吞吐)</span><br><span class="line"></span><br><span class="line"><span class="section">#分片设定-容量规划</span></span><br><span class="line"><span class="bullet">  1.</span> 分片数设置过小:</span><br><span class="line"><span class="code">    a. 后续无法增加节点实现水平扩展</span></span><br><span class="line"><span class="code">    b. 单个分片的数据量过大，导致数据重新分配耗时</span></span><br><span class="line"><span class="code">  2. 分片设置过大:</span></span><br><span class="line"><span class="code">    a. 影响搜索结果的相关性打分，影响统计结果准确性</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="section"># 查看集群状态</span></span><br><span class="line">  Green: 主分片和副片正常</span><br><span class="line">  Yellow: 主分片正常，副片不正常</span><br><span class="line">  Red: 主分片未能分配</span><br></pre></td></tr></table></figure></li>
<li><p>Elasticsearch vs 关系型数据库 抽象与类比</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">RDBMS</th>
<th align="left">Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Table</td>
<td align="left">Index</td>
</tr>
<tr>
<td align="left">Row</td>
<td align="left">Document</td>
</tr>
<tr>
<td align="left">Column</td>
<td align="left">Field</td>
</tr>
<tr>
<td align="left">Schema</td>
<td align="left">Mapping</td>
</tr>
<tr>
<td align="left">SQL</td>
<td align="left">DSL</td>
</tr>
</tbody></table>
<ul>
<li><p>文档Document CRUD</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>create document. 自动生成_id</span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;user&quot;</span>: <span class="string">&quot;Mike&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;trying out Kibana&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>create document. 指定Id, 如果ID已经存在，报错</span><br><span class="line">PUT users<span class="regexp">/_doc/</span><span class="number">1</span>?op_type=create</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;user&quot;</span>: <span class="string">&quot;Jack&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;trying out Elasticsearch&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>create document. 指定Id, 如果ID已经存在，报错</span><br><span class="line">PUT users<span class="regexp">/_create/</span><span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;user&quot;</span>: <span class="string">&quot;Jack&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;trying out Elasticsearch&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> Get the document by ID</span><br><span class="line">GET users<span class="regexp">/_doc/</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> Index</span><br><span class="line">PUT users<span class="regexp">/_doc/</span><span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;user&quot;</span>: <span class="string">&quot;Mike&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>Update 在原文档上增加字段</span><br><span class="line">POST users<span class="regexp">/_update/</span><span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;trying out Elasticsearch 3&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><ul>
<li>Bulk API<figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line">1. 支持在一次API调用中，对不同的索引进行操作</span><br><span class="line">2. 支持四种类型操作:</span><br><span class="line">  <span class="keyword">Index</span></span><br><span class="line">  <span class="keyword">Create</span></span><br><span class="line">  <span class="keyword">Update</span></span><br><span class="line">  <span class="keyword">Delete</span></span><br><span class="line"><span class="number">3.</span> 操作单条操作失败，不会影响其他操作</span><br><span class="line"><span class="number">4.</span> 返回结果包括每一条操作的执行结果</span><br><span class="line"></span><br><span class="line">//Bulk操作</span><br><span class="line">POST _bulk</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>: &#123;<span class="string">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;field1&quot;</span>: <span class="string">&quot;value1&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;delete&quot;</span>: &#123;<span class="string">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>: &#123;<span class="string">&quot;_index&quot;</span>: <span class="string">&quot;test2&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;field1&quot;</span>: <span class="string">&quot;value3&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;update&quot;</span>: &#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;1&quot;</span>, <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;doc&quot;</span>: &#123;<span class="string">&quot;field2&quot;</span>: <span class="string">&quot;value2&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>mget</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//mg</span>et -- 批量读取</span><br><span class="line"><span class="regexp">//</span>可以减少网络连接，提高性能</span><br><span class="line">GET _mget</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;docs&quot;</span>: [</span><br><span class="line">    &#123;<span class="string">&quot;_index&quot;</span>: <span class="string">&quot;users&quot;</span>, <span class="string">&quot;_id&quot;</span>:<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_index&quot;</span>: <span class="string">&quot;comment&quot;</span>, <span class="string">&quot;_id&quot;</span>:<span class="number">1</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Elasticsearch-原理"><a href="#Elasticsearch-原理" class="headerlink" title="Elasticsearch 原理"></a>Elasticsearch 原理</h2><ul>
<li>图书和搜索引擎类比</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Type</th>
<th align="left">正排索引</th>
<th align="left">倒排索引</th>
</tr>
</thead>
<tbody><tr>
<td align="left">图书</td>
<td align="left">目录页</td>
<td align="left">索引页</td>
</tr>
<tr>
<td align="left">搜索引擎</td>
<td align="left">文档ID-&gt;文档内容和单词的关联</td>
<td align="left">单词到文档ID的关系</td>
</tr>
</tbody></table>
<ul>
<li><p>Elasticsearch 倒排索引</p>
<blockquote>
<p>Elasticsearch的JSON文档中每个字段，都有自己的倒排索引</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 单词词典(Term Dictionary)</span></span><br><span class="line"><span class="quote">&gt; 记录所有文档的单词，记录单词到倒排列表的关联关系</span></span><br><span class="line"><span class="quote">&gt; 通过B+树或哈希链表实现，满足高性能的插入与查询</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 倒排列表(Posting List)</span></span><br><span class="line"><span class="quote">&gt; 记录单词对应的文档结合</span></span><br><span class="line"><span class="bullet">  -</span> 倒排索引项(Posting)</span><br><span class="line"><span class="bullet">    -</span> 文档ID</span><br><span class="line"><span class="bullet">    -</span> 词频TF - 单词在文档出现的次数</span><br><span class="line"><span class="bullet">    -</span> 位置Position - 单词在文档中分词的位置，用于语句搜索 phrase query</span><br><span class="line"><span class="bullet">    -</span> 偏移Offset - 记录单词的开始结束位置，实现高量显示</span><br></pre></td></tr></table></figure></li>
<li><p>Elasticsearch 分词器</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Analysis</span></span><br><span class="line">  - Analysis: 文本分析是把全文本转换一系列单词 term/token的过程</span><br><span class="line">  - Analysis是通过Analyzer实现</span><br><span class="line"></span><br><span class="line"><span class="comment"># Analyzer:</span></span><br><span class="line">  - Character Filters: 针对原始文本处理</span><br><span class="line">    - HTML strip - 去除html标签</span><br><span class="line">    - Mapping - 字符串替换</span><br><span class="line">    - Pattern repalce - 正则匹配替换</span><br><span class="line"></span><br><span class="line">  - Tokenizer: 将原始的文本按照一定的规则，切分为词 term or token</span><br><span class="line">    - whitespace</span><br><span class="line">    - standard</span><br><span class="line">    - uax_url_email</span><br><span class="line">    - pattern</span><br><span class="line">    - keyward</span><br><span class="line">    - path hierarchy</span><br><span class="line"></span><br><span class="line">  - Token Filter: 将切分的单词进行加工，小写，删除stopwords,增加同义词</span><br><span class="line">    - Lowercase</span><br><span class="line">    - stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># Elasticsearch内置分词器</span></span><br><span class="line"><span class="regexp">//</span>默认分词器 standard</span><br><span class="line"><span class="regexp">//</span> 按词切分，小写处理</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>Simple Analyzer</span><br><span class="line"><span class="regexp">//</span> 按照非字母切分，非字母被去除</span><br><span class="line"><span class="regexp">//</span> 小写处理</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> Whitespace Analyzer</span><br><span class="line"><span class="regexp">//</span> 按照空格切分</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;whitespace&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> Stop Analyzer</span><br><span class="line"><span class="regexp">//</span> stop filter: 去除the, a, is 修饰性词</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;stop&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>Keyward Analyzer</span><br><span class="line"><span class="regexp">//</span>不分词，直接将输入当输出</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>正则表达式进行分词</span><br><span class="line"><span class="regexp">//</span>默认非字符的符号进行分隔</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;pattern&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>english</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> analysis_icu</span><br><span class="line"><span class="regexp">//</span> elasticsearch-plugin install analysis_icu</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;icu_analyzer&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;他说的确实在理&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Search API</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># URI Search - 通过URI query实现搜索</span></span><br><span class="line">  q: 指定查询语句, 使用Query String Syntax</span><br><span class="line">  df: 默认字段, 不指定会对所有字段进行查询</span><br><span class="line">  Sort: 排序/from 和 size 用于分页</span><br><span class="line">  Profile: 查看查询是如何被执行</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>. 指定字段 vs. 泛查询</span><br><span class="line">  <span class="regexp">//</span>带profile 普通查询</span><br><span class="line">  GET <span class="regexp">/movies/</span>_search?q=<span class="number">2012</span>&amp;df=title</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="regexp">//</span>带profile 泛查询</span><br><span class="line">  GET <span class="regexp">/movies/</span>_search?q=<span class="number">2012</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="regexp">//</span>带profile 指定字段</span><br><span class="line">  GET <span class="regexp">/movies/</span>_search?q=title:<span class="number">2012</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>. Term vs. Phrase</span><br><span class="line">    <span class="comment"># Term: Beautiful Mind 等效于 Beautiful OR Mind</span></span><br><span class="line">    <span class="comment"># Phrase: &quot;Beautifuk Mind&quot; 等效于 Beautiful And Mind, 前后顺序保持一致</span></span><br><span class="line">  <span class="regexp">//</span>使用引号 查询</span><br><span class="line">  GET <span class="regexp">/movies/</span>_search?q=title:<span class="string">&quot;Beautiful Mind&quot;</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="regexp">//</span>使用引号 Mind 泛 查询</span><br><span class="line">  GET <span class="regexp">/movies/</span>_search?q=title:Beautiful Mind</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="regexp">//</span>使用引号 Bool 泛 查询</span><br><span class="line">  GET <span class="regexp">/movies/</span>_search?q=title:(Beautiful Mind)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="number">3</span>. 布尔操作</span><br><span class="line">    AND <span class="regexp">/ OR /</span> NOT 或者 &amp;&amp; <span class="regexp">/ || /</span> !</span><br><span class="line">    title:(matrix NOT reloaded)</span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>. 分组</span><br><span class="line">    + 表示 must</span><br><span class="line">    - 表示 must_not</span><br><span class="line">    title:(+matrix -reloaded)</span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>. 范围查询</span><br><span class="line">    []闭区间 &#123;&#125;开区间</span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>. 算数符号</span><br><span class="line">    year:&gt;<span class="number">2010</span></span><br><span class="line"></span><br><span class="line">  <span class="number">7</span>. 通配符查询(通配符查询效率低，占用内存大，不建议使用)</span><br><span class="line">    ? 代表<span class="number">1</span>个字符</span><br><span class="line">    * 代表<span class="number">0</span>或多个字符</span><br><span class="line"></span><br><span class="line">  <span class="number">8</span>. 正则表达式</span><br><span class="line">    title:[bt]oy</span><br><span class="line"></span><br><span class="line">  <span class="number">9</span>. 模糊匹配与近似查询</span><br><span class="line">    title:befutifl~<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Request Body Search</span></span><br><span class="line">  <span class="number">1</span>. 分页:</span><br><span class="line">    from, size</span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>. sort:</span><br><span class="line"></span><br><span class="line">  <span class="number">3</span>. _source filtering: 如果_source没有存储，就只返回匹配的文档的元数据</span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>. 脚本字段:</span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>. 查询表达式 - Match</span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>. Match</span><br><span class="line"></span><br><span class="line"><span class="comment"># Page Rank算法</span></span><br><span class="line">  <span class="number">1</span>. 衡量相关性 Information Retrieval</span><br><span class="line">    a. Precision (查准率) - 尽可能返回较少的无关文档</span><br><span class="line">    b. Recall(查全率)     - 尽量返回较多的相关文档</span><br><span class="line">    c. Ranking            - 是否能够按照相关度进行排序</span><br></pre></td></tr></table></figure></li>
<li><p>Mapping</p>
<blockquote>
<p>类似数据库中的scehma定义</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 定义索引中的字段名称</span><br><span class="line"><span class="number">2.</span> 定义字段的数据类型</span><br><span class="line"><span class="keyword">Mapping</span> 把<span class="type">JSON</span>文档映射成Lucene所需要的扁平格式</span><br><span class="line">一个<span class="keyword">Mapping</span>属于一个索引的<span class="keyword">type</span></span><br><span class="line"></span><br><span class="line"># 四种不同级别的<span class="keyword">Index</span> <span class="keyword">Options</span> - 控制倒排索引记录的内容</span><br><span class="line">  docs - 记录doc id</span><br><span class="line">  freqs - 记录 doc id 和 term frequencies</span><br><span class="line">  positions - 记录 doc id/term frequencies/term position</span><br><span class="line">  offsets - 记录 doc id/term frequencies/term position/<span class="type">character</span> offsets</span><br></pre></td></tr></table></figure></li>
<li><p>数据类型<br>JSON -&gt; Elasticsearch类型</p>
<table>
<thead>
<tr>
<th align="left">JSON类型</th>
<th align="left">Elasticsearch 类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">字符串</td>
<td align="left">匹配日期格式 -&gt; Date</td>
</tr>
<tr>
<td align="left">布尔值</td>
<td align="left">boolean</td>
</tr>
<tr>
<td align="left">浮点数</td>
<td align="left">float</td>
</tr>
<tr>
<td align="left">整数</td>
<td align="left">long</td>
</tr>
<tr>
<td align="left">对象</td>
<td align="left">Object</td>
</tr>
<tr>
<td align="left">数组</td>
<td align="left">由第一个非空数值的类型所决定</td>
</tr>
<tr>
<td align="left">空值</td>
<td align="left">忽略</td>
</tr>
</tbody></table>
</li>
</ul>
  <figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 简单类型:</span></span><br><span class="line"><span class="bullet">  1.</span> Text/Keyword</span><br><span class="line"><span class="bullet">  2.</span> Date</span><br><span class="line"><span class="bullet">  3.</span> Integer / Floating</span><br><span class="line"><span class="bullet">  4.</span> Boolean</span><br><span class="line"><span class="bullet">  5.</span> IPv4 &amp; IPv6</span><br><span class="line"></span><br><span class="line"><span class="section"># 复杂类型 - 对象和嵌套对象</span></span><br><span class="line">  对象类型/嵌套类型</span><br><span class="line"></span><br><span class="line"><span class="section"># 特殊类型</span></span><br><span class="line">  geo<span class="emphasis">_point &amp; geo_</span>shape / percolator</span><br></pre></td></tr></table></figure>

<h2 id="Elasticsearch-聚合-Aggregation"><a href="#Elasticsearch-聚合-Aggregation" class="headerlink" title="Elasticsearch 聚合 (Aggregation)"></a>Elasticsearch 聚合 (Aggregation)</h2><blockquote>
<p>Elasticsearch 除了搜索以外还提供针对ES数据进行统计分析</p>
</blockquote>
<ul>
<li>集合分类<figure class="highlight q"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> Bucket Aggregation: 满足特定条件的文档集合</span><br><span class="line">  <span class="built_in">group</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> Metric Aggregation: 数学运算，对文档字段统计分析</span><br><span class="line">  <span class="built_in">min</span>/<span class="built_in">max</span>/<span class="built_in">sum</span>/<span class="built_in">avg</span>/cardinality</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> Pipeline Aggregation: 对聚合结果进行二次聚合</span><br><span class="line"><span class="number">4.</span> Matrix Aggregation: 支持多个字段的操作并提供结果矩阵</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Elasticsearch-分布式结构"><a href="#Elasticsearch-分布式结构" class="headerlink" title="Elasticsearch 分布式结构"></a>Elasticsearch 分布式结构</h2><ul>
<li><p>高可用</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 服务可用性 - 允许有节点停止服务</span><br><span class="line"><span class="bullet">2.</span> 数据可用性 - 部分节点丢失，不会丢失数据</span><br></pre></td></tr></table></figure></li>
<li><p>可扩展性</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 请求量提升/数据不断增加(将数据分布到所有节点上)</span><br></pre></td></tr></table></figure></li>
<li><p>Elasticsearch分布式架构</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 不同的集群通过不同的名字区分，-E <span class="keyword">cluster</span>.name=geektime</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="ELK-大数据分析"><a href="#ELK-大数据分析" class="headerlink" title="ELK 大数据分析"></a>ELK 大数据分析</h2>]]></content>
      <tags>
        <tag>搜索引擎</tag>
        <tag>ES</tag>
      </tags>
  </entry>
  <entry>
    <title>golang pkg Tips &amp; Tracks</title>
    <url>/2021/09/03/golang-pkg-Tips-Tracks/</url>
    <content><![CDATA[<h2 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h2><ul>
<li>Goals<blockquote>
<p>The efficientcy of a statically-typed compiled language with the ease of programming of a dynamic language.<br>Safety: type-safe and memory-safe<br>Good support for concurrency and communication.<br>Efficient, latency-free garbage collection.<br>High-speed compilation.</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<ul>
<li><p>Design principles</p>
<blockquote>
<p>Keep concept orthogonal(正交).<br>Keep the grammar regular and simple.<br>Reduce typing. Let the language work things out.<br>Reduce typing. Keep the type system clear.</p>
</blockquote>
</li>
<li><p>The Big Picture</p>
<blockquote>
<p>Fundamentals:</p>
</blockquote>
<ul>
<li>Clean, concise syntax.</li>
<li>Lightweight type system.</li>
<li>No implicit conversions: keep things explicit.</li>
<li>Untyped unsized constants:</li>
<li>Strict separation of interface and implementation.<blockquote>
<p>Run-time:</p>
</blockquote>
</li>
<li>Garbage collection.</li>
<li>Strings, maps, communication channels</li>
<li>Concurrency.<blockquote>
<p>Package model:<br>Explicit dependencies to enable faster builds.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h2 id="Go-Identifiers"><a href="#Go-Identifiers" class="headerlink" title="Go Identifiers"></a>Go Identifiers</h2><h2 id="Go-项目组织"><a href="#Go-项目组织" class="headerlink" title="Go 项目组织"></a>Go 项目组织</h2><ul>
<li><p>Go应用</p>
<blockquote>
<p>编写高质量的Go应用</p>
</blockquote>
<ul>
<li>代码结构<ol>
<li>目录结构</li>
<li>按功能拆分模块</li>
</ol>
<ul>
<li>层次拆分 - MVC</li>
<li>功能拆分 - 实现高内聚低耦合的设计哲学</li>
</ul>
</li>
<li>代码规范 - UBer_Go_Guid</li>
<li>代码质量</li>
<li>编程哲学<ul>
<li>面向接口编程<ol>
<li>代码扩展性更强</li>
<li>解耦上下游的实现</li>
<li>提高代码的可测性</li>
</ol>
</li>
<li>面向“对象”编程<ol>
<li>类、抽象、封装通过结构体来实现</li>
<li>实例通过结构体变量来实现</li>
<li>继承通过组合来实现,一个结构体嵌到另一个结构体，称作组合</li>
<li>多态通过结构来实现<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基类: Bird</span></span><br><span class="line"><span class="keyword">type</span> Bird <span class="keyword">struct</span> &#123;</span><br><span class="line">  Type <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鸟来的类别</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bird *Bird)</span> <span class="title">Class</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> bird.Type</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义鸟类</span></span><br><span class="line"><span class="keyword">type</span> Birds <span class="keyword">interface</span> &#123;</span><br><span class="line">  Name() <span class="keyword">string</span></span><br><span class="line">  Class() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鸟类: 金丝雀</span></span><br><span class="line"><span class="keyword">type</span> Canary <span class="keyword">struct</span> &#123;</span><br><span class="line">  Bird</span><br><span class="line">  name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Canary)</span> <span class="title">Name</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> c.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鸟类: 乌鸦</span></span><br><span class="line"><span class="keyword">type</span> Crow <span class="keyword">struct</span> &#123;</span><br><span class="line">  Bird</span><br><span class="line">  name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Crow)</span> <span class="title">Name</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> c.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCrow</span><span class="params">(name <span class="keyword">string</span>)</span> *<span class="title">Crow</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Crow&#123;</span><br><span class="line">    Bird: Bird&#123;</span><br><span class="line">      Type: <span class="string">&quot;Crow&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    name: name,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCanary</span><span class="params">(name <span class="keyword">string</span>)</span> *<span class="title">Canary</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Canary&#123;</span><br><span class="line">    Bird: Bird&#123;</span><br><span class="line">      Type: <span class="string">&quot;Canary&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    name: name,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BirdInfo</span><span class="params">(birds Birds)</span></span> &#123;</span><br><span class="line">  fmt.Printf(<span class="string">&quot;I&#x27;m %s, I belong to %s bird class!\n&quot;</span>, birds.Name(), birds.Class())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  canary := NewCanary(<span class="string">&quot;CanaryA&quot;</span>)</span><br><span class="line">  crow := NewCrow(<span class="string">&quot;CrowA&quot;</span>)</span><br><span class="line">  BirdInfo(canary)</span><br><span class="line">  BirdInfo(crow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
</li>
<li>软件设计方法<ul>
<li>设计模式 Design Pattern<blockquote>
<p>针对特定场景总结出来的最佳实现方式，特点是解决场景比较具体，实施起来比较简单</p>
</blockquote>
<ul>
<li>创建型模式 Creational Patterns<blockquote>
<p>提供一种在创建对象的同时隐藏创建逻辑的方式，不使用new运算符直接实例化对象</p>
</blockquote>
<ul>
<li>单例模式 Singleton Pattern<blockquote>
<p>单例模式使全局只有一个实例,并且负责创建自己的对象，比较适合全局共享一个实例，且只需要被初始化一次的场景. [数据库实例、全局配置、全局任务池]</p>
</blockquote>
<ul>
<li>饿汉模式: 全局实例在包被加载时创建<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> singleton</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> singleton <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ins *singleton</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">//导入时 初始化静态实例</span></span><br><span class="line">  ins = &amp;singleton&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetInsOr</span><span class="params">()</span> *<span class="title">singleton</span></span> &#123;</span><br><span class="line">  <span class="comment">// 返回创建好的初始化实例</span></span><br><span class="line">  <span class="keyword">return</span> ins</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>懒汉模式: 全局实例在包被使用时创建<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> singleton</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="keyword">type</span> singleton <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ins *singleton</span><br><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetInsOr</span><span class="params">()</span> *<span class="title">singleton2</span></span> &#123;</span><br><span class="line">  <span class="comment">// Do is intended for initialization that must be run exactly once</span></span><br><span class="line">	once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ins2 = &amp;singleton&#123;<span class="string">&quot;Chyi&quot;</span>&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> ins</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>简单工厂模式<blockquote>
<p>传入参数并返回一个结构体的实例</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> factory</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span> <span class="title">Greet</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Hi! My name is %s&quot;</span>, p.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单工厂模式确保我们创建的实例具有需要的参数，进而保证实例按照预期执行</span></span><br><span class="line"><span class="comment">// 返回非指针的实例，可以确保实例属性避免属性被意外/任意修改</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, age <span class="keyword">int</span>)</span> <span class="title">Person</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Person&#123;</span><br><span class="line">		Name: name,</span><br><span class="line">		Age:  age,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>抽象工厂模式<blockquote>
<p>与简单工厂模式区别是返回的是接口而不是结构体, 在不公开内部实现的情况下，让调用者使用</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> abstract_factory</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">interface</span> &#123;</span><br><span class="line">	Greet()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span> &#123;</span><br><span class="line">	name <span class="keyword">string</span></span><br><span class="line">	age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p person)</span> <span class="title">Greet</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Hi!, my name is %s&quot;</span>, p.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here, NewPerson returns an interface, and not the person struct iteself</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, age <span class="keyword">int</span>)</span> <span class="title">Person</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> person&#123;</span><br><span class="line">		name: name,</span><br><span class="line">		age:  age,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>工厂方法模式<blockquote>
<p>依赖工厂接口，通过实现工厂接口来创建多种工厂，将对象创建从一个对象负责所有集体类的实例化，编程由一群子类负责对具体类的实例化,从而将过程解耦</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> method_factory</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	name <span class="keyword">string</span></span><br><span class="line">	age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPersonFactory</span><span class="params">(age <span class="keyword">int</span>)</span> <span class="title">func</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">Person</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">Person</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Person&#123;</span><br><span class="line">			name: name,</span><br><span class="line">			age:  age,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>建造者模式</li>
<li>原型模式</li>
</ul>
</li>
<li>结构型模式 Structural Patterns<ul>
<li>访问者模式</li>
<li>模版模式 Template Pattern<blockquote>
<p>将一个类中能够公共使用的方法放置在抽象类中实现，将不能公共使用的方法作为抽象方法，强制子类实现，这样就做到一个类作为模版，让开发者填充需要填充的地方</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cooker <span class="keyword">interface</span> &#123;</span><br><span class="line">	fire()</span><br><span class="line">	cooke()</span><br><span class="line">	outfire()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类似一个抽象类</span></span><br><span class="line"><span class="keyword">type</span> CookMenu <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(CookMenu)</span> <span class="title">fire</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;开火&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 做菜 交给具体的子类实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(CookMenu)</span> <span class="title">cooke</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(CookMenu)</span> <span class="title">outfire</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;关火&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装具体步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doCook</span><span class="params">(cook Cooker)</span></span> &#123;</span><br><span class="line">	cook.fire()</span><br><span class="line">	cook.cooke()</span><br><span class="line">	cook.outfire()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> XiHongShi <span class="keyword">struct</span> &#123;</span><br><span class="line">	CookMenu</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*XiHongShi)</span> <span class="title">cooke</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;做西红柿&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ChaoJiDan <span class="keyword">struct</span> &#123;</span><br><span class="line">	CookMenu</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ChaoJiDan)</span> <span class="title">cooke</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;做炒鸡蛋&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTemplate</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"> <span class="comment">// 做西红柿</span></span><br><span class="line"> xihongshi := &amp;XiHongShi&#123;&#125;</span><br><span class="line">  doCook(xihongshi)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 做炒鸡蛋</span></span><br><span class="line">  chaojidan := &amp;ChaoJiDan&#123;&#125;</span><br><span class="line">  doCook(chaojidan)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>策略模式 Strategy Pattern<blockquote>
<p>采用不同策略的场景</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> strategy</span><br><span class="line"></span><br><span class="line"><span class="comment">// 策略模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个策略类</span></span><br><span class="line"><span class="keyword">type</span> IStrategy <span class="keyword">interface</span> &#123;</span><br><span class="line">	do(<span class="keyword">int</span>, <span class="keyword">int</span>) <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 策略实现: 加</span></span><br><span class="line"><span class="keyword">type</span> add <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*add)</span> <span class="title">do</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 策略实现: 减</span></span><br><span class="line"><span class="keyword">type</span> reduce <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*reduce)</span> <span class="title">do</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a - b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体策略的执行者</span></span><br><span class="line"><span class="keyword">type</span> Operator <span class="keyword">struct</span> &#123;</span><br><span class="line">	strategy IStrategy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置策略</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(operator *Operator)</span> <span class="title">setStrategy</span><span class="params">(strategy IStrategy)</span></span> &#123;</span><br><span class="line">	operator.strategy = strategy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用策略中的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(operator *Operator)</span> <span class="title">calculate</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> operator.strategy.do(a, b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestStrategy</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	operator := Operator&#123;&#125;</span><br><span class="line"></span><br><span class="line">	operator.setStrategy(&amp;add&#123;&#125;)</span><br><span class="line">	result := operator.calculate(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;add:&quot;</span>, result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>状态模式</li>
<li>观察者模式</li>
<li>备忘录模式</li>
<li>中介者模式</li>
<li>迭代器模式</li>
<li>解释器模式</li>
<li>命令模式</li>
<li>责任链模式</li>
</ul>
</li>
<li>行为型模式 Behavioral Patterns<blockquote>
<p>关注对象之间的通信</p>
</blockquote>
<ul>
<li>适配器模式</li>
<li>桥接模式</li>
<li>组合模式</li>
<li>装饰模式</li>
<li>外观模式</li>
<li>享元模式</li>
<li>代理模式 Proxy Pattern<blockquote>
<p>可以为另一个对象提供一个替身或者占位符，以控制对这个对象的访问</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">package proxy</span><br><span class="line"></span><br><span class="line">import <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Seller interface &#123;</span><br><span class="line">	sell(name <span class="built_in">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 火车站</span></span><br><span class="line"><span class="keyword">type</span> Station <span class="keyword">struct</span> &#123;</span><br><span class="line">	stock <span class="built_in">int</span> <span class="comment">// 库存</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (station *Station) sell(name <span class="built_in">string</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> station.stock &gt; <span class="number">0</span> &#123;</span><br><span class="line">		station.stock--</span><br><span class="line">		fmt.<span class="constructor">Printf(<span class="string">&quot;代理点中: %s买了一张票，剩余: %d \n&quot;</span>, <span class="params">name</span>, <span class="params">station</span>.<span class="params">stock</span>)</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.<span class="constructor">Println(<span class="string">&quot;票已售空&quot;</span>)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 火车代理点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StationProxy <span class="keyword">struct</span> &#123;</span><br><span class="line">	station *Station <span class="comment">// 持有火车站对象</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (proxy *StationProxy) sell(name <span class="built_in">string</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> proxy.station.stock &gt; <span class="number">0</span> &#123;</span><br><span class="line">		proxy.station.stock--</span><br><span class="line">		fmt.<span class="constructor">Printf(<span class="string">&quot;代理点中: %s买了一张票,剩余: %d \n&quot;</span>, <span class="params">name</span>, <span class="params">proxy</span>.<span class="params">station</span>.<span class="params">stock</span>)</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.<span class="constructor">Println(<span class="string">&quot;票已售空&quot;</span>)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>选项模式 Options Pattern<blockquote>
<p>结构体参数很多，期望创建一个携带默认值的结构体变量，并选择性修改其中一些参数的值</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> options</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Connection <span class="keyword">struct</span> &#123;</span><br><span class="line">	addr    <span class="keyword">string</span></span><br><span class="line">	cache   <span class="keyword">bool</span></span><br><span class="line">	timeout time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	defaultTimeout = <span class="number">10</span></span><br><span class="line">	defaultCaching = <span class="literal">false</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> options <span class="keyword">struct</span> &#123;</span><br><span class="line">	timeout time.Duration</span><br><span class="line">	caching <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Option override behavior of Connect</span></span><br><span class="line"><span class="keyword">type</span> Option <span class="keyword">interface</span> &#123;</span><br><span class="line">	apply(*options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> optionFunc <span class="function"><span class="keyword">func</span><span class="params">(*options)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f optionFunc)</span> <span class="title">apply</span><span class="params">(o *options)</span></span> &#123;</span><br><span class="line">	f(o)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(t time.Duration)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> optionFunc(<span class="function"><span class="keyword">func</span><span class="params">(o *options)</span></span> &#123;</span><br><span class="line">		o.timeout = t</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCaching</span><span class="params">(cache <span class="keyword">bool</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> optionFunc(<span class="function"><span class="keyword">func</span><span class="params">(o *options)</span></span> &#123;</span><br><span class="line">		o.caching = cache</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewConnect create a connection.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewConnect</span><span class="params">(addr <span class="keyword">string</span>, opts ...Option)</span> <span class="params">(*Connection, error)</span></span> &#123;</span><br><span class="line">	options := options&#123;</span><br><span class="line">		timeout: defaultTimeout,</span><br><span class="line">		caching: defaultCaching,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		o.apply(&amp;options)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Connection&#123;</span><br><span class="line">		addr:    addr,</span><br><span class="line">		cache:   options.caching,</span><br><span class="line">		timeout: options.timeout,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestOptions</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"> connect, err := NewConnect(<span class="string">&quot;127.0.0.1&quot;</span>, WithCaching(<span class="literal">true</span>), WithTimeout(<span class="number">5</span>))</span><br><span class="line"> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatal(err)</span><br><span class="line"> &#125;</span><br><span class="line"> fmt.Println(connect)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>SOLID原则<blockquote>
<p>侧重设计原则,设计代码指导方针</p>
</blockquote>
<ul>
<li>SRP: 单一功能原则, 一个类或者模块只负责完成一个指责</li>
<li>OCP: 开闭原则,软件实体应该对扩展开放，对修改关闭</li>
<li>LSP: 里氏替换原则, 如果S是T的子类型，则类型T的对象可以替换为类型S的对象，而不会破坏程序</li>
<li>DIP: 依赖倒置原则，依赖于抽象而不是一个实例，其本质是要面向接口编程，不要面向实现编程</li>
<li>ISP: 接口分离原则，客户端程序不应该依赖它不需要的方法</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>项目管理</p>
</li>
<li><p>项目文档</p>
</li>
</ul>
<h2 id="Go-工具集"><a href="#Go-工具集" class="headerlink" title="Go 工具集"></a>Go 工具集</h2><table>
<thead>
<tr>
<th align="left">工具名</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left">golines</td>
<td align="left">格式化长行</td>
</tr>
<tr>
<td align="left">goimports</td>
<td align="left">导入包管理，自动增删依赖包，按照字母排序</td>
</tr>
<tr>
<td align="left">mockgen</td>
<td align="left">接口Mock工具</td>
</tr>
<tr>
<td align="left">gotests</td>
<td align="left">根据Go代码自动生成单元测试模版</td>
</tr>
<tr>
<td align="left">go-junit-report</td>
<td align="left">go test输出转换为junit xml</td>
</tr>
<tr>
<td align="left">richgo</td>
<td align="left">用文本装饰丰富go test的输出</td>
</tr>
<tr>
<td align="left">golangci-lint</td>
<td align="left">静态代码检查工具</td>
</tr>
<tr>
<td align="left">rts</td>
<td align="left">response to struct 根据服务器的响应生成Go结构体</td>
</tr>
<tr>
<td align="left">protoc-go-inject-tag</td>
<td align="left">通过protoc工具生成pb.go文件中注入自定义标签</td>
</tr>
<tr>
<td align="left">db2struct</td>
<td align="left">将数据库表一键转换为go struct,支持自定义Tag和多种命名格式配置</td>
</tr>
<tr>
<td align="left">gsemver</td>
<td align="left">根据git commit规范自动生成语义化版本</td>
</tr>
<tr>
<td align="left">git-chglog</td>
<td align="left">根据git commit 自动生成CHANGELOG</td>
</tr>
<tr>
<td align="left">github-release</td>
<td align="left">命令行工具，创建、修改github release</td>
</tr>
<tr>
<td align="left">go-mod-outdated</td>
<td align="left">检查依赖包是否有更新</td>
</tr>
<tr>
<td align="left">depth</td>
<td align="left">通过分析导入的库，将某个包的依赖关系用树状结构显示出来</td>
</tr>
<tr>
<td align="left">go-callvis</td>
<td align="left">可视化显示Go调用关系</td>
</tr>
<tr>
<td align="left">cfssl</td>
<td align="left">CouldFlare的PKI的TLS工具集</td>
</tr>
<tr>
<td align="left">addllicense</td>
<td align="left">通过扫描指定文件的文件，确保源码文件有版权头</td>
</tr>
<tr>
<td align="left">gothanks</td>
<td align="left">自动在github上Star项目的依赖包所在的github repository</td>
</tr>
<tr>
<td align="left">swagger</td>
<td align="left">自动生成Go Swagger文档</td>
</tr>
</tbody></table>
<h2 id="Go-Guide"><a href="#Go-Guide" class="headerlink" title="Go Guide"></a>Go Guide</h2><h2 id="Golang-Frequently-Asked-Questions-FAQ"><a href="#Golang-Frequently-Asked-Questions-FAQ" class="headerlink" title="Golang Frequently Asked Questions (FAQ)"></a>Golang Frequently Asked Questions (FAQ)</h2><ul>
<li><p>Map access is unsafe only when updates are occurring.</p>
</li>
<li><p>How can I gurantee my type satisfies an interface?</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> I <span class="keyword">interface</span> &#123;</span><br><span class="line">    Say(<span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> T <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *T)</span> <span class="title">Say</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于触发编译期的接口的合理性检查机制</span></span><br><span class="line"><span class="comment">// 如果T没有实现I，会在编译期报错</span></span><br><span class="line"><span class="comment">// 赋值右边是断言类型的零值，对于指针类型、切片、map是nil，对于结构体类型是空结构</span></span><br><span class="line"><span class="comment">// Ask the compiler to check that the type T implements the interface I by</span></span><br><span class="line"><span class="keyword">var</span> _ I = (*T)(<span class="literal">nil</span>) <span class="comment">// Verify that *T implements I.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    t := T&#123;&#125;</span><br><span class="line">    t.Say(<span class="string">&quot;Say Hello&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Should I define methods on values or pointers?</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">func (s *MyStruct) pointerMethod() &#123;&#125;   // <span class="keyword">method</span> <span class="keyword">on</span> pointer</span><br><span class="line">func (s MyStruct) valueMethod() &#123;&#125;      // <span class="keyword">method</span> <span class="keyword">on</span> <span class="keyword">value</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">When</span> defining a <span class="keyword">method</span> <span class="keyword">on</span> a <span class="keyword">type</span>, the receiver behaves exactly <span class="keyword">as</span> <span class="keyword">if</span> it were an argument <span class="keyword">to</span> the <span class="keyword">method</span>. Whether <span class="keyword">to</span> define the receiver <span class="keyword">as</span> a <span class="keyword">value</span> <span class="keyword">or</span> <span class="keyword">as</span> a pointer <span class="keyword">is</span> the same question, <span class="keyword">then</span>, <span class="keyword">as</span> whether a <span class="keyword">function</span> argument should be a <span class="keyword">value</span> <span class="keyword">or</span> poiner.</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> First, <span class="keyword">and</span> most important, does the <span class="keyword">method</span> need <span class="keyword">to</span> modify the receiver?</span><br><span class="line"><span class="number">2.</span> Second <span class="keyword">is</span> the consideration <span class="keyword">of</span> efficiency. <span class="keyword">If</span> the receiver <span class="keyword">is</span> <span class="keyword">large</span>, a big struct <span class="keyword">for</span> instance, it will be much cheaper <span class="keyword">to</span> use a pointer receiver.</span><br></pre></td></tr></table></figure></li>
<li><p>What operations are atomic? What about mutexes?</p>
<blockquote>
<p>Do not communicate by sharing memory. Instead, share memory by communicating.</p>
</blockquote>
</li>
<li><p>How can I control the number of CPUs?</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">The runtime can allocate more threads than the value of GOMAXPROCS to service multiple outstanding I/O requests. GOMAXPROCS only affects how many goroutines can actually<span class="built_in"> execute </span>at once; arbitrarily more may be blocked in<span class="keyword"> system</span> calls.</span><br></pre></td></tr></table></figure></li>
<li><p>Who do I write a unit test?</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> Create a <span class="keyword">new</span> file ending <span class="keyword">in</span> <span class="module-access"><span class="module"><span class="identifier">_test</span>.</span></span>go <span class="keyword">in</span> the same directory <span class="keyword">as</span> your package sources. Inside that file, import <span class="string">&quot;testing&quot;</span> <span class="keyword">and</span> write functions <span class="keyword">of</span> the form</span><br><span class="line"></span><br><span class="line">func <span class="constructor">TestFoo(<span class="params">t</span> <span class="operator">*</span><span class="params">testing</span>.T)</span> &#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>What compiler technology is used to build the compilers?</p>
<blockquote>
<p>The default compiler, gc, was originally written in C, but since the Go 1.5 release the compiler has been a Go program.</p>
</blockquote>
</li>
<li><p>Why do garbage collection? Won’t it be too expensive?</p>
<figure class="highlight mercury"><table><tr><td class="code"><pre><span class="line">The current <span class="keyword">implementation</span> <span class="keyword">is</span> a mark-and-sweep collector.</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="User-Go语言编码规范"><a href="#User-Go语言编码规范" class="headerlink" title="User Go语言编码规范"></a>User Go语言编码规范</h2><ul>
<li><p>指导原则:</p>
<ul>
<li><p>指向interface的指针</p>
<ol>
<li>使用指针传递才能通过接口方法修改基础数据</li>
</ol>
</li>
<li><p>Interface 合理性验证</p>
<ol>
<li>var _ http.Handler = (*Handler)(nil)  // 触发编译期的接口合理性检查机制，如果Handler没有实现Http.Handler 会报错</li>
<li>赋值右边是断言类型的零值，指针类型、切片和映射都是nil,对于结构类型是空结构</li>
</ol>
</li>
<li><p>接收器receiver与接口</p>
<ol>
<li>使用值接收器的方法即可以通过值调用，也可以通过指针调用</li>
<li>带指针接收器的方法只能通过指针调用<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 一个类型可以有值接收器方法集和指针接收器方法集</span><br><span class="line">  一个值接收器方法集是指针接收器方法集的子集</span><br><span class="line"><span class="bullet">2.</span> 值对象只可以使用值接收器方法集,指针对象可以使用值接收器方法集+指针接收器方法集</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>零值 Mutex</p>
<blockquote>
<p>零值sync.Mutex, sync.RWMutx是有效的，指向Mutex的指针基本是不必要的</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 使用结构体指针，mutex应该作为结构体的非指针字段，即使该结构体不被导出，不要将mutex嵌入到结构体中</span><br></pre></td></tr></table></figure></li>
<li><p>边界处拷贝Slices和Maps</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 接收Slices 和 Maps: 当<span class="built_in">map</span>或<span class="built_in">slice</span>作为函数参数传入时，用户可以对其进行修改</span><br><span class="line"><span class="number">2.</span> 注意用户对报漏内部状态的<span class="built_in">map</span>或<span class="built_in">slice</span>的修改</span><br></pre></td></tr></table></figure></li>
<li><p>使用defer释放资源</p>
</li>
<li><p>Channel的size要么是1，要么是无缓冲的</p>
</li>
<li><p>枚举从1开始:</p>
</li>
<li><p>使用time处理时间</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="built_in">time</span>.<span class="keyword">Time</span>表示瞬时时间</span><br><span class="line"><span class="number">2.</span> <span class="built_in">time</span>.Duration表示时间段</span><br><span class="line"><span class="number">3.</span> <span class="keyword">Time</span>.<span class="keyword">Add</span>: 某个时刻比前一个时刻晚</span><br><span class="line"><span class="number">4.</span> <span class="keyword">Time</span>.AddDate: 下一个日历日</span><br></pre></td></tr></table></figure></li>
<li><p>错误类型</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> errors.New: 对于简单静态字符串的错误</span><br><span class="line"><span class="bullet">2.</span> fmt.Errorf: 对于格式化的错误字符串</span><br><span class="line"><span class="bullet">3.</span> 实现Error()方法的自定义类型</span><br><span class="line"><span class="bullet">4.</span> errors.Wrap: Wrapped errors</span><br></pre></td></tr></table></figure></li>
<li><p>错误包装 Error Wrapping</p>
</li>
<li><p>处理类型断言失败</p>
</li>
<li><p>追加时优先执行切片容量</p>
</li>
</ul>
</li>
<li><p>性能</p>
<ul>
<li>将原语转换为字符串或从字符串转换时，strconv速度比fmt快</li>
<li>指定容器容量,以便为容器预先分配内存，将在添加元素时最小化后续分配 – 容量提示</li>
<li>指定切片容量,编译器为其提供make()的slice的容量分配足够的内存</li>
</ul>
</li>
<li><p>规范</p>
<ul>
<li><p>包名</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 全部小写，没有大写或下划线</span><br><span class="line"><span class="bullet">2.</span> 不使用复数</span><br><span class="line"><span class="bullet">3.</span> 不要用 common, util, shared, lib</span><br></pre></td></tr></table></figure></li>
<li><p>导入别名</p>
<blockquote>
<p>除非导入之间有直接冲突，否则避免导入别名</p>
</blockquote>
</li>
<li><p>减少嵌套</p>
<blockquote>
<p>代码通过尽可能先处理错误情况/特殊情况今早返回或继续循环减少嵌套，减少嵌套多个级别的代码的代码</p>
</blockquote>
</li>
<li><p>顶层变量声明</p>
</li>
</ul>
</li>
</ul>
<h2 id="Golang-Tips-amp-Tracks"><a href="#Golang-Tips-amp-Tracks" class="headerlink" title="Golang Tips &amp; Tracks"></a>Golang Tips &amp; Tracks</h2><ul>
<li><strong>负载均衡算法对比</strong><blockquote>
<p>负载均衡最重要的就是均衡</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;math/rand&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  rand.Seed(time.Now().UnixNano())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">normal_shuffle</span><span class="params">(slice []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(slice); i++ &#123;</span><br><span class="line">    a := rand.Intn(<span class="built_in">len</span>(slice))</span><br><span class="line">    b := rand.Intn(<span class="built_in">len</span>(slice))</span><br><span class="line">    slice[a], slice[b] = slice[b], slice[a]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">shuffle</span><span class="params">(indexes []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="built_in">len</span>(indexes); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">    lastIdx := i - <span class="number">1</span></span><br><span class="line">    idx := rand.Intn(i)</span><br><span class="line">    indexes[lastIdx], indexes[idx] = indexes[idx], indexes[lastIdx]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> cnt1 = <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">var</span> sl = []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">    normal_shuffle(sl)</span><br><span class="line">    cnt1[sl[<span class="number">0</span>]]++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> cnt2 = <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">var</span> sl = []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">    shuffle(sl)</span><br><span class="line">    cnt2[sl[<span class="number">0</span>]]++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">&quot;normal shuffle: &quot;</span>, cnt1)</span><br><span class="line">  fmt.Println(<span class="string">&quot;fisher yates  : &quot;</span>, cnt2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chyi/<span class="keyword">go</span>-awesome-prj/shuffle via 🐹 v1<span class="number">.17</span> took <span class="number">38</span>s</span><br><span class="line">➜ <span class="keyword">go</span> run main.<span class="keyword">go</span></span><br><span class="line">normal shuffle:  <span class="keyword">map</span>[<span class="number">0</span>:<span class="number">224558</span> <span class="number">1</span>:<span class="number">128887</span> <span class="number">2</span>:<span class="number">129201</span> <span class="number">3</span>:<span class="number">129493</span> <span class="number">4</span>:<span class="number">129487</span> <span class="number">5</span>:<span class="number">129202</span> <span class="number">6</span>:<span class="number">129172</span>]</span><br><span class="line">fisher yates  :  <span class="keyword">map</span>[<span class="number">0</span>:<span class="number">142974</span> <span class="number">1</span>:<span class="number">143116</span> <span class="number">2</span>:<span class="number">142768</span> <span class="number">3</span>:<span class="number">142660</span> <span class="number">4</span>:<span class="number">142930</span> <span class="number">5</span>:<span class="number">142505</span> <span class="number">6</span>:<span class="number">143047</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>CS - Basic Introduction</title>
    <url>/2021/09/06/CS-Time/</url>
    <content><![CDATA[<blockquote>
<p>计算机通识介绍</p>
</blockquote>
<span id="more"></span>

<h2 id="Time-时间"><a href="#Time-时间" class="headerlink" title="Time 时间"></a>Time 时间</h2><ul>
<li><p>Universal Time: 世界时</p>
<blockquote>
<p>依靠观测天文现象来测量时间，基于地球自转规律</p>
</blockquote>
</li>
<li><p>International Atomic Time: 国际原子时</p>
<blockquote>
<p>以微观时间铯原子的震荡频率为基准，制造原子钟</p>
</blockquote>
</li>
<li><p>Coordinated Universal Time: 协调世界时</p>
<blockquote>
<p>根据世间时和原子时，最终确立新的时间标准，定义成为全球的时间标准</p>
</blockquote>
</li>
<li><p>NTP Network Time Protocol 同步时间</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. NTP如何同步时间</span><br><span class="line">  &gt; 假设网络来回路径对称，并且延迟相同</span><br><span class="line">  网络延时 = (t4 - t1) - (t3 - t2)</span><br><span class="line">  时间差 = t2 - t1 - 网络延迟<span class="regexp">/2 = ((t2-t1) + (t3-t4))/</span><span class="number">2</span></span><br><span class="line"><span class="number">2</span>. 同步时间时，对正在运行的程序有没有影响</span><br><span class="line">  <span class="comment"># 墙上时钟: 世界协调时UTC，校准时间后，可能发生回拨</span></span><br><span class="line">  <span class="comment"># 单调时钟: 计算机自启动以后的纳秒数，不会回拨</span></span><br><span class="line"></span><br><span class="line">NTP校准时间提供<span class="number">2</span>中方式:</span><br><span class="line">  <span class="number">1</span>. ntpdate: 一切已服务器端时间为准，强制修改本机时间</span><br><span class="line">  <span class="number">2</span>. ntpd: 把时间差均摊到每次小的调整上 -- 避免发生倒流</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>计算机</tag>
      </tags>
  </entry>
  <entry>
    <title>Middleware Tips &amp; Tracks</title>
    <url>/2021/09/06/Middleware-Tips-Tracks/</url>
    <content><![CDATA[<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><blockquote>
<p>面对技术选型时，就是一个关于如何取舍的问题，不要不经过思考就觉得那个方案好，那个方案不好。需要根据具体场景分析<br>技术选型不只是技术问题，还与团队、管理、组织结构有关</p>
</blockquote>
<ul>
<li>业务功能角度</li>
<li>技术资源角度<blockquote>
<p>所处的环境、技术资源能否匹配这些技术方案</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<h2 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h2><figure class="highlight haml"><table><tr><td class="code"><pre><span class="line"># 专业消息中间件需要满足:</span><br><span class="line">  1. 消息不丢失</span><br><span class="line">    a. 生产者会不会丢消息?</span><br><span class="line">      -<span class="ruby"> 消息没发送出去: 网络故障或者其他原因导致发布失败，中间件直接返回失败</span></span><br><span class="line"><span class="ruby"></span>      -<span class="ruby"> 不确定是否发送成功: 网络问题导致发布超时，可能数据已发送成功，但是读取响应结果超时</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line">      生产者设置最大重试次数，超过上限依旧失败，需要记录日志报警处理, 生产者会不会丢消息，取决于生产者对于异常情况的处理是否合理, 保证消息不丢，宁可重发，也不能丢弃</span><br><span class="line">    b. 消费者会不会丢消息?</span><br><span class="line">      -<span class="ruby"> 消费者在处理完消息后，必须告知队列中间件，队列中间件才会把标记已处理，否则仍旧把这些数据发给消费者</span></span><br><span class="line"><span class="ruby"></span>    c. 队列中间件会不会丢消息?</span><br><span class="line">      -<span class="ruby"> 生产者在发布消息时，队列中间件通常会写多个节点，以此保证消息的完整性，即便其中一个节点挂，也能保证集群数据不丢失</span></span><br><span class="line"><span class="ruby"></span>  2. 消息可堆积</span><br></pre></td></tr></table></figure>
<ul>
<li>Redis 作为消息中间件<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> Redis本身可能会丢数据</span><br><span class="line"><span class="bullet">2.</span> 面对消息积压，Redis内存资源紧张</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>中间件</tag>
        <tag>Middleware</tag>
      </tags>
  </entry>
  <entry>
    <title>Protocol Buffer Intro</title>
    <url>/2021/09/07/Protocol-Buffer-Intro/</url>
    <content><![CDATA[<h1 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h1><blockquote>
<p>Google 开发的一套对数据结构进行序列化的方法，可用作数据通信协议、数据存储格式。</p>
</blockquote>
<ul>
<li>主要特征<ul>
<li>更快的数据传输速度：protobuf传输将数据序列化为二进制数据，JSON文本传输格式 节省大量IO操作，提高数据传输速度</li>
<li>跨平台多语言：protobuf编译工具protoc基于protobuf定义文件，编译出不同语言的客户端或者服务端</li>
<li>良好的扩展性和兼容性:</li>
<li>基于IDL文件定义服务，通过proto3工具生成指定语言的数据结构,服务端和客户端接口</li>
</ul>
</li>
</ul>
<span id="more"></span>


]]></content>
      <tags>
        <tag>Protocol Buffer</tag>
      </tags>
  </entry>
  <entry>
    <title>API Design</title>
    <url>/2021/09/07/RESTful-API-Design/</url>
    <content><![CDATA[<blockquote>
<p>目前业界常用的API风格</p>
</blockquote>
<ul>
<li>RESTful</li>
<li>RPC</li>
<li>GraphQL</li>
</ul>
<span id="more"></span>

<h2 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h2><blockquote>
<p>Representational State Transfer - 表现层状态转移<br>REST是一种软件架构风格，是一组架构约束条件和原则<br>REST规范把所有内容都视为资源<br>REST是一种规范，而RESTful API则是满足这种规范的API接口</p>
</blockquote>
<ul>
<li><p>HTTP动词与REST风格CRUD对应关系</p>
<table>
<thead>
<tr>
<th align="left">HTTP方法</th>
<th align="left">行为</th>
<th align="left">URI</th>
<th align="left">示例说明</th>
<th align="left">是否安全</th>
<th align="left">是否幂等</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">获取资源列表</td>
<td align="left">/users</td>
<td align="left">获取用户列表</td>
<td align="left">是</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">GET</td>
<td align="left">获取一个具体资源</td>
<td align="left">/users/admin</td>
<td align="left">获取admin用户的详细信息</td>
<td align="left">是</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">POST</td>
<td align="left">创建一个新的资源</td>
<td align="left">/users</td>
<td align="left">创建一个新用户</td>
<td align="left">否</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">PUT</td>
<td align="left">以整体的方式更新一个资源</td>
<td align="left">/users/admin</td>
<td align="left">更新user为admin的用户</td>
<td align="left">否</td>
<td align="left">是</td>
</tr>
<tr>
<td align="left">DELETE</td>
<td align="left">删除服务器上的一个资源</td>
<td align="left">/users/admin</td>
<td align="left">删除user为admin的用户</td>
<td align="left">否</td>
<td align="left">是</td>
</tr>
</tbody></table>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. <span class="keyword">GET</span>,<span class="keyword">PUT</span>,POST操作的资源属性一致</span><br><span class="line"><span class="number">2</span>. 资源进行状态/属性变更，要用<span class="keyword">PUT</span>方法，POST方法用来创建或者批量删除</span><br></pre></td></tr></table></figure>

<ul>
<li><p>核心特点</p>
<ol>
<li>以资源resource为中心, 所有的东西都抽象称资源，所有的行为都应该是在资源上的CRUD操作</li>
<li>资源是有状态的，使用JSON/XML等在HTTP Body里表征资源的状态</li>
<li>客户端通过四个HTTP动词，对服务器资源进行操作, 实现“表现层状态转化”</li>
<li>无状态, 对于服务端的弹性扩容是很重要的</li>
</ol>
</li>
<li><p>RESTful API 设计原则</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="comment"># URI设计</span></span><br><span class="line">  1. 资源名使用名词而不是动词,并且用名词复数表示</span><br><span class="line">  2. URI结尾不包含/</span><br><span class="line">  3. URI中不能出现下划线,必须使用中杠代替</span><br><span class="line">  4. URI路径shying小写，不使用大写</span><br><span class="line">  5. 避免层级过深的URI，超过2层的资源嵌套会很乱,建议其他资源转换为?参数</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全性: 不会改变资源状态</span></span><br><span class="line"><span class="comment"># 幂等性: 执行1次和执行N次，对资源状态改变的效果是等价的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># API版本管理</span></span><br><span class="line">  1. URL中 <span class="string">/v1/users</span></span><br><span class="line">  2. HTTP Header中, Accept: <span class="keyword">version</span>=1.0</span><br><span class="line">  3. Form参数中, <span class="string">/users</span>?<span class="keyword">version</span>=v1</span><br><span class="line"></span><br><span class="line"><span class="comment"># API命名:</span></span><br><span class="line">  1. 驼峰命名法 serverAddress</span><br><span class="line">  2. 蛇形命名法 server_address</span><br><span class="line">  3. 脊柱命名法 server-address -- GitHub API 使用的脊柱命名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统一分页/过滤/排序/搜索功能</span></span><br><span class="line">  1. 分页: <span class="string">/users</span>?offset=0&amp;limit20</span><br><span class="line">  2. 过滤: <span class="string">/users</span>?fields=email,username,address</span><br><span class="line">  3. 排序: <span class="string">/users</span>?sort=age,desc</span><br><span class="line">  4. 搜索:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 域名</span></span><br><span class="line">  1. https:<span class="string">//chyidl.com/api</span> : 这种方式适合API不会有进一步扩展的情况</span><br><span class="line">  2. https:<span class="string">//storage.api.chyidl.com</span> : chyidl.com域名下会新增另一个系统API</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="RPC-API"><a href="#RPC-API" class="headerlink" title="RPC API"></a>RPC API</h2><blockquote>
<p>RPC (Remote Procedure Call) 远程过程调用</p>
</blockquote>
<ul>
<li><p>RPC调用流程</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="built_in">Client</span> 通过本地调用<span class="built_in">Client</span> Stub --</span><br><span class="line"><span class="number">2.</span> <span class="built_in">Client</span> Stub将参数打包称一个消息，然后发送这个消息</span><br><span class="line"><span class="number">3.</span> <span class="built_in">Client</span>所在的OS将消息发送给<span class="built_in">Server</span></span><br><span class="line"><span class="number">4.</span> <span class="built_in">Server</span>端接收到消息后，将消息传递给<span class="built_in">Server</span> Stub</span><br><span class="line"><span class="number">5.</span> <span class="built_in">Server</span> Stub将消息解包，得到参数</span><br><span class="line"><span class="number">6.</span> <span class="built_in">Server</span> Stub调用服务端的子程序，处理完后，最终结果按照相反的步骤返回给<span class="built_in">Client</span></span><br><span class="line"></span><br><span class="line">Stub: 负责调用参数和返回值的流化serialization、参数的打包和解包、以及网络层的通信.</span><br><span class="line"></span><br><span class="line">google gRPC</span><br><span class="line">Facebook Thrift</span><br></pre></td></tr></table></figure></li>
<li><p>RESTful VS gRPC</p>
<table>
<thead>
<tr>
<th align="left">对比项</th>
<th align="left">RESTful</th>
<th align="left">gRPC</th>
</tr>
</thead>
<tbody><tr>
<td align="left">优点</td>
<td align="left">1. REST更规范、更标准、更通用 无论那种语言都支持HTTP协议，可以对接外部很多系统</td>
<td align="left">1. 屏蔽网络细节，调用远程接口像调用本地方法一样，调用简单、方便</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">2. RESTful接口采用JSON作为数据通信格式，JSON格式可读性强</td>
<td align="left">2. gRPC采用Protocol Buffer作为数据传输格式，效率高</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">3. 客户端和服务端松耦合</td>
<td align="left">3.gRPC基于HTTP/2协议标准，性能更高</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">1.扩展性差，随着需求变化</td>
<td align="left">1.Protobuf数据格式可读性差</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">2.性能相对于gRPC偏低</td>
<td align="left">2.gRPC不支持浏览器调用,调试不方便</td>
</tr>
<tr>
<td align="left">使用场景</td>
<td align="left">1. 接口对外，需要接口规范易懂</td>
<td align="left">1.消息密集型、对系统性能和延时要求比较高</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">2.系统能要求不高</td>
<td align="left">2.偏向内部的API</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">3.提供API天生围绕资源、对象、管理展开</td>
<td align="left">3.提供API很难进行资源、对象抽象</td>
</tr>
</tbody></table>
</li>
</ul>
]]></content>
      <tags>
        <tag>API</tag>
      </tags>
  </entry>
  <entry>
    <title>gRPC Intro</title>
    <url>/2021/09/07/gRPC-Intro/</url>
    <content><![CDATA[<h1 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h1><blockquote>
<p>Google开发共性能、开源、跨编程语言的通用RPC框架，基于HTTP2.0协议开发，默认采用Protocol Buffers数据序列化协议</p>
</blockquote>
]]></content>
      <tags>
        <tag>gRPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Gin Crash Course</title>
    <url>/2021/09/08/Gin-Crash-Course/</url>
    <content><![CDATA[<h1 id="Gin-Web-Framework"><a href="#Gin-Web-Framework" class="headerlink" title="Gin Web Framework"></a>Gin Web Framework</h1><blockquote>
<p>Gin是Go语言编写的Web框架，功能完善，使用简单，性能高，Gin核心的路由功能是通过HttpRouter实现，具有很高的路由性能.</p>
</blockquote>
<span id="more"></span>

<h2 id="Web服务核心功能"><a href="#Web服务核心功能" class="headerlink" title="Web服务核心功能"></a>Web服务核心功能</h2><ul>
<li><p>基础功能</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 通信协议: HTTP/HTTPS/gRPC</span></span><br><span class="line"><span class="meta"># 通信格式: JSON/Protobuf</span></span><br><span class="line"><span class="meta"># 路由匹配</span></span><br><span class="line">  &gt; HTTP方法，请求路径匹配到处理这个请求的函数,最终由改函数处理这次请求，并返回结果</span><br><span class="line"><span class="meta"># 路由分组</span></span><br><span class="line"><span class="meta"># 一进程多服务</span></span><br><span class="line"><span class="meta"># 业务处理</span></span><br><span class="line">  <span class="number">1.</span> 参数解析</span><br><span class="line">  <span class="number">2.</span> 参数校验</span><br><span class="line">  <span class="number">3.</span> 逻辑处理</span><br><span class="line">  <span class="number">4.</span> 返回结果</span><br></pre></td></tr></table></figure></li>
<li><p>高级功能</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 中间件</span></span><br><span class="line">  &gt; Gin支持中间件，HTTP请求在转发到实际的处理函数之前，会被一系列加载的中间件进行处理</span><br><span class="line">  gin.Engine.<span class="keyword">Use</span>() 方法加载中间件</span><br></pre></td></tr></table></figure>
<p>gin.Logger(): Logger中间件将日志写到gin.DefaultWriter, gin.DefaultWriter默认为os.Stdout<br>gin.Recovery(): Recovery中间件可以从任何panic恢复，并写入500状态<br>gin.CustomRecovery(handle gin.RecoverFunc):<br>gin.BasicAuth(): HTTP 请求基本认证</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">|<span class="string">中间件   </span>|<span class="string"> 功能                  </span>|</span><br><span class="line">|<span class="string">:--------</span>|<span class="string">:----------------------</span>|</span><br><span class="line">|<span class="string"> gin-jwt </span>|<span class="string"> JWT中间件，实现JWT认证</span>|</span><br><span class="line">|<span class="string"> gin-swagger</span>|<span class="string"> 自动生成Swagger 2.0格式的RESTful API文档</span>|</span><br><span class="line">|<span class="string"> cors</span>|<span class="string"> 实现HTTP请求跨域</span>|</span><br><span class="line">|<span class="string">sessions</span>|<span class="string">会话管理中间件</span>|</span><br><span class="line">|<span class="string">authz</span>|<span class="string"> 基于casbin授权中间件</span>|</span><br><span class="line">|<span class="string">pprof</span>|<span class="string"> gin pprof 中间件</span>|</span><br><span class="line">|<span class="string">go-gin-prometheus</span>|<span class="string">Prometheus metrics exporter</span>|</span><br><span class="line">|<span class="string">gzip</span>|<span class="string"> 支持HTTP请求和响应的gzip压缩</span>|</span><br><span class="line">|<span class="string">gin-limit</span>|<span class="string">HTTP请求并发控制中间件</span>|</span><br><span class="line">|<span class="string">requestid</span>|<span class="string">给每个Request生成uuid,并添加在返回的X-Request-ID Header中</span>|</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 认证</span></span><br></pre></td></tr></table></figure>
<p>认证: Authentication: 用来验证某个用户是否具有访问系统的权限 – 证明你是谁<br>授权: Authorization: 用来验证某个用户是否具有访问某个资源的权限 – 决定你能做什么</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> Basic: 基础认证</span><br></pre></td></tr></table></figure>
<p>   用户名:密码: base64编码后，放到HTTP Authorization Header<br>  github.com/chyidl/noone via 🐹 v1.17<br>  ➜ basic=<code>echo -n &#39;admin:Admin@2021&#39;|base64</code></p>
<p>  github.com/chyidl/noone via 🐹 v1.17<br>  ➜ echo $basic<br>  YWRtaW46QWRtaW5AMjAyMQ==</p>
<p>  github.com/chyidl/noone via 🐹 v1.17<br>  ➜ echo $basic | base64 –decode<br>  admin:Admin@2021%</p>
<p>Basic认证简单,但是不安全, 使用Basic认证+SSL配合使用确保整个认证过程安全</p>
<blockquote>
<p>不要再请求参数中使用明文密码，不要在任何存储中保存明文密码</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">2.</span> Digest</span><br><span class="line"><span class="bullet">3.</span> OAuth</span><br><span class="line"><span class="bullet">4.</span> Bearer</span><br><span class="line"><span class="quote">&gt; Bearer认证称为令牌认证。是一种HTTP身份验证方式. Bearer认证的核心是bearer token.</span></span><br></pre></td></tr></table></figure>
<p>bearer token: 是一个加密字符串，由服务端根据密钥生成, 客户端在请求服务端时，必须在请求头包含Authorization: Bearer <token>. 服务端收到请求头，解析出<token>.校验<token>合法性，Bearer认证配合HTTPS使用，保证认证安全性</p>
<p>JSON Web Token: JWT<br>JWT是Bearer Token一个具体实现，由JSON数据格式组成, 通过HASH散列算法生成字符串.</p>
<h1 id="JWT-认证流程"><a href="#JWT-认证流程" class="headerlink" title="JWT 认证流程:"></a>JWT 认证流程:</h1><blockquote>
<p>不要存放敏感信息到Token中<br>Payload exp值不要设置太大，一般开发版本2小时，上线版本7天</p>
</blockquote>
<ol>
<li>客户端使用用户名和密码请求登陆</li>
<li>服务端收到请求后，会验证用户名和密码，如果用户名和密码验证成功，服务端签发Token返回给客户端</li>
<li>客户端收到请求后将Token缓存起来 Cookie中或者LocalStorage,之后每次请求都会携带该Token</li>
<li>服务端收到请求后，验证请求中的Token,验证通过则进行业务逻辑处理，处理完返回处理结果</li>
</ol>
<h1 id="JWT格式"><a href="#JWT格式" class="headerlink" title="JWT格式:"></a>JWT格式:</h1><p>  1.Header</p>
<pre><code>- 类型声明 JWT
- 声明加密算法 HMAC SHA256
- 密钥ID 可选
  &#123;
    &quot;typ&quot;: &quot;JWT&quot;,
    &quot;alg&quot;: &quot;HS256&quot;
    &quot;kid&quot;: &quot;youknowwhoami&quot;
  &#125;
  Header进行base64编码
  github.com/chyidl/noone via 🐹 v1.17
  ➜ echo -n &#39;&#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;,&quot;kid&quot;:&quot;youknowwhoami&quot;&#125;&#39;|base64
  eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiIsImtpZCI6InlvdWtub3d3aG9hbWkifQ==
</code></pre>
<p>  2.Payload</p>
<pre><code>- JWT标准中注册的声明
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">iss</span><span class="params">(Issuer)</span></span>: JWT Token的签发者</span><br><span class="line"><span class="function"><span class="title">sub</span><span class="params">(Subject)</span></span>: 主题</span><br><span class="line"><span class="function"><span class="title">exp</span><span class="params">(Expiration Time)</span></span>: JWT Token过期时间</span><br><span class="line"><span class="function"><span class="title">aud</span><span class="params">(Audience)</span></span>: 接受JWT Token的一方</span><br><span class="line"><span class="function"><span class="title">iat</span><span class="params">(Issued At)</span></span>: JWT Token签发时间</span><br><span class="line"><span class="function"><span class="title">nbf</span><span class="params">(Not Before)</span></span>: JWT Token生效时间</span><br><span class="line"><span class="function"><span class="title">jti</span><span class="params">(JWT ID)</span></span>: JWT Token ID,令牌的唯一标识符</span><br></pre></td></tr></table></figure>
- 公共的声明
  &gt; 添加用户相关信息或者其他业务需要信息
- 私有的声明
  &gt; 客户端和服务端共同定义的声明，base64是对称加密，不建议存放敏感信息
</code></pre>
<p>  3.Signature 签名</p>
<pre><code>- header(base64后的)
- payload(base64后)
- secretKey: 密钥，保存在服务器中，通过配置文件保存
- Salt(加密盐)
<figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line">服务端收到<span class="built_in">Token</span>后会解析出header.payload 然后用相同的加密算法和密钥对header.payload在进行一次加密，并对加密后的<span class="built_in">Token</span>和收到的<span class="built_in">Token</span>是否相同，如果相同则验证通过，不相同返回HTTP <span class="number">401</span> Unauthrozied</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h1 id="RequestID"><a href="#RequestID" class="headerlink" title="RequestID"></a>RequestID</h1><pre><code>&gt; 定于和跟踪RequestID
</code></pre>
<h1 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h1><pre><code>&gt; 当前软件架构中采用前后端分离，前端访问地址和后端方法地址不同，Web服务需要处理浏览器跨域请求
</code></pre>
<h1 id="优雅关停"><a href="#优雅关停" class="headerlink" title="优雅关停"></a>优雅关停</h1>  <figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">```</span><br><span class="line"><span class="comment">// main.go</span></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/sync/errgroup&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Product struct &#123;</span><br><span class="line">	Username    string    `json:<span class="string">&quot;username&quot;</span> binding:<span class="string">&quot;required&quot;</span>`</span><br><span class="line">	Name        string    `json:<span class="string">&quot;name&quot;</span> binding:<span class="string">&quot;required&quot;</span>`</span><br><span class="line">	Category    string    `json:<span class="string">&quot;category&quot;</span> binding:<span class="string">&quot;required&quot;</span>`</span><br><span class="line">	Price       int       `json:<span class="string">&quot;price&quot;</span> binding:<span class="string">&quot;gte=0&quot;</span>`</span><br><span class="line">	Description string    `json:<span class="string">&quot;description&quot;</span>`</span><br><span class="line">	CreatedAt   time.Time `json:<span class="string">&quot;createdAt&quot;</span>`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> productHandler struct &#123;</span><br><span class="line">	sync.RWMutex</span><br><span class="line">	products map[string]Product</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newProductHandler() *productHandler &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;productHandler&#123;</span><br><span class="line">		products: make(map[string]Product),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (<span class="keyword">u</span> *productHandler) Create(c *gin.Context) &#123;</span><br><span class="line">	<span class="keyword">u</span>.Lock()</span><br><span class="line">	defer <span class="keyword">u</span>.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 参数解析</span></span><br><span class="line">	<span class="keyword">var</span> product Product</span><br><span class="line">  <span class="comment">// 将Body中JSON格式数据解析到指定的Struct中</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> := c.ShouldBindJSON(&amp;product); <span class="keyword">err</span> != nil &#123;</span><br><span class="line">    <span class="comment">// 返回JSON格式数据</span></span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.<span class="keyword">H</span>&#123;<span class="string">&quot;error&quot;</span>: <span class="keyword">err</span>.<span class="keyword">Error</span>()&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 参数校验</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := <span class="keyword">u</span>.products[product.Name]; ok &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.<span class="keyword">H</span>&#123;<span class="string">&quot;error&quot;</span>: fmt.Sprintf(<span class="string">&quot;product %s already exist&quot;</span>, product.Name)&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	product.CreatedAt = time.Now()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 逻辑处理</span></span><br><span class="line">	<span class="keyword">u</span>.products[product.Name] = product</span><br><span class="line">	<span class="keyword">log</span>.Printf(<span class="string">&quot;Register product %s success&quot;</span>, product.Name)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. 返回结果</span></span><br><span class="line">	c.JSON(http.StatusOK, product)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (<span class="keyword">u</span> *productHandler) <span class="built_in">Get</span>(c *gin.Context) &#123;</span><br><span class="line">	<span class="keyword">u</span>.Lock()</span><br><span class="line">	defer <span class="keyword">u</span>.Unlock()</span><br><span class="line"></span><br><span class="line">	product, ok := <span class="keyword">u</span>.products[c.Param(<span class="string">&quot;name&quot;</span>)]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line"></span><br><span class="line">		c.JSON(http.StatusNotFound, gin.<span class="keyword">H</span>&#123;<span class="string">&quot;error&quot;</span>: fmt.Errorf(<span class="string">&quot;can not found product %s&quot;</span>, c.Param(<span class="string">&quot;name&quot;</span>))&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.JSON(http.StatusOK, product)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func router() http.Handler &#123;</span><br><span class="line">	router := gin.Default()</span><br><span class="line">	productHandler := newProductHandler()</span><br><span class="line">	<span class="comment">// 路由分组/中间件/认证</span></span><br><span class="line">	v1 := router.<span class="built_in">Group</span>(<span class="string">&quot;/v1&quot;</span>)</span><br><span class="line">	productv1 := v1.<span class="built_in">Group</span>(<span class="string">&quot;/products&quot;</span>)</span><br><span class="line">	productv1.<span class="keyword">POST</span>(<span class="string">&quot;&quot;</span>, productHandler.Create)</span><br><span class="line">  <span class="comment">// Gin支持两种路由匹配规则</span></span><br><span class="line">  <span class="comment">//  /products/:name 精确匹配</span></span><br><span class="line">  <span class="comment">//  /products/*name 模糊匹配</span></span><br><span class="line">	productv1.<span class="built_in">GET</span>(<span class="string">&quot;:name&quot;</span>, productHandler.Get)</span><br><span class="line">	<span class="keyword">return</span> router</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	<span class="keyword">var</span> eg errgroup.Group</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 一进程多端口</span></span><br><span class="line">  <span class="comment">// Gin是基于net/http包封装的web框架</span></span><br><span class="line">	insecureServer := &amp;http.Server&#123;</span><br><span class="line">		Addr:         <span class="string">&quot;:8080&quot;</span>,</span><br><span class="line">		Handler:      router(),</span><br><span class="line">		ReadTimeout:  5 * time.Second,</span><br><span class="line">		WriteTimeout: 10 * time.Second,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	secureServer := &amp;http.Server&#123;</span><br><span class="line">		Addr:         <span class="string">&quot;:8443&quot;</span>,</span><br><span class="line">		Handler:      router(),</span><br><span class="line">		ReadTimeout:  5 * time.Second,</span><br><span class="line">		WriteTimeout: 10 * time.Second,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	eg.Go(func() <span class="keyword">error</span> &#123;</span><br><span class="line">		<span class="keyword">err</span> := insecureServer.ListenAndServe()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> != nil &amp;&amp; <span class="keyword">err</span> != http.ErrServerClosed &#123;</span><br><span class="line">			<span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	eg.Go(func() <span class="keyword">error</span> &#123;</span><br><span class="line">		path, <span class="keyword">err</span> := os.Getwd()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="keyword">err</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">log</span>.Println(path)</span><br><span class="line">		<span class="keyword">err</span> = secureServer.ListenAndServeTLS(<span class="string">&quot;./server.pem&quot;</span>, <span class="string">&quot;./server.key&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> != nil &amp;&amp; <span class="keyword">err</span> != http.ErrServerClosed &#123;</span><br><span class="line">			<span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> := eg.Wait(); <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>支持HTTP方法: GET/POST/PUT/PATCH/DELETE/OPTIONS</li>
<li>支持不同位置的HTTP参数:<ul>
<li>路径参数 path tag uri /user/:name name就是路径参数<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">路径参数: ShouldBindUri, BindUri</span></span><br></pre></td></tr></table></figure></li>
<li>查询字符串参数 query tag form /welcome?firstname=xx firstname就是查询参数<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">查询字符串参数: ShouldBindQuery, BindQuery</span></span><br></pre></td></tr></table></figure></li>
<li>表单参数 form tag form curl -X POST -F ‘username=colins’ <a href="http://mydomain.com/login">http://mydomain.com/login</a>, username就是表单参数<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">表单参数: ShouldBind</span></span><br></pre></td></tr></table></figure></li>
<li>HTTP头参数 header tag header curl -X POST -H ‘Content-Type:application/json’ <a href="http://mydomain.com/login">http://mydomain.com/login</a> Content-Type就是HTTP头参数<figure class="highlight ldif"><table><tr><td class="code"><pre><span class="line"><span class="attribute">HTTP头参数</span>: ShouldBindHeader, BindHeader</span><br></pre></td></tr></table></figure></li>
<li>消息体参数 body tag json/xml curl -X POST -H ‘Content-Type:application/json’ -d ‘{“username”:”colins”}’ <a href="http://mydomain.com/login">http://mydomain.com/login</a>, username就是消息体参数<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">消息体参数: ShouldBindJSON, BindJSON</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>支持HTTP路由和路由分组</li>
<li>支持自定义Log</li>
<li>支持binding和validation,</li>
<li>支持重定向</li>
<li>支持basic auth middleware</li>
<li>支持自定义HTTP配置</li>
<li>支持优雅关闭</li>
<li>支持HTTP2</li>
<li>支持设置获取cookie</li>
</ul>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><ul>
<li><p>ping-pong</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>启动 &amp; 运行<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">➜ go run main.go</span><br><span class="line">[GIN-<span class="keyword">debug</span>] [<span class="built_in">WARNING</span>] Creating an Engine instance <span class="keyword">with</span> the Logger <span class="keyword">and</span> Recovery middleware already attached.</span><br><span class="line"></span><br><span class="line">[GIN-<span class="keyword">debug</span>] [<span class="built_in">WARNING</span>] Running <span class="keyword">in</span> &quot;debug&quot; mode. Switch <span class="keyword">to</span> &quot;release&quot; mode <span class="keyword">in</span> production.</span><br><span class="line"> - <span class="keyword">using</span> env:	export GIN_MODE=<span class="keyword">release</span></span><br><span class="line"> - <span class="keyword">using</span> code:	gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-<span class="keyword">debug</span>] <span class="keyword">GET</span>    /ping                     <span class="comment">--&gt; main.main.func1 (3 handlers)</span></span><br><span class="line">[GIN-<span class="keyword">debug</span>] Environment variable PORT <span class="keyword">is</span> undefined. <span class="keyword">Using</span> port :<span class="number">8080</span> <span class="keyword">by</span> <span class="keyword">default</span></span><br><span class="line">[GIN-<span class="keyword">debug</span>] Listening <span class="keyword">and</span> serving HTTP <span class="keyword">on</span> :<span class="number">8080</span></span><br><span class="line"></span><br><span class="line"># 调用</span><br><span class="line">➜ curl -X <span class="keyword">GET</span> http://localhost:<span class="number">8080</span>/ping</span><br><span class="line">&#123;&quot;message&quot;:&quot;pong&quot;&#125;%</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>源码分析</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"># gin.Default</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default returns an Engine instance with the Logger and Recovery middleware already attached.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Default</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">	debugPrintWARNINGDefault()  <span class="comment">// 检查Go版本是否达到Gin最低要求</span></span><br><span class="line">	engine := New()</span><br><span class="line">	engine.Use(Logger(), Recovery()) <span class="comment">// 引入中间件</span></span><br><span class="line">	<span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># gin.New</span><br><span class="line"><span class="comment">// New returns a new blank Engine instance without any middleware attached.</span></span><br><span class="line"><span class="comment">// By default the configuration is:</span></span><br><span class="line"><span class="comment">// - RedirectTrailingSlash:  true</span></span><br><span class="line"><span class="comment">// - RedirectFixedPath:      false</span></span><br><span class="line"><span class="comment">// - HandleMethodNotAllowed: false</span></span><br><span class="line"><span class="comment">// - ForwardedByClientIP:    true</span></span><br><span class="line"><span class="comment">// - UseRawPath:             false</span></span><br><span class="line"><span class="comment">// - UnescapePathValues:     true</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">	debugPrintWARNINGNew()</span><br><span class="line">	engine := &amp;Engine&#123; <span class="comment">// 初始化</span></span><br><span class="line">		RouterGroup: RouterGroup&#123; <span class="comment">// 路由组</span></span><br><span class="line">			Handlers: <span class="literal">nil</span>,</span><br><span class="line">			basePath: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">			root:     <span class="literal">true</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		FuncMap:                template.FuncMap&#123;&#125;,</span><br><span class="line">		RedirectTrailingSlash:  <span class="literal">true</span>,</span><br><span class="line">		RedirectFixedPath:      <span class="literal">false</span>,</span><br><span class="line">		HandleMethodNotAllowed: <span class="literal">false</span>,</span><br><span class="line">		ForwardedByClientIP:    <span class="literal">true</span>,</span><br><span class="line">		RemoteIPHeaders:        []<span class="keyword">string</span>&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>, <span class="string">&quot;X-Real-IP&quot;</span>&#125;,</span><br><span class="line">		TrustedProxies:         []<span class="keyword">string</span>&#123;<span class="string">&quot;0.0.0.0/0&quot;</span>&#125;,</span><br><span class="line">		AppEngine:              defaultAppEngine,</span><br><span class="line">		UseRawPath:             <span class="literal">false</span>,</span><br><span class="line">		RemoveExtraSlash:       <span class="literal">false</span>,</span><br><span class="line">		UnescapePathValues:     <span class="literal">true</span>,</span><br><span class="line">		MaxMultipartMemory:     defaultMultipartMemory, <span class="comment">// const defaultMultipartMemory = 32 &lt;&lt; 20 // 32 MB</span></span><br><span class="line">		trees:                  <span class="built_in">make</span>(methodTrees, <span class="number">0</span>, <span class="number">9</span>),</span><br><span class="line">		delims:                 render.Delims&#123;Left: <span class="string">&quot;&#123;&#123;&quot;</span>, Right: <span class="string">&quot;&#125;&#125;&quot;</span>&#125;, <span class="comment">// HTML 模版左右定界符</span></span><br><span class="line">		secureJSONPrefix:       <span class="string">&quot;while(1);&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	engine.RouterGroup.engine = engine</span><br><span class="line">	engine.pool.New = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">		<span class="keyword">return</span> engine.allocateContext()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># r.GET()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span> <span class="title">handle</span><span class="params">(httpMethod, relativePath <span class="keyword">string</span>, handlers HandlersChain)</span> <span class="title">IRoutes</span></span> &#123;</span><br><span class="line">    absolutePath := group.calculateAbsolutePath(relativePath) <span class="comment">// 计算路由的绝对路径</span></span><br><span class="line">    handlers = group.combineHandlers(handlers)</span><br><span class="line">    group.engine.addRoute(httpMethod, absolutePath, handlers) <span class="comment">// 追加到树</span></span><br><span class="line">    <span class="keyword">return</span> group.returnObj()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"># r.Run()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run attaches the router to a http.Server and starts listening and serving HTTP requests.</span></span><br><span class="line"><span class="comment">// It is a shortcut for http.ListenAndServe(addr, router)</span></span><br><span class="line"><span class="comment">// Note: this method will block the calling goroutine indefinitely unless an error happens.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Run</span><span class="params">(addr ...<span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; debugPrintError(err) &#125;()</span><br><span class="line"></span><br><span class="line">	trustedCIDRs, err := engine.prepareTrustedCIDRs()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	engine.trustedCIDRs = trustedCIDRs</span><br><span class="line">	address := resolveAddress(addr)</span><br><span class="line">	debugPrint(<span class="string">&quot;Listening and serving HTTP on %s\n&quot;</span>, address)</span><br><span class="line">	err = http.ListenAndServe(address, engine)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上下文池化防止频繁生成上下文对象，提高性能</span></span><br><span class="line"><span class="comment">// ServeHTTP conforms to the http.Handler interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">	c := engine.pool.Get().(*Context) <span class="comment">// sync.Pool 对象池中获取一个上下文对象</span></span><br><span class="line">	c.writermem.reset(w)</span><br><span class="line">	c.Request = req</span><br><span class="line">	c.reset()</span><br><span class="line"></span><br><span class="line">	engine.handleHTTPRequest(c)</span><br><span class="line"></span><br><span class="line">	engine.pool.Put(c) <span class="comment">// 返回对象池</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>Gin</tag>
        <tag>Web框架</tag>
      </tags>
  </entry>
  <entry>
    <title>Makefile Intro</title>
    <url>/2021/09/08/Makefile-Intro/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>MySQL Index Intro</title>
    <url>/2021/09/08/MySQL-Index-Intro/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>数据结构-Radix-Tree</title>
    <url>/2021/09/08/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-Radix-Tree/</url>
    <content><![CDATA[<h1 id="Radix-Tree-基数树"><a href="#Radix-Tree-基数树" class="headerlink" title="Radix Tree - 基数树"></a>Radix Tree - 基数树</h1><blockquote>
<p>radix tree用于表示一种空间优化的tree. 假如树中的一个节点是父节点的唯一子节点，那么该节点将会与父节点进行合并 radix tree的边沿edges可以是一个或者多个元素<br>元素个数不是太多，但是元素之间通常有很长的相同前缀时很适合采用radix tree存储<br>Golang的web框架gin使用radix tree作为路由查找的算法.</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># gin/gin.go</span><br><span class="line"></span><br><span class="line">// <span class="keyword">method</span> -&gt; HTTP <span class="keyword">Method</span> &#123;<span class="keyword">GET</span>,PUT,POST,<span class="keyword">DELETE</span>&#125;</span><br><span class="line">func (engine *Engine) addRoute(<span class="keyword">method</span>, <span class="type">path</span> string, handlers HandlersChain) &#123;</span><br><span class="line">	assert1(<span class="type">path</span>[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>, &quot;path must begin with &#x27;/&#x27;&quot;)</span><br><span class="line">	assert1(<span class="keyword">method</span> != &quot;&quot;, &quot;HTTP method can not be empty&quot;)</span><br><span class="line">	assert1(len(handlers) &gt; <span class="number">0</span>, &quot;there must be at least one handler&quot;)</span><br><span class="line"></span><br><span class="line">	debugPrintRoute(<span class="keyword">method</span>, <span class="type">path</span>, handlers)</span><br><span class="line"></span><br><span class="line">  // 每一个<span class="keyword">method</span>对应一颗radix tree</span><br><span class="line">	root := engine.trees.<span class="keyword">get</span>(<span class="keyword">method</span>)</span><br><span class="line">	<span class="keyword">if</span> root == nil &#123;</span><br><span class="line">    // 如果获取不到<span class="keyword">method</span>对应的树，就创建</span><br><span class="line">		root = <span class="built_in">new</span>(node)</span><br><span class="line">		root.fullPath = &quot;/&quot;</span><br><span class="line">		engine.trees = append(engine.trees, methodTree&#123;<span class="keyword">method</span>: <span class="keyword">method</span>, root: root&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	root.addRoute(<span class="type">path</span>, handlers)</span><br><span class="line"></span><br><span class="line">	// <span class="keyword">Update</span> maxParams</span><br><span class="line">	<span class="keyword">if</span> paramsCount := countParams(<span class="type">path</span>); paramsCount &gt; engine.maxParams &#123;</span><br><span class="line">		engine.maxParams = paramsCount</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>数据结构</tag>
      </tags>
  </entry>
  <entry>
    <title>静态代码检查 golangci-lint</title>
    <url>/2021/09/08/%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5-golangci-lint/</url>
    <content><![CDATA[<h1 id="静态代码检查"><a href="#静态代码检查" class="headerlink" title="静态代码检查"></a>静态代码检查</h1><span id="more"></span>

<h2 id="golangci-lint"><a href="#golangci-lint" class="headerlink" title="golangci-lint"></a>golangci-lint</h2><blockquote>
<p>golangci-lint is a fast Go linters runner. It runs linters in parallel, uses caching, supports yaml config, has integrations with all major IDE and has dozens of linters included.</p>
</blockquote>
]]></content>
      <tags>
        <tag>golangci-lint</tag>
      </tags>
  </entry>
  <entry>
    <title>Error Code Design Intro</title>
    <url>/2021/09/09/Error-Code-Design-Intro/</url>
    <content><![CDATA[<h1 id="错误码设计"><a href="#错误码设计" class="headerlink" title="错误码设计"></a>错误码设计</h1><ul>
<li>错误码实现方式<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>. 无论请求成功或失败，始终返回<span class="number">200</span> http status <span class="selector-tag">code</span></span><br><span class="line"> &gt; 每次请求，都需要解析HTTP <span class="selector-tag">Body</span>,从中解析出错误码和错误信息.</span><br><span class="line"><span class="number">2</span>. 返回合适的HTTP <span class="selector-tag">Code</span>. 并在<span class="selector-tag">Body</span>中返回错误信息和自定义业务<span class="selector-tag">Code</span></span><br><span class="line"><span class="number">3</span>. 返回合适的HTTP <span class="selector-tag">Code</span>, 并在<span class="selector-tag">Body</span>中详尽的错误信息</span><br></pre></td></tr></table></figure></li>
<li>业务Code码设计</li>
</ul>
]]></content>
      <tags>
        <tag>Error</tag>
      </tags>
  </entry>
  <entry>
    <title>SwaggerAPI intro</title>
    <url>/2021/09/09/SwaggerAPI-intro/</url>
    <content><![CDATA[<h1 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h1><blockquote>
<p>Swagger是一套围绕OpenAPI规范构建的开源工具,可以设计·构建·编写·使用RESTAPI</p>
</blockquote>
<ul>
<li>Swagger编辑器:</li>
<li>Swagger UI: 将OpenAPI规范呈现为交互式API文档，并可以在浏览器中尝试API调用</li>
<li>Swagger Codegen: 根据OpenAPI规范，生成服务器存根和客户端代码库</li>
</ul>
<span id="more"></span>

<h2 id="Swagger和OpenAPI区别"><a href="#Swagger和OpenAPI区别" class="headerlink" title="Swagger和OpenAPI区别"></a>Swagger和OpenAPI区别</h2><ul>
<li>OpenAPI<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">OpenAPI是一个API规范，前身是<span class="keyword">Swagger规范. </span><span class="keyword">Swagger是实现规范的工具</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="go-swagger生成Swagger-API-文档"><a href="#go-swagger生成Swagger-API-文档" class="headerlink" title="go-swagger生成Swagger API 文档"></a>go-swagger生成Swagger API 文档</h2><ul>
<li><p>go-swagger特征</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 根据Swagger定义文件生成服务端代码</span><br><span class="line"><span class="bullet">2.</span> 根据Swagger定义文件生成客户端代码</span><br><span class="line"><span class="bullet">3.</span> 校验Swagger定义文件是否正确</span><br><span class="line"><span class="bullet">4.</span> 启动一个HTTP服务器，使我们可以通过浏览器访问API文档</span><br><span class="line"><span class="bullet">5.</span> 根据Swagger文档定义的参数生成Go Model结构体定义</span><br></pre></td></tr></table></figure></li>
<li><p>Swagger工具</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">github.com<span class="regexp">/chyidl/</span>noone via 🐹 v1.<span class="number">17</span></span><br><span class="line">➜ go get -u github.com<span class="regexp">/go-swagger/g</span>o-swagger<span class="regexp">/cmd/</span>swagger</span><br><span class="line"></span><br><span class="line">github.com<span class="regexp">/chyidl/</span>noone via 🐹 v1.<span class="number">17</span> took <span class="number">25</span>s</span><br><span class="line">➜ swagger version</span><br><span class="line">version: v0.<span class="number">27.0</span></span><br><span class="line">commit: (unknown, mod sum: <span class="string">&quot;h1:K7+nkBuf4oS1jTBrdvWqYFpqD69V5CN8HamZzCDDhAI=&quot;</span>)</span><br><span class="line"></span><br><span class="line">github.com<span class="regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="number">17</span></span><br><span class="line">➜ swagger generate spec -o swagger.yaml</span><br><span class="line">  -o: 指定输出文件名</span><br><span class="line"></span><br><span class="line">github.com<span class="regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="number">17</span></span><br><span class="line">➜ ls</span><br><span class="line">api          docs         go.mod       main.go      swagger.yaml</span><br><span class="line">github.com<span class="regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="number">17</span></span><br><span class="line">➜ swagger serve --no-open -F=swagger --port <span class="number">36666</span> swagger.yaml</span><br><span class="line"><span class="number">2021</span><span class="regexp">/09/</span><span class="number">09</span> <span class="number">12</span>:<span class="number">58</span>:<span class="number">09</span> serving docs at http:<span class="regexp">//</span>localhost:<span class="number">36666</span>/docs</span><br><span class="line">  --no-open: 禁止调用浏览器打开</span><br><span class="line">  -F: 指定文档风格</span><br><span class="line">  --port: 指定启动的HTTP服务监听</span><br><span class="line"></span><br><span class="line">github.com<span class="regexp">/chyidl/g</span>o-swagger-demo via 🐹 v1.<span class="number">17</span></span><br><span class="line">➜ swagger generate spec -i .<span class="regexp">/swagger.yaml -o ./</span>swagger.json</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> swagger:route POST /users user createUserRequest</span><br><span class="line"><span class="regexp">//</span> Create a user <span class="keyword">in</span> memory.</span><br><span class="line"><span class="regexp">//</span> responses:</span><br><span class="line"><span class="regexp">//</span>   <span class="number">200</span>: createUserResponse</span><br><span class="line"><span class="regexp">//</span>   default: errResponse</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> swagger:route GET <span class="regexp">/users/</span>&#123;name&#125; user getUserRequest</span><br><span class="line"><span class="regexp">//</span> Get a user from memory.</span><br><span class="line"><span class="regexp">//</span> responses:</span><br><span class="line"><span class="regexp">//</span>   <span class="number">200</span>: getUserResponse</span><br><span class="line"><span class="regexp">//</span>   default: errResponse</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>SwaggerAPI</tag>
      </tags>
  </entry>
  <entry>
    <title>gorm intro</title>
    <url>/2021/09/09/gorm-intro/</url>
    <content><![CDATA[<h1 id="GORM"><a href="#GORM" class="headerlink" title="GORM"></a>GORM</h1>]]></content>
      <tags>
        <tag>ORM</tag>
      </tags>
  </entry>
  <entry>
    <title>Go Concurrency Patterns</title>
    <url>/2021/09/10/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><ul>
<li><p>Simplicity: 简单</p>
<blockquote>
<p>Simplicity is prerequisite for reliability. 简单是可靠的先觉条件</p>
</blockquote>
</li>
<li><p>Readablity: 可读性</p>
<blockquote>
<p>Readability is essential for maintainablity. 可读性对于可维护性至关重要<br>Programs must be written for people to read, and only incidentally for machine to execute. 程序必须是为人们阅读而编写的，而偶然为及其执行而编写</p>
</blockquote>
</li>
<li><p>Productivity: 生产力</p>
<blockquote>
<p>Design is the art of arranging code to work today, and be changeable forever.</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<h2 id="Go-Model-CSP"><a href="#Go-Model-CSP" class="headerlink" title="Go Model: CSP"></a>Go Model: CSP</h2><ul>
<li>CSP:<blockquote>
<p>Communicating Sequential Processes</p>
</blockquote>
</li>
</ul>
<h2 id="并发-Concurrency-amp-amp-并行-Parallelism"><a href="#并发-Concurrency-amp-amp-并行-Parallelism" class="headerlink" title="并发(Concurrency) &amp;&amp; 并行(Parallelism)"></a>并发(Concurrency) &amp;&amp; 并行(Parallelism)</h2><ul>
<li><p>并发(Concurrency):</p>
<blockquote>
<p>Programming as the composition of independently executing processes.<br>Concurrency is about dealing with lots of things at once.<br>Concurreny is about structure</p>
</blockquote>
</li>
<li><p>并行(Parallelism)</p>
<blockquote>
<p>programming as the simultaneous execution of computations.<br>Parallelism is about doing lots of things at once.<br>Parallelism is about execution</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>A well-written concurrent program might run efficiently in parallel on a multiprocessor.</p>
</blockquote>
<h2 id="进程-amp-线程"><a href="#进程-amp-线程" class="headerlink" title="进程 &amp; 线程"></a>进程 &amp; 线程</h2><blockquote>
<p>进程 Process:<br>线程 Thread:</p>
</blockquote>
<h2 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h2><blockquote>
<p>Concurrent execution<br>A goroutine is a function running independently in the same address space as other goroutines<br>has its own call stack, which grows and shrinks as required.</p>
</blockquote>
<ul>
<li>goroutine 生命周期管理<ul>
<li>尽量避免在请求中直接启动goroutine处理问题，通过启动worker进行消费，避免由于请求量大，创建大量的goroutine导致OOM<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 初始化操作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	setup()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 监听服务退出</span></span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">2</span>)</span><br><span class="line">	<span class="comment">// 控制服务退出</span></span><br><span class="line">	stop := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// for debug</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- pprof(stop)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 主程序</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		done &lt;- app(stop)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> stoped <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(done); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> err := &lt;-done; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;server exit err: %+v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> !stoped &#123;</span><br><span class="line">			stoped = <span class="literal">true</span></span><br><span class="line">			<span class="built_in">close</span>(stop)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">app</span><span class="params">(stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		w.Write([]<span class="keyword">byte</span>(<span class="string">&quot;pong&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> server(mux, <span class="string">&quot;:8080&quot;</span>, stop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pprof</span><span class="params">(stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		server(http.DefaultServeMux, <span class="string">&quot;:8081&quot;</span>, stop)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;mock pprof exit&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(handler http.Handler, addr <span class="keyword">string</span>, stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	s := http.Server&#123;</span><br><span class="line">		Handler: handler,</span><br><span class="line">		Addr:    addr,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		&lt;-stop</span><br><span class="line">		log.Printf(<span class="string">&quot;server will exiting, addr: %s&quot;</span>, addr)</span><br><span class="line">		s.Shutdown(context.Background())</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h2><blockquote>
<p>Synchronization and messaging<br>Channels are typed values that allow goroutines to synchronize and exchange information<br>Channels are first-class values<br>A channel in Go provides a connection between two goroutines, allowing them to communicate</p>
</blockquote>
<ul>
<li><p>无缓冲通道 no-buffer channel</p>
<blockquote>
<p>发送者sender 和 接收者 receiver 必须同时准备好才能进行下去</p>
</blockquote>
</li>
<li><p>缓冲通道 buffer channel</p>
<blockquote>
<p>缓冲通道解决同步等待问题</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Declaring and initializing</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sending on a channel.</span></span><br><span class="line">c &lt;- <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Receiving from a channel</span></span><br><span class="line"><span class="comment">// The &quot;arrow&quot; indicates the direction of data flow.</span></span><br><span class="line">value = &lt;-c</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><blockquote>
<p>Multi-way concurrent control<br>The select statement is like a switch, but the decision is based on ability to communicate rather than equal values</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Fan-in using select</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1, input2 &lt;- <span class="keyword">chan</span> <span class="keyword">string</span>)</span> &lt;- <span class="title">chan</span> <span class="title">string</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> s := &lt;-input1: c &lt;- s</span><br><span class="line">        <span class="keyword">case</span> s := &lt;-input2: c &lt;- s</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;()</span><br><span class="line">  <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Closures"><a href="#Closures" class="headerlink" title="Closures"></a>Closures</h2><h3 id="Demo-Project"><a href="#Demo-Project" class="headerlink" title="Demo Project"></a>Demo Project</h3><blockquote>
<p>Always use the right tool for the job</p>
</blockquote>
<ul>
<li>Google Search: A fake framework<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> google_search_test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Result <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	Web    = fakeSearch(<span class="string">&quot;web&quot;</span>)</span><br><span class="line">	Web1   = fakeSearch(<span class="string">&quot;web1&quot;</span>)</span><br><span class="line">	Web2   = fakeSearch(<span class="string">&quot;web2&quot;</span>)</span><br><span class="line">	Image  = fakeSearch(<span class="string">&quot;image&quot;</span>)</span><br><span class="line">	Image1 = fakeSearch(<span class="string">&quot;Image1&quot;</span>)</span><br><span class="line">	Image2 = fakeSearch(<span class="string">&quot;Image2&quot;</span>)</span><br><span class="line">	Video  = fakeSearch(<span class="string">&quot;video&quot;</span>)</span><br><span class="line">	Video1 = fakeSearch(<span class="string">&quot;Video1&quot;</span>)</span><br><span class="line">	Video2 = fakeSearch(<span class="string">&quot;Video2&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Search <span class="function"><span class="keyword">func</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="title">Result</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fakeSearch</span><span class="params">(kind <span class="keyword">string</span>)</span> <span class="title">Search</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="title">Result</span></span> &#123;</span><br><span class="line">		time.Sleep(time.Duration(rand.Intn(<span class="number">100</span>)) * time.Millisecond)</span><br><span class="line">		<span class="keyword">return</span> Result(fmt.Sprintf(<span class="string">&quot;%s result for %q\n&quot;</span>, kind, query))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Google</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="params">(results []Result)</span></span> &#123;</span><br><span class="line">	results = <span class="built_in">append</span>(results, Web(query))</span><br><span class="line">	results = <span class="built_in">append</span>(results, Image(query))</span><br><span class="line">	results = <span class="built_in">append</span>(results, Video(query))</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GoogleV2</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="params">(results []Result)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Run the Web, Image, and Video searches concurrently</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- Web(query) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- Image(query) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- Video(query) &#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wait for all results</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">		result := &lt;-c</span><br><span class="line">		results = <span class="built_in">append</span>(results, result)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GoogleV21</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="params">(results []Result)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Don;t wait for slow servers. No locks. No condition variables.</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- Web(query) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- Image(query) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- Video(query) &#125;()</span><br><span class="line"></span><br><span class="line">	timeout := time.After(<span class="number">80</span> * time.Millisecond)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> result := &lt;-c:</span><br><span class="line">			results = <span class="built_in">append</span>(results, result)</span><br><span class="line">		<span class="keyword">case</span> &lt;-timeout:</span><br><span class="line">			fmt.Println(<span class="string">&quot;timed out&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GoogleV3</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="params">(results []Result)</span></span> &#123;</span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- First(query, Web1, Web2) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- First(query, Image1, Image2) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- First(query, Video1, Video2) &#125;()</span><br><span class="line">	timeout := time.After(<span class="number">80</span> * time.Millisecond)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> result := &lt;-c:</span><br><span class="line">			results = <span class="built_in">append</span>(results, result)</span><br><span class="line">		<span class="keyword">case</span> &lt;-timeout:</span><br><span class="line">			fmt.Println(<span class="string">&quot;timed out&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">First</span><span class="params">(query <span class="keyword">string</span>, replicas ...Search)</span> <span class="title">Result</span></span> &#123;</span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result)</span><br><span class="line">	searchReplica := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; c &lt;- replicas[i](query) &#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> replicas &#123;</span><br><span class="line">		<span class="keyword">go</span> searchReplica(i)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &lt;-c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGoogle</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line">	start := time.Now()</span><br><span class="line">	results := Google(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">	elapsed := time.Since(start)</span><br><span class="line">	fmt.Println(results)</span><br><span class="line">	fmt.Println(elapsed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGoogleV2</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line">	start := time.Now()</span><br><span class="line">	results := GoogleV2(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">	elapsed := time.Since(start)</span><br><span class="line">	fmt.Println(results)</span><br><span class="line">	fmt.Println(elapsed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGoogleV21</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line">	start := time.Now()</span><br><span class="line">	results := GoogleV21(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">	elapsed := time.Since(start)</span><br><span class="line">	fmt.Println(results)</span><br><span class="line">	fmt.Println(elapsed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGoogleV3</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line">	start := time.Now()</span><br><span class="line">	results := GoogleV3(<span class="string">&quot;golang&quot;</span>)</span><br><span class="line">	elapsed := time.Since(start)</span><br><span class="line">	fmt.Println(results)</span><br><span class="line">	fmt.Println(elapsed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ➜ go test -v google_search_test.go</span></span><br><span class="line"><span class="comment">// === RUN   TestGoogle</span></span><br><span class="line"><span class="comment">// [web result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  image result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  video result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="comment">// 31.882269ms</span></span><br><span class="line"><span class="comment">// --- PASS: TestGoogle (0.03s)</span></span><br><span class="line"><span class="comment">// === RUN   TestGoogleV2</span></span><br><span class="line"><span class="comment">// [web result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  image result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  video result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="comment">// 49.036197ms</span></span><br><span class="line"><span class="comment">// --- PASS: TestGoogleV2 (0.05s)</span></span><br><span class="line"><span class="comment">// === RUN   TestGoogleV21</span></span><br><span class="line"><span class="comment">// [web result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  video result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  image result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="comment">// 53.507162ms</span></span><br><span class="line"><span class="comment">// --- PASS: TestGoogleV21 (0.05s)</span></span><br><span class="line"><span class="comment">// === RUN   TestGoogleV3</span></span><br><span class="line"><span class="comment">// [Video2 result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  web1 result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">//  Image1 result for &quot;golang&quot;</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="comment">// 41.612001ms</span></span><br><span class="line"><span class="comment">// --- PASS: TestGoogleV3 (0.04s)</span></span><br><span class="line"><span class="comment">// PASS</span></span><br><span class="line"><span class="comment">// ok  	command-line-arguments	0.301s</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Best-Practice-Writing-Go-Code-最佳实践"><a href="#Best-Practice-Writing-Go-Code-最佳实践" class="headerlink" title="Best Practice Writing Go Code: 最佳实践"></a>Best Practice Writing Go Code: 最佳实践</h2><ul>
<li>software programming 软件编程</li>
<li>software engineering 软件工程</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">Practical Go: Real world advice for writing maintainable Go Programs</a></li>
</ul>
]]></content>
      <tags>
        <tag>Golang</tag>
        <tag>sync</tag>
      </tags>
  </entry>
  <entry>
    <title>Ansible Intro</title>
    <url>/2021/09/11/Ansible-Intro/</url>
    <content><![CDATA[<h1 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a>Ansible</h1><blockquote>
<p>Tool to automate IT tasks.</p>
</blockquote>
<ul>
<li>SIMPLE<ul>
<li>Human readable automation</li>
<li>No special coding skills needed</li>
<li>Tasks executed in order</li>
</ul>
</li>
<li>POWERFUL<ul>
<li>App deployment</li>
<li>Configuration management</li>
<li>Workflow orchestration</li>
</ul>
</li>
<li>AGENTLESS<ul>
<li>Agentless architecture</li>
<li>Use OpenSSH &amp; WinRM</li>
</ul>
</li>
</ul>
<h2 id="What-Can-I-Use-Ansible-To-Do"><a href="#What-Can-I-Use-Ansible-To-Do" class="headerlink" title="What Can I Use Ansible To Do?"></a>What Can I Use Ansible To Do?</h2><ul>
<li>Config Management</li>
<li>App deployment</li>
<li>Provisioning</li>
<li>Continuous delivery</li>
<li>Security &amp; Compliance</li>
<li>orchestration</li>
</ul>
<h2 id="Ansible-Architecture"><a href="#Ansible-Architecture" class="headerlink" title="Ansible Architecture"></a>Ansible Architecture</h2><p><img src="/misc/images/ansible-architecture.png" alt="ansible architecture"></p>
<ul>
<li>MODULES:</li>
</ul>
<h2 id="Quick-Start-Ansible"><a href="#Quick-Start-Ansible" class="headerlink" title="Quick Start Ansible"></a>Quick Start Ansible</h2><ul>
<li>Installing an Ansible<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line">$ <span class="string">curl</span> <span class="string">https</span>://<span class="string">bootstrap</span>.<span class="string">pypa</span>.<span class="string">io</span>/<span class="built_in">get-pip.py</span> -<span class="string">o</span> <span class="built_in">get-pip.py</span></span><br><span class="line">$ <span class="string">python</span> <span class="built_in">get-pip.py</span> <span class="built_in">--user</span></span><br><span class="line">$ <span class="string">python</span> -<span class="string">m</span> <span class="string">pip</span> <span class="string">install</span> <span class="built_in">--user</span> <span class="string">ansible</span></span><br><span class="line"></span><br><span class="line">➜ <span class="string">ansible</span> <span class="built_in">--version</span></span><br><span class="line"><span class="string">ansible</span> [<span class="string">core</span> <span class="string">2</span>.<span class="string">11</span>.<span class="string">4</span>]</span><br><span class="line">  <span class="string">config</span> <span class="string">file</span> = <span class="string">None</span></span><br><span class="line">  <span class="string">configured</span> <span class="string">module</span> <span class="string">search</span> <span class="string">path</span> = [<span class="string">&#x27;/Users/chyiyaqing/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  <span class="string">ansible</span> <span class="string">python</span> <span class="string">module</span> <span class="string">location</span> = /<span class="string">usr</span>/<span class="string">local</span>/<span class="string">lib</span>/<span class="string">python3</span>.<span class="string">9</span>/<span class="string">site-packages</span>/<span class="string">ansible</span></span><br><span class="line">  <span class="string">ansible</span> <span class="string">collection</span> <span class="string">location</span> = /<span class="string">Users</span>/<span class="string">chyiyaqing</span>/.<span class="string">ansible</span>/<span class="string">collections</span>:/<span class="string">usr</span>/<span class="string">share</span>/<span class="string">ansible</span>/<span class="string">collections</span></span><br><span class="line">  <span class="string">executable</span> <span class="string">location</span> = /<span class="string">usr</span>/<span class="string">local</span>/<span class="string">bin</span>/<span class="string">ansible</span></span><br><span class="line">  <span class="string">python</span> <span class="string">version</span> = <span class="string">3</span>.<span class="string">9</span>.<span class="string">6</span> (<span class="string">default</span>, <span class="string">Jun</span> <span class="string">29</span> <span class="string">2021</span>, <span class="string">05:25:</span><span class="string">02</span>) [<span class="string">Clang</span> <span class="string">12</span>.<span class="string">0</span>.<span class="string">5</span> (<span class="string">clang-1205</span>.<span class="string">0</span>.<span class="string">22</span>.<span class="string">9</span>)]</span><br><span class="line">  <span class="string">jinja</span> <span class="string">version</span> = <span class="string">2</span>.<span class="string">10</span>.<span class="string">1</span></span><br><span class="line">  <span class="string">libyaml</span> = <span class="string">True</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Go CLI Intro</title>
    <url>/2021/09/11/Go-CLI-Intro/</url>
    <content><![CDATA[<h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><blockquote>
<p>命令行flag解析</p>
</blockquote>
<ul>
<li><p>flag 长短选项</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	var name string</span><br><span class="line"></span><br><span class="line">  <span class="regexp">//</span> -flag: 仅支持布尔类型</span><br><span class="line">  <span class="regexp">//</span> -flag x: 仅支持非布尔类型</span><br><span class="line">  <span class="regexp">//</span> -flag=x: 均支持</span><br><span class="line">  <span class="regexp">//</span> 长短选项 分开两次调用</span><br><span class="line">	flag.StringVar(&amp;name, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Golang flag tour&quot;</span>, <span class="string">&quot;help&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;name, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;Golang flag tour&quot;</span>, <span class="string">&quot;help&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;name: %s&quot;</span>, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> ➜ go run flag/demo.go -name=<span class="string">&#x27;hello world&#x27;</span> -n <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line"><span class="regexp">//</span> <span class="number">2021</span><span class="regexp">/09/</span><span class="number">11</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">39</span> name: hello world</span><br></pre></td></tr></table></figure></li>
<li><p>flag 子命令</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	var name string</span><br><span class="line"></span><br><span class="line">	flag.Parse()</span><br><span class="line">	args := flag.Args()</span><br><span class="line">	<span class="keyword">if</span> len(args) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	switch args[<span class="number">0</span>] &#123;</span><br><span class="line">	case <span class="string">&quot;go&quot;</span>:</span><br><span class="line">		goCmd := flag.NewFlagSet(<span class="string">&quot;go&quot;</span>, flag.ExitOnError)</span><br><span class="line">		goCmd.StringVar(&amp;name, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Golang language&quot;</span>, <span class="string">&quot;help&quot;</span>)</span><br><span class="line">		_ = goCmd.Parse(args[<span class="number">1</span>:])</span><br><span class="line">	case <span class="string">&quot;py&quot;</span>:</span><br><span class="line">		pyCmd := flag.NewFlagSet(<span class="string">&quot;py&quot;</span>, flag.ExitOnError)</span><br><span class="line">		pyCmd.StringVar(&amp;name, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Python language&quot;</span>, <span class="string">&quot;help&quot;</span>)</span><br><span class="line">		_ = pyCmd.Parse(args[<span class="number">1</span>:])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;name: %s&quot;</span>, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> ➜ go run flag/flag_sub_cli.go go -name=golang</span><br><span class="line"><span class="regexp">//</span> <span class="number">2021</span><span class="regexp">/09/</span><span class="number">11</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">47</span> name: golang</span><br><span class="line"><span class="regexp">//</span></span><br><span class="line"><span class="regexp">//</span> ➜ go run flag/flag_sub_cli.go go -n=python</span><br><span class="line"><span class="regexp">//</span> flag provided but not defined: -n</span><br><span class="line"><span class="regexp">//</span> Usage of go:</span><br><span class="line"><span class="regexp">//</span>   -name string</span><br><span class="line"><span class="regexp">//</span>     	help (default <span class="string">&quot;Golang language&quot;</span>)</span><br><span class="line"><span class="regexp">//</span> <span class="keyword">exit</span> status <span class="number">2</span></span><br></pre></td></tr></table></figure></li>
<li><p>flag 源码分析</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"># flag.Parse</span><br><span class="line"></span><br><span class="line"><span class="comment">// CommandLine is the default set of command-line flags, parsed from os.Args.</span></span><br><span class="line"><span class="comment">// The top-level functions such as BoolVar, Arg, and so on are wrappers for the</span></span><br><span class="line"><span class="comment">// methods of CommandLine.</span></span><br><span class="line"><span class="keyword">var</span> CommandLine = NewFlagSet(os.Args[<span class="number">0</span>], ExitOnError)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse parses the command-line flags from os.Args[1:]. Must be called</span></span><br><span class="line"><span class="comment">// after all flags are defined and before flags are accessed by the program.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Ignore errors; CommandLine is set for ExitOnError.</span></span><br><span class="line">	CommandLine.Parse(os.Args[<span class="number">1</span>:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># FlagSet.Parse</span><br><span class="line">&gt; parse异常分流处理</span><br><span class="line"><span class="comment">// Parse parses flag definitions from the argument list, which should not</span></span><br><span class="line"><span class="comment">// include the command name. Must be called after all flags in the FlagSet</span></span><br><span class="line"><span class="comment">// are defined and before flags are accessed by the program.</span></span><br><span class="line"><span class="comment">// The return value will be ErrHelp if -help or -h were set but not defined.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Parse</span><span class="params">(arguments []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	f.parsed = <span class="literal">true</span></span><br><span class="line">	f.args = arguments</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		seen, err := f.parseOne()</span><br><span class="line">		<span class="keyword">if</span> seen &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> f.errorHandling &#123;</span><br><span class="line">		<span class="keyword">case</span> ContinueOnError:</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		<span class="keyword">case</span> ExitOnError:</span><br><span class="line">			<span class="keyword">if</span> err == ErrHelp &#123;</span><br><span class="line">				os.Exit(<span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			os.Exit(<span class="number">2</span>)</span><br><span class="line">		<span class="keyword">case</span> PanicOnError:</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># FlagSet.parseOne</span><br><span class="line"><span class="comment">// parseOne parses one flag. It reports whether a flag was seen.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">parseOne</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(f.args) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	s := f.args[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">2</span> || s[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	numMinuses := <span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> s[<span class="number">1</span>] == <span class="string">&#x27;-&#x27;</span> &#123;</span><br><span class="line">		numMinuses++</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">2</span> &#123; <span class="comment">// &quot;--&quot; terminates the flags</span></span><br><span class="line">			f.args = f.args[<span class="number">1</span>:]</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	name := s[numMinuses:]</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> || name[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span> || name[<span class="number">0</span>] == <span class="string">&#x27;=&#x27;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">&quot;bad flag syntax: %s&quot;</span>, s)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// it&#x27;s a flag. does it have an argument?</span></span><br><span class="line">	f.args = f.args[<span class="number">1</span>:]</span><br><span class="line">	hasValue := <span class="literal">false</span></span><br><span class="line">	value := <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(name); i++ &#123; <span class="comment">// equals cannot be first</span></span><br><span class="line">		<span class="keyword">if</span> name[i] == <span class="string">&#x27;=&#x27;</span> &#123;</span><br><span class="line">			value = name[i+<span class="number">1</span>:]</span><br><span class="line">			hasValue = <span class="literal">true</span></span><br><span class="line">			name = name[<span class="number">0</span>:i]</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	m := f.formal</span><br><span class="line">	flag, alreadythere := m[name] <span class="comment">// BUG</span></span><br><span class="line">	<span class="keyword">if</span> !alreadythere &#123;</span><br><span class="line">		<span class="keyword">if</span> name == <span class="string">&quot;help&quot;</span> || name == <span class="string">&quot;h&quot;</span> &#123; <span class="comment">// special case for nice help message.</span></span><br><span class="line">			f.usage()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, ErrHelp</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">&quot;flag provided but not defined: -%s&quot;</span>, name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> fv, ok := flag.Value.(boolFlag); ok &amp;&amp; fv.IsBoolFlag() &#123; <span class="comment">// special case: doesn&#x27;t need an arg</span></span><br><span class="line">		<span class="keyword">if</span> hasValue &#123;</span><br><span class="line">			<span class="keyword">if</span> err := fv.Set(value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">&quot;invalid boolean value %q for -%s: %v&quot;</span>, value, name, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := fv.Set(<span class="string">&quot;true&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">&quot;invalid boolean flag %s: %v&quot;</span>, name, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// It must have a value, which might be the next argument.</span></span><br><span class="line">		<span class="keyword">if</span> !hasValue &amp;&amp; <span class="built_in">len</span>(f.args) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// value is the next arg</span></span><br><span class="line">			hasValue = <span class="literal">true</span></span><br><span class="line">			value, f.args = f.args[<span class="number">0</span>], f.args[<span class="number">1</span>:]</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !hasValue &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">&quot;flag needs an argument: -%s&quot;</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := flag.Value.Set(value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">&quot;invalid value %q for flag -%s: %v&quot;</span>, value, name, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> f.actual == <span class="literal">nil</span> &#123;</span><br><span class="line">		f.actual = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Flag)</span><br><span class="line">	&#125;</span><br><span class="line">	f.actual[name] = flag</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Cobra"><a href="#Cobra" class="headerlink" title="Cobra"></a>Cobra</h2>]]></content>
      <tags>
        <tag>CLI</tag>
      </tags>
  </entry>
  <entry>
    <title>Go Constants</title>
    <url>/2021/09/12/Go-Constants/</url>
    <content><![CDATA[<h1 id="Constants-常量"><a href="#Constants-常量" class="headerlink" title="Constants 常量"></a>Constants 常量</h1><blockquote>
<p>Go是静态类型语言，不允许同步类型的数值类型进行计算. 不允许float64 + int 甚至 int32 + int. 如果你希望不同类型进行计算需要显式转换后在进行 int(float64) + int.</p>
</blockquote>
<span id="more"></span>

<h2 id="字符串常量"><a href="#字符串常量" class="headerlink" title="字符串常量"></a>字符串常量</h2><blockquote>
<p>字符串常量使用双引号(Go可以使用<code>raw string</code>)<br>  <figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># hello 是一个无类型的字符串常量, 赋值给有类型的变量不会引起类型错误.</span></span><br><span class="line"><span class="keyword">const</span> hello = <span class="string">&quot;Hello, 世界&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># hello是一个字符串常量</span></span><br><span class="line"><span class="keyword">const</span> typedHello <span class="keyword">string</span> = <span class="string">&quot;Hello, 世界&quot;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="默认类型"><a href="#默认类型" class="headerlink" title="默认类型"></a>默认类型</h2>  <figure class="highlight hsp"><table><tr><td class="code"><pre><span class="line"><span class="meta"># str := <span class="meta-string">&quot;Hello, 世界&quot;</span></span></span><br><span class="line">可能会有疑惑，如果常量是没有类型的，<span class="keyword">str</span>变量如何获取到类型? 答案就是无类型的常量有一个默认类型，如果变量<span class="keyword">str</span>没有声明类型会使用右边表达式中的默认类型.</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>常量</tag>
      </tags>
  </entry>
  <entry>
    <title>Go PProf Intro</title>
    <url>/2021/09/13/Go-PProf-Intro/</url>
    <content><![CDATA[<h1 id="Go-Profling-剖析"><a href="#Go-Profling-剖析" class="headerlink" title="Go Profling - 剖析"></a>Go Profling - 剖析</h1><blockquote>
<p>Using “pprof” to profiling your program<br>Go语言可视化性能分析工具,PProf以profile.proto读取分析样本集合，并生成报告可视化帮助分析数据(支持文本和图形报告)</p>
</blockquote>
<ul>
<li><p>使用场景</p>
<ul>
<li>runtime/pprof: 采集程序指定区块的运行数据分析</li>
<li>net/http/pprof: 基于HTTP Server运行,采集运行时数据分析</li>
<li>go test: 通过运行测试用例，指定所需标识进行采样</li>
</ul>
</li>
<li><p>安装可视化工具graphviz查看profile</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># Mac: $ brew install graphviz</span></span><br><span class="line"><span class="meta"># Linux: $ sudo apt install graphviz</span></span><br></pre></td></tr></table></figure></li>
<li><p>支持模式</p>
<ul>
<li>报告生成 Report generation</li>
<li>交互终端使用 Interactive terminal use</li>
<li>Web页面 Web interface</li>
</ul>
</li>
<li><p>可以做那些</p>
<ul>
<li>CPU Profiling: CPU分析<ul>
<li>按照一定频率采集监听应用程序CPU使用情况，确定应用程序的主动消耗CPU周期时花费时间的位置</li>
</ul>
</li>
<li>Memory Profiling: 内存分析<ul>
<li>程序进行堆分配时记录堆栈跟踪，监视当前和历史内存使用情况，检查内存泄漏</li>
</ul>
</li>
<li>Block Profiling: 阻塞分析<ul>
<li>记录Goroutine阻塞等待同步的位置，默认不开启，需要调用runtime.SetBlockProfileRate 设置</li>
</ul>
</li>
<li>Mutex Profiling: 互斥锁分析<ul>
<li>报告互斥锁的竞争情况, 默认不开启, runtime.SetMutexProfileFraction 设置</li>
</ul>
</li>
<li>Goroutine Profiling: Goroutine分析<ul>
<li>对当前应用程序正在运行的Goroutine进行堆栈跟踪和分析</li>
</ul>
</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h2 id="How-to-Use"><a href="#How-to-Use" class="headerlink" title="How to Use"></a>How to Use</h2><ul>
<li>runtime/pprof<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pprof useful command:</span></span><br><span class="line">  <span class="built_in">text</span>: show <span class="keyword">the</span> cpu report <span class="keyword">in</span> <span class="built_in">text</span> form</span><br><span class="line">  web: visualize graph <span class="keyword">through</span> web browser</span><br><span class="line">  top &lt;n&gt;: <span class="built_in">list</span> <span class="keyword">the</span> n highest entries <span class="keyword">in</span> <span class="built_in">text</span> form</span><br><span class="line">  <span class="built_in">list</span> &lt;function <span class="built_in">name</span>&gt;: reveal <span class="keyword">the</span> <span class="built_in">running</span> <span class="built_in">time</span> <span class="keyword">of</span> function</span><br><span class="line">  traces</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var datas []string</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	go <span class="keyword">func</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;len: %d&quot;</span>, Add(<span class="string">&quot;go-programming-tour-book&quot;</span>))</span><br><span class="line">			time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	_ = http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, nil)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> Add(str string) int &#123;</span><br><span class="line">	data := []byte(str)</span><br><span class="line">	datas = append(datas, string(data))</span><br><span class="line">	return len(datas)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 访问 http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/debug/</span>pprof</span><br><span class="line"><span class="regexp">//</span> <span class="regexp">/debug/</span>pprof/</span><br><span class="line"><span class="regexp">//</span></span><br><span class="line"><span class="regexp">//</span> Types of profiles available:</span><br><span class="line"><span class="regexp">//</span> Count	Profile</span><br><span class="line"><span class="regexp">//</span> <span class="number">3</span>	allocs                -- 查看过去内存分配样本</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>	block                 -- 查看阻塞</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>	cmdline               -- 命令行调用路径</span><br><span class="line"><span class="regexp">//</span> <span class="number">5</span>	goroutine             -- goroutine堆栈跟踪</span><br><span class="line"><span class="regexp">//</span> <span class="number">3</span>	heap                  -- 堆上内存分配</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>	mutex                 -- 互斥锁竞争持有者堆栈跟踪</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>	profile               -- 默认<span class="number">30</span>秒CPU Profiling</span><br><span class="line"><span class="regexp">//</span> <span class="number">7</span>	threadcreate          --</span><br><span class="line"><span class="regexp">//</span> <span class="number">0</span>	trace</span><br><span class="line"><span class="regexp">//</span> full goroutine stack dump</span><br></pre></td></tr></table></figure>

<ul>
<li><p>CPU Profiling</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">➜ <span class="keyword">go</span> tool pprof http://localhos<span class="variable">t:8080</span>/<span class="keyword">debug</span>/pprof/<span class="keyword">profile</span>\?seconds\=<span class="number">5</span></span><br><span class="line">Fetching <span class="keyword">profile</span> over HTTP from http://localhos<span class="variable">t:8080</span>/<span class="keyword">debug</span>/pprof/<span class="keyword">profile</span>?seconds=<span class="number">5</span></span><br><span class="line">Saved <span class="keyword">profile</span> in /Users/chyiyaqing/pprof/pprof.samples.cpu.<span class="number">001</span>.pb.gz</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">22</span>pm (CST)</span><br><span class="line">Duration: <span class="number">5</span>s, Total samples = <span class="number">20</span>ms (  <span class="number">0.4</span>%)</span><br><span class="line">Entering interactive <span class="keyword">mode</span> (<span class="built_in">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> <span class="keyword">options</span>)</span><br><span class="line">(pprof) top10</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">20</span>ms, <span class="number">100</span>% of <span class="number">20</span>ms total</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">11</span></span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">      <span class="number">10</span>ms <span class="number">50.00</span>% <span class="number">50.00</span>%       <span class="number">10</span>ms <span class="number">50.00</span>%  <span class="keyword">runtime</span>.kevent</span><br><span class="line">      <span class="number">10</span>ms <span class="number">50.00</span>%   <span class="number">100</span>%       <span class="number">10</span>ms <span class="number">50.00</span>%  <span class="keyword">runtime</span>.pthread_cond_wait</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">20</span>ms   <span class="number">100</span>%  <span class="keyword">runtime</span>.findrunnable</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">10</span>ms <span class="number">50.00</span>%  <span class="keyword">runtime</span>.mPark</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">20</span>ms   <span class="number">100</span>%  <span class="keyword">runtime</span>.mcall</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">10</span>ms <span class="number">50.00</span>%  <span class="keyword">runtime</span>.netpoll</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">10</span>ms <span class="number">50.00</span>%  <span class="keyword">runtime</span>.notesleep</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">20</span>ms   <span class="number">100</span>%  <span class="keyword">runtime</span>.park_m</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">20</span>ms   <span class="number">100</span>%  <span class="keyword">runtime</span>.schedule</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%       <span class="number">10</span>ms <span class="number">50.00</span>%  <span class="keyword">runtime</span>.semasleep</span><br><span class="line"></span><br><span class="line">fla<span class="variable">t:</span> 函数自身运行耗时</span><br><span class="line">flat%: 函数自身在CPU运行耗时总比例</span><br><span class="line">sum%: 函数自身累计使用CPU比例</span><br><span class="line">cum%: 函数自身及其调用函数运行总耗时</span><br><span class="line">cum%: 函数自身及其调用函数的运行耗时总比例</span><br><span class="line">Name: 函数名</span><br></pre></td></tr></table></figure></li>
<li><p>Heap Profiling</p>
<ul>
<li>inuse_space: 分析常驻内存占用<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">➜ go tool pprof -inuse_space http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Fetching profile over HTTP <span class="keyword">from</span> http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Saved profile in <span class="regexp">/Users/</span>chyiyaqing<span class="regexp">/pprof/</span>pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.<span class="number">002</span>.pb.gz</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">30</span>pm (CST)</span><br><span class="line">Entering interactive mode (type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> <span class="keyword">options</span>)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">6951.53</span>kB, <span class="number">100</span>% of <span class="number">6951.53</span>kB total</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">18</span></span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line"> <span class="number">4898.20</span>kB <span class="number">70.46</span>% <span class="number">70.46</span>%  <span class="number">4898.20</span>kB <span class="number">70.46</span>%  main.Add (inline)</span><br><span class="line"> <span class="number">1025.12</span>kB <span class="number">14.75</span>% <span class="number">85.21</span>%  <span class="number">1025.12</span>kB <span class="number">14.75</span>%  <span class="keyword">runtime</span>.allocm</span><br><span class="line">  <span class="number">516.01</span>kB  <span class="number">7.42</span>% <span class="number">92.63</span>%   <span class="number">516.01</span>kB  <span class="number">7.42</span>%  unicode.init</span><br><span class="line">  <span class="number">512.20</span>kB  <span class="number">7.37</span>%   <span class="number">100</span>%   <span class="number">512.20</span>kB  <span class="number">7.37</span>%  <span class="keyword">runtime</span>.malg</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%  <span class="number">4898.20</span>kB <span class="number">70.46</span>%  main.main.func1</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%   <span class="number">516.01</span>kB  <span class="number">7.42</span>%  <span class="keyword">runtime</span>.doInit</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%   <span class="number">516.01</span>kB  <span class="number">7.42</span>%  <span class="keyword">runtime</span>.main</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%  <span class="number">1025.12</span>kB <span class="number">14.75</span>%  <span class="keyword">runtime</span>.mstart</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%  <span class="number">1025.12</span>kB <span class="number">14.75</span>%  <span class="keyword">runtime</span>.mstart0</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%  <span class="number">1025.12</span>kB <span class="number">14.75</span>%  <span class="keyword">runtime</span>.mstart1</span><br><span class="line">(pprof) traces</span><br><span class="line">Type: alloc_objects</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">57</span>pm (CST)</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">     bytes:  <span class="number">256</span>kB</span><br><span class="line">         <span class="number">2</span>   compress/flate.(*compressor).init</span><br><span class="line">             compress/flate.<span class="keyword">NewWriter</span></span><br><span class="line">             compress/gzip.(*Writer).<span class="keyword">Write</span></span><br><span class="line">             <span class="keyword">runtime</span>/pprof.(*profileBuilder).build</span><br><span class="line">             <span class="keyword">runtime</span>/pprof.printCountProfile</span><br><span class="line">             <span class="keyword">runtime</span>/pprof.writeRuntimeProfile</span><br><span class="line">             <span class="keyword">runtime</span>/pprof.writeGoroutine</span><br><span class="line">             <span class="keyword">runtime</span>/pprof.(*Profile).WriteTo</span><br><span class="line">             net<span class="regexp">/http/</span>pprof.handler.ServeHTTP</span><br><span class="line">             net<span class="regexp">/http/</span>pprof.Index</span><br><span class="line">             net/http.HandlerFunc.ServeHTTP</span><br><span class="line">             net/http.(*ServeMux).ServeHTTP</span><br><span class="line">             net/http.serverHandler.ServeHTTP</span><br><span class="line">             net/http.(*conn).serve</span><br><span class="line">-----------+-------------------------------------------------------</span><br></pre></td></tr></table></figure></li>
<li>alloc_space: 分析分配内存空间大小</li>
<li>alloc_objects:</li>
<li>inuse_objects:</li>
</ul>
</li>
</ul>
<ul>
<li><p>Goroutine Profiling</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">➜ go tool pprof http:<span class="comment">//localhost:8080/debug/pprof/goroutine</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8080/debug/pprof/goroutine</span></span><br><span class="line">Saved profile <span class="keyword">in</span> /Users/chyiyaqing/pprof/pprof<span class="selector-class">.goroutine</span>.<span class="number">001</span><span class="selector-class">.pb</span><span class="selector-class">.gz</span></span><br><span class="line">Type: goroutine</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">54</span>pm (CST)</span><br><span class="line">Entering interactive mode (type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) traces  <span class="comment">// 打印调用栈</span></span><br><span class="line">Type: goroutine</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">54</span>pm (CST)</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">         <span class="number">1</span>   runtime<span class="selector-class">.gopark</span></span><br><span class="line">             runtime<span class="selector-class">.netpollblock</span></span><br><span class="line">             internal/poll<span class="selector-class">.runtime_pollWait</span></span><br><span class="line">             internal/poll.(*pollDesc)<span class="selector-class">.wait</span></span><br><span class="line">             internal/poll.(*pollDesc)<span class="selector-class">.waitRead</span> (inline)</span><br><span class="line">             internal/poll.(*FD)<span class="selector-class">.Read</span></span><br><span class="line">             net.(*netFD)<span class="selector-class">.Read</span></span><br><span class="line">             net.(*conn)<span class="selector-class">.Read</span></span><br><span class="line">             net/http.(*connReader)<span class="selector-class">.backgroundRead</span></span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">         <span class="number">1</span>   runtime<span class="selector-class">.gopark</span></span><br><span class="line">             runtime<span class="selector-class">.netpollblock</span></span><br><span class="line">             internal/poll<span class="selector-class">.runtime_pollWait</span></span><br><span class="line">             internal/poll.(*pollDesc)<span class="selector-class">.wait</span></span><br><span class="line">             internal/poll.(*pollDesc)<span class="selector-class">.waitRead</span> (inline)</span><br><span class="line">             internal/poll.(*FD)<span class="selector-class">.Accept</span></span><br><span class="line">             net.(*netFD)<span class="selector-class">.accept</span></span><br><span class="line">             net.(*TCPListener)<span class="selector-class">.accept</span></span><br><span class="line">             net.(*TCPListener)<span class="selector-class">.Accept</span></span><br><span class="line">             net/http.(*Server)<span class="selector-class">.Serve</span></span><br><span class="line">             net/http.(*Server)<span class="selector-class">.ListenAndServe</span></span><br><span class="line">             net/http<span class="selector-class">.ListenAndServe</span> (inline)</span><br><span class="line">             <span class="selector-tag">main</span><span class="selector-class">.main</span></span><br><span class="line">             runtime<span class="selector-class">.main</span></span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">         <span class="number">1</span>   runtime<span class="selector-class">.gopark</span></span><br><span class="line">             <span class="selector-tag">time</span><span class="selector-class">.Sleep</span></span><br><span class="line">             <span class="selector-tag">main</span><span class="selector-class">.main</span><span class="selector-class">.func1</span></span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">         <span class="number">1</span>   runtime/pprof<span class="selector-class">.runtime_goroutineProfileWithLabels</span></span><br><span class="line">             runtime/pprof<span class="selector-class">.writeRuntimeProfile</span></span><br><span class="line">             runtime/pprof<span class="selector-class">.writeGoroutine</span></span><br><span class="line">             runtime/pprof.(*Profile)<span class="selector-class">.WriteTo</span></span><br><span class="line">             net/http/pprof<span class="selector-class">.handler</span><span class="selector-class">.ServeHTTP</span></span><br><span class="line">             net/http/pprof<span class="selector-class">.Index</span></span><br><span class="line">             net/http<span class="selector-class">.HandlerFunc</span><span class="selector-class">.ServeHTTP</span></span><br><span class="line">             net/http.(*ServeMux)<span class="selector-class">.ServeHTTP</span></span><br><span class="line">             net/http<span class="selector-class">.serverHandler</span><span class="selector-class">.ServeHTTP</span></span><br><span class="line">             net/http.(*conn)<span class="selector-class">.serve</span></span><br><span class="line">-----------+-------------------------------------------------------</span><br></pre></td></tr></table></figure></li>
<li><p>Mutex Profiling</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">➜ go tool pprof http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/debug/</span>pprof/mutex</span><br><span class="line">Fetching profile over HTTP from http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/debug/</span>pprof/mutex</span><br><span class="line">Saved profile <span class="keyword">in</span> <span class="regexp">/Users/</span>chyiyaqing<span class="regexp">/pprof/</span>pprof.contentions.delay.<span class="number">003</span>.pb.gz</span><br><span class="line">Type: delay</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">6</span>:<span class="number">05</span>pm (CST)</span><br><span class="line">Entering interactive mode (type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">941.98</span>us, <span class="number">100</span>% of <span class="number">941.98</span>us total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">  <span class="number">941.98</span>us   <span class="number">100</span>%   <span class="number">100</span>%   <span class="number">941.98</span>us   <span class="number">100</span>%  sync.(*Mutex).Unlock</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%   <span class="number">941.98</span>us   <span class="number">100</span>%  main.main.func1</span><br><span class="line">(pprof) list main</span><br><span class="line">Total: <span class="number">941.98</span>us</span><br><span class="line">ROUTINE ======================== main.main.func1 <span class="keyword">in</span> <span class="regexp">/Users/</span>chyiyaqing<span class="regexp">/Downloads/</span>pprof<span class="regexp">/pprof/m</span>ain2.go</span><br><span class="line">         <span class="number">0</span>   <span class="number">941.98</span>us (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">18</span>:	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">999</span>; i++ &#123;</span><br><span class="line">         .          .     <span class="number">19</span>:		go <span class="keyword">func</span>(i int) &#123;</span><br><span class="line">         .          .     <span class="number">20</span>:			m.Lock()</span><br><span class="line">         .          .     <span class="number">21</span>:			defer m.Unlock()</span><br><span class="line">         .          .     <span class="number">22</span>:			datas[i] = struct&#123;&#125;&#123;&#125;</span><br><span class="line">         .   <span class="number">941.98</span>us     <span class="number">23</span>:		&#125;(i)</span><br><span class="line">         .          .     <span class="number">24</span>:	&#125;</span><br><span class="line">         .          .     <span class="number">25</span>:</span><br><span class="line">         .          .     <span class="number">26</span>:	_ = http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, nil)</span><br><span class="line">         .          .     <span class="number">27</span>:&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Block Profiling</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">➜ go tool pprof http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/debug/</span>pprof/block</span><br><span class="line">Fetching profile over HTTP from http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/debug/</span>pprof/block</span><br><span class="line">Saved profile <span class="keyword">in</span> <span class="regexp">/Users/</span>chyiyaqing<span class="regexp">/pprof/</span>pprof.contentions.delay.<span class="number">005</span>.pb.gz</span><br><span class="line">Type: delay</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">6</span>:<span class="number">17</span>pm (CST)</span><br><span class="line">Entering interactive mode (type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">92.66</span>ms, <span class="number">100</span>% of <span class="number">92.67</span>ms total</span><br><span class="line">Dropped <span class="number">4</span> nodes (cum &lt;= <span class="number">0.46</span>ms)</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">   <span class="number">92.66</span>ms   <span class="number">100</span>%   <span class="number">100</span>%    <span class="number">92.66</span>ms   <span class="number">100</span>%  sync.(*Mutex).Lock (inline)</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%    <span class="number">92.66</span>ms   <span class="number">100</span>%  main.main.func1</span><br><span class="line">(pprof) list</span><br><span class="line">command list requires an argument</span><br><span class="line">(pprof) list main</span><br><span class="line">Total: <span class="number">92.67</span>ms</span><br><span class="line">ROUTINE ======================== main.main.func1 <span class="keyword">in</span> <span class="regexp">/Users/</span>chyiyaqing<span class="regexp">/Downloads/</span>pprof<span class="regexp">/pprof/m</span>ain2.go</span><br><span class="line">         <span class="number">0</span>    <span class="number">92.66</span>ms (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">17</span>:<span class="keyword">func</span> main() &#123;</span><br><span class="line">         .          .     <span class="number">18</span>:	var m sync.Mutex</span><br><span class="line">         .          .     <span class="number">19</span>:	var datas = make(map[int]struct&#123;&#125;)</span><br><span class="line">         .          .     <span class="number">20</span>:	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">999</span>; i++ &#123;</span><br><span class="line">         .          .     <span class="number">21</span>:		go <span class="keyword">func</span>(i int) &#123;</span><br><span class="line">         .    <span class="number">92.66</span>ms     <span class="number">22</span>:			m.Lock()</span><br><span class="line">         .          .     <span class="number">23</span>:			defer m.Unlock()</span><br><span class="line">         .          .     <span class="number">24</span>:			datas[i] = struct&#123;&#125;&#123;&#125;</span><br><span class="line">         .          .     <span class="number">25</span>:		&#125;(i)</span><br><span class="line">         .          .     <span class="number">26</span>:	&#125;</span><br><span class="line">         .          .     <span class="number">27</span>:</span><br></pre></td></tr></table></figure></li>
<li><p>查看可视化界面</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">➜ wget http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/<span class="keyword">debug</span>/pprof/<span class="keyword">profile</span></span><br><span class="line">--<span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">42</span>--  http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/<span class="keyword">debug</span>/pprof/<span class="keyword">profile</span></span><br><span class="line">Connecting <span class="keyword">to</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>... connected.</span><br><span class="line">HTTP request sent, awaiting response... <span class="number">200</span> OK</span><br><span class="line">Length: <span class="number">1290</span> (<span class="number">1.3</span>K) [application/octet-stream]</span><br><span class="line">Saving <span class="keyword">to</span>: ‘<span class="keyword">profile</span>’</span><br><span class="line"></span><br><span class="line"><span class="keyword">profile</span>                            <span class="number">100</span>%[================================================================&gt;]   <span class="number">1.26</span>K  --.-KB/s    <span class="keyword">in</span> <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">12</span> (<span class="number">205</span> MB/s) - ‘<span class="keyword">profile</span>’ saved [<span class="number">1290</span>/<span class="number">1290</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一</span></span><br><span class="line">➜ go tool pprof -http=:<span class="number">6001</span> <span class="keyword">profile</span></span><br><span class="line">Serving web UI <span class="keyword">on</span> http://localhost:<span class="number">6001</span></span><br><span class="line">  <span class="comment"># Top</span></span><br><span class="line">  <span class="comment"># Graph: 函数调用流程</span></span><br><span class="line">  <span class="comment"># Peek: 上下文信息</span></span><br><span class="line">  <span class="comment"># Source: 源代码的追踪和分析</span></span><br><span class="line">  <span class="comment"># Flame Graph:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">➜ go tool pprof <span class="keyword">profile</span></span><br><span class="line">Type: cpu</span><br><span class="line">Time: Sep <span class="number">13</span>, <span class="number">2021</span> at <span class="number">6</span>:<span class="number">25</span>pm (CST)</span><br><span class="line">Duration: <span class="number">30</span>s, Total samples = <span class="number">240</span>ms (  <span class="number">0.8</span>%)</span><br><span class="line">Entering interactive mode (type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) web</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>性能分析</tag>
      </tags>
  </entry>
</search>
